<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://jekyll.tungchiahui.cn/feed.xml" rel="self" type="application/atom+xml" /><link href="https://jekyll.tungchiahui.cn/" rel="alternate" type="text/html" /><updated>2026-01-11T01:47:18+00:00</updated><id>https://jekyll.tungchiahui.cn/feed.xml</id><title type="html">东澈的折腾天地</title><subtitle>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</subtitle><author><name>Tung Chia-hui</name></author><entry><title type="html">欢迎来到 Tung 的个人网站！</title><link href="https://jekyll.tungchiahui.cn/blog/welcome-to-tung-site/" rel="alternate" type="text/html" title="欢迎来到 Tung 的个人网站！" /><published>2025-09-23T00:00:00+00:00</published><updated>2025-09-23T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/%E6%AC%A2%E8%BF%8E%E6%9D%A5%E5%88%B0%20Tung%20%E7%9A%84%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99%EF%BC%81</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/welcome-to-tung-site/"><![CDATA[<p>你会在 <code class="language-plaintext highlighter-rouge">_posts</code> 目录中找到这篇文章。尽管编辑它并重新构建网站，查看修改后的效果吧。你可以用多种方式重建网站，但最常用的是运行 <code class="language-plaintext highlighter-rouge">jekyll serve</code>，它会启动一个 web 服务器并在文件更新时自动重新生成网站。</p>

<p>Jekyll 要求博客文章文件命名格式如下：</p>

<p><code class="language-plaintext highlighter-rouge">YEAR-MONTH-DAY-title.MARKUP</code></p>

<p>其中 <code class="language-plaintext highlighter-rouge">YEAR</code> 是四位数字，<code class="language-plaintext highlighter-rouge">MONTH</code> 和 <code class="language-plaintext highlighter-rouge">DAY</code> 都是两位数字，<code class="language-plaintext highlighter-rouge">MARKUP</code> 是文件格式扩展名。之后，包含必要的 front matter。查看这篇文章的源码可以帮助你理解其工作原理。</p>

<p>Jekyll 还提供了对代码片段的强大支持：</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">print_hi</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Hi, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
<span class="n">print_hi</span><span class="p">(</span><span class="s1">'Tom'</span><span class="p">)</span>
<span class="c1">#=&gt; 打印 'Hi, Tom' 到 STDOUT。</span></code></pre></figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Hello, Jekyll!</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>更多信息可以查看 <a href="https://jekyllrb.com/docs/home">Jekyll 官方文档</a>，报告问题或功能请求请到 <a href="https://github.com/jekyll/jekyll">Jekyll 的 GitHub 仓库</a>，如果有问题可以在 <a href="https://talk.jekyllrb.com/">Jekyll 论坛</a> 提问。</p>]]></content><author><name>Tung Chia-hui</name></author><summary type="html"><![CDATA[你会在 _posts 目录中找到这篇文章。尽管编辑它并重新构建网站，查看修改后的效果吧。你可以用多种方式重建网站，但最常用的是运行 jekyll serve，它会启动一个 web 服务器并在文件更新时自动重新生成网站。]]></summary></entry><entry><title type="html">Linux-STM32-CMake-VScode环境搭建</title><link href="https://jekyll.tungchiahui.cn/blog/linux-stm32-cmake-vscode/" rel="alternate" type="text/html" title="Linux-STM32-CMake-VScode环境搭建" /><published>2025-07-18T00:00:00+00:00</published><updated>2025-07-18T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/Linux-STM32-CMake-VScode%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/linux-stm32-cmake-vscode/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#简介" id="markdown-toc-简介">简介</a></li>
  <li><a href="#linux" id="markdown-toc-linux">Linux</a>    <ul>
      <li><a href="#环境介绍" id="markdown-toc-环境介绍">环境介绍</a></li>
      <li><a href="#安装各种环境" id="markdown-toc-安装各种环境">安装各种环境</a>        <ul>
          <li><a href="#安装cc环境" id="markdown-toc-安装cc环境">安装C/C++环境</a></li>
          <li><a href="#安装cubemx" id="markdown-toc-安装cubemx">安装CubeMX</a></li>
          <li><a href="#安装vscode" id="markdown-toc-安装vscode">安装VScode</a></li>
          <li><a href="#安装arm-gnu工具链" id="markdown-toc-安装arm-gnu工具链">安装ARM GNU工具链</a>            <ul>
              <li><a href="#安装" id="markdown-toc-安装">安装</a>                <ul>
                  <li><a href="#方法一官网法" id="markdown-toc-方法一官网法">方法一（官网法）</a></li>
                  <li><a href="#方法二系统仓库法" id="markdown-toc-方法二系统仓库法">方法二（系统仓库法）</a></li>
                </ul>
              </li>
              <li><a href="#测试" id="markdown-toc-测试">测试</a></li>
            </ul>
          </li>
          <li><a href="#安装jlink驱动" id="markdown-toc-安装jlink驱动">安装JLink驱动</a>            <ul>
              <li><a href="#安装libreadline库" id="markdown-toc-安装libreadline库">安装libreadline库</a></li>
              <li><a href="#安装jlink驱动-1" id="markdown-toc-安装jlink驱动-1">安装JLink驱动</a></li>
              <li><a href="#下载并安装ozone" id="markdown-toc-下载并安装ozone">下载并安装Ozone</a></li>
              <li><a href="#测试-1" id="markdown-toc-测试-1">测试</a></li>
            </ul>
          </li>
          <li><a href="#下载svd" id="markdown-toc-下载svd">下载SVD</a></li>
        </ul>
      </li>
      <li><a href="#工程创建与测试" id="markdown-toc-工程创建与测试">工程创建与测试</a>        <ul>
          <li><a href="#使用cubemx创建工程" id="markdown-toc-使用cubemx创建工程">使用CubeMX创建工程</a></li>
          <li><a href="#对工程进行配置与编译" id="markdown-toc-对工程进行配置与编译">对工程进行配置与编译</a></li>
          <li><a href="#对代码提示进行配置" id="markdown-toc-对代码提示进行配置">对代码提示进行配置</a></li>
          <li><a href="#移植vinci机器人队标准cc工程模板" id="markdown-toc-移植vinci机器人队标准cc工程模板">移植Vinci机器人队标准C/C++工程模板</a></li>
          <li><a href="#下载程序到板子" id="markdown-toc-下载程序到板子">下载程序到板子</a>            <ul>
              <li><a href="#配置cmake生成bin和hex文件" id="markdown-toc-配置cmake生成bin和hex文件">配置CMake生成.bin和.hex文件</a></li>
              <li><a href="#将设备连接到jlink并烧录程序" id="markdown-toc-将设备连接到jlink并烧录程序">将设备连接到JLink并烧录程序</a>                <ul>
                  <li><a href="#图形界面烧录" id="markdown-toc-图形界面烧录">图形界面烧录</a></li>
                  <li><a href="#终端烧录" id="markdown-toc-终端烧录">终端烧录</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li><a href="#配置vscode任务" id="markdown-toc-配置vscode任务">配置VScode任务</a></li>
          <li><a href="#使用ozone进行flash烧录和debug调试" id="markdown-toc-使用ozone进行flash烧录和debug调试">使用ozone进行Flash烧录和Debug调试</a>            <ul>
              <li><a href="#基础配置" id="markdown-toc-基础配置">基础配置</a></li>
              <li><a href="#烧录与调试" id="markdown-toc-烧录与调试">烧录与调试</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#windows" id="markdown-toc-windows">Windows</a>    <ul>
      <li><a href="#环境准备" id="markdown-toc-环境准备">环境准备</a></li>
    </ul>
  </li>
</ul>

<p><strong><em><code class="language-plaintext highlighter-rouge">（本教程为2025年7月创建的，可能与以后的版本有些出入）</code></em></strong></p>

<p>https://blog.csdn.net/SankeXhy/article/details/138418371?shareId=138418371&amp;sharefrom=link&amp;sharerefer=APP&amp;sharesource=2301_80523028&amp;sharetype=blog</p>

<h1 id="简介">简介</h1>

<ul>
  <li>
    <p>CubeMX + CMake +GCC + HAL + VSCode + Clangd + Ozone 构成了全链路嵌入式开发方案： CubeMX解决硬件配置问题，CMake统一构建流程，GCC提供编译支持，HAL库屏蔽硬件差异，VSCode+Clangd打造智能编辑器,Ozone实现更方便高效的debug调试功能。</p>
  </li>
  <li>
    <p>该组合降低开发门槛（尤其对跨平台项目），提升代码质量与可维护性，并适配从原型到量产的全生命周期需求，是STM32等ARM嵌入式开发的推荐实践。</p>
  </li>
</ul>

<h1 id="linux">Linux</h1>

<h2 id="环境介绍">环境介绍</h2>

<p>本教程环境介绍：</p>

<ol>
  <li>
    <p>系统：Fedora 42 KDE Edition Linux</p>
  </li>
  <li>
    <p>系统内核：Linux 6.15.6-200.fc42.x86_64</p>
  </li>
  <li>
    <p>架构：X86_64</p>
  </li>
</ol>

<p>其他Linux环境也可以。</p>

<h2 id="安装各种环境">安装各种环境</h2>

<h3 id="安装cc环境">安装C/C++环境</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># debian系</span>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>gcc g++ gdb cmake-gui make

<span class="c"># rhel系</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>gcc g++ gdb cmake-gui make
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image1.webp" alt="" /></p>

<p>查看是否环境安装成功</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>gcc -v
g++ -v
gdb -v
cmake --version
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image2.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image3.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image4.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image5.webp" alt="" /></p>

<p>接下来测试是否能够对C/C++正常编译，请找一个存放C++代码的文件夹，然后在终端中cd进去。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image6.webp" alt="" /></p>

<p>然后创建一个.cpp文件并用vim编辑</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vim hello.cpp
</pre></td></tr></tbody></table></code></pre></div></div>

<p>复制以下代码到该文件里</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="c1"> </span><span class="cp">
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span> 
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"你好，机电创新学会！"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后编译</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>g++ <span class="nt">-o</span> hello hello.cpp
<span class="nb">ls</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image7.webp" alt="" /></p>

<p>运行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>./hello
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image8.webp" alt="" /></p>

<p>说明环境已经配置好了</p>

<h3 id="安装cubemx">安装CubeMX</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image9.webp" alt="" /></p>

<p>下载地址：</p>

<p>https://www.st.com.cn/zh/development-tools/stm32cubemx.html</p>

<p><strong>推荐下载6.14.1版本（不要下载6.15.0,这个版本有bug，不知道后续何时会修复）</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image10.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image11.webp" alt="" /></p>

<p>解压出来</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image12.webp" alt="" /></p>

<p>用root权限打开这个软件<code class="language-plaintext highlighter-rouge">SetupSTM32CubeMX-6.15.0</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">SetupSTM32CubeMX</span><span class="o">-</span><span class="mf">6.15.0</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image13.webp" alt="" /></p>

<p>在新弹出的界面一直点下一步就行，安装结束后出现如下图就成功了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image14.webp" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">/usr/local/STMicroelectronics/STM32Cube/STM32CubeMX</code>进入这个文件夹，然后打开终端输入</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">.</span><span class="o">/</span><span class="n">STM32CubeMX</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image15.webp" alt="" /></p>

<p>点击Help</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image16.webp" alt="" /></p>

<p>选<code class="language-plaintext highlighter-rouge">Manage embedded software packages</code>，把STM32F1，F4，H7的第一个最新的固件勾上。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image17.webp" alt="" /></p>

<p>点install</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image18.webp" alt="" /></p>

<p>登陆上账号</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image19.webp" alt="" /></p>

<p>然后等下载和安装完</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image20.webp" alt="" /></p>

<p>下载好就行了。</p>

<p>接下来可以把CubeMX应用配置一个桌面快捷方式等可以快速打开，教程详见<a href="https://sdutvincirobot.feishu.cn/wiki/GIKnwJo39iREkHkFGvqcy5Osntc">Vinci机器人队Linux入门教程</a>的Appimage章节，可以用ctrl+F快速定位该章节。</p>

<p>桌面快捷方式如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">Desktop</span> <span class="n">Entry</span><span class="p">]</span>
<span class="n">Name</span><span class="o">=</span><span class="n">STM32CubeMX</span>
<span class="n">Exec</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">STMicroelectronics</span><span class="o">/</span><span class="n">STM32Cube</span><span class="o">/</span><span class="n">STM32CubeMX</span><span class="o">/</span><span class="n">STM32CubeMX</span>
<span class="n">Icon</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">STMicroelectronics</span><span class="o">/</span><span class="n">STM32Cube</span><span class="o">/</span><span class="n">STM32CubeMX</span><span class="o">/</span><span class="n">help</span><span class="o">/</span><span class="n">STM32CubeMX</span><span class="p">.</span><span class="n">png</span>
<span class="n">Type</span><span class="o">=</span><span class="n">Application</span>
<span class="n">Categories</span><span class="o">=</span><span class="n">Development</span><span class="p">;</span><span class="n">Electronics</span><span class="p">;</span><span class="n">Embedded</span><span class="p">;</span>
<span class="n">Comment</span><span class="o">=</span><span class="n">STM32CubeMX</span> <span class="n">configuration</span> <span class="n">and</span> <span class="n">code</span> <span class="n">generation</span> <span class="n">tool</span>
<span class="n">Terminal</span><span class="o">=</span><span class="nb">false</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>根据教程做，就可以实现这种效果啦。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image21.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image22.webp" alt="" /></p>

<h3 id="安装vscode">安装VScode</h3>

<p>https://code.visualstudio.com/Download</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image23.webp" alt="" /></p>

<p>如果是debian系下载deb,如果是rhel系下载rpm.</p>

<p>下载完之后，点击浏览器，找到这个安装包的文件夹，并在该路径打开终端。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image24.webp" alt="" /></p>

<p>Debian系：输入<code class="language-plaintext highlighter-rouge">sudo apt install ./code</code>然后按<code class="language-plaintext highlighter-rouge">tab</code>按键补齐文件名，回车。</p>

<p>RHEL系：输入<code class="language-plaintext highlighter-rouge">sudo dnf install ./code</code>然后按<code class="language-plaintext highlighter-rouge">tab</code>按键补齐文件名，回车。</p>

<p>例如补齐后的：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install</span> ./code-1.102.1-1752598767.el8.x86_64.rpm
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image25.webp" alt="" /></p>

<p>然后打开VScode，在终端输入下面的命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>code
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image26.webp" alt="" /></p>

<p>然后安装一些插件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image27.webp" alt="" /></p>

<p>下面这些都要装</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image28.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image29.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image30.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image31.webp" alt="" /></p>

<h3 id="安装arm-gnu工具链">安装ARM GNU工具链</h3>

<p>编译工具比较：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">特性</th>
      <th style="text-align: left">ARM GCC (GNU 工具链)</th>
      <th style="text-align: left">Keil AC5 (ARM Compiler 5)</th>
      <th style="text-align: left">Keil AC6 (ARM Compiler 6)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">核心身份</td>
      <td style="text-align: left">基于GNU GPL的开源编译器</td>
      <td style="text-align: left">ARM自家的传统编译器</td>
      <td style="text-align: left">基于LLVM/Clang的现代编译器</td>
    </tr>
    <tr>
      <td style="text-align: left">许可模式</td>
      <td style="text-align: left">免费、开源</td>
      <td style="text-align: left">商业收费（包含在MDK中）</td>
      <td style="text-align: left">商业收费（包含在MDK中）</td>
    </tr>
    <tr>
      <td style="text-align: left">代码生成/优化</td>
      <td style="text-align: left">良好，持续改进</td>
      <td style="text-align: left">优秀（尤其在小代码尺寸上）</td>
      <td style="text-align: left">极佳，在性能与尺寸间有最佳平衡</td>
    </tr>
    <tr>
      <td style="text-align: left">标准兼容性</td>
      <td style="text-align: left">紧跟最新C/C++标准（如C17，C++17/20）</td>
      <td style="text-align: left">主要支持C++98，较陈旧</td>
      <td style="text-align: left">支持现代C++（C++11/14/17），兼容性更好</td>
    </tr>
    <tr>
      <td style="text-align: left">错误/警告信息</td>
      <td style="text-align: left">比较清晰易懂</td>
      <td style="text-align: left">相对晦涩</td>
      <td style="text-align: left">非常清晰和友好，类似GCC/Clang</td>
    </tr>
    <tr>
      <td style="text-align: left">与Keil MDK集成</td>
      <td style="text-align: left">需要手动配置或通过CubeIDE</td>
      <td style="text-align: left">原生、无缝集成</td>
      <td style="text-align: left">原生、无缝集成，是ARM推荐选择</td>
    </tr>
    <tr>
      <td style="text-align: left">链接脚本</td>
      <td style="text-align: left">使用自有的链接脚本语法（.ld文件）</td>
      <td style="text-align: left">使用ARM自家的分散加载文件语法（.sct）</td>
      <td style="text-align: left">使用ARM自家的分散加载文件语法（.sct）</td>
    </tr>
    <tr>
      <td style="text-align: left">汇编语法</td>
      <td style="text-align: left">使用GNU汇编语法（.S文件）</td>
      <td style="text-align: left">使用ARM汇编语法（.s）</td>
      <td style="text-align: left">使用ARM汇编语法（.s），但AC6更严格</td>
    </tr>
    <tr>
      <td style="text-align: left">生态与未来</td>
      <td style="text-align: left">生态强大，是很多开源项目（如Zephyr，ESP-IDF）和IDE（CubeIDE，VS Code）的首选</td>
      <td style="text-align: left">处于维护模式，ARM不再增加新功能，不推荐新项目使用</td>
      <td style="text-align: left">是ARM的未来和主力，持续更新和优化</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="安装">安装</h4>

<p><strong>建议都用</strong><strong>官方法</strong><strong>进行安装。</strong></p>

<h5 id="方法一官网法">方法一（官网法）</h5>

<p>https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image32.webp" alt="" /></p>

<p>进入下载目录并打开终端</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image33.webp" alt="" /></p>

<p>在终端里输入下列命令，将编译器文件tar压缩包复制到你存放程序的文件夹（这个文件夹你自己定，建议在home分区，别以后删了就行）。</p>

<p>具体命令为<code class="language-plaintext highlighter-rouge">cp ./arm-gnu</code>然后按<code class="language-plaintext highlighter-rouge">tab</code>补齐，然后空格，再跟上你要复制到的文件夹的路径。</p>

<p>比如下面的命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cp</span> ./arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz ~/UserFolder/Applications/
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后进入复制到的文件夹：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> ~/UserFolder/Applications/
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image34.webp" alt="" /></p>

<p>在终端里输入<code class="language-plaintext highlighter-rouge">tar -xvf ./arm-gnu</code>并按<code class="language-plaintext highlighter-rouge">tab</code>补齐。</p>

<p>例如我补齐后的：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> <span class="nb">tar</span> <span class="nt">-xvf</span> ./arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image35.webp" alt="" /></p>

<p>再进入这个解压后的文件夹</p>

<p><code class="language-plaintext highlighter-rouge">cd ./arm-gnu</code>按<code class="language-plaintext highlighter-rouge">tab</code>补齐。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> ./arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/
<span class="nb">cd</span> ./bin
</pre></td></tr></tbody></table></code></pre></div></div>

<p>查看文件夹路径</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">pwd</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image36.webp" alt="" /></p>

<p>复制一下<code class="language-plaintext highlighter-rouge">/home/tungchiahui/UserFolder/Applications/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin</code></p>

<p>然后需要配置环境</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在末尾输入下面的命令，把下面<code class="language-plaintext highlighter-rouge">~/UserFolder/Applications/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin</code>替换成你刚才复制的路径，<code class="language-plaintext highlighter-rouge">/home/用户名</code>可以用<code class="language-plaintext highlighter-rouge">~</code>来代替。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/home/tungchiahui/UserFolder/Applications/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin:<span class="nv">$PATH</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image37.webp" alt="" /></p>

<p>加载环境</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">source</span> ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="方法二系统仓库法">方法二（系统仓库法）</h5>

<p><strong>不建议本法</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># Debian系</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>arm-none-eabi-gcc

<span class="c"># Rhel系</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>arm-none-eabi-gcc
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image38.webp" alt="" /></p>

<h4 id="测试">测试</h4>

<p>检查版本</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>arm-none-eabi-gcc <span class="nt">-v</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image39.webp" alt="" /></p>

<h3 id="安装jlink驱动">安装JLink驱动</h3>

<h4 id="安装libreadline库">安装libreadline库</h4>

<p>我们烧录会用到JLinkExe的命令，而JLinkExe会用到libreadline库，所以要安装libreadline库，执行如下命令安装：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># debian系</span>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>libreadline-dev

<span class="c"># rhel系</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>readline-devel
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image40.webp" alt="" /></p>

<h4 id="安装jlink驱动-1">安装JLink驱动</h4>

<p>https://www.segger.com/downloads/jlink/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image41.webp" alt="" /></p>

<p>是Debian系下载64位DEB</p>

<p>是RHEL系下载64位RPM</p>

<p>（这里的64位指的是amd64和X86_64,如果你是ARM64请下载下方那个Linux ARM里的64位）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image42.webp" alt="" /></p>

<p>打开下载到的文件夹，并打开终端</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image43.webp" alt="" /></p>

<p>然后<code class="language-plaintext highlighter-rouge">sudo apt install ./JLink</code>然后tab补齐。</p>

<p>然后<code class="language-plaintext highlighter-rouge">sudo dnf install ./JLink</code>然后tab补齐。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install</span> ./JLink_Linux_V852_x86_64.rpm
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image44.webp" alt="" /></p>

<p>检查是否安装成功</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>JLinkExe
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image45.webp" alt="" /></p>

<p>我们点击No，然后会进入Commander交互模式，在这种模式下，我们可以执行各种 J-Link Commander 提供的命令来连接、配置调试器，下载程序或文件到目标设备等操作，感兴趣的同学可自行学习。</p>

<p>执行“q”指令退出该模式。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image46.webp" alt="" /></p>

<h4 id="下载并安装ozone">下载并安装Ozone</h4>

<p>https://www.segger.com/products/development-tools/ozone-j-link-debugger/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image47.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image48.webp" alt="" /></p>

<p>是Debian系下载64位DEB</p>

<p>是RHEL系下载64位RPM</p>

<p>（这里的64位指的是amd64和X86_64,如果你是ARM64请下载下方那个Linux ARM里的64位）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image49.webp" alt="" /></p>

<p>然后<code class="language-plaintext highlighter-rouge">sudo apt install ./Ozone</code>然后tab补齐。</p>

<p>然后<code class="language-plaintext highlighter-rouge">sudo dnf install ./Ozone</code>然后tab补齐。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install</span> ./Ozone_Linux_V338g_x86_64.rpm
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image50.webp" alt="" /></p>

<h4 id="测试-1">测试</h4>

<p>打开终端输入</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ozone
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image51.webp" alt="" /></p>

<h3 id="下载svd">下载SVD</h3>

<p>https://www.st.com.cn/content/st_com/zh.html</p>

<p>在搜索里搜索芯片型号，如stm32f103c8t6</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image52.webp" alt="" /></p>

<p>点CAD资源</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image53.webp" alt="" /></p>

<p>下载SVD，鼠标点红色框的区域就可以下载了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image54.webp" alt="" /></p>

<p>解压后就可以获得F1系列的SVD文件了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image55.webp" alt="" /></p>

<p>依次把F4和H7的也下载解压了就可以了。（可以解压到一个文件夹里）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image56.webp" alt="" /></p>

<p>然后在上面的文件夹打开终端</p>

<p>将这些文件夹全部复制到Ozone的<code class="language-plaintext highlighter-rouge">Config/Peripherals/</code>目录下。（你需要提前确定一下ozone的配置是否是这个路径再复制）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image57.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo cp</span> ./<span class="k">*</span>.svd /opt/SEGGER/Ozone_V338g/Config/Peripherals/
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image58.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image59.webp" alt="" /></p>

<h2 id="工程创建与测试">工程创建与测试</h2>

<h3 id="使用cubemx创建工程">使用CubeMX创建工程</h3>

<p>点击进入单片机挑选的按钮</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image60.webp" alt="" /></p>

<p>搜索对应芯片，并双击对应芯片选项。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image61.webp" alt="" /></p>

<p>进行一些配置，以下都是很基础的东西，你在看这个视频前肯定都会了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image62.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image63.webp" alt="" /></p>

<p>随便开一个IO用来测试，比如LED的GPIO</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image64.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image65.webp" alt="" /></p>

<p>FreeRTOS也要配置一下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image66.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image67.webp" alt="" /></p>

<p>这些文件夹也要配置好，最后Toolchain选择CMake,编译器选择GCC(6.14.1及之前没有选择编译器这个选项很正常)</p>

<p>（但是CubeMX6.15.0有bug,这个选择GCC编译器并没有用，还需要后续自己手动选择编译器，以后可能会修复这个bug.）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image68.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image69.webp" alt="" /></p>

<h3 id="对工程进行配置与编译">对工程进行配置与编译</h3>

<p>在工程文件夹打开终端</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image70.webp" alt="" /></p>

<p>然后打开vscode</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>code <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image71.webp" alt="" /></p>

<p>进入vscode后，点击目录下的CMakeLists.txt</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image72.webp" alt="" /></p>

<p>检查第25行左右是否有下面这行，如果没有，你需要手动给他加上这两行。(6.14.1版本没有这个bug)</p>

<p><em>tips1：这就是上面说的CubeMX6.15.0版本的bug,因为这个版本增加了对clang编译器的支持，在CubeMX里也支持了选择编译器的操作，但是这个选项估计是工程师没写好，选择编译器不管选哪个，他都不会选择咱们选择的编译器，所以咱们需要手动选择。</em></p>

<p><em>tips2:这CubeMX6.15.0有第二个bug,这个工作区根CMakeLists.txt他说了只会生成一次，后续不会再重新覆盖生成，但是发现每次在CubeMX修改配置后，然后重新生成代码，其他命令都被保留了，就这个命令不会被保留。不知道后续会不会被修复，或者直接修复上面tips1的bug.所以每次重新配置CubeMX后，需要再把这句加上。</em></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image73.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># Include toolchain file</span>
include<span class="o">(</span><span class="s2">"cmake/gcc-arm-none-eabi.cmake"</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>按ctrl+～打开内置终端。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image74.webp" alt="" /></p>

<p>使用下方命令创建并进入build文件夹</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir </span>build
<span class="nb">cd </span>build
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image75.webp" alt="" /></p>

<p>接下来使用cmake命令生成makefile文件</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>cmake ..
</pre></td></tr></tbody></table></code></pre></div></div>

<p>检查一下是否ARM的C/C++以及汇编编译器都被找到了（如果没有，请检查上面的教程是否有做错的地方）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image76.webp" alt="" /></p>

<p>然后使用make命令进行编译，命令为<code class="language-plaintext highlighter-rouge">make</code>或者<code class="language-plaintext highlighter-rouge">make -jxx</code>,这里的xx是你想使用CPU的几个线程来进行编译，比如我电脑是8核16线程，我就可以让xx是比16低的数字。而<code class="language-plaintext highlighter-rouge">make</code>是默认用一个线程。如果你并不知道你CPU有几个线程，那你就老老实实用<code class="language-plaintext highlighter-rouge">make</code>命令，别用<code class="language-plaintext highlighter-rouge">make -jxx</code>命令了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make <span class="nt">-j16</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这样就是编译成功了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image77.webp" alt="" /></p>

<h3 id="对代码提示进行配置">对代码提示进行配置</h3>

<p>在VScode中按Ctrl+Shift+P,搜索clangd,并选择下载语言服务</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image78.webp" alt="" /></p>

<p>在右下角选择安装即可，安装完就会出现下图提示。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image79.webp" alt="" /></p>

<p>接着禁用C/C++插件的代码提示功能(如果没这个界面，请往下看)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image80.webp" alt="" /></p>

<p>如果没有上图的弹窗，可以进行手动关闭，依然是ctrl shift P,输入settings然后找到如下图的选项</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image81.webp" alt="" /></p>

<p>找到下图这个选项，改成disabled即可。</p>

<p><code class="language-plaintext highlighter-rouge">"C_Cpp.intelliSenseEngine": "disabled"</code></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image82.webp" alt="" /></p>

<p>在VScode中再按Ctrl+Shift+P,搜索clangd,并选择重启clangd语言服务(重启clangd语言服务之前必须编译过一遍代码了)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image83.webp" alt="" /></p>

<p>此时，可以看代码里头文件都正常识别了,代码提示也正常了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image84.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image85.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image86.webp" alt="" /></p>

<p>⚠️注意：Clangd 默认找的是 <strong>本机系统的 libc/include 路径（比如 x86_64 的 <code class="language-plaintext highlighter-rouge">/usr/include</code>）</strong> ，而我们工程里面实际使用的是 <strong>ARM 工具链的头文件路径</strong> ，这就有概率导致包含C/C++库函数的头文件报错</p>

<p>例如：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image87.webp" alt="" /></p>

<p>这里的 #include <math.h>显示找不到头文件，但是我们进行编译的时候却没有报错，说明是clangd的配置有问题 。以下介绍一种解决方法：</math.h></p>

<ol>
  <li>运行以下命令，获取 ARM GCC 使用的标准 include 路径：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>arm-none-eabi-gcc <span class="nt">-x</span> c <span class="nt">-E</span> <span class="nt">-v</span> - &lt;/dev/null
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image88.webp" alt="" /></p>

<ol>
  <li>在工程根目录下面创建 .clangd 文件 将自己的头文件路径包含进去（引号里面替换成你自己的arm gcc头文件路径）</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>CompileFlags:
  Add: [
    "-isystem", "/home/xiaofang/Applications/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/lib/gcc/arm-none-eabi/14.3.1/include",
    "-isystem", "/home/xiaofang/Applications/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/lib/gcc/arm-none-eabi/14.3.1/include-fixed",
    "-isystem", "/home/xiaofang/Applications/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/arm-none-eabi/include"
  ]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>保存，此时刷新一下clangd,头文件提示正常</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image89.webp" alt="" /></p>

<h3 id="移植vinci机器人队标准cc工程模板">移植Vinci机器人队标准C/C++工程模板</h3>

<p>用git clone命令克隆仓库:https://github.com/tungchiahui/CubeMX_MDK5to6_Template</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git clone https://github.com/tungchiahui/CubeMX_MDK5to6_Template.git
</pre></td></tr></tbody></table></code></pre></div></div>

<p>把仓库里的“工程文件移植”文件夹里的 <strong>所有内容</strong> 复制到我们CMake工程的目录里。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image90.webp" alt="" /></p>

<p>然后打开applications文件夹，在Src和Inc文件夹分别创建led_task.cpp和led_task.h，内容分别如下:</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image91.webp" alt="" /></p>

<p>led_task.cpp:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"led_task.h"</span><span class="cp">
#include</span> <span class="cpf">"cmsis_os.h"</span><span class="cp">
#include</span> <span class="cpf">"stm32f1xx_hal.h"</span><span class="c1"> </span><span class="cp">
</span>
<span class="n">GPIO_PinState</span> <span class="n">pinstate</span> <span class="o">=</span> <span class="n">GPIO_PIN_RESET</span><span class="p">;</span>

<span class="k">extern</span> <span class="s">"C"</span>
<span class="kt">void</span> <span class="nf">StartDefaultTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">argument</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">for</span><span class="p">(;;)</span>
  <span class="p">{</span>
    <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">GPIO_PIN_13</span><span class="p">,</span><span class="n">pinstate</span><span class="p">);</span>
    <span class="n">pinstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">pinstate</span> <span class="o">==</span> <span class="n">GPIO_PIN_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="n">GPIO_PIN_SET</span> <span class="o">:</span> <span class="n">GPIO_PIN_RESET</span><span class="p">;</span>
    <span class="n">osDelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>led_task.h:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cp">#ifndef __LED_TASK_H_
#define __LED_TASK_H_
</span>
<span class="cp">#ifdef __cplusplus
</span><span class="k">extern</span> <span class="s">"C"</span>
<span class="p">{</span>
<span class="cp">#endif
</span>
<span class="cp">#include</span> <span class="cpf">"cpp_interface.h"</span><span class="cp">
</span>
<span class="cp">#ifdef __cplusplus
</span><span class="p">}</span>
<span class="cp">#endif
</span>
<span class="cp">#endif
</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后打开<code class="language-plaintext highlighter-rouge">cmake/user</code>文件夹下的<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>，把刚才新建的led_task.cpp添加上去。</p>

<p>详细介绍（可以不看）：这里的<code class="language-plaintext highlighter-rouge">cmake/stm32cubemx</code>下的<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>是被CubeMX管理的，你重新用CubeMX生成新代码后，这个文件里的东西会被覆盖。而工作区根目录下的<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>是不会被重新覆盖的，而且给我们留了一些区域加源文件和头文件，但是这样会让这个文件太过于嘈杂。所以我们选择新建一个user文件夹，然后在这里面弄一个<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>，再用顶层<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>去加载这个子<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>，这个子<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>方便咱们修改，文件结构也更加明显。（这些都不需要咱们自己创建，我已经给创建到 <strong>工程文件移植</strong> 里了，你在上面复制的时候已经复制过来了）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image92.webp" alt="" /></p>

<p>然后要去最顶层的CMakeLists.txt里加上这句话来引用我们自己的CMakeLists.txt。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image93.webp" alt="" /></p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c1"># Add USER generated sources</span>
<span class="nb">add_subdirectory</span><span class="p">(</span>cmake/user<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>大功告成，编译一次试试。可以看到下图，那些新加的文件都编译上了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cmake ..
make
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image94.webp" alt="" /></p>

<p>然后去main.c中引用cpp_interface.h头文件，并将cpp_main()函数在main函数的这个地方调用。(我这里是开RTOS了，所以需要在启动RTOS之前调用cpp_main函数，如果你是没有用RTOS的裸机程序，则在while (1)的上方调用cpp_main即可)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image95.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image96.webp" alt="" /></p>

<p>然后在cpp_interface.h里修改isRTOS这个宏来让程序知道你是否开启了RTOS，如果开启了，宏就为1，裸机就填0。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image97.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image98.webp" alt="" /></p>

<p>其他更加详细的关于STM32的C/C++工程介绍请看<a href="https://sdutvincirobot.feishu.cn/wiki/PqsGwcPCuidbN6k13jfcGWtWn0b">Vinci机器人队单片机教程</a>。</p>

<p>此时在build文件夹下进行编译程序，发现成功!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cmake ..
make
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image99.webp" alt="" /></p>

<h3 id="下载程序到板子">下载程序到板子</h3>

<h4 id="配置cmake生成bin和hex文件">配置CMake生成.bin和.hex文件</h4>

<p>在下载程序到板子之前，我们需要去看看咱们之前编译的到底生成了啥文件。</p>

<p>通过下图可知，他只生成了.elf文件，并没有咱们常见的.bin和.hex文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image100.webp" alt="" /></p>

<p>咱们需要再更改一下工作区下的CMakeLists.txt从而来让编译的时候生成.hex和.bin（没办法，就得这么麻烦，我也不知道为啥CubeMX不给全干好）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image101.webp" alt="" /></p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c1"># 生成 .bin 和 .hex 文件</span>
<span class="nb">find_program</span><span class="p">(</span>OBJCOPY arm-none-eabi-objcopy REQUIRED<span class="p">)</span>

<span class="nb">add_custom_command</span><span class="p">(</span>TARGET <span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span> POST_BUILD
    COMMAND <span class="si">${</span><span class="nv">OBJCOPY</span><span class="si">}</span> -O binary <span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span>.elf <span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span>.bin
    COMMAND <span class="si">${</span><span class="nv">OBJCOPY</span><span class="si">}</span> -O ihex   <span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span>.elf <span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span>.hex
    COMMENT <span class="s2">"Generating </span><span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span><span class="s2">.bin and </span><span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span><span class="s2">.hex from </span><span class="si">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="si">}</span><span class="s2">.elf"</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这些需要在工作区主CMakeLists.txt里添加的命令我全都写在这个记事本里了，每次生成新工程直接复制即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image102.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image103.webp" alt="" /></p>

<p>然后再次编译</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cmake ..
make
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image104.webp" alt="" /></p>

<p>此时再看build目录：咱们需要的.hex或者.bin就出来了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image105.webp" alt="" /></p>

<h4 id="将设备连接到jlink并烧录程序">将设备连接到JLink并烧录程序</h4>

<h5 id="图形界面烧录">图形界面烧录</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c">#打开终端输入</span>
JFlashLite
</pre></td></tr></tbody></table></code></pre></div></div>

<p>选择对应的芯片型号和速度</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image106.webp" alt="" /></p>

<p>添加hex文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image107.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image108.webp" alt="" /></p>

<p>点击烧录并完成：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image109.webp" alt="" /></p>

<p>成功点亮led：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image110.webp" alt="" /></p>

<h5 id="终端烧录">终端烧录</h5>

<p>算鸟算鸟，太麻烦了。</p>

<h3 id="配置vscode任务">配置VScode任务</h3>

<p>咱们在上面编译，一直需要输入以下命令</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cd build
cmake ..
make
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这样每次编译过于麻烦了，所以我们使用强大的VScode来一键编译。</p>

<p>首先创建<code class="language-plaintext highlighter-rouge">.vscode</code>文件夹和<code class="language-plaintext highlighter-rouge">tasks.json</code>文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image111.webp" alt="" /></p>

<p>以下是<code class="language-plaintext highlighter-rouge">tasks.json</code>的内容：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/build"</span><span class="w">    </span><span class="err">//需要进入到我们执行tasks任务的文件夹中</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tasks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">    </span><span class="err">//tasks包含</span><span class="mi">4</span><span class="err">个任务</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stm32-cmake"</span><span class="p">,</span><span class="w">    </span><span class="err">//第一个任务的名字叫cmake</span><span class="w">
            </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bash"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"-c"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"mkdir -p ../log &amp;&amp; echo </span><span class="se">\"</span><span class="s2">===== CMake started at: $(date) =====</span><span class="se">\"</span><span class="s2"> | tee -a ../log/cmake.log &amp;&amp; cmake .. 2&gt;&amp;1 | tee -a ../log/cmake.log"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"problemMatcher"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">    </span><span class="err">//这里需要添加一个空的问题匹配器，否则会报错</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stm32-make"</span><span class="p">,</span><span class="w">    </span><span class="err">//第二个任务的名字叫make</span><span class="w">
            </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bash"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"-c"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"mkdir -p ../log &amp;&amp; echo </span><span class="se">\"</span><span class="s2">===== Make started at: $(date) =====</span><span class="se">\"</span><span class="s2"> | tee -a ../log/make.log &amp;&amp; make -j$(grep -c ^processor /proc/cpuinfo) 2&gt;&amp;1 | tee -a ../log/make.log"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"problemMatcher"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">    </span><span class="err">//这里也需要添加一个空的问题匹配器，否则会报错</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stm32-Build"</span><span class="p">,</span><span class="w">    </span><span class="err">//第</span><span class="mi">3</span><span class="err">个任务的名字叫Build</span><span class="w">
            </span><span class="nl">"group"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">               </span><span class="err">//默认是build任务</span><span class="w">
                </span><span class="nl">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"build"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"isDefault"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"dependsOrder"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sequence"</span><span class="p">,</span><span class="w">    </span><span class="err">//顺序执行依赖项</span><span class="w">
            </span><span class="nl">"dependsOn"</span><span class="p">:[</span><span class="w">    </span><span class="err">//依赖的</span><span class="mi">2</span><span class="err">个项为cmake、make</span><span class="w">
                </span><span class="s2">"stm32-cmake"</span><span class="p">,</span><span class="w">    </span><span class="err">//即第一个任务的label</span><span class="w">
                </span><span class="s2">"stm32-make"</span><span class="w">      </span><span class="err">//即第二个任务的label</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stm32-clean"</span><span class="p">,</span><span class="w">    </span><span class="err">//第四个任务：清理</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">文件夹</span><span class="w">
            </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bash"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"-c"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">===== Clean started at: $(date) =====</span><span class="se">\"</span><span class="s2"> &amp;&amp; rm -rf * &amp;&amp; echo </span><span class="se">\"</span><span class="s2">Build folder cleaned.</span><span class="se">\"</span><span class="s2">"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/build"</span><span class="w">    </span><span class="err">//只清理build目录下的文件</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"problemMatcher"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">    </span><span class="err">//不需要问题匹配器</span><span class="w">
        </span><span class="p">}</span><span class="w">

    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>方法一：</strong></p>

<p>在VScode标题栏上，找到<code class="language-plaintext highlighter-rouge">终端</code>，然后再选择<code class="language-plaintext highlighter-rouge">运行构建任务</code>，快捷键是<code class="language-plaintext highlighter-rouge">Ctrl+Shift+B</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image112.webp" alt="" /></p>

<p>可见任务已经被运行了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image113.webp" alt="" /></p>

<p><strong>方法二：</strong></p>

<p>在VScode标题栏上，找到<code class="language-plaintext highlighter-rouge">终端</code>，然后再选择<code class="language-plaintext highlighter-rouge">运行任务</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image114.webp" alt="" /></p>

<p>下面有4个stm32的任务，第一个是<code class="language-plaintext highlighter-rouge">stm32-Build</code>任务，运行后的效果和刚才方法一是一样的，方法一的那个<code class="language-plaintext highlighter-rouge">运行构建任务</code>的按钮，就是运行的这个<code class="language-plaintext highlighter-rouge">stm32-Build</code>任务。</p>

<p>这个<code class="language-plaintext highlighter-rouge">stm32-Build</code>任务包含stm32-cmake和stm32-make任务。</p>

<p>然后<code class="language-plaintext highlighter-rouge">stm32-clean</code>任务就是清除build文件夹下的所有文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image115.webp" alt="" /></p>

<p>可以试一下<code class="language-plaintext highlighter-rouge">stm32-clean</code>任务。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image116.webp" alt="" /></p>

<p>可以发现都删完了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image117.webp" alt="" /></p>

<p><strong>你不用担心每次新建工程都需要配置那么多东西。</strong></p>

<p>以上大多数配置文件全部都已经包含在https://github.com/tungchiahui/CubeMX_MDK5to6_Template仓库下的<strong><em><code class="language-plaintext highlighter-rouge">工程文件移植(创建新模板请看这里)</code></em></strong>文件夹了，到时候新建一个工程后，直接把这个文件夹下的所有文件全部复制过来即可。</p>

<h3 id="使用ozone进行flash烧录和debug调试">使用ozone进行Flash烧录和Debug调试</h3>

<h4 id="基础配置">基础配置</h4>

<p>打开终端输入ozone打开软件或者直接找到应用图标打开ozone</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image118.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image119.webp" alt="" /></p>

<p>先选择device，比如我是STM32F407VET6</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image120.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image121.webp" alt="" /></p>

<p>选择Peripherals:</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image122.webp" alt="" /></p>

<p>点击下一步</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image123.webp" alt="" /></p>

<p>你用的SWD就填SWD，是JTAG就填JTAG</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image124.webp" alt="" /></p>

<p>选择ELF</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image125.webp" alt="" /></p>

<p>elf,hex,bin都可以选，一般选elf就行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image126.webp" alt="" /></p>

<p>这一步保持默认即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image127.webp" alt="" /></p>

<p>如果你开启了RTOS可能会遇到这个问题。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>warning <span class="o">(</span>138<span class="o">)</span>: The target application seems to be using FreeRTOS, but FreeRTOS-awareness is not enabled.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>意思是你的目标应用似乎使用了 FreeRTOS，但当前没有启用对 FreeRTOS 的调试支持（RTOS-awareness）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image128.webp" alt="" /></p>

<p>直接按照他底下的提示应用修复即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image129.webp" alt="" /></p>

<p>点继续就行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image130.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image131.webp" alt="" /></p>

<h4 id="烧录与调试">烧录与调试</h4>

<p>可以看下面这个视频，讲的挺好的。<strong>(从30:10开始看）</strong></p>

<p>https://www.bilibili.com/video/BV1yrLHzZEoE</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image132.webp" alt="" /></p>

<p>点击File让他按文件名排序。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image133.webp" alt="" /></p>

<p>找到led_task.cpp点击就可以打开这个源文件啦。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/18/image134.webp" alt="" /></p>

<h1 id="windows">Windows</h1>

<h2 id="环境准备">环境准备</h2>

<p>本教程环境介绍：</p>

<ol>
  <li>
    <p>系统：Windows 11 LSTC</p>
  </li>
  <li>
    <p>系统内核：Windows NT</p>
  </li>
  <li>
    <p>架构：X86_64</p>
  </li>
</ol>

<p>算鸟算鸟，肝部东啦</p>]]></content><author><name>Tung Chia-hui</name></author><category term="环境搭建" /><category term="Linux" /><category term="STM32" /><category term="RTOS" /></entry><entry><title type="html">Jekyll静态网站框架</title><link href="https://jekyll.tungchiahui.cn/blog/jekyll-framework/" rel="alternate" type="text/html" title="Jekyll静态网站框架" /><published>2025-07-01T00:00:00+00:00</published><updated>2025-07-01T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/Jekyll%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E6%A1%86%E6%9E%B6</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/jekyll-framework/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#简介" id="markdown-toc-简介">简介</a></li>
  <li><a href="#部署方案" id="markdown-toc-部署方案">部署方案</a>    <ul>
      <li><a href="#静态网站托管服务pages介绍" id="markdown-toc-静态网站托管服务pages介绍">静态网站托管服务Pages介绍</a></li>
      <li><a href="#内容分发网络cdn介绍" id="markdown-toc-内容分发网络cdn介绍">内容分发网络CDN介绍</a></li>
      <li><a href="#搭配方案" id="markdown-toc-搭配方案">搭配方案</a>        <ul>
          <li><a href="#免费方案" id="markdown-toc-免费方案">免费方案</a></li>
          <li><a href="#付费方案" id="markdown-toc-付费方案">付费方案</a></li>
          <li><a href="#方案展示" id="markdown-toc-方案展示">方案展示</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="简介">简介</h1>

<h1 id="部署方案">部署方案</h1>

<h2 id="静态网站托管服务pages介绍">静态网站托管服务Pages介绍</h2>

<p>Pages一般常用的有Github Pages，Cloudflare Pages和腾讯云Edge One Pages.</p>

<p>一般来说，Github pages是带宽又低，在国内访问又很波动，所以一般不用Github pages.</p>

<p>Cloudflare Pages在全球（除中国大陆🇨🇳）都有高速服务器，所以在全球（除中国大陆🇨🇳）访问都是非常快的，基本延迟都在1～5ms内，缺点就是在中国大陆🇨🇳比较波动。</p>

<p>腾讯云Edge One Pages的服务器主要是在中国（大陆🇨🇳、港澳台🇭🇰🇲🇴🇨🇳）和国外一些主要的国家，但是缺点是可能需要你在国内进行域名备案，但是国内域名备案需要购买服务器等东西，所以成本很高。<strong>（腾讯云Pages自带CDN，所以不用再套一层CDN了）</strong></p>

<p>据说，阿里云(阿里云ESA Pages）也在加班加点的去抄袭Cloudflare和腾讯云EO，从而去阻击腾讯云EdgeOne Pages。不知道何时才会出，希望能够也有免费额度吧。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">平台</th>
      <th style="text-align: left">主要特点</th>
      <th style="text-align: left">费用</th>
      <th style="text-align: left">优势</th>
      <th style="text-align: left">缺点</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">GitHub Pages</td>
      <td style="text-align: left">托管静态网站</td>
      <td style="text-align: left">免费</td>
      <td style="text-align: left">与 GitHub 仓库集成紧密，自动构建方便</td>
      <td style="text-align: left">带宽较低，在中国大陆访问极不稳定</td>
    </tr>
    <tr>
      <td style="text-align: left">Cloudflare Pages</td>
      <td style="text-align: left">全球高性能服务器（不含中国大陆）</td>
      <td style="text-align: left">免费</td>
      <td style="text-align: left">全球访问速度极快，延迟通常仅 1～5 ms；支持自定义域名与CI/CD集成</td>
      <td style="text-align: left">中国大陆访问速度不稳定</td>
    </tr>
    <tr>
      <td style="text-align: left">腾讯云 EdgeOne Pages</td>
      <td style="text-align: left">服务器覆盖中国大陆、港澳台及海外主要节点</td>
      <td style="text-align: left">有免费额度</td>
      <td style="text-align: left">对国内访问速度优秀；支持 EO CDN 一体化加速；免费额度较大</td>
      <td style="text-align: left">若面向大陆用户需备案，备案流程复杂且可能需购买国内服务器</td>
    </tr>
    <tr>
      <td style="text-align: left">阿里云ESA Pages</td>
      <td style="text-align: left">服务器覆盖中国大陆、港澳台及海外主要节点</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
  </tbody>
</table>

<h2 id="内容分发网络cdn介绍">内容分发网络CDN介绍</h2>

<p>CDN（Content Delivery Network）通过在全球布置缓存节点，让用户从距离最近的服务器加载内容，从而大幅提升访问速度并降低源站压力。</p>

<p>常用的CDN有Cloudflare CDN，腾讯云EO CDN，阿里云CDN等等。</p>

<p>Cloudflare CDN在全球（除中国大陆🇨🇳）都有高速服务器，所以在全球（除中国大陆🇨🇳）访问都是比较快的，缺点就是在中国大陆比较波动。</p>

<p>腾讯云Edge One CDN的服务器主要是在中国（大陆🇨🇳、港澳台🇭🇰🇲🇴🇨🇳）和国外一些主要的国家，如果要面向中国大陆🇨🇳用户加速，则需要备案，成本很高。但是可以选择不向中国大陆🇨🇳用户加速，这样，由于腾讯云在中国香港🇭🇰的CDN很优质，所以在国内访问其实速度也不差的。而且最重要的是，目前有免费的配额，对于普通用户来讲完全够用了。</p>

<p>阿里云ESA CDN，和腾讯云EO定位差不多，但是这是一个为了阻击腾讯云EO而加班加点模仿出来的产品，只能说《暂时》远远不如Cloudflare和腾讯云EO好用。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">平台</th>
      <th style="text-align: left">节点分布</th>
      <th style="text-align: left">费用</th>
      <th style="text-align: left">优势</th>
      <th style="text-align: left">缺点</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Cloudflare CDN</td>
      <td style="text-align: left">免费的全球高速节点（除中国大陆）</td>
      <td style="text-align: left">免费</td>
      <td style="text-align: left">性能优秀、配置简便、全球覆盖广</td>
      <td style="text-align: left">中国大陆访问速度波动较大</td>
    </tr>
    <tr>
      <td style="text-align: left">腾讯云 EdgeOne CDN</td>
      <td style="text-align: left">中国大陆、港澳台及海外主要节点</td>
      <td style="text-align: left">有免费额度</td>
      <td style="text-align: left">国内外访问速度平衡；香港节点质量高；提供免费配额</td>
      <td style="text-align: left">若启用大陆加速需备案，成本较高</td>
    </tr>
    <tr>
      <td style="text-align: left">阿里云 ESA</td>
      <td style="text-align: left">中国大陆、港澳台及海外主要节点</td>
      <td style="text-align: left">有免费额度</td>
      <td style="text-align: left">国内外访问速度平衡；香港节点质量高；提供免费配额</td>
      <td style="text-align: left">若启用大陆加速需备案，成本较高。且暂时产品并不像腾讯云EO那样完善。</td>
    </tr>
  </tbody>
</table>

<h2 id="搭配方案">搭配方案</h2>

<h3 id="免费方案">免费方案</h3>

<ol>
  <li><strong>纯免费方案一【Cloudflare Pages + 腾讯云EO CDN（加速全球，但不加速中国大陆）】：</strong><strong>（普通人用这个方案完全够用了，强烈推荐）</strong></li>
</ol>

<p>在中国大陆🇨🇳平均在150ms，在中国香港🇭🇰平均2ms。</p>

<p>这是因为Cloudflare在全球（除中国大陆🇨🇳）都有高速服务器，腾讯云CDN在中国香港🇭🇰也有高速CDN，所以中国大陆访问比较快，完全够用，主要是纯免费。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image1.webp" alt="" /></p>

<ol>
  <li>纯免费方案二【Cloudflare Pages + 阿里云 ESA CDN（加速全球，但不加速中国大陆）】：</li>
</ol>

<p>在中国大陆🇨🇳平均在240ms，在中国香港🇭🇰平均2ms。</p>

<p>这是因为Cloudflare在全球（除中国大陆🇨🇳）都有高速服务器，阿里云CDN在中国香港🇭🇰也有高速CDN，但是目前貌似没有腾讯的优质,所以比腾讯的要差很多.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image2.webp" alt="" /></p>

<ol>
  <li>纯免费方案三【腾讯云EO Pages + 腾讯云EO CDN（加速全球，但不加速中国大陆）】：</li>
</ol>

<p>在中国大陆🇨🇳平均在230ms，在中国香港🇭🇰平均2ms。</p>

<p>不如方案一的原因是，腾讯云只在主要国家有服务器，而Cloudflare在全球（除中国大陆🇨🇳）都有高速服务器，所以不如Cloudflare的速度快。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image3.webp" alt="" /></p>

<ol>
  <li>纯免费方案四【Cloudflare Pages + Cloudflare CDN（加速全球）】：</li>
</ol>

<p>在中国大陆🇨🇳平均在180ms，但有些省（比如江苏省）访问异常，在中国香港🇭🇰、中国台湾🇨🇳平均0～2ms。</p>

<p>这是因为Cloudflare的CDN在中国大陆🇨🇳会抽风，所以才不太行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image4.webp" alt="" /></p>

<ol>
  <li>纯免费方案五【Github Pages】：</li>
</ol>

<p>在中国大陆🇨🇳平均在100ms，在中国香港🇭🇰平均51ms。</p>

<p>看似延迟不低，而且没有像Cloudflare那样被半封禁，实际上带宽低的要命，加载一个图片卡的要死。最不推荐的方案。（连中国香港🇭🇰这种什么方案都2ms的都变成50+ms了，可想而知多么垃圾）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image5.webp" alt="" /></p>

<h3 id="付费方案">付费方案</h3>

<ol>
  <li><strong>付费方案一【腾讯云EO Pages + 腾讯云EO CDN（加速全球，含中国大陆）】：</strong></li>
</ol>

<p>在中国大陆🇨🇳平均在16ms，在中国香港🇭🇰平均2ms。</p>

<p>付费就付费在域名和备案上，成本也没那么高，Pages和CDN都是免费的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image6.webp" alt="" /></p>

<ol>
  <li><strong>付费方案二【阿里云ESA Pages + 阿里云ESA CDN（加速全球，含中国大陆）】：</strong></li>
</ol>

<p>在中国大陆🇨🇳平均在12ms，在中国香港🇭🇰平均2ms,中国台湾🇨🇳平均4ms.</p>

<p>付费就付费在域名和备案上，成本也没那么高，Pages和CDN暂时都是免费的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image7.webp" alt="" /></p>

<ol>
  <li>付费方案三【Cloudflare Pages + 腾讯云EO CDN（加速全球，含中国大陆）】：</li>
</ol>

<p>在中国大陆🇨🇳平均在10ms，在中国香港🇭🇰平均2ms，中国台湾🇨🇳平均20ms。</p>

<p>因为Cloudflare服务器在中国香港🇭🇰，中国台湾🇨🇳，日本🇯🇵等地区，但是腾讯云CDN使用的是中国大陆🇨🇳CDN，这样腾讯高速CDN先从Cloudflare的高速服务器获取内容，再把内容分发给中国大陆用户，还是非常快的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image8.webp" alt="" /></p>

<ol>
  <li>付费方案四【Cloudflare Pages + 阿里云ESA CDN（加速全球，含中国大陆）】：</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image9.webp" alt="" /></p>

<p>在中国大陆🇨🇳平均在10ms，在中国香港🇭🇰平均2ms，中国台湾🇨🇳平均4ms。</p>

<p>因为Cloudflare服务器在中国香港🇭🇰，中国台湾🇨🇳，日本🇯🇵等地区，但是腾讯云CDN使用的是中国大陆🇨🇳CDN，这样腾讯高速CDN先从Cloudflare的高速服务器获取内容，再把内容分发给中国大陆用户，还是非常快的。</p>

<h3 id="方案展示">方案展示</h3>

<ol>
  <li>腾讯EO Pages + 腾讯EO CDN</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image10.webp" alt="" /></p>

<ol>
  <li>阿里云ESA Pages + 阿里云ESA CDN</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image11.webp" alt="" /></p>

<ol>
  <li>Cloudflare Pages + 腾讯EO CDN</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image12.webp" alt="" /></p>

<ol>
  <li>Cloudflare Pages + 阿里云ESA CDN</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image13.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image14.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2025/07/01/image15.webp" alt="" /></p>

<p>强制浏览器刷新缓存</p>

<pre><code class="language-Bash">
# Chrome/Edge 强制刷新组合键
Ctrl + Shift + R (Windows/Linux)
Cmd + Shift + R (Mac)

# Firefox 额外步骤
about:config → 搜索 "browser.cache.disk.enable" → 设为 false → 刷新
</code></pre>

<pre><code class="language-Bash">bundle exec jekyll serve --livereload

# 上面那个出错后，用下面这个把错误全排除就好了
bundle exec jekyll serve --livereload --trace
</code></pre>]]></content><author><name>Tung Chia-hui</name></author><category term="前端" /><category term="Jekyll" /></entry><entry><title type="html">Docker教程</title><link href="https://jekyll.tungchiahui.cn/blog/docker-tutorial/" rel="alternate" type="text/html" title="Docker教程" /><published>2024-10-03T00:00:00+00:00</published><updated>2024-10-03T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/Docker%E6%95%99%E7%A8%8B</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/docker-tutorial/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#简介" id="markdown-toc-简介">简介</a>    <ul>
      <li><a href="#-什么是-docker" id="markdown-toc--什么是-docker">🐳 什么是 Docker？</a></li>
      <li><a href="#-它是怎么工作的" id="markdown-toc--它是怎么工作的">📦 它是怎么工作的？</a></li>
      <li><a href="#-docker-的几个基本概念" id="markdown-toc--docker-的几个基本概念">🔧 Docker 的几个基本概念</a></li>
      <li><a href="#-类比理解" id="markdown-toc--类比理解">🔍 类比理解</a></li>
      <li><a href="#-docker-的核心优势" id="markdown-toc--docker-的核心优势">✅ Docker 的核心优势</a></li>
      <li><a href="#-常见-docker-应用场景" id="markdown-toc--常见-docker-应用场景">📁 常见 Docker 应用场景</a></li>
    </ul>
  </li>
  <li><a href="#安装docker" id="markdown-toc-安装docker">安装Docker</a>    <ul>
      <li><a href="#linux安装docker-engine推荐" id="markdown-toc-linux安装docker-engine推荐">Linux安装Docker Engine(推荐)</a>        <ul>
          <li><a href="#ubuntuapt" id="markdown-toc-ubuntuapt">Ubuntu（APT）</a></li>
          <li><a href="#fedoradnf5" id="markdown-toc-fedoradnf5">Fedora（DNF5）</a></li>
        </ul>
      </li>
      <li><a href="#配置环境" id="markdown-toc-配置环境">配置环境</a>        <ul>
          <li><a href="#检查-docker-服务状态-" id="markdown-toc-检查-docker-服务状态-"><strong>检查 Docker 服务状态</strong> ：</a></li>
          <li><a href="#启动-docker-服务-" id="markdown-toc-启动-docker-服务-"><strong>启动 Docker 服务</strong> ：</a></li>
          <li><a href="#设置-docker-开机自启-" id="markdown-toc-设置-docker-开机自启-"><strong>设置 Docker 开机自启</strong> ：</a></li>
          <li><a href="#将用户添加到-docker-组-" id="markdown-toc-将用户添加到-docker-组-"><strong>将用户添加到 <code class="language-plaintext highlighter-rouge">docker</code> 组</strong> ：</a></li>
          <li><a href="#退出并重新登录-" id="markdown-toc-退出并重新登录-"><strong>退出并重新登录</strong> ：</a></li>
          <li><a href="#重新启动-docker-服务如果需要-" id="markdown-toc-重新启动-docker-服务如果需要-"><strong>重新启动 Docker 服务（如果需要）</strong> ：</a></li>
          <li><a href="#重启电脑后检查-docker-服务状态-" id="markdown-toc-重启电脑后检查-docker-服务状态-"><strong>重启电脑后检查 Docker 服务状态</strong> ：</a></li>
        </ul>
      </li>
      <li><a href="#安装docker-desktopwinmac" id="markdown-toc-安装docker-desktopwinmac">安装Docker Desktop（Win，Mac）</a></li>
    </ul>
  </li>
  <li><a href="#docker直通" id="markdown-toc-docker直通">Docker直通</a>    <ul>
      <li><a href="#usb直通" id="markdown-toc-usb直通">USB直通</a></li>
      <li><a href="#nvidia显卡直通" id="markdown-toc-nvidia显卡直通">NVIDIA显卡直通</a>        <ul>
          <li><a href="#安装" id="markdown-toc-安装">安装</a>            <ul>
              <li><a href="#ubuntu" id="markdown-toc-ubuntu">Ubuntu</a></li>
              <li><a href="#fedora" id="markdown-toc-fedora">Fedora</a></li>
            </ul>
          </li>
          <li><a href="#测试是否可用" id="markdown-toc-测试是否可用">测试是否可用</a></li>
        </ul>
      </li>
      <li><a href="#docker配置cuda和cudnn" id="markdown-toc-docker配置cuda和cudnn">Docker配置CUDA和CuDNN</a></li>
      <li><a href="#配置以太网" id="markdown-toc-配置以太网">配置以太网</a></li>
    </ul>
  </li>
  <li><a href="#dockerhub换源" id="markdown-toc-dockerhub换源">DockerHub换源</a></li>
  <li><a href="#docker容器里的程序的图形界面弹不出来" id="markdown-toc-docker容器里的程序的图形界面弹不出来">docker容器里的程序的图形界面弹不出来</a></li>
  <li><a href="#docker命令学习" id="markdown-toc-docker命令学习">Docker命令学习</a>    <ul>
      <li><a href="#参考文档" id="markdown-toc-参考文档">参考文档</a></li>
      <li><a href="#常用命令" id="markdown-toc-常用命令">常用命令</a>        <ul>
          <li><a href="#run命令的参数非常重要" id="markdown-toc-run命令的参数非常重要"><strong>run命令的参数（非常重要）</strong></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#各种docker容器部署" id="markdown-toc-各种docker容器部署">各种Docker容器部署</a>    <ul>
      <li><a href="#部署容器步骤" id="markdown-toc-部署容器步骤">部署容器步骤</a></li>
      <li><a href="#各大容器拉取" id="markdown-toc-各大容器拉取">各大容器拉取</a>        <ul>
          <li><a href="#vinci机器人队暂时主使用的docker版本" id="markdown-toc-vinci机器人队暂时主使用的docker版本">Vinci机器人队暂时主使用的docker版本</a></li>
          <li><a href="#rosopencv纯cpu版本" id="markdown-toc-rosopencv纯cpu版本">ROS+OpenCV纯CPU版本</a></li>
          <li><a href="#无rosopencv411cuda128cudnn970" id="markdown-toc-无rosopencv411cuda128cudnn970">（无ROS）OpenCV4.11+CUDA12.8+CuDNN9.7.0</a></li>
          <li><a href="#rosopencv411cuda128cudnn970" id="markdown-toc-rosopencv411cuda128cudnn970">ROS+OpenCV4.11+CUDA12.8+CuDNN9.7.0</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#手动创建docker镜像" id="markdown-toc-手动创建docker镜像">手动创建Docker镜像</a>    <ul>
      <li><a href="#dockerfile" id="markdown-toc-dockerfile">DockerFile</a></li>
      <li><a href="#自己创建容器" id="markdown-toc-自己创建容器">自己创建容器</a>        <ul>
          <li><a href="#手动创建" id="markdown-toc-手动创建">手动创建</a></li>
          <li><a href="#手动创建跨平台多架构构建" id="markdown-toc-手动创建跨平台多架构构建">手动创建(跨平台多架构构建)</a></li>
          <li><a href="#清除构建缓存" id="markdown-toc-清除构建缓存">清除构建缓存</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#vscode远程开发" id="markdown-toc-vscode远程开发">VScode远程开发</a></li>
</ul>

<h1 id="简介">简介</h1>

<h2 id="-什么是-docker">🐳 什么是 Docker？</h2>

<p>Docker 是一个开源的 <strong>应用容器引擎</strong> ，可以让开发者将应用和其所有依赖打包成一个“容器”，<strong>一次构建，到处运行。</strong></p>

<p>“<strong>一次构建，到处运行</strong>”也就是说：</p>

<ol>
  <li><strong>之前：</strong></li>
</ol>

<p>之前想跑ROS2+OpenCV+CUDA+CuDNN，我需要在一台电脑上一个一个环境的安装配置，如果我还要在另一台电脑上跑这个，也需要把第二台电脑也这样配置一遍。如果我的系统环境崩了，需要重装系统了，重装完后又双叒叕要再来一遍配置过程，很麻烦。</p>

<ol>
  <li><strong>使用docker后：</strong></li>
</ol>

<p>（docker镜像和docker容器的概念在下下下面，下面这段话里看到镜像和容器的概念先接受就行。）</p>

<p>我只需要在电脑上用docker配置一遍这个ROS2+OpenCV+CUDA+CuDNN环境，然后用docker生成一个镜像，把这个镜像打包好。以后在任何一台电脑上，我都可以直接用这个镜像生成一个容器，而这个容器内就包含了我所需要的ROS2+OpenCV+CUDA+CuDNN环境，如果我的容器环境崩了，我只需要把坏掉的容器删掉，重新由镜像再生成一个新的容器即可。只需要配置一次，以后都可以一键安装这个环境。</p>

<h2 id="-它是怎么工作的">📦 它是怎么工作的？</h2>

<ul>
  <li>
    <p>传统方式：软件运行需要在不同系统上安装各种库、配置环境，很麻烦。</p>
  </li>
  <li>
    <p>Docker方式：打包成“容器”，环境和应用一起封装， <strong>无论在哪运行都一样稳定</strong> 。</p>
  </li>
</ul>

<h2 id="-docker-的几个基本概念">🔧 Docker 的几个基本概念</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">概念</th>
      <th style="text-align: left">解释</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">镜像</td>
      <td style="text-align: left">Image，运行容器的模板，像是一个应用快照</td>
    </tr>
    <tr>
      <td style="text-align: left">容器</td>
      <td style="text-align: left">Container，运行中的镜像实例，有自己的文件系统、网络等</td>
    </tr>
    <tr>
      <td style="text-align: left">Dockerfile</td>
      <td style="text-align: left">构建镜像的脚本，写明安装哪些包、设置哪些环境变量等</td>
    </tr>
    <tr>
      <td style="text-align: left">仓库</td>
      <td style="text-align: left">Registry，存放镜像的地方，比如 Docker Hub</td>
    </tr>
  </tbody>
</table>

<p>抽象化理解:</p>

<p>Docker镜像≈C++类</p>

<p>Docker容器≈C++类实例(即对象)</p>

<p>形象化理解: 镜像可以类似于给电脑装系统的iso镜像文件。 容器可以类似于已经被装到电脑上的可以运行的系统。</p>

<p>把镜像变为容器时，需要用docker run命令添加很多参数，这个可以理解你这个电脑到底有啥硬件配置。</p>

<h2 id="-类比理解">🔍 类比理解</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">传统部署</th>
      <th style="text-align: left">Docker部署</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">手动安装依赖、调试版本不一致问题</td>
      <td style="text-align: left">一次打包环境和代码</td>
    </tr>
    <tr>
      <td style="text-align: left">程序“裸奔”跑在系统上</td>
      <td style="text-align: left">程序“穿着容器”隔离运行</td>
    </tr>
    <tr>
      <td style="text-align: left">容易“在我电脑上能跑”</td>
      <td style="text-align: left">保证“无论在哪都能跑”</td>
    </tr>
  </tbody>
</table>

<p>就像快递包裹： <strong>你不再关心内容怎么运送，因为包装已经帮你做好了一切隔离。</strong></p>

<h2 id="-docker-的核心优势">✅ Docker 的核心优势</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">优势</th>
      <th style="text-align: left">说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">轻量级</td>
      <td style="text-align: left">基于系统内核共享，启动速度快，占资源少</td>
    </tr>
    <tr>
      <td style="text-align: left">跨平台</td>
      <td style="text-align: left">一次构建，到处运行（Windows、Linux、macOS 上都一致）</td>
    </tr>
    <tr>
      <td style="text-align: left">易于迁移部署</td>
      <td style="text-align: left">应用和环境一起封装，不怕依赖不一致</td>
    </tr>
    <tr>
      <td style="text-align: left">易于版本控制</td>
      <td style="text-align: left">镜像版本可控，支持回滚</td>
    </tr>
    <tr>
      <td style="text-align: left">生态丰富</td>
      <td style="text-align: left">Docker Hub 上有成千上万的现成镜像可用</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>在Linux上可以几乎实现无性能损失。</li>
</ol>

<p>docker里的发行版和本机共用Linux内核。</p>

<p>CPU损耗不到1%。 内存接近原生没损耗。 硬盘损耗不到2%。 网络性能接近原生没有损耗。 显卡损耗小于1%。</p>

<ol>
  <li>可以快速部署在绝大多数Linux发行版</li>
</ol>

<p>你想跑ROS2，之前是仅在Ubuntu上是比较好部署的，但是现在你可以使用任意发行版，比如Fedora，ArchLinux等发行版上也能通过docker跑ROS2。</p>

<ol>
  <li>配置环境简单</li>
</ol>

<p>之前你需要在Ubuntu上按照教程安装ROS2，CUDA，CuDNN，OpenCV4等等，但是只要你用了Docker，可以直接用docker pull命令拉取别人配置好的开发环境，只需要一条命令直通罗马。</p>

<p>你仅仅只需要把一个发行版最基础的东西配置好，比如那些仓库换源，输入法，显卡驱动（只用让显卡工作起来，不用在本机配置CUDA和CuDNN）等。</p>

<ol>
  <li>生态丰富</li>
</ol>

<p>生态及其丰富，有很多东西即便自己不构建，也能在dockerhub上找到别人构建好的镜像，自己连编译都省去了。</p>

<p>比如之前配置cuda和cudnn的话，需要在本机先安装英伟达驱动，再安装CUDA和CuDNN。而现在，我们只需要本机安装英伟达驱动，英伟达官方在DockerHub上提供了CUDA和CUDNN的镜像，他们已经编译好了，我们可以直接拿来用。</p>

<h2 id="-常见-docker-应用场景">📁 常见 Docker 应用场景</h2>

<ul>
  <li>
    <p>本地开发：快速搭建各种开发环境（如 Python + Jupyter、ROS + Gazebo）</p>
  </li>
  <li>
    <p>测试部署：CI/CD 中自动测试、构建、部署</p>
  </li>
  <li>
    <p>微服务架构：每个服务一个容器，灵活组合</p>
  </li>
  <li>
    <p>科研工具封装：复现别人论文环境，或封装自己的项目发给他人使用</p>
  </li>
</ul>

<h1 id="安装docker">安装Docker</h1>

<h2 id="linux安装docker-engine推荐">Linux安装Docker Engine(推荐)</h2>

<p>Linux只需要安装Docker Engine就可以，不要安装docker desktop，那玩意是专门给Mac和Windows用的。</p>

<p>Linux跑docker性能损失很低，而Windows和MacOS跑docker损失相对于大一些。</p>

<p>https://docs.docker.com/engine/install/</p>

<p>https://mirrors.bfsu.edu.cn/help/docker-ce/</p>

<h3 id="ubuntuapt">Ubuntu（APT）</h3>

<p>以下内容根据 <a href="https://docs.docker.com/engine/install/ubuntu/">官方文档</a> 修改而来。</p>

<p>如果你过去安装过 docker，先删掉：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">for </span>pkg <span class="k">in </span>docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc<span class="p">;</span> <span class="k">do </span><span class="nb">sudo </span>apt-get remove <span class="nv">$pkg</span><span class="p">;</span> <span class="k">done</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>首先安装依赖和GPG：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c"># Add Docker's official GPG key:</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>ca-certificates curl
<span class="nb">sudo install</span> <span class="nt">-m</span> 0755 <span class="nt">-d</span> /etc/apt/keyrings
<span class="nb">sudo </span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/docker.gpg
<span class="nb">sudo chmod </span>a+r /etc/apt/keyrings/docker.asc

<span class="c"># 如果上面这行报错就弄下面这行</span>
<span class="nb">sudo chmod </span>a+r /etc/apt/keyrings/docker.gpg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>信任 Docker 的 GPG 公钥并添加仓库：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Add the repository to Apt sources:</span>
<span class="nb">echo</span> <span class="se">\</span>
  <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.bfsu.edu.cn/docker-ce/linux/ubuntu </span><span class="se">\</span><span class="s2">
  "</span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2">" stable"</span> | <span class="se">\</span>
  <span class="nb">sudo tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最后安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="fedoradnf5">Fedora（DNF5）</h3>

<p>以下内容根据 <a href="https://docs.docker.com/engine/install/fedora/">官方文档</a> 修改而来。(官方教程还是DNF4,太老了，请看下方的教程)</p>

<p>如果你之前安装过 docker，请先删掉</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf remove docker <span class="se">\</span>
                  docker-client <span class="se">\</span>
                  docker-client-latest <span class="se">\</span>
                  docker-common <span class="se">\</span>
                  docker-latest <span class="se">\</span>
                  docker-latest-logrotate <span class="se">\</span>
                  docker-logrotate <span class="se">\</span>
                  docker-selinux <span class="se">\</span>
                  docker-engine-selinux <span class="se">\</span>
                  docker-engine
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装依赖，下载 repo 文件，并把软件仓库地址替换为镜像站：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nt">-y</span> <span class="nb">install </span>dnf-plugins-core
<span class="nb">sudo </span>dnf config-manager addrepo <span class="nt">--from-repofile</span><span class="o">=</span>https://download.docker.com/linux/fedora/docker-ce.repo
<span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s+https://download.docker.com+https://mirrors.bfsu.edu.cn/docker-ce+'</span> /etc/yum.repos.d/docker-ce.repo
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最后安装：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install </span>docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="配置环境">配置环境</h2>

<h3 id="检查-docker-服务状态-"><strong>检查 Docker 服务状态</strong> ：</h3>

<p>在 Linux 上，你可以通过以下命令检查 Docker 服务的状态：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>systemctl status docker
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="启动-docker-服务-"><strong>启动 Docker 服务</strong> ：</h3>

<p>如果服务没有运行，可以使用以下命令启动 Docker 服务：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl start docker
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="设置-docker-开机自启-"><strong>设置 Docker 开机自启</strong> ：</h3>

<p>如果你希望 Docker 在每次启动时自动运行，可以启用开机自启：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="将用户添加到-docker-组-"><strong>将用户添加到 <code class="language-plaintext highlighter-rouge">docker</code> 组</strong> ：</h3>

<p>使用以下命令将当前用户添加到 <code class="language-plaintext highlighter-rouge">docker</code> 组：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="退出并重新登录-"><strong>退出并重新登录</strong> ：</h3>

<p>执行完上述命令后，你需要退出当前会话并重新登录，或者运行以下命令使更改生效：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>newgrp docker
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="重新启动-docker-服务如果需要-"><strong>重新启动 Docker 服务（如果需要）</strong> ：</h3>

<p>确保 Docker 服务正在运行，可以使用以下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl start docker
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="重启电脑后检查-docker-服务状态-"><strong>重启电脑后检查 Docker 服务状态</strong> ：</h3>

<p>先重启电脑，接着你可以通过以下命令检查 Docker 服务的状态，看看是否正常：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>reboot

systemctl status docker
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image1.webp" alt="" /></p>

<h2 id="安装docker-desktopwinmac">安装Docker Desktop（Win，Mac）</h2>

<p>(Docker Desktop在Windows和MacOS使用的是虚拟机，性能有损失，在这俩系统上可以用，但是你需要接受这些性能损失。在Windows上性能损失和WSL2的损失几乎一样，因为Windows的docker desktop基于wsl2)</p>

<p>(Docker Desktop在Linux上只是Docker Engine的一个GUI管理工具，依然默认使用Docker Engine开启容器，所以依然几乎没有损耗，讨厌用命令行的可以考虑使用)</p>

<p>官方下载安装:https://www.docker.com/</p>

<p>Windows的Docker显卡直通与USB直通:</p>

<p>在Windows上想Nvidia显卡直通的话，需要先去DockerDesktop设置里开启WSL2支持并勾选一个wsl2的发行版，比如Ubuntu22.04，紧接着，需要进入wsl2的Ubuntu22.04中安装NVIDIA Container Toolkit，教程在下方。</p>

<p>在Windows的Docker上想要USB直通需要先让wsl2直通该usb，再在docker run命令将该设备添加到docker。(如果把wsl2所有设备全挂载到docker了，那么只需要让usb直通wsl2)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image2.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image3.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image4.webp" alt="" /></p>

<h1 id="docker直通">Docker直通</h1>

<h2 id="usb直通">USB直通</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image5.webp" alt="" /></p>

<ol>
  <li>方法一(不是很推荐新手)：</li>
</ol>

<p>创建容器的时候把需要的设备加在红色部分这里即可。可以通过下面的命令查看想要的设备的名字。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">ls</span> /dev
<span class="c">#例如</span>
<span class="nt">--device</span><span class="o">=</span>/dev/tty_USB0
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>方法二(个人更加推荐，不用重新再挂载了，虽然安全性会降低，但是别人利用安全权限能够攻击你的概率很低很低，企业服务器才需要提防)：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">--privileged</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>直接添加一行绿色部分，然后所有设备都会被挂载到docker了。(红色部分就不用写了）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image6.webp" alt="" /></p>

<h2 id="nvidia显卡直通">NVIDIA显卡直通</h2>

<p>NVIDIA Container Toolkit使用户 <strong>能够构建和运行GPU加速的容器</strong> 。该工具包包括一个容器运行库和实用程序，用于自动配置容器以利用NVIDIA GPU。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image7.webp" alt="" /></p>

<p>https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html</p>

<h3 id="安装">安装</h3>

<p>（尽量能看官方就看官方的，安装方式可能会更新）</p>

<h4 id="ubuntu">Ubuntu</h4>

<ol>
  <li>配置存储库 并更新</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>curl <span class="nt">-fsSL</span> https://nvidia.github.io/libnvidia-container/gpgkey | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg <span class="se">\</span>
  <span class="o">&amp;&amp;</span> curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | <span class="se">\</span>
    <span class="nb">sed</span> <span class="s1">'s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g'</span> | <span class="se">\</span>
    <span class="nb">sudo tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list <span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">sudo </span>apt-get update
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>安装nvidia-docker2</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> nvidia-docker2
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>使用nvidia-ctk命令配置container runtime</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>nvidia-ctk runtime configure <span class="nt">--runtime</span><span class="o">=</span>docker
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>重启docker服务:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart docker
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="fedora">Fedora</h4>

<ol>
  <li>Configure the production repository:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | <span class="se">\</span>
<span class="nb">sudo tee</span> /etc/yum.repos.d/nvidia-container-toolkit.repo
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>Optionally, configure the repository to use experimental packages:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 如果是RHEL或者Rocky（DNF4）</span>
<span class="nb">sudo </span>dnf config-manager <span class="nt">--add-repo</span> https://nvidia.github.io/libnvidia-container/stable/rpm/libnvidia-container.repo

<span class="c"># 如果是Feodra41+（DNF5）</span>
<span class="nb">sudo </span>dnf config-manager addrepo <span class="nt">--from-repofile</span><span class="o">=</span>https://nvidia.github.io/libnvidia-container/stable/rpm/libnvidia-container.repo
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>Install the NVIDIA Container Toolkit packages:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 如果是RHEL或者Rocky</span>
<span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">-y</span> nvidia-container-toolkit

<span class="c"># 如果是Fedora</span>
<span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">-y</span> nvidia-container-toolkit
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li><strong>安装nvidia-docker2</strong> ： 在Fedora上使用<code class="language-plaintext highlighter-rouge">dnf</code>进行安装。</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">-y</span> nvidia-docker2
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li><strong>使用nvidia-ctk命令配置容器运行时</strong> ： 这个命令用于配置NVIDIA Container Toolkit与Docker集成。命令如下：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>nvidia-ctk runtime configure <span class="nt">--runtime</span><span class="o">=</span>docker
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li><strong>重启Docker服务</strong> ： 完成配置后，必须重启Docker服务以使更改生效：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart docker
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这些步骤执行后，Docker将使用NVIDIA Container Runtime，并支持GPU加速的容器运行。你可以使用<code class="language-plaintext highlighter-rouge">nvidia-smi</code>命令来验证容器中的NVIDIA GPU是否可用。</p>

<h3 id="测试是否可用">测试是否可用</h3>

<ol>
  <li><strong>运行nvidia cuda 容器进行测试</strong> ：</li>
</ol>

<p>可以使用下面指令进行测试，docker会自动从nvidia/cuda拉取11.0.3-base-ubuntu20.04镜像，并创建一个运行一次即删除的容器。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>docker run <span class="nt">--rm</span> <span class="nt">--gpus</span> all nvidia/cuda:11.0.3-base-ubuntu20.04 nvidia-smi
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image8.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image9.webp" alt="" /></p>

<h2 id="docker配置cuda和cudnn">Docker配置CUDA和CuDNN</h2>

<p>如果你不需要自己创建Docker镜像，直接使用学长或者其他人创建好的镜像，则不用看该章节，容器的CUDA和CuDNN是和本地完全隔离的环境，你本地有没有CUDA都无所谓，但英伟达驱动版本必须满足CUDA的最低版本要求。</p>

<p>下面是如果你想自己创建镜像，则可以在学会如何创建容器的镜像后再回来看本节：</p>

<p>https://hub.docker.com/r/nvidia/cuda</p>

<p>在上方这个网站中，英伟达都帮我们配置好了CUDA和CuDNN了，我们根本不需要自己去配置了，比传统方式要简单太多太多了。</p>

<p>我们只需要找到对应的Docker镜像当底包即可。</p>

<p>CUDA镜像有三个类型，如下，如果我们需要编译OpenCV4,那么需要使用devel版的CUDA。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">镜像类型</th>
      <th style="text-align: left">适用场景</th>
      <th style="text-align: left">示例标签</th>
      <th style="text-align: left">大小</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">base</td>
      <td style="text-align: left">仅需 CUDA 运行时库</td>
      <td style="text-align: left">12.4.0-base-ubuntu22.04</td>
      <td style="text-align: left">~240MB</td>
    </tr>
    <tr>
      <td style="text-align: left">runtime</td>
      <td style="text-align: left">部署编译后的应用（含数学库）</td>
      <td style="text-align: left">12.4.0-runtime-ubuntu22.04</td>
      <td style="text-align: left">~2GB</td>
    </tr>
    <tr>
      <td style="text-align: left">devel</td>
      <td style="text-align: left">开发环境（含编译工具）</td>
      <td style="text-align: left">12.4.0-devel-ubuntu22.04</td>
      <td style="text-align: left">~3GB</td>
    </tr>
  </tbody>
</table>

<p>我示例一个，比如我想用在Ubuntu24.04上用CUDA12.6和CuDNN，那么就选择<code class="language-plaintext highlighter-rouge">nvidia/cuda:12.6.0-cudnn-devel-ubuntu24.04</code>。这个镜像既有CUDA-devel也有CuDNN，而且还是基于Ubuntu24.04的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image10.webp" alt="" /></p>

<p>在dockerfile里就可以开头这么写。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 基于NVIDIA官方CUDA 12.6和CuDNN基础镜像</span>
<span class="k">FROM</span><span class="s"> nvidia/cuda:12.6.0-cudnn-devel-ubuntu24.04</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="配置以太网">配置以太网</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>启动参数里加上这行即可。具体在下方。</p>

<h1 id="dockerhub换源">DockerHub换源</h1>

<p>（DockerHub已于2024年5月被🇨🇳封杀，各大国内镜像源均已下架DockerHub镜像源，直接挂梯用官方源吧）</p>

<p>各大镜像源只有Docker-Ce的镜像库，这个是用来安装docker的，而不是dockerhub的镜像源。</p>

<h1 id="docker容器里的程序的图形界面弹不出来">docker容器里的程序的图形界面弹不出来</h1>

<p>（等你成功创建容器后，再回来搞这个操作）</p>

<p>临时允许X11访问： 每次开机在主机上运行以下命令以允许X11访问：(但每次开机都运行一遍命令很麻烦，可以写成脚本开机自启，详见 <a href="/blog/linux-tutorial/#自启应用与脚本">自启应用与脚本</a>)</p>

<p>命令如下:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>xhost +local:docker
</pre></td></tr></tbody></table></code></pre></div></div>

<p>自启脚本如下:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="c"># 等待 X Server 就绪（最多等 10 秒）</span>
<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$DISPLAY</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> xset q <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then</span>
        /usr/bin/xhost +local:docker
        <span class="nb">exit </span>0
    <span class="k">fi
    </span><span class="nb">sleep </span>1
<span class="k">done</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>教程部分如下：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image11.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image12.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image13.webp" alt="" /></p>

<h1 id="docker命令学习">Docker命令学习</h1>

<h2 id="参考文档">参考文档</h2>

<p>https://www.runoob.com/docker/docker-tutorial.html</p>

<h2 id="常用命令">常用命令</h2>

<p>常用的标红了，偶尔用的标绿了，其他了解就行。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">命令</th>
      <th style="text-align: left">描述</th>
      <th style="text-align: left">示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">docker run</td>
      <td style="text-align: left">创建并启动一个新的容器。</td>
      <td style="text-align: left">docker run -it ubuntu bash</td>
    </tr>
    <tr>
      <td style="text-align: left">docker build</td>
      <td style="text-align: left">通过指定的 Dockerfile 创建一个新的镜像。</td>
      <td style="text-align: left">docker build -t myimage .</td>
    </tr>
    <tr>
      <td style="text-align: left">docker pull</td>
      <td style="text-align: left">从 Docker 仓库拉取镜像。</td>
      <td style="text-align: left">docker pull ubuntu</td>
    </tr>
    <tr>
      <td style="text-align: left">docker push</td>
      <td style="text-align: left">将本地镜像推送到 Docker 仓库。</td>
      <td style="text-align: left">docker push myimage</td>
    </tr>
    <tr>
      <td style="text-align: left">docker stop</td>
      <td style="text-align: left">停止一个正在运行的容器。</td>
      <td style="text-align: left">docker stop container_id</td>
    </tr>
    <tr>
      <td style="text-align: left">docker start</td>
      <td style="text-align: left">启动一个已经存在的容器。</td>
      <td style="text-align: left">docker start container_id</td>
    </tr>
    <tr>
      <td style="text-align: left">docker restart</td>
      <td style="text-align: left">重新启动容器。</td>
      <td style="text-align: left">docker restart container_id</td>
    </tr>
    <tr>
      <td style="text-align: left">docker ps</td>
      <td style="text-align: left">列出当前正在运行的容器。</td>
      <td style="text-align: left">docker ps</td>
    </tr>
    <tr>
      <td style="text-align: left">docker rm</td>
      <td style="text-align: left">删除一个或多个停止的容器。</td>
      <td style="text-align: left">docker rm container_id</td>
    </tr>
    <tr>
      <td style="text-align: left">docker exec</td>
      <td style="text-align: left">在一个正在运行的容器中执行命令。</td>
      <td style="text-align: left">docker exec -it container_id bash</td>
    </tr>
    <tr>
      <td style="text-align: left">docker logs</td>
      <td style="text-align: left">查看容器的日志输出。</td>
      <td style="text-align: left">docker logs container_id</td>
    </tr>
    <tr>
      <td style="text-align: left">docker images</td>
      <td style="text-align: left">列出本地所有镜像。</td>
      <td style="text-align: left">docker images</td>
    </tr>
    <tr>
      <td style="text-align: left">docker rmi</td>
      <td style="text-align: left">删除一个或多个镜像。</td>
      <td style="text-align: left">docker rmi myimage</td>
    </tr>
    <tr>
      <td style="text-align: left">docker network</td>
      <td style="text-align: left">管理 Docker 网络。</td>
      <td style="text-align: left">docker network ls</td>
    </tr>
    <tr>
      <td style="text-align: left">docker volume</td>
      <td style="text-align: left">管理 Docker 数据卷。</td>
      <td style="text-align: left">docker volume ls</td>
    </tr>
    <tr>
      <td style="text-align: left">docker-compose up</td>
      <td style="text-align: left">启动 docker-compose.yml 中定义的所有服务。</td>
      <td style="text-align: left">docker-compose up</td>
    </tr>
    <tr>
      <td style="text-align: left">docker-compose down</td>
      <td style="text-align: left">停止并移除 docker-compose.yml 中定义的所有服务及其相关资源。</td>
      <td style="text-align: left">docker-compose down</td>
    </tr>
    <tr>
      <td style="text-align: left">docker info</td>
      <td style="text-align: left">显示 Docker 系统的详细信息。</td>
      <td style="text-align: left">docker info</td>
    </tr>
    <tr>
      <td style="text-align: left">docker stats</td>
      <td style="text-align: left">查看正在运行的容器的实时资源使用情况（CPU、内存等）。</td>
      <td style="text-align: left">docker stats</td>
    </tr>
    <tr>
      <td style="text-align: left">docker inspect</td>
      <td style="text-align: left">查看容器或镜像的详细信息（JSON 格式）。</td>
      <td style="text-align: left">docker inspect container_id</td>
    </tr>
    <tr>
      <td style="text-align: left">docker save</td>
      <td style="text-align: left">将一个镜像保存为 tar 文件。</td>
      <td style="text-align: left">docker save -o myimage.tar myimage</td>
    </tr>
    <tr>
      <td style="text-align: left">docker load</td>
      <td style="text-align: left">从 tar 文件中加载镜像。</td>
      <td style="text-align: left">docker load -i myimage.tar</td>
    </tr>
    <tr>
      <td style="text-align: left">docker tag</td>
      <td style="text-align: left">为镜像添加标签（tag）。</td>
      <td style="text-align: left">docker tag myimage myimage:v1</td>
    </tr>
    <tr>
      <td style="text-align: left">docker buildx build</td>
      <td style="text-align: left">使用 Buildx 构建多架构镜像。</td>
      <td style="text-align: left">docker buildx build -t myimage .</td>
    </tr>
    <tr>
      <td style="text-align: left">docker buildx create</td>
      <td style="text-align: left">创建一个新的 Buildx 构建实例。</td>
      <td style="text-align: left">docker buildx create –use</td>
    </tr>
    <tr>
      <td style="text-align: left">docker buildx ls</td>
      <td style="text-align: left">列出所有可用的 Buildx 构建实例。</td>
      <td style="text-align: left">docker buildx ls</td>
    </tr>
    <tr>
      <td style="text-align: left">docker buildx use</td>
      <td style="text-align: left">设置当前的 Buildx 构建实例。</td>
      <td style="text-align: left">docker buildx use mybuilder</td>
    </tr>
    <tr>
      <td style="text-align: left">docker buildx bake</td>
      <td style="text-align: left">使用 Bake 文件批量构建镜像。</td>
      <td style="text-align: left">docker buildx bake -f bake.hcl</td>
    </tr>
    <tr>
      <td style="text-align: left">docker buildx build –push</td>
      <td style="text-align: left">构建镜像并推送到镜像仓库。</td>
      <td style="text-align: left">docker buildx build –push -t myimage .</td>
    </tr>
    <tr>
      <td style="text-align: left">docker buildx build –platform</td>
      <td style="text-align: left">构建镜像并为多个平台生成支持。</td>
      <td style="text-align: left">docker buildx build –platform linux/amd64,linux/arm64 -t myimage .</td>
    </tr>
  </tbody>
</table>

<h3 id="run命令的参数非常重要"><strong>run命令的参数（非常重要）</strong></h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">参数/配置</th>
      <th style="text-align: left">功能说明</th>
      <th style="text-align: left">重要性与参考依据</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">–name=ros_jazzy_opencv411_cuda128_cudnn971_noble</td>
      <td style="text-align: left">指定容器名称，便于后续管理</td>
      <td style="text-align: left">替代随机生成的容器名。</td>
    </tr>
    <tr>
      <td style="text-align: left">–gpus all</td>
      <td style="text-align: left">允许容器访问宿主机所有GPU资源，需NVIDIA驱动支持</td>
      <td style="text-align: left">用于CUDA加速等GPU依赖任务。</td>
    </tr>
    <tr>
      <td style="text-align: left">-e NVIDIA_DRIVER_CAPABILITIES=all</td>
      <td style="text-align: left">启用NVIDIA驱动的全部功能（如CUDA、图形渲染）</td>
      <td style="text-align: left">确保容器内GPU功能完整67。</td>
    </tr>
    <tr>
      <td style="text-align: left">-dit</td>
      <td style="text-align: left">组合参数：- -d：后台运行容器（Detached模式）- -i：保持标准输入（STDIN）开放- -t：分配伪终端（TTY）</td>
      <td style="text-align: left">允许容器在后台运行并支持交互操作。</td>
    </tr>
    <tr>
      <td style="text-align: left">–privileged</td>
      <td style="text-align: left">赋予容器完全主机权限（可访问设备、内核模块等）</td>
      <td style="text-align: left">用于需要直接操作硬件的场景（如访问USB设备），但存在安全风险。</td>
    </tr>
    <tr>
      <td style="text-align: left">–net=host</td>
      <td style="text-align: left">共享宿主机网络命名空间（容器使用宿主机IP和端口）</td>
      <td style="text-align: left">简化网络配置，无NAT，这样的话，网络效率更高，局域网设备更容易发现。</td>
    </tr>
    <tr>
      <td style="text-align: left">–group-add audio–group-add video–group-add dialout</td>
      <td style="text-align: left">将容器用户加入宿主机用户组：- audio：音频设备访问- video：视频设备访问- dialout：串口设备访问</td>
      <td style="text-align: left">避免权限问题（如避免无法调用摄像头、麦克风）。</td>
    </tr>
    <tr>
      <td style="text-align: left">-e DISPLAY=$DISPLAY-e XAUTHORITY=/home/tungchiahui/.Xauthority-e WAYLAND_DISPLAY-e XDG_RUNTIME_DIR-e QT_QPA_PLATFORM=xcb</td>
      <td style="text-align: left">配置图形显示环境：- 绑定宿主机显示接口（X11或Wayland）- 设置GUI应用渲染后端</td>
      <td style="text-align: left">支持容器内运行图形界面应用（如OpenCV可视化）。</td>
    </tr>
    <tr>
      <td style="text-align: left">-v /tmp/.X11-unix:/tmp/.X11-unix:rw-v /dev/dri:/dev/dri</td>
      <td style="text-align: left">挂载宿主机图形设备：- X11套接字目录- 直接渲染管理器（DRI）设备</td>
      <td style="text-align: left">实现容器内图形显示。</td>
    </tr>
    <tr>
      <td style="text-align: left">-v $HOME/.Xauthority:/home/tungchiahui/.Xauthority:ro</td>
      <td style="text-align: left">挂载X11认证文件（只读）</td>
      <td style="text-align: left">确保容器有权连接宿主机显示服务。</td>
    </tr>
    <tr>
      <td style="text-align: left">-v /run/user/1000/wayland-0-v /run/user/1000</td>
      <td style="text-align: left">挂载Wayland显示协议相关目录</td>
      <td style="text-align: left">支持Wayland协议的图形显示。</td>
    </tr>
    <tr>
      <td style="text-align: left">–ulimit nofile=1024:524288</td>
      <td style="text-align: left">设置进程<strong>最大可打开文件数（nofile）</strong>的方式，用于控制容器或进程运行时的文件句柄数量限制。–ulimit <限制类型>=<软限制>:<硬限制></硬限制></软限制></限制类型></td>
      <td style="text-align: left">如果默认限制太小，可能会出现 “too many open files” 的错误。所以在容器运行或系统服务启动时，需要调大这个值。–ulimit nofile=4096:65536</td>
    </tr>
    <tr>
      <td style="text-align: left">-v /home/tungchiahui:/home/tungchiahui</td>
      <td style="text-align: left">挂载宿主机用户目录到容器内同名路径</td>
      <td style="text-align: left">实现宿主机与容器间文件共享（如代码、数据持久化）。</td>
    </tr>
    <tr>
      <td style="text-align: left">-w /home/tungchiahui</td>
      <td style="text-align: left">设置容器启动后的默认工作目录</td>
      <td style="text-align: left">直接进入项目路径，方便执行命令2324。</td>
    </tr>
    <tr>
      <td style="text-align: left">tungchiahui/ros-opencv:jazzy-411-cuda128-cudnn971-noble</td>
      <td style="text-align: left">镜像名称指定镜像及标签，包含：- ROS 2 Jazzy- OpenCV 4.11- CUDA 12.8- cuDNN 9.7.1</td>
      <td style="text-align: left">提供预配置的深度学习与机器人开发环境。</td>
    </tr>
  </tbody>
</table>

<p>下方这条命令一定要在普通用户下运行，不要在root用户下运行，其实加不加<code class="language-plaintext highlighter-rouge">sudo</code>加不加<code class="language-plaintext highlighter-rouge">sudo -E</code>都无所谓。</p>

<p>用户已经被加到docker组了，不用<code class="language-plaintext highlighter-rouge">sudo</code>也行跑，其次，<code class="language-plaintext highlighter-rouge">sudo</code>运行的话，你的<code class="language-plaintext highlighter-rouge">$HOME</code>变量也不会变，更何况加上-E的话，这样你的<code class="language-plaintext highlighter-rouge">$HOME</code>更不可能变了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>docker run <span class="nt">--name</span><span class="o">=</span>ros_opencv_cuda <span class="se">\</span>
<span class="nt">--gpus</span> all <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">NVIDIA_DRIVER_CAPABILITIES</span><span class="o">=</span>all <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DISPLAY</span><span class="o">=</span><span class="nv">$DISPLAY</span> <span class="se">\</span>
<span class="nt">-dit</span> <span class="se">\</span>
<span class="nt">--privileged</span> <span class="se">\</span>
<span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
<span class="nt">--group-add</span> audio <span class="se">\</span>
<span class="nt">--group-add</span> video <span class="se">\</span>
<span class="nt">--group-add</span> dialout <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">XAUTHORITY</span><span class="o">=</span><span class="nv">$HOME</span>/.Xauthority <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">WAYLAND_DISPLAY</span><span class="o">=</span><span class="nv">$WAYLAND_DISPLAY</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">XDG_RUNTIME_DIR</span><span class="o">=</span><span class="nv">$XDG_RUNTIME_DIR</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">QT_QPA_PLATFORM</span><span class="o">=</span>xcb <span class="se">\</span>
<span class="nt">-v</span> /tmp/.X11-unix:/tmp/.X11-unix:rw <span class="se">\</span>
<span class="nt">-v</span> /dev/dri:/dev/dri <span class="se">\</span>
<span class="nt">-v</span> <span class="nv">$HOME</span>/.Xauthority:<span class="nv">$HOME</span>/.Xauthority:ro <span class="se">\</span>
<span class="nt">-v</span> /run/user/<span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>/wayland-0:/run/user/<span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>/wayland-0 <span class="se">\</span>
<span class="nt">-v</span> /run/user/<span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:/run/user/<span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span> <span class="se">\</span>
<span class="nt">-v</span> <span class="nv">$HOME</span>:<span class="nv">$HOME</span> <span class="se">\</span>
<span class="nt">-w</span> <span class="nv">$HOME</span> <span class="se">\</span>
tungchiahui/ros-opencv:humble-411-cuda128-cudnn970-jammy
</pre></td></tr></tbody></table></code></pre></div></div>

<p>注意：</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">NVIDIA_DRIVER_CAPABILITIES=all</code> <code class="language-plaintext highlighter-rouge">--gpus all</code>没有英伟达显卡请注释。</p>
  </li>
  <li>
    <p>--name后面请自己为容器起名。</p>
  </li>
  <li>
    <p>最后一行仓库名称请你自己找对应的镜像填上。</p>
  </li>
  <li>
    <p>ROS1在Fedora发行版下会爆内存，需要添加上下面这个参数，如果你不是Fedora和ROS1,<strong><em>请不要加</em></strong>。</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">--ulimit</span> <span class="nv">nofile</span><span class="o">=</span>1024:524288 <span class="se">\</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>如果想用当前用户登陆容器,可以加上下面这几条,但非常非常<strong><em>不建议</em></strong><strong>.</strong></li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">--user</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="se">\</span>
<span class="nt">-v</span> /etc/passwd:/etc/passwd:ro <span class="se">\</span>
<span class="nt">-v</span> /etc/group:/etc/group:ro <span class="se">\</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="各种docker容器部署">各种Docker容器部署</h1>

<h2 id="部署容器步骤">部署容器步骤</h2>

<p>先从dockerhub拉取（docker pull）镜像，<strong>然后再通过docker run命令创建容器即可。</strong>（直接运行docker run命令也行，这会自己寻找本地镜像并创建，如果本地没有则会自动去dockerhub上寻找镜像并拉取创建容器一条龙服务。）</p>

<p>下面是各大容器拉取的命令（均支持amd64和arm64架构）：</p>

<h2 id="各大容器拉取">各大容器拉取</h2>

<h3 id="vinci机器人队暂时主使用的docker版本">Vinci机器人队暂时主使用的docker版本</h3>

<p><strong>（该版本暂未构建上传到dockerhub，但是tungchiahui/ros-opencv:humble-411-cuda128-cudnn970-jammy已经实现了下列说的全部了）</strong></p>

<p>https://hub.docker.com/repositories/sdutvincirobot</p>

<p>https://github.com/SDUTVINCI/docker</p>

<p>使用以下带有CUDA和CuDNN的Docker必须满足的条件:</p>

<ol>
  <li>
    <p>有英伟达NVIDIA独立显卡</p>
  </li>
  <li>
    <p>显卡驱动必须满足≥570.86.10</p>
  </li>
  <li>
    <p>设备的架构必须为amd64(x86_64)架构或者aarch64(arm64)架构。(绝大多数设备均满足)</p>
  </li>
  <li>
    <p>支持的显卡型号如下:</p>

    <ol>
      <li>
        <p>GTX10系列桌面端、移动端显卡均已支持</p>
      </li>
      <li>
        <p>RTX20-RTX50系列桌面端、移动端显卡均已支持</p>
      </li>
      <li>
        <p>NVIDIA Jetson AGX Orin、NVIDIA Jetson Orin NX、NVIDIA Jetson Orin Nano工控机已支持</p>
      </li>
      <li>
        <p>NVIDIA Jetson AGX Xavier、NVIDIA Jetson Xavier NX工控机已支持</p>
      </li>
      <li>
        <p>其他显卡均未适配，强行使用其他显卡肯定会有不兼容的问题，如果想要适配你的显卡型号，请单独联系学长</p>
      </li>
    </ol>
  </li>
</ol>

<p>该镜像包含的内容：</p>

<ol>
  <li>
    <p>Ubuntu22.04</p>
  </li>
  <li>
    <p>ROS2 Humble</p>
  </li>
  <li>
    <p>OpenCV4.11</p>
  </li>
  <li>
    <p>CUDA12.8</p>
  </li>
  <li>
    <p>CuDNN9.7.0</p>
  </li>
  <li>
    <p>cv_bridge(amd64支持，但arm64暂时没构建，请自行构建)</p>
  </li>
  <li>
    <p>Livox-SDK2</p>
  </li>
  <li>
    <p>(但无Livox-ROS-Driver2，自己在ws下编译吧)</p>
  </li>
</ol>

<p>请电控组成员在组长的允许下，变更该docker镜像内容，dockerfile和镜像均上传到github及dockerhub上了。</p>

<ol>
  <li>从dockerhub上拉取镜像</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker pull sdutvincirobot/ros-opencv:humble-411
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="rosopencv纯cpu版本">ROS+OpenCV纯CPU版本</h3>

<p>https://hub.docker.com/repository/docker/tungchiahui/ros</p>

<p>https://github.com/tungchiahui/ros-docker/blob/main/README-zh_CN.md</p>

<ol>
  <li>从dockerhub上拉取镜像</li>
</ol>

<p>暂时主要维护ROS Humble的版本，其他版本随缘更新，但也基本都是非常够用的状态（随着战队主要使用的版本而变化）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>docker pull tungchiahui/ros:noetic-focal

docker pull tungchiahui/ros:humble-jammy

docker pull tungchiahui/ros:jazzy-noble
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="无rosopencv411cuda128cudnn970">（无ROS）OpenCV4.11+CUDA12.8+CuDNN9.7.0</h3>

<p>https://hub.docker.com/repository/docker/tungchiahui/opencv</p>

<p>https://github.com/tungchiahui/ros-docker/blob/main/README-zh_CN.md</p>

<p>OpenCV4.11+CUDA12.8+CuDNN9.7.0：</p>

<p>（因为50系显卡最低要跑CUDA12.8,所以拉高门槛）</p>

<p><a href="https://pcnveplwrxf8.feishu.cn/sync/HtRPdZxPHsfwnwbXDsjcBfVcnah">https://pcnveplwrxf8.feishu.cn/sync/HtRPdZxPHsfwnwbXDsjcBfVcnah</a></p>

<p>暂时主要维护Ubuntu Jammy的版本，其他版本随缘更新，但也基本都是非常够用的状态（随着战队主要使用的版本而变化）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>docker pull tungchiahui/opencv:411-cuda128-cudnn970-focal

docker pull tungchiahui/opencv:411-cuda128-cudnn971-jammy

docker pull tungchiahui/opencv:411-cuda128-cudnn971-noble
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="rosopencv411cuda128cudnn970">ROS+OpenCV4.11+CUDA12.8+CuDNN9.7.0</h3>

<p>https://hub.docker.com/repository/docker/tungchiahui/ros-opencv/general</p>

<p>https://github.com/tungchiahui/ros-docker/blob/main/README-zh_CN.md</p>

<ol>
  <li>
    <p>拉取镜像：</p>

    <p>  ROS+OpenCV4.11+CUDA12.8+CuDNN9.7.0：</p>

    <p>  （因为50系显卡最低要跑CUDA12.8,所以拉高门槛）</p>

    <p>使用以下带有CUDA和CuDNN的Docker必须满足的条件:</p>

    <ol>
      <li>
        <p>有英伟达NVIDIA独立显卡</p>
      </li>
      <li>
        <p>显卡驱动必须满足≥570.86.10</p>
      </li>
      <li>
        <p>设备的架构必须为amd64(x86_64)架构或者aarch64(arm64)架构。(绝大多数设备均满足)</p>
      </li>
      <li>
        <p>cv_bridge(amd64支持，但arm64暂时没构建，请自行构建)</p>
      </li>
      <li>
        <p>支持的显卡型号如下:</p>

        <ol>
          <li>
            <p>GTX10系列桌面端、移动端显卡均已支持</p>
          </li>
          <li>
            <p>RTX20-RTX50系列桌面端、移动端显卡均已支持</p>
          </li>
          <li>
            <p>NVIDIA Jetson AGX Orin、NVIDIA Jetson Orin NX、NVIDIA Jetson Orin Nano工控机已支持</p>
          </li>
          <li>
            <p>NVIDIA Jetson AGX Xavier、NVIDIA Jetson Xavier NX工控机已支持</p>
          </li>
          <li>
            <p>其他显卡均未适配，强行使用其他显卡肯定会有不兼容的问题，如果想要适配你的显卡型号，请单独联系学长</p>
          </li>
        </ol>
      </li>
    </ol>

    <p>  暂时主要维护ROS Humble的版本，其他版本随缘更新，但也基本都是非常够用的状态随着战队主要使用的版本而变化）</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>docker pull tungchiahui/ros-opencv:noetic-411-cuda128-cudnn970-focal

docker pull tungchiahui/ros-opencv:humble-411-cuda128-cudnn970-jammy

docker pull tungchiahui/ros-opencv:jazzy-411-cuda128-cudnn971-noble
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="手动创建docker镜像">手动创建Docker镜像</h1>

<p><strong>（嫌麻烦的话，直接去看各种docker容器部署的章节）（有别人给你创建好的，就别自己折腾啦）</strong></p>

<h2 id="dockerfile">DockerFile</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">指令</th>
      <th style="text-align: left">说明</th>
      <th style="text-align: left">示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">FROM</td>
      <td style="text-align: left">指定基础镜像，是 Dockerfile 的起点</td>
      <td style="text-align: left">FROM ubuntu:22.04</td>
    </tr>
    <tr>
      <td style="text-align: left">LABEL</td>
      <td style="text-align: left">添加元数据（如作者、版本等）</td>
      <td style="text-align: left">LABEL maintainer=”you@example.com”</td>
    </tr>
    <tr>
      <td style="text-align: left">ENV</td>
      <td style="text-align: left">设置环境变量</td>
      <td style="text-align: left">ENV PORT=8080</td>
    </tr>
    <tr>
      <td style="text-align: left">ARG</td>
      <td style="text-align: left">构建参数，只在构建期间可用</td>
      <td style="text-align: left">ARG VERSION=1.0</td>
    </tr>
    <tr>
      <td style="text-align: left">RUN</td>
      <td style="text-align: left">构建镜像时运行命令</td>
      <td style="text-align: left">RUN apt-get update &amp;&amp; apt-get install -y curl</td>
    </tr>
    <tr>
      <td style="text-align: left">COPY</td>
      <td style="text-align: left">复制文件到镜像中</td>
      <td style="text-align: left">COPY . /app</td>
    </tr>
    <tr>
      <td style="text-align: left">ADD</td>
      <td style="text-align: left">类似 COPY，额外支持解压 .tar 文件或远程 URL（不推荐用于 URL）</td>
      <td style="text-align: left">ADD archive.tar.gz /data/</td>
    </tr>
    <tr>
      <td style="text-align: left">WORKDIR</td>
      <td style="text-align: left">设置工作目录</td>
      <td style="text-align: left">WORKDIR /opt</td>
    </tr>
    <tr>
      <td style="text-align: left">CMD</td>
      <td style="text-align: left">设置容器启动时默认命令（可被 docker run 覆盖）</td>
      <td style="text-align: left">CMD [“node”, “index.js”]</td>
    </tr>
    <tr>
      <td style="text-align: left">ENTRYPOINT</td>
      <td style="text-align: left">设置容器启动时固定命令（通常用于 CLI 工具等）</td>
      <td style="text-align: left">ENTRYPOINT [“python3”]</td>
    </tr>
    <tr>
      <td style="text-align: left">EXPOSE</td>
      <td style="text-align: left">声明镜像内服务监听的端口（不会自动映射）</td>
      <td style="text-align: left">EXPOSE 80</td>
    </tr>
    <tr>
      <td style="text-align: left">VOLUME</td>
      <td style="text-align: left">声明数据卷挂载点</td>
      <td style="text-align: left">VOLUME [“/data”]</td>
    </tr>
    <tr>
      <td style="text-align: left">USER</td>
      <td style="text-align: left">设置后续命令执行的用户</td>
      <td style="text-align: left">USER appuser</td>
    </tr>
    <tr>
      <td style="text-align: left">ONBUILD</td>
      <td style="text-align: left">当镜像作为其他镜像基础镜像时触发的构建指令</td>
      <td style="text-align: left">ONBUILD COPY . /src</td>
    </tr>
    <tr>
      <td style="text-align: left">SHELL</td>
      <td style="text-align: left">更改默认 shell，比如将 sh -c 改为 bash -c</td>
      <td style="text-align: left">SHELL [“/bin/bash”, “-c”]</td>
    </tr>
    <tr>
      <td style="text-align: left">HEALTHCHECK</td>
      <td style="text-align: left">定义容器运行时的健康检查命令</td>
      <td style="text-align: left">`HEALTHCHECK CMD curl –fail http://localhost:8080</td>
    </tr>
    <tr>
      <td style="text-align: left">STOPSIGNAL</td>
      <td style="text-align: left">容器停止时发送的信号</td>
      <td style="text-align: left">STOPSIGNAL SIGKILL</td>
    </tr>
  </tbody>
</table>

<h2 id="自己创建容器">自己创建容器</h2>

<h3 id="手动创建">手动创建</h3>

<p>https://github.com/tungchiahui/ros-docker</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>
<span class="c"># DockerFile内容请看Github仓库中的DockerFile</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在x86电脑上编译x86的：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>docker build <span class="nt">-t</span> ros-melodic-cuda118-cudnn8-bionic:latest <span class="nb">.</span>

docker build <span class="nt">-t</span> ros-noetic-focal:latest <span class="nb">.</span>

docker build <span class="nt">-t</span> ros-humble-jammy:latest <span class="nb">.</span>

docker build <span class="nt">-t</span> ros-jazzy-noble:latest <span class="nb">.</span>

docker build <span class="nt">-t</span> ros-humble-opencv411-cuda128-cudnn970-jammy:latest <span class="nb">.</span>

docker build <span class="nt">-t</span> ros-jazzy-opencv411-cuda128-cudnn970-noble:latest <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image14.webp" alt="" /></p>

<p>镜像大小5GB(压缩后的大小详见DockerHub)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image15.webp" alt="" /></p>

<p>将 Docker 镜像推送到 Docker Hub 的步骤如下：</p>

<ol>
  <li>创建 Docker Hub 账户</li>
</ol>

<p>如果你还没有 Docker Hub 账户，请前往 Docker Hub 注册一个免费账户。</p>

<ol>
  <li>登录 Docker Hub</li>
</ol>

<p>在终端中使用以下命令登录到你的 Docker Hub 账户：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker login
</pre></td></tr></tbody></table></code></pre></div></div>

<p>输入你的 Docker Hub 用户名和密码进行验证。</p>

<ol>
  <li>为你的镜像打标签</li>
</ol>

<p>Docker Hub 使用 <code class="language-plaintext highlighter-rouge">&lt;用户名&gt;/&lt;镜像名&gt;:&lt;标签&gt;</code> 的格式来标识镜像。你需要为你的镜像打上标签，以便能够推送到 Docker Hub。使用以下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker tag ros-jazzy-noble:latest &lt;你的用户名&gt;/ros-jazzy-noble:latest
</pre></td></tr></tbody></table></code></pre></div></div>

<p>例如，如果你的 Docker Hub 用户名是 <code class="language-plaintext highlighter-rouge">tungchiahui</code>，你应该执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>docker tag ros-noetic-focal:latest tungchiahui/ros-noetic-focal:latest

docker tag ros-humble-jammy:latest tungchiahui/ros-humble-jammy:latest

docker tag ros-jazzy-noble:latest tungchiahui/ros-jazzy-noble:latest

docker tag ros-humble-opencv411-cuda128-cudnn970-jammy:latest tungchiahui/ros-humble-opencv411-cuda128-cudnn970-jammy:latest

docker tag ros-jazzy-opencv411-cuda128-cudnn970-noble:latest tungchiahui/ros-jazzy-opencv411-cuda128-cudnn970-noble:latest
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>推送镜像到 Docker Hub</li>
</ol>

<p>使用以下命令将镜像推送到 Docker Hub：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker push &lt;你的用户名&gt;/ros-noetic-jazzy-noble:latest
</pre></td></tr></tbody></table></code></pre></div></div>

<p>例如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>docker push tungchiahui/ros-noetic-focal:latest

docker push tungchiahui/ros-humble-jammy:latest

docker push tungchiahui/ros-jazzy-noble:latest

docker push tungchiahui/ros-humble-opencv411-cuda128-cudnn970-jammy:latest

docker push tungchiahui/ros-jazzy-opencv411-cuda128-cudnn970-noble:latest

docker push tungchiahui/ros-noetic-focal-arm64:latest
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>验证推送成功</li>
</ol>

<p>你可以通过访问 Docker Hub 的个人页面来验证你的镜像是否已成功推送。</p>

<p><strong>注意事项</strong></p>

<ul>
  <li>
    <p>确保你的镜像大小在 Docker Hub 的限制范围内（一般为 10GB）。</p>
  </li>
  <li>
    <p>如果你打算将镜像公开，可以设置为公共仓库；如果希望只有你自己可以访问，可以设置为私有仓库。</p>
  </li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image16.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image17.webp" alt="" /></p>

<h3 id="手动创建跨平台多架构构建">手动创建(跨平台多架构构建)</h3>

<p>如果您想在 <strong>x86/x64 电脑上即为本机x86设备构建镜像，又想为树莓派、Jetson等ARM64 设备构建 Docker 镜像</strong> ，需要使用 <strong>Docker 的跨平台构建功能</strong> 。以下是完整解决方案：</p>

<hr />

<p>1. <strong>启用 Docker 跨平台构建</strong></p>

<p>在 x86 主机上模拟 ARM64 环境需要以下工具：</p>

<p>第一步：启用 buildx（只需执行一次）</p>

<pre><code class="language-Shell">docker buildx create --name multiarch_builder --use
</code></pre>

<p>这会创建并启用一个支持多架构构建的 builder，电脑重启后也依然存在，所以只用运行一次。</p>

<p>第二步：安装 QEMU 支持（一般新版 Docker Desktop 已自带，但是Linux必须要安装） 如果你用的是服务器或Linux发行版，确保有 qemu 模拟器：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker run <span class="nt">--rm</span> <span class="nt">--privileged</span> multiarch/qemu-user-static <span class="nt">--reset</span> <span class="nt">-p</span> <span class="nb">yes</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>电脑重启后，就会消失，所以需要你每次电脑重启后，在buildx命令前，运行一次该命令即可。</p>

<p>第三步：构建多架构镜像 用下面的命令构建 amd64 和 arm64：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre>docker buildx build <span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="nt">-t</span> &lt;你的镜像名&gt;:&lt;标签&gt; <span class="nt">--push</span> <span class="nb">.</span>

<span class="c"># 例子：</span>
docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/ros:noetic-focal <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/ros:humble-jammy <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/ros:jazzy-noble <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

 docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/opencv:411-cuda128-cudnn970-focal <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/opencv:411-cuda128-cudnn971-jammy <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

 docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/opencv:411-cuda128-cudnn971-noble <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/ros-opencv:noetic-411-cuda128-cudnn970-focal <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/ros-opencv:humble-411-cuda128-cudnn970-jammy <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

 docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> tungchiahui/ros-opencv:jazzy-411-cuda128-cudnn970-noble <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>

  docker buildx build <span class="se">\</span>
<span class="nt">--platform</span> linux/amd64,linux/arm64 <span class="se">\</span>
 <span class="nt">-t</span> sdutvincirobot/ros-opencv:humble-411-cuda128-cudnn970-jammy <span class="se">\</span>
 <span class="nt">--push</span> <span class="se">\</span>
 <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>说明： –platform 指定多架构。 –push 是必须的，因为 buildx 的多平台构建默认是不能本地加载的（除非加 –load，但那只能支持单一架构）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image18.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image19.webp" alt="" /></p>

<h3 id="清除构建缓存">清除构建缓存</h3>

<pre><code class="language-C++">
# 清理BuildKit构建缓存
docker builder prune -f  
</code></pre>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image20.webp" alt="" /></p>

<h1 id="vscode远程开发">VScode远程开发</h1>

<ol>
  <li>插件1：微软Docker工具</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image21.webp" alt="" /></p>

<p><em>docker扩展插件已经进化为container tools了，请安装container tools。</em></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image22.webp" alt="" /></p>

<ol>
  <li>插件2：微软Docker远程开发工具</li>
</ol>

<p>下面这是远程开发的插件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image23.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image24.webp" alt="" /></p>

<p>上述教程已经挂载了本地磁盘了，所以在Docker容器中可以轻松访问本地的工程。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/10/03/image25.webp" alt="" /></p>]]></content><author><name>Tung Chia-hui</name></author><category term="环境搭建" /><category term="Linux" /></entry><entry><title type="html">ROS1机器人操作系统教程</title><link href="https://jekyll.tungchiahui.cn/blog/ros1-tutorial/" rel="alternate" type="text/html" title="ROS1机器人操作系统教程" /><published>2024-07-13T00:00:00+00:00</published><updated>2024-07-13T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/ROS1%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/ros1-tutorial/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#ros介绍" id="markdown-toc-ros介绍">ROS介绍</a>    <ul>
      <li><a href="#ros介绍-1" id="markdown-toc-ros介绍-1">ROS介绍</a></li>
      <li><a href="#ros与ros2的关系" id="markdown-toc-ros与ros2的关系">ROS与ROS2的关系</a></li>
      <li><a href="#ros的教学资料" id="markdown-toc-ros的教学资料">ROS的教学资料</a></li>
      <li><a href="#安装ros1-noetic" id="markdown-toc-安装ros1-noetic">安装ROS1 Noetic</a>        <ul>
          <li><a href="#官方途径" id="markdown-toc-官方途径">官方途径</a>            <ul>
              <li><a href="#二进制包安装仅支持ubuntu2004-focal和debian10-buster更推荐该方式" id="markdown-toc-二进制包安装仅支持ubuntu2004-focal和debian10-buster更推荐该方式">二进制包安装(仅支持Ubuntu20.04 Focal和Debian10 Buster，<strong>更推荐该方式</strong>)</a></li>
              <li><a href="#根据官方源码手动编译不推荐该方式" id="markdown-toc-根据官方源码手动编译不推荐该方式">根据官方源码，手动编译(不推荐该方式)</a></li>
            </ul>
          </li>
          <li><a href="#第三方途径" id="markdown-toc-第三方途径">第三方途径</a>            <ul>
              <li><a href="#二进制包安装较为推荐" id="markdown-toc-二进制包安装较为推荐">二进制包安装(<strong>较为推荐</strong>）</a></li>
              <li><a href="#docker容器不推荐可供有需要的使用" id="markdown-toc-docker容器不推荐可供有需要的使用">Docker容器(不推荐，可供有需要的使用)</a></li>
              <li><a href="#根据源码手动编译不推荐" id="markdown-toc-根据源码手动编译不推荐">根据源码，手动编译（不推荐）</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#测试ros1" id="markdown-toc-测试ros1">测试ROS1</a></li>
    </ul>
  </li>
</ul>

<p>如果你想看ROS2教程，请看<a href="/blog/ros2-tutorial/">ROS2机器人操作系统教程</a></p>

<h1 id="ros介绍">ROS介绍</h1>

<h2 id="ros介绍-1">ROS介绍</h2>

<h2 id="ros与ros2的关系">ROS与ROS2的关系</h2>

<p><strong>ROS1最后一个</strong><strong>LTS</strong><strong>版本</strong><strong>ROS</strong> <strong>Noetic官方仅在Ubuntu20.04 Focal和Debian10 Buster提供二进制安装文件.且在2025年彻底停更。(有第三方的方式可以将ROS Neotic部署在Ubuntu 22.04 Jammy、Ubuntu 24.04 Noble以及Debian12 Bookworm等发行版上)</strong></p>

<p><strong>ROS2改进了ROS1初期设计的一些遗留毛病，以后会成为主流，但ROS2纯纯战未来，目前可以学，但是几乎没法应用，没啥教程。</strong></p>

<p><strong>ROS2目前主流的</strong><strong>LTS</strong><strong>版本如下:</strong><strong>ROS</strong> <strong>Humble官方仅在Ubuntu22.04 Jammy提供二进制安装文件，ROS Jazzy官方仅在Ubuntu24.04 Noble提供二进制安装文件。</strong></p>

<h2 id="ros的教学资料">ROS的教学资料</h2>

<ol>
  <li>教学视频</li>
</ol>

<p>https://www.bilibili.com/video/BV1Ci4y1L7ZZ/</p>

<p>https://www.bilibili.com/video/BV1Ub4y1a7PH</p>

<ol>
  <li>教学文档</li>
</ol>

<p>http://www.autolabor.com.cn/book/ROSTutorials/</p>

<h2 id="安装ros1-noetic">安装ROS1 Noetic</h2>

<p>安装ROS2详见:<a href="/blog/ros2-tutorial/">ROS2机器人操作系统教程</a></p>

<p>ROS1已经EOF了，来ROS2吧。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/07/13/image1.webp" alt="" /></p>

<h3 id="官方途径">官方途径</h3>

<ol>
  <li>Wiki安装首页：</li>
</ol>

<p>https://wiki.ros.org/cn/noetic/Installation</p>

<h4 id="二进制包安装仅支持ubuntu2004-focal和debian10-buster更推荐该方式">二进制包安装(仅支持Ubuntu20.04 Focal和Debian10 Buster，<strong>更推荐该方式</strong>)</h4>

<ol>
  <li>Ubuntu 20.04 Focal</li>
</ol>

<p>https://wiki.ros.org/noetic/Installation/Ubuntu</p>

<ol>
  <li>Debian10 Buster</li>
</ol>

<p>https://wiki.ros.org/noetic/Installation/Debian</p>

<h4 id="根据官方源码手动编译不推荐该方式">根据官方源码，手动编译(不推荐该方式)</h4>

<ol>
  <li>支持的发行版：</li>
</ol>

<p>https://www.ros.org/reps/rep-2000.html</p>

<ol>
  <li>
    <p>教程</p>

    <ol>
      <li>Ubuntu 20.04 Focal和Debian10 Buster（多此一举：有二进制包安装，就不要从源码编译了）</li>
    </ol>

    <p>https://wiki.ros.org/noetic/Installation/Source</p>

    <ol>
      <li>Arch Linux</li>
    </ol>

    <p>https://wiki.ros.org/noetic/Installation/ArchLinux</p>
  </li>
</ol>

<h3 id="第三方途径">第三方途径</h3>

<h4 id="二进制包安装较为推荐">二进制包安装(<strong>较为推荐</strong>）</h4>

<ol>
  <li>支持Ubuntu 22.04 Jammy的方式：</li>
</ol>

<p>https://rcbbs.top/t/topic/559</p>

<p>https://github.com/ganyuanzhen/ROS-on-Jammy</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>sudo add-apt-repository ppa:ros-for-jammy/noetic
sudo apt update
sudo apt install ros-noetic-desktop-full
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>支持Ubuntu 24.04 Noble的方式：</li>
</ol>

<p>https://rcbbs.top/t/topic/559</p>

<p>https://github.com/ganyuanzhen/ROS-on-Jammy</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>add-apt-repository ppa:ros-for-jammy/noble
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-noetic-desktop-full
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>支持Debian 12 Bookworm的方式：</li>
</ol>

<p>https://gist.github.com/vrbadev/ec168a0940d45f523bf050011d7dff75</p>

<p><strong>从密钥服务器重新获取密钥</strong> ： 你可以直接从密钥服务器上获取并保存这个密钥文件到正确的位置。首先，使用以下命令从密钥服务器获取密钥，并将其保存为 <code class="language-plaintext highlighter-rouge">.asc</code> 文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>wget <span class="nt">-O</span> /etc/apt/trusted.gpg.d/ros.asc https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这个Mavros相关的不用管，用不着飞控</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/07/13/image2.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/07/13/image3.webp" alt="" /></p>

<h4 id="docker容器不推荐可供有需要的使用">Docker容器(不推荐，可供有需要的使用)</h4>

<p><a href="/blog/docker-tutorial/">Docker教程</a></p>

<p>https://gitee.com/qinyinan/amber-ce-bookworm</p>

<h4 id="根据源码手动编译不推荐">根据源码，手动编译（不推荐）</h4>

<ol>
  <li>Ubuntu</li>
</ol>

<p>https://zhuanlan.zhihu.com/p/688413327?utm_psn=1805362924497268736</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/07/13/image4.webp" alt="" /></p>

<ol>
  <li>Fedora</li>
</ol>

<p>https://zhuanlan.zhihu.com/p/687755518?utm_psn=1823704798471520256</p>

<h2 id="测试ros1">测试ROS1</h2>

<ol>
  <li>配置环境（只需配置一次即可）</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 打开文件并编辑</span>
<span class="nb">sudo </span>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>在末尾加上下方命令（只需配置一次即可）</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">source</span> /opt/ros/noetic/setup.bash
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>在当前终端加载修改的文件（只需配置一次即可）</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 加载文件</span>
<span class="nb">source</span> ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>测试</li>
</ol>

<p>打开一个终端，并敲下列命令打开Master</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>roscore
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再打开一个终端，打开乌龟图形界面节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rosrun turtlesim turtlesim_node
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再打开一个终端，打开控制节点，鼠标选中放在该终端中，按键盘即可让🐢龟男🐢移动。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rosrun turtlesim turtle_teleop_key
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/07/13/image5.webp" alt="" /></p>]]></content><author><name>Tung Chia-hui</name></author><category term="ROS" /></entry><entry><title type="html">Linux教程</title><link href="https://jekyll.tungchiahui.cn/blog/linux-tutorial/" rel="alternate" type="text/html" title="Linux教程" /><published>2024-03-30T00:00:00+00:00</published><updated>2024-03-30T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/Linux%E6%95%99%E7%A8%8B</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/linux-tutorial/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#发行版推荐" id="markdown-toc-发行版推荐">发行版推荐</a></li>
  <li><a href="#linux装机教程" id="markdown-toc-linux装机教程">Linux装机教程</a>    <ul>
      <li><a href="#实体机双系统最推荐" id="markdown-toc-实体机双系统最推荐">实体机（双系统，最推荐）</a>        <ul>
          <li><a href="#环境准备" id="markdown-toc-环境准备">环境准备</a></li>
          <li><a href="#关闭安全启动secure-boot" id="markdown-toc-关闭安全启动secure-boot">关闭安全启动Secure Boot</a>            <ul>
              <li><a href="#联想拯救者" id="markdown-toc-联想拯救者">联想拯救者</a></li>
              <li><a href="#戴尔游匣intel版" id="markdown-toc-戴尔游匣intel版">戴尔游匣Intel版</a></li>
              <li><a href="#惠普暗影精灵" id="markdown-toc-惠普暗影精灵">惠普暗影精灵</a></li>
              <li><a href="#华硕天选" id="markdown-toc-华硕天选">华硕天选</a></li>
            </ul>
          </li>
          <li><a href="#开启核显" id="markdown-toc-开启核显">开启核显</a>            <ul>
              <li><a href="#联想拯救者-1" id="markdown-toc-联想拯救者-1">联想拯救者</a></li>
              <li><a href="#戴尔游匣intel版-1" id="markdown-toc-戴尔游匣intel版-1">戴尔游匣Intel版</a></li>
              <li><a href="#戴尔游匣amd版" id="markdown-toc-戴尔游匣amd版">戴尔游匣AMD版</a></li>
              <li><a href="#惠普暗影精灵-1" id="markdown-toc-惠普暗影精灵-1">惠普暗影精灵</a></li>
              <li><a href="#华硕天选-1" id="markdown-toc-华硕天选-1">华硕天选</a></li>
            </ul>
          </li>
          <li><a href="#安装adk" id="markdown-toc-安装adk">安装ADK</a></li>
          <li><a href="#下载diskgenius" id="markdown-toc-下载diskgenius">下载DiskGenius</a></li>
          <li><a href="#下载傲梅分区助手" id="markdown-toc-下载傲梅分区助手">下载傲梅分区助手</a></li>
          <li><a href="#下载ventoy" id="markdown-toc-下载ventoy">下载Ventoy</a></li>
          <li><a href="#下载镜像" id="markdown-toc-下载镜像">下载镜像</a>            <ul>
              <li><a href="#x86_64amd64" id="markdown-toc-x86_64amd64">X86_64(amd64)</a></li>
            </ul>
          </li>
          <li><a href="#硬盘分区安装方案" id="markdown-toc-硬盘分区安装方案">硬盘分区安装方案</a></li>
          <li><a href="#创建安装介质" id="markdown-toc-创建安装介质">创建安装介质</a>            <ul>
              <li><a href="#方法一u盘法" id="markdown-toc-方法一u盘法">方法一：U盘法</a>                <ul>
                  <li><a href="#创建ventoy-u盘" id="markdown-toc-创建ventoy-u盘">创建Ventoy U盘</a></li>
                  <li><a href="#安装微pe并下载winpe的镜像" id="markdown-toc-安装微pe并下载winpe的镜像">安装微PE并下载WinPE的镜像</a></li>
                  <li><a href="#复制linux镜像iso" id="markdown-toc-复制linux镜像iso">复制Linux镜像iso</a></li>
                  <li><a href="#设置启动项ventoy" id="markdown-toc-设置启动项ventoy">设置启动项Ventoy</a></li>
                  <li><a href="#在ventoy里启动linux安装介质镜像" id="markdown-toc-在ventoy里启动linux安装介质镜像">在Ventoy里启动Linux安装介质镜像</a></li>
                </ul>
              </li>
              <li><a href="#方法二本地法" id="markdown-toc-方法二本地法">方法二：本地法</a>                <ul>
                  <li><a href="#本地法创建" id="markdown-toc-本地法创建">本地法创建</a></li>
                  <li><a href="#删除本地安装介质安装完后再删" id="markdown-toc-删除本地安装介质安装完后再删">删除本地安装介质(安装完后再删）</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li><a href="#linux安装空间的预留" id="markdown-toc-linux安装空间的预留">Linux安装空间的预留</a>            <ul>
              <li><a href="#硬盘分区安装方案的场景" id="markdown-toc-硬盘分区安装方案的场景">硬盘分区安装方案的场景①</a></li>
              <li><a href="#硬盘分区安装方案的场景-1" id="markdown-toc-硬盘分区安装方案的场景-1">硬盘分区安装方案的场景②</a></li>
              <li><a href="#硬盘分区安装方案的场景3️⃣" id="markdown-toc-硬盘分区安装方案的场景3️⃣">硬盘分区安装方案的场景3️⃣</a></li>
            </ul>
          </li>
          <li><a href="#安装linux" id="markdown-toc-安装linux">安装Linux</a>            <ul>
              <li><a href="#grub设置" id="markdown-toc-grub设置">grub设置</a></li>
              <li><a href="#基础安装选项" id="markdown-toc-基础安装选项">基础安装选项</a></li>
              <li><a href="#分区设置重要" id="markdown-toc-分区设置重要">分区设置（重要！！！）</a>                <ul>
                  <li><a href="#与windows使用同一个efi分区" id="markdown-toc-与windows使用同一个efi分区">与Windows使用同一个EFI分区</a>                    <ul>
                      <li><a href="#初步设置" id="markdown-toc-初步设置">初步设置</a></li>
                      <li><a href="#swap分区建立" id="markdown-toc-swap分区建立">swap分区建立</a></li>
                      <li><a href="#根目录分区建立" id="markdown-toc-根目录分区建立">根目录/分区建立</a></li>
                      <li><a href="#取消挂载其他无关分区" id="markdown-toc-取消挂载其他无关分区">取消挂载其他无关分区</a></li>
                      <li><a href="#设置uefi引导位置" id="markdown-toc-设置uefi引导位置">设置UEFI引导位置</a></li>
                    </ul>
                  </li>
                  <li><a href="#独立的efi分区不推荐" id="markdown-toc-独立的efi分区不推荐">独立的EFI分区（不推荐）</a>                    <ul>
                      <li><a href="#初步设置-1" id="markdown-toc-初步设置-1">初步设置</a></li>
                      <li><a href="#efi分区建立比前面的那种方法多一个efi分区" id="markdown-toc-efi分区建立比前面的那种方法多一个efi分区">EFI分区建立（比前面的那种方法多一个EFI分区）</a></li>
                      <li><a href="#swap分区建立-1" id="markdown-toc-swap分区建立-1">swap分区建立</a></li>
                      <li><a href="#根目录分区建立-1" id="markdown-toc-根目录分区建立-1">根目录/分区建立</a></li>
                      <li><a href="#取消挂载其他无关分区-1" id="markdown-toc-取消挂载其他无关分区-1">取消挂载其他无关分区</a></li>
                      <li><a href="#设置uefi引导位置-1" id="markdown-toc-设置uefi引导位置-1">设置UEFI引导位置</a></li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li><a href="#最后设置" id="markdown-toc-最后设置">最后设置</a></li>
            </ul>
          </li>
          <li><a href="#双系统切换" id="markdown-toc-双系统切换">双系统切换</a></li>
          <li><a href="#彻底删除linux" id="markdown-toc-彻底删除linux">彻底删除Linux</a>            <ul>
              <li><a href="#分区格式化" id="markdown-toc-分区格式化">分区格式化</a></li>
              <li><a href="#引导删除" id="markdown-toc-引导删除">引导删除</a>                <ul>
                  <li><a href="#和windows共用efi" id="markdown-toc-和windows共用efi">和Windows共用EFI</a></li>
                  <li><a href="#独立的efi" id="markdown-toc-独立的efi">独立的EFI</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#普通虚拟机不推荐" id="markdown-toc-普通虚拟机不推荐">普通虚拟机（不推荐）</a></li>
      <li><a href="#windows-subsystem-for-linux-2windows的linux子系统2勉强的法子" id="markdown-toc-windows-subsystem-for-linux-2windows的linux子系统2勉强的法子">Windows Subsystem For Linux 2(Windows的Linux子系统2)（勉强的法子）</a>        <ul>
          <li><a href="#简介与优缺点" id="markdown-toc-简介与优缺点">简介与优缺点</a></li>
          <li><a href="#安装教程" id="markdown-toc-安装教程">安装教程</a>            <ul>
              <li><a href="#启动wsl2子系统和虚拟平台" id="markdown-toc-启动wsl2子系统和虚拟平台">启动WSL2子系统和虚拟平台</a></li>
              <li><a href="#将wsl2设置为默认版本" id="markdown-toc-将wsl2设置为默认版本">将WSL2设置为默认版本</a></li>
              <li><a href="#安装linux发行版" id="markdown-toc-安装linux发行版">安装Linux发行版</a></li>
              <li><a href="#查看系统状态" id="markdown-toc-查看系统状态">查看系统状态</a></li>
              <li><a href="#设置用户名与密码" id="markdown-toc-设置用户名与密码">设置用户名与密码</a></li>
              <li><a href="#卸载发行版" id="markdown-toc-卸载发行版">卸载发行版</a></li>
            </ul>
          </li>
          <li><a href="#配置各种环境" id="markdown-toc-配置各种环境">配置各种环境</a>            <ul>
              <li><a href="#换源" id="markdown-toc-换源">换源</a></li>
              <li><a href="#英伟达显卡" id="markdown-toc-英伟达显卡">英伟达显卡</a>                <ul>
                  <li><a href="#显卡驱动" id="markdown-toc-显卡驱动">显卡驱动</a></li>
                  <li><a href="#cuda" id="markdown-toc-cuda">CUDA</a></li>
                  <li><a href="#cudnn" id="markdown-toc-cudnn">cuDNN</a></li>
                </ul>
              </li>
              <li><a href="#配置网络" id="markdown-toc-配置网络">配置网络</a></li>
              <li><a href="#usb直通" id="markdown-toc-usb直通">USB直通</a></li>
              <li><a href="#vscode远程开发" id="markdown-toc-vscode远程开发">VScode远程开发</a></li>
              <li><a href="#linux终端使用windows软件" id="markdown-toc-linux终端使用windows软件">Linux终端使用Windows软件</a></li>
              <li><a href="#opengl有问题" id="markdown-toc-opengl有问题">OpenGL有问题</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#安装必备配置" id="markdown-toc-安装必备配置">安装必备配置</a>    <ul>
      <li><a href="#软件包换源以debian系的发行版为例" id="markdown-toc-软件包换源以debian系的发行版为例">  软件包换源（以Debian系的发行版为例）</a>        <ul>
          <li><a href="#ubuntu2204及debian10及以下版本" id="markdown-toc-ubuntu2204及debian10及以下版本">  Ubuntu22.04(及Debian10)及以下版本</a></li>
          <li><a href="#ubuntu2404及debian12及以上版本" id="markdown-toc-ubuntu2404及debian12及以上版本">  Ubuntu24.04(及Debian12)及以上版本</a></li>
          <li><a href="#fedora41dnf5及之后" id="markdown-toc-fedora41dnf5及之后">Fedora41(DNF5)及之后</a></li>
        </ul>
      </li>
      <li><a href="#卸载恶心的snapubuntu的衍生版" id="markdown-toc-卸载恶心的snapubuntu的衍生版">卸载恶心的snap(Ubuntu的衍生版)</a>        <ul>
          <li><a href="#安装非firefox浏览器" id="markdown-toc-安装非firefox浏览器">安装非firefox浏览器</a></li>
          <li><a href="#查看snap包应用数量" id="markdown-toc-查看snap包应用数量">查看snap包应用数量</a></li>
          <li><a href="#移除snap应用" id="markdown-toc-移除snap应用">移除snap应用</a></li>
          <li><a href="#移除snap" id="markdown-toc-移除snap">移除snap</a></li>
          <li><a href="#禁止系统自动安装snap" id="markdown-toc-禁止系统自动安装snap">禁止系统自动安装snap</a></li>
          <li><a href="#测试是否成功" id="markdown-toc-测试是否成功">测试是否成功</a></li>
          <li><a href="#重新安装firefox浏览器没大有必要" id="markdown-toc-重新安装firefox浏览器没大有必要">重新安装FireFox浏览器（没大有必要）</a></li>
          <li><a href="#跨ubuntu大版本更新" id="markdown-toc-跨ubuntu大版本更新">跨Ubuntu大版本更新</a></li>
        </ul>
      </li>
      <li><a href="#切换系统语言到中文" id="markdown-toc-切换系统语言到中文">切换系统语言到中文</a></li>
      <li><a href="#中文输入法" id="markdown-toc-中文输入法">中文输入法</a>        <ul>
          <li><a href="#搜狗不建议ubuntu2204-及-以下" id="markdown-toc-搜狗不建议ubuntu2204-及-以下">搜狗(不建议）(Ubuntu22.04 <strong>及</strong> 以下)</a></li>
          <li><a href="#fcitx5ubuntu2204-及-以上debian12及以上fedora" id="markdown-toc-fcitx5ubuntu2204-及-以上debian12及以上fedora">Fcitx5(Ubuntu22.04 <strong>及</strong> 以上、Debian12及以上、Fedora)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#ubuntu" id="markdown-toc-ubuntu">Ubuntu</a></li>
  <li><a href="#直接在线执行工具箱优化" id="markdown-toc-直接在线执行工具箱优化">直接在线执行工具箱优化</a></li>
  <li><a href="#fedora" id="markdown-toc-fedora">Fedora</a></li>
  <li><a href="#直接在线执行工具箱优化-1" id="markdown-toc-直接在线执行工具箱优化-1">直接在线执行工具箱优化</a>    <ul>
      <li><a href="#pip3源替换" id="markdown-toc-pip3源替换">pip3源替换</a></li>
      <li><a href="#rpmfusion安装并换源" id="markdown-toc-rpmfusion安装并换源">RPMFusion安装并换源</a></li>
      <li><a href="#时间不同步" id="markdown-toc-时间不同步">时间不同步</a></li>
      <li><a href="#显卡驱动安装" id="markdown-toc-显卡驱动安装">显卡驱动安装</a>        <ul>
          <li><a href="#卸载显卡驱动卸载干净" id="markdown-toc-卸载显卡驱动卸载干净">卸载显卡驱动(卸载干净)</a></li>
          <li><a href="#常见问题遇到问题再翻上来看这里" id="markdown-toc-常见问题遇到问题再翻上来看这里">常见问题（遇到问题再翻上来看这里）</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#重启" id="markdown-toc-重启">重启</a>    <ul>
      <li><a href="#安装方式推荐" id="markdown-toc-安装方式推荐">安装方式推荐</a></li>
      <li><a href="#apt安装方式一适合debianubuntu等" id="markdown-toc-apt安装方式一适合debianubuntu等">APT安装（方式一：适合Debian,Ubuntu等）</a>        <ul>
          <li><a href="#安装显卡驱动" id="markdown-toc-安装显卡驱动">安装显卡驱动</a>            <ul>
              <li><a href="#ubuntu-1" id="markdown-toc-ubuntu-1">Ubuntu</a></li>
              <li><a href="#debian" id="markdown-toc-debian">Debian</a></li>
            </ul>
          </li>
          <li><a href="#安装cuda" id="markdown-toc-安装cuda">安装CUDA</a></li>
          <li><a href="#安装cudnn" id="markdown-toc-安装cudnn">安装cuDNN</a></li>
        </ul>
      </li>
      <li><a href="#dnf安装方式二适合fedorarocky等" id="markdown-toc-dnf安装方式二适合fedorarocky等">DNF安装（方式二：适合Fedora,Rocky等）</a>        <ul>
          <li><a href="#安装显卡驱动-1" id="markdown-toc-安装显卡驱动-1">安装显卡驱动</a>            <ul>
              <li><a href="#fedora-1" id="markdown-toc-fedora-1">Fedora</a></li>
            </ul>
          </li>
          <li><a href="#安装cuda-1" id="markdown-toc-安装cuda-1">安装CUDA</a></li>
          <li><a href="#安装cudnn-1" id="markdown-toc-安装cudnn-1">安装cuDNN</a></li>
        </ul>
      </li>
      <li><a href="#通用方式方式三脚本或压缩包方式" id="markdown-toc-通用方式方式三脚本或压缩包方式">通用方式（方式三：脚本或压缩包方式）</a>        <ul>
          <li><a href="#安装显卡驱动-2" id="markdown-toc-安装显卡驱动-2">安装显卡驱动</a></li>
          <li><a href="#安装cuda-2" id="markdown-toc-安装cuda-2">安装CUDA</a></li>
          <li><a href="#安装cudnn基本废弃请往下看apt和dnf安装cudnn的方式" id="markdown-toc-安装cudnn基本废弃请往下看apt和dnf安装cudnn的方式">安装cuDNN<strong>（基本废弃，请往下看apt和dnf安装CuDNN的方式）</strong></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#命令教程长期积累" id="markdown-toc-命令教程长期积累">命令教程(长期积累)</a>    <ul>
      <li><a href="#大多数命令" id="markdown-toc-大多数命令">大多数命令</a></li>
      <li><a href="#包管理工具命令" id="markdown-toc-包管理工具命令">包管理工具命令</a></li>
      <li><a href="#kde-dolphin-以root打开" id="markdown-toc-kde-dolphin-以root打开">KDE Dolphin 以root打开</a></li>
    </ul>
  </li>
  <li><a href="#各种环境配置" id="markdown-toc-各种环境配置">各种环境配置</a></li>
  <li><a href="#其他可选配置" id="markdown-toc-其他可选配置">其他可选配置</a>    <ul>
      <li><a href="#kde的wayland和x11互相切换" id="markdown-toc-kde的wayland和x11互相切换">KDE的Wayland和X11互相切换</a></li>
      <li><a href="#修改dns" id="markdown-toc-修改dns">修改DNS</a></li>
      <li><a href="#截图快捷键" id="markdown-toc-截图快捷键">截图快捷键</a></li>
      <li><a href="#搜索工具" id="markdown-toc-搜索工具">搜索工具</a></li>
      <li><a href="#关闭selinux" id="markdown-toc-关闭selinux">关闭SELinux</a></li>
      <li><a href="#uefi启动界面refind" id="markdown-toc-uefi启动界面refind">UEFI启动界面rEFInd</a>        <ul>
          <li><a href="#安装refind" id="markdown-toc-安装refind">安装rEFInd</a></li>
          <li><a href="#确认refind是否安装成功" id="markdown-toc-确认refind是否安装成功">确认refind是否安装成功</a></li>
          <li><a href="#配置-refindconf" id="markdown-toc-配置-refindconf">配置 refind.conf</a></li>
          <li><a href="#美化" id="markdown-toc-美化">美化</a></li>
        </ul>
      </li>
      <li><a href="#kde主题" id="markdown-toc-kde主题">KDE主题</a></li>
      <li><a href="#自启应用与脚本" id="markdown-toc-自启应用与脚本">自启应用与脚本</a></li>
      <li><a href="#从bash切换到zsh" id="markdown-toc-从bash切换到zsh">从Bash切换到Zsh</a>        <ul>
          <li><a href="#什么是shell" id="markdown-toc-什么是shell">什么是shell？</a></li>
          <li><a href="#zsh有什么优势" id="markdown-toc-zsh有什么优势">zsh有什么优势？</a></li>
          <li><a href="#zsh安装与配置" id="markdown-toc-zsh安装与配置">zsh安装与配置</a></li>
          <li><a href="#oh-my-zsh" id="markdown-toc-oh-my-zsh">oh my zsh!</a></li>
          <li><a href="#配置oh-my-zsh" id="markdown-toc-配置oh-my-zsh">配置oh my zsh</a></li>
          <li><a href="#定制独一无二的zsh" id="markdown-toc-定制独一无二的zsh">定制独一无二的zsh</a></li>
          <li><a href="#切换默认shell" id="markdown-toc-切换默认shell">切换默认shell</a></li>
          <li><a href="#添加插件教程" id="markdown-toc-添加插件教程">添加插件教程</a>            <ul>
              <li><a href="#powerlevel10k" id="markdown-toc-powerlevel10k">powerlevel10k</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#flatpak软件管理工具" id="markdown-toc-flatpak软件管理工具">Flatpak软件管理工具</a>        <ul>
          <li><a href="#flatpak安装" id="markdown-toc-flatpak安装">flatpak安装</a></li>
          <li><a href="#字体问题解决" id="markdown-toc-字体问题解决">字体问题解决</a></li>
          <li><a href="#安装软件" id="markdown-toc-安装软件">安装软件</a></li>
          <li><a href="#运行软件" id="markdown-toc-运行软件">运行软件</a></li>
        </ul>
      </li>
      <li><a href="#appimage" id="markdown-toc-appimage">Appimage</a></li>
      <li><a href="#修改hostname" id="markdown-toc-修改hostname">修改HOSTNAME</a></li>
      <li><a href="#删掉应用配置" id="markdown-toc-删掉应用配置">删掉应用配置</a></li>
    </ul>
  </li>
  <li><a href="#qemu-kvm虚拟机" id="markdown-toc-qemu-kvm虚拟机">QEMU-KVM虚拟机</a>    <ul>
      <li><a href="#安装必备软件" id="markdown-toc-安装必备软件">安装必备软件</a></li>
      <li><a href="#打开kvm硬件加速" id="markdown-toc-打开kvm硬件加速">打开KVM硬件加速</a></li>
      <li><a href="#创建虚拟硬盘文件" id="markdown-toc-创建虚拟硬盘文件">创建虚拟硬盘文件</a></li>
      <li><a href="#准备-ovmfuefi-固件文件" id="markdown-toc-准备-ovmfuefi-固件文件">准备 OVMF（UEFI 固件）文件</a></li>
      <li><a href="#启动虚拟机" id="markdown-toc-启动虚拟机">启动虚拟机</a></li>
      <li><a href="#安装系统" id="markdown-toc-安装系统">安装系统</a></li>
      <li><a href="#其他操作" id="markdown-toc-其他操作">其他操作</a>        <ul>
          <li><a href="#显卡直通谨慎不懂不要乱搞" id="markdown-toc-显卡直通谨慎不懂不要乱搞">显卡直通(谨慎,不懂不要乱搞)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#拓展功能" id="markdown-toc-拓展功能">拓展功能</a>    <ul>
      <li><a href="#wine" id="markdown-toc-wine">Wine</a></li>
      <li><a href="#android" id="markdown-toc-android">Android</a>        <ul>
          <li><a href="#i卡a卡" id="markdown-toc-i卡a卡">I卡、A卡</a></li>
          <li><a href="#n卡so-nvidia-fxxk-u" id="markdown-toc-n卡so-nvidia-fxxk-u">N卡(So Nvidia Fxxk U!)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#其他操作-1" id="markdown-toc-其他操作-1">其他操作</a>    <ul>
      <li><a href="#工控机如何连wifi" id="markdown-toc-工控机如何连wifi">工控机如何连wifi</a></li>
      <li><a href="#ssh远程开发" id="markdown-toc-ssh远程开发">SSH远程开发</a>        <ul>
          <li><a href="#环境准备-1" id="markdown-toc-环境准备-1">环境准备</a></li>
          <li><a href="#环境搭建" id="markdown-toc-环境搭建">环境搭建</a></li>
        </ul>
      </li>
      <li><a href="#usb端口设置" id="markdown-toc-usb端口设置">USB端口设置</a>        <ul>
          <li><a href="#根据usb设备绑定端口多个不同设备" id="markdown-toc-根据usb设备绑定端口多个不同设备">根据USB设备绑定端口(多个不同设备)</a></li>
          <li><a href="#根据主机硬件绑定端口多个相同设备" id="markdown-toc-根据主机硬件绑定端口多个相同设备">根据主机硬件绑定端口（多个相同设备)</a></li>
          <li><a href="#根据其他属性绑定端口" id="markdown-toc-根据其他属性绑定端口">根据其他属性绑定端口</a></li>
          <li><a href="#其他注意事项" id="markdown-toc-其他注意事项">其他注意事项</a></li>
        </ul>
      </li>
      <li><a href="#linux分区gui工具" id="markdown-toc-linux分区gui工具">Linux分区Gui工具</a></li>
      <li><a href="#rustdesk无人值守远程控制" id="markdown-toc-rustdesk无人值守远程控制">RustDesk无人值守远程控制</a>        <ul>
          <li><a href="#设置-kde6-自动登录" id="markdown-toc-设置-kde6-自动登录">设置 KDE6 自动登录</a></li>
          <li><a href="#关闭锁屏" id="markdown-toc-关闭锁屏">关闭锁屏</a></li>
          <li><a href="#关闭休眠" id="markdown-toc-关闭休眠">关闭休眠</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>暂时无法在飞书文档外展示此内容</p>

<h1 id="发行版推荐">发行版推荐</h1>

<p>根据需求选发行版。</p>

<p>要跑ROS1就装Ubuntu20.04(推荐)</p>

<p>要跑ROS2就装Ubuntu22.04(推荐)或者24.04</p>

<p>想折腾个人推荐Fedora，可以用docker跑ROS1和ROS2(不推荐初学者)</p>

<p>本教程将涵盖Debian系和红帽系两大派系的配置。</p>

<p>Debian系本教程大部分都用Ubuntu当例子。</p>

<p>红帽系本教程大部分都用Fedora当例子。</p>

<h1 id="linux装机教程">Linux装机教程</h1>

<h2 id="实体机双系统最推荐">实体机（双系统，最推荐）</h2>

<h3 id="环境准备">环境准备</h3>

<ol>
  <li>
    <p>至少留出160GB的硬盘空间（可以和Windows是同一块硬盘，也可以是单独的一块硬盘）</p>
  </li>
  <li>
    <p>一个里面没存东西的大于8GB的U盘（也可以没有）</p>
  </li>
  <li>
    <p>一个聪慧的大脑</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image1.webp" alt="" /></p>

<h3 id="关闭安全启动secure-boot">关闭安全启动Secure Boot</h3>

<p>如果下面没有，可以自行B站搜自己品牌的电脑如何关闭安全启动</p>

<h4 id="联想拯救者">联想拯救者</h4>

<h4 id="戴尔游匣intel版">戴尔游匣Intel版</h4>

<p>关机，然后在点开机的一瞬间，一直点摁F12（反复狂摁），直到进入一个白色的BIOS界面。</p>

<p>进入<code class="language-plaintext highlighter-rouge">BIOS SETUP</code>，找到<code class="language-plaintext highlighter-rouge">Boot Configuration</code>，然后往下滑，找到<code class="language-plaintext highlighter-rouge">Enable Secure Boot</code>这个选项，给他关闭就行了。</p>

<p>然后再点下面的<code class="language-plaintext highlighter-rouge">Apply Changes</code>按钮，再点右下角<code class="language-plaintext highlighter-rouge">EXIT</code>按钮重启即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image2.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image3.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image4.webp" alt="" /></p>

<h4 id="惠普暗影精灵">惠普暗影精灵</h4>

<h4 id="华硕天选">华硕天选</h4>

<p>开机狂按F2进入BIOS模式,右下角找到高级模式打开</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image5.webp" alt="" /></p>

<p>关闭安全模式</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image6.webp" alt="" /></p>

<h3 id="开启核显">开启核显</h3>

<p>安装Linux的时候建议开着核显防止Linux图形显示出现问题。</p>

<p>可以通过打开任务管理器来看自己是否开着核显。（轻薄本不用管，轻薄本肯定开着核显的）</p>

<p>①像你如果是Intel的CPU，那么这里GPU0或者GPU1会显示intel xxxxxx。这样是正确的。</p>

<p>②如果你是AMD的CPU，那么这里GPU0或者GPU1会显示amd xxxxxx。这样是正确的。</p>

<p>③如果你发现，你的GPU0是NVIDIA开头的，而且没有GPU1，那么说明你关闭了核显，请按照下面的操作来关闭独显直连开启核显。（如果你是AMD独显，无所谓，开不开独显直连都一样，就不用管了，但是大部分人都不可能是AMD的独显，所以基本排除这一项了）</p>

<p>对于很多游戏本，支持独显直连，所以可能已经默认关闭了核显，只允许了独显运行，所以此时你需要关闭独显直连，开启核显（独显直连对于打游戏提升很大）</p>

<p>如果你确定你确实已经开启了独显直连，请看下方不同电脑品牌的解决方案。</p>

<p>如果下方没有，可以自行去B站搜自己品牌电脑如何切换到混合输出模式。</p>

<h4 id="联想拯救者-1">联想拯救者</h4>

<p>进入联想电脑管家或者Lenovo Ventage，把图形输出模式切换为混合输出即可，</p>

<p>然后重启查看任务管理器确认是否核显已经被打开了。</p>

<h4 id="戴尔游匣intel版-1">戴尔游匣Intel版</h4>

<p>关机，然后在点开机的一瞬间，一直点摁F12（反复狂摁），直到进入一个白色的BIOS界面。</p>

<p>进入BIOS设置，找到<code class="language-plaintext highlighter-rouge">Display</code>，然后往下滑，找到<code class="language-plaintext highlighter-rouge">Enable Hybird Graphic</code>这个选项这个选项，给他打开就行了。然后点<code class="language-plaintext highlighter-rouge">Apply Changes</code>，再退出<code class="language-plaintext highlighter-rouge">EXIT</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image7.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image8.webp" alt="" /></p>

<p>再重启后，打开任务管理器确认核显是否已经被打开了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image9.webp" alt="" /></p>

<h4 id="戴尔游匣amd版">戴尔游匣AMD版</h4>

<h4 id="惠普暗影精灵-1">惠普暗影精灵</h4>

<h4 id="华硕天选-1">华硕天选</h4>

<p>进入BIOS的高级设置模式</p>

<p>高级-显示模式-Dynamic</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image10.webp" alt="" /></p>

<p>保存退出</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image11.webp" alt="" /></p>

<h3 id="安装adk">安装ADK</h3>

<p>https://learn.microsoft.com/zh-cn/windows-hardware/get-started/adk-install</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image12.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image13.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image14.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image15.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image16.webp" alt="" /></p>

<p>下载之前可以关掉梯子，这样可能走的是国内的网，可能会加速下载。（如果你的节点够快，可能走外网下载更快）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image17.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image18.webp" alt="" /></p>

<p>同样下载下面这个</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image19.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image20.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image21.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image22.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image23.webp" alt="" /></p>

<p>这样就安装结束了，可以重新打开傲梅。</p>

<h3 id="下载diskgenius">下载DiskGenius</h3>

<p>在Windows系统上打开百度搜索DiskGenius并下载。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image24.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image25.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image26.webp" alt="" /></p>

<p>找一个纯英文目录创建一个DiskGenius文件夹，建议在任意一个磁盘分区里的Program Files文件夹下新建DiskGenius文件夹。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image27.webp" alt="" /></p>

<p>将刚才压缩包里的所有文件解压到这个DiskGenius文件夹中。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image28.webp" alt="" /></p>

<p>右键拖住它，拖到桌面再放手。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image29.webp" alt="" /></p>

<p>点在这里创建快捷方式。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image30.webp" alt="" /></p>

<p>打开这个快捷方式</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image31.webp" alt="" /></p>

<p>这样就安装成功了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image32.webp" alt="" /></p>

<h3 id="下载傲梅分区助手">下载傲梅分区助手</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image33.webp" alt="" /></p>

<p>https://www.disktool.cn/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image34.webp" alt="" /></p>

<p>下载完解压到一个地方（可以是桌面），双击打开。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image35.webp" alt="" /></p>

<p>如果想安装到C盘，直接点立即安装即可。</p>

<p>如果想安装到D盘，则将默认路径前面的C改成D就行了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image36.webp" alt="" /></p>

<p>随后安装完毕就可以打开软件了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image37.webp" alt="" /></p>

<p>把那个安装包.exe删掉就行了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image38.webp" alt="" /></p>

<h3 id="下载ventoy">下载Ventoy</h3>

<p>https://www.ventoy.net/cn/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image39.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image40.webp" alt="" /></p>

<p>如果进不去下面的界面，请你确保你的网络环境（使用能够绕过GFW的东西，懂得都懂）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image41.webp" alt="" /></p>

<p>找一个纯英文目录创建一个Ventoy文件夹，建议在任意一个磁盘分区里的Program Files文件夹下新建Ventoy文件夹。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image42.webp" alt="" /></p>

<p>把刚才下载的压缩包里的东西解压到这里。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image43.webp" alt="" /></p>

<p>右键拖住它，拖到桌面再放手。再点击创建快捷方式。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image44.webp" alt="" /></p>

<p>双击快捷方式打开。这样就是安装完毕了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image45.webp" alt="" /></p>

<h3 id="下载镜像">下载镜像</h3>

<p>百度搜索 bfsu mirror</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image46.webp" alt="" /></p>

<h4 id="x86_64amd64">X86_64(amd64)</h4>

<ol>
  <li>Ubuntu KDE 22.04（Kubuntu）更推荐</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image47.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image48.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image49.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image50.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image51.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image52.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image53.webp" alt="" /></p>

<ol>
  <li>Ubuntu Gnome 22.04</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image54.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image55.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image56.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image57.webp" alt="" /></p>

<ol>
  <li>Fedora KDE</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image58.webp" alt="" /></p>

<p>依次点击下方的文件夹，那个42是版本号，选最新版即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image59.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image60.webp" alt="" /></p>

<h3 id="硬盘分区安装方案">硬盘分区安装方案</h3>

<p>重点看红字。其他内容你不需要管。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">场景分类</th>
      <th style="text-align: left">场景</th>
      <th style="text-align: left">硬盘分配情况</th>
      <th style="text-align: left">EFI 分区来源</th>
      <th style="text-align: left">Linux 分区方案</th>
      <th style="text-align: left">注意事项</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">同硬盘分区</td>
      <td style="text-align: left">① 同一块硬盘，Win 已安装在硬盘前面</td>
      <td style="text-align: left">硬盘1：前半部分是Win的C盘，D盘等，在末尾新建分区给 Linux</td>
      <td style="text-align: left">复用 Windows 已有 EFI 分区（通常 100–300MB，FAT32，/boot/efi 挂载）</td>
      <td style="text-align: left">新建 /（ext4）+ swap（可选）</td>
      <td style="text-align: left">安装 Linux 引导时要选现有 EFI 分区，避免覆盖 Windows 引导文件。</td>
    </tr>
    <tr>
      <td style="text-align: left">异硬盘混合分区</td>
      <td style="text-align: left">② 两块硬盘，第二块硬盘末尾装 Linux，前面存放 Windows 数据，比如E盘</td>
      <td style="text-align: left">硬盘1：Windows 系统+EFI；硬盘2：前面是Win的数据区，末尾分给 Linux</td>
      <td style="text-align: left">复用 硬盘1 的 EFI 分区</td>
      <td style="text-align: left">硬盘2 新建 / + swap</td>
      <td style="text-align: left">引导还是写入硬盘1 的 EFI；安装时要特别小心不要把 EFI 装到硬盘2。</td>
    </tr>
    <tr>
      <td style="text-align: left">异硬盘独立分区</td>
      <td style="text-align: left">③ 两块硬盘，第二块硬盘全空</td>
      <td style="text-align: left">硬盘1：Windows 系统+EFI；硬盘2：完全给 Linux</td>
      <td style="text-align: left">复用 硬盘1 的 EFI 分区（推荐）或者在硬盘2 新建一个 EFI 分区（双 EFI 并存适合老鸟）</td>
      <td style="text-align: left">硬盘2 新建 / + swap</td>
      <td style="text-align: left">如果新建 EFI，需在 BIOS/UEFI 中手动调整启动顺序；更灵活，但稍复杂。</td>
    </tr>
  </tbody>
</table>

<p>你需要确认你属于哪种情况，下方教程我将以场景一为例子，其他情况也类似。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>───────────────────────────────────────────────────
场景1：同硬盘分区（单硬盘）  
磁盘布局：  
<span class="o">[</span>EFI<span class="o">(</span>共享<span class="o">)]</span> <span class="o">[</span>Win C:] <span class="o">[</span>空闲区域] <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        │      │               │             │  
        └──────┴───────────────┴─────────────┘  
        ↑ 所有系统共用此EFI分区（挂载至/boot/efi）
───────────────────────────────────────────────────
场景2：异硬盘混合分区（双硬盘）  
硬盘1: <span class="o">[</span>EFI<span class="o">(</span>共享<span class="o">)]</span> <span class="o">[</span>Win C:] <span class="o">[</span>D: Win存储区]  
        │  
硬盘2: <span class="o">[</span>E: Win存储区 <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        ↑  
        └─ Linux安装时挂载硬盘1的EFI至/boot/efi
───────────────────────────────────────────────────
场景3：异硬盘独立分区（双硬盘）  
硬盘1: <span class="o">[</span>EFI_Win] <span class="o">[</span>Win C:]  
        │  
硬盘2: <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        │          │  
        └──────────┘  
        ↑ 非独立EFI分区（Linux安装时挂载硬盘1的EFI至/boot/efi）
───────────────────────────────────────────────────
场景3：异硬盘独立分区（双硬盘）  
硬盘1: <span class="o">[</span>EFI_Win] <span class="o">[</span>Win C:]  
        │  
硬盘2: <span class="o">[</span>EFI_Linux] <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        │          │  
        └──────────┘  
        ↑ 独立EFI分区（需手动配置UEFI启动顺序，适合老鸟）
───────────────────────────────────────────────────
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="创建安装介质">创建安装介质</h3>

<h4 id="方法一u盘法">方法一：U盘法</h4>

<p><strong>（如果没有U盘请看本地法）</strong></p>

<p>待肝，几乎和本地法差不太多。</p>

<h5 id="创建ventoy-u盘">创建Ventoy U盘</h5>

<p>把一个大于8GB的U盘插入电脑，然后打开ventoy，选择好U盘，点击安装即可。（注意，此过程可能会格式化U盘，请把数据先备份，等安装完Ventoy后再把数据移动回来即可。）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image61.webp" alt="" /></p>

<h5 id="安装微pe并下载winpe的镜像">安装微PE并下载WinPE的镜像</h5>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image62.webp" alt="" /></p>

<p>https://www.wepe.com.cn/</p>

<p>点击下载2.3版本</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image63.webp" alt="" /></p>

<p>有钱可以捐赠，没钱可以先不捐赠，假装自己捐赠了也行点击已捐赠。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image64.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image65.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image66.webp" alt="" /></p>

<p>下载完把下载的exe复制到你想存放软件的盘（比如C盘）里的Program Files下，新建一个WePE文件夹存放。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image67.webp" alt="" /></p>

<p>双击打开exe文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image68.webp" alt="" /></p>

<p>选择输出位置</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image69.webp" alt="" /></p>

<p>选择桌面并保存</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image70.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image71.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image72.webp" alt="" /></p>

<p>然后去桌面，把刚才生成的镜像复制到U盘里，不要放在U盘的某个文件夹，直接放在U盘里就行。</p>

<p>比如我的U盘是H盘。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image73.webp" alt="" /></p>

<h5 id="复制linux镜像iso">复制Linux镜像iso</h5>

<p>再把你上面下载好的Linux安装镜像也复制到U盘里。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image74.webp" alt="" /></p>

<h5 id="设置启动项ventoy">设置启动项Ventoy</h5>

<p>把U盘插在电脑上，重启电脑，然后打开DiskGenius.</p>

<p>点击导航栏上的<code class="language-plaintext highlighter-rouge">工具</code>选项，然后再点<code class="language-plaintext highlighter-rouge">设置UEFI BIOS启动项</code>。</p>

<p>找到U盘，比如我的U盘是爱国者aigo的，所以应该选aigo。</p>

<p>然后点下次从该启动项启动，重启就可以了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image75.webp" alt="" /></p>

<p>进入这个界面说明成功了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image76.webp" alt="" /></p>

<h5 id="在ventoy里启动linux安装介质镜像">在Ventoy里启动Linux安装介质镜像</h5>

<p>找到你想装的linux的镜像，比如kubuntu22.04,回车进入</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image77.webp" alt="" /></p>

<p>再点回车即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image78.webp" alt="" /></p>

<p>进入下面这个界面就说明成功了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image79.webp" alt="" /></p>

<h4 id="方法二本地法">方法二：本地法</h4>

<h5 id="本地法创建">本地法创建</h5>

<p>本方法是在本地开创一个存放安装介质（安装文件）的分区，为该分区设置上引导，从而安装Linux系统。</p>

<p><strong>这里分的区不是放置Linux的分区。放置的是安装Linux的文件。（类似安装包）</strong></p>

<ol>
  <li>查看自己想要放安装介质（也就是安装文件，大概8GB，建议在C盘）还剩多少空间。比如我是还有231GB.</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image80.webp" alt="" /></p>

<ol>
  <li>然后打开傲梅分区助手，选中你想要放置8GB安装介质的磁盘分区（比如我选的是C盘），然后点击右边的调整/移动分区。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image81.webp" alt="" /></p>

<ol>
  <li>点击分区大小右边的按钮</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image82.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image83.webp" alt="" /></p>

<ol>
  <li>计算<code class="language-plaintext highlighter-rouge">分区后的未分配空间</code></li>
</ol>

<p>①如果你不打算在这个磁盘分区（比如我这里是C盘）里安装Linux（也就是<code class="language-plaintext highlighter-rouge">硬盘分区安装方案的场景</code>②和3️⃣），</p>

<p>那么只需要在下图中的<code class="language-plaintext highlighter-rouge">分区大小</code>中减掉8GB，让<code class="language-plaintext highlighter-rouge">分区后的未分配空间</code>变为8GB即可。</p>

<p>（如果你打算在这个磁盘的分区安装Linux，也就是<code class="language-plaintext highlighter-rouge">硬盘分区安装方案的场景①</code>，那么往下看，用②的法）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image84.webp" alt="" /></p>

<p>②如果你打算在这个磁盘分区中安装Linux，那么需要计算一下到底要压缩多少空间。</p>

<p><code class="language-plaintext highlighter-rouge">分区后的未分配的空间=8GB+打算给Linux的空间大小。</code></p>

<p>比如我剩余的磁盘分区空间为231GB，打算给Linux分配100GB（这里我只是举例子，实际上给Linux的空间不要这么小，至少160GB吧），那么我需要的<code class="language-plaintext highlighter-rouge">分区后的未分配的空间</code>=8GB+100GB=108GB。那么就需要在<code class="language-plaintext highlighter-rouge">分区大小</code>上减去108GB，让<code class="language-plaintext highlighter-rouge">分区后的未分配的空间</code>=108GB.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image85.webp" alt="" /></p>

<ol>
  <li>然后点击确定进行分区，接着在主界面左上角点提交。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image86.webp" alt="" /></p>

<ol>
  <li>接着点执行。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image87.webp" alt="" /></p>

<ol>
  <li>
    <p>因为我修改的是C盘，所以需要进入WinPE里进行操作， <strong>如果你不是在C盘操作的，可能不用做这一步</strong> 。（如果你不能选择Windows PE这个按钮，请去上方教程看看ADK是否安装成功了？）</p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image88.webp" alt="" /></p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image89.webp" alt="" /></p>

<p>等待创建PE结束</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image90.webp" alt="" /></p>

<p>他会自动进入PE进行分区操作。</p>

<p>勾上自动修复分区中的错误和勾上完成操作后自动关机，等待进度条结束即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image91.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image92.webp" alt="" /></p>

<ol>
  <li>然后开机就可以看到我压缩的磁盘分区变小了，我的是C盘，如下图。可以看到C盘后面多了一块未分配的空间。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image93.webp" alt="" /></p>

<ol>
  <li>点击这块未分配的空间，然后点击分区</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image94.webp" alt="" /></p>

<ol>
  <li>给他分一个FAT32格式的8GB大小的磁盘分区。（记住盘符是多少，比如我的是D盘）</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image95.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image96.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image97.webp" alt="" /></p>

<ol>
  <li>然后找到你下载的Linux安装介质.iso，双击打开。（或者右键点<code class="language-plaintext highlighter-rouge">装载mount</code>）</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image98.webp" alt="" /></p>

<ol>
  <li>然后去此电脑里找到这个被加载的镜像，点进去。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image99.webp" alt="" /></p>

<ol>
  <li>再打开FAT32格式的这个磁盘分区。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image100.webp" alt="" /></p>

<ol>
  <li>将镜像里的所有内容全部复制到FAT32的磁盘分区中。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image101.webp" alt="" /></p>

<ol>
  <li>右键镜像<code class="language-plaintext highlighter-rouge">弹出Eject</code>虚拟镜像。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image102.webp" alt="" /></p>

<ol>
  <li>然后打开DiskGenius，点击导航栏上的<code class="language-plaintext highlighter-rouge">工具</code>选项，然后再点<code class="language-plaintext highlighter-rouge">设置UEFI BIOS启动项</code>。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image103.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image104.webp" alt="" /></p>

<ol>
  <li>点击添加启动项，文件路径选择刚才Fat32分区（比如我的是D盘）。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image105.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image106.webp" alt="" /></p>

<ol>
  <li>依次找到/EFI/boot/bootx64.efi</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image107.webp" alt="" /></p>

<ol>
  <li>可以命名为Linux Install，点击保存，并选择下一次重启以这个引导当首选项。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image108.webp" alt="" /></p>

<ol>
  <li>重启，可以看到下方已经进入了Linux安装界面。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image109.webp" alt="" /></p>

<p>重启后是这个样子，说明进入安装界面了。（对于硬盘分区安装方案的场景①的此时已经可以开始安装了，对于还没给Linux预留安装空间的请按电源按键关机并重启回Windows）</p>

<p>如果你安装失败了，你还想进这个安装界面，则在DiskGenius里像上面那样在BIOS UEFI设置里选中引导，勾上<code class="language-plaintext highlighter-rouge">下一次从该项启动</code>，然后重启即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image110.webp" alt="" /></p>

<h5 id="删除本地安装介质安装完后再删">删除本地安装介质(安装完后再删）</h5>

<p>当你使用本地法安装Linux的话，你完成Linux的安装需要删除掉开辟的这8GB的FAT32的空间。</p>

<p>打开傲梅分区助手。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image111.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image112.webp" alt="" /></p>

<p>然后再找到C盘，点调整分区。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image113.webp" alt="" /></p>

<p>然后把剩下的空闲空间全部还给C盘。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image114.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image115.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image116.webp" alt="" /></p>

<h3 id="linux安装空间的预留">Linux安装空间的预留</h3>

<h4 id="硬盘分区安装方案的场景">硬盘分区安装方案的场景①</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>───────────────────────────────────────────────────
场景1：同硬盘分区（单硬盘）  
磁盘布局：  
<span class="o">[</span>EFI<span class="o">(</span>共享<span class="o">)]</span> <span class="o">[</span>Win C:] <span class="o">[</span>空闲区域] <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        │      │               │             │  
        └──────┴───────────────┴─────────────┘  
        ↑ 所有系统共用此EFI分区（挂载至/boot/efi）
───────────────────────────────────────────────────
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果你是本地法+场景一，则已经创建过这个地方了，（如下图）跳过本节。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image117.webp" alt="" /></p>

<p>但如果你是U盘法，则接着往下看。</p>

<p>场景一是和Windows装在一个硬盘里。</p>

<ol>
  <li>打开傲梅分区助手。找到你想安装Linux的Windows的硬盘。点移动分区。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image118.webp" alt="" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">分区后的未分配空间</code>就是你要安装Linux的空间。设置分区大小，或者拖动下面的图形按钮都可以更改分区大小。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image119.webp" alt="" /></p>

<ol>
  <li>然后点击确定进行分区，接着在主界面左上角点提交。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image120.webp" alt="" /></p>

<ol>
  <li>接着点执行。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image121.webp" alt="" /></p>

<ol>
  <li>因为我修改的是C盘，所以需要进入WinPE里进行操作， <strong>如果你不是在C盘操作的，可能不用做这一步</strong> 。（如果你不能选择Windows PE这个按钮，请去上方教程看看ADK是否安装成功了？）</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image122.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image123.webp" alt="" /></p>

<p>等待创建PE结束</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image124.webp" alt="" /></p>

<p>他会自动进入PE进行分区操作。</p>

<p>勾上自动修复分区中的错误和勾上完成操作后自动关机，等待进度条结束即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image125.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image126.webp" alt="" /></p>

<ol>
  <li>然后开机就可以看到我压缩的磁盘分区变小了，我的是C盘，如下图。可以看到C盘后面多了一块未分配的空间。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image127.webp" alt="" /></p>

<h4 id="硬盘分区安装方案的场景-1">硬盘分区安装方案的场景②</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>───────────────────────────────────────────────────
场景2：异硬盘混合分区（双硬盘）  
硬盘1: <span class="o">[</span>EFI<span class="o">(</span>共享<span class="o">)]</span> <span class="o">[</span>Win C:] <span class="o">[</span>D: Win存储区]  
        │  
硬盘2: <span class="o">[</span>E: Win存储区 <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        ↑  
        └─ Linux安装时挂载硬盘1的EFI至/boot/efi
───────────────────────────────────────────────────
</pre></td></tr></tbody></table></code></pre></div></div>

<p>像场景一一样，把你第二个硬盘里的后半部分像场景一一样给压缩取消掉挂载就行。</p>

<h4 id="硬盘分区安装方案的场景3️⃣">硬盘分区安装方案的场景3️⃣</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>───────────────────────────────────────────────────
场景3：异硬盘独立分区（双硬盘）  
硬盘1: <span class="o">[</span>EFI_Win] <span class="o">[</span>Win C:]  
        │  
硬盘2: <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        │          │  
        └──────────┘  
        ↑ 非独立EFI分区（Linux安装时挂载硬盘1的EFI至/boot/efi）
───────────────────────────────────────────────────
场景3：异硬盘独立分区（双硬盘）  
硬盘1: <span class="o">[</span>EFI_Win] <span class="o">[</span>Win C:]  
        │  
硬盘2: <span class="o">[</span>EFI_Linux] <span class="o">[</span>Linux Swap] <span class="o">[</span>Linux /]  
        │          │  
        └──────────┘  
        ↑ 独立EFI分区（需手动配置UEFI启动顺序，适合老鸟）
───────────────────────────────────────────────────
</pre></td></tr></tbody></table></code></pre></div></div>

<p>直接把整个第二个硬盘所有分区全部删除，格式化即可。</p>

<h3 id="安装linux">安装Linux</h3>

<p>以Kubuntu 22.04（Ubuntu KDE 22.04）为例子，其他发行版差不多其实也。</p>

<h4 id="grub设置">grub设置</h4>

<p>在下面这个界面按E。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image128.webp" alt="" /></p>

<p>在这一行后面加上 <code class="language-plaintext highlighter-rouge">noauto toram</code></p>

<p>这个<code class="language-plaintext highlighter-rouge">noauto</code>是必须要写的。那个<code class="language-plaintext highlighter-rouge">toram</code>如果你电脑内存大于等于16GB（小于8GB谨慎，可能会崩溃），则可以填，这样安装速度会提升200+%，甚至300+%，甚至无上限。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image129.webp" alt="" /></p>

<p>然后按crtl+X启动系统。</p>

<h4 id="基础安装选项">基础安装选项</h4>

<p>这里语言一定选择English比较好。（这样/home分区底下所有文件夹都是英文，不会出现中文。）</p>

<p>然后选Install Kubuntu.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image130.webp" alt="" /></p>

<p>点continue</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image131.webp" alt="" /></p>

<p>连接网络，先点connect to this network,然后找到wifi名，输入上密码，点右边的connect,出现connected后，点continue.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image132.webp" alt="" /></p>

<p>这里和我选的一样即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image133.webp" alt="" /></p>

<h4 id="分区设置重要">分区设置（重要！！！）</h4>

<h5 id="与windows使用同一个efi分区">与Windows使用同一个EFI分区</h5>

<h6 id="初步设置">初步设置</h6>

<p>这里选Manual,咱们手动分区。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image134.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image135.webp" alt="" /></p>

<p>找到咱们之前预留给Linux的那块磁盘区域，比如我的是预留了100GB的那块区域，大概Size是107452MB，一定别找错磁盘区域了。如果你这里不是<code class="language-plaintext highlighter-rouge">free space</code>，那么左键选中，点<code class="language-plaintext highlighter-rouge">delete</code>.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image136.webp" alt="" /></p>

<h6 id="swap分区建立">swap分区建立</h6>

<p>选中这块区域，双击或者点击Add按钮。</p>

<p>use as选<code class="language-plaintext highlighter-rouge">swap area.</code></p>

<p>给swap区域分区，这个Size请填写你的<code class="language-plaintext highlighter-rouge">内存大小（运存大小）+2GB</code><em><code class="language-plaintext highlighter-rouge">（单位MB）</code></em>，比如我电脑内存为32GB，那么32+2=34GB，再用<code class="language-plaintext highlighter-rouge">34*1024=34816MB，</code>所以填<code class="language-plaintext highlighter-rouge">34816</code>.</p>

<p>tips（可以不看）：为何要这么做是为了开启Linux的休眠功能，如果你的swap分区大小设置有误，Linux休眠功能可能会出问题。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image137.webp" alt="" /></p>

<h6 id="根目录分区建立">根目录/分区建立</h6>

<p>再选中剩余的这块区域，双击或者点击Add按钮。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image138.webp" alt="" /></p>

<p>use as选 ext4</p>

<p>然后挂载点选<code class="language-plaintext highlighter-rouge">/</code>（也就是根目录）</p>

<p>Size使用默认的就行（默认就是把剩下的最大容量全给<code class="language-plaintext highlighter-rouge">根目录</code>）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image139.webp" alt="" /></p>

<h6 id="取消挂载其他无关分区">取消挂载其他无关分区</h6>

<p>如下图，swap和/已经被创建成功了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image140.webp" alt="" /></p>

<p>把上图除了<strong>efi和刚才创建的那俩分区</strong> 的其他分区全部点change更改为do not use the partition.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image141.webp" alt="" /></p>

<h6 id="设置uefi引导位置">设置UEFI引导位置</h6>

<p>把最下方那个<code class="language-plaintext highlighter-rouge">bootloader</code>设置为<code class="language-plaintext highlighter-rouge">efi</code>分区的磁盘号。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image142.webp" alt="" /></p>

<p>点击右下角Install Now，看看是不是下面只显示修改了swap和ext4俩分区，如果有其他的，说明有无关分区没被取消挂载。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image143.webp" alt="" /></p>

<h5 id="独立的efi分区不推荐">独立的EFI分区（不推荐）</h5>

<p>这种适用于你有一个空的硬盘（不是空的磁盘分区，是一整个硬盘全是空的），然后整个硬盘全分给Linux。（当然这种情况也适用于上面那个和Windows共用一个EFI分区的方法）</p>

<p>适合老鸟。</p>

<p>优点是崩了直接格掉整个硬盘，很干净。</p>

<h6 id="初步设置-1">初步设置</h6>

<p>这里选Manual,咱们手动分区。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image144.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image145.webp" alt="" /></p>

<p>找到咱们预留的空硬盘。（整个硬盘全空，我单独找了个空的128GB的硬盘来写教程，如下图的nvme0n1）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image146.webp" alt="" /></p>

<h6 id="efi分区建立比前面的那种方法多一个efi分区">EFI分区建立（比前面的那种方法多一个EFI分区）</h6>

<p>双击你的硬盘底下的free space,</p>

<p>然后size设置为1024,use as设置为EFI分区。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image147.webp" alt="" /></p>

<h6 id="swap分区建立-1">swap分区建立</h6>

<p>紧接着再点free space。</p>

<p>选中这块区域，双击或者点击Add按钮。</p>

<p>use as选<code class="language-plaintext highlighter-rouge">swap area.</code></p>

<p>给swap区域分区，这个Size请填写你的<code class="language-plaintext highlighter-rouge">内存大小（运存大小）+2GB</code><em><code class="language-plaintext highlighter-rouge">（单位MB）</code></em>，比如我电脑内存为32GB，那么32+2=34GB，再用<code class="language-plaintext highlighter-rouge">34*1024=34816MB，</code>所以填<code class="language-plaintext highlighter-rouge">34816</code>.</p>

<p>tips（可以不看）：为何要这么做是为了开启Linux的休眠功能，如果你的swap分区大小设置有误，Linux休眠功能可能会出问题。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image148.webp" alt="" /></p>

<h6 id="根目录分区建立-1">根目录/分区建立</h6>

<p>再选中剩余的这块区域，双击或者点击Add按钮。</p>

<p>use as选 ext4</p>

<p>然后挂载点选<code class="language-plaintext highlighter-rouge">/</code>（也就是根目录）</p>

<p>Size使用默认的就行（默认就是把剩下的最大容量全给<code class="language-plaintext highlighter-rouge">根目录</code>）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image149.webp" alt="" /></p>

<h6 id="取消挂载其他无关分区-1">取消挂载其他无关分区</h6>

<p>把上图除了刚才创建的<strong>efi，swap,根目录/</strong> 的其他分区全部点change更改为do not use the partition.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image150.webp" alt="" /></p>

<h6 id="设置uefi引导位置-1">设置UEFI引导位置</h6>

<p>把最下方那个<code class="language-plaintext highlighter-rouge">bootloader</code>设置为<code class="language-plaintext highlighter-rouge">efi</code>分区的磁盘号。比如我这里是nvme0n1p1。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image151.webp" alt="" /></p>

<p>点击右下角Install Now，看看是不是下面只显示修改了efi,swap和ext4仨分区，如果有其他的，说明有无关分区没被取消挂载。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image152.webp" alt="" /></p>

<h4 id="最后设置">最后设置</h4>

<p>时区选个东八区的就行。默认应该是中国上海🇨🇳时间，也可以选中国香港🇭🇰，中国台湾🇨🇳时间都可以。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image153.webp" alt="" /></p>

<p>用户名设置为英文开头的就行，我这里是tungchiahui</p>

<p>密码选个简单点的，纯数字的，因为以后要经常输入，所以尽可能简单点。</p>

<p>电脑名字随便起，英文开头就行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image154.webp" alt="" /></p>

<p>等着就行了，与网速，电脑性能都有关。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image155.webp" alt="" /></p>

<p>重启。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image156.webp" alt="" /></p>

<p>如果你是U盘法，请拔掉U盘（大部分情况不拔也行，只要你的开机首选项不是U盘），然后点回车重启</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image157.webp" alt="" /></p>

<p>开机啦！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image158.webp" alt="" /></p>

<h3 id="双系统切换">双系统切换</h3>

<p>在点了开机键进入了grub（黑色的界面）</p>

<p>上面显示Ubuntu选项就是进Linux。</p>

<p>上面显示Windows选项就是进Windows。</p>

<h3 id="彻底删除linux">彻底删除Linux</h3>

<h4 id="分区格式化">分区格式化</h4>

<p>打开diskgenius，找到给Linux分的盘。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image159.webp" alt="" /></p>

<p>挨个选中，点删除分区。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image160.webp" alt="" /></p>

<p>点保存更改。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image161.webp" alt="" /></p>

<h4 id="引导删除">引导删除</h4>

<h5 id="和windows共用efi">和Windows共用EFI</h5>

<p>打开DiskGenius双击Windows的ESP分区。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image162.webp" alt="" /></p>

<p>进入EFI文件夹，找到ubuntu文件夹，右键<code class="language-plaintext highlighter-rouge">强制删除</code></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image163.webp" alt="" /></p>

<p>然后后面不管给你啥警告，一直点删除，和确定删除等字眼。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image164.webp" alt="" /></p>

<p>这样引导就删除完毕了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image165.webp" alt="" /></p>

<h5 id="独立的efi">独立的EFI</h5>

<p>则直接格式化掉整个硬盘即可。</p>

<p>找到自己第二个盘。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image166.webp" alt="" /></p>

<p>右键选中整个硬盘，点<code class="language-plaintext highlighter-rouge">删除所有分区</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image167.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image168.webp" alt="" /></p>

<h2 id="普通虚拟机不推荐">普通虚拟机（不推荐）</h2>

<p>(不用教，自己百度解决)</p>

<h2 id="windows-subsystem-for-linux-2windows的linux子系统2勉强的法子">Windows Subsystem For Linux 2(Windows的Linux子系统2)（勉强的法子）</h2>

<h3 id="简介与优缺点">简介与优缺点</h3>

<ol>
  <li>什么情况下推荐？</li>
</ol>

<p>无多余硬盘，没法实体装Linux。此时最优选择就是WSL2。而非VMware等虚拟机。</p>

<ol>
  <li>
    <p>优缺点：</p>

    <ol>
      <li>
        <p>优点：</p>

        <ol>
          <li>
            <p>WSL2是最好的Linux发行版;(bushi)</p>
          </li>
          <li>
            <p>性能损耗极低。且比在Windows上跑深度性能 <strong>强非常非常多;</strong> （如下图，时间的数值越低证明性能越高）</p>
          </li>
          <li>
            <p>非常方便调用USB设备，可以USB直通;</p>
          </li>
          <li>
            <p>非常方便使用英伟达显卡的CUDA与cuDNN;</p>
          </li>
          <li>
            <p>非常方便Win与WSL2互相传文件等协同操作;</p>
          </li>
          <li>
            <p>WSL2中甚至可以在Linux的终端中使用Windows软件;</p>
          </li>
          <li>
            <p>非常方便使用Windows的VScode远程开发;</p>
          </li>
        </ol>
      </li>
      <li>
        <p>缺点：</p>

        <ol>
          <li>无法调用本机摄像头，或说调用本机摄像头会巨麻烦。（虽无法调用本机摄像头，但是可以使用USB的摄像头）</li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image169.webp" alt="" /></p>

<h3 id="安装教程">安装教程</h3>

<h4 id="启动wsl2子系统和虚拟平台">启动WSL2子系统和虚拟平台</h4>

<ol>
  <li>方法一(图形界面)</li>
</ol>

<p>用Win+R输入<code class="language-plaintext highlighter-rouge">appwiz.cpl</code>：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image170.webp" alt="" /></p>

<p>点击OK进入 <strong>程序和功能/Programs and Features</strong> 界面，点击 <strong>启用或关闭Windows功能/Turn Windows features on or off</strong> ：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image171.webp" alt="" /></p>

<p>选择 <strong>适用于Linux的Windows子系统/Windows Subsystem for Linux</strong> 和 <strong>虚拟机平台/Virtual Machine Platform</strong> 功能：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image172.webp" alt="" /></p>

<ol>
  <li>方法二(命令行)</li>
</ol>

<pre><code class="language-PowerShell">
# 开启 Linux 子系统
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart

# 开启虚拟机平台
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre>

<h4 id="将wsl2设置为默认版本">将WSL2设置为默认版本</h4>

<p>用管理员权限打开powershell</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image173.webp" alt="" /></p>

<p>升级WSL并设置默认版本为WSL2</p>

<pre><code class="language-PowerShell">
# 更新 wsl
wsl --update

# 将 wsl 版本设置为 wsl2
wsl --set-default-version 2
</code></pre>

<h4 id="安装linux发行版">安装Linux发行版</h4>

<ol>
  <li>方式一(商店下载,推荐，网速快，不用翻)</li>
</ol>

<p>直接打开Microsoft Store搜索对应的发行版下载即可(比如Ubuntu 22.04 LTS)</p>

<p>要是跑ROS1建议20.04LTS.</p>

<p>ROS2的话更建议用22.04LTS，对于初学者来说，教程多才是最好的，ROS2 Humble和ROS2 Jazzy在gazebo上区别还是很大的，先学教程多的，以后可以慢慢再转Jazzy。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image174.webp" alt="" /></p>

<ol>
  <li>方式二(命令行安装)</li>
</ol>

<pre><code class="language-PowerShell">
# 列出可安装的 Linux 版本
#（需要科学手段）
wsl --list --online
</code></pre>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image175.webp" alt="" /></p>

<p>选择对应发行版并安装</p>

<pre><code class="language-PowerShell">
# Ubuntu安装完毕后(可以重启)
wsl --install -d Ubuntu-22.04
</code></pre>

<h4 id="查看系统状态">查看系统状态</h4>

<pre><code class="language-PowerShell">
# 查看 wsl
wsl -l

# 查看 wsl 运行版本或模式
wsl -l -v

# 设置发行版为使用 wsl 2 （如果版本为 2 则不需要）
wsl --set-version &lt;distro&gt; 2

# 选择要注销的版本 （如果想卸载再用此命令）
wsl --unregister &lt;distro&gt;
</code></pre>

<p>输出Version为2即正常</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image176.webp" alt="" /></p>

<h4 id="设置用户名与密码">设置用户名与密码</h4>

<p>直接在Powershell里输入wsl命令进入子系统</p>

<pre><code class="language-PowerShell">
# 进入子系统
wsl
</code></pre>

<p>输入用户名(随便设置，建议字母+数字，或者纯字母)</p>

<p>输入密码(建议低于6位的数字，并且在输入密码时，终端上不会显示输入的字符，但是已经正常输入了)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image177.webp" alt="" /></p>

<h4 id="卸载发行版">卸载发行版</h4>

<p>如果出现问题，就卸载wsl2出问题的发行版</p>

<p>第一步在powershell里输入下列命令查询发行版信息。</p>

<p>```Plain Text
wsl -l -v</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
第二步在微软应用商店将Ubuntu卸载。(该步一般可以省略)

第三步要敲下方命令进行注销:

```Plain Text
wsl --unregister 发行版名称
</pre></td></tr></tbody></table></code></pre></div></div>

<p>第四步可以从安装发行版这步重新装。</p>

<h3 id="配置各种环境">配置各种环境</h3>

<h4 id="换源">换源</h4>

<p>(同实体机LINUX，往下找教程)</p>

<h4 id="英伟达显卡">英伟达显卡</h4>

<h5 id="显卡驱动">显卡驱动</h5>

<p>不用安装，只要你的Windows安装了驱动，你的WSL2就已经安装好驱动了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image178.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image179.webp" alt="" /></p>

<h5 id="cuda">CUDA</h5>

<p>https://developer.nvidia.com/cuda/wsl</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image180.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image181.webp" alt="" /></p>

<p>在下方的网站，选择合适的版本。</p>

<p>https://developer.nvidia.com/cuda-toolkit-archive</p>

<p><strong>(同实体机LINUX，往下找教程，唯一与实体机不同的地方如下图)</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image182.webp" alt="" /></p>

<p>挨行敲一遍</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image183.webp" alt="" /></p>

<p>敲完后，输入<code class="language-plaintext highlighter-rouge">nvcc -V</code>检测是否安装成功，如果出现下图，证明没配置环境。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image184.webp" alt="" /></p>

<p>（请详看下方教程的<strong>安装</strong><strong>CUDA</strong><strong>的配置环境来看</strong>如何配置环境）</p>

<h5 id="cudnn">cuDNN</h5>

<p>(同实体机LINUX，往下找教程)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image185.webp" alt="" /></p>

<h4 id="配置网络">配置网络</h4>

<p>WSL2默认是NAT模式，也就是拿Windows当网关，WSL2是Windows的下级设备，这样的话，WSL2和Windows并不处于同一网段，WSL2只能和Windows以及Windows的上游设备进行通信，无法与和Windows同局域网的同网段设备进行通信。想要和同网段的ROS、ROS2设备进行通信，只能要么端口转发，要么设置DDS，都是非常麻烦的。</p>

<p>WSL2还提供了好几种模式，有一个模式叫Mirrored模式 <strong>（Windows 10 22H2及以上才能开启）</strong> ，相当于Docker的<code class="language-plaintext highlighter-rouge">--network host</code>，这种方式是让WSL2和Windows使用相同的IP，这样的话，不论是WSL2还是Windows都可以访问同网段的局域网设备了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image186.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image187.webp" alt="" /></p>

<p>重启WSL2</p>

<pre><code class="language-PowerShell">wsl --shutdown
wsl
</code></pre>

<h4 id="usb直通">USB直通</h4>

<p>https://learn.microsoft.com/zh-cn/windows/wsl/connect-usb</p>

<p>直通的USB设备只供WSL2使用，应该Windows是没法使用的，如果想使用，请解绑（关闭直通）。</p>

<p>首先现在电脑上安装usbipd，下面是github链接，进去点releases。</p>

<p>https://github.com/dorssel/usbipd-win</p>

<p>点击x64.msi下载并安装。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image188.webp" alt="" /></p>

<p>安装完后，然后开启你的WSL2</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image189.webp" alt="" /></p>

<p>右键开始菜单，选择终端（以管理员身份运行）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image190.webp" alt="" /></p>

<p>列出设备</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">usbipd</span> <span class="n">list</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>下图这个busid为2-1的就是我的目标。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image191.webp" alt="" /></p>

<p>绑定并链接设备，这个2-1要换成你对应的busid</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">usbipd</span> <span class="n">bind</span> <span class="o">--</span><span class="n">busid</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">force</span>
<span class="n">usbipd</span> <span class="n">attach</span> <span class="o">--</span><span class="n">wsl</span> <span class="o">--</span><span class="n">busid</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image192.webp" alt="" /></p>

<p>然后在wsl中的终端里查看设备。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">lsusb</span>

<span class="n">ls</span> <span class="o">/</span><span class="n">dev</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image193.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image194.webp" alt="" /></p>

<p>如果你中途插拔了USB，WSL2找不到了的话，请解绑设备。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">usbipd</span> <span class="n">unbind</span> <span class="o">--</span><span class="n">busid</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后再像上方那样重新绑定即可。</p>

<h4 id="vscode远程开发">VScode远程开发</h4>

<p>(一定要把工程放在Linux中开发，别放在Win磁盘中，否则I/O效率会很低)</p>

<p>安装该插件(WSL2有自己的远程开发插件，无需使用SSH）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image195.webp" alt="" /></p>

<p>连接WSL2</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image196.webp" alt="" /></p>

<p>远程开发成功。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image197.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image198.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image199.webp" alt="" /></p>

<h4 id="linux终端使用windows软件">Linux终端使用Windows软件</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image200.webp" alt="" /></p>

<h4 id="opengl有问题">OpenGL有问题</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt upgrade
<span class="nb">sudo </span>apt <span class="nb">install </span>mesa-utils

<span class="c">#然后重启wsl2即可</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="安装必备配置">安装必备配置</h1>

<h2 id="软件包换源以debian系的发行版为例">  软件包换源（以Debian系的发行版为例）</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>  打开下方网站（注意，该Ubuntu仓库版本是X86、amd64的仓库，ARM的仓库并非该网站（99.9%的人的电脑是X86的，很多工控机是ARM的，但工控机也有X86的，请看[Vinci机器人队单片机教程](https://sdutvincirobot.feishu.cn/docx/PRAodvrWvoXTrVxP1EDcMKM7nXb)中讲的了解一下，或者自行百度。）

  下方这几个镜像源选一个即可。

https://mirrors.bfsu.edu.cn/help/ubuntu/

https://mirrors.cloud.tencent.com/help/ubuntu.html

https://developer.aliyun.com/mirror/ubuntu

https://mirrors.sustech.edu.cn/help/ubuntu.html#introduction

https://mirrors.ustc.edu.cn/help/ubuntu.html

https://help.mirrors.cernet.edu.cn/ubuntu/

  可以测速，选择出速度最快的源。

```bash
curl https://mirrors.cernet.edu.cn/oh-my-mirrorz.py | python3
```

  在北方（山东）测速如下：

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image201.webp)

  在南方（广东）测速如下：

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image202.webp)

  在南北都比较快的是`北京外国语大学BFSU`和`南方科技大学SUSTech`，不想测速可以无脑选，也可以测速选择最好的源。
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ubuntu2204及debian10及以下版本">  Ubuntu22.04(及Debian10)及以下版本</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre>  输入以下命令

```bash
sudo apt update
sudo apt install vim
sudo vim /etc/apt/sources.list
```

  在以下界面，用键盘按`ggdG`（注意区分大小写）

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image203.webp)

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image204.webp)

  选择好Ubuntu版本后，

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image205.webp)

  粘贴进去

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image206.webp)

  按一下ESC，然后英文冒号，输入 `:wq!`然后回车

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image207.webp)

  输入以下命令

```bash
sudo apt update
```

  下方出现对应学校源网站则成功

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image208.webp)

  至此换源结束
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ubuntu2404及debian12及以上版本">  Ubuntu24.04(及Debian12)及以上版本</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>```bash
sudo apt update
sudo apt install vim
sudo rm -rf /etc/apt/sources.list
sudo rm -rf /etc/apt/sources.list.d/**

sudo vim /etc/apt/sources.list.d/ubuntu.sources
```
</pre></td></tr></tbody></table></code></pre></div></div>

<p>选择好Ubuntu版本后，复制下方的内容。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image209.webp" alt="" /></p>

<p>粘贴进去</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image210.webp" alt="" /></p>

<p>按一下ESC，然后英文冒号，输入 <code class="language-plaintext highlighter-rouge">:wq!</code>然后回车</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image211.webp" alt="" /></p>

<p>输入以下命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里被替换成对应学校则成功</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image212.webp" alt="" /></p>

<h3 id="fedora41dnf5及之后">Fedora41(DNF5)及之后</h3>

<p>https://mirrors.bfsu.edu.cn/help/fedora/</p>

<p>https://help.mirrors.cernet.edu.cn/fedora/</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s|^metalink=|#metalink=|g'</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="s1">'s|^#baseurl=http://download.example/pub/fedora/linux|baseurl=https://mirrors.bfsu.edu.cn/fedora|g'</span> <span class="se">\</span>
    <span class="nt">-i</span>.bak <span class="se">\</span>
    /etc/yum.repos.d/fedora.repo <span class="se">\</span>
    /etc/yum.repos.d/fedora-updates.repo
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="卸载恶心的snapubuntu的衍生版">卸载恶心的snap(Ubuntu的衍生版)</h2>

<p><strong>⚠️官方默认原版Ubuntu</strong> <strong>Gnome</strong><strong>不要卸载snap,会g.原版Ubuntu只能继续让snap恶心你，没办法。(现在貌似非原版ubuntu也不允许卸载了，恶心坏了）</strong></p>

<p>所以我一直都推荐Ubuntu KDE（也就是Kubuntu）。</p>

<h3 id="安装非firefox浏览器">安装非firefox浏览器</h3>

<p>卸载snap前，请先安装一个浏览器（以Google Chrome为例）(这里是因为Ubuntu默认安装的是snap版本的FireFox)</p>

<p>以下是Google上海服务器的Chrome官网（无需挂梯）</p>

<p>https://www.google.cn/chrome/index.html</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image213.webp" alt="" /></p>

<p>咱们这里是Ubuntu所以是Debian系的系统，所以选deb扩展名的程序包。（也就是红色框框）</p>

<p>红帽系则需要安装的是rpm扩展名程序包。（也就是蓝色框框）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image214.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c">#某些发行版中，可能Downloads是中文下载，所以就需要  cd ~/下载</span>
<span class="nb">cd</span> ~/Downloads
<span class="c">#下方chrome安装包名不一定是这个，根据名字来看</span>
<span class="nb">sudo </span>apt <span class="nb">install</span> ./google-chrome-stable_current_amd64.deb
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image215.webp" alt="" /></p>

<h3 id="查看snap包应用数量">查看snap包应用数量</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>
<span class="c"># 老版</span>
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>neofetch
neofetch

<span class="c"># 新版</span>
<span class="nb">sudo </span>add-apt-repository ppa:zhangsongcui3371/fastfetch
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>fastfetch
fastfetch

<span class="c"># windows 想看系统信息的话</span>
winget <span class="nb">install </span>fastfetch
<span class="c">#重启 powershell</span>
fastfetch
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里显示，一共有3162个debian的程序，7个snap程序</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image216.webp" alt="" /></p>

<h3 id="移除snap应用">移除snap应用</h3>

<p>系统在启动时，会自动启动Snap相关服务，我们先禁用掉这些服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl disable snapd.service
<span class="nb">sudo </span>systemctl disable snapd.socket
<span class="nb">sudo </span>systemctl disable snapd.seeded.service
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后查看snap应用列表</p>

<p>根据你安装的选择不同（最小安装或普通安装），有<a href="https://so.csdn.net/so/search?q=%E4%B8%8D%E5%90%8C%E7%9A%84&amp;spm=1001.2101.3001.7020">不同的</a>Snap软件会被预装到系统，在删除Snap服务之前，我们需要移除Snap安装的这些</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 查询当前系统上snap安装了哪些app</span>
snap list
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image217.webp" alt="" /></p>

<p>卸载掉图中所有应用，按照<strong>先删除应用软件，再删除非应用软件</strong>的顺序进行删除</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c">#移除snap-store，如果是Kubuntu，则没有这个东西，测不需要卸载</span>
<span class="nb">sudo </span>snap remove snap-store
<span class="c">#移除firefox浏览器 gnome-42-2204 gtk-common-themes(可以一次性移除多个)</span>
<span class="nb">sudo </span>snap remove firefox gnome-42-2204 gtk-common-themes
<span class="c">#移除其它...</span>

<span class="c">#移除core22,bare以及snapd（下面这些需要最后再移除，否则会报错）</span>
<span class="nb">sudo </span>snap remove core22
<span class="nb">sudo </span>snap remove bare
<span class="nb">sudo </span>snap remove snapd
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image218.webp" alt="" /></p>

<p>输入以下命令查看是否还有snap包</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>snap list

<span class="c"># 老版</span>
neofetch

<span class="c"># 新版</span>
fastfetch
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image219.webp" alt="" /></p>

<h3 id="移除snap">移除snap</h3>

<p>在删除掉<a href="https://so.csdn.net/so/search?q=Snap%E5%AE%89%E8%A3%85&amp;spm=1001.2101.3001.7020">Snap安装</a>的软件后，下一步就是把Snap本身也删除掉，这里需要使用Apt来实现（谨慎卸载，可视化页面容易崩）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre> <span class="c">#使用apt移除掉snap</span>
<span class="nb">sudo </span>apt autoremove <span class="nt">--purge</span> snapd
<span class="c">#移除snapd的一些目录</span>
<span class="nb">sudo rm</span> <span class="nt">-rf</span> /var/cache/snapd
<span class="nb">sudo rm</span> <span class="nt">-rf</span> ~/snap
</pre></td></tr></tbody></table></code></pre></div></div>

<p>至此，其实snap已经被删除掉了。但是这个并不足够，如果你使用apt安装一些软件 <code class="language-plaintext highlighter-rouge">sudo apt install firefox</code>时，会自动下载并重新安装snap服务。因为Ubuntu源中的一些软件已经是snap版本，而非deb版本，下载snap版本时，会自动检查并在必要时重新安装snap服务。这也是Canonical为了推广自己的Snap Store而做的一些额外的努力吧。(这一点最被很多人不喜欢)</p>

<h3 id="禁止系统自动安装snap">禁止系统自动安装snap</h3>

<p>我们可以利用APT可配置禁用安装哪些依赖的特性，来实现禁止重新自动安装Snap服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/apt/preferences.d/nosnap.pref
</pre></td></tr></tbody></table></code></pre></div></div>

<p>按insert进入编辑模式，然后复制以下内容，最后按ESC，切换为英文输入法模式，然后敲 <code class="language-plaintext highlighter-rouge">:wq</code> 回车</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>Package: snapd
Pin: release <span class="nv">a</span><span class="o">=</span><span class="k">*</span>
Pin-Priority: <span class="nt">-10</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image220.webp" alt="" /></p>

<h3 id="测试是否成功">测试是否成功</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>firefox
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里提示snapd无法被安装，就证明成功了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image221.webp" alt="" /></p>

<h3 id="重新安装firefox浏览器没大有必要">重新安装FireFox浏览器（没大有必要）</h3>

<p>我个人其实更偏好Google Chrome浏览器，浏览器是从Chrome官网下载deb进行安装的。所以我有浏览器了，就没必要安装火狐浏览器了，</p>

<p>但如果你确实喜欢Firefox，在删除掉Snap后，其实没法再通过Snap或Apt来安装Firefox了，而Firefox官网提供的下载，又没有deb包，没有桌面快捷方式，不是非常方便。</p>

<p>所以，你可以考虑使用Mozilla提供的源来安装debian版本的Firefox</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
<span class="c"># 添加Mozilla提供的源</span>
<span class="nb">sudo </span>add-apt-repository ppa:mozillateam/ppa

<span class="c"># 安装Firefox</span>
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>firefox
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="跨ubuntu大版本更新">跨Ubuntu大版本更新</h3>

<p>跨Ubuntu大版本更新，是指从Ubuntu22.04LTS更新到Ubuntu24.04LTS这种大版本更新。</p>

<p>跨Ubuntu大版本更新时，建议恢复snap，等更新完毕后再删掉snap，以防止Canonical公司从中作妖。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c">#删掉禁止安装snap的配置文件</span>
<span class="nb">sudo rm</span> <span class="nt">-rf</span> /etc/apt/preferences.d/nosnap.pref
<span class="nb">sudo </span>apt update

<span class="nb">sudo </span>apt dist-update
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="切换系统语言到中文">切换系统语言到中文</h2>

<p>（实在不喜欢英文的可以切换，以KDE6为例子，其他类似）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image222.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image223.webp" alt="" /></p>

<h2 id="中文输入法">中文输入法</h2>

<h3 id="搜狗不建议ubuntu2204-及-以下">搜狗(不建议）(Ubuntu22.04 <strong>及</strong> 以下)</h3>

<p>官网下载搜狗输入法</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image224.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image225.webp" alt="" /></p>

<p>打开终端输入如下</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> ~/Downloads/
<span class="nb">sudo </span>apt <span class="nb">install</span> ./sogoupinyin_4.2.1.145_amd64.deb
</pre></td></tr></tbody></table></code></pre></div></div>

<p>打开Fcitx</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image226.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image227.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image228.webp" alt="" /></p>

<p>添加搜狗输入法</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image229.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image230.webp" alt="" /></p>

<p>将搜狗输入法设置为唯一输入法</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image231.webp" alt="" /></p>

<h3 id="fcitx5ubuntu2204-及-以上debian12及以上fedora">Fcitx5(Ubuntu22.04 <strong>及</strong> 以上、Debian12及以上、Fedora)</h3>

<ol>
  <li>卸载旧输入法</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
<span class="c"># Ubuntu或者Debian</span>
<span class="nb">sudo </span>apt purge fcitx<span class="k">*</span> ibus<span class="k">*</span>

<span class="c"># Fedora</span>

<span class="c"># 应该不用干任何事，fedora41基本都移除了</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>安装Fcitx5</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>
<span class="c"># Ubuntu22.04及以上、Debian12及以上</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>fcitx5 fcitx5-chinese-addons

<span class="c"># Ubuntu20.04</span>
<span class="nb">sudo </span>add-apt-repository ppa:zhsj/fcitx5
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>fcitx5 fcitx5-chinese-addons

<span class="c"># Fedora</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>fcitx5 fcitx5-chinese-addons fcitx5-autostart
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p>Reboot System重启系统</p>
  </li>
  <li>
    <p>启动Fcitx5</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image232.webp" alt="" /></p>

<ol>
  <li>修改一些设置</li>
</ol>

<p>将Pinyin和Keyboard - English US加入到左边。(如果找不到，不要勾选右边的仅显示当前语言）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image233.webp" alt="" /></p>

<p>添加快捷键以便于更好切换中英文</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image234.webp" alt="" /></p>

<ol>
  <li>如果你是KDE6+Wayland,则还需要下面这个步骤（Kubuntu26.04及以上，Debian13及以上，Rocky10及以上，Fedora等）</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image235.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image236.webp" alt="" /></p>

<ol>
  <li>重启</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>shutdown <span class="nt">-r</span> now
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>使用Fcitx5工具箱优化Fcitx5(进入Github自己看说明书安装)</li>
</ol>

<p>https://github.com/debuggerx01/fcitx5_customizer</p>

<p>```Plain Text</p>

<h1 id="ubuntu">Ubuntu</h1>

<h1 id="直接在线执行工具箱优化">直接在线执行工具箱优化</h1>
<p>curl -sSL https://fcitx5.debuggerx.com/fcitx5_customizer.sh | bash -s – recommend</p>

<h1 id="fedora">Fedora</h1>

<h1 id="直接在线执行工具箱优化-1">直接在线执行工具箱优化</h1>
<p>curl -sSL https://fcitx5.debuggerx.com/fcitx5_customizer.sh | bash -s – recommend</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
9.  再重启

```bash
sudo shutdown -r now
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="pip3源替换">pip3源替换</h2>

<p>非Debian系发行版需要做。</p>

<p>像Ubuntu、Debian这类使用apt工具的发行版不需要此操作。</p>

<p>使用dnf的系统（如Fedora，RHEL，RockyLinux）也可能可以不用做。</p>

<p>https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</p>

<p>按图中顺序敲，但是不出意外的话，会报错，因为大部分发行版不自带pip，所以请接着往下看。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image237.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c">#安装pip3</span>
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>python3-pip

<span class="c">#更新pip3</span>
python3 <span class="nt">-m</span> pip <span class="nb">install</span> <span class="nt">-i</span> https://mirrors.bfsu.edu.cn/pypi/web/simple <span class="nt">--upgrade</span> pip

<span class="c">#设置pip源为北京外国语大学镜像源</span>
pip3 config <span class="nb">set </span>global.index-url https://mirrors.bfsu.edu.cn/pypi/web/simple

<span class="c">#测试</span>
python3 <span class="nt">-m</span> pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
</pre></td></tr></tbody></table></code></pre></div></div>

<p>成功的话，会看到Looking后面是bfsu字样。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image238.webp" alt="" /></p>

<h2 id="rpmfusion安装并换源">RPMFusion安装并换源</h2>

<p><strong>（仅红帽系，即Ubuntu等Debian系的不用弄）</strong></p>

<p>https://mirrors.bfsu.edu.cn/help/rpmfusion/</p>

<ol>
  <li>先用下方命令查询你是否开启了rpmfusion.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rpm <span class="nt">-qa</span> | <span class="nb">grep </span>rpmfusion
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image239.webp" alt="" /></p>

<ol>
  <li>如果开启了的话，就先卸载rpmfusion</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf remove rpmfusion-free-release rpmfusion-nonfree-release
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image240.webp" alt="" /></p>

<ol>
  <li>
    <p>安装北京外国语大学的rpmfusion</p>

    <ol>
      <li>Fedora</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 安装免费仓库非免费仓库</span>
<span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">--nogpgcheck</span> https://mirrors.bfsu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-<span class="si">$(</span>rpm <span class="nt">-E</span> %fedora<span class="si">)</span>.noarch.rpm https://mirrors.bfsu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-<span class="si">$(</span>rpm <span class="nt">-E</span> %fedora<span class="si">)</span>.noarch.rpm
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>RHEL、RockyLinux</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 安装免费仓库非免费仓库</span>
<span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">--nogpgcheck</span> https://mirrors.bfsu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-<span class="si">$(</span>rpm <span class="nt">-E</span> %rhel<span class="si">)</span>.noarch.rpm https://mirrors.bfsu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-<span class="si">$(</span>rpm <span class="nt">-E</span> %rhel<span class="si">)</span>.noarch.rpm
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>把其他rpmfusion仓库也改为bfsu源</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">sudo sed</span> <span class="nt">-e</span> <span class="s1">'s!^metalink=!#metalink=!g'</span> <span class="se">\</span>
         <span class="nt">-e</span> <span class="s1">'s!^mirrorlist=!#mirrorlist=!g'</span> <span class="se">\</span>
         <span class="nt">-e</span> <span class="s1">'s!^#baseurl=!baseurl=!g'</span> <span class="se">\</span>
         <span class="nt">-e</span> <span class="s1">'s!https\?://download1\.rpmfusion\.org/!https://mirrors.bfsu.edu.cn/rpmfusion/!g'</span> <span class="se">\</span>
         <span class="nt">-i</span> /etc/yum.repos.d/rpmfusion<span class="k">*</span>.repo
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>检查修改好的仓库</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">grep</span> <span class="s2">"mirrors.bfsu"</span> /etc/yum.repos.d/rpmfusion<span class="k">*</span>.repo
</pre></td></tr></tbody></table></code></pre></div></div>

<p>可以看到不止free和nonfree的源换了，英伟达和steam也换了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image241.webp" alt="" /></p>

<ol>
  <li>刷新仓库缓存</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf clean all
<span class="nb">sudo </span>dnf makecache
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="时间不同步">时间不同步</h2>

<p>双系统会导致Ubuntu比Windows的时间快8小时，而Windows的时间比Ubuntu慢8小时，所以需要解决系统时间同步的问题。还是第一次分享的那个视频，后面有一节讲到了时间同步的问题。</p>

<p>（ <strong>建议：打开字幕观看，因为有些莫名出现的问题，会在弹幕里有解答</strong> ）</p>

<p>https://www.bilibili.com/video/BV1554y1n7zv/?vd_source=ceb9c29ca8792358f229b53eef0c1448</p>

<h2 id="显卡驱动安装">显卡驱动安装</h2>

<h3 id="卸载显卡驱动卸载干净">卸载显卡驱动(卸载干净)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 如果使用了.run文件进行安装的，再使用下面命令卸载干净</span>
<span class="nb">sudo</span> /usr/bin/nvidia-uninstall

<span class="c"># 如果是使用apt安装的驱动</span>
<span class="nb">sudo </span>apt-get remove <span class="nt">--purge</span> nvidia<span class="k">*</span>

<span class="c"># 如果是使用dnf安装的驱动</span>
<span class="nb">sudo </span>dnf remove nvidia<span class="k">*</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="常见问题遇到问题再翻上来看这里">常见问题（遇到问题再翻上来看这里）</h3>

<ol>
  <li>禁用开源驱动nouveau，nouveau经常会引起卡顿黑屏花屏，所以要禁用</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/modprobe.d/blacklist-nouveau.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>blacklist-nouveau.conf文件内容如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>blacklist nouveau
blacklist lbm-nouveau
options nouveau <span class="nv">modeset</span><span class="o">=</span>0
lias nouveau off
<span class="nb">alias </span>lbm-nouveau off
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接着运行下方命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># debian系选这个（Ubuntu等）</span>
<span class="nb">sudo </span>update-initramfs <span class="nt">-u</span>

<span class="c"># 红帽系选这个（Fedora，Rocky等）</span>
<span class="nb">sudo </span>dracut <span class="nt">--force</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>```Plain Text</p>

<h1 id="重启">重启</h1>
<p>sudo reboot</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
重启后，查询nouveau是否还开着，如果什么都不出现，说明禁用成功。

```bash
lsmod | grep nouveau
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>无法调节屏幕亮度，无法使用HDMI插口(这是因为xorg文件和grub没配置)( <strong>仅X11</strong> ，例如Ubuntu24.04及以下，像Fedora等使用wayland的不能用下方的配置。)</li>
</ol>

<p>先配置xorg</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /usr/share/X11/xorg.conf.d/10-nvidia.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>并把10-nvidia.conf里的内容修改为下方内容并保存，然后重启即可。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>Section <span class="s2">"OutputClass"</span>
   Identifier <span class="s2">"nvidia"</span>
   MatchDriver <span class="s2">"nvidia-drm"</span>
   Driver <span class="s2">"nvidia"</span>
   Option <span class="s2">"AllowEmptyInitialConfiguration"</span>
   Option <span class="s2">"PrimaryGPU"</span> <span class="s2">"yes"</span>
   ModulePath <span class="s2">"/usr/lib/x86_64-linux-gnu/nvidia/xorg"</span>
EndSection

<span class="c"># 或者</span>

Section <span class="s2">"OutputClass"</span> 
    Identifier     <span class="s2">"nvidia"</span> 
    MatchDriver    <span class="s2">"nvidia-drm"</span> 
    Driver         <span class="s2">"nvidia"</span> 
    Option         <span class="s2">"RegistryDwords"</span> <span class="s2">"EnableBrightnessControl=1;PrimaryGPU=1"</span> 
    Option         <span class="s2">"Backlight"</span> <span class="s2">"nvidia_0"</span> 
    ModulePath     <span class="s2">"/usr/lib/x86_64-linux-gnu/nvidia/xorg"</span> 
EndSection
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再配置grub</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/default/grub
</pre></td></tr></tbody></table></code></pre></div></div>

<p>grub参数添加上下面这些参数，注意是添加啊，可不是改为这样，原来的参数要保留。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">"nvidia.NVreg_EnableBacklightControl=1 acpi_backlight=native video.use_native_backlight=0"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image242.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
<span class="c"># debian系选这个（Ubuntu等）</span>
<span class="nb">sudo </span>update-initramfs <span class="nt">-u</span>
<span class="c">#或</span>
<span class="nb">sudo </span>update-grub

<span class="c"># 红帽系选这个（Fedora，Rocky等）</span>
<span class="nb">sudo </span>dracut <span class="nt">--force</span>

<span class="nb">sudo </span>reboot
</pre></td></tr></tbody></table></code></pre></div></div>

<p>重启即可</p>

<ol>
  <li>安装N卡驱动提示错误</li>
</ol>

<p>```Plain Text
Unable to find the kernel source tree for the currently running kernel.  Please make sure you have installed the kernel source files for your kernel and that they are properly configured; on Red Hat Linux systems, for example, be sure you have the ‘kernel-source’ or ‘kernel-devel’ RPM installed.If you know the correct kernel source files are installed, you may specify the kernel source path with the ‘–kernel-source-path’ command line option.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
1.  检查当前运行的内核版本：

运行以下命令以查看你当前正在使用的内核版本：

```bash
uname -r
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>安装内核开发文件：</li>
</ol>

<p>确保你已经安装了与当前内核版本相匹配的 <code class="language-plaintext highlighter-rouge">kernel-devel</code> 包。运行以下命令来安装：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install </span>kernel-devel-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这将自动安装与你当前内核版本匹配的内核开发包。</p>

<ol>
  <li>安装内核源代码（可选）：</li>
</ol>

<p>如果需要访问完整的内核源代码，你可以运行以下命令来安装它：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install </span>kernel-headers kernel-source
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>检查安装：</li>
</ol>

<p>安装完成后，确认路径是否正确。内核源文件通常位于 <code class="language-plaintext highlighter-rouge">/usr/src/kernels/</code> 目录下，你可以使用以下命令来检查该目录是否存在：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">ls</span> /usr/src/kernels/
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果仍然遇到问题，可以通过 <code class="language-plaintext highlighter-rouge">--kernel-source-path</code> 选项手动指定内核源文件路径。</p>

<h3 id="安装方式推荐">安装方式推荐</h3>

<p>下面有三个方式安装驱动，教程基本都写了，分别是通用方式，APT方式，DNF方式。</p>

<p>新手建议使用APT方式（Ubuntu或者Debian）或者DNF方式（Fedora或者RockyLinux）安装 <strong>NVIDIA驱动</strong> ，然后CUDA用通用方式安装，CUDNN依然用APT或者DNF方式安装。</p>

<p><strong>（你是新手的话，老老实实按照下方的表格推荐的方式进行安装，别瞎整活）</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">各发行版推荐使用的方式</th>
      <th> </th>
      <th> </th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"> </td>
      <td>Ubuntu</td>
      <td>Debian</td>
      <td>Fedora</td>
      <td>RockyLinux</td>
    </tr>
    <tr>
      <td style="text-align: left">NVIDIA驱动</td>
      <td>APT</td>
      <td>APT</td>
      <td>DNF</td>
      <td>DNF</td>
    </tr>
    <tr>
      <td style="text-align: left">CUDA</td>
      <td>通用或APT</td>
      <td>通用或APT</td>
      <td>通用或DNF</td>
      <td>通用或DNF</td>
    </tr>
    <tr>
      <td style="text-align: left">cuDNN</td>
      <td>APT</td>
      <td>APT</td>
      <td>DNF</td>
      <td>DNF</td>
    </tr>
  </tbody>
</table>

<h3 id="apt安装方式一适合debianubuntu等">APT安装（方式一：适合Debian,Ubuntu等）</h3>

<h4 id="安装显卡驱动">安装显卡驱动</h4>

<p>这种方式安装的显卡驱动，以后更新内核后都不用再重新安装显卡驱动了。</p>

<h5 id="ubuntu-1">Ubuntu</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 安装英伟达驱动</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>nvidia-driver-版本号

<span class="c"># 重启 (必须重启)</span>
<span class="nb">sudo </span>shutdown <span class="nt">-r</span> now

<span class="c"># 检查驱动是否安装成功</span>
nvidia-smi
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="debian">Debian</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="c"># 安装内核头文件和编译工具</span>
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> linux-headers-amd64 build-essential

<span class="c"># 安装英伟达驱动</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>nvidia-driver

<span class="c"># 重启</span>
<span class="nb">sudo </span>shutdown <span class="nt">-r</span> now

<span class="c"># 检查驱动是否安装成功</span>
nvidia-smi
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="安装cuda">安装CUDA</h4>

<p>（请使用方式一通用法）</p>

<h4 id="安装cudnn">安装cuDNN</h4>

<p>选择CuDNN v9版本（该版本安装和CUDA差不多，可以看着官网教程来安装）</p>

<p>https://developer.nvidia.com/cudnn-archive</p>

<h3 id="dnf安装方式二适合fedorarocky等">DNF安装（方式二：适合Fedora,Rocky等）</h3>

<h4 id="安装显卡驱动-1">安装显卡驱动</h4>

<p>如果我们使用通用方式安装显卡驱动，会发现每次Feodra更新内核后，显卡驱动都会掉，如何解决这个办法呢？请采用DNF安装显卡驱动。</p>

<p>这种方式安装的显卡驱动，以后更新内核后都不用再重新安装显卡驱动了。（安装新内核后，重启时会自动触发 <code class="language-plaintext highlighter-rouge">akmod</code> 的构建流程。此时，系统会生成与新内核匹配的 NVIDIA 驱动模块。）</p>

<p>注意，安装驱动之前，要确定自己没用.run等方式安装了驱动。可以用nvidia-smi命令查看，如果提示没安装驱动就可以。如果提示当前已经安装了驱动，请先卸载驱动(卸载教程上面应该有）或者等下一次内核更新(内核更新会掉.run安装的驱动）</p>

<h5 id="fedora-1">Fedora</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>
<span class="c"># 启用 RPM Fusion 仓库（北京外国语源）</span>
<span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">--nogpgcheck</span> https://mirrors.bfsu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-<span class="si">$(</span>rpm <span class="nt">-E</span> %fedora<span class="si">)</span>.noarch.rpm https://mirrors.bfsu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-<span class="si">$(</span>rpm <span class="nt">-E</span> %fedora<span class="si">)</span>.noarch.rpm

<span class="c"># 安装驱动和内核工具</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>akmod-nvidia  <span class="c"># 自动适配内核的驱动（重点）</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>xorg-x11-drv-nvidia-cuda  <span class="c"># 包含 CUDA 支持</span>

<span class="c"># 重启并验证(这种方式必须重启)</span>
<span class="nb">sudo </span>reboot
nvidia-smi  <span class="c"># 检查驱动版本（如 570.86.16）</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="安装cuda-1">安装CUDA</h4>

<p>通过dnf安装完显卡驱动后，也可以使用通用法安装CUDA，这种方法也很方便（CUDA在更新内核后不会掉的）。</p>

<p>也可以使用下面这种dnf的方式进行CUDA安装。</p>

<p>（此教程以Fedora41和RTX3060Laptop为例）(Rocky,RHEL也类似)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image243.webp" alt="" /></p>

<ol>
  <li>先查看显卡驱动所支持的最高CUDA版本</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nvidia-smi
</pre></td></tr></tbody></table></code></pre></div></div>

<p>左边是英伟达驱动版本，右边是所支持CUDA的最高版本，注意是最高版本，比这个版本低的CUDA都是可以安装的。(不用追求最高，稳定即可，虽然都很稳定)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image244.webp" alt="" /></p>

<ol>
  <li>下载CUDA并安装CUDA</li>
</ol>

<p>https://developer.nvidia.com/cuda-toolkit-archive</p>

<p>选择一个版本，这里以CUDA12.4为例（绿色框住的都是我这台电脑对应可安装的版本，而红色框则不能）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image245.webp" alt="" /></p>

<p>我这里是Intel CPU(X86_64架构或者叫amd64架构)，所以选择X86_64。（AMD和Intel全是X86的，如果分不清，请看<a href="https://sdutvincirobot.feishu.cn/wiki/PqsGwcPCuidbN6k13jfcGWtWn0b">Vinci机器人队单片机教程</a>）</p>

<p>我是Fedora41，所以选择了Fedora41 ,(你是RockyLinux要选择RockyLinux)如下图所示:</p>

<p>https://developer.nvidia.com/cuda-toolkit-archive</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image246.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image247.webp" alt="" /></p>

<p>按照网站对应的部分敲，如我上图里是这样的：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>wget https://developer.download.nvidia.com/compute/cuda/12.8.0/local_installers/cuda-repo-fedora41-12-8-local-12.8.0_570.86.10-1.x86_64.rpm
<span class="nb">sudo </span>dnf <span class="nb">install</span> ./cuda-repo-fedora41-12-8-local-12.8.0_570.86.10-1.x86_64.rpm
<span class="nb">sudo </span>dnf clean all
<span class="nb">sudo </span>dnf <span class="nt">-y</span> <span class="nb">install </span>cuda-toolkit-12-8
</pre></td></tr></tbody></table></code></pre></div></div>

<p>进行环境配置：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>复制下面这一串到~/.bashrc文件中，并保存，不会用vim编辑器的请自行百度。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/cuda-12.4/bin:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/cuda-12.4/lib64:<span class="nv">$LD_LIBRARY_PATH</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>或者（更建议下方这个）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/cuda/bin:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/cuda/lib64:<span class="nv">$LD_LIBRARY_PATH</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image248.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 刷新当前终端的环境变量</span>
<span class="nb">source</span> ~/.bashrc

<span class="c"># 验证CUDA是否安装成功</span>
nvcc <span class="nt">-V</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>出现下图这种则安装成功。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image249.webp" alt="" /></p>

<h4 id="安装cudnn-1">安装cuDNN</h4>

<p>选择CuDNN v9版本（该版本安装和CUDA差不多，可以看着官网教程来安装）</p>

<p>https://developer.nvidia.com/cudnn-archive</p>

<h3 id="通用方式方式三脚本或压缩包方式">通用方式（方式三：脚本或压缩包方式）</h3>

<p>遇到问题请看 <strong>常见问题</strong> 那节，看看有没有对应解决方案。（对于Ubuntu，Debian，Fedora，Rocky的常见问题应该是全的）</p>

<h4 id="安装显卡驱动-2">安装显卡驱动</h4>

<p>使用这种方式安装，需要先禁用掉nouveau，请先往下翻，找到<strong>常见问题（在上面一两小节）</strong>那节内容里的禁用nouveau，将nouveau禁用。</p>

<p>先下载N卡驱动，下载.run扩展名的</p>

<p>https://www.nvidia.cn/drivers/lookup/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image250.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image251.webp" alt="" /></p>

<p>用以下命令停止可视化桌面环境（用ctrl alt f*也可以）<strong><em>（也可以不禁用桌面环境，直接进行下一步。）</em></strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 通用的命令（sudo telinit 5是打开图形界面）</span>
<span class="nb">sudo </span>telinit 3

<span class="c"># ubuntu 使用下方命令</span>
<span class="nb">sudo </span>service lightdm stop

<span class="c"># Fedora 使用下方命令</span>
<span class="nb">sudo </span>systemctl isolate multi-user.target
</pre></td></tr></tbody></table></code></pre></div></div>

<p>之后会进入一个新的命令行会话，使用当前的用户名密码登录。(不用使用root用户)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
<span class="c"># 编译环境+准备工作</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>build-essential

<span class="c"># 进入到.run目录中</span>
<span class="nb">cd</span> /home/tungchiahui/Downloads/

<span class="c"># 给驱动文件增加可执行权限：</span>
<span class="nb">sudo chmod </span>a+x NVIDIA-Linux-x86_64-550.107.02.run

<span class="c"># 然后执行安装：</span>
<span class="nb">sudo</span> ./NVIDIA-Linux-x86_64-550.107.02.run

<span class="c"># 如果有异常则：(一般不用下方这条，会导致OPENGL没法被安装，这样ROS有些功能无法使用)</span>
<span class="nb">sudo</span> ./NVIDIA-Linux-x86_64-550.107.02.run  <span class="nt">--no-opengl-files</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装完毕重启即可</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 重启 </span>
<span class="nb">sudo </span>reboot

<span class="c"># 检查驱动是否安装成功</span>
nvidia-smi
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="安装cuda-2">安装CUDA</h4>

<p>（此教程以Debian 12 Bookworm和RTX3060Laptop为例）(Ubuntu，Fedora也类似)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image252.webp" alt="" /></p>

<ol>
  <li>先查看显卡驱动所支持的最高CUDA版本</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nvidia-smi
</pre></td></tr></tbody></table></code></pre></div></div>

<p>左边是英伟达驱动版本，右边是所支持CUDA的最高版本，注意是最高版本，比这个版本低的CUDA都是可以安装的。(不用追求最高，稳定即可，虽然都很稳定)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image253.webp" alt="" /></p>

<ol>
  <li>下载CUDA并安装CUDA</li>
</ol>

<p>https://developer.nvidia.com/cuda-toolkit-archive</p>

<p>选择一个版本，这里以CUDA12.4为例（绿色框住的都是我这台电脑对应可安装的版本，而红色框则不能）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image254.webp" alt="" /></p>

<p>我这里是Intel CPU(X86_64架构或者叫amd64架构)，所以选择X86_64。（AMD和Intel全是X86的，如果分不清，请看<a href="https://sdutvincirobot.feishu.cn/wiki/PqsGwcPCuidbN6k13jfcGWtWn0b">Vinci机器人队单片机教程</a>）</p>

<p>我是Debian12，所以选择了Debian12 ,(你是Ubuntu要选择Ubuntu)如下图所示，建议选择runfile文件进行安装。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image255.webp" alt="" /></p>

<p>将最下方框框里的命令敲入终端</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
<span class="c"># 在当前文件夹下创建一个ttt的子文件夹</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> ./ttt

<span class="c"># 进入ttt文件夹</span>
<span class="nb">cd </span>ttt

<span class="c"># 输入复制的第一条命令（用来下载cuda的runfile文件）</span>
wget https://developer.download.nvidia.com/compute/cuda/12.4.0/local_installers/cuda_12.4.0_550.54.14_linux.run

<span class="c"># 给予权限</span>
<span class="nb">sudo chmod </span>a+x ./cuda_12.4.0_550.54.14_linux.run

<span class="c"># 运行脚本</span>
<span class="nb">sudo</span> ./cuda_12.4.0_550.54.14_linux.run
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image256.webp" alt="" /></p>

<p>正在加载中：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image257.webp" alt="" /></p>

<p>输入accept接受即可</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image258.webp" alt="" /></p>

<p>因为我们已经安装了驱动，所以删掉该项，Install即可。（ <strong>一定不要勾选安装驱动</strong> ，新手避免非必要的麻烦）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image259.webp" alt="" /></p>

<p>等待片刻后，一般不出红色字体就是安装成功了，可以读读英语确认一下。(顺便确定一下位置)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image260.webp" alt="" /></p>

<ol>
  <li>配置环境</li>
</ol>

<p>根据上方确认一下路径，比如我上面红色框起来的为</p>

<p><code class="language-plaintext highlighter-rouge">Please make sure that</code> <code class="language-plaintext highlighter-rouge">- PATH includes /usr/local/cuda-12.4/bin</code> <code class="language-plaintext highlighter-rouge">- LD_LIBRARY_PATH includes /usr/local/cuda-12.4/lib64, or, add /usr/local/cuda-12.4/lib64 to /etc/ld.so.conf and run ldconfig as root</code></p>

<p>如果刚才忘记查看了，也可以使用下方命令查看路径：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>which nvcc
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image261.webp" alt="" /></p>

<p>所以我进行以下操作：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>复制下面这一串到~/.bashrc文件中，并保存，不会用vim编辑器的请自行百度。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/cuda-12.4/bin:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/cuda-12.4/lib64:<span class="nv">$LD_LIBRARY_PATH</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>或者</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/cuda/bin:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/cuda/lib64:<span class="nv">$LD_LIBRARY_PATH</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image262.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 刷新当前终端的环境变量</span>
<span class="nb">source</span> ~/.bashrc

<span class="c"># 验证CUDA是否安装成功</span>
nvcc <span class="nt">-V</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>出现下图这种则安装成功。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image263.webp" alt="" /></p>

<h4 id="安装cudnn基本废弃请往下看apt和dnf安装cudnn的方式">安装cuDNN<strong>（基本废弃，请往下看apt和dnf安装CuDNN的方式）</strong></h4>

<ol>
  <li>据安装好的CUDA版本选择合适的cuDNN版本进行下载，注意这里是需要注册登录的：</li>
</ol>

<p>https://developer.nvidia.cn/rdp/cudnn-archive#a-collapse805-111</p>

<p>因为我是CUDA12.4，所以下方红圈版本都是可以安装的，越新越好。（上方网站最高版本也就v8.9.7,还有更新的版本，可以直接往下看apt和dnf方式安装）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image264.webp" alt="" /></p>

<p>红色是X86架构的所有Linux通用的，所以我选择红色的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image265.webp" alt="" /></p>

<p>绿色的是X86架构的Ubuntu，是Ubuntu且CPU为X86架构的可以选择下载。</p>

<p>蓝色的是arm64(aarch64)架构的Ubuntu，是Ubuntu且CPU为arm64(aarch64)架构的可以选择下载。</p>

<p><strong>我这里选择所有Linux X86_64最通用的办法：</strong></p>

<p>下载好的：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image266.webp" alt="" /></p>

<ol>
  <li>安装cuDNN</li>
</ol>

<p>找到该文件所在目录，并打开终端，cd到该目录。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image267.webp" alt="" /></p>

<p>解压文件，并复制到对应位置完成安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>
<span class="c"># 解压cuDNN文件</span>
<span class="nb">tar</span> <span class="nt">-xvf</span> ./cudnn-linux-x86_64-8.9.7.29_cuda12-archive.tar.xz

<span class="c"># cd进文件夹</span>
<span class="nb">cd</span> ./cudnn-linux-x86_64-8.9.7.29_cuda12-archive

<span class="c"># 复制cuDNN文件到CUDA目录</span>
<span class="nb">sudo cp </span>include/cudnn<span class="k">*</span>    /usr/local/cuda/include
<span class="nb">sudo cp </span>lib/libcudnn<span class="k">*</span>    /usr/local/cuda/lib64

<span class="c"># 对比一下有没有缺文件</span>
<span class="nb">ls</span> /usr/local/cuda/include/cudnn<span class="k">*</span>
<span class="nb">ls</span> /usr/local/cuda/lib64/libcudnn<span class="k">*</span>

<span class="c"># 给予权限</span>
<span class="nb">sudo chmod </span>a+r /usr/local/cuda/include/cudnn<span class="k">*</span>
<span class="nb">sudo chmod </span>a+r /usr/local/cuda/lib64/libcudnn<span class="k">*</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>检查是否安装成功</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 检查cuDNN版本命令</span>
<span class="nb">cat</span> /usr/local/cuda/include/cudnn_version.h | <span class="nb">grep </span>CUDNN_MAJOR <span class="nt">-A</span> 2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>出现下图这样的就是安装成功了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image268.webp" alt="" /></p>

<ol>
  <li>软链接</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 运行 ldconfig 以更新库缓存：（如果运行 ldconfig 后没有出现任何错误，说明配置已经完成。）</span>
<span class="nb">sudo </span>ldconfig
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果出现下列提示，则需要软链接<strong>(如果没有下列提示，则什么都不需要做)</strong></p>

<p>```Plain Text
ldconfig: /usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudnn_cnn_train.so.8 is not a symbolic link<br />
ldconfig: /usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudnn_ops_train.so.8 is not a symbolic link<br />
ldconfig: /usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudnn_ops_infer.so.8 is not a symbolic link<br />
ldconfig: /usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudnn_adv_infer.so.8 is not a symbolic link<br />
ldconfig: /usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudnn_cnn_infer.so.8 is not a symbolic link<br />
ldconfig: /usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudnn.so.8 is not a symbolic link<br />
ldconfig: /usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudnn_adv_train.so.8 is not a symbolic link</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
运行下方的命令

```bash

# cd进入CUDA路径
cd /usr/local/cuda/targets/x86_64-linux/lib

 # 查看本路径下的需要软链接的文件名
 ls
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image269.webp" alt="" /></p>

<p>如上图，我需要将<code class="language-plaintext highlighter-rouge">libcudnn_xxx_xxxxx.so.8.9.7</code>和<code class="language-plaintext highlighter-rouge">libcudnn_xxx_xxxxx.so.8</code>和<code class="language-plaintext highlighter-rouge">libcudnn_xxx_xxxxx.so</code>软链接</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
<span class="c"># 创建符号链接。对于每个 .so.8 文件，需要创建一个指向该文件的符号链接，通常链接的名称是不包含 .8 的文件名。</span>
<span class="nb">sudo ln</span> <span class="nt">-sf</span> libcudnn_cnn_train.so.8.9.7 libcudnn_cnn_train.so.8
<span class="nb">sudo ln</span> <span class="nt">-sf</span> libcudnn_adv_infer.so.8.9.7 libcudnn_adv_infer.so.8
<span class="nb">sudo ln</span> <span class="nt">-sf</span> libcudnn_adv_train.so.8.9.7 libcudnn_adv_train.so.8
<span class="nb">sudo ln</span> <span class="nt">-sf</span> libcudnn_cnn_infer.so.8.9.7 libcudnn_cnn_infer.so.8
<span class="nb">sudo ln</span> <span class="nt">-sf</span> libcudnn.so.8.9.7 libcudnn.so.8
<span class="nb">sudo ln</span> <span class="nt">-sf</span> libcudnn_ops_infer.so.8.9.7 libcudnn_ops_infer.so.8
<span class="nb">sudo ln</span> <span class="nt">-sf</span> libcudnn_ops_train.so.8.9.7 libcudnn_ops_train.so.8

<span class="c"># 运行 ldconfig 以更新库缓存：（如果运行 ldconfig 后没有出现任何提示，说明配置已经完成。）</span>
<span class="nb">sudo </span>ldconfig

<span class="c"># 使用 ls -l 来确认符号链接是否创建成功：(再次确认链接）</span>
<span class="nb">ls</span> <span class="nt">-l</span> /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_<span class="k">*</span>.so<span class="k">*</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="命令教程长期积累">命令教程(长期积累)</h1>

<h2 id="大多数命令">大多数命令</h2>

<p>https://www.runoob.com/linux/linux-tutorial.html</p>

<h2 id="包管理工具命令">包管理工具命令</h2>

<p>常见的有apt,dnf,yum,pacman,pkcon等等。</p>

<h2 id="kde-dolphin-以root打开">KDE Dolphin 以root打开</h2>

<p>kde5</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>pkexec <span class="nb">env </span><span class="nv">DISPLAY</span><span class="o">=</span><span class="nv">$DISPLAY</span> <span class="nv">XAUTHORITY</span><span class="o">=</span><span class="nv">$XAUTHORITY</span> <span class="nv">KDE_SESSION_VERSION</span><span class="o">=</span>5 <span class="nv">KDE_FULL_SESSION</span><span class="o">=</span><span class="nb">true </span>dolphin
</pre></td></tr></tbody></table></code></pre></div></div>

<p>kde6</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>pkexec <span class="nb">env </span><span class="nv">DISPLAY</span><span class="o">=</span><span class="nv">$DISPLAY</span> <span class="nv">XAUTHORITY</span><span class="o">=</span><span class="nv">$XAUTHORITY</span> <span class="nv">KDE_SESSION_VERSION</span><span class="o">=</span>6 <span class="nv">KDE_FULL_SESSION</span><span class="o">=</span><span class="nb">true </span>dolphin
</pre></td></tr></tbody></table></code></pre></div></div>

<p>kde6.3.3及以上</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image270.webp" alt="" /></p>

<p>直接图形化就可以了。</p>

<h1 id="各种环境配置">各种环境配置</h1>

<p><a href="https://sdutvincirobot.feishu.cn/wiki/FQszwXIR5iQgCfk7pRwc9rYpnqg">电控组环境搭建大全</a></p>

<h1 id="其他可选配置">其他可选配置</h1>

<p>根据自己是否有需求再选择对应的功能进行配置</p>

<h2 id="kde的wayland和x11互相切换">KDE的Wayland和X11互相切换</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># Ubuntu</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>plasma-workspace-x11 plasma-workspace-wayland

<span class="c"># Fedora，Rocky</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>plasma-workspace-x11 plasma-workspace-wayland
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后重启，在kde的登陆界面的左下角可以选择X11还是Wayland！</p>

<h2 id="修改dns">修改DNS</h2>

<p>使用 NetworkManager（最推荐，适用于大多数现代发行版）这是最灵活的方法，NetworkManager 是 Ubuntu、Fedora、CentOS 等大多数主流发行版的默认网络管理工具。</p>

<ol>
  <li>修改全局配置文件（对所有连接生效）：创建或编辑 <code class="language-plaintext highlighter-rouge">/etc/NetworkManager/conf.d/dns.conf</code>文件：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/NetworkManager/conf.d/dns.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>添加以下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="o">[</span>main]dns<span class="o">=</span>none
systemd-resolved<span class="o">=</span>falserc-manager<span class="o">=</span>unmanaged
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这告诉 NetworkManager 不要管理 DNS 设置。</p>

<ol>
  <li>创建静态 resolv.conf 文件：编辑 <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code>文件（如果文件不存在则创建）：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/resolv.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>添加您想要的 DNS 服务器，例如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>nameserver 223.5.5.5
nameserver 119.29.29.29
options <span class="nb">timeout</span>:1 attempts:2
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>防止文件被覆盖：为防止系统其他服务覆盖此文件，将其设置为不可更改：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>chattr +i /etc/resolv.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（如需修改此文件，先使用 <code class="language-plaintext highlighter-rouge">sudo chattr -i /etc/resolv.conf</code>解除锁定）</p>

<p>重启 NetworkManager：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart NetworkManager
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>使用 <code class="language-plaintext highlighter-rouge">resolvectl</code>或 <code class="language-plaintext highlighter-rouge">systemd-resolve</code>查看是否成功（最推荐）</li>
</ol>

<p>这是最直接的方法，可以查看系统默认的 DNS 配置。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>resolvectl status
</pre></td></tr></tbody></table></code></pre></div></div>

<p>或者（对于旧版系统）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>systemd-resolve <span class="nt">--status</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image271.webp" alt="" /></p>

<h2 id="截图快捷键">截图快捷键</h2>

<p>KDE自带的截图工具贼好用，同时这个截图工具同样可以录屏，但是OBS比截图工具更加专业，所以我们一般只用这个截图工具进行截图。</p>

<p>QQ和微信的截图在Wayland下截至2025年还都有些小问题，所以我们选择KDE自带的截图工具。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image272.webp" alt="" /></p>

<p>这里在捕获矩形区域的自定义快捷键在这里输入自己想用的快捷键即可。</p>

<h2 id="搜索工具">搜索工具</h2>

<p>KDE自带的搜索工具也很好用，可以快速打开自己想打开的应用。就像这样，所以我们也设置一个快捷键进行呼出。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image273.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image274.webp" alt="" /></p>

<p>Meta这个按键就是Win键，上面是一个微软LOGO。</p>

<h2 id="关闭selinux">关闭SELinux</h2>

<p>这玩意在个人电脑没必要开，纯给自己找麻烦，Android倒是可以开。</p>

<p>这个目前Feodra是默认开的（<code class="language-plaintext highlighter-rouge">enforcing</code>模式），所以需要关一下。</p>

<p>禁用有俩方式，<code class="language-plaintext highlighter-rouge">disabled</code>和<code class="language-plaintext highlighter-rouge">permissive</code>模式，下面是这俩模式的区别：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">特性</th>
      <th style="text-align: left">Disabled 模式</th>
      <th style="text-align: left">Permissive 模式</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">SELinux 内核模块状态</td>
      <td style="text-align: left">完全禁用 SELinux，内核模块不运行137。</td>
      <td style="text-align: left">SELinux 内核模块正常运行，但仅记录违规行为，不阻止访问126。</td>
    </tr>
    <tr>
      <td style="text-align: left">访问控制策略</td>
      <td style="text-align: left">不执行任何策略，所有访问均被允许29。</td>
      <td style="text-align: left">检查策略并记录违规行为，但不会阻止操作36。</td>
    </tr>
    <tr>
      <td style="text-align: left">日志记录</td>
      <td style="text-align: left">不生成 SELinux 相关的审计日志37。</td>
      <td style="text-align: left">记录所有违反策略的行为到 /var/log/audit/audit.log26。</td>
    </tr>
    <tr>
      <td style="text-align: left">安全性</td>
      <td style="text-align: left">最低，完全依赖传统 Linux DAC（自主访问控制）28。</td>
      <td style="text-align: left">高于 Disabled 模式，提供调试环境，同时保留日志分析能力36。</td>
    </tr>
    <tr>
      <td style="text-align: left">切换方式</td>
      <td style="text-align: left">必须修改配置文件 /etc/selinux/config 并重启系统34。</td>
      <td style="text-align: left">可通过命令 setenforce 0 临时切换，无需重启34。</td>
    </tr>
    <tr>
      <td style="text-align: left">适用场景</td>
      <td style="text-align: left">仅用于彻底规避 SELinux 兼容性问题（如老旧软件），不推荐长期使用19。</td>
      <td style="text-align: left">用于调试策略、排查权限问题，或在开发阶段测试 SELinux 规则367。</td>
    </tr>
  </tbody>
</table>

<p>由于Disabled模式，SELinux 完全关闭，内核模块未加载。所有进程和文件的访问仅受传统 Linux 用户/组权限控制（如 <code class="language-plaintext highlighter-rouge">rwx</code>），所以我们选择Permissive模式，该模式下SELinux 策略正常加载，但仅记录违规行为（如进程尝试访问未授权文件）。</p>

<p>下面是修改模式的教程：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/selinux/config
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image275.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image276.webp" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre>
<span class="c1"># This file controls the state of SELinux on the system. </span>

<span class="c1"># SELINUX= can take one of these three values: </span>

<span class="c1">#     enforcing - SELinux security policy is enforced. </span>

<span class="c1">#     permissive - SELinux prints warnings instead of enforcing. </span>

<span class="c1">#     disabled - No SELinux policy is loaded. </span>

<span class="c1"># See also: </span>

<span class="c1"># https://docs.fedoraproject.org/en-US/quick-docs/getting-started-with-selinux/#getting-started-with-selinux-selinux-states-and-modes </span>
<span class="c1"># </span>

<span class="c1"># NOTE: In earlier Fedora kernel builds, SELINUX=disabled would also </span>

<span class="c1"># fully disable SELinux during boot. If you need a system with SELinux </span>

<span class="c1"># fully disabled instead of SELinux running with no policy loaded, you </span>

<span class="c1"># need to pass selinux=0 to the kernel command line. You can use grubby </span>

<span class="c1"># to persistently set the bootloader to boot with selinux=0: </span>
<span class="c1"># </span>

<span class="c1">#    grubby --update-kernel ALL --args selinux=0 </span>
<span class="c1"># </span>

<span class="c1"># To revert back to SELinux enabled: </span>
<span class="c1"># </span>

<span class="c1">#    grubby --update-kernel ALL --remove-args selinux </span>
<span class="c1"># </span>
<span class="s">SELINUX=permissive</span> 

<span class="c1"># SELINUXTYPE= can take one of these three values: </span>

<span class="c1">#     targeted - Targeted processes are protected, </span>

<span class="c1">#     minimum - Modification of targeted policy. Only selected processes are protected. </span>

<span class="c1">#     mls - Multi Level Security protection. </span>
<span class="s">SELINUXTYPE=targeted</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">SELINUXTYPE</code>是修改selinux的策略，<code class="language-plaintext highlighter-rouge">targeted</code> 策略是 SELinux 的 默认策略，主要对 高风险的网络服务（如 Apache、MySQL、SSH）进行强制访问控制，其他非关键进程沿用传统的 Linux 用户/组权限（DAC）。这种设计在安全性和易用性之间取得了平衡,所以无需修改。</p>

<p>重启即可</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>reboot
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="uefi启动界面refind">UEFI启动界面rEFInd</h2>

<p>https://www.bilibili.com/video/BV1qh411Q7d4</p>

<h3 id="安装refind">安装rEFInd</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># Ubuntu</span>
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>refind
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># Fedora</span>
<span class="nb">sudo </span>dnf makecache
<span class="nb">sudo </span>dnf <span class="nb">install </span>rEFInd
</pre></td></tr></tbody></table></code></pre></div></div>

<p>注：如果安装了三系统，尽量把refind安装到Linux盘的第一个系统上。</p>

<h3 id="确认refind是否安装成功">确认refind是否安装成功</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image277.webp" alt="" /></p>

<p>如图在/boot/efi/EFI文件夹里，有个refind.</p>

<p>如果你没有这个refind文件的话，需要手动进行安装。</p>

<p>手动安装方式一：</p>

<p>找到<code class="language-plaintext highlighter-rouge">/usr/share/rEFInd/</code>文件夹，看看里面是否有refind-install,直接运行下方命令即可。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> /usr/share/rEFInd/
<span class="nb">sudo</span> ./refind-install
<span class="nb">sudo </span>reboot
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image278.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image279.webp" alt="" /></p>

<p>手动安装方式二：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> /usr/share/rEFInd/
<span class="nb">sudo cp</span> <span class="nt">-r</span> /usr/share/rEFInd/refind /boot/efi/EFI/
<span class="nb">sudo </span>reboot
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装完毕后，可以看看/boot/efi/EFI文件夹里，是否有refind了.</p>

<h3 id="配置-refindconf">配置 refind.conf</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> /boot/efi/EFI/refind
<span class="nb">sudo </span>vim ./refind.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最后一行加上（vim编辑器不会用自己百度）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>dont_scan_dirs ESP:/EFI/boot,EFI/ubuntu,EFI/boot,EFI/deepin_os,EFI/UOS,EFI/fedora
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image280.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>sduo reboot
<span class="c">#如果使用refind-install安装的refind,默认自动将rEFInd启动项作为第一项，如果没有进BIOS手动配置</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image281.webp" alt="" /></p>

<p>完成！！！</p>

<h3 id="美化">美化</h3>

<p>rEFInd-glassy主题：https://pan.baidu.com/s/1HgfXG3m4j57VIk4k6inI-g</p>

<p>提取码：zimo</p>

<p>记得解压出来。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> /boot/efi/EFI/refind
<span class="nb">mkdir</span> <span class="nt">-p</span> ./themes

<span class="c"># 你把美化包解压到哪里了，就cd到哪里</span>
<span class="nb">cd</span> ~/Downloads
<span class="nb">sudo cp</span> <span class="nt">-r</span> ./rEFInd-glassy /boot/efi/EFI/refind/themes
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> /boot/efi/EFI/refind
<span class="nb">sudo </span>vim ./refind.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最后一行加上（vim编辑器不会用自己百度）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>include themes/rEFInd-glassy/theme.conf
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 重新启动电脑</span>
<span class="nb">sudo </span>reboot
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image282.webp" alt="" /></p>

<h2 id="kde主题">KDE主题</h2>

<p>先从kde store下载一个心仪的主题，然后解压出来。</p>

<p>https://store.kde.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image283.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># cd进主题的文件夹</span>
<span class="nb">cd</span> ~/Downloads

<span class="c"># 把主题文件复制到KDE的主题</span>
<span class="nb">sudo cp</span> <span class="nt">-r</span> ./Apple.BigSur.Dark.P6 /usr/share/plasma/look-and-feel
</pre></td></tr></tbody></table></code></pre></div></div>

<p>进入设置就可以看到啦，如果看不到，就重启下电脑。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image284.webp" alt="" /></p>

<h2 id="自启应用与脚本">自启应用与脚本</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image285.webp" alt="" /></p>

<p>在右上角可以添加脚本和应用，添加脚本前先要确认脚本是否拥有可执行权限。也可以选择开机时运行脚本和关机时运行脚本。</p>

<p>例子：拿docker_x11的命令<code class="language-plaintext highlighter-rouge">xhost +local:docker</code>为例。</p>

<p>先找到一个存放脚本的文件夹，你自己在home分区创一个就可以了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image286.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">touch </span>docker_x11.bash
<span class="nb">sudo chmod </span>a+x ./docker_x11.bash
<span class="nb">sudo </span>vim ./docker_x11.bash
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="c"># 等待 X Server 就绪（最多等 10 秒）</span>
<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$DISPLAY</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> xset q <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then</span>
        /usr/bin/xhost +local:docker
        <span class="nb">exit </span>0
    <span class="k">fi
    </span><span class="nb">sleep </span>1
<span class="k">done</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在vim编辑器里用<code class="language-plaintext highlighter-rouge">:wq</code>保存并退出</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image287.webp" alt="" /></p>

<p>在kde6设置里找到autostart，然后添加登陆脚本，而不是登出脚本。</p>

<p>🟢 <strong>Login Script（登录脚本）</strong></p>

<ul>
  <li><strong>什么时候执行？</strong> 当用户登录系统时（例如通过终端、TTY 或 SSH）自动执行。</li>
</ul>

<p>🔴 <strong>Logout Script（登出脚本）</strong></p>

<ul>
  <li><strong>什么时候执行？</strong> 当用户退出 shell 或注销登录会话时自动执行。</li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image288.webp" alt="" /></p>

<p>找到脚本文件添加进去即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image289.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image290.webp" alt="" /></p>

<p>重启即可</p>

<h2 id="从bash切换到zsh">从Bash切换到Zsh</h2>

<h3 id="什么是shell">什么是shell？</h3>

<p>简单说，shell是你与应用程序交互的媒介。 通常情况下，你将你想要使用的应用程序和参数输入到shell，shell在PATH中查找你希望调用的应用程序，对参数进行解析，并传入参数。最终将结果返回给你。</p>

<p>如果你使用的是bash shell，那么你大概率正在使用某个linux发行版。 目前，大部分<code class="language-plaintext highlighter-rouge">linux</code>发行版使用的默认shell仍然是<code class="language-plaintext highlighter-rouge">bash</code>。 <code class="language-plaintext highlighter-rouge">Windows</code>默认使用<code class="language-plaintext highlighter-rouge">Powershell</code>。 从<code class="language-plaintext highlighter-rouge">Catalina</code>开始，<code class="language-plaintext highlighter-rouge">MacOS</code>已经将默认shell从<code class="language-plaintext highlighter-rouge">bash</code>切换到了<code class="language-plaintext highlighter-rouge">zsh</code>。</p>

<h3 id="zsh有什么优势">zsh有什么优势？</h3>

<p>相比<code class="language-plaintext highlighter-rouge">bash</code>，<code class="language-plaintext highlighter-rouge">zsh</code>有庞大的插件社区和成熟的插件管理框架如<code class="language-plaintext highlighter-rouge">oh my zsh</code>，这使得<code class="language-plaintext highlighter-rouge">zsh</code>的功能扩展变得极为容易，你可以向管理vim插件一样管理zsh插件。</p>

<h3 id="zsh安装与配置">zsh安装与配置</h3>

<p>先查看自己现在是啥shell？（一般是bash）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nv">$SHELL</span>  <span class="c"># 应该会显示/usr/bin/bash</span>

<span class="c"># 或</span>
<span class="nb">echo</span> <span class="nv">$0</span>      <span class="c"># 应该显示 "-bash"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>现在让我们来安装zsh吧。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># Debian系</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>zsh

<span class="c">#红帽系</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>zsh
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image291.webp" alt="" /></p>

<p>确认一下自己是否安装成功</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 查看shell版本</span>
bash <span class="nt">--version</span>
zsh <span class="nt">--version</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image292.webp" alt="" /></p>

<p>如何配置zsh呢？</p>

<p>和<code class="language-plaintext highlighter-rouge">bash</code>差不多。</p>

<p><code class="language-plaintext highlighter-rouge">zsh</code>的全局配置文件位于<code class="language-plaintext highlighter-rouge">/etc/zsh.zshc</code>， 单用户配置文件位于<code class="language-plaintext highlighter-rouge">~/.zshrc</code>。</p>

<p>但不推荐你现在修改任何一个文件，因为我们有更加优雅的配置方式：</p>

<h3 id="oh-my-zsh">oh my zsh!</h3>

<p>项目地址：</p>

<p>https://github.com/ohmyzsh/ohmyzsh</p>

<p><code class="language-plaintext highlighter-rouge">oh my zsh</code>是当下最流行的<code class="language-plaintext highlighter-rouge">zsh</code>插件管理工具，相当于vim中的vim-plug或vundle。</p>

<p>安装oh my zsh</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 方式一（可能需要科学上网）</span>
sh <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span class="si">)</span><span class="s2">"</span>

<span class="c"># 方式二</span>
sh <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://install.ohmyz.sh/<span class="si">)</span><span class="s2">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>下图可选是否现在就把zsh设置成默认的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image293.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image294.webp" alt="" /></p>

<p>如上图即安装成功。</p>

<h3 id="配置oh-my-zsh">配置oh my zsh</h3>

<p>现在查看.zshrc文件，你会发现oh my zsh已经几乎帮你配置好了。</p>

<p>如果你想使用插件，可以找到plugins，在其中添加即可。</p>

<p>这里给出我的.zshrc供你参考。</p>

<h3 id="定制独一无二的zsh">定制独一无二的zsh</h3>

<p>还记得上文中我提到不建议修改.zshrc，这是因为我们在使用oh my zsh框架后，oh my zsh会建立一个~/oh-my-zsh目录用于存放相关文件，其中有一个名为custom的文件夹，我们可以将我们的配置脚本放在此处，oh my zsh会自动加载这一目录下的vim脚本。</p>

<p>基本支持bash的配置命令。以博主为例，bashrc脚本迁移到zsh未作任何改动。</p>

<p>我创建了一个名为myshrc.zsh的脚本以存储配置，文件如下供你参考。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> /home/用户名/.oh-my-zsh/custom
<span class="nb">touch</span> ./myshrc.zsh
vim ./myshrc.zsh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>将自己~/.bashrc里自己多添加的设置全部复制到该文件中即可。</p>

<p>例如我的：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>
<span class="c"># 配置CUDA</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/cuda/bin:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/cuda/lib64:<span class="nv">$LD_LIBRARY_PATH</span>

<span class="c"># 配置ROS-DISTRO</span>
<span class="nb">export </span><span class="nv">ROSDISTRO_INDEX_URL</span><span class="o">=</span>https://mirrors.bfsu.edu.cn/rosdistro/index-v4.yaml

<span class="c"># 配置ROS1 Noetic</span>

<span class="c"># source /opt/ros/noetic/setup.zsh</span>

<span class="c"># export ROS_MASTER_URI=http://localhost:11311</span>

<span class="c"># export ROS_HOSTNAME=localhost</span>

<span class="c"># export GAZEBO_MODEL_PATH=$GAZEBO_MODEL_PATH:/home/tungchiahui/UserFloder/MySource/ROS_WS/gazebo_models:/home/tungchiahui/UserFloder/MySource/ROS_WS/ign_models</span>

<span class="c"># 配置ROS2 Humble</span>
<span class="nb">source</span> /opt/ros/humble/setup.zsh
<span class="nb">export </span><span class="nv">ROS_DOMAIN_ID</span><span class="o">=</span>6
<span class="nb">export </span><span class="nv">IGN_GAZEBO_RESOURCE_PATH</span><span class="o">=</span><span class="nv">$IGN_GAZEBO_RESOURCE_PATH</span>:/home/tungchiahui/UserFloder/MySource/ROS_WS/gazebo_models:/home/tungchiahui/UserFloder/MySource/ROS_WS/ign_models
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接着可以刷新当前终端环境</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 刷新环境</span>
<span class="nb">source</span> ~/.zshrc

<span class="c"># 检查自己的配置是否生效</span>
<span class="nb">echo</span> <span class="nv">$LD_LIBRARY_PATH</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>对应着我上面我的配置，会对应echo打印出下列即为成功。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>/usr/local/cuda/lib64:/usr/local/cuda/lib64: 
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="切换默认shell">切换默认shell</h3>

<p>如果在下图选择了yes,就不用再重新设置了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image295.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>chsh <span class="nt">-s</span> <span class="si">$(</span>which zsh<span class="si">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nv">$SHELL</span>  <span class="c"># 应输出 "/usr/bin/zsh"</span>
<span class="nb">echo</span> <span class="nv">$0</span>      <span class="c"># 若显示 "-zsh"，表示已生效</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>完毕！</p>

<p>如果这里发现无法设置成默认，如下图：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image296.webp" alt="" /></p>

<p>那么使用下方命令强制修改：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 强制修改</span>
<span class="nb">sudo </span>usermod <span class="nt">-s</span> /usr/bin/zsh tungchiahui<span class="o">(</span>用户名<span class="o">)</span>

<span class="c"># 验证</span>
<span class="nb">grep </span>tungchiahui<span class="o">(</span>用户名<span class="o">)</span> /etc/passwd  <span class="c"># 检查是否显示 "/usr/bin/zsh"</span>

<span class="c"># 重启</span>
<span class="nb">sudo </span>reboot
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image297.webp" alt="" /></p>

<p>重启后验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nv">$SHELL</span>  <span class="c"># 应输出 "/usr/bin/zsh"</span>
<span class="nb">echo</span> <span class="nv">$0</span>      <span class="c"># 若显示 "-zsh"，表示已生效</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image298.webp" alt="" /></p>

<p>再次完毕！</p>

<h3 id="添加插件教程">添加插件教程</h3>

<h4 id="powerlevel10k">powerlevel10k</h4>

<p>这个插件是美化zsh的，优点是不会怎么影响终端性能，速度比较快。</p>

<p>https://github.com/romkatv/powerlevel10k</p>

<p>安装powerlevel10k</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
<span class="c"># 国外用户</span>
git clone <span class="nt">--depth</span><span class="o">=</span>1 https://github.com/romkatv/powerlevel10k.git ~/powerlevel10k
<span class="nb">echo</span> <span class="s1">'source ~/powerlevel10k/powerlevel10k.zsh-theme'</span> <span class="o">&gt;&gt;</span>~/.zshrc

<span class="c"># 国内用户</span>
git clone <span class="nt">--depth</span><span class="o">=</span>1 https://gitee.com/romkatv/powerlevel10k.git ~/powerlevel10k
<span class="nb">echo</span> <span class="s1">'source ~/powerlevel10k/powerlevel10k.zsh-theme'</span> <span class="o">&gt;&gt;</span>~/.zshrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>下载字体</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image299.webp" alt="" /></p>

<p>下面的任选其一</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image300.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image301.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 刷新当前环境变量</span>
<span class="nb">source</span> ~/.zshrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里需要检查图标是否都显示正常，显示不正常就证明字体有问题，关闭终端再重新打开看看字体还有问题吗?</p>

<p>没问题就一直y.</p>

<p>建议参考这个教程的配置。</p>

<p>https://www.bilibili.com/video/BV1dX4y127JL</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image302.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image303.webp" alt="" /></p>

<p>下面是配置好的样子：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image304.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image305.webp" alt="" /></p>

<p>如果想重新配置就输入：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>p10k configure
</pre></td></tr></tbody></table></code></pre></div></div>

<p>VScode如果图标显示不全的话，如下操作即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image306.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image307.webp" alt="" /></p>

<ol>
  <li>搜索 <code class="language-plaintext highlighter-rouge">Terminal › Integrated: Font Family</code></li>
</ol>

<p>输入支持 Nerd Font 的字体名称，例如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>MesloLGS NF
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（注意 <code class="language-plaintext highlighter-rouge">MesloLGS NF</code> 必须放在首位）</p>

<ol>
  <li><strong>用基础连字支持</strong></li>
</ol>

<p>搜索 <code class="language-plaintext highlighter-rouge">Terminal › Integrated: Font Ligatures</code></p>

<p>勾选 <code class="language-plaintext highlighter-rouge">Enabled</code>（允许字体渲染特殊连字符号）</p>

<ol>
  <li><strong>确保 GPU 加速开启</strong></li>
</ol>

<ul>
  <li>
    <p>搜索 <code class="language-plaintext highlighter-rouge">Terminal › Integrated: Gpu Acceleration</code></p>
  </li>
  <li>
    <p>设置为 <code class="language-plaintext highlighter-rouge">on</code>（提升渲染性能）</p>
  </li>
</ul>

<p><strong>若 GPU 加速导致问题</strong></p>

<ul>
  <li>
    <p>尝试设置为 <code class="language-plaintext highlighter-rouge">off</code> 后重启终端</p>
  </li>
  <li>
    <p>检查 Fallback Ligatures 是否生效</p>
  </li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image308.webp" alt="" /></p>

<p>再重开终端即可（GPU设置必须重启终端）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image309.webp" alt="" /></p>

<h2 id="flatpak软件管理工具">Flatpak软件管理工具</h2>

<p>flatpak类似于apt和dnf等包管理工具，可以安装软件，但安装的不是最基础的软件，是QQ，QQ音乐这种软件。</p>

<p>当你的apt或者dnf没有某个软件时，可以去flathub上去看看是否有这个软件。</p>

<h3 id="flatpak安装">flatpak安装</h3>

<p>https://flatpak.org/</p>

<ol>
  <li>Ubuntu</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="c"># 安装flatpak</span>
<span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install </span>flatpak

<span class="c"># 先添加官方国外源</span>
flatpak remote-add <span class="nt">--if-not-exists</span> flathub https://dl.flathub.org/repo/flathub.flatpakrepo

<span class="c"># 再修改为中科大镜像源</span>
<span class="nb">sudo </span>flatpak remote-modify flathub <span class="nt">--url</span><span class="o">=</span>https://mirrors.ustc.edu.cn/flathub

<span class="c"># 查看仓库详情</span>
flatpak remotes <span class="nt">--show-details</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image310.webp" alt="" /></p>

<ol>
  <li>Fedora</li>
</ol>

<p>Fedora已经自带。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 先添加官方国外源</span>
flatpak remote-add <span class="nt">--if-not-exists</span> flathub https://dl.flathub.org/repo/flathub.flatpakrepo

<span class="c"># 再修改为中科大镜像源</span>
<span class="nb">sudo </span>flatpak remote-modify flathub <span class="nt">--url</span><span class="o">=</span>https://mirrors.ustc.edu.cn/flathub

<span class="c"># 查看仓库详情</span>
flatpak remotes <span class="nt">--show-details</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image311.webp" alt="" /></p>

<h3 id="字体问题解决">字体问题解决</h3>

<p>因为flatpak是沙盒,所以容易缺字体,先安装字体</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c">#Ubuntu</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>google-noto-sans-cjk-fonts google-noto-serif-cjk-fonts

<span class="c"># Fedora</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>google-noto-sans-cjk-fonts google-noto-serif-cjk-fonts
</pre></td></tr></tbody></table></code></pre></div></div>
<p>实际上这套字体叫：
Noto Sans CJK / Noto Serif CJK
它同时包含：
中文（Simplified + Traditional）
日文（JP）
韩文（KR）</p>

<p>然后设置 Flatpak 的字体访问权限（override）,让所有 Flatpak 应用能“看到”这些字体：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>flatpak override <span class="nt">--filesystem</span><span class="o">=</span>/usr/share/fonts
<span class="nb">sudo </span>flatpak override <span class="nt">--filesystem</span><span class="o">=</span>~/.local/share/fonts
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果你之前安装过flatpak软件,那么上面的操作对已安装的软件不生效,
拿QQ音乐举例,我们需要让他生效.</p>

<p>进入 Flatpak 沙盒环境,这条命令让你进入 QQ 音乐的沙盒终端，就像“进入容器”一样。
里面的路径和主系统是隔离的。</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>flatpak run <span class="nt">--command</span><span class="o">=</span>bash com.qq.QQmusic
</pre></td></tr></tbody></table></code></pre></div></div>

<p>删除旧的 fontconfig 缓存,Flatpak 会在自己的沙盒里缓存字体索引。
删掉旧缓存后，新的字体才能重新被识别。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">rm</span> <span class="nt">-rvf</span> ~/.var/app/com.qq.QQmusic/cache/fontconfig/
</pre></td></tr></tbody></table></code></pre></div></div>

<p>重建字体缓存,这一步会强制重新扫描字体路径（包含 /usr/share/fonts 和用户字体路径），
生成新的缓存文件，修复显示问题。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>fc-cache <span class="nt">-f</span> <span class="nt">-v</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="安装软件">安装软件</h3>

<p>https://flathub.org/</p>

<p>去上面的官网搜索软件+下载软件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image312.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image313.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>flatpak <span class="nb">install </span>flathub com.obsproject.Studio
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image314.webp" alt="" /></p>

<h3 id="运行软件">运行软件</h3>

<p>方法一（官方）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image315.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>flatpak <span class="nb">install </span>flathub com.obsproject.Studio
</pre></td></tr></tbody></table></code></pre></div></div>

<p>方法二（直接当普通软件运行即可）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image316.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image317.webp" alt="" /></p>

<h2 id="appimage">Appimage</h2>

<p>比如说，QQ音乐只提供deb，appimage.并不提供rpm格式的安装包（1.1.7版本是这样的，以后估计rpm会给。纯纯开发者欠C了，连rpm都不给。）所以说我想在Fedora上安装QQ音乐要么用appimage,要么选择用flatpak.(这里使用appimage)</p>

<p>先下载appimage</p>

<p>https://y.qq.com/download/download.html</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image318.webp" alt="" /></p>

<p>再去google下载个QQ音乐图标（因为google可以下载透明图标）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image319.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image320.webp" alt="" /></p>

<p>给他们放在<code class="language-plaintext highlighter-rouge">/home/用户名</code>的某个文件夹中（这个自己定，比如我是<code class="language-plaintext highlighter-rouge">/home/tungchiahui/UserFloder/Applications/qqmusic/</code>文件夹）</p>

<p>先给QQ音乐执行权限</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> ~/UserFloder/Applications/qqmusic
<span class="nb">sudo chmod</span> +x ./qqmusic-1.1.7.AppImage
</pre></td></tr></tbody></table></code></pre></div></div>

<p>给QQ音乐配置 <strong>快捷方式</strong> ：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> ~/.local/share/applications/
<span class="nb">touch</span> ./qqmusic.desktop
vim ./qqmusic.desktop
<span class="nb">sudo chmod</span> +x ./qqmusic.desktop
</pre></td></tr></tbody></table></code></pre></div></div>

<p>内容如下</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">[</span>Desktop Entry]
<span class="nv">Name</span><span class="o">=</span>QQ音乐
<span class="nv">Exec</span><span class="o">=</span>/home/tungchiahui/UserFloder/Applications/qqmusic/qqmusic-1.1.7.AppImage
<span class="nv">Icon</span><span class="o">=</span>/home/tungchiahui/UserFloder/Applications/qqmusic/QQ_Music2023.svg
<span class="nv">Type</span><span class="o">=</span>Application
<span class="nv">Categories</span><span class="o">=</span>Audio<span class="p">;</span>Music<span class="p">;</span>Player<span class="p">;</span>
<span class="nv">Comment</span><span class="o">=</span>QQ Music Client <span class="k">for </span>Linux
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时找到软件就可以打开了，如果找不到，请重启，部分不先进的发行版刷新图标列表不会很快。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image321.webp" alt="" /></p>

<p>如果QQ音乐闪退，这个只是QQ音乐自己软件的问题，按下图这样做。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image322.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image323.webp" alt="" /></p>

<p>如果你用的不是KDE，那么也可以直接修改<code class="language-plaintext highlighter-rouge">qqmuic.desktop</code>：在exec的末尾加上<code class="language-plaintext highlighter-rouge">--no-sandbox</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">[</span>Desktop Entry]
<span class="nv">Name</span><span class="o">=</span>QQ音乐
<span class="nv">Exec</span><span class="o">=</span>/home/tungchiahui/UserFloder/Applications/qqmusic/qqmusic-1.1.7.AppImage <span class="nt">--no-sandbox</span>
<span class="nv">Icon</span><span class="o">=</span>/home/tungchiahui/UserFloder/Applications/qqmusic/QQ_Music2023.svg
<span class="nv">Type</span><span class="o">=</span>Application
<span class="nv">Categories</span><span class="o">=</span>Audio<span class="p">;</span>Music<span class="p">;</span>Player<span class="p">;</span>
<span class="nv">Comment</span><span class="o">=</span>QQ Music Client <span class="k">for </span>Linux
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image324.webp" alt="" /></p>

<p>如果qq音乐缺字体,那么请安装字体(这个字体是多种语言合一的字体)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install </span>google-noto-sans-cjk-fonts google-noto-serif-cjk-fonts
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="修改hostname">修改HOSTNAME</h2>

<p>例如我要修改为Dell-G15-5511</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>hostnamectl set-hostname <span class="s2">"Dell-G15-5511"</span>

hostnamectl | <span class="nb">grep</span> <span class="s2">"Static hostname"</span>      <span class="c"># 验证静态主机名</span>

<span class="nb">sudo </span>systemctl restart systemd-hostnamed  <span class="c"># 重启主机名服务</span>
<span class="nb">sudo </span>systemctl restart NetworkManager      <span class="c"># 重启网络服务</span>
<span class="nb">sudo </span>reboot

<span class="nb">echo</span> <span class="nv">$HOSTNAME</span>           <span class="c"># 验证主机名</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image325.webp" alt="" /></p>

<h2 id="删掉应用配置">删掉应用配置</h2>

<p>有的应用配置有问题，可以删掉他的缓存。</p>

<p>缓存在<code class="language-plaintext highlighter-rouge">~/.config</code>文件夹下。</p>

<p>比如VScode出问题了：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image326.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image327.webp" alt="" /></p>

<p>这样删掉他就结束了。</p>

<p>而下面的这个<code class="language-plaintext highlighter-rouge">~/.vscode</code>是扩展。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image328.webp" alt="" /></p>

<h1 id="qemu-kvm虚拟机">QEMU-KVM虚拟机</h1>

<p>QEMU-KVM是一个高性能的虚拟机,以下是以安装RockyLinux9为例.</p>

<h2 id="安装必备软件">安装必备软件</h2>

<p>确保主机已经安装了 QEMU、KVM 和相关工具。以基于 Debian/Ubuntu 的系统为例，执行以下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>qemu-kvm qemu-img virt-manager virt-install virt-viewer libvirt libvirt-daemon libvirt-daemon-qemu bridge-utils virglrenderer
</pre></td></tr></tbody></table></code></pre></div></div>

<p>对于基于 Fedora/CentOS/Rocky Linux 的系统，命令可能是：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install </span>qemu-kvm qemu-img virt-manager virt-install virt-viewer libvirt libvirt-daemon libvirt-daemon-qemu bridge-utils virglrenderer
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装完成后，确保当前用户在 <code class="language-plaintext highlighter-rouge">kvm</code> 组中（否则可能没有权限使用 KVM 加速）：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>usermod <span class="nt">-aG</span> kvm <span class="nv">$USER</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>注意：</strong> 修改组后可能需要注销重新登录才能生效。</p>

<h2 id="打开kvm硬件加速">打开KVM硬件加速</h2>

<p>运行以下命令检查 KVM 是否启用：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>egrep <span class="nt">-c</span> <span class="s1">'(vmx|svm)'</span> /proc/cpuinfo
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果输出 <code class="language-plaintext highlighter-rouge">0</code>，说明 CPU 不支持 KVM 或未开启 VT-x（Intel）/ SVM（AMD），需要在 BIOS 里开启 <strong>Intel VT-x</strong> 或 <strong>AMD SVM</strong> 。</p>

<p>然后检查 KVM 模块是否加载：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 验证 KVM 加速可用</span>
lsmod | <span class="nb">grep </span>kvm

<span class="c"># 验证当前用户有权限访问 /dev/kvm</span>
<span class="nb">ls</span> <span class="nt">-l</span> /dev/kvm
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果没有输出，加载 KVM 模块：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>modprobe kvm_intel  <span class="c"># Intel 处理器</span>
<span class="nb">sudo </span>modprobe kvm_amd    <span class="c"># AMD 处理器</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="创建虚拟硬盘文件">创建虚拟硬盘文件</h2>

<p>你需要为虚拟机创建一个硬盘镜像文件。这里以 qcow2 格式、100GB 为例（你可以根据需要调整大小）。在终端中运行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>qemu-img create <span class="nt">-f</span> qcow2 disk.qcow2 100G
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这将在当前目录下生成一个名为 <code class="language-plaintext highlighter-rouge">disk.qcow2</code> 的虚拟硬盘文件。</p>

<h2 id="准备-ovmfuefi-固件文件">准备 OVMF（UEFI 固件）文件</h2>

<p>安装 <code class="language-plaintext highlighter-rouge">OVMF</code> 包。例如，在 Ubuntu 上可通过以下命令安装：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 一般电脑都默认安装过了</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ovmf <span class="c"># Debian/Ubuntu</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>edk2-ovmf <span class="c"># RHEL/CentOS/Fedora</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装后，查找文件路径，通常位于 <code class="language-plaintext highlighter-rouge">/usr/share/OVMF/OVMF_CODE.fd</code> 或 <code class="language-plaintext highlighter-rouge">/usr/share/ovmf/OVMF.fd</code>。直接在命令中使用正确路径。(下方脚本中有例子,你只需要确保你的<code class="language-plaintext highlighter-rouge">/usr/share/OVMF/</code>下有这俩文件即可)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image329.webp" alt="" /></p>

<p>也可以下载下面这个文件:</p>

<p>暂时无法在飞书文档外展示此内容</p>

<ol>
  <li>编写或调整 run.sh 脚本</li>
</ol>

<p>将下面的内容写入你的 <code class="language-plaintext highlighter-rouge">run.sh</code> 文件（你可以使用文本编辑器）。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim ./run.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>下面的脚本示例使用 QEMU 启动虚拟机并加载 ISO 镜像：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-machine</span> q35,vmport<span class="o">=</span>off,kernel_irqchip<span class="o">=</span>on <span class="se">\</span>
    <span class="nt">-accel</span> kvm <span class="se">\</span>
    <span class="nt">-cpu</span> host,kvm<span class="o">=</span>on,vmx<span class="o">=</span>on,migratable<span class="o">=</span>on,+invtsc <span class="se">\</span>
    <span class="nt">-smp</span> 8,sockets<span class="o">=</span>1,cores<span class="o">=</span>4,threads<span class="o">=</span>2 <span class="se">\</span>
    <span class="nt">-m</span> 8G,slots<span class="o">=</span>4,maxmem<span class="o">=</span>32G <span class="se">\</span>
    <span class="nt">-device</span> virtio-gpu-gl-pci,max_outputs<span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">-vga</span> none <span class="se">\</span>
    <span class="nt">-display</span> sdl,gl<span class="o">=</span>on <span class="se">\</span>
    <span class="nt">-audiodev</span> pa,id<span class="o">=</span>pa1,server<span class="o">=</span>unix:/run/user/1000/pulse/native <span class="se">\</span>
    <span class="nt">-device</span> ich9-intel-hda <span class="se">\</span>
    <span class="nt">-device</span> hda-micro,audiodev<span class="o">=</span>pa1 <span class="se">\</span>
    <span class="nt">-device</span> qemu-xhci,id<span class="o">=</span>xhci <span class="se">\</span>
    <span class="nt">-device</span> virtio-tablet-pci <span class="se">\</span>
    <span class="nt">-device</span> usb-kbd,bus<span class="o">=</span>xhci.0 <span class="se">\</span>
    <span class="nt">-bios</span> OVMF-pure-efi64.fd <span class="se">\</span>
    <span class="nt">-boot</span> d <span class="se">\</span>
    <span class="nt">-blockdev</span> <span class="nv">driver</span><span class="o">=</span>qcow2,node-name<span class="o">=</span>disk1,file.driver<span class="o">=</span>file,file.cache.direct<span class="o">=</span>on,file.aio<span class="o">=</span>io_uring,file.filename<span class="o">=</span>disk.qcow2 <span class="se">\</span>
    <span class="nt">-device</span> virtio-blk-pci,drive<span class="o">=</span>disk1 <span class="se">\</span>
    <span class="nt">-drive</span> <span class="nv">file</span><span class="o">=</span>kubuntu-20.04.6-desktop-amd64.iso,media<span class="o">=</span>cdrom,if<span class="o">=</span>none,id<span class="o">=</span>cdrom <span class="se">\</span>
    <span class="nt">-device</span> usb-storage,drive<span class="o">=</span>cdrom,removable<span class="o">=</span>on <span class="se">\</span>
    <span class="nt">-nic</span> user,model<span class="o">=</span>virtio-net-pci,hostfwd<span class="o">=</span>tcp::8022-:22 <span class="se">\</span>
    <span class="nt">-monitor</span> stdio <span class="se">\</span>
    <span class="nt">-parallel</span> none <span class="se">\</span>
    <span class="nt">-serial</span> none <span class="se">\</span>
    <span class="nt">-msg</span> <span class="nv">timestamp</span><span class="o">=</span>on

</pre></td></tr></tbody></table></code></pre></div></div>

<p>保存后给脚本执行权限：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo chmod</span> +x run.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="启动虚拟机">启动虚拟机</h2>

<p>确保当前目录下有以下文件：</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">run.sh</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">disk.qcow2</code>（刚刚创建的虚拟硬盘）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Rocky-9.4-x86_64-dvd.iso</code>（Rocky Linux 9 安装 ISO）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">OVMF-pure-efi64.fd</code>文件</p>
  </li>
</ul>

<p>然后在终端中运行脚本：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>./run.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时，QEMU 应该会启动一个窗口，并加载 ISO 镜像进入安装界面。</p>

<h2 id="安装系统">安装系统</h2>

<p>在虚拟机窗口中，你会看到 Linux 的安装界面。按照安装向导的步骤进行安装。安装完成后，你可能需要调整启动项，将硬盘作为启动介质（如果默认还是从 CD 启动）。</p>

<p><strong>建议：</strong> 安装好系统后，关闭虚拟机，再修改 <code class="language-plaintext highlighter-rouge">run.sh</code> 将 ISO 镜像移除或改为可选启动设备，这样下次启动时就会直接从硬盘启动。</p>

<p>例如，将 <code class="language-plaintext highlighter-rouge">-drive file=Rocky-9.5-x86_64-dvd.iso,media=cdrom</code> 移除，或者更换为启动顺序参数。</p>

<h2 id="其他操作">其他操作</h2>

<h3 id="显卡直通谨慎不懂不要乱搞">显卡直通(谨慎,不懂不要乱搞)</h3>

<p>此操作的意思是把显卡完全给虚拟机用,实体宿主机就没法用显卡了.</p>

<ol>
  <li>主机和 IOMMU 配置</li>
</ol>

<p><strong>(1) 启用 IOMMU（以 Intel 为例）</strong></p>

<p>编辑 <code class="language-plaintext highlighter-rouge">/etc/default/grub</code>，在 <code class="language-plaintext highlighter-rouge">GRUB_CMDLINE_LINUX_DEFAULT</code> 中加入：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">intel_iommu</span><span class="o">=</span>on <span class="nv">iommu</span><span class="o">=</span>pt
</pre></td></tr></tbody></table></code></pre></div></div>

<p>对于 AMD 主机则设置 <code class="language-plaintext highlighter-rouge">amd_iommu=on</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image330.webp" alt="" /></p>

<p>更新 grub 后重启：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>grub2-mkconfig <span class="nt">-o</span> /boot/grub2/grub.cfg   <span class="c"># CentOS/Fedora/Rocky 系列</span>

<span class="c"># 或者</span>
<span class="nb">sudo </span>update-grub   <span class="c"># Ubuntu/Debian 系统</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>可以在重启后用下面命令确认 IOMMU 是否启用：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>dmesg | <span class="nb">grep</span> <span class="nt">-e</span> DMAR <span class="nt">-e</span> IOMMU
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果看到类似“DMAR: IOMMU enabled”之类的信息，就说明生效了。</p>

<p><strong>(2) 查找你的 NVIDIA 显卡设备 ID</strong> 使用 <code class="language-plaintext highlighter-rouge">lspci -nn | grep NVIDIA</code> 查找显卡，例如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>tungchiahui@Dell-G15-5511:~/Downloads<span class="nv">$ </span>lspci <span class="nt">-nn</span> | <span class="nb">grep </span>NVIDIA 
01:00.0 VGA compatible controller <span class="o">[</span>0300]: NVIDIA Corporation GA106M <span class="o">[</span>GeForce RTX 3060 Mobile / M
ax-Q] <span class="o">[</span>10de:2560] <span class="o">(</span>rev a1<span class="o">)</span> 
01:00.1 Audio device <span class="o">[</span>0403]: NVIDIA Corporation GA106 High Definition Audio Controller <span class="o">[</span>10de:228
e] <span class="o">(</span>rev a1<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>记下上面的 PCI 地址和设备 ID。</p>

<p><strong>显卡</strong> PCI 地址：<code class="language-plaintext highlighter-rouge">01:00.0</code> 设备 ID：<code class="language-plaintext highlighter-rouge">10de:2560</code></p>

<p><strong>显卡音频</strong> PCI 地址：<code class="language-plaintext highlighter-rouge">01:00.1</code> 设备 ID：<code class="language-plaintext highlighter-rouge">10de:228e</code></p>

<p><strong>(3) 绑定设备到 vfio 驱动</strong></p>

<p>另一种方式是创建一个 modprobe 配置文件，让 vfio-pci 在加载时绑定这些设备。</p>

<ol>
  <li>创建文件（例如 <code class="language-plaintext highlighter-rouge">/etc/modprobe.d/vfio.conf</code>）：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/modprobe.d/vfio.conf
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>在文件中写入：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>options vfio-pci <span class="nv">ids</span><span class="o">=</span>10de:2560,10de:228e
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>保存文件后，更新 initramfs：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># debian系选这个</span>
<span class="nb">sudo </span>update-initramfs <span class="nt">-u</span>

<span class="c"># 红帽系选这个</span>
<span class="nb">sudo </span>dracut <span class="nt">--force</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p>重启系统。</p>
  </li>
  <li>
    <p>检查设备绑定情况</p>
  </li>
</ol>

<p>重启后，你可以用下面命令检查设备是否已经被 vfio-pci 驱动接管：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>lspci <span class="nt">-nnk</span> | <span class="nb">grep</span> <span class="nt">-A3</span> <span class="s2">"10de:2560"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>你应该能看到类似：</p>

<pre><code class="language-YAML">01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GA106M [GeForce RTX 3060 Mobile / Max-Q] [10de:2560]
        Subsystem: ...
        Kernel driver in use: vfio-pci
</code></pre>

<p>同样用相似的命令检查音频设备（10de:228e）。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>lspci <span class="nt">-nnk</span> | <span class="nb">grep</span> <span class="nt">-A3</span> <span class="s2">"10de:228e"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果看到 <code class="language-plaintext highlighter-rouge">Kernel driver in use: vfio-pci</code>，说明绑定成功。</p>

<p><strong>(4) 启动选项</strong></p>

<p>在run.sh里添加上下面两行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
    <span class="c"># 直通 NVIDIA 显卡</span>
    <span class="nt">-device</span> vfio-pci,host<span class="o">=</span>01:00.0,multifunction<span class="o">=</span>on,x-vga<span class="o">=</span>on <span class="se">\</span>
    <span class="nt">-device</span> vfio-pci,host<span class="o">=</span>01:00.1 <span class="se">\</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="拓展功能">拓展功能</h1>

<h2 id="wine">Wine</h2>

<h2 id="android">Android</h2>

<h3 id="i卡a卡">I卡、A卡</h3>

<ol>
  <li>Wayland-Waydroid(体验超级好)</li>
</ol>

<p>https://waydro.id/</p>

<h3 id="n卡so-nvidia-fxxk-u">N卡(So Nvidia Fxxk U!)</h3>

<ol>
  <li>
    <p>QEMU-KVM虚拟机 + BlissOS-X86</p>

    <p>https://www.bilibili.com/video/BV1aS411P7Wh</p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image331.webp" alt="" /></p>

    <ol>
      <li>比较推荐的配置</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>qemu-system-x86_64 <span class="se">\</span>
        <span class="nt">-M</span> q35,vmport<span class="o">=</span>off <span class="se">\</span>
        <span class="nt">-accel</span> kvm <span class="se">\</span>
        <span class="nt">-cpu</span> qemu64,+sse3,+sse4.2 <span class="se">\</span>
        <span class="nt">-smp</span> 8,cores<span class="o">=</span>4 <span class="se">\</span>
        <span class="nt">-m</span> 6G <span class="se">\</span>
        <span class="nt">-usb</span> <span class="se">\</span>
        <span class="nt">-device</span> virtio-tablet <span class="se">\</span>
        <span class="nt">-device</span> virtio-keyboard <span class="se">\</span>
        <span class="nt">-device</span> usb-tablet <span class="se">\</span>
        <span class="nt">-bios</span> OVMF-pure-efi64.fd <span class="se">\</span>
        <span class="nt">-net</span> user,hostfwd<span class="o">=</span>tcp::5555-:5555,hostfwd<span class="o">=</span>tcp::8022-:8022 <span class="se">\</span>
        <span class="nt">-net</span> nic,model<span class="o">=</span>virtio <span class="se">\</span>
        <span class="nt">-audio</span> sdl,model<span class="o">=</span>hda <span class="se">\</span>
        <span class="nt">-display</span> sdl,gl<span class="o">=</span>on,show-cursor<span class="o">=</span>on <span class="se">\</span>
        <span class="nt">-device</span> virtio-vga-gl,xres<span class="o">=</span>1920,yres<span class="o">=</span>1080 <span class="se">\</span>
        <span class="nt">-drive</span> <span class="nv">file</span><span class="o">=</span>disk.qcow2,media<span class="o">=</span>disk,if<span class="o">=</span>virtio,cache<span class="o">=</span>writeback <span class="se">\</span>
        <span class="nt">-drive</span> <span class="nv">file</span><span class="o">=</span>Bliss-v16.9.7-x86_64-OFFICIAL-gapps-20240911.iso,media<span class="o">=</span>cdrom <span class="se">\</span>
        <span class="nt">-monitor</span> stdio <span class="se">\</span>
        <span class="nt">-serial</span> none
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>
        <p>常用操作：</p>

        <ol>
          <li>
            <p>全屏：Ctrl+Alt+F</p>
          </li>
          <li>
            <p>adb调试</p>

            <ol>
              <li>使Linux与Android用ADB连接。</li>
            </ol>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 连接安卓</span>
adb connect 127.0.0.1

<span class="c"># 打开shell</span>
adb <span class="nt">-s</span> 127.0.0.1:5555 shell

<span class="c"># 使用root权限</span>
su
</pre></td></tr></tbody></table></code></pre></div>            </div>
          </li>
          <li>
            <p>中文输入法</p>

            <ol>
              <li>可以下载google输入法：按Shift+space进行中英文切换（这样有效防止与linux本机的中英文切换冲突）</li>
            </ol>
          </li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<h1 id="其他操作-1">其他操作</h1>

<h2 id="工控机如何连wifi">工控机如何连wifi</h2>

<p>当我们工控机从一个环境移动到另一个环境，且新的环境的wifi我们没有连接过，我们没有屏幕如何让工控机连上网呢？</p>

<p>进入工控机的硬盘目录，进入<code class="language-plaintext highlighter-rouge">/etc/netplan/</code>，底下有很多yaml,找到一个最符合下方格式的yaml:</p>

<pre><code class="language-YAML">network: 
  version: 2 
  wifis: 
    NM-6f414fe0-2658-48ff-89ee-c7981b87bc96: 
      renderer: NetworkManager 
      match: 
        name: "wlan0" 
      dhcp4: true 
      dhcp6: true 
      access-points: 
        "EMIS_Vinci_Robocon_5G": 
          auth: 
            key-management: "psk" 
            password: "vinci666" 
          networkmanager: 
            uuid: "6f414fe0-2658-48ff-89ee-c7981b87bc96" 
            name: "EMIS_Vinci_Robocon_5G" 
            passthrough: 
              wifi-security.auth-alg: "open" 
              ipv6.addr-gen-mode: "default" 
              ipv6.ip6-privacy: "-1" 
              proxy._: "" 
      networkmanager: 
        uuid: "6f414fe0-2658-48ff-89ee-c7981b87bc96" 
        name: "EMIS_Vinci_Robocon_5G"

</code></pre>

<p>将其改为新wifi的名和密码：</p>

<pre><code class="language-YAML">network:
  version: 2
  wifis:
    wlan0:
      dhcp4: true
      dhcp6: true
      access-points:
        "EMIS_Vinci_Robocon_5G":
          password: "vinci666"

</code></pre>

<p>工控机开机即可连上网。</p>

<h2 id="ssh远程开发">SSH远程开发</h2>

<h3 id="环境准备-1">环境准备</h3>

<p><strong>1.硬件准备</strong></p>

<p>首先要有一台工控机（X86小型电脑，专业工控机，树莓派等等）。</p>

<p>控制系统的硬件载体是具有多样性的，常用的多是基于ARM、x86等架构的处理器，比如：PC、工控机、树莓派、NVIDIA Jetson…。不同的处理器都存在一定的优缺点，PC和工控机，处理器性能强大，但是功耗高、体积大、灵活性差，嵌入式系统则反之。对于我们而言，可以根据机器人平台的电气、载重、空间以及用途等诸多要素自主选择合适的控制系统。</p>

<p>无论选用何种处理器，只要是要进行机器人的开发，安装了ROS或者ROS2，那么对于开发人员而言，在使用上，没有任何本质的区别，或者换言之，作为软件工程师，部分场景下无需关注于硬件的选型。</p>

<p><strong>2.设置固定IP</strong></p>

<p>远程连接时，不管使用何种工具，需要根据IP地址定位到被连接的主机，再通过账号和密码登录该主机，因此，我们需要先获取该IP地址。并且每次连接时，都需要使用到IP，为了保证连接的便利性和稳定性，最好将被连接主机的IP地址设置为固定IP，具体操作如下。</p>

<p>1.进入设置界面</p>

<p>启动被连接的主机（启动时需要连接显示器或使用HDMI采集卡，并且配置完SSH远程访问之后，可以不再使用显示器或HDMI采集卡），并进入设置界面。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image332.webp" alt="" /></p>

<p>2.配置所连接的网络</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image333.webp" alt="" /></p>

<p>3.设置固定IP</p>

<p>查看当前IP地址。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image334.webp" alt="" /></p>

<p>设置固定IP。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image335.webp" alt="" /></p>

<p>至此，IP配置完毕。</p>

<h3 id="环境搭建">环境搭建</h3>

<p><strong>概念</strong></p>

<p>SSH（Secure Shell）是一种通用的、功能强大的、基于软件的网络安全解决方案。计算机每次向网络发送数据时，SSH都会自动对其进行加密。数据到达目的地时，SSH自动对加密数据进行解密。整个过程都是透明的，使用OpenSSH工具将会增进你的系统安全性。SSH安装容易、使用简单。</p>

<p><strong>实现</strong></p>

<p>SSH实现架构上分为客户端和服务器端两大部分，客户端是数据的发送方，服务端是数据的接收方，当前场景下，我们需要从本地主机发送数据到远程主机，那么本地主机需要安装并启动SSH客户端，而远程主机则需要安装并启动SSH服务端，整个实现具体流程如下：</p>

<ol>
  <li>
    <p>本地主机安装SSH客户端，远程主机安装SSH服务端；</p>
  </li>
  <li>
    <p>远程主机启动SSH服务；</p>
  </li>
  <li>
    <p>本地主机登陆远程主机；</p>
  </li>
  <li>
    <p>实现数据传输。</p>
  </li>
</ol>

<p>1.安装SSH客户端与服务端</p>

<p>默认情况下，Ubuntu系统已经安装了SSH客户端，因此只需要在远程主机安装SSH服务端即可，安装命令如下：</p>

<p>```Plain Text
 sudo apt install openssh-server</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
如果SSH客户端需要自行安装，那么调用如下命令:

```Plain Text
sudo apt install openssh-client
</pre></td></tr></tbody></table></code></pre></div></div>

<p>2.远程主机启动SSH服务</p>

<p>远程主机启动 ssh 服务命令如下：</p>

<p>```Plain Text
sudo /etc/init.d/ssh start</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
启动后可使用如下命令查看服务是否正常运行：

```Plain Text
ps -e | grep ssh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果启动成功，会包含 sshd 程序。</p>

<p>以后需要频繁的使用ssh远程登录，为了简化实现，可以将远程主机的ssh服务设置为开机自启动，命令如下：</p>

<p>```Plain Text
sudo systemctl enable ssh</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
3.本地远程登录

登录远程主机可以调用如下命令:

```bash
ssh -X 用户名@ip地址
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后根据提示，录入登陆密码，即可成功登录。</p>

<p>如果退出，可以调用exit命令：</p>

<p>```Plain Text
exit</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
**4.实现数据传输**

通过SSH在本地主机只需调用相关指令，便可方便的实现与远程主机的数据上传或下载，指令格式如下所示：

上传文件指令格式如下：

```Plain Text
scp 本地文件路径 账号@ip:路径
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上传文件夹指令格式如下：</p>

<p>```Plain Text
scp -r 本地文件夹路径 账号@ip:路径</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
下载文件指令格式如下：

```Plain Text
scp 账号@ip:路径 本地文件夹路径
</pre></td></tr></tbody></table></code></pre></div></div>

<p>下载文件夹指令格式如下：</p>

<p>```Plain Text
scp -r 账号@ip:路径 本地文件夹路径</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
**优化**

每次远程登录时，都需要输入密码，使用不方便，可以借助密钥简化登录过程，实现免密登录，提高操作效率。实现思想是：生成一对公钥私钥，私钥存储在本地，公钥上传至服务器，每次登录时，本地直接上传私钥到服务器，服务器有匹配的公钥就认为是合法用户，直接创建SSH连接即可。具体实现步骤只有两步：

1.  本地生成密钥对；

2.  将公钥上传至远程主机。

**1.生成密钥对**

本地客户端生成公私钥：（一路回车默认即可）

```Plain Text
ssh-keygen
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上面这个命令会在用户目录.ssh文件夹下创建公私钥：</p>

<ol>
  <li>
    <p>id_rsa （私钥）；</p>
  </li>
  <li>
    <p>id_rsa.pub (公钥)。</p>
  </li>
</ol>

<p><strong>2.公钥上传</strong></p>

<p>上传指令如下：</p>

<p>```Plain Text
ssh-copy-id -i ~/.ssh/id_rsa.pub 账号@ip</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre>
上面这条指令是将本地公钥上传到远程主机的ssh目录下，该目录下有文件authorized\_keys保存了公钥内容。

以后再远程登录就无需录入密码了。

### 使用VScode优化

上一节，我们介绍了ssh远程连接的使用，但是如果只是纯粹使用ssh也存在一些不足，比如：编辑文件内容时，需要使用vi编辑器，且在一个终端内，无法同时编辑多个文件。本节将介绍一更为实用的功能——VSCode结合插件实现远程开发，这使我们可以以图形化的方式实现远程开发，比ssh的使用更方便快捷，可以大大的提高程序开发效率。

**1.准备工作**

VScode远程开发依赖于ssh，请首先按照上一节内容配置ssh远程连接。

**2.为VScode安装远程开发插件**

启动VScode，首先点击侧边栏的扩展按钮，然后在`扩展：商店`的搜索栏输入`Remote Development`并点击同名插件，最后在右侧显示区中点击`安装`。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image336.webp)

**3.配置远程连接**

步骤1：使用快捷键`ctrl + shift + p`打开命令输入窗口，并输入`Remote-SSH:Connect to Host...`，弹出列表中选择与之同名的选项。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image337.webp)

步骤2：步骤1完成将弹出一个新的命令窗口如下，选择下拉列表中的 `Add New SSH Host`。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image338.webp)

步骤3：步骤2完成又将弹出一个新的命令窗口，在其中输入：`ssh -X ubuntu@192.168.43.164`，其中，`ubuntu`需要替换为你的登录用户名，`192.18.43.164` 则替换为被远程连接主机的ip地址。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image339.webp)

步骤4：选择步骤3完成后的弹窗列表中的第一个选项(或直接回车)，即可完成配置，配置成功后会有提示信息。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image340.webp)

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image341.webp)

**4.使用**

步骤1：继续使用快捷键`ctrl + shift + p`打开命令输入窗口，并输入`Remote-SSH:Connect to Host...`，此时列表中将显示步骤3中配置的ip地址，直接选择，选择后，VScode将打开一个新的窗口。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image342.webp)

或者，也可以点击侧边栏的`远程资源管理器`，在弹出的服务器列表中选择要连接的服务器，并右击，选择在本窗口或新窗口中实现远程连接。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image343.webp)

步骤2：选择菜单栏的`文件`下的`打开文件夹`，在弹窗列表中选择需要打开的文件夹并点击确定即可。

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image344.webp)

最终，我们就可以像操作本地文件一样实现远程开发了。

## 远程桌面

因为用X11转发效率太低太低，所以还是要选用远程访问桌面的形式来看Rviz2和Gazebo等等（如果有需求的话）

我们选择使用VNC来看。

1.  安装VNC服务器：

这里以TigerVNC为例进行安装：

```bash
sudo apt install tigervnc-standalone-server tigervnc-common
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>设置VNC密码：</li>
</ol>

<p>为VNC用户设置密码，运行以下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vncpasswd
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>配置VNC启动脚本:</li>
</ol>

<p>创建VNC配置文件，在用户家目录内的.vnc文件夹中创建启动文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> ~/.vnc
nano ~/.vnc/xstartup
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在打开的编辑器里面输入以下内容（以GNOME为例）：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
<span class="nb">unset </span>SESSION_MANAGER
<span class="nb">unset </span>DBUS_SESSION_BUS_ADDRESS
gnome-session
</pre></td></tr></tbody></table></code></pre></div></div>

<p>保存并退出（在nano中按Ctrl + O保存，然后按Ctrl + X退出）。</p>

<ol>
  <li>给予执行权限：</li>
</ol>

<p>为xstartup文件设置执行权限：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">chmod</span> +x ~/.vnc/xstartup
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>启动VNC服务器：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vncserver <span class="nt">-geometry</span> 1920x1080 <span class="nt">-localhost</span><span class="o">=</span>0
</pre></td></tr></tbody></table></code></pre></div></div>

<p>geometry 选项指定窗口大小，localhost 选项设为 0 以开放连接。(设为1是只允许本地连接)</p>

<p>你将看到类似于:1的输出，这表示VNC会话的显示编号。例如，如果输出为:1，则VNC监听的端口为5901（5900 + 显示编号）。</p>

<ol>
  <li>查看已开启的VNC服务器：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vncserver <span class="nt">-list</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image345.webp" alt="" /></p>

<ol>
  <li>连接到VNC服务器：</li>
</ol>

<p>使用VNC客户端（如vncviewer）连接到VNC服务器，输入你的服务器IP和端口。例如，如果服务器IP为192.168.31.10，且显示编号为1，你应该连接到192.168.31.10:1，或者直接输入192.168.31.10:5901。</p>

<ol>
  <li>停止VNC服务器：</li>
</ol>

<p>如果需要停止VNC服务器，可以使用以下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vncserver <span class="nt">-kill</span> :1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>将:1替换为你实际使用的显示编号。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image346.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image347.webp" alt="" /></p>

<h2 id="usb端口设置">USB端口设置</h2>

<p><strong>首先先配置好权限</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
<span class="c"># 将用户权限提高</span>
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> dialout <span class="nv">$USER</span>
newgrp dialout

<span class="c"># 查看下面命令是否输出dialout（若输出才正常）</span>
<span class="nb">groups</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>因为我们插拔USB设备，他的端口号可能会一直变，所以我们要给他的tty起一个固定的别名。</p>

<h3 id="根据usb设备绑定端口多个不同设备">根据USB设备绑定端口(多个不同设备)</h3>

<p><strong>需求：</strong> Ubuntu系统中现接入雷达和智能小车，请为二者绑定端口。</p>

<p><strong>实现原理：</strong> 可以通过USB设备本身的“标识”实现端口绑定。</p>

<p><strong>流程如下：</strong></p>

<p>（1）.查找设备idVendor和idProduct</p>

<p>接入两个USB设备，在终端调用指令<code class="language-plaintext highlighter-rouge">lsusb</code>查看显示系统中以及连接到系统的USB设备信息。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image348.webp" alt="" /></p>

<p>如上图所示，红色方框内数据为USB设备，ID后面的<code class="language-plaintext highlighter-rouge">1a86:7523</code>分别为USB的idVendor和idProduct（两个参数之间使用”：“分隔）。</p>

<p>另外：可以通过重新插拔比较的方式确定哪些数据对应接入的USB设备。</p>

<p>（2）.编写映射规则</p>

<p>在<code class="language-plaintext highlighter-rouge">/etc/udev/rules.d</code>目录下新建文件xxx.rules（文件名自定义）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/udev/rules.d/xxx.rules
</pre></td></tr></tbody></table></code></pre></div></div>

<p>输入如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"ttyUSB*"</span>, ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">"10c4"</span>, ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">"ea60"</span>, MODE:<span class="o">=</span><span class="s2">"0777"</span>, SYMLINK+<span class="o">=</span><span class="s2">"mylidar"</span>
<span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"ttyUSB*"</span>, ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">"1a86"</span>, ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">"7523"</span>, MODE:<span class="o">=</span><span class="s2">"0777"</span>, SYMLINK+<span class="o">=</span><span class="s2">"mycar"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>代码解释：</p>

<ul>
  <li>
    <p>KERNEL是内核固定名称，这里统一是“ttyUSB*”；</p>
  </li>
  <li>
    <p>MODE是节点权限，通常改为“0777”，表示可读写可运行；</p>
  </li>
  <li>
    <p>SYMLINK是符号连接，即绑定的别名；</p>
  </li>
  <li>
    <p>ATTRS是设备厂商的唯一标识，idVendor和idProduct正好组成上面通过lsusb查找到的设备ID。</p>
  </li>
</ul>

<p><strong><em>小提示：</em></strong><em>一般的USB设备供应商都会提供类似的脚本文件，对于调用者而言，直接复制该文件到</em><code class="language-plaintext highlighter-rouge">/etc/udev/rule.d</code><em>目录即可。</em></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">设备类型</th>
      <th style="text-align: left">内核名称示例</th>
      <th style="text-align: left">说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">USB 串口设备</td>
      <td style="text-align: left">ttyUSB*</td>
      <td style="text-align: left">USB 转串口设备，如 /dev/ttyUSB0</td>
    </tr>
    <tr>
      <td style="text-align: left">串口设备</td>
      <td style="text-align: left">ttyS*</td>
      <td style="text-align: left">物理串口设备，如 /dev/ttyS0</td>
    </tr>
    <tr>
      <td style="text-align: left">存储设备</td>
      <td style="text-align: left">sd*</td>
      <td style="text-align: left">SCSI 磁盘设备，如 /dev/sda</td>
    </tr>
    <tr>
      <td style="text-align: left">网络设备</td>
      <td style="text-align: left">eth*</td>
      <td style="text-align: left">以太网设备，如 /dev/eth0</td>
    </tr>
    <tr>
      <td style="text-align: left">输入设备</td>
      <td style="text-align: left">event*</td>
      <td style="text-align: left">输入事件设备，如 /dev/input/event0</td>
    </tr>
    <tr>
      <td style="text-align: left">蓝牙设备</td>
      <td style="text-align: left">rfcomm*</td>
      <td style="text-align: left">蓝牙串口设备，如 /dev/rfcomm0</td>
    </tr>
  </tbody>
</table>

<p>（3）.使规则生效</p>

<p>在终端下输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
<span class="c"># Ubuntu用下方命令</span>
<span class="nb">sudo </span>service udev reload
<span class="nb">sudo </span>service udev restart

<span class="c">#Fedora用下方命令</span>
<span class="nb">sudo </span>udevadm control <span class="nt">--reload</span>
<span class="nb">sudo </span>udevadm trigger
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再重新插拔设备即可。</p>

<p>（4）.测试</p>

<p>终端下输入如下指令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ll /dev | <span class="nb">grep </span>ttyUSB
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果如下：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image349.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image350.webp" alt="" /></p>

<p>也可以多次插拔USB设备，会发现设备端口<code class="language-plaintext highlighter-rouge">ttyUSBn</code>中的n编号会变动，但是别名是始终可以指向对应的USB设备的。至此，就可以使用别名来关联所需使用的USB设备了。</p>

<p><strong>缺点：</strong></p>

<p>上述实现也存在一定的局限性，当Ubuntu接入两台或多台相同型号的USB设备时，由于设备ID是一样的，该种实现方式只会对其中的一台设备生效，这种情况下，就需要通过第二种策略来实现端口的绑定了。</p>

<h3 id="根据主机硬件绑定端口多个相同设备">根据主机硬件绑定端口（多个相同设备)</h3>

<p><strong>需求：</strong> 无人车中现接入一前一后两台相同型号的雷达，请为二者绑定端口。</p>

<p><strong>实现原理：</strong> USB设备所连接主机的USB接口也是有其“标识”的，可以通过这个标识实现端口绑定。</p>

<p><strong>流程如下：</strong></p>

<p>（1）.查看所连接的主机USB接口的KERNELS</p>

<p>调用如下指令查看第一台雷达的USB信息：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>udevadm info <span class="nt">--attribute-walk</span> <span class="nt">--name</span><span class="o">=</span>/dev/ttyUSB0 | <span class="nb">grep </span>KERNELS
udevadm info <span class="nt">--attribute-walk</span> <span class="nt">--name</span><span class="o">=</span>/dev/ttyACM0 | <span class="nb">grep </span>KERNELS
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image351.webp" alt="" /></p>

<p>调用如下指令查看第二台雷达的USB信息：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>udevadm info <span class="nt">--attribute-walk</span> <span class="nt">--name</span><span class="o">=</span>/dev/ttyUSB1 | <span class="nb">grep </span>KERNELS
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果相比较不同的KERNELS，第一台雷达端口地址为<code class="language-plaintext highlighter-rouge">KERNELS==1-1.3:1.0</code>，第二个雷达端口地址为<code class="language-plaintext highlighter-rouge">KERNELS==1-1.4:1.0</code>。可以使用此数据作为不同端口的“<strong>唯一性标识</strong>”。</p>

<p>（2）.编写映射规则</p>

<p>在<code class="language-plaintext highlighter-rouge">/etc/udev/rules.d</code>目录下新建文件xxx.rules（文件名自定义），输入如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/udev/rules.d/xxx.rules
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"ttyUSB*"</span>, <span class="nv">KERNELS</span><span class="o">==</span><span class="s2">"1-1.3:1.0"</span>, MODE:<span class="o">=</span><span class="s2">"0777"</span>, SYMLINK+<span class="o">=</span><span class="s2">"rplidar_front"</span>
<span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"ttyUSB*"</span>, <span class="nv">KERNELS</span><span class="o">==</span><span class="s2">"1-1.4:1.0"</span>, MODE:<span class="o">=</span><span class="s2">"0777"</span>, SYMLINK+<span class="o">=</span><span class="s2">"rplidar_back"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（3）.使规则生效</p>

<p>在终端下输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
<span class="c"># Ubuntu用下方命令</span>
<span class="nb">sudo </span>service udev reload
<span class="nb">sudo </span>service udev restart

<span class="c">#Fedora用下方命令</span>
<span class="nb">sudo </span>udevadm control <span class="nt">--reload</span>
<span class="nb">sudo </span>udevadm trigger
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再重新插拔设备即可。</p>

<p>（4）.测试</p>

<p>终端下输入如下指令，运行结果如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ll /dev | <span class="nb">grep </span>ttyUSB
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image352.webp" alt="" /></p>

<p>至此，就可以使用别名来关联所需使用的USB设备了。</p>

<p><strong>缺点：</strong> USB设备必须连接在主机的指定端口上，否则，会导致端口绑定失败，或产生逻辑错误。(而且增加新设备可能会导致端口改变)</p>

<h3 id="根据其他属性绑定端口">根据其他属性绑定端口</h3>

<p>（1）.查看所连接的主机USB接口的信息</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>udevadm info <span class="nt">-a</span> <span class="nt">-p</span> <span class="si">$(</span>udevadm info <span class="nt">-q</span> path <span class="nt">-n</span> /dev/ttyACM0<span class="si">)</span>
udevadm info <span class="nt">-a</span> <span class="nt">-p</span> <span class="si">$(</span>udevadm info <span class="nt">-q</span> path <span class="nt">-n</span> /dev/ttyUSB0<span class="si">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image353.webp" alt="" /></p>

<p>这些数据都是不会变的，所以可以拿这些数据来做标识</p>

<p>（2）.编写映射规则</p>

<p>在<code class="language-plaintext highlighter-rouge">/etc/udev/rules.d</code>目录下新建文件xxx.rules（文件名自定义），输入如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/udev/rules.d/xxx.rules
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"ttyACM*"</span>, ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">"1a86"</span>, ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">"55d4"</span>, ATTRS<span class="o">{</span>serial<span class="o">}==</span><span class="s2">"0001"</span>, MODE:<span class="o">=</span><span class="s2">"0777"</span>, SYMLINK+<span class="o">=</span><span class="s2">"ttyACM_Lidar"</span>
<span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"ttyACM*"</span>, ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">"1a86"</span>, ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">"55d4"</span>, ATTRS<span class="o">{</span>serial<span class="o">}==</span><span class="s2">"0002"</span>, MODE:<span class="o">=</span><span class="s2">"0777"</span>, SYMLINK+<span class="o">=</span><span class="s2">"ttyACM_MCU"</span>
<span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"ttyUSB*"</span>, ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">"1a86"</span>, ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">"7523"</span>, MODE:<span class="o">=</span><span class="s2">"0777"</span>, SYMLINK+<span class="o">=</span><span class="s2">"ttyUSB_IMU"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（3）.使规则生效</p>

<p>在终端下输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
<span class="c"># Ubuntu用下方命令</span>
<span class="nb">sudo </span>service udev reload
<span class="nb">sudo </span>service udev restart

<span class="c">#Fedora用下方命令</span>
<span class="nb">sudo </span>udevadm control <span class="nt">--reload</span>
<span class="nb">sudo </span>udevadm trigger
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再重新插拔设备即可，或者 <strong>直接重启系统。</strong></p>

<p>（4）.测试</p>

<p>终端下输入如下指令<code class="language-plaintext highlighter-rouge">ll /dev | grep ttyUSB</code>，运行结果如下：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/03/30/image354.webp" alt="" /></p>

<p>至此，就可以使用别名来关联所需使用的USB设备了。</p>

<p><strong>缺点：</strong> 一些设备可能没有串口号等。</p>

<h3 id="其他注意事项">其他注意事项</h3>

<p>并非所有的USB设备端口号都是<code class="language-plaintext highlighter-rouge">ttyUSBn</code>的格式，比如Arduino的端口号可能是<code class="language-plaintext highlighter-rouge">ttyACMn</code>，而对于USB摄像头而言，一台设备则对应两个端口号，分别是<code class="language-plaintext highlighter-rouge">videon</code>和<code class="language-plaintext highlighter-rouge">video(n+1)</code>，并且启用摄像头设备一般使用的是<code class="language-plaintext highlighter-rouge">videon</code>端口，绑定时需要关联的也是该接口。</p>

<p>但是无论是外接何种USB设备，也不管采用上述两种方案的哪一种进行端口绑定，其原理都是类似的，只是实现细节不同而已。如果是外接的Arduino设备，那么需要在rules文件中的将<code class="language-plaintext highlighter-rouge">KERNEL=="ttyUSB*"</code>修改为<code class="language-plaintext highlighter-rouge">KERNEL=="ttyACM*"</code>，如果外接的是USB摄像头，那么则需要在rules文件中的将<code class="language-plaintext highlighter-rouge">KERNEL=="ttyUSB*"</code>修改为类似于<code class="language-plaintext highlighter-rouge">KERNEL=="video[0,2,4,6]"</code>的格式，其中<code class="language-plaintext highlighter-rouge">video[0,2,4,6]</code>表示可以绑定的端口为<code class="language-plaintext highlighter-rouge">video0</code>或<code class="language-plaintext highlighter-rouge">video2</code>或<code class="language-plaintext highlighter-rouge">video4</code>或<code class="language-plaintext highlighter-rouge">video6</code>。</p>

<h2 id="linux分区gui工具">Linux分区Gui工具</h2>

<p>```Plain Text
sudo apt install gparted
sudo dnf install gparted</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
## 挂载内网网页

可以把本地的网页挂载到路由器端，或者同内网段其他设备上，甚至可以挂载在本地。

下面以安卓设备为例子，由于安卓设备暂时不能直接打开html,所以我们可以把html挂载到本地服务器，再通过浏览器查看。

由于安卓系统基于Linux内核，所以我们可以下载一个叫termux的app来敲一些Linux命令：

https://github.com/termux/termux-app

首先打开app后，先更新软件缓存：

```bash
pkg update
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后换源</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nano <span class="nv">$PREFIX</span>/etc/apt/sources.list
</pre></td></tr></tbody></table></code></pre></div></div>

<p>将该文件内容替换为下面：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>deb https://mirrors.bfsu.edu.cn/termux/termux-packages-24 stable main
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p>如果你使用的是<code class="language-plaintext highlighter-rouge">nano</code>编辑器：</p>

    <ul>
      <li>
        <p>按 <code class="language-plaintext highlighter-rouge">Ctrl+O</code> 保存文件。</p>
      </li>
      <li>
        <p>按 <code class="language-plaintext highlighter-rouge">Enter</code> 确认文件名。</p>
      </li>
      <li>
        <p>按 <code class="language-plaintext highlighter-rouge">Ctrl+X</code> 退出编辑器。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>如果你使用的是<code class="language-plaintext highlighter-rouge">vim</code>编辑器：</p>

    <ul>
      <li>
        <p>按 <code class="language-plaintext highlighter-rouge">Esc</code> 退出编辑模式。</p>
      </li>
      <li>
        <p>输入 <code class="language-plaintext highlighter-rouge">:wq</code> 保存并退出。</p>
      </li>
    </ul>
  </li>
</ul>

<p>接下来重新更新软件源：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>pkg update <span class="o">&amp;&amp;</span> pkg upgrade
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装python：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>pkg <span class="nb">install </span>python3
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>通过Termux访问设备存储</strong> ：</p>

<p>如果文件在安卓设备上，可以使用Termux的文件管理器访问设备的存储：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>termux-setup-storage
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p><strong>进入HTML文件所在的目录</strong> ：</p>

    <ol>
      <li>使用<code class="language-plaintext highlighter-rouge">cd</code>命令进入HTML文件所在的目录：</li>
    </ol>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> ~/your_html_folder
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p><strong>启动Python HTTP服务器</strong> ：</p>

    <ol>
      <li>运行以下命令启动一个简单的HTTP服务器：</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>python3 <span class="nt">-m</span> http.server 8000
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>这会在端口<code class="language-plaintext highlighter-rouge">8000</code>上启动一个Web服务器。</li>
    </ol>
  </li>
</ol>

<ul>
  <li>启动服务器后，Termux会显示日志信息，例如：</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>这表示服务器已成功启动。</li>
</ul>

<p><strong>在浏览器中访问HTML文件</strong></p>

<ol>
  <li>
    <p><strong>在同一设备上访问</strong> ：</p>

    <ol>
      <li>打开安卓设备上的浏览器（如Chrome），输入以下地址：</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>http://localhost:8000
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>如果HTML文件中有<code class="language-plaintext highlighter-rouge">index.html</code>，它会自动加载；否则，你需要手动点击文件链接。</li>
    </ol>
  </li>
</ol>

<h2 id="rustdesk无人值守远程控制">RustDesk无人值守远程控制</h2>

<p>目前rustdesk还没办法进行无人值守在wayland下,所以我们需要把登陆密码,锁屏和休眠待机全部关掉.</p>

<h3 id="设置-kde6-自动登录">设置 KDE6 自动登录</h3>

<ol>
  <li>可以先查自己的sddm类型
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">ls</span> /usr/share/xsessions/
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">ls</span> /usr/share/wayland-sessions/
</pre></td></tr></tbody></table></code></pre></div></div>
<p>看哪个会输出东西,输出东西的文件夹就是你拥有的sddm,比如xsessions输出内容的话,那就是x11的sddm,如果wayland-sessions输出内容的话你就是wayland的sddm.</p>

<ol>
  <li>编辑 SDDM 配置：
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/sddm.conf
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<p>在文件最上面有个[Autologin],在这个底下加入下面的内容：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="o">[</span>Autologin]
<span class="nv">User</span><span class="o">=</span>你的用户名
<span class="nv">Session</span><span class="o">=</span>plasma.desktop   <span class="c"># 或 plasma.desktop（X11），方案一可用 Wayland</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>保存退出后重启 SDDM：
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart sddm
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<p>✅ 开机后自动进入桌面，无需输入密码</p>

<h3 id="关闭锁屏">关闭锁屏</h3>
<p>在 KDE6 系统设置里：
打开 系统设置 → 屏幕锁定(Screen Locking)
关闭自动锁定
关闭屏幕关闭 / 屏幕保护锁定
这样 RustDesk 可以开机后直接控制桌面，不会被锁屏阻挡</p>

<h3 id="关闭休眠">关闭休眠</h3>
<p>系统设置 → 电源管理(Power Managerment)
禁用“休眠”或“自动挂起”
保证电脑开机一直在线，RustDesk 可随时远控
如果必须休眠，可在 BIOS 设置里禁用休眠，保证开机即联网</p>]]></content><author><name>Tung Chia-hui</name></author><category term="环境搭建" /><category term="Linux" /></entry><entry><title type="html">Arm-Keil-MDK6教程</title><link href="https://jekyll.tungchiahui.cn/blog/arm-keil-mdk6-tutorial/" rel="alternate" type="text/html" title="Arm-Keil-MDK6教程" /><published>2024-01-21T00:00:00+00:00</published><updated>2024-01-21T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/Arm-Keil-MDK6%E6%95%99%E7%A8%8B</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/arm-keil-mdk6-tutorial/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#简介" id="markdown-toc-简介">简介</a></li>
  <li><a href="#官方教程" id="markdown-toc-官方教程">官方教程</a></li>
  <li><a href="#linux配置mdk6环境教程" id="markdown-toc-linux配置mdk6环境教程">Linux配置MDK6环境教程</a>    <ul>
      <li><a href="#需要准备的软件" id="markdown-toc-需要准备的软件">需要准备的软件</a></li>
      <li><a href="#vcpkg安装与环境配置" id="markdown-toc-vcpkg安装与环境配置">vcpkg安装与环境配置</a></li>
      <li><a href="#mdk5工程生成与armclangac6编译器配置" id="markdown-toc-mdk5工程生成与armclangac6编译器配置">MDK5工程生成与ARMCLANG(AC6)编译器配置</a>        <ul>
          <li><a href="#工程生成与编译器配置" id="markdown-toc-工程生成与编译器配置">工程生成与编译器配置</a></li>
          <li><a href="#工程配置比如初始化一个gpio口并创建任务使其电平翻转" id="markdown-toc-工程配置比如初始化一个gpio口并创建任务使其电平翻转">工程配置(比如初始化一个GPIO口并创建任务使其电平翻转)</a></li>
        </ul>
      </li>
      <li><a href="#安装并激活mdk6插件" id="markdown-toc-安装并激活mdk6插件">安装并激活MDK6插件</a></li>
      <li><a href="#初次转化mdk5工程并下载依赖包" id="markdown-toc-初次转化mdk5工程并下载依赖包">初次转化MDK5工程并下载依赖包</a></li>
      <li><a href="#编译" id="markdown-toc-编译">编译</a></li>
      <li><a href="#linux如何配置st-link等调试器" id="markdown-toc-linux如何配置st-link等调试器">Linux如何配置ST-Link等调试器？</a>        <ul>
          <li><a href="#安装pyocdlinux" id="markdown-toc-安装pyocdlinux">安装pyOCD(Linux)</a></li>
          <li><a href="#更新st-link最新驱动linux" id="markdown-toc-更新st-link最新驱动linux">更新ST-Link最新驱动(Linux)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#windows配置mdk6环境教程" id="markdown-toc-windows配置mdk6环境教程">Windows配置MDK6环境教程</a>    <ul>
      <li><a href="#需要准备的软件-1" id="markdown-toc-需要准备的软件-1">需要准备的软件</a></li>
      <li><a href="#vcpkg安装与环境配置-1" id="markdown-toc-vcpkg安装与环境配置-1">vcpkg安装与环境配置</a></li>
      <li><a href="#生成工程文件" id="markdown-toc-生成工程文件">生成工程文件</a></li>
      <li><a href="#打开工程并配置默认编译器" id="markdown-toc-打开工程并配置默认编译器">打开工程并配置默认编译器</a></li>
      <li><a href="#下载并激活keil-mdk6插件" id="markdown-toc-下载并激活keil-mdk6插件">下载并激活Keil MDK6插件</a></li>
      <li><a href="#mdk5工程转化为mdk6工程" id="markdown-toc-mdk5工程转化为mdk6工程">MDK5工程转化为MDK6工程</a></li>
      <li><a href="#编译-1" id="markdown-toc-编译-1">编译</a></li>
      <li><a href="#windows如何配置st-link等调试器" id="markdown-toc-windows如何配置st-link等调试器">Windows如何配置ST-Link等调试器？</a>        <ul>
          <li><a href="#添加设备选择st-link" id="markdown-toc-添加设备选择st-link">添加设备选择ST-Link</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#进阶使用教程全平台通用" id="markdown-toc-进阶使用教程全平台通用">进阶使用教程(全平台通用)</a>    <ul>
      <li><a href="#run运行程序和debug调试程序" id="markdown-toc-run运行程序和debug调试程序">Run（运行程序）和Debug（调试程序）？</a>        <ul>
          <li><a href="#选择packs" id="markdown-toc-选择packs">选择packs</a></li>
          <li><a href="#run将程序下载到st-link中" id="markdown-toc-run将程序下载到st-link中">(RUN)将程序下载到ST-Link中</a></li>
          <li><a href="#debug调试程序" id="markdown-toc-debug调试程序">(DEBUG)调试程序</a></li>
        </ul>
      </li>
      <li><a href="#vscode头文件配置" id="markdown-toc-vscode头文件配置">VScode头文件配置</a>        <ul>
          <li><a href="#cc插件不推荐" id="markdown-toc-cc插件不推荐">C/C++插件（不推荐）</a></li>
          <li><a href="#clangd插件-非常推荐" id="markdown-toc-clangd插件-非常推荐">Clangd插件 (非常推荐)</a></li>
        </ul>
      </li>
      <li><a href="#添加源文件对应project-items和头文件对应include-path到编译环境中" id="markdown-toc-添加源文件对应project-items和头文件对应include-path到编译环境中"><strong>添加源文件(对应Project Items)和头文件(对应Include Path)到编译环境中</strong></a>        <ul>
          <li><a href="#常规方法修改yaml文件" id="markdown-toc-常规方法修改yaml文件">常规方法(修改yaml文件)</a>            <ul>
              <li><a href="#相关资料" id="markdown-toc-相关资料">相关资料</a></li>
              <li><a href="#创建文件c和h" id="markdown-toc-创建文件c和h">创建文件(.c和.h)</a></li>
              <li><a href="#添加头文件路径" id="markdown-toc-添加头文件路径">添加头文件路径</a></li>
              <li><a href="#添加源文件与分组" id="markdown-toc-添加源文件与分组">添加源文件与分组</a></li>
              <li><a href="#编写文件并编译" id="markdown-toc-编写文件并编译">编写文件并编译</a></li>
            </ul>
          </li>
          <li><a href="#图形化" id="markdown-toc-图形化">图形化</a>            <ul>
              <li><a href="#简介-1" id="markdown-toc-简介-1">简介</a></li>
              <li><a href="#添加源文件" id="markdown-toc-添加源文件">添加源文件</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#常见问题" id="markdown-toc-常见问题">常见问题</a>    <ul>
      <li><a href="#freertos使用armclangac6编译报错的问题" id="markdown-toc-freertos使用armclangac6编译报错的问题">FreeRTOS使用ARMCLANG(AC6)编译报错的问题</a></li>
      <li><a href="#错误执行cmake配置" id="markdown-toc-错误执行cmake配置">错误执行cmake配置</a></li>
      <li><a href="#修改汇编语言的编译器为armclang集成的汇编编译器" id="markdown-toc-修改汇编语言的编译器为armclang集成的汇编编译器">修改汇编语言的编译器为ARMClang集成的汇编编译器</a></li>
      <li><a href="#出现某些工具没被下载的情况" id="markdown-toc-出现某些工具没被下载的情况">出现某些工具没被下载的情况</a></li>
    </ul>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">截止2024年1月21日，MDK6已经完善到完全可以当主力IDE的状态，各项功能都比较完备。</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">但是由于ARM仍在更新完善MDK6，所以教程会有所出入，但是大体上的步骤不会有太大的变化，有太大的变化的地方本文可能会更新。</code></p>

<h1 id="简介">简介</h1>

<p>https://www.keil.arm.com/</p>

<p>As flexible as you are: from cloud to desktop, from CLI to GUI, running on macOS, Linux, and Windows.</p>

<p>暂时无法在飞书文档外展示此内容</p>

<h1 id="官方教程">官方教程</h1>

<p>https://developer.arm.com/documentation/108029/0000/Get-started-with-an-example-project</p>

<h1 id="linux配置mdk6环境教程">Linux配置MDK6环境教程</h1>

<p><strong><em><code class="language-plaintext highlighter-rouge">（本教程为2024年1月创建的，可能与以后的版本有些出入）</code></em></strong></p>

<h2 id="需要准备的软件">需要准备的软件</h2>

<ol>
  <li>
    <p>CubeMX最新版</p>
  </li>
  <li>
    <p>VScode最新版</p>
  </li>
  <li>
    <p>vcpkg包管理工具</p>
  </li>
  <li>
    <p>pyOcd（如何安装下方有教程）</p>
  </li>
  <li>
    <p>ST-Link驱动（如何安装下方有教程）</p>
  </li>
</ol>

<h2 id="vcpkg安装与环境配置">vcpkg安装与环境配置</h2>

<ol>
  <li>下载依赖包</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get upgrade
<span class="nb">sudo </span>apt-get <span class="nb">install </span>build-essential <span class="nb">tar </span>curl zip unzip
<span class="nb">sudo </span>apt-get <span class="nb">install </span>default-jre
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>克隆vcpkg仓库</li>
</ol>

<p>https://github.com/microsoft/vcpkg/tree/master</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git clone https://github.com/microsoft/vcpkg.git
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>生成vcpkg程序</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">cd </span>vcpkg
<span class="nb">sudo chmod </span>a+x ./bootstrap-vcpkg.sh
<span class="nb">sudo</span> ./bootstrap-vcpkg.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>配置环境</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image1.webp" alt="" /></p>

<p>这个 <strong>VCPKG_HOME是vcpkg的目录</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c">#配置vcpkg环境 </span>
<span class="nb">export </span><span class="nv">VCPKG_HOME</span><span class="o">=</span>/home/tungchiahui/user/applications/vcpkg  <span class="c">#目录需要改为你的vcpkg的目录</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$VCPKG_HOME</span>:<span class="nv">$PATH</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image2.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">source</span> ~/.bashrc
vcpkg <span class="nt">--version</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>出现如图提示则安装成功！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image3.webp" alt="" /></p>

<h2 id="mdk5工程生成与armclangac6编译器配置">MDK5工程生成与ARMCLANG(AC6)编译器配置</h2>

<h3 id="工程生成与编译器配置">工程生成与编译器配置</h3>

<ol>
  <li>
    <p><strong>方式一</strong> ：配置编译器教程需要在Windows进行，在Linux上目前很难修改编译器选项，可以参考下方Windows教程里的生成工程并配置默认编译器。(实质就是把编译器从默认的AC5改成AC6)</p>
  </li>
  <li>
    <p><strong>方式二</strong> ：克隆已经生成好的模板（模板目前只有几个常用型号的)</p>
  </li>
</ol>

<p>仓库链接：</p>

<p>https://github.com/TungChiahuiMCURepos/CubeMX_CMake_Template</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git clone https://github.com/TungChiahuiMCURepos/CubeMX_CMake_Template.git
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image4.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image5.webp" alt="" /></p>

<h3 id="工程配置比如初始化一个gpio口并创建任务使其电平翻转">工程配置(比如初始化一个GPIO口并创建任务使其电平翻转)</h3>

<p>先复制一份工程模板</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image6.webp" alt="" /></p>

<p>重命名工程</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image7.webp" alt="" /></p>

<p>打开CubeMX(并点击最上方File-&gt;Load Project 或者 直接点击下方图中的图标)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image8.webp" alt="" /></p>

<p>找到工程并Load，并配置好工程</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image9.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image10.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image11.webp" alt="" /></p>

<p>在文件夹MDK-ARM下打开终端</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd </span>MDK-ARM
code <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="安装并激活mdk6插件">安装并激活MDK6插件</h2>

<p>下载好ARM Keil Studio Pack</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image12.webp" alt="" /></p>

<p>激活MDK6插件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image13.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image14.webp" alt="" /></p>

<h2 id="初次转化mdk5工程并下载依赖包">初次转化MDK5工程并下载依赖包</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image15.webp" alt="" /></p>

<p>右下角把这些要安装的pack都安装一下，有什么提示要允许的都允许一下</p>

<p>在安装Packs的时候，需要保证一个良好的网络环境(需要一个有魔法的网络环境)，</p>

<p>这个阶段会持续5-20分钟，请慢慢等待。(看你的机场速度而决定)</p>

<p>(只有第一次运行需要这些操作)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image16.webp" alt="" /></p>

<p>这个调查可以不查</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image17.webp" alt="" /></p>

<p>如图即是安装成功</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image18.webp" alt="" /></p>

<p>如果下方环境已经配置好了，请右键点击uvprojx选择Convert</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image19.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image20.webp" alt="" /></p>

<p>如果环境没配置好，右键这个文件，选择active environment(图中因为我的环境配置好了，所以是deactive失能)</p>

<p>然后再执行上一步的Convert</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image21.webp" alt="" /></p>

<p>如图已经初始化成功了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image22.webp" alt="" /></p>

<h2 id="编译">编译</h2>

<p>点击build按钮发现文件大小一样就是编译成功了。</p>

<p>若编译失败，则看一下是否是工程文件列表被多配置了一个点。（看下方进阶教程里的添加源文件解决）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image23.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image24.webp" alt="" /></p>

<h2 id="linux如何配置st-link等调试器">Linux如何配置ST-Link等调试器？</h2>

<h3 id="安装pyocdlinux">安装pyOCD(Linux)</h3>

<p>https://github.com/pyocd/pyOCD</p>

<p>先打开终端输入（如果你是debian系的系统，如Ubuntu，请看下方的教程）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>python3-pip
python3 <span class="nt">-mpip</span> <span class="nb">install</span> <span class="nt">-U</span> pyocd

<span class="c"># 如果上面的不行，则输入下方的</span>
pip3 <span class="nb">install</span> <span class="nt">-U</span> pyocd
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果还不行，且提示</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>error: externally-managed-environment

× This environment is externally managed
╰─&gt; To <span class="nb">install </span>Python packages system-wide, try apt <span class="nb">install
    </span>python3-xyz, where xyz is the package you are trying to
    install.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>则使用（debian系的系统）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>python3-pyocd
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>或者</strong> 说直接克隆仓库</p>

<pre><code class="language-Python">git clone https://github.com/pyocd/pyOCD.git
cd pyOCD
pip3 install .
</code></pre>

<p>这样也可以安装pyOCD</p>

<p>接下来，我们需要安装ST-Link等调试器的驱动。</p>

<p>pyOCD安装调试器驱动官方教程：</p>

<p>https://github.com/pyocd/pyOCD/tree/main/udev</p>

<p>还是需要用到pyOCD仓库里的文件。</p>

<p>如果你没clone仓库请尽快克隆。</p>

<p>在仓库目录下，输入以下命令</p>

<pre><code class="language-Python">cd udev
sudo cp *.rules /etc/udev/rules.d
#重启udev
sudo udevadm control --reload
sudo udevadm trigger
</code></pre>

<p>这样ST-Link就可以正常被检测出来了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image25.webp" alt="" /></p>

<p>如果没被检测出来，请插拔一下ST-Link，然后点击Add Device添加一下设备。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image26.webp" alt="" /></p>

<h3 id="更新st-link最新驱动linux">更新ST-Link最新驱动(Linux)</h3>

<p>https://www.st.com/en/development-tools/stsw-link007.html#get-software</p>

<p>暂时无法在飞书文档外展示此内容</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image27.webp" alt="" /></p>

<p>下载后的文件解压出来。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image28.webp" alt="" /></p>

<pre><code class="language-Python">sudo apt install ./st-stlink-udev-rules-1.0.3-2-linux-all.deb
</code></pre>

<p>重启VScode即可</p>

<p>(下方还有其他有关的教程操作，请往下滑)</p>

<h1 id="windows配置mdk6环境教程">Windows配置MDK6环境教程</h1>

<h2 id="需要准备的软件-1">需要准备的软件</h2>

<ol>
  <li>
    <p>Keil MDK5.3x及以上</p>
  </li>
  <li>
    <p>VScode最新版</p>
  </li>
  <li>
    <p>CubeMX最新版</p>
  </li>
</ol>

<h2 id="vcpkg安装与环境配置-1">vcpkg安装与环境配置</h2>

<ol>
  <li>克隆vcpkg仓库</li>
</ol>

<p>https://github.com/microsoft/vcpkg/tree/master</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git clone https://github.com/microsoft/vcpkg.git
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image29.webp" alt="" /></p>

<ol>
  <li>生成vcpkg程序</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image30.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image31.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image32.webp" alt="" /></p>

<ol>
  <li>配置环境</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image33.webp" alt="" /></p>

<p>点击高级系统设置</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image34.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image35.webp" alt="" /></p>

<p>将用户环境变量和系统环境变量都配置一下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image36.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image37.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image38.webp" alt="" /></p>

<ol>
  <li>测试</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vcpkg <span class="nt">--version</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>显示如下图所示，则安装成功</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image39.webp" alt="" /></p>

<h2 id="生成工程文件">生成工程文件</h2>

<ol>
  <li>打开CubeMX并登录ST账号</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image40.webp" alt="" /></p>

<ol>
  <li>安装好Pack</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image41.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image42.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image43.webp" alt="" /></p>

<ol>
  <li>配置工程</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image44.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image45.webp" alt="" /></p>

<h2 id="打开工程并配置默认编译器">打开工程并配置默认编译器</h2>

<ol>
  <li>配置默认编译器为ARMCLANG(AC6)</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image46.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image47.webp" alt="" /></p>

<ol>
  <li>编译验证</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image48.webp" alt="" /></p>

<h2 id="下载并激活keil-mdk6插件">下载并激活Keil MDK6插件</h2>

<ol>
  <li>打开VScode</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image49.webp" alt="" /></p>

<ol>
  <li>安装Keil Studio Pack插件</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image50.webp" alt="" /></p>

<ol>
  <li>
    <p>安装完毕后，重启VScode</p>
  </li>
  <li>
    <p>然后右下角会跳出来两个窗口，点击激活MDK6Community.</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image51.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image52.webp" alt="" /></p>

<p>显示这个通知即激活成功。</p>

<h2 id="mdk5工程转化为mdk6工程">MDK5工程转化为MDK6工程</h2>

<p>点击Convert进行转化</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image53.webp" alt="" /></p>

<p>右下角把这些要安装的pack都安装一下，有什么提示要允许的都允许一下</p>

<p>在安装Packs的时候，需要保证一个良好的网络环境(需要一个有魔法的网络环境)，</p>

<p>这个阶段会持续5-20分钟，请慢慢等待。(看你的机场速度而决定)</p>

<p>(只有第一次运行需要这些操作)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image54.webp" alt="" /></p>

<p>可以打开任务管理器看cmsis.exe是否在正常下载，如果后面有网速，则说明在正常下载，等待即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image55.webp" alt="" /></p>

<p>这个调查可以不查</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image56.webp" alt="" /></p>

<p>如图即是安装成功</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image57.webp" alt="" /></p>

<p>这里如果是没激活环境，则需要active environment。(图中是取消激活环境)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image58.webp" alt="" /></p>

<p>点击转化MDK5工程</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image59.webp" alt="" /></p>

<p>这样则显示为转化MDK6工程成功。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image60.webp" alt="" /></p>

<h2 id="编译-1">编译</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image61.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image62.webp" alt="" /></p>

<p>可以看到，通过KEIL MDK6编译后的大小和KEIL MDK5编译后的大小完全相同。</p>

<h2 id="windows如何配置st-link等调试器">Windows如何配置ST-Link等调试器？</h2>

<p>Windows就更简单了，根本不用多下其他东西，只要你在MDK5上能用，基本在MDK6上也能用。</p>

<h3 id="添加设备选择st-link">添加设备选择ST-Link</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image63.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image64.webp" alt="" /></p>

<h1 id="进阶使用教程全平台通用">进阶使用教程(全平台通用)</h1>

<h2 id="run运行程序和debug调试程序">Run（运行程序）和Debug（调试程序）？</h2>

<h3 id="选择packs">选择packs</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image65.webp" alt="" /></p>

<p>出现STM32 STLink后，接着点回车Enter</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image66.webp" alt="" /></p>

<p>搜索对应的芯片的Packs并选中</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image67.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image68.webp" alt="" /></p>

<h3 id="run将程序下载到st-link中">(RUN)将程序下载到ST-Link中</h3>

<p>点击RUN，然后在新弹出的窗口选择对应的型号，比如我选择STM32F103C8</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image69.webp" alt="" /></p>

<p>可以看到下方的命令已经把程序烧写进STM32了，然后STM32也正常工作了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image70.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image71.webp" alt="" /></p>

<h3 id="debug调试程序">(DEBUG)调试程序</h3>

<p>打上三个断点</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image72.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">extern</span> <span class="s">"C"</span>
<span class="kt">void</span> <span class="nf">led_task</span><span class="p">(</span><span class="kt">void</span> <span class="k">const</span> <span class="o">*</span> <span class="n">argument</span><span class="p">)</span>
<span class="p">{</span>

    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="n">bsp_led</span><span class="p">.</span><span class="n">LED_Toggle</span><span class="p">();</span>  <span class="c1">//实例化后调用对象翻转电平函数</span>
        <span class="n">osDelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
        <span class="n">a</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>点击Debug并选中型号</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image73.webp" alt="" /></p>

<p>然后就可以进入Debug界面</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image74.webp" alt="" /></p>

<p>点击开始按钮</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image75.webp" alt="" /></p>

<p>可以看到断点被成功命中，且可以通过左边窗口查看a的值。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image76.webp" alt="" /></p>

<p>接着点击继续。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image77.webp" alt="" /></p>

<p>下一个断点也被命中了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image78.webp" alt="" /></p>

<p>接着点继续，发现a的值变为了6，符合我们程序的运行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image79.webp" alt="" /></p>

<p>这样就可以正常debug了。</p>

<h2 id="vscode头文件配置">VScode头文件配置</h2>

<p><strong>(这只是可以更好的编辑代码，这些头文件并没有被加入到编译环境中)</strong></p>

<h3 id="cc插件不推荐">C/C++插件（不推荐）</h3>

<p>如果有这种找不到头文件的情况，配置一下VScode的C/C++插件的Include Path即可。</p>

<p>但是由于该插件需要同时配置编译器，所以可能会出一些各种各样的小问题。</p>

<p>而且该插件对于大型项目会很卡，可以选择直接看下方的clangd插件教程。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image80.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image81.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image82.webp" alt="" /></p>

<p>在这里多加一行../**</p>

<p>除了以上这种方式，也可以通过修改c_cpp_properties.json文件进行。</p>

<p>输入 <code class="language-plaintext highlighter-rouge">"../**"</code> (意思是将上一个目录(工程根目录)里的所有文件全部加载到Include Path中)</p>

<p>同时建议也把ARMCLANG的include文件加入到这里面 “<code class="language-plaintext highlighter-rouge">/home/tungchiahui/.vcpkg/artifacts/2139c4c6/compilers.arm.armclang/6.21.0/include/</code>”</p>

<p>每个人的目录不同，但都是在用户文件夹的.vcpkg隐藏文件夹下，可以自己找找。（下方的图不完整，请根据上访内容进行添加）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image83.webp" alt="" /></p>

<p>配置好之后，我们发现代码提示也正常了，虽然头文件还是有可能会被VScode误报错说找不到，但是其实已经可以正常编译了，也可以正常提示这些头文件了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image84.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image85.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image86.webp" alt="" /></p>

<h3 id="clangd插件-非常推荐">Clangd插件 (非常推荐)</h3>

<ol>
  <li>优势：由于clangd适合大型的cmake项目，在大型项目里表现比C/C++插件优秀太多，所以笔者与MDK6都建议用clangd的语言服务器。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image87.webp" alt="" /></p>

<p>现在最新版MDK6自带clangd插件。</p>

<ol>
  <li>Windows需要下载安装一下LLVM (Linux一般不用管或者<code class="language-plaintext highlighter-rouge">sudo apt install llvm</code>)</li>
</ol>

<p>https://github.com/llvm/llvm-project/releases</p>

<p>我下载的是LLVM 18.1.8，中选择<code class="language-plaintext highlighter-rouge">Assets</code>中选择<code class="language-plaintext highlighter-rouge">LLVM-18.1.8-win64.exe</code></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image88.webp" alt="" /></p>

<p>这里选择这个选项<code class="language-plaintext highlighter-rouge">Add LLVM to the system PATH for all users</code>，其他无脑下一步即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image89.webp" alt="" /></p>

<p>可以打开terminal测试一下是否安装成功并配置好环境。</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">clang</span><span class="w"> </span><span class="nt">-v</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image90.webp" alt="" /></p>

<ol>
  <li>现在来安装clangd：</li>
</ol>

<p>按住Ctrl shift P打开搜索框</p>

<p>输入clangd 找到下载语言服务器这一项目，点击安装clangd（请保持良好的网络状况）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image91.webp" alt="" /></p>

<ol>
  <li>接着配置clangd：</li>
</ol>

<p>禁用C/C++的代码提示功能</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image92.webp" alt="" /></p>

<p>如果没有上图的弹窗，可以进行手动关闭，依然是ctrl shift P,输入settings然后找到如下图的选项</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image93.webp" alt="" /></p>

<p>找到下图这个选项，改成disabled即可。</p>

<p><code class="language-plaintext highlighter-rouge">"C_Cpp.intelliSenseEngine": "disabled"</code></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image94.webp" alt="" /></p>

<p>新建一个settings.json文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image95.webp" alt="" /></p>

<p>修改里面的内容，该内容是 cmake产生的compile_commands.json 文件所在的路径(路径会随MDK6版本更新而改变，请自己找文件所在路径)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image96.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image97.webp" alt="" /></p>

<p>接着找到armclang编译器的include目录，也添加进来，一般在用户文件夹下的.vcpkg隐藏文件夹下。</p>

<p>(现在已经无需找了)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image98.webp" alt="" /></p>

<p>以下是Linux版本的settings.json示例</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>{
    "clangd.arguments": [
        "--compile-commands-dir=${workspaceFolder}/tmp/Template_Linux/TemplateLinux"
    ]
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以下是Windows版本的settings.json示例</p>

<p>需要注意的是，Windows需要把盘符号变为小写，比如<code class="language-plaintext highlighter-rouge">C:/</code>要改为<code class="language-plaintext highlighter-rouge">c:/</code>然后<code class="language-plaintext highlighter-rouge">反斜杠\</code>要改为<code class="language-plaintext highlighter-rouge">斜杠/</code>。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"clangd.arguments"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"--compile-commands-dir=${workspaceFolder}/tmp/Template_Linux/TemplateLinux"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>然后ctrl shift P搜索clangd找到如下图的选项</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image99.webp" alt="" /></p>

<p>代码提示就正常啦</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image100.webp" alt="" /></p>

<h2 id="添加源文件对应project-items和头文件对应include-path到编译环境中"><strong>添加源文件(对应Project Items)和头文件(对应Include Path)到编译环境中</strong></h2>

<h3 id="常规方法修改yaml文件">常规方法(修改yaml文件)</h3>

<h4 id="相关资料">相关资料</h4>

<p>添加源文件需要使用yaml标记语言修改cproject.yml文件。</p>

<p>官方为此提供了相关的更为详细的资料文档：https://github.com/Open-CMSIS-Pack/cmsis-toolbox/blob/main/docs/YML-Input-Format.md#source-file-management</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image101.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image102.webp" alt="" /></p>

<h4 id="创建文件c和h">创建文件(.c和.h)</h4>

<p>我们这里先在bsp中创建4个文件分别放入到Src和Inc中。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image103.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image104.webp" alt="" /></p>

<h4 id="添加头文件路径">添加头文件路径</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image105.webp" alt="" /></p>

<p>将头文件所在的目录写入</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image106.webp" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>      add-path:
        - ../Core/Inc
        - ../Drivers/STM32F1xx_HAL_Driver/Inc
        - ../Drivers/STM32F1xx_HAL_Driver/Inc/Legacy
        - ../Drivers/CMSIS/Device/ST/STM32F1xx/Include
        - ../Drivers/CMSIS/Include
        - ../bsp/boards/Inc
        - ../applications/Inc
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="添加源文件与分组">添加源文件与分组</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image107.webp" alt="" /></p>

<p>在这里输入group的名字和所需要添加的源文件路径（这里因为applications里无源文件，所以我们注释掉）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image108.webp" alt="" /></p>

<pre><code class="language-ymal">    - group: bsp/boards
      files:
        - file: ../bsp/boards/Src/gpio_demo.cpp
        - file: ../bsp/boards/Src/gpio_test.c

    # - group: applications

    #   files:
</code></pre>

<p>源文件和头文件都已经成功导入了，我们可以对文件内容进行编写，看其是否能通过编译。</p>

<h4 id="编写文件并编译">编写文件并编译</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image109.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image110.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image111.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image112.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image113.webp" alt="" /></p>

<p>可以看到日志这几行，显示gpio_demo和gpio_test都成功被编译了</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="o">[</span>14/22] Building C object CMakeFiles/Template_Linux.dir/home/tungchiahui/user/Source/STM32_Projects/N1_F407ZGT6_GPIO_Test/bsp/boards/Src/gpio_test.o
<span class="o">[</span>15/22] Building C object CMakeFiles/Template_Linux.dir/home/tungchiahui/user/Source/STM32_Projects/N1_F407ZGT6_GPIO_Test/Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_flash_ex.o
<span class="o">[</span>16/22] Building CXX object CMakeFiles/Template_Linux.dir/home/tungchiahui/user/Source/STM32_Projects/N1_F407ZGT6_GPIO_Test/bsp/boards/Src/gpio_demo.o
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="图形化">图形化</h3>

<h4 id="简介-1">简介</h4>

<p>由于ARM团队比较给力，短短2个月就搞出来了图形化操作，截止3月初已经更新。</p>

<p>ARM团队更新了什么图形化功能，下方教程就会推迟几天更新一下对应的内容。</p>

<h4 id="添加源文件">添加源文件</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image114.webp" alt="" /></p>

<p>等待ARM公司更新功能中… …</p>

<h1 id="常见问题">常见问题</h1>

<h2 id="freertos使用armclangac6编译报错的问题">FreeRTOS使用ARMCLANG(AC6)编译报错的问题</h2>

<ol>
  <li>如果你是使用的模板，那么将模板中的“其他注意事项”文件夹中的Middlewares文件夹复制到根目录即可。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image115.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image116.webp" alt="" /></p>

<ol>
  <li>如果你是自己从Windows上从0开始创立的工程(没有使用模板)，那么需要你去寻找CubeMX下载的固件源码</li>
</ol>

<p>比如Linux中固件源码在<code class="language-plaintext highlighter-rouge">/home/tungchiahui(你自己的用户名)/STM32Cube/Repository/</code>中。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image117.webp" alt="" /></p>

<p>假如你是F103，那么打开<code class="language-plaintext highlighter-rouge">STM32Cube_FW_F1_V1.8.5</code>文件夹。</p>

<p>如果你是F407，那么打开<code class="language-plaintext highlighter-rouge">STM32Cube_FW_F4_V1.28.0</code>文件夹。</p>

<p>找到路径<code class="language-plaintext highlighter-rouge">/home/tungchiahui/STM32Cube/Repository/STM32Cube_FW_F1_V1.8.5/Middlewares/Third_Party/FreeRTOS/Source/portable/</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image118.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image119.webp" alt="" /></p>

<p>将这个GCC文件夹里的ARM_CM3文件夹复制到 <strong>工程文件夹</strong> 对应的RVDS文件夹下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image120.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image121.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image122.webp" alt="" /></p>

<h2 id="错误执行cmake配置">错误执行cmake配置</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image123.webp" alt="" /></p>

<p>如果遇到<code class="language-plaintext highlighter-rouge">error cbuild: error executing 'cmake' configuration</code>这种错误。则删掉MDK-ARM文件夹下的tmp文件夹。再重新编译即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image124.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c">#删除tmp文件夹</span>
<span class="nb">rm</span> <span class="nt">-rf</span> ./tmp
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image125.webp" alt="" /></p>

<h2 id="修改汇编语言的编译器为armclang集成的汇编编译器">修改汇编语言的编译器为ARMClang集成的汇编编译器</h2>

<p>这是个警告，不影响正常使用，但是咱们尽量可以修改一下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image126.webp" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">Plain Text
Warning: A1950W: The legacy armasm assembler is deprecated. 
Consider using the armclang integrated assembler instead.
0 Errors, 1 Warning
</code></p>

<p>暂时没找到解决方案</p>

<h2 id="出现某些工具没被下载的情况">出现某些工具没被下载的情况</h2>

<p>按下面的arm tools然后进入下面的界面选择对应版本,再点击update tool registry即可.(最常见的就是编译器和调试器的库没自动下载.)</p>

<p>如果不知道需要哪些工具,建议可以全部都选上最新版本.(亲测全选最新版本是可以正常使用的)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image127.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2024/01/21/image128.webp" alt="" /></p>]]></content><author><name>Tung Chia-hui</name></author><category term="环境搭建" /><category term="STM32" /></entry><entry><title type="html">ROS2机器人操作系统教程</title><link href="https://jekyll.tungchiahui.cn/blog/ros2-tutorial/" rel="alternate" type="text/html" title="ROS2机器人操作系统教程" /><published>2023-12-30T00:00:00+00:00</published><updated>2023-12-30T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/ROS2%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/ros2-tutorial/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#ros2介绍" id="markdown-toc-ros2介绍">ROS2介绍</a>    <ul>
      <li><a href="#ros2简介" id="markdown-toc-ros2简介">ROS2简介</a></li>
      <li><a href="#ros2框架" id="markdown-toc-ros2框架">ROS2框架</a></li>
      <li><a href="#ros2参考资料" id="markdown-toc-ros2参考资料">ROS2参考资料</a>        <ul>
          <li><a href="#官方资料" id="markdown-toc-官方资料">官方资料</a></li>
          <li><a href="#推荐的视频资料与配套文档" id="markdown-toc-推荐的视频资料与配套文档"><strong>推荐的视频资料与配套文档</strong></a></li>
        </ul>
      </li>
      <li><a href="#学习ros2需要用到的知识储备" id="markdown-toc-学习ros2需要用到的知识储备">学习ROS2需要用到的知识储备</a></li>
      <li><a href="#安装ros2" id="markdown-toc-安装ros2">安装ROS2</a>        <ul>
          <li><a href="#二进制包安装ros2以kubuntu-jammy-2204安装-ros-humble-为例" id="markdown-toc-二进制包安装ros2以kubuntu-jammy-2204安装-ros-humble-为例">二进制包安装ROS2(以Kubuntu Jammy 22.04安装 <strong>ROS Humble</strong> 为例)</a>            <ul>
              <li><a href="#进入ros官网" id="markdown-toc-进入ros官网">进入ROS官网</a></li>
              <li><a href="#安装ros2前期准备工作" id="markdown-toc-安装ros2前期准备工作">安装ROS2前期准备工作</a></li>
              <li><a href="#换源国内源" id="markdown-toc-换源国内源">换源(国内源)</a></li>
              <li><a href="#通过apt安装ros2" id="markdown-toc-通过apt安装ros2">通过apt安装ROS2</a></li>
              <li><a href="#ros2基础环境变量配置" id="markdown-toc-ros2基础环境变量配置">ROS2基础环境变量配置</a></li>
              <li><a href="#测试ros2" id="markdown-toc-测试ros2">测试ROS2</a></li>
            </ul>
          </li>
          <li><a href="#从源码安装ros2难度较高ubuntu用上面那个简单方法即可" id="markdown-toc-从源码安装ros2难度较高ubuntu用上面那个简单方法即可">从源码安装ROS2(难度较高，Ubuntu用上面那个简单方法即可。)</a>            <ul>
              <li><a href="#fedora或者rocky" id="markdown-toc-fedora或者rocky">Fedora或者Rocky</a></li>
              <li><a href="#debian" id="markdown-toc-debian">Debian</a></li>
            </ul>
          </li>
          <li><a href="#docker安装ros2" id="markdown-toc-docker安装ros2">Docker安装ROS2</a></li>
        </ul>
      </li>
      <li><a href="#ros2安装进阶可选" id="markdown-toc-ros2安装进阶可选">ROS2安装进阶(可选)</a>        <ul>
          <li><a href="#安装进阶的包" id="markdown-toc-安装进阶的包">安装进阶的包</a>            <ul>
              <li><a href="#apt安装方式ubuntu强烈建议" id="markdown-toc-apt安装方式ubuntu强烈建议">apt安装方式（Ubuntu强烈建议）</a></li>
              <li><a href="#源码方式非ubuntu" id="markdown-toc-源码方式非ubuntu">源码方式（非Ubuntu）</a>                <ul>
                  <li><a href="#黄色的包" id="markdown-toc-黄色的包">黄色的包</a></li>
                  <li><a href="#蓝色的包" id="markdown-toc-蓝色的包">蓝色的包</a></li>
                </ul>
              </li>
              <li><a href="#常见问题" id="markdown-toc-常见问题">常见问题</a></li>
            </ul>
          </li>
          <li><a href="#环境进阶" id="markdown-toc-环境进阶">环境进阶</a>            <ul>
              <li><a href="#apt方式" id="markdown-toc-apt方式">Apt方式</a></li>
              <li><a href="#源码方式" id="markdown-toc-源码方式">源码方式</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#测试ros2-1" id="markdown-toc-测试ros2-1">测试ROS2</a>        <ul>
          <li><a href="#示例1" id="markdown-toc-示例1">示例1</a></li>
          <li><a href="#示例2" id="markdown-toc-示例2">示例2</a></li>
        </ul>
      </li>
      <li><a href="#常见问题-1" id="markdown-toc-常见问题-1">常见问题</a>        <ul>
          <li><a href="#rviz2闪烁" id="markdown-toc-rviz2闪烁">Rviz2闪烁</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#入门操作" id="markdown-toc-入门操作">入门操作</a>    <ul>
      <li><a href="#简介" id="markdown-toc-简介">简介</a></li>
      <li><a href="#终端环境搭建" id="markdown-toc-终端环境搭建">终端环境搭建</a></li>
      <li><a href="#命令行操作" id="markdown-toc-命令行操作">命令行操作</a></li>
      <li><a href="#ros2-helloworldc" id="markdown-toc-ros2-helloworldc">ROS2 HelloWorld(C++)</a></li>
      <li><a href="#ros2-helloworldpython" id="markdown-toc-ros2-helloworldpython">ROS2 HelloWorld(Python)</a></li>
      <li><a href="#运行优化bash终端环境" id="markdown-toc-运行优化bash终端环境">运行优化(bash终端环境)</a></li>
      <li><a href="#vscode环境搭建" id="markdown-toc-vscode环境搭建">VScode环境搭建</a></li>
      <li><a href="#运行优化colcon-build" id="markdown-toc-运行优化colcon-build">运行优化(colcon build)</a></li>
      <li><a href="#vscode环境进阶" id="markdown-toc-vscode环境进阶">VScode环境进阶</a>        <ul>
          <li><a href="#clangd插件代码提示可选但是建议" id="markdown-toc-clangd插件代码提示可选但是建议">clangd插件代码提示(可选,但是建议)</a></li>
        </ul>
      </li>
      <li><a href="#安装其他工具" id="markdown-toc-安装其他工具">安装其他工具</a></li>
      <li><a href="#ros2体系框架" id="markdown-toc-ros2体系框架">ROS2体系框架</a></li>
    </ul>
  </li>
  <li><a href="#工作空间与功能包" id="markdown-toc-工作空间与功能包">工作空间与功能包</a>    <ul>
      <li><a href="#工作空间简介" id="markdown-toc-工作空间简介">工作空间简介</a></li>
      <li><a href="#源文件编译" id="markdown-toc-源文件编译">源文件编译</a></li>
      <li><a href="#配置文件" id="markdown-toc-配置文件">配置文件</a></li>
      <li><a href="#常用操作命令" id="markdown-toc-常用操作命令">常用操作命令</a></li>
      <li><a href="#核心模块_通信相关" id="markdown-toc-核心模块_通信相关">核心模块_通信相关</a></li>
      <li><a href="#核心模块_工具相关" id="markdown-toc-核心模块_工具相关">核心模块_工具相关</a></li>
      <li><a href="#功能包" id="markdown-toc-功能包">功能包</a></li>
      <li><a href="#ros2技术支持" id="markdown-toc-ros2技术支持">ROS2技术支持</a></li>
      <li><a href="#ros2应用方向" id="markdown-toc-ros2应用方向">ROS2应用方向</a>        <ul>
          <li><a href="#nav2" id="markdown-toc-nav2"><strong>NAV2</strong></a></li>
          <li><a href="#opencv" id="markdown-toc-opencv"><strong>OpenCV</strong></a></li>
          <li><a href="#moveit" id="markdown-toc-moveit"><strong>MoveIt</strong></a></li>
          <li><a href="#the-autoware-foundation" id="markdown-toc-the-autoware-foundation"><strong>The Autoware Foundation</strong></a></li>
          <li><a href="#f1-tenth" id="markdown-toc-f1-tenth"><strong>F1 Tenth</strong></a></li>
          <li><a href="#microros" id="markdown-toc-microros"><strong>microROS</strong></a></li>
          <li><a href="#open-robotics" id="markdown-toc-open-robotics"><strong>Open Robotics</strong></a></li>
          <li><a href="#px4" id="markdown-toc-px4"><strong>PX4</strong></a></li>
          <li><a href="#ros-industrial" id="markdown-toc-ros-industrial"><strong>ROS-Industrial</strong></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#四大通信" id="markdown-toc-四大通信">四大通信</a>    <ul>
      <li><a href="#通信机制简介与代码模板" id="markdown-toc-通信机制简介与代码模板">通信机制简介与代码模板</a></li>
      <li><a href="#话题通信_理论" id="markdown-toc-话题通信_理论">话题通信_理论</a></li>
      <li><a href="#话题通信_实验1c" id="markdown-toc-话题通信_实验1c">话题通信_实验1(C++)</a></li>
      <li><a href="#话题通信_自定义接口信息" id="markdown-toc-话题通信_自定义接口信息">话题通信_自定义接口信息</a></li>
      <li><a href="#话题通信_实验2c" id="markdown-toc-话题通信_实验2c">话题通信_实验2(C++)</a></li>
      <li><a href="#话题通信_rqt查看计算图" id="markdown-toc-话题通信_rqt查看计算图">话题通信_rqt查看计算图</a></li>
      <li><a href="#服务通信_理论" id="markdown-toc-服务通信_理论">服务通信_理论</a></li>
      <li><a href="#服务通信_实验1_服务端实现c" id="markdown-toc-服务通信_实验1_服务端实现c">服务通信_实验1_服务端实现(C++)</a></li>
      <li><a href="#服务通信_实验1_客户端实现c" id="markdown-toc-服务通信_实验1_客户端实现c">服务通信_实验1_客户端实现(C++)</a></li>
      <li><a href="#动作通信_理论" id="markdown-toc-动作通信_理论">动作通信_理论</a></li>
      <li><a href="#动作通信_实验1_服务端实现c" id="markdown-toc-动作通信_实验1_服务端实现c">动作通信_实验1_服务端实现(C++)</a></li>
      <li><a href="#动作通信_实验1_客户端实现c" id="markdown-toc-动作通信_实验1_客户端实现c">动作通信_实验1_客户端实现(C++)</a></li>
      <li><a href="#参数服务_理论与api介绍c" id="markdown-toc-参数服务_理论与api介绍c">参数服务_理论与API介绍(C++)</a></li>
      <li><a href="#参数服务_实验1_服务端c" id="markdown-toc-参数服务_实验1_服务端c">参数服务_实验1_服务端(C++)</a></li>
      <li><a href="#参数服务_实验1_客户端c" id="markdown-toc-参数服务_实验1_客户端c">参数服务_实验1_客户端(C++)</a></li>
    </ul>
  </li>
  <li><a href="#ros2其他通信机制" id="markdown-toc-ros2其他通信机制">ROS2其他通信机制</a>    <ul>
      <li><a href="#概述" id="markdown-toc-概述">概述</a></li>
      <li><a href="#分布式搭建" id="markdown-toc-分布式搭建">分布式搭建</a></li>
      <li><a href="#工作空间覆盖" id="markdown-toc-工作空间覆盖">工作空间覆盖</a></li>
      <li><a href="#元功能包" id="markdown-toc-元功能包">元功能包</a></li>
      <li><a href="#节点重名" id="markdown-toc-节点重名">节点重名</a></li>
      <li><a href="#话题重名" id="markdown-toc-话题重名">话题重名</a></li>
      <li><a href="#时间相关api" id="markdown-toc-时间相关api">时间相关API</a></li>
      <li><a href="#通信机制工具" id="markdown-toc-通信机制工具">通信机制工具</a>        <ul>
          <li><a href="#命令行" id="markdown-toc-命令行">命令行</a></li>
          <li><a href="#rqt工具箱" id="markdown-toc-rqt工具箱">Rqt工具箱</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#launch" id="markdown-toc-launch">Launch</a>    <ul>
      <li><a href="#概述-1" id="markdown-toc-概述-1">概述</a></li>
      <li><a href="#launch基本使用流程c" id="markdown-toc-launch基本使用流程c">launch基本使用流程(C++)</a></li>
      <li><a href="#launch_python_node" id="markdown-toc-launch_python_node">Launch_Python_Node</a></li>
      <li><a href="#launch_python_执行命令" id="markdown-toc-launch_python_执行命令">Launch_Python_执行命令</a></li>
      <li><a href="#launch_python_参数设置" id="markdown-toc-launch_python_参数设置">Launch_Python_参数设置</a></li>
      <li><a href="#launch_python_文件包含" id="markdown-toc-launch_python_文件包含">Launch_Python_文件包含</a></li>
      <li><a href="#launch_python_分组设置" id="markdown-toc-launch_python_分组设置">Launch_Python_分组设置</a></li>
      <li><a href="#launch_python_事件设置" id="markdown-toc-launch_python_事件设置">Launch_Python_事件设置</a></li>
      <li><a href="#launch_xml_yaml_node" id="markdown-toc-launch_xml_yaml_node">Launch_XML_YAML_Node</a></li>
      <li><a href="#launch_xml_yaml_执行命令" id="markdown-toc-launch_xml_yaml_执行命令">Launch_XML_YAML_执行命令</a></li>
      <li><a href="#launch_xml_yaml_参数设置" id="markdown-toc-launch_xml_yaml_参数设置">Launch_XML_YAML_参数设置</a></li>
      <li><a href="#launch_xml_yaml_分组设置" id="markdown-toc-launch_xml_yaml_分组设置">Launch_XML_YAML_分组设置</a></li>
      <li><a href="#launch_xml_yaml_文件包含" id="markdown-toc-launch_xml_yaml_文件包含">Launch_XML_YAML_文件包含</a></li>
    </ul>
  </li>
  <li><a href="#回溯rosbag2" id="markdown-toc-回溯rosbag2">回溯rosbag2</a>    <ul>
      <li><a href="#概述-2" id="markdown-toc-概述-2">概述</a></li>
      <li><a href="#rosbag2的命令工具" id="markdown-toc-rosbag2的命令工具">rosbag2的命令工具</a></li>
      <li><a href="#rosbag2-c案例分析及框架搭建" id="markdown-toc-rosbag2-c案例分析及框架搭建">rosbag2 C++案例分析及框架搭建</a></li>
      <li><a href="#rosbag2-c-录制数据" id="markdown-toc-rosbag2-c-录制数据">rosbag2 C++ 录制数据</a></li>
      <li><a href="#rosbag2-c-读取数据" id="markdown-toc-rosbag2-c-读取数据">rosbag2 C++ 读取数据</a></li>
    </ul>
  </li>
  <li><a href="#坐标变换tf" id="markdown-toc-坐标变换tf">坐标变换TF</a>    <ul>
      <li><a href="#坐标变换" id="markdown-toc-坐标变换">坐标变换</a>        <ul>
          <li><a href="#引言与应用场景" id="markdown-toc-引言与应用场景">引言与应用场景</a></li>
          <li><a href="#概念与作用" id="markdown-toc-概念与作用">概念与作用</a></li>
          <li><a href="#案例安装以及运行" id="markdown-toc-案例安装以及运行">案例安装以及运行</a></li>
          <li><a href="#坐标变换相关消息" id="markdown-toc-坐标变换相关消息">坐标变换相关消息</a>            <ul>
              <li><a href="#geometry_msgsmsgtransformstamped" id="markdown-toc-geometry_msgsmsgtransformstamped">geometry_msgs/msg/TransformStamped</a></li>
              <li><a href="#geometry_msgsmsgpointstamped" id="markdown-toc-geometry_msgsmsgpointstamped">geometry_msgs/msg/PointStamped</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#坐标变换广播" id="markdown-toc-坐标变换广播">坐标变换广播</a>        <ul>
          <li><a href="#引言与案例及分析" id="markdown-toc-引言与案例及分析">引言与案例及分析</a>            <ul>
              <li><a href="#1案例需求" id="markdown-toc-1案例需求">1.案例需求</a></li>
              <li><a href="#2案例分析" id="markdown-toc-2案例分析">2.案例分析</a></li>
              <li><a href="#3流程简介" id="markdown-toc-3流程简介">3.流程简介</a></li>
              <li><a href="#4准备工作" id="markdown-toc-4准备工作">4.准备工作</a></li>
            </ul>
          </li>
          <li><a href="#静态广播器_命令行实现" id="markdown-toc-静态广播器_命令行实现">静态广播器_命令行实现</a>            <ul>
              <li><a href="#1静态广播器工具" id="markdown-toc-1静态广播器工具">1.静态广播器工具</a></li>
              <li><a href="#2静态广播器工具使用" id="markdown-toc-2静态广播器工具使用">2.静态广播器工具使用</a></li>
              <li><a href="#3rviz2-查看坐标系关系" id="markdown-toc-3rviz2-查看坐标系关系">3.rviz2 查看坐标系关系</a></li>
            </ul>
          </li>
          <li><a href="#静态广播器_c实现" id="markdown-toc-静态广播器_c实现">静态广播器_C++实现</a>            <ul>
              <li><a href="#框架搭建" id="markdown-toc-框架搭建">框架搭建</a></li>
              <li><a href="#广播实现" id="markdown-toc-广播实现">广播实现</a></li>
            </ul>
          </li>
          <li><a href="#动态广播器_c实现" id="markdown-toc-动态广播器_c实现">动态广播器_C++实现</a>            <ul>
              <li><a href="#框架搭建-1" id="markdown-toc-框架搭建-1">框架搭建</a></li>
              <li><a href="#广播实现-1" id="markdown-toc-广播实现-1">广播实现</a></li>
            </ul>
          </li>
          <li><a href="#坐标点发布_c实现" id="markdown-toc-坐标点发布_c实现">坐标点发布_C++实现</a>            <ul>
              <li><a href="#案例与分析" id="markdown-toc-案例与分析">案例与分析</a></li>
              <li><a href="#实现" id="markdown-toc-实现">实现</a></li>
            </ul>
          </li>
          <li><a href="#小结" id="markdown-toc-小结">小结</a></li>
        </ul>
      </li>
      <li><a href="#坐标变换监听" id="markdown-toc-坐标变换监听">坐标变换监听</a>        <ul>
          <li><a href="#案例与分析-1" id="markdown-toc-案例与分析-1">案例与分析</a></li>
          <li><a href="#坐标-系-变换监听_c" id="markdown-toc-坐标-系-变换监听_c">坐标 <strong>系</strong> 变换监听_C++</a>            <ul>
              <li><a href="#实例分析" id="markdown-toc-实例分析">实例分析</a></li>
              <li><a href="#实现-1" id="markdown-toc-实现-1">实现</a></li>
            </ul>
          </li>
          <li><a href="#坐标-点-变换监听_c" id="markdown-toc-坐标-点-变换监听_c">坐标 <strong>点</strong> 变换监听_C++</a>            <ul>
              <li><a href="#实现框架" id="markdown-toc-实现框架">实现框架</a></li>
              <li><a href="#框架搭建-2" id="markdown-toc-框架搭建-2">框架搭建</a></li>
              <li><a href="#实现-2" id="markdown-toc-实现-2">实现</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#坐标变换工具" id="markdown-toc-坐标变换工具">坐标变换工具</a>        <ul>
          <li><a href="#1tf2_monitor" id="markdown-toc-1tf2_monitor">1.tf2_monitor</a>            <ul>
              <li><a href="#11打印所有坐标系的发布频率与网络延迟" id="markdown-toc-11打印所有坐标系的发布频率与网络延迟">1.1打印所有坐标系的发布频率与网络延迟</a></li>
              <li><a href="#12打印指定坐标系的发布频率与网络延迟" id="markdown-toc-12打印指定坐标系的发布频率与网络延迟">1.2打印指定坐标系的发布频率与网络延迟</a></li>
            </ul>
          </li>
          <li><a href="#2tf2_echo" id="markdown-toc-2tf2_echo">2.tf2_echo</a></li>
          <li><a href="#3view_frames常用" id="markdown-toc-3view_frames常用">3.view_frames（常用）</a></li>
        </ul>
      </li>
      <li><a href="#练习" id="markdown-toc-练习">练习</a>        <ul>
          <li><a href="#乌龟跟随" id="markdown-toc-乌龟跟随">乌龟跟随</a></li>
          <li><a href="#乌龟护航" id="markdown-toc-乌龟护航">乌龟护航</a></li>
        </ul>
      </li>
      <li><a href="#小结-1" id="markdown-toc-小结-1">小结</a></li>
    </ul>
  </li>
  <li><a href="#可视化平台rviz2与urdf建模语言" id="markdown-toc-可视化平台rviz2与urdf建模语言">可视化平台RVIZ2与URDF建模语言</a>    <ul>
      <li><a href="#可视化简介" id="markdown-toc-可视化简介">可视化简介</a></li>
      <li><a href="#rviz2基本使用" id="markdown-toc-rviz2基本使用">rviz2基本使用</a></li>
      <li><a href="#rviz2集成urdf基本流程" id="markdown-toc-rviz2集成urdf基本流程">rviz2集成URDF基本流程</a>        <ul>
          <li><a href="#案例分析" id="markdown-toc-案例分析">  案例分析</a></li>
          <li><a href="#框架搭建-3" id="markdown-toc-框架搭建-3">  框架搭建</a></li>
          <li><a href="#urdf文件" id="markdown-toc-urdf文件">  urdf文件</a></li>
          <li><a href="#xacro工具将磁盘文件加载到ros2中的工具" id="markdown-toc-xacro工具将磁盘文件加载到ros2中的工具">  xacro工具(将磁盘文件加载到ROS2中的工具)</a></li>
          <li><a href="#launch核心实现" id="markdown-toc-launch核心实现">  launch核心实现</a></li>
          <li><a href="#launch优化说明与实现" id="markdown-toc-launch优化说明与实现">  launch优化说明与实现</a></li>
        </ul>
      </li>
      <li><a href="#urdf语法" id="markdown-toc-urdf语法">URDF语法</a>        <ul>
          <li><a href="#简介-1" id="markdown-toc-简介-1">简介</a></li>
          <li><a href="#robot根标签" id="markdown-toc-robot根标签">robot根标签</a></li>
          <li><a href="#link标签" id="markdown-toc-link标签">link标签</a>            <ul>
              <li><a href="#简介-2" id="markdown-toc-简介-2">简介</a></li>
              <li><a href="#使用" id="markdown-toc-使用">使用</a></li>
              <li><a href="#使用补充" id="markdown-toc-使用补充">使用补充</a></li>
            </ul>
          </li>
          <li><a href="#joint标签" id="markdown-toc-joint标签">joint标签</a>            <ul>
              <li><a href="#简介-3" id="markdown-toc-简介-3">简介</a></li>
              <li><a href="#练习-1" id="markdown-toc-练习-1">练习</a></li>
              <li><a href="#joint_state_publisher" id="markdown-toc-joint_state_publisher">joint_state_publisher</a></li>
              <li><a href="#base_footprint" id="markdown-toc-base_footprint">base_footprint</a></li>
            </ul>
          </li>
          <li><a href="#练习-2" id="markdown-toc-练习-2">练习</a></li>
        </ul>
      </li>
      <li><a href="#urdf工具" id="markdown-toc-urdf工具">URDF工具</a>        <ul>
          <li><a href="#check_urdf-语法检查" id="markdown-toc-check_urdf-语法检查"><strong>check_urdf 语法检查</strong></a></li>
          <li><a href="#urdf_to_graphviz-结构查看" id="markdown-toc-urdf_to_graphviz-结构查看"><strong>urdf_to_graphviz 结构查看</strong></a></li>
        </ul>
      </li>
      <li><a href="#sw2urdf" id="markdown-toc-sw2urdf">SW2URDF</a>        <ul>
          <li><a href="#solidworks简介" id="markdown-toc-solidworks简介">solidworks简介</a></li>
          <li><a href="#solidworks插件sw2urdf介绍" id="markdown-toc-solidworks插件sw2urdf介绍">solidworks插件sw2urdf介绍</a></li>
          <li><a href="#安装sw2urdf" id="markdown-toc-安装sw2urdf">安装sw2urdf</a></li>
          <li><a href="#导出urdf与meshes" id="markdown-toc-导出urdf与meshes">导出URDF与Meshes</a></li>
          <li><a href="#将ros1的ws转化为ros2的ws" id="markdown-toc-将ros1的ws转化为ros2的ws">将ROS1的WS转化为ROS2的WS</a></li>
          <li><a href="#注意事项仅供参考chatgpt的解决方案" id="markdown-toc-注意事项仅供参考chatgpt的解决方案">注意事项（仅供参考，ChatGPT的解决方案）</a>            <ul>
              <li><a href="#坐标系1" id="markdown-toc-坐标系1">坐标系1</a></li>
              <li><a href="#坐标系让车躺着" id="markdown-toc-坐标系让车躺着">坐标系让车躺着</a></li>
              <li><a href="#车直走变旋转旋转变直走" id="markdown-toc-车直走变旋转旋转变直走">车直走变旋转，旋转变直走</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#xacro" id="markdown-toc-xacro">xacro</a>        <ul>
          <li><a href="#场景作用与概念" id="markdown-toc-场景作用与概念">场景、作用与概念</a></li>
          <li><a href="#快速体验" id="markdown-toc-快速体验">快速体验</a>            <ul>
              <li><a href="#语法" id="markdown-toc-语法">语法</a></li>
            </ul>
          </li>
          <li><a href="#练习-3" id="markdown-toc-练习-3">练习</a>            <ul>
              <li><a href="#框架" id="markdown-toc-框架">框架</a></li>
              <li><a href="#车体" id="markdown-toc-车体">车体</a></li>
              <li><a href="#添加摄像头" id="markdown-toc-添加摄像头">添加摄像头</a></li>
              <li><a href="#添加雷达" id="markdown-toc-添加雷达">添加雷达</a></li>
              <li><a href="#执行" id="markdown-toc-执行">执行</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#小结-2" id="markdown-toc-小结-2">小结</a></li>
    </ul>
  </li>
  <li><a href="#stage_ros2仿真平台" id="markdown-toc-stage_ros2仿真平台">Stage_Ros2仿真平台</a>    <ul>
      <li><a href="#stage_ros2安装与运行" id="markdown-toc-stage_ros2安装与运行">stage_ros2安装与运行</a></li>
      <li><a href="#stage_ros2仿真框架搭建" id="markdown-toc-stage_ros2仿真框架搭建">stage_ros2仿真框架搭建</a></li>
      <li><a href="#stage_ros2设置窗体" id="markdown-toc-stage_ros2设置窗体">stage_ros2设置窗体</a></li>
      <li><a href="#stage_ros2基本模型" id="markdown-toc-stage_ros2基本模型">stage_ros2基本模型</a></li>
      <li><a href="#stage_ros2添加地图" id="markdown-toc-stage_ros2添加地图">stage_ros2添加地图</a></li>
      <li><a href="#stage_ros2添加机器人" id="markdown-toc-stage_ros2添加机器人">stage_ros2添加机器人</a></li>
      <li><a href="#stage_ros2添加多机器人" id="markdown-toc-stage_ros2添加多机器人">stage_ros2添加多机器人</a></li>
    </ul>
  </li>
  <li><a href="#gezebo仿真平台" id="markdown-toc-gezebo仿真平台">Gezebo仿真平台</a>    <ul>
      <li><a href="#简述" id="markdown-toc-简述">简述</a></li>
      <li><a href="#gazebogazebo-classic" id="markdown-toc-gazebogazebo-classic">Gazebo(Gazebo Classic)</a>        <ul>
          <li><a href="#gazebo-classic安装与运行" id="markdown-toc-gazebo-classic安装与运行">Gazebo Classic安装与运行</a></li>
          <li><a href="#插件及节点服务介绍" id="markdown-toc-插件及节点服务介绍">插件及节点服务介绍</a></li>
          <li><a href="#调用服务加载模型" id="markdown-toc-调用服务加载模型">调用服务加载模型</a></li>
          <li><a href="#在不同位置加载多个机器人" id="markdown-toc-在不同位置加载多个机器人">在不同位置加载多个机器人</a></li>
          <li><a href="#查询和删除机器人" id="markdown-toc-查询和删除机器人">查询和删除机器人</a></li>
          <li><a href="#创建工作空间" id="markdown-toc-创建工作空间">创建工作空间</a></li>
          <li><a href="#插件" id="markdown-toc-插件">插件</a>            <ul>
              <li><a href="#运动控制插件里程计odom" id="markdown-toc-运动控制插件里程计odom">运动控制插件+里程计odom</a></li>
              <li><a href="#惯性计imu" id="markdown-toc-惯性计imu">惯性计IMU</a></li>
              <li><a href="#雷达laser" id="markdown-toc-雷达laser">雷达Laser</a></li>
              <li><a href="#超声波ultrasonic" id="markdown-toc-超声波ultrasonic">超声波Ultrasonic</a></li>
            </ul>
          </li>
          <li><a href="#搭建世界地图" id="markdown-toc-搭建世界地图">搭建世界地图</a></li>
          <li><a href="#框架优化" id="markdown-toc-框架优化">框架优化</a></li>
        </ul>
      </li>
      <li><a href="#ignition-gazebo" id="markdown-toc-ignition-gazebo">Ignition Gazebo</a>        <ul>
          <li><a href="#ign-gazebo安装与运行" id="markdown-toc-ign-gazebo安装与运行">Ign Gazebo安装与运行</a></li>
          <li><a href="#与ros2集成" id="markdown-toc-与ros2集成">与ROS2集成</a></li>
          <li><a href="#ros_gz_bridge" id="markdown-toc-ros_gz_bridge">ros_gz_bridge</a></li>
          <li><a href="#与ros2集成优化" id="markdown-toc-与ros2集成优化">与ROS2集成优化</a></li>
          <li><a href="#仿真环境创建-sdf文件" id="markdown-toc-仿真环境创建-sdf文件">仿真环境创建 <strong>SDF文件</strong></a></li>
          <li><a href="#igng添加模型" id="markdown-toc-igng添加模型"><strong>IgnG添加模型</strong></a></li>
          <li><a href="#igng添加机器人" id="markdown-toc-igng添加机器人">IgnG添加机器人</a></li>
          <li><a href="#-igng运动控制器实质上就是标签" id="markdown-toc--igng运动控制器实质上就是标签">   IgnG运动控制器(实质上就是<gazebo>标签)</gazebo></a></li>
          <li><a href="#ignition-gazebo仿真之传感器" id="markdown-toc-ignition-gazebo仿真之传感器">Ignition Gazebo仿真之传感器</a></li>
        </ul>
      </li>
      <li><a href="#将ign-gazebo迁移至gz-sim" id="markdown-toc-将ign-gazebo迁移至gz-sim">将Ign Gazebo迁移至Gz Sim</a>        <ul>
          <li><a href="#sdf文件" id="markdown-toc-sdf文件">SDF文件</a></li>
        </ul>
      </li>
      <li><a href="#本章小结" id="markdown-toc-本章小结">本章小结</a></li>
    </ul>
  </li>
  <li><a href="#机器人导航navigation2仿真篇" id="markdown-toc-机器人导航navigation2仿真篇">机器人导航Navigation2(仿真篇)</a>    <ul>
      <li><a href="#导航概述" id="markdown-toc-导航概述">导航概述</a>        <ul>
          <li><a href="#导航简述" id="markdown-toc-导航简述">导航简述</a></li>
          <li><a href="#导航安装" id="markdown-toc-导航安装">导航安装</a></li>
          <li><a href="#导航条件" id="markdown-toc-导航条件">导航条件</a></li>
          <li><a href="#导航参数参考" id="markdown-toc-导航参数参考">导航参数参考</a></li>
        </ul>
      </li>
      <li><a href="#slam-定位与建图" id="markdown-toc-slam-定位与建图">SLAM 定位与建图</a>        <ul>
          <li><a href="#slam_toolbox概述" id="markdown-toc-slam_toolbox概述">slam_toolbox概述</a></li>
          <li><a href="#slam_toolbox安装" id="markdown-toc-slam_toolbox安装">slam_toolbox安装</a></li>
          <li><a href="#slam_toolbox节点说明" id="markdown-toc-slam_toolbox节点说明">slam_toolbox节点说明</a></li>
          <li><a href="#slam_toolbox基本使用" id="markdown-toc-slam_toolbox基本使用">slam_toolbox基本使用</a></li>
          <li><a href="#cartographer概述" id="markdown-toc-cartographer概述">cartographer概述</a></li>
          <li><a href="#cartographer安装" id="markdown-toc-cartographer安装">cartographer安装</a></li>
          <li><a href="#cartographer节点说明" id="markdown-toc-cartographer节点说明">cartographer节点说明</a></li>
          <li><a href="#cartogarpher基本使用" id="markdown-toc-cartogarpher基本使用">cartogarpher基本使用</a></li>
        </ul>
      </li>
      <li><a href="#地图服务" id="markdown-toc-地图服务">地图服务</a>        <ul>
          <li><a href="#保存地图序列化" id="markdown-toc-保存地图序列化">保存地图(序列化)</a>            <ul>
              <li><a href="#地图保存节点说明" id="markdown-toc-地图保存节点说明">地图保存节点说明</a></li>
              <li><a href="#地图保存基本操作" id="markdown-toc-地图保存基本操作">地图保存基本操作</a></li>
              <li><a href="#地图接口" id="markdown-toc-地图接口">地图接口</a></li>
              <li><a href="#地图存储格式" id="markdown-toc-地图存储格式">地图存储格式</a></li>
            </ul>
          </li>
          <li><a href="#读取地图反序列化" id="markdown-toc-读取地图反序列化">读取地图(反序列化)</a>            <ul>
              <li><a href="#地图读取节点说明" id="markdown-toc-地图读取节点说明">地图读取节点说明</a></li>
              <li><a href="#地图读取基本操作" id="markdown-toc-地图读取基本操作">地图读取基本操作</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#amcl自适应蒙特卡洛定位" id="markdown-toc-amcl自适应蒙特卡洛定位">AMCL自适应蒙特卡洛定位</a>        <ul>
          <li><a href="#定位节点说明" id="markdown-toc-定位节点说明">定位节点说明</a></li>
          <li><a href="#定位节点基本操作" id="markdown-toc-定位节点基本操作">定位节点基本操作</a></li>
        </ul>
      </li>
      <li><a href="#导航服务器" id="markdown-toc-导航服务器">导航服务器</a>        <ul>
          <li><a href="#生命周期管理节点说明" id="markdown-toc-生命周期管理节点说明">生命周期管理节点说明</a></li>
          <li><a href="#行为树节点说明" id="markdown-toc-行为树节点说明">行为树节点说明</a></li>
          <li><a href="#规划器节点说明" id="markdown-toc-规划器节点说明">规划器节点说明</a></li>
          <li><a href="#控制器节点说明" id="markdown-toc-控制器节点说明">控制器节点说明</a></li>
          <li><a href="#恢复器节点说明" id="markdown-toc-恢复器节点说明">恢复器节点说明</a></li>
          <li><a href="#航点跟随节点说明" id="markdown-toc-航点跟随节点说明">航点跟随节点说明</a></li>
          <li><a href="#路径平滑节点说明" id="markdown-toc-路径平滑节点说明">路径平滑节点说明</a></li>
          <li><a href="#速度平滑节点说明" id="markdown-toc-速度平滑节点说明">速度平滑节点说明</a></li>
          <li><a href="#导航功能集成重要" id="markdown-toc-导航功能集成重要">导航功能集成(重要)</a></li>
          <li><a href="#自主探索slam" id="markdown-toc-自主探索slam">自主探索SLAM</a></li>
        </ul>
      </li>
      <li><a href="#多车编队" id="markdown-toc-多车编队">多车编队</a></li>
    </ul>
  </li>
  <li><a href="#ros2-serial" id="markdown-toc-ros2-serial">ROS2 Serial</a>    <ul>
      <li><a href="#ros1串口库11" id="markdown-toc-ros1串口库11">ROS1串口库1.1</a></li>
      <li><a href="#ros2串口库12" id="markdown-toc-ros2串口库12">ROS2串口库1.2</a>        <ul>
          <li><a href="#serialdriver库特点" id="markdown-toc-serialdriver库特点">SerialDriver库特点</a></li>
          <li><a href="#基于boostasio库的优点" id="markdown-toc-基于boostasio库的优点">基于Boost.Asio库的优点</a></li>
          <li><a href="#安装ros2串口包" id="markdown-toc-安装ros2串口包">安装ROS2串口包</a>            <ul>
              <li><a href="#方式一在ros2中安装" id="markdown-toc-方式一在ros2中安装"><strong>方式一：在ROS2中安装</strong></a></li>
              <li><a href="#方式二通用该方法未经测试如果你测试了请帮忙删掉本句话" id="markdown-toc-方式二通用该方法未经测试如果你测试了请帮忙删掉本句话"><strong>方式二：通用（该方法未经测试，如果你测试了，请帮忙删掉本句话）</strong></a></li>
              <li><a href="#其他准备工作" id="markdown-toc-其他准备工作">其他准备工作</a></li>
            </ul>
          </li>
          <li><a href="#初始化详解" id="markdown-toc-初始化详解">初始化详解</a></li>
          <li><a href="#发送代码详解" id="markdown-toc-发送代码详解">发送代码详解</a></li>
          <li><a href="#接收代码详解" id="markdown-toc-接收代码详解">接收代码详解</a>            <ul>
              <li><a href="#定时器方式低效不建议用" id="markdown-toc-定时器方式低效不建议用">定时器方式(低效，不建议用)</a></li>
              <li><a href="#异步方式高效" id="markdown-toc-异步方式高效">异步方式(高效)</a></li>
            </ul>
          </li>
          <li><a href="#总代码又发又收" id="markdown-toc-总代码又发又收">总代码(又发又收)</a></li>
          <li><a href="#注意事项" id="markdown-toc-注意事项">注意事项</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#机器人硬件" id="markdown-toc-机器人硬件">机器人硬件</a>    <ul>
      <li><a href="#机器人组成" id="markdown-toc-机器人组成">机器人组成</a></li>
      <li><a href="#工控机之远程开发环境" id="markdown-toc-工控机之远程开发环境">工控机之远程开发环境</a>        <ul>
          <li><a href="#远程开发ssh" id="markdown-toc-远程开发ssh">远程开发SSH</a></li>
          <li><a href="#远程访问桌面" id="markdown-toc-远程访问桌面">远程访问桌面</a></li>
        </ul>
      </li>
      <li><a href="#工控机之外接usb设备" id="markdown-toc-工控机之外接usb设备">工控机之外接USB设备</a></li>
      <li><a href="#分布式搭建-1" id="markdown-toc-分布式搭建-1">分布式搭建</a></li>
      <li><a href="#优化日志" id="markdown-toc-优化日志">优化日志</a></li>
      <li><a href="#硬件平台" id="markdown-toc-硬件平台">硬件平台</a>        <ul>
          <li><a href="#里程计odom" id="markdown-toc-里程计odom">里程计Odom</a>            <ul>
              <li><a href="#功能包创建" id="markdown-toc-功能包创建">功能包创建</a></li>
              <li><a href="#消息接口" id="markdown-toc-消息接口">消息接口</a></li>
              <li><a href="#节点主要逻辑" id="markdown-toc-节点主要逻辑">节点主要逻辑</a></li>
            </ul>
          </li>
          <li><a href="#惯性计imu-1" id="markdown-toc-惯性计imu-1">惯性计IMU</a>            <ul>
              <li><a href="#简介-4" id="markdown-toc-简介-4">简介</a></li>
              <li><a href="#消息接口-1" id="markdown-toc-消息接口-1">消息接口</a></li>
              <li><a href="#功能包创建-1" id="markdown-toc-功能包创建-1">功能包创建</a></li>
              <li><a href="#节点主要逻辑-1" id="markdown-toc-节点主要逻辑-1">节点主要逻辑</a></li>
            </ul>
          </li>
          <li><a href="#激光雷达lidar" id="markdown-toc-激光雷达lidar">激光雷达LiDAR</a></li>
          <li><a href="#相机camera" id="markdown-toc-相机camera">相机Camera</a></li>
          <li><a href="#全球定位gnss" id="markdown-toc-全球定位gnss">全球定位GNSS</a></li>
          <li><a href="#键盘控制节点" id="markdown-toc-键盘控制节点">键盘控制节点</a>            <ul>
              <li><a href="#简介-5" id="markdown-toc-简介-5">简介</a></li>
              <li><a href="#twist消息接口" id="markdown-toc-twist消息接口">Twist消息接口</a></li>
              <li><a href="#发布cmd_vel给单片机" id="markdown-toc-发布cmd_vel给单片机">发布cmd_vel给单片机</a></li>
              <li><a href="#官方节点" id="markdown-toc-官方节点">官方节点</a></li>
              <li><a href="#自定义节点" id="markdown-toc-自定义节点">自定义节点</a>                <ul>
                  <li><a href="#功能包创建-2" id="markdown-toc-功能包创建-2">功能包创建</a></li>
                  <li><a href="#节点主逻辑" id="markdown-toc-节点主逻辑">节点主逻辑</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#坐标系与话题关系" id="markdown-toc-坐标系与话题关系">坐标系与话题关系</a></li>
      <li><a href="#硬件平台进阶" id="markdown-toc-硬件平台进阶">硬件平台进阶</a>        <ul>
          <li><a href="#轮式里程计标定与融合" id="markdown-toc-轮式里程计标定与融合">轮式里程计标定与融合</a>            <ul>
              <li><a href="#轮式里程计标定" id="markdown-toc-轮式里程计标定">轮式里程计标定</a></li>
              <li><a href="#轮式里程计与imu融合" id="markdown-toc-轮式里程计与imu融合">轮式里程计与IMU融合</a></li>
            </ul>
          </li>
          <li><a href="#激光雷达工具" id="markdown-toc-激光雷达工具">激光雷达工具</a></li>
          <li><a href="#相机使用进阶" id="markdown-toc-相机使用进阶">相机使用进阶</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#机器人导航navigation2实体篇" id="markdown-toc-机器人导航navigation2实体篇">机器人导航Navigation2(实体篇)</a>    <ul>
      <li><a href="#准备工作" id="markdown-toc-准备工作">准备工作</a></li>
      <li><a href="#导航参数参考-1" id="markdown-toc-导航参数参考-1">导航参数参考</a></li>
      <li><a href="#slam-定位与建图-1" id="markdown-toc-slam-定位与建图-1">SLAM 定位与建图</a>        <ul>
          <li><a href="#slam_toolbox" id="markdown-toc-slam_toolbox">slam_toolbox</a></li>
          <li><a href="#cartographer" id="markdown-toc-cartographer">cartographer</a></li>
        </ul>
      </li>
      <li><a href="#地图服务-1" id="markdown-toc-地图服务-1">地图服务</a>        <ul>
          <li><a href="#保存地图序列化-1" id="markdown-toc-保存地图序列化-1">保存地图(序列化)</a></li>
          <li><a href="#读取地图反序列化-1" id="markdown-toc-读取地图反序列化-1">读取地图(反序列化)</a></li>
        </ul>
      </li>
      <li><a href="#amcl自适应蒙特卡洛定位-1" id="markdown-toc-amcl自适应蒙特卡洛定位-1">AMCL自适应蒙特卡洛定位</a></li>
      <li><a href="#导航服务器-1" id="markdown-toc-导航服务器-1">导航服务器</a></li>
      <li><a href="#多车编队-1" id="markdown-toc-多车编队-1">多车编队</a></li>
    </ul>
  </li>
  <li><a href="#moveit2工业机器人机械臂" id="markdown-toc-moveit2工业机器人机械臂">Moveit2工业机器人机械臂</a>    <ul>
      <li><a href="#机器人学" id="markdown-toc-机器人学">机器人学</a>        <ul>
          <li><a href="#理论基础" id="markdown-toc-理论基础">理论基础</a>            <ul>
              <li><a href="#dof自由度" id="markdown-toc-dof自由度">DOF(自由度)</a></li>
            </ul>
          </li>
          <li><a href="#数理基础" id="markdown-toc-数理基础">数理基础</a>            <ul>
              <li><a href="#位姿位置与姿态的表示" id="markdown-toc-位姿位置与姿态的表示">位姿（位置与姿态）的表示</a></li>
              <li><a href="#旋转矩阵" id="markdown-toc-旋转矩阵">旋转矩阵</a></li>
              <li><a href="#坐标变换-1" id="markdown-toc-坐标变换-1">坐标变换</a></li>
              <li><a href="#物体的变换及逆变换" id="markdown-toc-物体的变换及逆变换">物体的变换及逆变换</a></li>
            </ul>
          </li>
          <li><a href="#机械臂描述方式" id="markdown-toc-机械臂描述方式">机械臂描述方式</a></li>
          <li><a href="#描述各关节之间的关系" id="markdown-toc-描述各关节之间的关系">描述各关节之间的关系</a></li>
          <li><a href="#在joint上建立frame" id="markdown-toc-在joint上建立frame">在joint上建立frame</a></li>
          <li><a href="#link-transformations" id="markdown-toc-link-transformations">Link Transformations</a>            <ul>
              <li><a href="#理论" id="markdown-toc-理论">理论</a></li>
              <li><a href="#example" id="markdown-toc-example">Example</a>                <ul>
                  <li><a href="#平面rrr类型" id="markdown-toc-平面rrr类型">平面RRR类型</a></li>
                  <li><a href="#rpr类型" id="markdown-toc-rpr类型">RPR类型</a></li>
                  <li><a href="#中国台积电晶圆机器人prrr类型4个自由度" id="markdown-toc-中国台积电晶圆机器人prrr类型4个自由度">中国台积电晶圆机器人(PRRR类型4个自由度)</a></li>
                  <li><a href="#scara机器人rrrp类型4个自由度" id="markdown-toc-scara机器人rrrp类型4个自由度">SCARA机器人(RRRP类型4个自由度)</a></li>
                  <li><a href="#rp类型" id="markdown-toc-rp类型">RP类型</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li><a href="#执行器关节与笛卡尔空间actuator-joint-and-cartesian-spaces" id="markdown-toc-执行器关节与笛卡尔空间actuator-joint-and-cartesian-spaces">执行器关节与笛卡尔空间(Actuator Joint and Cartesian Spaces)</a></li>
          <li><a href="#正运动学" id="markdown-toc-正运动学">正运动学</a></li>
          <li><a href="#逆运动学" id="markdown-toc-逆运动学">逆运动学</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#microros-1" id="markdown-toc-microros-1">MicroROS</a></li>
  <li><a href="#ros2_control" id="markdown-toc-ros2_control">ROS2_Control</a></li>
  <li><a href="#webots仿真平台" id="markdown-toc-webots仿真平台">Webots仿真平台</a></li>
  <li><a href="#opencv-1" id="markdown-toc-opencv-1">OpenCV</a>    <ul>
      <li><a href="#opencv-2" id="markdown-toc-opencv-2">OpenCV</a></li>
      <li><a href="#cv_bridge" id="markdown-toc-cv_bridge">CV_Bridge</a>        <ul>
          <li><a href="#安装" id="markdown-toc-安装">安装</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image2.webp" alt="" /></p>

<p>欢迎各位Vinci芬奇机器人队成员来进行学习ROS2。</p>

<p>如果你想要找ROS1教程，请看<a href="https://sdutvincirobot.feishu.cn/wiki/W976wTlonibALVkmfIhcdUKYnUV">ROS机器人操作系统教程</a></p>

<h1 id="ros2介绍">ROS2介绍</h1>

<h2 id="ros2简介">ROS2简介</h2>

<p>The Robot Operating System (ROS) is a set of software libraries and tools that help you build robot applications. From drivers to state-of-the-art algorithms, and with powerful developer tools, ROS has what you need for your next robotics project. And it’s all open source.</p>

<p>机器人操作系统（ROS）是一组软件库和工具，可帮助您构建机器人应用程序。从驱动程序到最先进的算法，再加上强大的开发工具，ROS为您的下一个机器人项目提供了所需的东西。而且都是开源的。</p>

<h2 id="ros2框架">ROS2框架</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image3.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image4.webp" alt="" /></p>

<h2 id="ros2参考资料">ROS2参考资料</h2>

<h3 id="官方资料">官方资料</h3>

<p>由于ROS2参考文档太少，所以很多教程还是需要看ROS2官网：</p>

<p>https://www.ros.org/</p>

<h3 id="推荐的视频资料与配套文档"><strong>推荐的视频资料与配套文档</strong></h3>

<p>非常推荐以下资料与视频</p>

<p>https://www.bilibili.com/video/BV1VB4y137ys</p>

<p>赵虚左原版配套资料:[ROS2理论与实践-赵虚左<密码:qinghuamengshi>.pdf](https://sdutvincirobot.feishu.cn/file/GQgvbWU4UoKhbxx8DjHc9nQ1nWf)</密码:qinghuamengshi></p>

<p>暂时无法在飞书文档外展示此内容</p>

<h2 id="学习ros2需要用到的知识储备">学习ROS2需要用到的知识储备</h2>

<ol>
  <li>
    <p>需要用哪些知识？</p>

    <ol>
      <li>Linux基本操作与Shell脚本语言</li>
    </ol>

    <p>  <a href="https://sdutvincirobot.feishu.cn/docx/ZD0bd33RRovEoIxeBzncdmQEnSg">Linux基本教程</a></p>

    <p>https://www.runoob.com/linux/linux-tutorial.html</p>

    <ol>
      <li>Cmake基本使用</li>
    </ol>

    <p>  <a href="https://sdutvincirobot.feishu.cn/docx/ANgFdRtvKoCcKDxZ2ehc5Rocnwh">Linux C++编译环境配置</a></p>

    <ol>
      <li>Git基本操作</li>
    </ol>

    <p>  <a href="https://sdutvincirobot.feishu.cn/docx/B7arde6u0ob5tsxk5QOcFLG7nYd">Vinci机器人队Git入门教程</a></p>

    <ol>
      <li>C/C++语言</li>
    </ol>

    <p>  <a href="https://sdutvincirobot.feishu.cn/docx/XfSud40MgoxZkQxup0acTf6Znwb">Vinci机器人队电控组入门指导</a></p>

    <p>  <a href="https://sdutvincirobot.feishu.cn/docx/N0GAdx6IDoqnRnx1q0TcX1Wfnvc">Vinci机器人队C/C++资料</a></p>

    <ol>
      <li>Python3语言</li>
    </ol>

    <p>  <a href="https://sdutvincirobot.feishu.cn/wiki/QZL8wLeewiTmvfkczMyccAdVn0c">Vinci机器人队Python3教程</a></p>

    <p>https://www.runoob.com/python3/python3-tutorial.html</p>

    <ol>
      <li>XML语言</li>
    </ol>

    <p>https://www.runoob.com/xml/xml-tutorial.html</p>

    <ol>
      <li>YAML语言</li>
    </ol>

    <p>http://www.noobyard.com/article/p-saghdsms-mn.html</p>
  </li>
</ol>

<h2 id="安装ros2">安装ROS2</h2>

<p>ROS1安装请看<a href="https://sdutvincirobot.feishu.cn/wiki/W976wTlonibALVkmfIhcdUKYnUV">ROS机器人操作系统教程</a></p>

<h3 id="二进制包安装ros2以kubuntu-jammy-2204安装-ros-humble-为例">二进制包安装ROS2(以Kubuntu Jammy 22.04安装 <strong>ROS Humble</strong> 为例)</h3>

<p>注意:</p>

<p>截至2024年12月，强烈建议如果要用ROS2的话，一定要用ROS Humble,别用ROS Jazzy，这玩意有些区别，特别是Gazebo,几乎没啥教程的。</p>

<p>Ubuntu Jammy 22.04(LTS)请安装ROS Humble(LTS)。安装向导网站:https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html</p>

<p>Ubuntu Noble 24.04(LTS)请安装ROS Jazzy(LTS)。安装向导网站:https://docs.ros.org/en/jazzy/Installation/Ubuntu-Install-Debians.html</p>

<p>各个ROS1、ROS2版本所支持的发行版：https://www.ros.org/reps/rep-2000.html</p>

<h4 id="进入ros官网">进入ROS官网</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image5.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image6.webp" alt="" /></p>

<p>一定要安装LTS版本的ROS2</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image7.webp" alt="" /></p>

<h4 id="安装ros2前期准备工作">安装ROS2前期准备工作</h4>

<p>装LTS版本的ROS2点击使用debian包管理工具安装ROS2二进制文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image8.webp" alt="" /></p>

<p>按照ROS2官网教程在终端里输入如下命令</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image9.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image10.webp" alt="" /></p>

<p>依旧输入以下命令启动Ubuntu Universe Repo</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image11.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image12.webp" alt="" /></p>

<h4 id="换源国内源">换源(国内源)</h4>

<p>这个是官网的源，是从国外服务器下载ROS2二进制文件的，对网络有要求，所以我们要给改为国内源。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image13.webp" alt="" /></p>

<p>百度搜索北京外国语大学镜像源(亲测，北方最快的源)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image14.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image15.webp" alt="" /></p>

<p>找到ROS2，然后勾上sudo和https，选择正确的Linux发行版。在使用该命令前有可能会遇到权限不够的问题，可以先往下看，如何以root权限运行所有命令。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image16.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image17.webp" alt="" /></p>

<p>先输入sudo passwd设置root密码（Ubuntu系发行版要干的事）（debian,Fedora等发行版在装机时就已经设置过了，无需运行）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image18.webp" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>sudo passwd

su -
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后进入管理员权限下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image19.webp" alt="" /></p>

<p>挨行复制输入运行</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image20.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image21.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image22.webp" alt="" /></p>

<p>上面下载key的时候如果卡住了，那就是github又抽风了，很正常的问题，可以选择科学*上网(<a href="https://sdutvincirobot.feishu.cn/wiki/HnjswlR8NiVjVgkbn6hcAlwzn2e">科学机场教程</a>)解决，如果还解决不了，可以通过下方教程修改hosts。</p>

<p>https://blog.csdn.net/qq_40584960/article/details/117963644?sharetype=blog&amp;shareId=117963644&amp;sharerefer=APP&amp;sharesource=qq_33274985&amp;sharefrom=link</p>

<p>成功下载key之后，继续往下弄。</p>

<p>输入exit退出root模式</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">exit</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image23.webp" alt="" /></p>

<h4 id="通过apt安装ros2">通过apt安装ROS2</h4>

<p>把以下红色框框的全部在终端里敲一遍</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image24.webp" alt="" /></p>

<p>国内的镜像下载还是非常快的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image25.webp" alt="" /></p>

<h4 id="ros2基础环境变量配置">ROS2基础环境变量配置</h4>

<p>复制该行</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image26.webp" alt="" /></p>

<p>输入以下命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>vim
<span class="nb">sudo </span>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在最底部把这行加上（vim不会使用的，请自行百度）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image27.webp" alt="" /></p>

<p>刷新以下当前终端的环境变量</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'export ROSDISTRO_INDEX_URL=https://mirrors.bfsu.edu.cn/rosdistro/index-v4.yaml'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">source</span> ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image28.webp" alt="" /></p>

<h4 id="测试ros2">测试ROS2</h4>

<p>请往下翻到<strong><code class="language-plaintext highlighter-rouge">测试ROS2</code></strong>章节</p>

<h3 id="从源码安装ros2难度较高ubuntu用上面那个简单方法即可">从源码安装ROS2(难度较高，Ubuntu用上面那个简单方法即可。)</h3>

<h4 id="fedora或者rocky">Fedora或者Rocky</h4>

<p>https://www.ros.org/</p>

<p>先进官网,选择对应的版本,比如我这里选择ROS Jazzy.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image29.webp" alt="" /></p>

<p>然后选择用源码进行编译,找到对应的发行版,比如我这里是Feodra.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image30.webp" alt="" /></p>

<p>然后根据官网教程来就行</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image31.webp" alt="" /></p>

<ol>
  <li>设置区域</li>
</ol>

<p>确保你的 locale 支持 <code class="language-plaintext highlighter-rouge">UTF-8</code>。如果你在一个最小的环境（比如 docker 容器）中，locale 可能是 <code class="language-plaintext highlighter-rouge">C</code> 等最小的东西。我们使用以下设置进行测试。但是，如果您使用的是其他支持 UTF-8 的区域设置，应该没问题。</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>locale  <span class="c1"># check for UTF-8</span>

sudo dnf install langpacks-en glibc-langpack-en
export LANG=en_US.UTF-8

locale  <span class="c1"># verify settings</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>启用必须的仓库</li>
</ol>

<p>Fedora无需额外启用仓库,RHEL需要.</p>

<ol>
  <li>安装开发工具</li>
</ol>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>sudo dnf install -y \
  cmake \
  gcc-c++ \
  git \
  make \
  patch \
  python3-colcon-common-extensions \
  python3-mypy \
  python3-pip \
  python3-pydocstyle \
  python3-pytest \
  python3-pytest-cov \
  python3-pytest-mock \
  python3-pytest-repeat \
  python3-pytest-rerunfailures \
  python3-pytest-runner \
  python3-rosdep \
  python3-setuptools \
  python3-vcstool \
  wget

<span class="c1"># install some pip packages needed for testing and</span>

<span class="c1"># not available as RPMs</span>
python3 -m pip install -U --user \
  flake8-blind-except==0.1.1 \
  flake8-class-newline \
  flake8-deprecated
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p>构建ROS2</p>

    <ol>
      <li>获取ROS2源码</li>
    </ol>

    <p>  找一个要存放ROS2的文件夹,建议在/home分区找,然后在这个文件夹下打开终端.</p>

    <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>mkdir -p ./ros2_jazzy/src
cd ./ros2_jazzy
vcs import --input https://raw.githubusercontent.com/ros2/ros2/jazzy/ros2.repos src
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image32.webp" alt="" /></p>

    <ol>
      <li>更新系统</li>
    </ol>

    <p>  ROS 2 软件包构建在经常更新的 红帽系 系统上。始终建议您在安装新软件包之前确保您的系统是最新的。</p>

    <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sudo dnf upgrade
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>初始化并更换rosdep源</li>
    </ol>

    <p>https://mirrors.bfsu.edu.cn/help/rosdistro/</p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image33.webp" alt="" /></p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image34.webp" alt="" /></p>

    <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>
<span class="c1"># 手动模拟 rosdep init</span>
sudo mkdir -p /etc/ros/rosdep/sources.list.d/
sudo curl -o /etc/ros/rosdep/sources.list.d/20-default.list -L https://mirrors.bfsu.edu.cn/github-raw/ros/rosdistro/master/rosdep/sources.list.d/20-default.list

<span class="c1"># 加入环境</span>
echo 'export ROSDISTRO_INDEX_URL=https://mirrors.bfsu.edu.cn/rosdistro/index-v4.yaml' &gt;&gt; ~/.bashrc

<span class="c1"># 加载.bashrc</span>
source ~/.bashrc

<span class="c1"># 更新rosdep</span>
rosdep update
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image35.webp" alt="" /></p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image36.webp" alt="" /></p>

    <ol>
      <li>通过rosdep安装依赖</li>
    </ol>

    <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>export ROS_PYTHON_VERSION=3

rosdep install --from-paths src --ignore-src -y --skip-keys <span class="s2">"fastcdr rti-connext-dds-6.0.1 urdfdom_headers"</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image37.webp" alt="" /></p>

    <p>  如果出现上面这种错误,使用pip3安装包.</p>

    <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sudo pip3 install flake8-docstrings
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>  然后,使用下面命令忽略掉<code class="language-plaintext highlighter-rouge">flake8-docstrings</code>.</p>

    <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>rosdep install --from-paths src --ignore-src -y \
--skip-keys <span class="s2">"fastcdr rti-connext-dds-6.0.1 urdfdom_headers python3-flake8-docstrings"</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>  显示成功即可</p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image38.webp" alt="" /></p>

    <ol>
      <li>配置环境(不是红帽系的发行版不用弄)</li>
    </ol>

    <p>  如果你是红帽系系统需要下面配置</p>

    <p>  可以用下面这些命令暂时定义这些宏。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">RPM_PACKAGE_NAME</span><span class="o">=</span>qt_gui_cpp   <span class="c"># 根据包名调整（如 ros_&lt;package&gt;）</span>
<span class="nb">export </span><span class="nv">RPM_PACKAGE_VERSION</span><span class="o">=</span>1.0.0
<span class="nb">export </span><span class="nv">RPM_PACKAGE_RELEASE</span><span class="o">=</span>1
<span class="nb">export </span><span class="nv">RPM_ARCH</span><span class="o">=</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <table>
      <thead>
        <tr>
          <th style="text-align: left">变量名</th>
          <th style="text-align: left">示例值</th>
          <th style="text-align: left">用途</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left">RPM_PACKAGE_NAME</td>
          <td style="text-align: left">qt_gui_cpp</td>
          <td style="text-align: left">定义 RPM 包名</td>
        </tr>
        <tr>
          <td style="text-align: left">RPM_PACKAGE_VERSION</td>
          <td style="text-align: left">1.0.0</td>
          <td style="text-align: left">定义 RPM 包版本</td>
        </tr>
        <tr>
          <td style="text-align: left">RPM_PACKAGE_RELEASE</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">定义 RPM 包发行号</td>
        </tr>
        <tr>
          <td style="text-align: left">RPM_ARCH</td>
          <td style="text-align: left">x86_64 或 arm64</td>
          <td style="text-align: left">定义目标系统架构</td>
        </tr>
      </tbody>
    </table>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image39.webp" alt="" /></p>

    <ol>
      <li>使用colcon构建源码</li>
    </ol>

    <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build --symlink-install
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image40.webp" alt="" /></p>

    <p>  等待构建完毕,下方就是构建完毕且没错误的样子</p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image41.webp" alt="" /></p>
  </li>
  <li>
    <p>配置基础环境</p>
  </li>
</ol>

<p>找到下方文件夹,并复制路径,比如我的是<code class="language-plaintext highlighter-rouge">~/UserFloder/Applications/ros2_jazzy</code></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image42.webp" alt="" /></p>

<p>使用vim修改bash的环境</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用Insert按键进行输入</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image43.webp" alt="" /></p>

<p>添加完这两行后,按ESC,然后<code class="language-plaintext highlighter-rouge">:wq</code>保存并退出.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c1"># 刷新当前环境变量</span>
source ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>测试ROS2</li>
</ol>

<p>请往下翻到<strong><code class="language-plaintext highlighter-rouge">测试ROS2</code></strong>章节</p>

<h4 id="debian">Debian</h4>

<p>https://www.ros.org/</p>

<p>先进官网,选择对应的版本,比如我这里选择ROS Jazzy.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image44.webp" alt="" /></p>

<p>然后选择用源码进行编译,找到对应的发行版,比如我这里是Debian.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image45.webp" alt="" /></p>

<p>接下来，从下图这里开始，跟着官方教程一路敲，但是有几个需要注意的点，我这里都会写出来：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image46.webp" alt="" /></p>

<ol>
  <li>设置区域</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>locale  <span class="c"># check for UTF-8</span>

<span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install </span>locales
<span class="nb">sudo </span>locale-gen en_US en_US.UTF-8
<span class="nb">sudo </span>update-locale <span class="nv">LC_ALL</span><span class="o">=</span>en_US.UTF-8 <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
<span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8

locale  <span class="c"># verify settings</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>换源</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image47.webp" alt="" /></p>

<p>红色部分是Ubuntu要做的，我们是debian,不需要做。</p>

<p>蓝色部分我们不要用官方的，官方是国外源，我们替换成国内源。</p>

<p>先去镜像源换源：</p>

<p>https://mirrors.bfsu.edu.cn/help/ros2/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image48.webp" alt="" /></p>

<p>比如我是debian12：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>curl gnupg2
<span class="nb">sudo </span>curl <span class="nt">-sSL</span> https://raw.githubusercontent.com/ros/rosdistro/master/ros.key  <span class="nt">-o</span> /usr/share/keyrings/ros-archive-keyring.gpg

<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] https://mirrors.bfsu.edu.cn/ros2/ubuntu bookworm main"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/ros2.list <span class="o">&gt;</span> /dev/null
<span class="nb">sudo </span>apt update
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image49.webp" alt="" /></p>

<ol>
  <li>上图成功换源后，再安装ros的工具：</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image50.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
  python3-flake8-blind-except <span class="se">\</span>
  python3-flake8-class-newline <span class="se">\</span>
  python3-flake8-deprecated <span class="se">\</span>
  python3-mypy <span class="se">\</span>
  python3-pip <span class="se">\</span>
  python3-pytest <span class="se">\</span>
  python3-pytest-cov <span class="se">\</span>
  python3-pytest-mock <span class="se">\</span>
  python3-pytest-repeat <span class="se">\</span>
  python3-pytest-rerunfailures <span class="se">\</span>
  python3-pytest-runner <span class="se">\</span>
  python3-pytest-timeout <span class="se">\</span>
  ros-dev-tools
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>下载ROS2源码</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image51.webp" alt="" /></p>

<p>找一个要存放ROS2的文件夹,建议在/home分区找,然后在这个文件夹下打开终端.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>mkdir -p ./ros2_jazzy/src
cd ./ros2_jazzy
vcs import --input https://raw.githubusercontent.com/ros2/ros2/jazzy/ros2.repos src
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image52.webp" alt="" /></p>

<ol>
  <li>补依赖之前，我们需要先初始化rosdep并给rosdep换源：</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image53.webp" alt="" /></p>

<p>图中红色部分，不要跟着这个来，这个是官方源，会很慢很慢，建议用bfsu的仓库。</p>

<p>https://mirrors.bfsu.edu.cn/help/rosdistro/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image54.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image55.webp" alt="" /></p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>
<span class="c1"># 手动模拟 rosdep init</span>
sudo mkdir -p /etc/ros/rosdep/sources.list.d/
sudo curl -o /etc/ros/rosdep/sources.list.d/20-default.list -L https://mirrors.bfsu.edu.cn/github-raw/ros/rosdistro/master/rosdep/sources.list.d/20-default.list

<span class="c1"># 加入环境</span>
echo 'export ROSDISTRO_INDEX_URL=https://mirrors.bfsu.edu.cn/rosdistro/index-v4.yaml' &gt;&gt; ~/.bashrc

<span class="c1"># 加载.bashrc</span>
source ~/.bashrc

<span class="c1"># 更新rosdep</span>
rosdep update
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image56.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image57.webp" alt="" /></p>

<p>出现以上红框部分，就是成功换源了。如果你不换源，下面补依赖的过程可能会巨慢（我具体没试过，猜测），除非你科学了。</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>sudo apt upgrade

export ROS_PYTHON_VERSION=3

rosdep install --from-paths src --ignore-src -y --skip-keys <span class="s2">"fastcdr rti-connext-dds-6.0.1 urdfdom_headers"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image58.webp" alt="" /></p>

<ol>
  <li>编译ROS2</li>
</ol>

<p>在ros_jazzy目录下，打开终端，跑下面命令。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--symlink-install</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>colcon build还有以下命令，如–packages-skip和–packages-select用来跳过和单个功能包编译。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image59.webp" alt="" /></p>

<p>等待构建完毕,下方就是构建完毕且没错误的样子</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image60.webp" alt="" /></p>

<ol>
  <li>配置基础环境</li>
</ol>

<p>找到下方文件夹,并复制路径,比如我的是<code class="language-plaintext highlighter-rouge">~/UserFloder/Applications/ros2_jazzy</code></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image61.webp" alt="" /></p>

<p>使用vim修改bash的环境</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用Insert按键进行输入</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image62.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 配置ROS2环境</span>
<span class="nb">export </span><span class="nv">ROSDISTRO_INDEX_URL</span><span class="o">=</span>https://mirrors.bfsu.edu.cn/rosdistro/index-v4.yaml
<span class="nb">source</span> ~/UserFloder/Applcations/ros2_jazzy/install/setup.bash
</pre></td></tr></tbody></table></code></pre></div></div>

<p>添加完这两行后,按ESC,然后<code class="language-plaintext highlighter-rouge">:wq</code>保存并退出.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c1"># 刷新当前环境变量</span>
source ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>测试ROS2</li>
</ol>

<p>请往下翻到<strong><code class="language-plaintext highlighter-rouge">测试ROS2</code></strong>章节</p>

<h3 id="docker安装ros2">Docker安装ROS2</h3>

<p><a href="https://sdutvincirobot.feishu.cn/wiki/KRSMwKmTvivWRskSRszc2vfNnoc">Docker教程</a></p>

<h2 id="ros2安装进阶可选">ROS2安装进阶(可选)</h2>

<p>上面只是安装了最基本的ROS2包和配置了最基本的ROS2环境。</p>

<p>你安装完上面的内容后，可以选择接着进行下面的进阶配置ROS2环境。</p>

<p>也可以不安装进阶得东西，学到啥再安装啥就可以，当然也有想一劳永逸的同学，所以下面也会列出来最常用的ros2包和环境配置供大家一次性安装。</p>

<p>https://index.ros.org/?search_packages=true</p>

<h3 id="安装进阶的包">安装进阶的包</h3>

<p>以下是一些ROS2自带的导航算法和仿真环境等等的包，下方将列出这些包。</p>

<p>如果你是Ubuntu的话：</p>

<p>下面的包你全都可以用apt安装，不用手动编译！！！</p>

<p>如果你不是Ubuntu的话：</p>

<p>灰色的是上面基础教程安装过的包，</p>

<p>黄色是需要手动编译的包，</p>

<p>蓝色是不仅要手动编译，还要手动修改一些源码的包。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ROS的包（非Ubuntu的发行版基本都需要手动编译）</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">软件包/库名称</td>
      <td>功能描述</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-desktop</td>
      <td>ROS 2 Jazzy的核心桌面安装包，包含基础工具、客户端库和常用功能包，适用于桌面开发环境。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-xacro</td>
      <td>用于简化URDF（机器人描述文件）的宏语言工具，支持定义常量、数学运算和代码复用，提升可维护性。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-joint-state-publisher</td>
      <td>发布机器人关节状态（如角度、速度）的ROS节点，支持硬件接口与仿真环境的数据同步。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-joint-state-publisher-gui</td>
      <td>带图形界面的关节状态发布工具，可通过GUI手动调整关节参数，常用于调试和仿真可视化。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-gazebo-ros</td>
      <td>老版Gazebo Classic</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-gazebo-ros-pkgs</td>
      <td>老版Gazebo Classic的一些插件</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-ros-gz</td>
      <td>ROS2与新版Gazebo仿真的包，支持ROS 2与Gazebo（如Harmonic版本）的集成，用于传感器模拟和物理引擎交互。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-diagnostic-updater</td>
      <td>提供机器人系统诊断功能的工具，用于监控硬件状态、频率异常等，并通过ROS主题发布诊断信息。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-teleop-twist-keyboard</td>
      <td>ROS2的键盘控制节点</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-navigation2</td>
      <td>ROS 2的导航框架（Nav2），包含路径规划（全局/局部）、避障、行为树控制等功能，支持动态环境下的自主移动。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-nav2-bringup</td>
      <td>Nav2的启动和配置工具包，提供预定义的启动文件，简化导航系统的部署流程。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-slam-toolbox</td>
      <td>SLAM（同步定位与建图）工具包，支持实时地图构建与优化，兼容激光雷达和深度相机数据，适用于动态环境。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-cartographer</td>
      <td>Google开源的SLAM算法实现，专注于高精度2D/3D建图，适用于大规模环境。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-cartographer-ros</td>
      <td>Cartographer算法的ROS封装包，提供与ROS 2的数据接口和启动配置。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-asio-cmake-module</td>
      <td>用于集成ASIO（异步I/O库）的CMake模块，支持ROS中网络通信和异步操作的开发。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-serial-driver</td>
      <td>串口通信驱动包，支持通过串口与硬件设备（如传感器、控制器）进行数据交互。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-pcl-ros</td>
      <td>点云库（PCL）的ROS接口，提供点云数据处理、滤波、配准等功能，常用于3D感知任务。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-pointcloud-to-laserscan</td>
      <td>将三维点云转换为二维激光扫描。这对于使Kinect等设备看起来像基于2D算法的激光扫描仪（例如基于激光的SLAM）非常有用。</td>
    </tr>
    <tr>
      <td style="text-align: left">ros-humble-vision-opencv</td>
      <td>OpenCV与ROS的集成工具包，支持图像处理、特征提取、相机标定等计算机视觉任务。</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: left">非ROS包（基本都可以apt,dnf安装）</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">软件包/库名称</td>
      <td>功能描述</td>
    </tr>
    <tr>
      <td style="text-align: left">libpcl-dev</td>
      <td>点云库（PCL）的开发文件，提供点云数据结构的核心算法（如分割、配准、滤波）。</td>
    </tr>
    <tr>
      <td style="text-align: left">libeigen3-dev</td>
      <td>Eigen数学库的开发文件，用于矩阵运算、几何变换和数值计算，是SLAM和运动规划的基础依赖。</td>
    </tr>
    <tr>
      <td style="text-align: left">libpcap-dev</td>
      <td>网络数据包捕获库的开发文件，支持底层网络通信协议解析，常用于传感器数据流的实时捕获。</td>
    </tr>
    <tr>
      <td style="text-align: left">libboost-dev</td>
      <td>这个库是一个巨型库，里面有很多东西，比如Linux的串口，但是由于ROS2的串口库就是基于boost库的，所以该库不安装的话也可以正常跑，ROS2跑的是它自带的boost底层。</td>
    </tr>
    <tr>
      <td style="text-align: left">libogre-1.12-dev</td>
      <td>Gazebo的渲染引擎，在debian12中用libogre-dev搜不到，必须用libogre-1.12-dev才能搜到。</td>
    </tr>
  </tbody>
</table>

<p>但是上面这些包可以依赖于其他的包，下面这个仓库里有全部的包的仓库链接：（往后看就知道怎么用了）</p>

<p>https://github.com/ros/rosdistro/tree/master</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image63.webp" alt="" /></p>

<h4 id="apt安装方式ubuntu强烈建议">apt安装方式（Ubuntu强烈建议）</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="se">\</span>
    ros-humble-desktop <span class="se">\</span>
    ros-dev-tools <span class="se">\</span>
    ros-humble-xacro <span class="se">\</span>
    ros-humble-joint-state-publisher <span class="se">\</span>
    ros-humble-joint-state-publisher-gui <span class="se">\</span>
    ros-humble-ros-gz <span class="se">\</span>
    ros-humble-gazebo-ros <span class="se">\</span>
    ros-humble-gazebo-ros-pkgs <span class="se">\</span>
    ros-humble-imu-tools <span class="se">\</span>
    ros-humble-diagnostic-updater <span class="se">\</span>
    ros-humble-teleop-twist-keyboard <span class="se">\</span>
    ros-humble-navigation2 <span class="se">\</span>
    ros-humble-nav2-bringup <span class="se">\</span>
    ros-humble-slam-toolbox <span class="se">\</span>
    ros-humble-cartographer <span class="se">\</span>
    ros-humble-cartographer-ros <span class="se">\</span>
    ros-humble-asio-cmake-module <span class="se">\</span>
    ros-humble-serial-driver <span class="se">\</span>
    ros-humble-pcl-ros <span class="se">\</span>
    ros-humble-vision-opencv <span class="se">\</span>
    ros-humble-pointcloud-to-laserscan <span class="se">\</span>
    libpcl-dev <span class="se">\</span>
    libeigen3-dev <span class="se">\</span>
    libpcap-dev <span class="se">\</span>
    python3-colcon-common-extensions
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="源码方式非ubuntu">源码方式（非Ubuntu）</h4>

<p>以debian12为例。</p>

<h5 id="黄色的包">黄色的包</h5>

<p>以安装ros-jazzy-xacro，ros-jazzy-joint-state-publisher，ros-jazzy-joint-state-publisher-gui这三个包为例，其他的包一样操作。</p>

<p>https://index.ros.org/?search_packages=true</p>

<p>进入上面的网站，在下图中选择对应版本，比如我是JAZZY，然后在搜索框中搜索xacro，joint_state_publisher，joint_state_publisher_gui</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image64.webp" alt="" /></p>

<p>比如xacro</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image65.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image66.webp" alt="" /></p>

<p>找到对应版本的xacro，然后仓库地址是checkout URI，分支是vcs version,你可以使用git clone一个一个克隆下来，但这是巨麻烦的一件事，所以我们选择ROS2提供给我们的vcs命令进行下载包的源码。</p>

<p>首先，进入自己的ros2_jazzy文件并打开一个终端</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image67.webp" alt="" /></p>

<p>并创建一个.repos文件，文件名随便起，比如我的叫my_ros2_jazzy_packages.repos</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image68.webp" alt="" /></p>

<p>然后用vscode编辑，因为.repos使用的是yaml语言，vscode可以识别语法正确性：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image69.webp" alt="" /></p>

<p>将刚才查询的信息写上去：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="na">repositories</span><span class="pi">:</span>
  <span class="na">xacro</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/ros/xacro.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">ros2</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>用同样的方式找到其他包：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image70.webp" alt="" /></p>

<p>上图说明joint_state_publisher和joint_state_publisher_gui其实是一个仓库，所以我们只需要克隆一个仓库。</p>

<p>然后vcs version也就是git的分支是ros2。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="na">repositories</span><span class="pi">:</span>
  <span class="na">xacro</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/ros/xacro.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">ros2</span>
  <span class="na">joint_state_publisher</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/ros/joint_state_publisher.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">ros2</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>其他的包如法炮制。</p>

<p>但我先以这俩包做个例子。</p>

<p>在ros2_jazzy目录下的终端：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vcs import src &lt; my_ros2_jazzy_packages.repos
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image71.webp" alt="" /></p>

<p>可以看到下图，克隆成功了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image72.webp" alt="" /></p>

<p>接下来进行补充依赖：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rosdep <span class="nb">install</span> <span class="nt">--from-paths</span> src <span class="nt">--ignore-src</span> <span class="nt">-y</span> <span class="nt">--skip-keys</span> <span class="s2">"fastcdr rti-connext-dds-6.0.1 urdfdom_headers"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>提示下图字样，即是成功</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image73.webp" alt="" /></p>

<p>再编译安装即可：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--symlink-install</span>

<span class="c"># 或仅编译特定包</span>
colcon build <span class="nt">--packages-select</span> xacro joint_state_publisher joint_state_publisher_gui
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image74.webp" alt="" /></p>

<p>其他的包如法炮制。</p>

<p>测试：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># 重新加载环境</span>
<span class="nb">source</span> ~/.bashrc

<span class="c"># 敲命令</span>
xacro
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如下图xacro提示error即是成功，这样就是安装成功了！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image75.webp" alt="" /></p>

<p>其他的包如法炮制。</p>

<p>我也整了Humble和Jazzy的repos的文件，从官网和distribution.yaml一个个找的，你可以克隆下来直接用我整理的就可以。(但有可能部分仓库分支ROS2官方会做出修改)</p>

<p>https://github.com/tungchiahui/ros-docker/tree/main/repos</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image76.webp" alt="" /></p>

<h5 id="蓝色的包">蓝色的包</h5>

<p>蓝色的包大体的方式是和黄色一样的，只不过蓝色的包在下载完源码后，还需要修改下源码里的文件，再进行编译。</p>

<p>如vision_opencv的cv_bridge:请看下方OpenCV章节的CV_Bridge。</p>

<h4 id="常见问题">常见问题</h4>

<ol>
  <li>libogre-dev找不到</li>
</ol>

<p>Gazebo的渲染引擎，在debian12中用libogre-dev搜不到，必须用libogre-1.12-dev才能搜到。</p>

<ol>
  <li>nav2_mppi_controller里有个被当成空指针了，警告成错误了。</li>
</ol>

<p>解决在nav2_mppi_controller的cmakelists里添加上<code class="language-plaintext highlighter-rouge">add_compile_options(-Wno-error=null-dereference)</code>即可。</p>

<ol>
  <li>nav2_system_tests里有个内存重叠警告。</li>
</ol>

<p>解决在nav2_system_tests的cmakelists里添加上下面的几行即可。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="o">(</span>CMAKE_CXX_COMPILER_ID MATCHES <span class="s2">"GNU"</span><span class="o">)</span>
    add_compile_options<span class="o">(</span><span class="nt">-Wno-restrict</span><span class="o">)</span>
endif<span class="o">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>有的库在Fedora最新版没有，在旧版有。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image77.webp" alt="" /></p>

<p>https://src.fedoraproject.org/projects/rpms/%2A</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image78.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>dnf <span class="nb">install </span>python3-pykdl <span class="nt">--releasever</span><span class="o">=</span>41
<span class="nb">sudo </span>dnf <span class="nb">install </span>orocos-kdl-devel <span class="nt">--releasever</span><span class="o">=</span>41
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>有些python库在最新版系统上下不了，因为python版本过高</li>
</ol>

<p>可以使用pip3安装该库</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>pip3 <span class="nb">install </span>flake8-docstrings
</pre></td></tr></tbody></table></code></pre></div></div>

<p>但后续编译的话，需要把该库加入rosdep忽略的依赖。比如python3-flake8-docstrings的话就是下面这行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>rosdep <span class="nb">install</span> <span class="nt">--from-paths</span> src <span class="nt">--ignore-src</span> <span class="nt">-y</span> <span class="nt">--skip-keys</span> <span class="s2">"fastcdr rti-connext-dds-6.0.1 urdfdom_headers"</span>

<span class="c"># 改为</span>
rosdep <span class="nb">install</span> <span class="nt">--from-paths</span> src <span class="nt">--ignore-src</span> <span class="nt">-y</span> <span class="nt">--skip-keys</span> <span class="s2">"fastcdr rti-connext-dds-6.0.1 urdfdom_headers python3-flake8-docstrings"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image79.webp" alt="" /></p>

<h3 id="环境进阶">环境进阶</h3>

<h4 id="apt方式">Apt方式</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="err">#</span> <span class="nx">rosdep换源</span>
<span class="k">export</span> <span class="nx">ROSDISTRO_INDEX_URL</span><span class="o">=</span><span class="nx">https</span><span class="p">:</span><span class="c1">//mirrors.bfsu.edu.cn/rosdistro/index-v4.yaml</span>

<span class="err">#</span> <span class="nx">加载ROS2环境</span>
<span class="nx">source</span> <span class="o">/</span><span class="nx">opt</span><span class="o">/</span><span class="nx">ros</span><span class="o">/</span><span class="nx">jazzy</span><span class="o">/</span><span class="nx">setup</span><span class="p">.</span><span class="nx">bash</span>

<span class="err">#</span> <span class="nx">配置ROS2的分布式</span>
<span class="k">export</span> <span class="nx">ROS_DOMAIN_ID</span><span class="o">=</span><span class="mi">6</span>

<span class="err">#</span> <span class="nx">配置新版Gazebo的资源</span><span class="err">（</span><span class="nx">这里先注释</span><span class="err">，</span><span class="nx">等你学到gazebo再打开</span><span class="err">）</span>
<span class="nx">#export</span> <span class="nx">GZ_SIM_RESOURCE_PATH</span><span class="o">=</span><span class="nx">$GZ_SIM_RESOURCE_PATH</span><span class="p">:</span><span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">tungchiahui</span><span class="o">/</span><span class="nx">UserFloder</span><span class="o">/</span><span class="nx">MySource</span><span class="o">/</span><span class="nx">ROS_WS</span><span class="o">/</span><span class="nx">gazebo_models</span><span class="p">:</span><span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">tungchiahui</span><span class="o">/</span><span class="nx">UserFloder</span><span class="o">/</span><span class="nx">MySource</span><span class="o">/</span><span class="nx">ROS_WS</span><span class="o">/</span><span class="nx">ign_models</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>注意，Gazebo资源包在不同ROS2版本可能宏的名称不同，如在ROS2Humble里是IGN_GAZEBO_RESOURCE_PATH，在ROS2Jazzy里是GZ_SIM_RESOURCE_PATH。（往后的ROS2版本估计都是GZ_SIM_RESOURCE_PATH）（详见下方Gazebo教程）</p>

<h4 id="源码方式">源码方式</h4>

<p>与apt方式相同，但是需要把加载ROS2环境的那个setup.bash路径设置为你的ros2安装路径。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 加载ROS2环境</span>
<span class="nb">source</span> ~/UserFloder/Applcations/ros2_jazzy/install/setup.bash
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="测试ros2-1">测试ROS2</h2>

<h3 id="示例1">示例1</h3>

<p>打开两个终端，并分别输入如下两个红框框里的命令</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image80.webp" alt="" /></p>

<p>弹出如下程序，则测试成功。</p>

<p>对着终端按Ctrl+C可以终止程序。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image81.webp" alt="" /></p>

<h3 id="示例2">示例2</h3>

<p>乌龟作为ROS老测试项目了，必须拉出来溜溜！</p>

<p>同样开两个终端，并分别输入以下命令。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtlesim_node
ros2 run turtlesim turtle_teleop_key
</pre></td></tr></tbody></table></code></pre></div></div>

<p>鼠标点以下红色部分，然后通过小键盘的方向键可以控制乌龟运行，如果没有小键盘，可以尝试GBVCDERT等按键操控小乌龟。</p>

<p>同样地，对着终端按Ctrl+C可以终止程序。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image82.webp" alt="" /></p>

<h2 id="常见问题-1">常见问题</h2>

<h3 id="rviz2闪烁">Rviz2闪烁</h3>

<p>如果2K+的电脑安装完rviz2有显示问题，可以在.bashrc里加上下面的内容，用来让qt不缩放。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">QT_AUTO_SCREEN_SCALE_FACTOR</span><span class="o">=</span>0
<span class="nb">export </span><span class="nv">QT_SCREEN_SCALE_FACTORS</span><span class="o">=[</span>1.0]
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="入门操作">入门操作</h1>

<h2 id="简介">简介</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image83.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image84.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image85.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image86.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image87.webp" alt="" /></p>

<h2 id="终端环境搭建">终端环境搭建</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image88.webp" alt="" /></p>

<p>如果在上方安装ROS2的时候，已经将该语句添加到<code class="language-plaintext highlighter-rouge">~/.bashrc</code>了，则不必再跟着这步操作了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image89.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">source</span> /opt/ros/humble/setup.bash  <span class="c">#将ROS2环境变量配置到当前位置</span>
<span class="nb">echo</span> <span class="s2">" source /opt/ros/humble/setup.bash"</span> <span class="o">&gt;&gt;</span> ~/.bashrc    <span class="c">#每次启动终端都会运行该句</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image90.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run demo_nodes_cpp talker
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image91.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image92.webp" alt="" /></p>

<p>用ctrl+c来进行取消程序运行</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image93.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run demo_nodes_py listener
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image94.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image95.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtlesim_node
ros2 run turtlesim turtle_teleop_key
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image96.webp" alt="" /></p>

<h2 id="命令行操作">命令行操作</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image97.webp" alt="" /></p>

<p>mkdir -p 新建文件夹</p>

<p>rm -R 递归删除（删掉文件夹及里面包含的文件夹及文件）</p>

<p>touch 新建文件</p>

<p>rm 删除文件</p>

<p>cd ..退回上级目录（cd 点点）</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image98.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image99.webp" alt="" /></p>

<p>会弹提示信息，告诉我们后面要跟的参数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image100.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image101.webp" alt="" /></p>

<p>ros2 node list会把当前ROS2正在运行的节点列出来</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image102.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image103.webp" alt="" /></p>

<p>ros2 node info + /节点名 可以查看目标节点的详细情况</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image104.webp" alt="" /></p>

<p>会弹提示信息，告诉我们后面要跟的参数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image105.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image106.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image107.webp" alt="" /></p>

<p>可以通过话题来显示机器人运动的状态</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image108.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 topic pub <span class="nt">--rate</span> 1 /turtle1/cmd_vel geometry_msgs/msg/Twist <span class="s2">"{linear: {x: 2.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 1.8}}"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image109.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image110.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 service call /spawn turtlesim/srv/Spawn <span class="s2">"{x: 2, y: 2, theta: 0.2, name: ''}"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image111.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image112.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image113.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>ros2 bag record /turtle1/cmd_vel
ros2 bag play rosbag2_2022_04_11-17_35_40/rosbag2_2022_04_11-17_35_40_0.db3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 bag record + 话题</p>

<p>按Ctrl+C结束，然后录制的数据在当前终端的目录下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image114.webp" alt="" /></p>

<p>如何去复现呢？</p>

<p>ros2 bag play + 文件夹名称</p>

<h2 id="ros2-helloworldc">ROS2 HelloWorld(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image115.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image116.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image117.webp" alt="" /></p>

<p>1.创建功能包</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image118.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image119.webp" alt="" /></p>

<p>指令就是创建ros2的功能包</p>

<p>ros2 pkg create + 功能包名 + –build-type(构建类型) + ament_cmake / ament_python + –dependencies（依赖） + rclcpp(ROS2的CPP客户端) + –node-name（节点名） + 节点名</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create pkg01_helloworld_cpp <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp <span class="nt">--node-name</span> helloworld
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image120.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image121.webp" alt="" /></p>

<p>源文件自动生成了，文件名和我们指定的node name是一致的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image122.webp" alt="" /></p>

<p>这是自动生成的内容，但是和ROS2没有任何关系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image123.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image124.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image125.webp" alt="" /></p>

<p>如果依赖的库不止这一个，则再回车，</p>

<p>xxx</p>

<p>再添加下一个</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image126.webp" alt="" /></p>

<p>10行是查找包</p>

<p>12行是添加可执行的</p>

<p>add_executable 的第一个参数是 可执行文件的名字（默认和节点名一致，默认和源文件名一致） 第二个参数是源文件的名字</p>

<p>17行是为我们的可执行程序添加依赖 我们的可执行程序依赖于RCLCPP这个库</p>

<p>22行是要为我们的可执行程序设立一个安装目录，创建在了当前功能包下的lib目录，也就是 工作空间名/install/功能包名/lib</p>

<p>编辑配置文件之后编译，用cd..返回ws目录</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image127.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image128.webp" alt="" /></p>

<p>图标为绿色，是没有警告也没有错误</p>

<p>是黄色的则有警告</p>

<p>是红色的则有致命错误</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image129.webp" alt="" /></p>

<p>可执行二进制文件的路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image130.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">source install</span>/setup.bash <span class="c">#刷新环境变量</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image131.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run pkg01_helloworld_cpp helloworld
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 run 功能包名称 可执行文件名(默认和节点名一致)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image132.webp" alt="" /></p>

<p>编辑ROS2 C++源文件：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image133.webp" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>#include "rclcpp/rclcpp.hpp"

int main(int argc, char ** argv)
{
  rclcpp::init(argc,argv);

  auto node = rclcpp::Node::make_shared("helloworld_node");

  RCLCPP_INFO(node-&gt;get_logger(),"hello world!");

  rclcpp::shutdown();

  return 0;
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image134.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image135.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image136.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image137.webp" alt="" /></p>

<h2 id="ros2-helloworldpython">ROS2 HelloWorld(Python)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image138.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create pkg02_helloworld_py <span class="nt">--build-type</span> ament_python <span class="nt">--dependencies</span> rclpy <span class="nt">--node-name</span> helloworld
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 pkg create + 功能包名 + –build-type(构建类型) + ament_cmake / ament_python + –dependencies（依赖） + rclpy(ROS2的Python客户端) + –node-name（节点名） + 节点名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image139.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image140.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image141.webp" alt="" /></p>

<p>与node name和可执行二进制文件同名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image142.webp" alt="" /></p>

<p>默认这里面已经有代码，但是和ROS2无关，这是标准的python代码</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image143.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image144.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image145.webp" alt="" /></p>

<p>二进制可执行文件 映射到 源文件的main函数</p>

<p>如何编译呢？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image146.webp" alt="" /></p>

<p>先返回上一级，来到ws目录</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image147.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image148.webp" alt="" /></p>

<p>有个黄色警告，但是不影响我们使用。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image149.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">source</span> ./install/setup.bash
</pre></td></tr></tbody></table></code></pre></div></div>

<p>刷新环境变量</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run pkg02_helloworld_py helloworld
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image150.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image151.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">rclpy</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">rclpy</span><span class="p">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">rclpy</span><span class="p">.</span><span class="nf">create_node</span><span class="p">(</span><span class="sh">"</span><span class="s">helloworld_py_node</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">node</span><span class="p">.</span><span class="nf">get_logger</span><span class="p">().</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">hello world by python!</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">rclpy</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image152.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image153.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image154.webp" alt="" /></p>

<h2 id="运行优化bash终端环境">运行优化(bash终端环境)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image155.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image156.webp" alt="" /></p>

<p>要使用绝对路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image157.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image158.webp" alt="" /></p>

<p>尽量不要这么干，ROS2有一个bug，就是不同工作空间的功能包可能会调用混乱，所以先不要搞全局的运行优化。</p>

<h2 id="vscode环境搭建">VScode环境搭建</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image159.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image160.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image161.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image162.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image163.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image164.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image165.webp" alt="" /></p>

<p>看C/C++，Python，CMake，XML,YAML文件就可以代码高亮显示</p>

<p>在写一些ROS2消息的代码可以提供代码补齐等操作</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image166.webp" alt="" /></p>

<p>编写机器人模型所要用的插件，也可以进行代码补齐</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image167.webp" alt="" /></p>

<p>ROS2经常生成PDF文件，可以通过这个插件来查看</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image168.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image169.webp" alt="" /></p>

<p>ROS2插件建议等成熟之后再进行安装</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image170.webp" alt="" /></p>

<p>这个官方插件可以尝试安装</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image171.webp" alt="" /></p>

<p>人工智能代码补全</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image172.webp" alt="" /></p>

<p>MarkDown高亮</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image173.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image174.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image175.webp" alt="" /></p>

<p>虽然报错，但是程序是可以正常运行的。（主要是vscode找不到头文件）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image176.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image177.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image178.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image179.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image180.webp" alt="" /></p>

<pre><code class="language-JSON">            "includePath": [
                "${default}",
                "${workspaceFolder}/**",
                "/opt/ros/humble/include/**"
            ],
</code></pre>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image181.webp" alt="" /></p>

<p>/**代表要包含该文件夹下的所有的子集</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image182.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image183.webp" alt="" /></p>

<hr />

<p>按Ctrl + `（ESC底下的按键）把VSCODE终端打开</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image184.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image185.webp" alt="" /></p>

<p>--node-name也是可选参数，如果不配置，则不会有源文件，也不会有可执行文件到源文件的映射</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image186.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image187.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image188.webp" alt="" /></p>

<p>不需要修改，已经默认生成好了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image189.webp" alt="" /></p>

<p>再返回WS目录进行编译（但是此时编译是编译整个WS目录下的所有功能包）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image190.webp" alt="" /></p>

<p>刷新环境变量并运行</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image191.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image192.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image193.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image194.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image195.webp" alt="" /></p>

<hr />

<p>如何在一个功能包里添加多个源文件呢？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image196.webp" alt="" /></p>

<p>新建一个新文件，比如hellovscode2.cpp</p>

<p>但是此时该文件是一个孤零零的文件，他没有做任何的配置，对应的，编译完之后也不会被执行。</p>

<p>我们想编译执行该文件，必须配置相关的配置文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image197.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image198.webp" alt="" /></p>

<p>选中的这些用不着，可以删掉</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image199.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image200.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image201.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image202.webp" alt="" /></p>

<h2 id="运行优化colcon-build">运行优化(colcon build)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image203.webp" alt="" /></p>

<p>平常会全编译WS目录下的文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image204.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> xxx xxx xxx <span class="c">#可以指向多个包</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image205.webp" alt="" /></p>

<h2 id="vscode环境进阶">VScode环境进阶</h2>

<h3 id="clangd插件代码提示可选但是建议">clangd插件代码提示(可选,但是建议)</h3>

<p>https://colcon.readthedocs.io/en/released/index.html</p>

<p>由于C/C++插件在大项目里的表现简直拉胯的一批，所以我们选择使用llvm里的clangd插件来进行代码提示。</p>

<p>但clangd依赖于cmake生成一个编译信息文件，我们需要一些步骤来生成该文件。</p>

<p>由于ROS2没有像ROS1那样的一个总的规范的CMakeLists，所以配置起来没有ROS1那么方便。</p>

<ol>
  <li>
    <p>配置colcon build参数</p>

    <ol>
      <li>方法一：（不建议） <strong>每次</strong> 编译要用该命令：</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--cmake-args</span> <span class="nt">-DCMAKE_EXPORT_COMPILE_COMMANDS</span><span class="o">=</span>ON
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>  等同于在cmake文件里写上（一般不建议改cmakelists）</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">set</span><span class="o">(</span>CMAKE_EXPORT_COMPILE_COMMANDS ON<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>方法二：全局参数(更加推荐)</li>
    </ol>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir</span> ~/.colcon

vim ~/.colcon/defaults.yaml
</pre></td></tr></tbody></table></code></pre></div></div>

<p>按下<code class="language-plaintext highlighter-rouge">insert（插入）</code>按键</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image206.webp" alt="" /></p>

<p>输入下方内容</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>build:
  cmake-args:
    - <span class="nt">-DCMAKE_EXPORT_COMPILE_COMMANDS</span><span class="o">=</span>ON
</pre></td></tr></tbody></table></code></pre></div></div>

<p>按下<code class="language-plaintext highlighter-rouge">ESC</code>，并按下<code class="language-plaintext highlighter-rouge">:wq</code>,然后按下<code class="language-plaintext highlighter-rouge">Enter(回车)</code>即可成功保存。</p>

<p>在编译的时候正常用<code class="language-plaintext highlighter-rouge">colcon build</code>就可以自动启用CMAKE_EXPORT_COMPILE_COMMANDS=ON参数了。</p>

<ol>
  <li>
    <p>然后再来配置clangd插件</p>

    <ol>
      <li>
        <p>先下载clangd插件</p>

        <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image207.webp" alt="" /></p>
      </li>
      <li>
        <p>下载clangd文件</p>
      </li>
    </ol>

    <p>  按住Ctrl shift P打开搜索框</p>

    <p>  输入clangd 找到下载语言服务器这一项目，点击安装clangd（请保持良好的网络状况）</p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image208.webp" alt="" /></p>

    <ol>
      <li>接着配置clangd：</li>
    </ol>
  </li>
</ol>

<p>禁用C/C++的代码提示功能</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image209.webp" alt="" /></p>

<p>如果没有上图的弹窗，可以进行手动关闭，依然是ctrl shift P,输入settings然后找到如下图的选项</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image210.webp" alt="" /></p>

<p>找到下图这个选项，改成disabled即可。</p>

<p><code class="language-plaintext highlighter-rouge">"C_Cpp.intelliSenseEngine": "disabled"</code></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image211.webp" alt="" /></p>

<ol>
  <li>重启clangd</li>
</ol>

<p>然后ctrl shift P搜索clangd找到如下图的选项（重启clangd语言服务器前，要先colcon build）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image212.webp" alt="" /></p>

<p>代码提示就正常啦</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image213.webp" alt="" /></p>

<h2 id="安装其他工具">安装其他工具</h2>

<p>安装terminator(选装，建议，因人而异）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>terminator
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image214.webp" alt="" /></p>

<p>1，Ctrl+Shift+e 垂直平分窗口</p>

<p>这样你就有了两个独立的工作区见，对于大屏幕的人是个不错的选择。</p>

<p>2，Ctrl+Shift+o 水平平分窗口</p>

<p>如果你分了两个垂直的工作区间之后发现宽度不够了怎么办，没关系，试试把其中一个做水平分割，恩，很符合美学（呲牙笑）。</p>

<p>3，Ctrl+Shift+s 隐藏/恢复滚动条</p>

<p>一般到了这里，我会去掉鸡肋的滚动条，果然清爽了很多，至简至上，如果你想念它了，没关系再按一次滚动条就愉快的滚回来了。</p>

<p>4，F11 进入退出全屏幕</p>

<p>到了这里你会发现，如果屏幕不够大，终端显示都挤在了一起，这时你需要一键切换退出全屏幕，用F11体验一下满眼终端时专注敲代码的感觉吧。</p>

<p>5，Ctrl+Tab 在不同的工作区间循环</p>

<p>经过上面的操作，不出意外的话，我们现在已经有了三个工作区间，在一个工作区间敲完了代码，之后想跑到另一个工作区间执行，又不想用鼠标点击怎么办，利用Ctrl+Tab你可以在不同的工作区间进行循环，以便逐个区间进行操作。</p>

<p>6，Ctrl+l 清空当前窗口</p>

<p>当我们把窗口写满时，就只能在整个窗口的下面敲击命令，这时我们需要这个命令把窗口清空一下，但其实我们并不是把它真正的清空了，只是相当于翻到了一个新页面一样，如果我们用鼠标往上滚动时会发现是可以看到之前的内容的。</p>

<p>7，Ctrl+Shift+w 关闭当前工作区间</p>

<p>我们上面打开了三个工作区间，当我们不需要操作又嫌弃它占用了无用的空间时，我们就可以使用这一快捷方式把它快速关闭。</p>

<p>8，Ctrl+Shift+q</p>

<p>这也是我比较喜欢的命令，当你关掉只剩最后一个窗口时就用这一方式退出终端吧，相信我这比你用鼠标点击退出要要快的多。</p>

<p>还有一些通用的终端复制粘帖方式我就不多说了，当然还有一些其他很有用的命令，但是我在实际的工作中并没有用到，也就是掌握了这几个快捷方式已经完全满足了我日常的工作需求。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image215.webp" alt="" /></p>

<p>咱们的Git入门教程：<a href="https://sdutvincirobot.feishu.cn/docx/B7arde6u0ob5tsxk5QOcFLG7nYd">Vinci机器人队Git入门教程</a></p>

<h2 id="ros2体系框架">ROS2体系框架</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image216.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image217.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image218.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image219.webp" alt="" /></p>

<p>Client Library就是ROS2的客户端，比如rclcpp，rclpy。</p>

<p>Abstract DDS Layer是DDS抽象层，这样DDS可以实现可插拔，可以随便替换DDS模块。</p>

<p>Intra-process API是进程内通讯API，可以提高通信效率的一类API。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image220.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image221.webp" alt="" /></p>

<h1 id="工作空间与功能包">工作空间与功能包</h1>

<h2 id="工作空间简介">工作空间简介</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image222.webp" alt="" /></p>

<p>工作空间里有4个子空间</p>

<p>未来编写的代码和脚本都需要人为的放入src空间里，</p>

<p>编译所形成的中间文件会存放到build空间里，</p>

<p>可执行文件会存放到install空间里，</p>

<p>编译过程以及运行之后各种警告，错误信息等会存放到log空间里。</p>

<hr />

<p>用pip工具可以很方便的安装各种python的包</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image223.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image224.webp" alt="" /></p>

<p>国内开发者@鱼香ROS 开发的一个专门处理ROS2依赖的工具</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image225.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image226.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image227.webp" alt="" /></p>

<p>实际上就是扫描了各个功能包里的package.xml里的depend，然后查找本机是否含有该依赖，再决定是否安装。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>rosdepc init
rosdepc update
<span class="nb">cd</span> ..
rosdepc <span class="nb">install</span> <span class="nt">-i</span> <span class="nt">--from-path</span> src <span class="nt">--rosdistro</span> humble <span class="nt">-y</span>  <span class="c">#在src文件里看功能包所需依赖并查找安装</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image228.webp" alt="" /></p>

<p>后面还需要创建好几个目录，这些目录大多都是和接口文件相关的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image229.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image230.webp" alt="" /></p>

<h2 id="源文件编译">源文件编译</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image231.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image232.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image233.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image234.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">MyNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">MyNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"node_name"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"hello world!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MyNode</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image235.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image236.webp" alt="" /></p>

<p>实例化只能一个进程组织一个节点，</p>

<p>而继承可以组织多个节点。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image237.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image238.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image239.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image240.webp" alt="" /></p>

<p>初始化和资源释放的作用是什么？</p>

<p>可以往context对象里放数据，也可以取数据，类似于FreeRTOS里的消息队列，但也不完全类似，它可以存储之前的数据。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image241.webp" alt="" /></p>

<p>初始化不是仅仅只创建context对象，这是它的其中一个功能，它还有其他比较重要的功能。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image242.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image243.webp" alt="" /></p>

<p>先初始化父类构造，并传入一个节点名称。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image244.webp" alt="" /></p>

<p>智能指针忘记的可以看<a href="https://sdutvincirobot.feishu.cn/docx/N0GAdx6IDoqnRnx1q0TcX1Wfnvc">Vinci机器人队C/C++资料</a></p>

<p>智能指针是一种自动管理内存的指针，它会在不需要对象时自动释放内存。使用智能指针可以避免内存泄漏和空悬指针等问题。</p>

<p>最安全的分配和使用动态内存的方法是调用一个名为 make_shared 的标准库函数。 此函数在动态内存中分配一个对象并初始化它，返回指向此对象的 shared_ptr。与智能指针一样，make_shared 也定义在头文件 memory 中。</p>

<p>当要用 make_shared 时，必须指定想要创建的对象的类型。定义方式与模板类相同， 在函数名之后跟一个尖括号，在其中给出类型：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">// 指向一个值为42的int的shared_ptr</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>

<span class="c1">// p4 指向一个值为"9999999999"的string</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="sc">'9'</span><span class="p">);</span>

<span class="c1">// p5指向一个未初始化的int</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p5</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
<span class="c1">//当然，我们通常用 auto 定义一个对象来保存 make_shared 的结果，这种方式较为简单：</span>

<span class="c1">// p6指向一个动态分配的空vector&lt;string&gt;</span>
<span class="k">auto</span> <span class="n">p6</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&gt;</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image245.webp" alt="" /></p>

<p>用make_shared可以分配堆区内存。</p>

<h2 id="配置文件">配置文件</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image246.webp" alt="" /></p>

<p>C++</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image247.webp" alt="" /></p>

<p>Python</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image248.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image249.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image250.webp" alt="" /></p>

<p>name是功能包名称</p>

<p>version是包的版本</p>

<p>description是描述包的信息，也就是包是干嘛的</p>

<p>email是维护者的邮箱地址</p>

<p>license是我们的功能包使用的软件协议</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image251.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image252.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image253.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image254.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image255.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image256.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image257.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image258.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image259.webp" alt="" /></p>

<p>不建议直接重命名功能包的名字，当修改了文件夹名称，则里面很多文件里的配置内容也需要被修改。建议重新建。</p>

<h2 id="常用操作命令">常用操作命令</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image260.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image261.webp" alt="" /></p>

<p>ament_cmake是cmake的增强版</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image262.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image263.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image264.webp" alt="" /></p>

<p>-h 是查看帮助信息</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image265.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg executables <span class="c">#输出当前系统可执行的功能包和节点</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image266.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image267.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg executables 功能包名         <span class="c">#是输出当前包下可执行的功能包和节点</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image268.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg list <span class="c">#是输出当前系统可执行的功能包</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image269.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg prefix + 功能包名   <span class="c">#是输出该功能包的路径(重要，后面经常要用)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image270.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image271.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg xml + 功能包名   <span class="c">#是输出该功能包里的packages.xml的内容</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image272.webp" alt="" /></p>

<h2 id="核心模块_通信相关">核心模块_通信相关</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image273.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image274.webp" alt="" /></p>

<p>通信模块被封装进了功能包</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image275.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image276.webp" alt="" /></p>

<p>比如（例子）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image277.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image278.webp" alt="" /></p>

<p>会搜到巨多的内容，可以用grep进一步搜索</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image279.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image280.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image281.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image282.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image283.webp" alt="" /></p>

<p>下载分支用 -b</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image284.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image285.webp" alt="" /></p>

<p>有个警告，因为有两个功能包都叫humble了</p>

<p>如果允许覆盖需要加参数 –allow-overriding</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image286.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image287.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image288.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image289.webp" alt="" /></p>

<p>也就是helloworld那样的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image290.webp" alt="" /></p>

<h2 id="核心模块_工具相关">核心模块_工具相关</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image291.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image292.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image293.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image294.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image295.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image296.webp" alt="" /></p>

<p>命令行在某些地方比图形化工具比较好用，在远程登录时只能用命令行</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image297.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image298.webp" alt="" /></p>

<p>Lanuch文件现在在ROS2里是一个Python文件了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image299.webp" alt="" /></p>

<p>Camera是摄像头位置，Base_Link是车体的位置，Laser是激光雷达的位置。</p>

<p>雷达检测的距离信息，会转化成车体的位置信息。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image300.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image301.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image302.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image303.webp" alt="" /></p>

<h2 id="功能包">功能包</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image304.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image305.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image306.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image307.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image308.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image309.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image310.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image311.webp" alt="" /></p>

<p>python是解析型语言，不用编译，但是需要setup.py文件，setup.py主要功能是把可执行文件移动到install的。</p>

<h2 id="ros2技术支持">ROS2技术支持</h2>

<p>ROS2_Wiki官网:</p>

<p>http://wiki.ros.org/</p>

<p>ROS2_Wiki中文官网(ROS2维基百科现已支持简体中文):</p>

<p>http://wiki.ros.org/cn</p>

<p>ROS2简体中文社区：</p>

<p>http://wiki.ros.org/cn/community</p>

<p>ROS2插件索引网址:</p>

<p>https://index.ros.org/packages/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image312.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image313.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image314.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image315.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image316.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image317.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image318.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image319.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image320.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image321.webp" alt="" /></p>

<h2 id="ros2应用方向">ROS2应用方向</h2>

<p>许多ROS团队伴随ROS成长到今日，其规模已经发展到足以被认为是独立组织的程度了。在导航、机械臂、无人驾驶、无人机等诸多领域大放异彩，下面列出了其中的一些团队项目，这些项目对我们以后的进阶发展，也提供了指导。</p>

<p>ROS2社区：</p>

<p>https://www.ros.org/blog/community/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image322.webp" alt="" /></p>

<hr />

<h3 id="nav2"><strong>NAV2</strong></h3>

<p>Nav2项目继承自ROS Navigation Stack。该项目旨在可以让移动机器人从A点安全的移动到B点。它也可以应用于涉及机器人导航的其他应用，例如跟随动态点。Nav2将用于实现路径规划、运动控制、动态避障和恢复行为等一系列功能。</p>

<p>NAV2官网：</p>

<p>https://navigation.ros.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image323.webp" alt="" /></p>

<hr />

<h3 id="opencv"><strong>OpenCV</strong></h3>

<p>OpenCV（Open Source Computer Vision Library）是一个开源的计算机视觉和机器学习软件库。OpenCV旨在为计算机视觉应用程序提供通用基础架构，并加速机器感知在商业产品中的使用。OpenCV允许企业轻松地使用和修改代码。</p>

<p>OpenCV官网：</p>

<p>https://opencv.org/</p>

<p>教程：<a href="https://sdutvincirobot.feishu.cn/docx/K7gxdJjSFoAjerxTzaNcH3ufnpb">OpenCV教程</a></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image324.webp" alt="" /></p>

<hr />

<h3 id="moveit"><strong>MoveIt</strong></h3>

<p>MoveIt是一组ROS软件包， 主要包含运动规划、碰撞检测、运动学、3D感知、操作控制等功能。它可以用于构建机械臂的高级行为。MoveIt现在可以用于市面上的大多数机械臂，并被许多大公司使用。</p>

<p>https://moveit.ros.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image325.webp" alt="" /></p>

<hr />

<h3 id="the-autoware-foundation"><strong>The Autoware Foundation</strong></h3>

<p>Autoware Foundation是ROS下属的非营利组织，支持实现自动驾驶的开源项目。Autoware基金会在企业发展和学术研究之间创造协同效应，为每个人提供自动驾驶技术。</p>

<p>TAF官网:</p>

<p>https://www.autoware.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image326.webp" alt="" /></p>

<hr />

<h3 id="f1-tenth"><strong>F1 Tenth</strong></h3>

<p>F1 Tenth是将模型车改为无人车的竞速赛事，是一个由研究人员、工程师和自主系统爱好者组成的国际社区。它最初于 2016 年在宾夕法尼亚大学成立，但后来扩展到全球许多其他机构。</p>

<p>F1 Tenth官网:</p>

<p>https://f1tenth.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image327.webp" alt="" /></p>

<hr />

<h3 id="microros"><strong>microROS</strong></h3>

<p>在基于ROS的机器人应用中，micro-ROS正在弥合性能有限的微控制器和一般处理器之间的差距。micro-ROS在各种嵌入式硬件上运行，使ROS能直接应用于机器人硬件。</p>

<p>MicroROS官网:</p>

<p>https://micro.ros.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image328.webp" alt="" /></p>

<hr />

<h3 id="open-robotics"><strong>Open Robotics</strong></h3>

<p>Open Robotics与全球ROS社区合作，为机器人创建开放的软件和硬件平台，包括 ROS1、ROS2、Gazebo模拟器和Ignition模拟器。Open Robotics使用这些平台解决一些重要问题，并通过为各种客户组织提供软件和硬件开发服务来帮助其他人做同样的事情。</p>

<p>Open Robotics官网:</p>

<p>https://www.openrobotics.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image329.webp" alt="" /></p>

<hr />

<h3 id="px4"><strong>PX4</strong></h3>

<p>PX4是一款用于无人机和其他无人驾驶车辆的开源飞行控制软件。该项目为无人机开发人员提供了一套灵活的工具，用于共享技术并为无人机应用程序创建量身定制解决方案。</p>

<p>PX4官网:</p>

<p>https://px4.io/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image330.webp" alt="" /></p>

<hr />

<h3 id="ros-industrial"><strong>ROS-Industrial</strong></h3>

<p>ROS-Industrial是一个开源项目，将 ROS 软件的高级功能扩展到工业相关硬件和应用程序。</p>

<p>https://rosindustrial.org/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image331.webp" alt="" /></p>

<h1 id="四大通信">四大通信</h1>

<h2 id="通信机制简介与代码模板">通信机制简介与代码模板</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image332.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">MyNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">MyNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"mynode_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"Hello World!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MyNode</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image333.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image334.webp" alt="" /></p>

<p>https://snippet-generator.app/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image335.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image336.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image337.webp" alt="" /></p>

<pre><code class="language-JSON">{
"ROS2节点模板(C++)": {
    "prefix": "ros2_node_cpp",
    "body": [
      "#include \"rclcpp/rclcpp.hpp\"",
      "",
      "class MyNode: public rclcpp::Node",
      "{",
      "  public:",
      "    MyNode():Node(\"mynode_node_cpp\")",
      "    {",
      "      RCLCPP_INFO(this-&gt;get_logger(),\"Hello World!\");",
      "    }",
      "};",
      "",
      "int main(int argc, char ** argv)",
      "{",
      "  rclcpp::init(argc,argv);",
      "",
      "  rclcpp::spin(std::make_shared&lt;MyNode&gt;());",
      "",
      "  rclcpp::shutdown();",
      "  return 0;",
      "}"
    ],
    "description": "ROS2节点模板(C++)"
  }
}
</code></pre>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image338.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image339.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image340.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image341.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image342.webp" alt="" /></p>

<p>第一个窗口是服务端，第二个窗口是客户端。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image343.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image344.webp" alt="" /></p>

<p>通信至少要涉及两方，只是一个人算不上通信。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image345.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image346.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image347.webp" alt="" /></p>

<p>面向接口，话题是一致的，数据载体也是一致的，就可以无缝对接</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image348.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image349.webp" alt="" /></p>

<p>话题通信：只能单向传输数据</p>

<p>服务通信：双向通信，可以互为客户端和服务端，客户端给服务端发数据，服务端给客户端响应</p>

<p>动作通信：和服务通信很像，有服务端给客户端发的最终响应，但是中间也会连续发送反馈给客户端。</p>

<p>参数服务：参数服务是基于<strong>服务通信</strong>的，参数客户先发送一个请求，然后从参数服务的数据池里拿走数据。也可以更改数据池里的东西，但是不能删除。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image350.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image351.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image352.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image353.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image354.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image355.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image356.webp" alt="" /></p>

<p>参数通信不用自己定义接口文件，系统会自己弄接口文件，但是开发者是看不到该文件的，该文件被封装了。</p>

<p>我们操作的数据被封装成参数对象了。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image357.webp" alt="" /></p>

<p>ros2 pkg create + 功能包名（可以写在前面或者） + –build-type(构建类型) + ament_cmake / ament_python + –dependencies（依赖） + rclcpp(ROS2的CPP客户端) + –node-name（节点名） + 节点名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image358.webp" alt="" /></p>

<p>在src里创建功能包</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image359.webp" alt="" /></p>

<h2 id="话题通信_理论">话题通信_理论</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image360.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image361.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image362.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image363.webp" alt="" /></p>

<p>在ROS1里，node和node之间通信需要经过master，每个传输数据的node都需要在master里注册相关数据，master再将信息进行匹配。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image364.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image365.webp" alt="" /></p>

<p>一个publisher发布数据，两个subscriber都会接收到数据。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image366.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image367.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image368.webp" alt="" /></p>

<h2 id="话题通信_实验1c">话题通信_实验1(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image369.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image370.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image371.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image372.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image373.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image374.webp" alt="" /></p>

<pre><code class="language-JSON">ros2 pkg create cpp01_topic --build-type ament_cmake --dependencies rclcpp std_msgs base_interfaces_demo
</code></pre>

<p>依赖还需要std_msgs，base_interfaces_demo（这里面存放了我们自己定义的所需的接口）</p>

<p>ros2 pkg create + 功能包名（可以写在前面或者最后面） + –build-type(构建类型) + ament_cmake / ament_python + –dependencies（依赖） + rclcpp(ROS2的CPP客户端) + –node-name（节点名） + 节点名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image375.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image376.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image377.webp" alt="" /></p>

<hr />

<p>发布方</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image378.webp" alt="" /></p>

<p>定时器是用来控制发送频率的，定时器里还会执行一个回调函数timer_callback。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image379.webp" alt="" /></p>

<p>count_是计数器，每执行一次这个回调函数，count_就++；</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image380.webp" alt="" /></p>

<p>spin函数是，程序一旦执行到这里，就返回到上面，返回到上面是为了调用回调函数，如果没有这个spin函数，那么我们这个回调函数是不会被执行的。</p>

<p>以后只要我们创建完节点类对象指针，就要把该指针传入spin()函数里。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image381.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image382.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image383.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image384.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image385.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image386.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Talker</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">Talker</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"talker_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"发布节点创建！"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Talker</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时程序处于挂起状态，会一直运行，因为spin函数。</p>

<p>想结束得按Ctrl+C。</p>

<p>我们想要的类型在std_msgs里，所以要加头文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image387.webp" alt="" /></p>

<p>create_publisher()第一个入口参数是话题名称，是一个字符串</p>

<p>create_publisher()第二个入口参数是QOS服务质量有关的，是队列深度是一串数字，暂时可以先填10或者20等。</p>

<p>也就是当网络质量不好的时候，消息发不出去了，我们可以将数据先存到队列里，假设填10，最多就可以存10个数，当网络恢复了，我们就从队列里取数据，将其发出。</p>

<p>其他入口参数有默认值，可以暂时先不管。</p>

<p>返回值是一个publisher的指针。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image388.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image389.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image390.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image391.webp" alt="" /></p>

<p>创建定时器，这个函数有模板，但是模板有默认值可以不设置，</p>

<p>然后三个入口参数，</p>

<p>第一个入口参数是持续时间，也就是周期；</p>

<p>第二个入口参数是回调函数；</p>

<p>第三个入口参数有默认值，先不管。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image392.webp" alt="" /></p>

<p>使用该命名空间的优势是，在第一个入口参数，可以直接填时间+单位。</p>

<p>如果是1s就写1s，是100ms就填100ms。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image393.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image394.webp" alt="" /></p>

<p>该函数还有个返回值，返回值是定时器相关的一个指针。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image395.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image396.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image397.webp" alt="" /></p>

<p>该函数有多个重载，选择适合自己的一个函数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image398.webp" alt="" /></p>

<p>发布对象得先创建对象。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image399.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image400.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image401.webp" alt="" /></p>

<p>把count转化成字符串并发送。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image402.webp" alt="" /></p>

<p>因为它是一个std::string类型的，我们要转化成c风格的字符串。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image403.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image404.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image405.webp" alt="" /></p>

<p>尽量在构造函数的时候，给count赋初值0.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"std_msgs/msg/string.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Talker</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">Talker</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"talker_node_cpp"</span><span class="p">)</span><span class="err">，</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"发布节点创建！"</span><span class="p">);</span>
      <span class="n">publisher_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"chatter"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
      <span class="n">timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mx">1s</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Talker</span><span class="o">::</span><span class="n">on_timer</span><span class="p">,</span><span class="k">this</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">on_timer</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">auto</span> <span class="n">message</span> <span class="o">=</span> <span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="p">();</span>
      <span class="n">message</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">"hello world!"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">count</span><span class="o">++</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"发布方发布的消息：%s"</span><span class="p">,</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">publisher_</span><span class="p">;</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">timer_</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Talker</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image406.webp" alt="" /></p>

<p>但是不一定消息真的发布出去了。</p>

<p>验证方法：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 topic <span class="nb">echo</span> /xxx
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image407.webp" alt="" /></p>

<p>这样才能确定消息被发到chatter话题上了。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image408.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image409.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image410.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image411.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image412.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image413.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image414.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image415.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image416.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image417.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Listener</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Listener</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"listener_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"订阅方创建!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Listener</span><span class="o">&gt;</span><span class="p">());</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image418.webp" alt="" /></p>

<p>编译之前别忘了编辑配置文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image419.webp" alt="" /></p>

<p>依赖包已经自动生成了，不用管。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image420.webp" alt="" /></p>

<p>主要改这三大部分</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image421.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image422.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image423.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image424.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image425.webp" alt="" /></p>

<p>一共有5个入口参数，后面两个入口参数有默认值。</p>

<p>第一个入口参数是话题名称，要保证和发布方一致；</p>

<p>第二个入口参数是QoS，就是服务质量管理，队列深度，10或者20暂时随便设置，可以看看发布方那边的QoS的解释;</p>

<p>第三个入口参数是回调函数，一旦接收到数据，就触发该回调函数。</p>

<p>返回值是一个订阅对象的指针。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image426.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image427.webp" alt="" /></p>

<p>std::placeholders::_1这个是占位符，_1是指一个。这个地方本应该填入消息。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image428.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image429.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image430.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image431.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"std_msgs/msg/string.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Listener</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Listener</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"listener_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"订阅方创建!"</span><span class="p">);</span>
        <span class="n">subscription_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"chatter"</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Listener</span><span class="o">::</span><span class="n">do_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>

    <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">do_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"订阅到的消息是:%s"</span><span class="p">,</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">subscription_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Listener</span><span class="o">&gt;</span><span class="p">());</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="话题通信_自定义接口信息">话题通信_自定义接口信息</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image432.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image433.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image434.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image435.webp" alt="" /></p>

<p>构建依赖</p>

<p>执行依赖</p>

<p>当前功能包所属的功能包组</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image436.webp" alt="" /></p>

<p>find_package是要把构建依赖传递过来</p>

<p>然后还要指定当前被构建的接口文件的路径（通过这个设置，就可以把.msg转化成对应的C++和Python代码了）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image437.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image438.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image439.webp" alt="" /></p>

<p>文件名可以自定义，但是首字母必须大写</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image440.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image441.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image442.webp" alt="" /></p>

<p>写完之后test_depend报错了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image443.webp" alt="" /></p>

<p>删掉即可</p>

<p>编译依赖是rosidl开头的，我们通过grep查询一下</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg list | <span class="nb">grep</span> <span class="nt">-i</span> rosidl
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image444.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image445.webp" alt="" /></p>

<p>我们用的是这一个，直接复制过来</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image446.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image447.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image448.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image449.webp" alt="" /></p>

<p>在list里这个所属的功能包组就没有了，需要自己写rosidl_interface_packages</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image450.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image451.webp" alt="" /></p>

<p>这个依赖要和构建依赖一样</p>

<p>然后我们要为接口文件生成源码</p>

<p>需要使用rosidl_generate_interfaces函数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image452.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image453.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> base_interfaces_demo
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image454.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image455.webp" alt="" /></p>

<p>会在install空间下生成student.hpp代码</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image456.webp" alt="" /></p>

<p>以上.msg生成C++的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image457.webp" alt="" /></p>

<p>然后这个是.msg生成的Python的源码</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image458.webp" alt="" /></p>

<p>也可以通过这个方式来检测是否编译正常</p>

<p>interface是接口</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image459.webp" alt="" /></p>

<h2 id="话题通信_实验2c">话题通信_实验2(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image460.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image461.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image462.webp" alt="" /></p>

<p>新建完源文件之后，要配置CMakeLists</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image463.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image464.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image465.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image466.webp" alt="" /></p>

<p>将最基本的框架直接复制过来</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image467.webp" alt="" /></p>

<p>然后替换类的名称</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image468.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">TalkerStu</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">TalkerStu</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"talkerstu_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"发布节点创建！"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">TalkerStu</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>为了编码规范，把talkerstu_node_cpp改成小写</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image469.webp" alt="" /></p>

<p>同样的，订阅方也是需要这样操作</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image470.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ListenerStu</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">ListenerStu</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"listenerstu_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"订阅方创建!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ListenerStu</span><span class="o">&gt;</span><span class="p">());</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image471.webp" alt="" /></p>

<pre><code class="language-JSON">{
  "configurations": [
    {
      "browse": {
        "databaseFilename": "${default}",
        "limitSymbolsToIncludedHeaders": false
      },
      "includePath": [
        "/opt/ros/humble/include/**",
        "/home/tungchiahui/mysource/ros2src/3.ws01_plumbing/src/base_interfaces_demo/include/**",
        "/usr/include/**",
        "${workspaceFolder}/",
**        "${workspaceFolder}/install/base_interfaces_demo/include/**"
      ],
      "name": "ROS",
      "intelliSenseMode": "gcc-x64",
      "compilerPath": "/usr/bin/gcc",
      "cStandard": "gnu11",
      "cppStandard": "c++14"
    }
  ],
  "version": 4
}
</code></pre>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image472.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image473.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image474.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image475.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image476.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image477.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image478.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image479.webp" alt="" /></p>

<p>不要忘记字符串转成C风格的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image480.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/msg/student.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TalkerStu</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">TalkerStu</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"talkerstu_node_cpp"</span><span class="p">),</span><span class="n">age</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"发布节点创建！"</span><span class="p">);</span>
      <span class="n">publisher_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Student</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"chatter_stu"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
      <span class="n">timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mx">500ms</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TalkerStu</span><span class="o">::</span><span class="n">on_timer_callback</span><span class="p">,</span><span class="k">this</span><span class="p">));</span>
    <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">on_timer_callback</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">stu</span> <span class="o">=</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Student</span><span class="p">();</span>
        <span class="n">stu</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"葫芦娃"</span><span class="p">;</span>
        <span class="n">stu</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
        <span class="n">stu</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mf">2.20f</span><span class="p">;</span>
        <span class="n">age</span><span class="o">++</span><span class="p">;</span>
        <span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">stu</span><span class="p">);</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"发布的消息:(%s,%d,%.2f)"</span><span class="p">,</span><span class="n">stu</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">stu</span><span class="p">.</span><span class="n">age</span><span class="p">,</span><span class="n">stu</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Student</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">publisher_</span><span class="p">;</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">timer_</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">age</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">TalkerStu</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image481.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image482.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image483.webp" alt="" /></p>

<p>虽然发布方可以打印日志，但是不代表信息被正常发出去了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image484.webp" alt="" /></p>

<p>这样检验才是真能确定数据被发送出去了。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image485.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image486.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/msg/student.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Student</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ListenerStu</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">ListenerStu</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"listenerstu_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"订阅方创建!"</span><span class="p">);</span>
        <span class="n">Subscription_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"chatter_stu"</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ListenerStu</span><span class="o">::</span><span class="n">do_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">do_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">Student</span> <span class="o">&amp;</span><span class="n">stu</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"订阅的学生信息:name=%s,age=%d,height=%.2f"</span><span class="p">,</span><span class="n">stu</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">stu</span><span class="p">.</span><span class="n">age</span><span class="p">,</span><span class="n">stu</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="p">}</span>
<span class="n">_</span>    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">Subscription_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ListenerStu</span><span class="o">&gt;</span><span class="p">());</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image487.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image488.webp" alt="" /></p>

<h2 id="话题通信_rqt查看计算图">话题通信_rqt查看计算图</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image489.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image490.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image491.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image492.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image493.webp" alt="" /></p>

<p>图形化工具RQT</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image494.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image495.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image496.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image497.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image498.webp" alt="" /></p>

<h2 id="服务通信_理论">服务通信_理论</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image499.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image500.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image501.webp" alt="" /></p>

<p>只能有一个服务端，可以有多个客户端，每个客户端都可以向服务端发送请求。（当然可以有多个服务端，但是会出很多逻辑问题，这是极其不合理的，禁止使用）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image502.webp" alt="" /></p>

<h2 id="服务通信_实验1_服务端实现c">服务通信_实验1_服务端实现(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image503.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image504.webp" alt="" /></p>

<p>先开服务端，然后从客户端提交两个整数，到服务端之后，服务端会解析数据，然后求和，并返回给客户端。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image505.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image506.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image507.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image508.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp02_service <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp base_interfaces_demo <span class="nt">--node-name</span> demo01_server
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image509.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image510.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image511.webp" alt="" /></p>

<p>如果之前用过demo_interfaces_demo，那么一般是不用再配置package.xml了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image512.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image513.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image514.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image515.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image516.webp" alt="" /></p>

<p>记得文件名首字母要大写！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image517.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image518.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image519.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image520.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image521.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image522.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image523.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image524.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image525.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image526.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image527.webp" alt="" /></p>

<p>这是另一个验证方式</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image528.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image529.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">AddIntsServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"服务端节点创建！"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsServer</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image530.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image531.webp" alt="" /></p>

<p>服务端是一直要挂起的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image532.webp" alt="" /></p>

<p>客户端是执行完毕就结束返回到终端的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image533.webp" alt="" /></p>

<p>所以客户端不用调用spin函数，直接创建对象即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image534.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">AddIntsClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"客户端节点创建！"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

<span class="c1">//   rclcpp::spin(std::make_shared&lt;AddIntsClient&gt;());</span>
  <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后还要编辑配置文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image535.webp" alt="" /></p>

<p>package.xml现在不用修改</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image536.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image537.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image538.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image539.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image540.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image541.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image542.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image543.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image544.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image545.webp" alt="" /></p>

<p>有4个入口参数，但是后两个有默认值，所以我们只用管前2个。</p>

<p>第一个入口参数就是一个话题名称，字符串</p>

<p>第二个入口参数是回调函数</p>

<p>返回值是一个service类型的智能指针</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image546.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image547.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image548.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image549.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image550.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image551.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image552.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image553.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/srv/add_ints.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddInts</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AddIntsServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"服务端节点创建！"</span><span class="p">);</span>
      <span class="n">server_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_service</span><span class="o">&lt;</span><span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddInts</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"add_ints"</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">AddIntsServer</span><span class="o">::</span><span class="n">add_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="mi">2</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">add_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">AddInts</span><span class="o">::</span><span class="n">Request</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">req</span><span class="p">,</span><span class="n">AddInts</span><span class="o">::</span><span class="n">Response</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">res</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">res</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">num1</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">).</span><span class="n">num2</span><span class="p">;</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"%d + %d = %d"</span><span class="p">,</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">num1</span><span class="p">,</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">num2</span><span class="p">,</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">);</span>
    <span class="p">}</span>
<span class="n">_</span>    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Service</span><span class="o">&lt;</span><span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddInts</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">server_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsServer</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image554.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image555.webp" alt="" /></p>

<p>因为我们的客户端还没写，所以先暂时用ros2 service call这个小工具来查看服务端的情况</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image556.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 service call /add_ints base_interfaces_demo/srv/AddInts <span class="s2">"{'num1': 10,'num2': 30}"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 service call + 话题名 + 接口数据类型 + json代码(也可以理解成yaml格式的)</p>

<p>此json代码(yaml格式)格式: “{‘第一个数的名’: <strong>空格</strong> +对应数值,’第二个数的名’: <strong>空格</strong> +对应数的数值}”</p>

<h2 id="服务通信_实验1_客户端实现c">服务通信_实验1_客户端实现(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image557.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image558.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image559.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image560.webp" alt="" /></p>

<p>运行的时候后面跟了两个整形数据，</p>

<p>所以这个argc应该是等于3的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image561.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image562.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image563.webp" alt="" /></p>

<p><strong>argv[]:接收编译时的返回的argc的参数</strong></p>

<p><strong>argc是命令行总的参数个数</strong></p>

<p><strong>argv[]是argc个参数，其中第0个参数是程序的全名，以后的参数</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image564.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image565.webp" alt="" /></p>

<p>必须得保证服务器开着，并且客户端能够连接服务器，如果服务器没开，那么发送的数据会丢失，但是一般使用服务通信的都是比较重要的信息，一定不要丢失了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image566.webp" alt="" /></p>

<p>客户端发送完数据后，会产生一个响应，这里直接当函数的返回值给返回了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image567.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image568.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image569.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image570.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image571.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image572.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">AddIntsClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"客户端节点创建！"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

<span class="c1">//   rclcpp::spin(std::make_shared&lt;AddIntsClient&gt;());</span>
  <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image573.webp" alt="" /></p>

<p>这一段就应该放在节点初始化前面，防止多作一些耗资源的操作再进行判断。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image574.webp" alt="" /></p>

<p>因为RCLCPP_INFO在节点创建的前面，无法使用类和实例化方式进行get_logger，也就是无法使用this指针和节点智能指针来获取。</p>

<p>所以我们采用以下方式：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image575.webp" alt="" /></p>

<p>这种方式通过rclcpp里的get_logger，但是需要给日志起个名字，放到入口参数里，我们就叫rclcpp吧。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">AddIntsClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"客户端节点创建！"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"请提交两个整形数字!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image576.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image577.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image578.webp" alt="" /></p>

<p>如果我不提交参数，直接回车，然后这是一个异常，主函数返回值不是0</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image579.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image580.webp" alt="" /></p>

<p>也可以把INFO改成ERROR</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image581.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">AddIntsClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"客户端节点创建！"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"请提交两个整形数字!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image582.webp" alt="" /></p>

<p>一共3个入口参数，</p>

<p>第一个入口参数是话题名称，是字符串;</p>

<p>第二个入口参数和第三个入口参数有默认值，先不用管;</p>

<p>返回值是客户端的智能指针。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image583.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image584.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image585.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image586.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image587.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image588.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image589.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image590.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image591.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image592.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image593.webp" alt="" /></p>

<p>一旦Ctrl+C关闭，则会疯狂爆INFO，且程序无法停止。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image594.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image595.webp" alt="" /></p>

<p>再按Ctrl+Z可以停止程序进行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image596.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image597.webp" alt="" /></p>

<p>解决上面Ctrl+C的bug：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image598.webp" alt="" /></p>

<p>rclcpp::ok()这个是判断当前程序是否正常运行，如果正常运行，则返回true，如果不正常运行则返回false，比如按下Ctrl+C就是不正常运行。</p>

<p>当rclcpp::ok() != true的时候，就是ctrl+c按下了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image599.webp" alt="" /></p>

<p>这样直接可以让函数结束。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image600.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image601.webp" alt="" /></p>

<p>这时按下ctrl+c会爆很多错误</p>

<p>这是因为</p>

<p>this-&gt;get_logger()</p>

<p>client-&gt;get_logger()</p>

<p>rclcpp::get_logger()</p>

<p>的不同</p>

<p>这个异常和context有关，初始化的时候会创建context对象，相当于是一个容器，可以往容器里放数据，也可以在容器里取数据。</p>

<p>当前，如果我们连接失败的话，打印日志。</p>

<p>按下ctrl+c会结束我们的ROS2程序，要释放资源，比如要关闭context，这时已经关掉了context，这样，我们再从client和this来获取日志，就不行了，所以建议用rclcpp::get_logger()。</p>

<p>因为rclcpp::get_logger()的调用和context没有关系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image602.webp" alt="" /></p>

<p>这样程序就正常了！</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/srv/add_ints.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddInts</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AddIntsClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"客户端节点创建！"</span><span class="p">);</span>
      <span class="n">client_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_client</span><span class="o">&lt;</span><span class="n">AddInts</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"add_ints"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="nf">connect_server</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="n">client_</span><span class="o">-&gt;</span><span class="n">wait_for_service</span><span class="p">(</span><span class="mx">1s</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"服务连接中!"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"强行终止客户端!"</span><span class="p">);</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">AddInts</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">client_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"请提交两个整形数字!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="kt">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">connect_server</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"服务器连接失败，程序退出!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image603.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image604.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image605.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image606.webp" alt="" /></p>

<p>返回值类型有了，我们就粘贴过去，</p>

<p>因为using base_interfaces_demo::srv::AddInts所以可以省略成AddInts</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image607.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image608.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image609.webp" alt="" /></p>

<p>在主函数里要调用函数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image610.webp" alt="" /></p>

<p>atoi()是把数据转化成整形</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image611.webp" alt="" /></p>

<p>我们还要处理响应，响应有3个</p>

<p>第一个是中断，第二个是成功，第三个是超时;</p>

<p>我们一般只判断成功，其他两种情况都认为是失败。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image612.webp" alt="" /></p>

<p>第一个入口参数是 节点的智能指针</p>

<p>第二个入口参数是future</p>

<p>第三个入口参数有默认值，先不用管</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image613.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image614.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image615.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image616.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image617.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/srv/add_ints.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddInts</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AddIntsClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">AddIntsClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"add_ints_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"客户端节点创建！"</span><span class="p">);</span>
      <span class="n">client_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_client</span><span class="o">&lt;</span><span class="n">AddInts</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"add_ints"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="nf">connect_server</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="n">client_</span><span class="o">-&gt;</span><span class="n">wait_for_service</span><span class="p">(</span><span class="mx">1s</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"服务连接中!"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"强行终止客户端!"</span><span class="p">);</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">AddInts</span><span class="o">&gt;::</span><span class="n">FutureAndRequestId</span> <span class="nf">send_request</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">num1</span><span class="p">,</span><span class="kt">int32_t</span> <span class="n">num2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*
        返回值 rclcpp::Client&lt;base_interfaces_demo::srv::AddInts&gt;::FutureAndRequestId
        入口参数 async_send_request(std::shared_ptr&lt;base_interfaces_demo::srv::AddInts_Request&gt; request)  //其实就相当于AddInts::Request类型
      */</span>
      <span class="k">auto</span> <span class="n">request</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_sharedautolinkAddInts</span><span class="o">::</span><span class="n">Requestautolink</span><span class="p">();</span>
      <span class="n">request</span><span class="o">-&gt;</span><span class="n">num1</span> <span class="o">=</span> <span class="n">num1</span><span class="p">;</span>
      <span class="n">request</span><span class="o">-&gt;</span><span class="n">num2</span> <span class="o">=</span> <span class="n">num2</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">client_</span><span class="o">-&gt;</span><span class="n">async_send_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">AddInts</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">client_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"请提交两个整形数字!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">AddIntsClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="kt">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">connect_server</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="s">"服务器连接失败，程序退出!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">auto</span> <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="n">future</span><span class="p">)</span> <span class="o">==</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">FutureReturnCode</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"响应成功! sum = %d"</span><span class="p">,</span><span class="n">future</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"响应失败!"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="动作通信_理论">动作通信_理论</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image618.webp" alt="" /></p>

<p>让B一直给A返回当前机器人的状态信息，这样的行为通信更符合我们操控机器人的导航需求。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image619.webp" alt="" /></p>

<p>输入10，会累加1-10的所有数，并且会遍历1-10所有的数，并进行累加，累加是需要耗时的，假设每累加一次，耗时一秒，</p>

<p>然后为了好看出来程序运行情况，在每累加的时候，都发一个INFO，代表当前进度。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image620.webp" alt="" /></p>

<p>可以在进行任务时，把任务取消掉。</p>

<p>第一步，客户端给服务端发目标数据</p>

<p>第二步，服务端评估目标数据，并反馈给客户端这个评估结果(是否能够达到目标)</p>

<p>第三步，客户端再给服务端发最终确定的目标数据</p>

<p>第四步，服务端一直反馈给客户端执行的过程数据</p>

<p>第五步，结束之后，服务端反馈给客户端最终的结果</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image621.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image622.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image623.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image624.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image625.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image626.webp" alt="" /></p>

<p>ros2 pkg create cpp03_action –build-type ament_cmake –dependencies rclcpp rclcpp_action base_interfaces_demo –node-name demo01_action_server</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image627.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image628.webp" alt="" /></p>

<p>最顶上是请求数据，</p>

<p>中间是最终响应结果的数据，</p>

<p>最底下是连续反馈的数据。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image629.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image630.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image631.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image632.webp" alt="" /></p>

<p>depend是build depend,exe depend,export depend三者的集成。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image633.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image634.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image635.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image636.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image637.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image638.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image639.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image640.webp" alt="" /></p>

<p>ros2 interface show base_interfaces_demo/action/Progress</p>

<h2 id="动作通信_实验1_服务端实现c">动作通信_实验1_服务端实现(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image641.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ProgressActionServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ProgressActionServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"progress_action_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"action服务端创建!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProgressActionServer</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image642.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ProgressActionClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ProgressActionClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"progress_action_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"action客户端创建!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProgressActionClient</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image643.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image644.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image645.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image646.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image647.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image648.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image649.webp" alt="" /></p>

<p>有俩模板，我们只需要设置action就行了，就是我们的动作接口类型。</p>

<p>第一个参数是node，在class里就用this指针，</p>

<p>第二个参数是话题，字符串，</p>

<p>第三个参数是回调函数用来处理目标值的，</p>

<p>第四个参数是回调函数用来处理取消请求的，</p>

<p>第五个参数是接收目标值之后，该回调函数生成连续反馈，</p>

<p>第六、第七个参数有默认值，先不管，</p>

<p>返回值是action智能指针。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image650.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image651.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image652.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image653.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image654.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image655.webp" alt="" /></p>

<p>Goal_callback解析：</p>

<p>第一个参数是GoalUUID，</p>

<p>第二个参数是我们动作接口下的Goal，</p>

<p>返回值是goalresponse，用的命名空间是rclcpp_action，底下封装了3个常量，</p>

<p>第一个是接收并马上执行，</p>

<p>第二个是接收并推迟执行，</p>

<p>第三个是拒绝。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image656.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image657.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image658.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image659.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image660.webp" alt="" /></p>

<p>报错原因是没加占位符</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image661.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image662.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"rclcpp_action/rclcpp_action.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/action/progress.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">action</span><span class="o">::</span><span class="n">Progress</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_2</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProgressActionServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ProgressActionServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"progress_action_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"action服务端创建!"</span><span class="p">);</span>
      <span class="cm">/*
      rclcpp_action::Server&lt;ActionT&gt;::SharedPtr create_server&lt;ActionT,
      NodeT&gt;(NodeT node,
      const std::string &amp;name,
      rclcpp_action::Server&lt;ActionT&gt;::GoalCallback handle_goal,
      rclcpp_action::Server&lt;ActionT&gt;::CancelCallback handle_cancel,
      rclcpp_action::Server&lt;ActionT&gt;::AcceptedCallback handle_accepted,
      const rcl_action_server_options_t &amp;options = rcl_action_server_get_default_options(),
      rclcpp::CallbackGroup::SharedPtr group = nullptr)
      */</span>
      <span class="n">server_</span> <span class="o">=</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">create_server</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="k">this</span><span class="p">,</span>
        <span class="s">"get_sum_topic"</span><span class="p">,</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionServer</span><span class="o">::</span><span class="n">handle_goal_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionServer</span><span class="o">::</span><span class="n">handle_cancel_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionServer</span><span class="o">::</span><span class="n">handle_accepted_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//std::function&lt;GoalResponse(const GoalUUID &amp;, std::shared_ptr&lt;const typename ActionT::Goal&gt;)&gt;</span>
    <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span> <span class="nf">handle_goal_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalUUID</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Progress</span><span class="o">::</span><span class="n">Goal</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="p">{</span>

      <span class="k">return</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span><span class="o">::</span><span class="n">ACCEPT_AND_EXECUTE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//std::function&lt;CancelResponse(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;</span>
    <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">CancelResponse</span> <span class="nf">handle_cancel_callback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ServerGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;&gt;</span> <span class="n">goal_handle</span><span class="p">)</span>
    <span class="p">{</span>

      <span class="k">return</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">CancelResponse</span><span class="o">::</span><span class="n">ACCEPT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//std::function&lt;void (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;</span>
    <span class="kt">void</span> <span class="nf">handle_accepted_callback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ServerGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;&gt;</span> <span class="n">goal_handle</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">Server</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">server_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProgressActionServer</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image663.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image664.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image665.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image666.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 action send_goal /get_sum_topic base_interfaces_demo/action/Progress <span class="nt">-f</span> <span class="s2">"{'num': 10}"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 action send_goal /话题名称 + 接口类型 + -f + 参数</p>

<p>-f是连续反馈，就是可以获取连续反馈。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image667.webp" alt="" /></p>

<p>发送目标值为10</p>

<p>然后为我们客户端设置了一个ID，因为可能有多个客户端都访问这个服务端，所以我们要给每个客户端都设置一个唯一的ID</p>

<p>然后结果是0</p>

<p>因为我们程序暂时啥都还没写。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image668.webp" alt="" /></p>

<p>uuid就是客户端ID，在此时没有使用，那就用(void)uuid，因为如果不用，编译器可能报警告。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image669.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image670.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image671.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image672.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image673.webp" alt="" /></p>

<hr />

<p>我们的这个任务是可以正常被取消的，所以直接return accept就可以，根据不同任务需求来在函数里做不同的事。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image674.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image675.webp" alt="" /></p>

<hr />

<p>因为我们的连续反馈和最终响应的生成是耗时操作，为了避免主逻辑出现阻塞，建议单独再开一个线程。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image676.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image677.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image678.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image679.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image680.webp" alt="" /></p>

<p>生成连续反馈的API，需要传参，传入的参数就是Progress里的Feedback对象。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image681.webp" alt="" /></p>

<p>get_goal()可以获取目标值</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image682.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image683.webp" alt="" /></p>

<p>因为这是个耗时操作，为了看出效果来，所以咱们每次循环的时候都给设置一下休眠。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image684.webp" alt="" /></p>

<p>1.0是指1Hz，也就是每隔1秒执行一次。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image685.webp" alt="" /></p>

<p>因为1Hz，所以我们这个rate.sleep()每次都会休眠1秒钟;</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image686.webp" alt="" /></p>

<p>生成最终结果的API，需要传参，传入的参数就是Progress里的Result对象。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image687.webp" alt="" /></p>

<p>ok()函数的返回值：如果正常运行，则返回true，如果不正常运行则返回false</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image688.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image689.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image690.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image691.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image692.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image693.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image694.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image695.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image696.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image697.webp" alt="" /></p>

<hr />

<p>bug：当我们终止客户端之后，服务端没有停止运行。服务端要一直执行到程序结束。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image698.webp" alt="" /></p>

<p>bug解决思路：</p>

<p>接收到取消请求后，就是中断我的主逻辑，也就是execute_callback被关闭，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image699.webp" alt="" /></p>

<p>这个函数返回值是布尔值，如果接收到了取消请求就返回true，否则返回false，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image700.webp" alt="" /></p>

<p>我们取消之后，其实仍然可以向客户端反应最终的结果，用canceled函数，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image701.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image702.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image703.webp" alt="" /></p>

<p>要把定义result放在前面。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image704.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image705.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image706.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"rclcpp_action/rclcpp_action.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/action/progress.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">action</span><span class="o">::</span><span class="n">Progress</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_2</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProgressActionServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ProgressActionServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"progress_action_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"action服务端创建!"</span><span class="p">);</span>
      <span class="cm">/*
      rclcpp_action::Server&lt;ActionT&gt;::SharedPtr create_server&lt;ActionT,
      NodeT&gt;(NodeT node,
      const std::string &amp;name,
      rclcpp_action::Server&lt;ActionT&gt;::GoalCallback handle_goal,
      rclcpp_action::Server&lt;ActionT&gt;::CancelCallback handle_cancel,
      rclcpp_action::Server&lt;ActionT&gt;::AcceptedCallback handle_accepted,
      const rcl_action_server_options_t &amp;options = rcl_action_server_get_default_options(),
      rclcpp::CallbackGroup::SharedPtr group = nullptr)
      */</span>
      <span class="n">server_</span> <span class="o">=</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">create_server</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="k">this</span><span class="p">,</span>
        <span class="s">"get_sum_topic"</span><span class="p">,</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionServer</span><span class="o">::</span><span class="n">handle_goal_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionServer</span><span class="o">::</span><span class="n">handle_cancel_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionServer</span><span class="o">::</span><span class="n">handle_accepted_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//std::function&lt;GoalResponse(const GoalUUID &amp;, std::shared_ptr&lt;const typename ActionT::Goal&gt;)&gt;</span>
    <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span> <span class="nf">handle_goal_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalUUID</span> <span class="o">&amp;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Progress</span><span class="o">::</span><span class="n">Goal</span><span class="o">&gt;</span> <span class="n">goal</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">uuid</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">goal</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"提交的目标值必须大于1!"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span><span class="o">::</span><span class="n">REJECT</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"提交的目标值合法!"</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span><span class="o">::</span><span class="n">ACCEPT_AND_EXECUTE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//std::function&lt;CancelResponse(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;</span>
    <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">CancelResponse</span> <span class="nf">handle_cancel_callback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ServerGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;&gt;</span> <span class="n">goal_handle</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">goal_handle</span><span class="p">;</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"接收到任务取消请求!"</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">CancelResponse</span><span class="o">::</span><span class="n">ACCEPT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//std::function&lt;void (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;</span>
    <span class="kt">void</span> <span class="nf">execute_callback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ServerGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;&gt;</span> <span class="n">goal_handle</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">//void publish_feedback(std::shared_ptr&lt;base_interfaces_demo::action::Progress_Feedback&gt; feedback_msg)</span>
      <span class="c1">//goal_handle-&gt;publish_feedback();</span>
      <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">get_goal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">auto</span> <span class="n">feedback</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_sharedautolinkProgress</span><span class="o">::</span><span class="n">Feedbackautolink</span><span class="p">();</span>
      <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_sharedautolinkProgress</span><span class="o">::</span><span class="n">Resultautolink</span><span class="p">();</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Rate</span> <span class="n">rate</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">num</span><span class="p">;</span>
        <span class="n">feedback</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span><span class="p">;</span>

        <span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">publish_feedback</span><span class="p">(</span><span class="n">feedback</span><span class="p">);</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"连续反馈中，当前进度为:%.2f"</span><span class="p">,</span><span class="n">progress</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">is_canceling</span><span class="p">()</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">result</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
          <span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">canceled</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
          <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"任务被取消了!"</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="c1">//void succeed(std::shared_ptr&lt;base_interfaces_demo::action::Progress_Result&gt; result_msg)</span>
      <span class="c1">//goal_handle-&gt;succeed();</span>

      <span class="k">if</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">()</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">result</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
        <span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">succeed</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"最终响应结果为:%d"</span><span class="p">,</span><span class="n">sum</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">handle_accepted_callback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ServerGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;&gt;</span> <span class="n">goal_handle</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionServer</span><span class="o">::</span><span class="n">execute_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">goal_handle</span><span class="p">)).</span><span class="n">detach</span><span class="p">();</span>
    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">Server</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">server_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProgressActionServer</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="动作通信_实验1_客户端实现c">动作通信_实验1_客户端实现(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image707.webp" alt="" /></p>

<p>这条红色的线是在action_client帮我们封装好的，所以可以不用管。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image708.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ProgressActionClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ProgressActionClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"progress_action_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"action客户端创建!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcppp"</span><span class="p">),</span><span class="s">"请输入一个整形数字!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProgressActionClient</span><span class="o">&gt;</span><span class="p">());</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image709.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image710.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image711.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image712.webp" alt="" /></p>

<p>第一个入口参数是node</p>

<p>第二个入口参数是话题名称，字符串</p>

<p>第三个入口参数和第四个入口参数都有默认值</p>

<p>返回值是客户端智能指针。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image713.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image714.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image715.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image716.webp" alt="" /></p>

<p>需要把一步分成两步。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image717.webp" alt="" /></p>

<p>再把send_goal函数调用一下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image718.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image719.webp" alt="" /></p>

<p>async_send_goal是异步发送目标值</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image720.webp" alt="" /></p>

<p>第一个入口参数是我们接口文件里的目标值</p>

<p>第二个入口参数是发送目标选项对象，我们可以设置这个目标发送过去之后，我们需要处理的一些回调函数</p>

<p>返回值是</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image721.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image722.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image723.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image724.webp" alt="" /></p>

<p>先不管其他的，先把函数随便定义上，什么返回值，入口参数都是void，先不让程序报错。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image725.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image726.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image727.webp" alt="" /></p>

<p>得知，</p>

<p>GoalResponseCallback返回值是void，入口参数是goalhandle，goalhandle在本图的上面，是clientgoalhandle，然后这个clientgoalhandle属于rclcpp_action工作空间</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image728.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image729.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image730.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image731.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image732.webp" alt="" /></p>

<p>返回值是void</p>

<p>第一个入口参数是clientgoalhandle</p>

<p>第二个入口参数是feedback</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image733.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image734.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image735.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image736.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image737.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image738.webp" alt="" /></p>

<p>发送一个数值给服务端，服务端要先拿到目标值进行判断，判断该目标值是否可以被接收，或者被拒绝，再把处理结果响应给客户端。</p>

<p>如果说这个目标值可处理，那么goal_handle里是有内容的;</p>

<p>如果不可以被处理，那么goal_handle是一个nullptr空指针。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image739.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image740.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image741.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image742.webp" alt="" /></p>

<hr />

<p>接下来处理反馈数据：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image743.webp" alt="" /></p>

<p>如果我们只是解析反馈的数据，那么goal_handle是用不上的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image744.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image745.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image746.webp" alt="" /></p>

<p>需要用俩%来转译%，如上图是打印百分比数据的案例。</p>

<p>假设progress_int是50，则会输出50%。</p>

<p>如果只想打印一个%，那就需要%%来转译。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image747.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image748.webp" alt="" /></p>

<p>回调函数是可能会数据丢失的。这是正常现象。</p>

<hr />

<p>最终响应：</p>

<p>这个result最终结果的状态是不一定的，有可能任务被取消了，或被终止了，也有可能任务正常运行了。</p>

<p>所以我们要通过状态码来判断状态。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image749.webp" alt="" /></p>

<p>第一个是被强行终止</p>

<p>第二个是取消</p>

<p>第三个是成功</p>

<p>第四个是未知</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image750.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image751.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image752.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"rclcpp_action/rclcpp_action.hpp"</span><span class="cp">
#include</span> <span class="cpf">"base_interfaces_demo/action/progress.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">base_interfaces_demo</span><span class="o">::</span><span class="n">action</span><span class="o">::</span><span class="n">Progress</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_2</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProgressActionClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ProgressActionClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"progress_action_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"action客户端创建!"</span><span class="p">);</span>
      <span class="cm">/*
      rclcpp_action::Client&lt;ActionT&gt;::SharedPtr create_client&lt;ActionT,
      NodeT&gt;(NodeT node, const std::string &amp;name,
      rclcpp::CallbackGroup::SharedPtr group = nullptr,
      const rcl_action_client_options_t &amp;options = rcl_action_client_get_default_options())
      */</span>
      <span class="n">client_</span> <span class="o">=</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">create_client</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s">"get_sum_topic"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">send_goal</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">num</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">client_</span><span class="o">-&gt;</span><span class="n">wait_for_action_server</span><span class="p">(</span><span class="mx">1s</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"服务连接失败!"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/*
      std::shared_future&lt;rclcpp_action::ClientGoalHandle&lt;base_interfaces_demo::action::Progress&gt;::SharedPtr&gt;
      async_send_goal(const base_interfaces_demo::action::Progress::Goal &amp;goal,
      const rclcpp_action::Client&lt;base_interfaces_demo::action::Progress&gt;::SendGoalOptions &amp;options)
      */</span>
      <span class="k">auto</span> <span class="n">goal</span> <span class="o">=</span> <span class="n">Progress</span><span class="o">::</span><span class="n">Goal</span><span class="p">();</span>
      <span class="n">goal</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>

      <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;::</span><span class="n">SendGoalOptions</span> <span class="n">options</span><span class="p">;</span>
      <span class="n">options</span><span class="p">.</span><span class="n">goal_response_callback</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionClient</span><span class="o">::</span><span class="n">goal_response_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">);</span>
      <span class="n">options</span><span class="p">.</span><span class="n">feedback_callback</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionClient</span><span class="o">::</span><span class="n">feedback_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">);</span>
      <span class="n">options</span><span class="p">.</span><span class="n">result_callback</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProgressActionClient</span><span class="o">::</span><span class="n">result_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">);</span>

      <span class="k">auto</span> <span class="n">future</span> <span class="o">=</span> <span class="n">client_</span><span class="o">-&gt;</span><span class="n">async_send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span><span class="n">options</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">goal_response_callback</span><span class="p">(</span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ClientGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">goal_handle</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">goal_handle</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"目标请求被服务端拒绝!"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"目标处理中!"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">feedback_callback</span><span class="p">(</span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ClientGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">goal_handle</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Progress</span><span class="o">::</span><span class="n">Feedback</span><span class="o">&gt;</span> <span class="n">feedback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">goal_handle</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">feedback</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">progress_int</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">progress</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"当前进度为:%d%%"</span><span class="p">,</span><span class="n">progress_int</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">result_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ClientGoalHandle</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;::</span><span class="n">WrappedResult</span> <span class="o">&amp;</span> <span class="n">result</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ResultCode</span><span class="o">::</span><span class="n">SUCCEEDED</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"最终结果为:%d"</span><span class="p">,</span><span class="n">result</span><span class="p">.</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ResultCode</span><span class="o">::</span><span class="n">ABORTED</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"过程被中断!"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ResultCode</span><span class="o">::</span><span class="n">CANCELED</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"任务被取消!"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"未知异常!"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp_action</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">Progress</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">client_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcppp"</span><span class="p">),</span><span class="s">"请输入一个整形数字!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProgressActionClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">node</span><span class="o">-&gt;</span><span class="n">send_goal</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image753.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image754.webp" alt="" /></p>

<p>此时我们取消客户端，反而服务端还在运行，这里的ctrl+c只是结束了我们的客户端，而不是指挥我们的客户端去下发取消请求指令，我们只有去捕获一下我们的键盘才能完成取消请求指令的发送。</p>

<hr />

<p>修复bug:</p>

<p>还没修复好</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">// 发送取消请求auto future_cancel = client_-&gt;async_cancel_goal(goal_handle);</span>
<span class="n">rclcpp</span><span class="o">::</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_base_interface</span><span class="p">(),</span> <span class="n">future_cancel</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">future_cancel</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="mx">1s</span><span class="p">)</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">future_status</span><span class="o">::</span><span class="n">ready</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"终止请求已发送!"</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
  <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"无法发送终止请求..."</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="参数服务_理论与api介绍c">参数服务_理论与API介绍(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image755.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image756.webp" alt="" /></p>

<p>当然还有特殊情况，比如把参数设置为私有的。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image757.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image758.webp" alt="" /></p>

<p>其他通信需要自己弄接口文件，但是参数服务不用自己弄接口文件，ROS2已经封装好了API，所以我们只需要调用API即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image759.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image760.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image761.webp" alt="" /></p>

<p>只是想展示一下API，所以先创建参数功能包展示下API，先不创建客户端和服务端。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image762.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image763.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image764.webp" alt="" /></p>

<p>rclcpp::parameter 对象(键,值);</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image765.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image766.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image767.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image768.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image769.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image770.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image771.webp" alt="" /></p>

<p>该函数是给parameter的值赋值的，有18个重载，各种类型。</p>

<p>其中空是说不给赋值，这样只有键，没有值。</p>

<h2 id="参数服务_实验1_服务端c">参数服务_实验1_服务端(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image772.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image773.webp" alt="" /></p>

<p>这里有差异，在Node里传入了第二个参数，这句是专门用来允许删除参数的。undeclared解除声明。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image774.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image775.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image776.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image777.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image778.webp" alt="" /></p>

<p>只有查询和修改的接口API，并没有新增和删除的API，这是ROS2根据安全考虑的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image779.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image780.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image781.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image782.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ParamServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ParamServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"param_server_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"参数服务端搭建!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ParamServer</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ParamClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ParamClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"param_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"参数客户端搭建!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ParamClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image783.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image784.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image785.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image786.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image787.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image788.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image789.webp" alt="" /></p>

<p>链式编程。</p>

<p>一个普通的节点就可以当参数服务端，不需要另行创建参数服务端。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image790.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image791.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ParamServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ParamServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"param_server_node_cpp"</span><span class="p">,</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">NodeOptions</span><span class="p">().</span><span class="n">allow_undeclared_parameters</span><span class="p">(</span><span class="nb">true</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"参数服务端搭建!"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">create_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------增操作--------------"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">get_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------查操作--------------"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">update_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------改操作--------------"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">delete_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------删操作--------------"</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ParamServer</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">node</span><span class="o">-&gt;</span><span class="n">create_param</span><span class="p">();</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">get_param</span><span class="p">();</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">update_param</span><span class="p">();</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">delete_param</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image792.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image793.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image794.webp" alt="" /></p>

<p>ros2 param list</p>

<p>查询所有节点里的所有参数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image795.webp" alt="" /></p>

<p>ros2 param get /节点名称 参数键名 来查看参数的值</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image796.webp" alt="" /></p>

<p>可以通过键来查询参数的值</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image797.webp" alt="" /></p>

<p>带复数形式的函数可以通过由键组成的容器来获取一些参数对象。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image798.webp" alt="" /></p>

<p>来判断是否有该参数的，入口参数也是键，返回值是布尔值。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image799.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image800.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image801.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image802.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image803.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image804.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image805.webp" alt="" /></p>

<p>需要传入parameter对象。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image806.webp" alt="" /></p>

<p>我们覆盖掉旧值即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image807.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image808.webp" alt="" /></p>

<p>通过set_parameter也可以创建参数,但是必须声明allow_undeclared_parameters(true)。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image809.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image810.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image811.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image812.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image813.webp" alt="" /></p>

<p>这种声明的参数不可以被删除，只能删除未声明但设置的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image814.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image815.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ParamServer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ParamServer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"param_server_node_cpp"</span><span class="p">,</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">NodeOptions</span><span class="p">().</span><span class="n">allow_undeclared_parameters</span><span class="p">(</span><span class="nb">true</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"参数服务端搭建!"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">create_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------增操作--------------"</span><span class="p">);</span>

      <span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">"car_name"</span><span class="p">,</span><span class="s">"ER"</span><span class="p">);</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">"width"</span><span class="p">,</span><span class="mf">1.55</span><span class="p">);</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">"wheels"</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>

      <span class="k">this</span><span class="o">-&gt;</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="p">(</span><span class="s">"height"</span><span class="p">,</span><span class="mf">2.00</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">get_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------查操作--------------"</span><span class="p">);</span>

      <span class="k">auto</span> <span class="n">car</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"car_name"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"key = %s,value = %s"</span><span class="p">,</span><span class="n">car</span><span class="p">.</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="n">car</span><span class="p">.</span><span class="n">as_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span> 

      <span class="k">auto</span> <span class="n">params</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameters</span><span class="p">({</span><span class="s">"car_name"</span><span class="p">,</span><span class="s">"width"</span><span class="p">,</span><span class="s">"wheels"</span><span class="p">});</span>
      <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="err">¶</span><span class="n">m</span> <span class="o">:</span> <span class="n">params</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"key = %s,value = %s"</span><span class="p">,</span><span class="n">param</span><span class="p">.</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="n">param</span><span class="p">.</span><span class="n">value_to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="kt">bool</span> <span class="n">car_name_flag</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">has_parameter</span><span class="p">(</span><span class="s">"car_name"</span><span class="p">);</span>
      <span class="kt">bool</span> <span class="n">height_flag</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">has_parameter</span><span class="p">(</span><span class="s">"height"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"是否包含car_name? 答案:%d"</span><span class="p">,</span><span class="n">car_name_flag</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"是否包含height? 答案:%d"</span><span class="p">,</span><span class="n">height_flag</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">update_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------改操作--------------"</span><span class="p">);</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="p">(</span><span class="s">"width"</span><span class="p">,</span><span class="mf">1.85</span><span class="p">));</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"width = %.2f"</span><span class="p">,</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"width"</span><span class="p">).</span><span class="n">as_double</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">delete_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-------------删操作--------------"</span><span class="p">);</span>
    <span class="c1">//   this-&gt;undeclare_parameter("car_name");</span>
    <span class="c1">//   RCLCPP_INFO(this-&gt;get_logger(),"是否包含car_name? 答案:%d",this-&gt;has_parameter("car_name"));</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">undeclare_parameter</span><span class="p">(</span><span class="s">"height"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"是否包含height? 答案:%d"</span><span class="p">,</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">has_parameter</span><span class="p">(</span><span class="s">"height"</span><span class="p">));</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ParamServer</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">node</span><span class="o">-&gt;</span><span class="n">create_param</span><span class="p">();</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">get_param</span><span class="p">();</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">update_param</span><span class="p">();</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">delete_param</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="参数服务_实验1_客户端c">参数服务_实验1_客户端(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image816.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image817.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image818.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image819.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image820.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image821.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image822.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image823.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image824.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image825.webp" alt="" /></p>

<p>第一个入口参数是客户端节点对象，</p>

<p>第二个入口参数是需要连接的服务端的节点名称。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image826.webp" alt="" /></p>

<p>如果1秒钟之内连接上了就返回true，如果超时1s没连接上就返回false。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image827.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image828.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ParamClient</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ParamClient</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"param_client_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"参数客户端搭建!"</span><span class="p">);</span>
      <span class="n">param_client_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_sharedautolinkrclcpp</span><span class="o">::</span><span class="n">SyncParametersClientautolink</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s">"param_server_node_cpp"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="nf">connect_server</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="n">param_client_</span><span class="o">-&gt;</span><span class="n">wait_for_service</span><span class="p">(</span><span class="mx">1s</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"服务连接中!"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">get_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-----------参数查询操作-------------"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">update_param</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"-----------参数更新操作-------------"</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">SyncParametersClient</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">param_client_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ParamClient</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="kt">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">connect_server</span><span class="p">();</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">client</span><span class="o">-&gt;</span><span class="n">get_param</span><span class="p">();</span>
  <span class="n">client</span><span class="o">-&gt;</span><span class="n">update_param</span><span class="p">();</span>
  <span class="n">client</span><span class="o">-&gt;</span><span class="n">get_param</span><span class="p">();</span>

  <span class="c1">// rclcpp::spin(client);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image829.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image830.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image831.webp" alt="" /></p>

<p>这些话题都是我们此节点名称下的。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image832.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image833.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image834.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image835.webp" alt="" /></p>

<p>要用高级for</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image836.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image837.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image838.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image839.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image840.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image841.webp" alt="" /></p>

<p>入口参数填参数对象的容器。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image842.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image843.webp" alt="" /></p>

<p>我们不仅可以修改值，也可以创建新的参数，但是要保证服务端那边调用过undeclared……</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image844.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image845.webp" alt="" /></p>

<h1 id="ros2其他通信机制">ROS2其他通信机制</h1>

<h2 id="概述">概述</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image846.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image847.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image848.webp" alt="" /></p>

<p>不同设备之间的通信，是通过分布式来实现的。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image849.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image850.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image851.webp" alt="" /></p>

<p>镜像王八</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image852.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image853.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image854.webp" alt="" /></p>

<h2 id="分布式搭建">分布式搭建</h2>

<p><strong>场景</strong></p>

<p>在许多机器人相关的应用场景中都涉及到多台ROS2设备协作，比如：无人车编队、无人机编队、远程控制等等，那么不同的ROS2设备之间是如何实现通信的呢？</p>

<p><strong>概念</strong></p>

<p>分布式通信是指可以通过网络在不同主机之间实现数据交互的一种通信策略。</p>

<p>ROS2本身是一个分布式通信框架，可以很方便的实现不同设备之间的通信，ROS2所基于的中间件是DDS，当处于同一网络中时，通过DDS的域ID机制(ROS_DOMAIN_ID)可以实现分布式通信，大致流程是：在启动节点之前，可以设置域ID的值，不同节点如果域ID相同，那么可以自由发现并通信，反之，如果域ID值不同，则不能实现。默认情况下，所有节点启动时所使用的域ID为0，换言之，只要保证在同一网络，你不需要做任何配置，不同ROS2设备上的不同节点即可实现分布式通信。</p>

<p><strong>作用</strong></p>

<p>分布式通信的应用场景是较为广泛的，如上所述：机器人编队时，机器人可能需要获取周边机器人的速度、位置、运行轨迹的相关信息，远程控制时，则可能需要控制端获取机器人采集的环境信息并下发控制指令…… 这些数据的交互都依赖于分布式通信。</p>

<hr />

<p><strong>实现</strong></p>

<p>多机通信时，可以通过域ID对节点进行分组，组内的节点之间可以自由通信，不同组之间的节点则不可通信。如果所有节点都属于同一组，那么直接使用默认域ID即可，如果要将不同节点划分为多个组，那么可以在终端中启动节点前设置该节点的域ID(比如设置为6)，具体执行命令为：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">ROS_DOMAIN_ID</span><span class="o">=</span>6
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述指令执行后，该节点将被划分到ID为6的域内。</p>

<p>如果要为当前设备下的所有节点设置统一的域ID，那么可以执行如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">"export ROS_DOMAIN_ID=6"</span> <span class="o">&gt;&gt;</span> ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>执行完毕后再重新启动终端，运行的所有节点将自动被划分到ID为6的域内。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image855.webp" alt="" /></p>

<p>默认域ID是0，域ID不一样，无法互相通信。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image856.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image857.webp" alt="" /></p>

<p>ID不一样就无法正常通信，和在ROS1内需要指定ROS Master一样。</p>

<p><strong>注意</strong></p>

<p>在设置ROS_DOMAIN_ID的值时并不是随意的，也是有一定约束的：</p>

<ol>
  <li>
    <p>建议ROS_DOMAIN_ID的取值在[0,101] 之间，包含0和101；</p>
  </li>
  <li>
    <p>每个域ID内的节点总数是有限制的，需要小于等于120个；</p>
  </li>
  <li>
    <p>如果域ID为101，那么该域的节点总数需要小于等于54个。</p>
  </li>
</ol>

<p><strong>DDS 域 ID 值的计算规则</strong></p>

<p>域ID值的相关计算规则如下：</p>

<ol>
  <li>
    <p>DDS是基于TCP/IP或UDP/IP网络通信协议的，网络通信时需要指定端口号，端口号由2个字节的无符号整数表示，其取值范围在[0,65535]之间；</p>
  </li>
  <li>
    <p>端口号的分配也是有其规则的，并非可以任意使用的，根据DDS协议规定以7400作为起始端口，也即可用端口为[7400,65535]，又已知按照DDS协议默认情况下，每个域ID占用250个端口，那么域ID的个数为：(65535-7400)/250 = 232(个)，对应的其取值范围为[0,231]；</p>
  </li>
  <li>
    <p>操作系统还会设置一些预留端口，在DDS中使用端口时，还需要避开这些预留端口，以免使用中产生冲突，不同的操作系统预留端口又有所差异，其最终结果是，在Linux下，可用的域ID为[0,101]与[215-231]，在Windows和Mac中可用的域ID为[0,166]，综上，为了兼容多平台，建议域ID在[0,101] 范围内取值。</p>
  </li>
  <li>
    <p>每个域ID默认占用250个端口，且每个ROS2节点需要占用两个端口，另外，按照DDS协议每个域ID的端口段内，第1、2个端口是Discovery Multicast端口与User Multicast端口，从第11、12个端口开始是域内第一个节点的Discovery Unicast端口与User Unicast，后续节点所占用端口依次顺延，那么一个域ID中的最大节点个数为：(250-10)/2 = 120(个)；</p>
  </li>
  <li>
    <p>特殊情况：域ID值为101时，其后半段端口属于操作系统的预留端口，其节点最大个数为54个。</p>
  </li>
</ol>

<p>上述计算规则了解即可。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>域 ID 与节点所占用端口示意

Domain ID:      0
Participant ID: 0

Discovery Multicast Port: 7400
User Multicast Port:      7401
Discovery Unicast Port:   7410
User Unicast Port:        7411

<span class="nt">---</span>

Domain ID:      1
Participant ID: 2
Discovery Multicast Port: 7650
User Multicast Port:      7651
Discovery Unicast Port:   7664
User Unicast Port:        7665
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Domain ID是指域ID</p>

<p>Participant ID是参与组ID，是指该域内的第几个节点</p>

<p>Discovery Multicast Port主发现端口，DDS规定，端口应从7400开始</p>

<p>User Multicast Port用户广播端口，</p>

<p>Discovery Unicast Port单播发现端口，7410是第一个节点开始使用的Discovery Unicast端口，因为DDS规定的，第11个端口才是第一个节点的Discovery Unicast端口。</p>

<p>User Unicast Port单播用户端口，7411才是第一个节点开始使用的User Unicast端口，因为DDS规定的，第12个端口才是第一个节点的User Unicast端口。</p>

<p>Discovery Unicast Port和User Unicast Port是第一个节点所占用的端口，所以一共占用了俩端口。</p>

<p>如果Domain ID不变还为0，Participant ID变成1的话，那么下一个节点的Discovery Unicast Port为7412，User Unicast Port为7413。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image858.webp" alt="" /></p>

<p>以此类推。</p>

<p>一个Domain ID占用250个端口，所以当Domain ID为1的时候，Discovery Unicast Port应该是7650。</p>

<p>这是第三个节点，所以是7664和7665。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image859.webp" alt="" /></p>

<p>实践：在树莓派5上跑一个ROS2 Jazzy开启键盘控制节点，然后在电脑实体机Linux(或者在Docker里跑也行，但要设置好网络)里跑一个ROS2 Humble，并打开乌龟显示节点。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image860.webp" alt="" /></p>

<p>会发现是可以正常通信的。</p>

<h2 id="工作空间覆盖">工作空间覆盖</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image861.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image862.webp" alt="" /></p>

<p><strong>没什么用，建议不要使用</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image863.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image864.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image865.webp" alt="" /></p>

<p>这个是和你的bashrc文件里，加载bash文件的顺序有关，谁最后加载，谁就会运行，也就是最高优先级。除了ROS2本身自带的bash，这个bash是不论在哪加载，都是最低优先级。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image866.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image867.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image868.webp" alt="" /></p>

<h2 id="元功能包">元功能包</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image869.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image870.webp" alt="" /></p>

<p>distro就是发行版的意思</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image871.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image872.webp" alt="" /></p>

<p>--build-type默认C++，</p>

<p>--dependent默认无，</p>

<p>--node-name本身是虚包，所以也无需设置。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image873.webp" alt="" /></p>

<p>CmakeLists无需修改</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image874.webp" alt="" /></p>

<p>先把12，13行删除</p>

<p>&lt;exec_depend&gt;xxxxxx&lt;/exec_depend&gt;</p>

<p>所要依赖的功能包名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image875.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image876.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image877.webp" alt="" /></p>

<hr />

<p>以后可能需要的元功能包：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image878.webp" alt="" /></p>

<p>这个功能包是导航相关的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image879.webp" alt="" /></p>

<p>这个就是个元功能包</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image880.webp" alt="" /></p>

<p>只有配置文件，没有其他实质性实现</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image881.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image882.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image883.webp" alt="" /></p>

<p>元功能包的作用就是方便安装，把自己的东西打包，可以共享到ROS2社区。也方便安装别人的东西。</p>

<h2 id="节点重名">节点重名</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image884.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image885.webp" alt="" /></p>

<p>而且节点名称都是一致的，图中有个&lt;2&gt;，这是操作系统给的标号，其他的操作系统是没有这个标号的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image886.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rqt_graph
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image887.webp" alt="" /></p>

<p>他只显示一个turtlesim，实际上我们是使用了两个turtlesim的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image888.webp" alt="" /></p>

<p>这样虽然都显示了，但是是一模一样的名字，容易混淆，而且上面也给重名警告了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image889.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image890.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image891.webp" alt="" /></p>

<p>要么起别名：王大宝，王小宝</p>

<p>要么加命名空间： 毛驴子家的王宝，李二狗家的王宝</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image892.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image893.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image894.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtlesim_node <span class="nt">--ros-args</span> <span class="nt">--remap</span> __ns:<span class="o">=</span>/t1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 run 功能包名 节点名 –ros-args –remap __ns:=/命名空间</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image895.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image896.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtlesim_node <span class="nt">--ros-args</span> <span class="nt">--remap</span> __name:<span class="o">=</span>turtlesim2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 run 功能包名 节点名 –ros-args –remap __name:=别名</p>

<p>or</p>

<p>ros2 run 功能包名 节点名 –ros-args –remap __node:=别名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image897.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image898.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image899.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp05_names <span class="nt">--build-type</span> ament_cmake <span class="nt">--node-name</span> demo01_names
</pre></td></tr></tbody></table></code></pre></div></div>

<p>节点名可以不设置，这里设置主要是为以后学习做铺垫。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image900.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image901.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image902.webp" alt="" /></p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>DIRECTORY launch DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image903.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image904.webp" alt="" /></p>

<p>先导俩包</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image905.webp" alt="" /></p>

<p>这个LaunchDescription对象里面呢是个列表，这个列表就是存储要启动的若干个节点。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image906.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image907.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="nc">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">t1</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>package功能包名</p>

<p>executable节点名</p>

<p>name别名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image908.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch cpp05_names demo01_names_launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image909.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image910.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image911.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image912.webp" alt="" /></p>

<p>根标签是Launch</p>

<p>子集标签是node</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image913.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;launch&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"turtlesim"</span> <span class="na">exec=</span><span class="s">"turtlesim_node"</span> <span class="na">name=</span><span class="s">"t1"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/launch&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image914.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch cpp05_names demo02_names_launch.xml 
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image915.webp" alt="" /></p>

<p>yaml的根标签也是launch</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image916.webp" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="na">launch</span><span class="pi">:</span>
<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t1"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image917.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch cpp05_names demo03_names_launch.yaml 
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image918.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image919.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image920.webp" alt="" /></p>

<p>name别名</p>

<p>namespace命名空间</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image921.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="nc">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">turtle1</span><span class="sh">"</span><span class="p">),</span>
        <span class="nc">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span><span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">t1</span><span class="sh">"</span><span class="p">),</span>
        <span class="nc">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span><span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">t1</span><span class="sh">"</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">turtle1</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image922.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;launch&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">pkg =</span><span class="s">"turtlesim"</span> <span class="na">exec =</span><span class="s">"turtlesim_node"</span> <span class="na">name =</span><span class="s">"turtle1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">pkg =</span><span class="s">"turtlesim"</span> <span class="na">exec =</span><span class="s">"turtlesim_node"</span> <span class="na">namespace =</span><span class="s">"t1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">pkg =</span><span class="s">"turtlesim"</span> <span class="na">exec =</span><span class="s">"turtlesim_node"</span> <span class="na">namespace =</span><span class="s">"t1"</span> <span class="na">name=</span> <span class="s">"turtle1"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/launch&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image923.webp" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="na">launch</span><span class="pi">:</span>
<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtle"</span>
<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t1"</span>
<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t1"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtle"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image924.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image925.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image926.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image927.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image928.webp" alt="" /></p>

<p>可指定命名空间</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image929.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">MyNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">MyNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"mynode_node_cpp"</span><span class="p">,</span><span class="s">"t1_ns"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"Hello World!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MyNode</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image930.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image931.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image932.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image933.webp" alt="" /></p>

<h2 id="话题重名">话题重名</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image934.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image935.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image936.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image937.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image938.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtlesim_node <span class="nt">--ros-args</span> <span class="nt">--remap</span> __ns:<span class="o">=</span>/t1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ros2 run 功能包名 节点名 –ros-args –remap __ns:=/命名空间</p>

<p>这种加命名空间的方式，不仅对节点重名生效，当然对话题名称依然生效。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image939.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image940.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image941.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image942.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image943.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run teleop_twist_keyboard teleop_twist_keyboard 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这个是打开控制机器人运动的节点</p>

<p>ros2 run teleop_twist_keyboard teleop_twist_keyboard</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image944.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image945.webp" alt="" /></p>

<p>其所对应的话题名称是这个。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image946.webp" alt="" /></p>

<p>但此时控制乌龟运动无效，是因为话题命名空间不同。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image947.webp" alt="" /></p>

<p>乌龟接收的话题是/turtle1/cmd_vel，命名空间是/turtle1</p>

<p>而控制乌龟运动的是/cmd_vel，命名空间不同，</p>

<p>所以我们要把两者命名空间弄成一样的。</p>

<p>随便改即可，只要改成一样的，就可以正常通信了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image948.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image949.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image950.webp" alt="" /></p>

<p>remappings可以实现话题的重映射，该参数是一个列表，然后里面是元组，每一个元组都可以对一个话题进行重映射，元组里第一个参数是原话题名称，第二个参数是重映射后的话题名称。</p>

<p>namespace可以实现命名空间。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image951.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image952.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image953.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image954.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image955.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image956.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image957.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image958.webp" alt="" /></p>

<p>remp也是可以设置重映射，from是原话题名称，to是重映射的名称。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;launch&gt;</span>

    <span class="nt">&lt;node</span> <span class="na">pkg =</span><span class="s">"turtlesim"</span> <span class="na">exec =</span><span class="s">"turtlesim_node"</span> <span class="na">namespace =</span><span class="s">"t1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">pkg =</span><span class="s">"turtlesim"</span> <span class="na">exec =</span><span class="s">"turtlesim_node"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;remap</span> <span class="na">from=</span> <span class="s">"/turtle1/cmd_vel"</span> <span class="na">to=</span><span class="s">"/cmd_vel"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/node&gt;</span>
<span class="nt">&lt;/launch&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image959.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image960.webp" alt="" /></p>

<p>launch:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">node</span><span class="pi">:</span>
<span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
<span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
<span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtle"</span>
<span class="pi">-</span> <span class="na">node</span><span class="pi">:</span>
<span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
<span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t1"</span>
<span class="pi">-</span> <span class="na">node</span><span class="pi">:</span>
<span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
<span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t1"</span>
<span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtle"</span>

<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t1"</span>
<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">remap</span><span class="pi">:</span>
  <span class="pi">-</span>
      <span class="na">from</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/turtle1/cmd_vel"</span>
      <span class="na">to</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/cmd_vel"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image961.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image962.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image963.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image964.webp" alt="" /></p>

<p>命名空间可以有好几级。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image965.webp" alt="" /></p>

<p>全局话题是和节点命名空间平级，也就是挂载在根下的。</p>

<p>相对话题是挂载在命名空间下的。</p>

<p>私有话题是节点名称的子级。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image966.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image967.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image968.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image969.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"std_msgs/msg/string.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">MyNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"mynode_node_name"</span><span class="p">,</span><span class="s">"t1_namespace"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"Hello World!"</span><span class="p">);</span>
      <span class="n">publisher_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"/global_topics"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">publisher_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MyNode</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image970.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image971.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image972.webp" alt="" /></p>

<p>全局话题</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image973.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image974.webp" alt="" /></p>

<p>相对话题</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image975.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image976.webp" alt="" /></p>

<p>私有话题</p>

<h2 id="时间相关api">时间相关API</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image977.webp" alt="" /></p>

<p>发消息可以有消息头，消息头里有时间戳，接收方解析消息头，并把消息时间和当前时间进行比对，看是否延迟过高。</p>

<p>Rate是频率</p>

<p>Time是时刻</p>

<p>Duration是持续时间</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image978.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image979.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image980.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image981.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image982.webp" alt="" /></p>

<p>这个类的构造函数有两个重载，第一个是周期，第二个是频率。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image983.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image984.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image985.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">MyNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"time_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"Hello World!"</span><span class="p">);</span>
      <span class="n">demo_rate</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">demo_rate</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Rate</span> <span class="n">rate1</span><span class="p">(</span><span class="mx">500ms</span><span class="p">);</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Rate</span> <span class="n">rate2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
      <span class="c1">// while(rclcpp::ok())</span>
      <span class="c1">// {</span>
      <span class="c1">//   RCLCPP_INFO(this-&gt;get_logger(),"休眠500ms");</span>
      <span class="c1">//   rate1.sleep();</span>
      <span class="c1">// }</span>
      <span class="k">while</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"休眠1000ms"</span><span class="p">);</span>
        <span class="n">rate2</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MyNode</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image986.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image987.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image988.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image989.webp" alt="" /></p>

<p>可以传入一个纳秒</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image990.webp" alt="" /></p>

<p>也可以传入一个秒和一个纳秒</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image991.webp" alt="" /></p>

<p>因为是int64_t类型的，所以我们后面加个L，这是5亿纳秒，也就是0.5秒。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image992.webp" alt="" /></p>

<p>这样time2代表2.5秒。</p>

<p>获取当前时刻有两种方式，</p>

<p>一个是this-&gt;get_clock()-&gt;now()，</p>

<p>另一个是this-&gt;now();</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image993.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image994.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image995.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image996.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">MyNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"time_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"Hello World!"</span><span class="p">);</span>
      <span class="c1">// demo_rate();</span>
      <span class="n">demo_time</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">demo_rate</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Rate</span> <span class="n">rate1</span><span class="p">(</span><span class="mx">500ms</span><span class="p">);</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Rate</span> <span class="n">rate2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
      <span class="c1">// while(rclcpp::ok())</span>
      <span class="c1">// {</span>
      <span class="c1">//   RCLCPP_INFO(this-&gt;get_logger(),"休眠500ms");</span>
      <span class="c1">//   rate1.sleep();</span>
      <span class="c1">// }</span>
      <span class="k">while</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"休眠1000ms"</span><span class="p">);</span>
        <span class="n">rate2</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">demo_time</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span> <span class="n">time1</span><span class="p">(</span><span class="mi">500000000L</span><span class="p">);</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span> <span class="n">time2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">500000000L</span><span class="p">);</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span> <span class="n">right_now_1</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
      <span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span> <span class="n">right_now_2</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>

      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"s = %.2f , ns = %ld"</span><span class="p">,</span><span class="n">time1</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span><span class="n">time1</span><span class="p">.</span><span class="n">nanoseconds</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"s = %.2f , ns = %ld"</span><span class="p">,</span><span class="n">time2</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span><span class="n">time2</span><span class="p">.</span><span class="n">nanoseconds</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"s = %.2f , ns = %ld"</span><span class="p">,</span><span class="n">right_now_1</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span><span class="n">right_now_1</span><span class="p">.</span><span class="n">nanoseconds</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"s = %.2f , ns = %ld"</span><span class="p">,</span><span class="n">right_now_2</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span><span class="n">right_now_2</span><span class="p">.</span><span class="n">nanoseconds</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MyNode</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image997.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image998.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image999.webp" alt="" /></p>

<p>和Time类似</p>

<p>但是不完全相同，这个duration用到了chrono。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1000.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1001.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1002.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1003.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1004.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1005.webp" alt="" /></p>

<p>t2和t1可以进行相减，结果是一个duration类型的，但是不能相加。</p>

<p>time也可以和duration相加相减，结果是一个time。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1006.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1007.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1008.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1009.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1010.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1011.webp" alt="" /></p>

<h2 id="通信机制工具">通信机制工具</h2>

<h3 id="命令行">命令行</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1012.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1013.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1014.webp" alt="" /></p>

<p>ros2 doctor是来检测系统网络状态、版本兼容性等状态的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1015.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1016.webp" alt="" /></p>

<p>是通过了的，但是有几个警告：版本过低，不影响正常使用。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1017.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1018.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1019.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1020.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1021.webp" alt="" /></p>

<p>参数服务端的本质还是服务端，所以也会列在Service Servers里。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1022.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1023.webp" alt="" /></p>

<p>如果查看list发现有一些接口文件没显示，那说明你的这个终端的环境变量没刷新。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1024.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1025.webp" alt="" /></p>

<p>proto比show更精简一些。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1026.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1027.webp" alt="" /></p>

<p>pose是发送位姿的，会一直发数据。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1028.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1029.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1030.webp" alt="" /></p>

<p><strong>想输出延时，消息必须有消息头。</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1031.webp" alt="" /></p>

<p>输出实时位姿</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1032.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1033.webp" alt="" /></p>

<p>find和type是相反着来的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1034.webp" alt="" /></p>

<p>消息发布频率是不断变动的，消息频率是可以通过定时器来控制，但是定时器是有误差的，并不是特别特别精准。当然还有网络也是一大影响因素。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1035.webp" alt="" /></p>

<p>ros2 topic pub -r 发布消息的频率 话题名称 消息 具体的指令（要用json格式）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1036.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1037.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1038.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1039.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1040.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1041.webp" alt="" /></p>

<p>clear是清除乌龟轨迹</p>

<p>kill是杀乌龟</p>

<p>reset是将乌龟位置重置</p>

<p>spawn是产卵，生成新乌龟</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1042.webp" alt="" /></p>

<p>可以按Tab补齐</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1043.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1044.webp" alt="" /></p>

<p>type和find是相反的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1045.webp" alt="" /></p>

<p>empty就是空，所以我们后面内容啥都不用写。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1046.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1047.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1048.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1049.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1050.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1051.webp" alt="" /></p>

<p>可以加上-f或者-feedback打开连续反馈，这个连续反馈是航向角弧度</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1052.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1053.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1054.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1055.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1056.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1057.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1058.webp" alt="" /></p>

<p>删除不是所有参数都能删除，这里提示不能删除静态类型参数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1059.webp" alt="" /></p>

<p>最大值255，最小取值0</p>

<p>步长1</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1060.webp" alt="" /></p>

<p>可以显示在终端上，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1061.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1062.webp" alt="" /></p>

<p>也可以写入磁盘</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1063.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1064.webp" alt="" /></p>

<p>当然也可以修改</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1065.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1066.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1067.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1068.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1069.webp" alt="" /></p>

<p>也可以用ROS2 RUN来修改，–ros-args -p 后面跟 键:=值</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1070.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1071.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1072.webp" alt="" /></p>

<p>ROS2 RUN也可以直接读取磁盘文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1073.webp" alt="" /></p>

<h3 id="rqt工具箱">Rqt工具箱</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1074.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1075.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1076.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1077.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1078.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1079.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1080.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1081.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1082.webp" alt="" /></p>

<p>这个是显示两个节点之间关系的。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1083.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1084.webp" alt="" /></p>

<p>这个是用来发布消息的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1085.webp" alt="" /></p>

<p>点击添加按钮</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1086.webp" alt="" /></p>

<p>可以设置线速度和角速度，频率等</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1087.webp" alt="" /></p>

<p>设置好参数后勾选</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1088.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1089.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1090.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1091.webp" alt="" /></p>

<p>call /clear这个是清除轨迹的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1092.webp" alt="" /></p>

<p>也可以产卵，设置好参数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1093.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1094.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1095.webp" alt="" /></p>

<p>这个可以直接修改参数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1096.webp" alt="" /></p>

<hr />

<p>我们不能用rqt代替命令行，虽然rqt更方便，但是因为我们在工作中是远程控制机器人的，我们是通过terminal来远程控制机器人，所以，命令行很重要，这样不能使用rqt。</p>

<h1 id="launch">Launch</h1>

<h2 id="概述-1">概述</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1097.webp" alt="" /></p>

<p>rosbag2的作用是来序列化储存数据的，是一个数据库。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1098.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1099.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1100.webp" alt="" /></p>

<p>ros2 launch 功能包名 launch文件名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1101.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1102.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1103.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1104.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1105.webp" alt="" /></p>

<p>ros2 pkg create cpp01_launch –build-type ament_cmake –dependencies rclcpp</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp01_launch <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1106.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="launch基本使用流程c">launch基本使用流程(C++)</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1107.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1108.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1109.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1110.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1111.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1112.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1113.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1114.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1115.webp" alt="" /></p>

<p>配置完这个，不管我launch目录下有多少launch文件，只需要配置这一次就行了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1116.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1117.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1118.webp" alt="" /></p>

<p>这样说明我们cmake配置对了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1119.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1120.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1121.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1122.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1123.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1124.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;launch&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">pkg =</span> <span class="s">"turtlesim"</span> <span class="na">exec =</span> <span class="s">"turtlesim_node"</span> <span class="na">name =</span> <span class="s">"t1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">pkg =</span> <span class="s">"turtlesim"</span> <span class="na">exec =</span> <span class="s">"turtlesim_node"</span> <span class="na">name =</span> <span class="s">"t2"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/launch&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1125.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1126.webp" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="na">launch</span><span class="pi">:</span>
<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t1"</span>
<span class="na">node</span><span class="pi">:</span>
  <span class="na">pkg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim"</span>
  <span class="na">exec</span><span class="pi">:</span> <span class="s2">"</span><span class="s">turtlesim_node"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">t2"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1127.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1128.webp" alt="" /></p>

<p>最好添加一个依赖</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1129.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1130.webp" alt="" /></p>

<h2 id="launch_python_node">Launch_Python_Node</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1131.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1132.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1133.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1134.webp" alt="" /></p>

<p>这个是标签exec_name</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1135.webp" alt="" /></p>

<p>这俩参数传参的区别在于–ros-args的区别</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1136.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1137.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1138.webp" alt="" /></p>

<p>在launch里写更简单</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1139.webp" alt="" /></p>

<p>这样是等价的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1140.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1141.webp" alt="" /></p>

<p>{}里是yaml格式的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1142.webp" alt="" /></p>

<p>有另一种更常用的方法，就是上来读取yaml文件，把数据都存在yaml里，用到的时候直接读取。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1143.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1144.webp" alt="" /></p>

<p>把yaml文件放到config里</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1145.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 param dump haha <span class="nt">--output-dir</span> src/cpp01_launch/config/
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1146.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1147.webp" alt="" /></p>

<p>还需要再配置cmakelists</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1148.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1149.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1150.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1151.webp" alt="" /></p>

<p>我们要读就读install目录下的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1152.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1153.webp" alt="" /></p>

<p>直接复制路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1154.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1155.webp" alt="" /></p>

<p>可以进一步优化代码</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1156.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1157.webp" alt="" /></p>

<p>这个就是来获取某个功能包的share目录路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1158.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1159.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1160.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="c1"># turtle1 = Node(
</span>
    <span class="c1">#     package="turtlesim",
</span>
    <span class="c1">#     executable="turtlesim_node",
</span>
    <span class="c1">#     exec_name="my_label",
</span>
    <span class="c1">#     ros_arguments=["--remap","__ns:=/t2"]
</span>
    <span class="c1">#     )
</span>    <span class="n">turtle2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">haha</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp01_launch</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">config</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">haha.yaml</span><span class="sh">"</span><span class="p">)]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">turtle2</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1161.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1162.webp" alt="" /></p>

<p>建议采用第三种 动态获取路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1163.webp" alt="" /></p>

<p>respawn是自动重启的意思，这样运行后的节点，你用鼠标关闭小乌龟窗口后，也会自动重启节点，再把小乌龟窗口打开一个新的。</p>

<p>按Ctrl+C可以终止。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="c1"># turtle1 = Node(
</span>
    <span class="c1">#     package="turtlesim",
</span>
    <span class="c1">#     executable="turtlesim_node",
</span>
    <span class="c1">#     exec_name="my_label",
</span>
    <span class="c1">#     ros_arguments=["--remap","__ns:=/t2"]
</span>
    <span class="c1">#     )
</span>    <span class="n">turtle2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">haha</span><span class="sh">"</span><span class="p">,</span>

        <span class="c1"># parameters=[{"background_r": 255,"background_g": 0,"background_b": 0}],
</span>
        <span class="c1"># parameters=["/home/tungchiahui/mysource/ros2src/4.ws02_tools/install/cpp01_launch/share/cpp01_launch/config/haha.yaml"],
</span>        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp01_launch</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">config</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">haha.yaml</span><span class="sh">"</span><span class="p">)],</span>
        <span class="n">respawn</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">turtle2</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1164.webp" alt="" /></p>

<p>第一个是原话题名称，第二个是新话题名称</p>

<h2 id="launch_python_执行命令">Launch_Python_执行命令</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1165.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1166.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1167.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1168.webp" alt="" /></p>

<p>这是个列表，列表里面写我们的指令</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1169.webp" alt="" /></p>

<p>这样是把日志既输出到终端也输出到日志，如果不写则只会输出到日志。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1170.webp" alt="" /></p>

<p>这样就是把命令当成终端指令来执行</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1171.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1172.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">turtle</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">ros2 topic echo /turtle1/pose</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">output</span> <span class="o">=</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">turtle</span><span class="p">,</span><span class="n">cmd</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1173.webp" alt="" /></p>

<p>如果指令过长，可以分到多个字符串里运行。</p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1174.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1175.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1176.webp" alt="" /></p>

<p>这样也是可以运行的。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">turtle</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="nc">FindExecutable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">ros2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">topic</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">/turtle1/pose</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">output</span> <span class="o">=</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">turtle</span><span class="p">,</span><span class="n">cmd</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1177.webp" alt="" /></p>

<h2 id="launch_python_参数设置">Launch_Python_参数设置</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1178.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1179.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1180.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1181.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1182.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1183.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1184.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1185.webp" alt="" /></p>

<p>没传值的话，乌龟红色是满的，那就是粉红色背景</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1186.webp" alt="" /></p>

<p>也可以传值，比如传backg_r:=0</p>

<p>这样背景色就变的更偏蓝绿了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1187.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1188.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1189.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">bg_r</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">backg_r</span><span class="sh">"</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="sh">"</span><span class="s">255</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">bg_g</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">backg_g</span><span class="sh">"</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="sh">"</span><span class="s">255</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">bg_b</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">backg_b</span><span class="sh">"</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="sh">"</span><span class="s">255</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">turtle</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">background_r</span><span class="sh">"</span> <span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">backg_r</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">background_g</span><span class="sh">"</span> <span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">backg_g</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">background_b</span><span class="sh">"</span> <span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">backg_b</span><span class="sh">"</span><span class="p">)}]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">bg_r</span><span class="p">,</span><span class="n">bg_g</span><span class="p">,</span><span class="n">bg_b</span><span class="p">,</span><span class="n">turtle</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="launch_python_文件包含">Launch_Python_文件包含</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1190.webp" alt="" /></p>

<p>假设我要编写一个机器人启动相关的launch文件，在这个launch文件中，我可能要启动雷达，启动IMU，启动底盘等等，我们需要把这些launch文件都包含进机器人启动的launch文件中。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1191.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1192.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1193.webp" alt="" /></p>

<p>这个值是由被包含的launch文件封装而来的对象。</p>

<p>这个对象对应的类就是PythonLaunchDescriptionSource，</p>

<p>类里面还得设置一个参数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1194.webp" alt="" /></p>

<p>这个参数是launch_file_path就是文件路径。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1195.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1196.webp" alt="" /></p>

<p>建议用这个来获取路径。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1197.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1198.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1199.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1200.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1201.webp" alt="" /></p>

<p>也可以为其传参</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1202.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1203.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1204.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">include</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="n">launch_description_source</span><span class="o">=</span><span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="n">launch_file_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span>
                <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp01_launch</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">launch/py</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">py04_args_launch.py</span><span class="sh">"</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">launch_arguments</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">backg_r</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">80</span><span class="sh">"</span><span class="p">),(</span><span class="sh">"</span><span class="s">backg_g</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">10</span><span class="sh">"</span><span class="p">),(</span><span class="sh">"</span><span class="s">backg_b</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">200</span><span class="sh">"</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">include</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="launch_python_分组设置">Launch_Python_分组设置</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1205.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1206.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1207.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1208.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1209.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1210.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1211.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">turtle1</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">t1</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">turtle2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">t2</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">turtle3</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">t3</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="n">group1</span> <span class="o">=</span> <span class="nc">GroupAction</span><span class="p">(</span><span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="nc">PushRosNamespace</span><span class="p">(</span><span class="sh">"</span><span class="s">g1</span><span class="sh">"</span><span class="p">),</span><span class="n">turtle1</span><span class="p">,</span><span class="n">turtle2</span><span class="p">])</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="nc">GroupAction</span><span class="p">(</span><span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="nc">PushRosNamespace</span><span class="p">(</span><span class="sh">"</span><span class="s">g2</span><span class="sh">"</span><span class="p">),</span><span class="n">turtle3</span><span class="p">])</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">group1</span><span class="p">,</span><span class="n">group2</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="launch_python_事件设置">Launch_Python_事件设置</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1212.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1213.webp" alt="" /></p>

<p>第一个主要用于注册事件，第二个是开始事件，第三个是节点退出。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1214.webp" alt="" /></p>

<hr />

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1215.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1216.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1217.webp" alt="" /></p>

<p>这个是在终端中生成新小乌龟的命令</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1218.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1219.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1220.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1221.webp" alt="" /></p>

<p>第一个参数是针对哪个事件进行注册。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1222.webp" alt="" /></p>

<p>target_action是事件源，你要为哪个节点注册事件。</p>

<p>on_start是等到事件被触发，你要做哪些操作？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1223.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1224.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1225.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1226.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="n">封装终端指令相关类</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">FindExecutable</span>
<span class="n">参数声明与获取</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="n">文件包含相关</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="n">分组相关</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">PushRosNamespace</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">GroupAction</span>
<span class="n">事件相关</span>
<span class="kn">from</span> <span class="n">launch.event_handlers</span> <span class="kn">import</span> <span class="n">OnProcessStart</span><span class="p">,</span><span class="n">OnProcessExit</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span><span class="p">,</span><span class="n">RegisterEventHandler</span><span class="p">,</span><span class="n">LogInfo</span>
<span class="n">获取功能包下share目录或路径</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">turtle</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">spawn</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">ros2 service call /spawn turtlesim/srv/Spawn </span><span class="se">\"</span><span class="s">{</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">: 8.0,</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="s">: 3.0}</span><span class="se">\"</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>

    <span class="n">event_start</span> <span class="o">=</span> <span class="nc">RegisterEventHandler</span><span class="p">(</span>
        <span class="n">event_handler</span><span class="o">=</span><span class="nc">OnProcessStart</span><span class="p">(</span>
            <span class="n">target_action</span><span class="o">=</span><span class="n">turtle</span><span class="p">,</span>
            <span class="n">on_start</span><span class="o">=</span><span class="n">spawn</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">event_exit</span> <span class="o">=</span> <span class="nc">RegisterEventHandler</span><span class="p">(</span>
        <span class="n">event_handler</span><span class="o">=</span><span class="nc">OnProcessExit</span><span class="p">(</span>
            <span class="n">target_action</span><span class="o">=</span><span class="n">turtle</span><span class="p">,</span>
            <span class="n">on_exit</span><span class="o">=</span><span class="p">[</span><span class="nc">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sh">"</span><span class="s">turtlesim_node:退出！</span><span class="sh">"</span><span class="p">)]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">turtle</span><span class="p">,</span><span class="n">event_start</span><span class="p">,</span><span class="n">event_exit</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1227.webp" alt="" /></p>

<p>on_exit可以创建一个对象，也可以放在列表里。</p>

<p>可以只学Python版本的Launch，XML和Yaml版本的Launch可以了解就行，自己写就写Python版本的，当你要用到别人开源的功能包用的Launch是Xml或者yaml版本一般不影响正常使用。</p>

<h2 id="launch_xml_yaml_node">Launch_XML_YAML_Node</h2>

<h2 id="launch_xml_yaml_执行命令">Launch_XML_YAML_执行命令</h2>

<h2 id="launch_xml_yaml_参数设置">Launch_XML_YAML_参数设置</h2>

<h2 id="launch_xml_yaml_分组设置">Launch_XML_YAML_分组设置</h2>

<h2 id="launch_xml_yaml_文件包含">Launch_XML_YAML_文件包含</h2>

<h1 id="回溯rosbag2">回溯rosbag2</h1>

<h2 id="概述-2">概述</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1228.webp" alt="" /></p>

<p>方式1一边采集数据，一边生成地图信息。</p>

<p>方式2是将采集数据和生成地图信息分割开来了，方式2做到了解耦合，所以更灵活一些。用同一套数据，可能用不同的算法处理，总之，非常灵活。</p>

<p>留存的过程咱们也可以叫做序列化。（转化为磁盘文件）</p>

<p>留存一般叫录制（序列化）。</p>

<p>读取一般叫回放(反序列化)。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1229.webp" alt="" /></p>

<p>留存时也可以将文件进行分卷，也就是每个文件最大能占多大的大小，如果超过该大小，就新建一个文件继续留存。（类似于压缩文件的分卷）</p>

<p>这样的话，存的数据太大，我们一次性打开太慢，就可以分段打开。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1230.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1231.webp" alt="" /></p>

<p>需要依赖于rosbag2_cpp或者rosbag2_py</p>

<p>然后还要依赖于geometry_msgs，这个是因为我们要序列化的数据是这个包下的速度指令。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp02_rosbag <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp rosbag2_cpp geometry_msgs <span class="nt">--node-name</span> cpp01_writer
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="rosbag2的命令工具">rosbag2的命令工具</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1232.webp" alt="" /></p>

<p>一般ROSBAG2的使用有命令行工具和编码两种使用方式，<strong>命令行工具功能比较齐全，够用。</strong></p>

<p>查看帮助文档ros2 bag -h</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1233.webp" alt="" /></p>

<p>主要有6个指令。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1234.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1235.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1236.webp" alt="" /></p>

<p>可以看record的详细用法。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1237.webp" alt="" /></p>

<p>record是用来将消息序列化的。(录制)</p>

<p>play是用来反序列化消息的。(回放)</p>

<p>info是用来输出bag文件的相关信息的。比如有多少条消息，录制起始时间和终止时间以及持续时间。</p>

<p>reindex是重建bag文件，可以修改bag源数据文件。</p>

<p>list是输出rosbag2中可用的插件(高阶应用)。</p>

<p>convert我们可以用这个给bag文件修改扩展名，也可以把多个bag文件合并成一个文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1238.webp" alt="" /></p>

<p>打开小乌龟节点与键盘控制小乌龟节点。</p>

<p>我们用键盘控制小乌龟，然后把速度指令通过rosbag2给序列化。</p>

<p>然后我们关掉两个节点，再重启小乌龟节点，然后这次不通过键盘控制，而是通过play bag文件让小乌龟运动。</p>

<p>record指令后面要跟一个话题组成的列表，但是在咱们下面的操作中，只用到了一个话题。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1239.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1240.webp" alt="" /></p>

<p>然后再用output，把序列化后的文件写出到一个磁盘目录中去。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1241.webp" alt="" /></p>

<p>cd进想保存bag的目录，然输入record指令，后面跟话题名称，然后-o +bag文件名，这里也可以不重新命名bag文件，这样会用默认的名字，默认的名称是年月日命名的。</p>

<p>这样就已经开始录制了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1242.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1243.webp" alt="" /></p>

<p>按Ctrl + C进行结束，结束有个提示，说正在将消息写入bag，需要一段时间。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1244.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1245.webp" alt="" /></p>

<p>这个yaml文件是源数据文件。</p>

<p>db3是SQLite数据库，这个是移动端(比如手机)常用的数据库。</p>

<p>这个数据库就存储了录制的数据。</p>

<h2 id="rosbag2-c案例分析及框架搭建">rosbag2 C++案例分析及框架搭建</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1246.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1247.webp" alt="" /></p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="nb">add_executable</span><span class="p">(</span>demo01_writer src/demo01_writer.cpp<span class="p">)</span>
<span class="nf">ament_target_dependencies</span><span class="p">(</span>
  demo01_writer
  <span class="s2">"rclcpp"</span>
  <span class="s2">"rosbag2_cpp"</span>
  <span class="s2">"geometry_msgs"</span>
<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>demo02_reader src/demo02_reader.cpp<span class="p">)</span>
<span class="nf">ament_target_dependencies</span><span class="p">(</span>
  demo02_reader
  <span class="s2">"rclcpp"</span>
  <span class="s2">"rosbag2_cpp"</span>
  <span class="s2">"geometry_msgs"</span>
<span class="p">)</span>

<span class="nb">install</span><span class="p">(</span>TARGETS 
  demo01_writer
  demo02_reader
  DESTINATION lib/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="rosbag2-c-录制数据">rosbag2 C++ 录制数据</h2>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="cm">/* 
  需求：录制 turtle_teleop_key 节点发布的速度指令。
  步骤：
    1.包含头文件；
    2.初始化 ROS 客户端；
    3.定义节点类；
      3-1.创建写出对象指针；
      3-2.设置写出的目标文件；
      3-3.写出消息。
    4.调用 spin 函数，并传入对象指针；
    5.释放资源。

 */</span>
<span class="c1">// 1.包含头文件；</span>
<span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"rosbag2_cpp/writer.hpp"</span><span class="cp">
#include</span> <span class="cpf">"geometry_msgs/msg/twist.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>

<span class="c1">// 3.定义节点类；</span>
<span class="k">class</span> <span class="nc">SimpleBagRecorder</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">SimpleBagRecorder</span><span class="p">()</span>
  <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"simple_bag_recorder"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 3-1.创建写出对象指针；</span>
    <span class="n">writer_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">rosbag2_cpp</span><span class="o">::</span><span class="n">Writer</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="c1">// 3-2.设置写出的目标文件；(目录为ws目录)</span>
    <span class="n">writer_</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="s">"src/cpp02_rosbag/my_bag"</span><span class="p">);</span>
    <span class="n">subscription_</span> <span class="o">=</span> <span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="s">"/turtle1/cmd_vel"</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SimpleBagRecorder</span><span class="o">::</span><span class="n">topic_callback</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="nf">topic_callback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">SerializedMessage</span><span class="o">&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span> <span class="n">time_stamp</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
    <span class="c1">// 3-3.写出消息。</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"数据写出... ..."</span><span class="p">);</span>
    <span class="n">writer_</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">"/turtle1/cmd_vel"</span><span class="p">,</span> <span class="s">"geometry_msgs/msg/Twist"</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">subscription_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">rosbag2_cpp</span><span class="o">::</span><span class="n">Writer</span><span class="o">&gt;</span> <span class="n">writer_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="c1">// 2.初始化 ROS 客户端；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="c1">// 4.调用 spin 函数，并传入对象指针；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SimpleBagRecorder</span><span class="o">&gt;</span><span class="p">());</span>
  <span class="c1">// 5.释放资源。</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1248.webp" alt="" /></p>

<p>这是一个相对目录，目录位置是工作空间目录。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1249.webp" alt="" /></p>

<p>写数据之前，要先创建一个订阅方，订阅方要建立一个回调函数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1250.webp" alt="" /></p>

<p>回调函数入口参数，消息类型用write函数的入口参数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1251.webp" alt="" /></p>

<p>这里要用斜杠代替冒号，因为入口是string类型。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1252.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1253.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1254.webp" alt="" /></p>

<p>创建乌龟节点。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1255.webp" alt="" /></p>

<p>启动writer节点</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1256.webp" alt="" /></p>

<p>运行小乌龟</p>

<p>运行一会儿后，关掉所有节点。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1257.webp" alt="" /></p>

<p>成功生成了文件</p>

<p>验证录制文件是否成功。</p>

<p>在验证前，先创建一个乌龟节点，不用创建控制节点。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">bag</span> <span class="n">play</span> <span class="n">src</span><span class="o">/</span><span class="n">cpp02_rosbag</span><span class="o">/</span><span class="n">my_bag</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1258.webp" alt="" /></p>

<p>可以看到乌龟正常走了。回放成功！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1259.webp" alt="" /></p>

<p>如果已经生成了一遍my_bag，再想生成新的会显示不能覆盖。</p>

<p>解决方案，可以把my_bag设置为动态的，加个时间戳或者直接按功能命名。</p>

<h2 id="rosbag2-c-读取数据">rosbag2 C++ 读取数据</h2>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="cm">/* 
  需求：读取 bag 文件数据。
  步骤：
    1.包含头文件；
    2.初始化 ROS 客户端；
    3.定义节点类；
      3-1.创建读取对象指针；
      3-2.设置读取的目标文件；
      3-3.读消息；
      3-4.关闭文件。
    4.调用 spin 函数，并传入对象指针；
    5.释放资源。

 */</span>
 <span class="c1">// 1.包含头文件；</span>
 <span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
</span> <span class="cp">#include</span> <span class="cpf">"rosbag2_cpp/reader.hpp"</span><span class="cp">
</span> <span class="cp">#include</span> <span class="cpf">"geometry_msgs/msg/twist.hpp"</span><span class="cp">
</span> <span class="c1">// 3.定义节点类；</span>
<span class="k">class</span> <span class="nc">SimpleBagPlayer</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">SimpleBagPlayer</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"simple_bag_player"</span><span class="p">){</span>
        <span class="c1">// 3-1.创建读取对象指针；</span>
        <span class="n">reader_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">rosbag2_cpp</span><span class="o">::</span><span class="n">Reader</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="c1">// 3-2.设置读取的目标文件；</span>
        <span class="n">reader_</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="s">"src/cpp02_rosbag/my_bag"</span><span class="p">);</span>
        <span class="c1">// 3-3.读消息；</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">reader_</span><span class="o">-&gt;</span><span class="n">has_next</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">auto</span> <span class="n">twist</span> <span class="o">=</span> <span class="n">reader_</span><span class="o">-&gt;</span><span class="n">read_next</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span><span class="p">();</span>
            <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"线速度:%.2f, 角速度: %.2f"</span><span class="p">,</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 3-4.关闭文件。</span>
        <span class="n">reader_</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">rosbag2_cpp</span><span class="o">::</span><span class="n">Reader</span><span class="o">&gt;</span> <span class="n">reader_</span><span class="p">;</span>

<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]){</span>
    <span class="c1">// 2.初始化 ROS 客户端；</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
    <span class="c1">// 4.调用 spin 函数，并传入对象指针；</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SimpleBagPlayer</span><span class="o">&gt;</span><span class="p">());</span>
    <span class="c1">// 5.释放资源。</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1260.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1261.webp" alt="" /></p>

<p>编译</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1262.webp" alt="" /></p>

<p>这显示能读出来几条信息。能读出来8条。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1263.webp" alt="" /></p>

<p>正好8条</p>

<h1 id="坐标变换tf">坐标变换TF</h1>

<h2 id="坐标变换">坐标变换</h2>

<h3 id="引言与应用场景">引言与应用场景</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1264.webp" alt="" /></p>

<p><strong><code class="language-plaintext highlighter-rouge">里程计ODOM</code></strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">惯性计IMU</code></strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">激光雷达Laser</code></strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">摄像头Camera</code></strong></p>

<p>场景1：现有一移动式机器人底盘，在底盘上安装了一雷达，雷达相对于底盘的偏移量已知，现雷达检测到一障碍物信息，获取到坐标分别为(x,y,z)，该坐标是以雷达为参考系的，如何将这个坐标转换成以小车为参考系的坐标呢？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1265.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1266.webp" alt="" /></p>

<p>激光雷达与小车的中心或边缘相差的横纵距离，以及激光雷达与墙的距离及小车与墙的距离。</p>

<p>场景2:现有一带机械臂的机器人(比如:PR2)需要夹取目标物，当前机器人头部摄像头可以探测到目标物的坐标(x,y,z)，不过该坐标是以摄像头为参考系的，而实际操作目标物的是机械臂的夹具，当前我们需要将该坐标转换成相对于机械臂夹具的坐标，这个过程如何实现？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1267.webp" alt="" /></p>

<p>以上通过TF即可算</p>

<h3 id="概念与作用">概念与作用</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1268.webp" alt="" /></p>

<p>TF实行<strong>右手坐标系</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1269.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1270.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1271.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1272.webp" alt="" /></p>

<p>重要的就是相对位置和时间，在某个时间某个物体位于某个位置。（时间差太大，数据会被废弃）</p>

<h3 id="案例安装以及运行">案例安装以及运行</h3>

<p>安装乌龟案列：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># Humble版本安装</span>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>ros-humble-turtle-tf2-py ros-humble-tf2-tools ros-humble-tf-transformations

<span class="c"># Jazzy版本安装</span>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>ros-jazzy-turtle-tf2-py ros-jazzy-tf2-tools ros-jazzy-tf-transformations
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1273.webp" alt="" /></p>

<p>此外，还需要安装一个名为 <code class="language-plaintext highlighter-rouge">transforms3d</code> 的 Python 包，它为 <code class="language-plaintext highlighter-rouge">tf_transformations</code>包提供四元数和欧拉角变换功能，安装命令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
<span class="c"># 方式一（不推荐）</span>
<span class="nb">sudo </span>apt intall python3-pip
pip3 <span class="nb">install </span>transforms3d

<span class="c">#方式二（推荐）</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>python3-transforms3d
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1274.webp" alt="" /></p>

<p>启动两个终端，终端1输入如下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch turtle_tf2_py turtle_tf2_demo.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该命令会启动 turtlesim_node 节点，turtlesim_node 节点中自带一只小乌龟 turtle1，除此之外还会新生成一只乌龟 turtle2，turtle2 会运行至 turtle1 的位置。</p>

<p>终端2输入如下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtle_teleop_key
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该终端下可以通过键盘控制 turtle1 运动，并且 turtle2 会跟随 turtle1 运动（参考引言部分的 <strong>案例1</strong> ）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1275.webp" alt="" /></p>

<p>龟男🐢🚹会跟随前面的乌龟🐢运动</p>

<h3 id="坐标变换相关消息">坐标变换相关消息</h3>

<p>坐标变换的实现其本质是基于话题通信的发布订阅模型的，发布方可以发布坐标系之间的相对关系，订阅方则可以监听这些消息，并实现不同坐标系之间的变换。显然的根据之前介绍，在话题通信中，接口消息作为数据载体在整个通信模型中是比较重要的一部分，本节将会介绍坐标变换中常用的两种接口消息：<code class="language-plaintext highlighter-rouge">geometry_msgs/msg/TransformStamped</code>和<code class="language-plaintext highlighter-rouge">geometry_msgs/msg/PointStamped</code>。</p>

<p>前者用于描述某一时刻两个坐标系之间相对关系的接口，后者用于描述某一时刻坐标系内某个坐标点的位置的接口。在坐标变换中，会经常性的使用到坐标系相对关系以及坐标点信息。</p>

<h4 id="geometry_msgsmsgtransformstamped">geometry_msgs/msg/TransformStamped</h4>

<p>通过如下命令查看接口定义：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 interface show geometry_msgs/msg/TransformStamped
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接口定义解释：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>std_msgs/Header header
    builtin_interfaces/Time stamp     <span class="c"># 时间戳</span>
        int32 sec         <span class="c">#秒</span>
        uint32 nanosec    <span class="c">#纳秒</span>
    string frame_id                   <span class="c"># 父级坐标系</span>
string child_frame_id                 <span class="c"># 子级坐标系</span>
Transform transform                   <span class="c"># 子级坐标系相对于父级坐标系的位姿</span>
    Vector3 translation               <span class="c"># 三维偏移量</span>
        float64 x
        float64 y
        float64 z
    Quaternion rotation               <span class="c"># 四元数</span>
        float64 x 0
        float64 y 0
        float64 z 0
        float64 w 1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>描述一个物体运动一般有6个自由度：X，Y，Z，Yaw，Pitch，Roll。</p>

<p>三个平动，三个旋转：</p>

<p>Vector3 translation代表3个平移</p>

<p>Quaternion rotation四元数可以转化为三个欧拉角(yaw，pitch，roll)</p>

<p>（Q：为何不用欧拉角而用四元数？A：因为用欧拉角计算会出现死锁现象，所以选择用四元数，而不用欧拉角，以便避免欧拉角的缺陷。）</p>

<p>3个平移以米meter为单位</p>

<p>3个旋转以弧度rad为单位</p>

<p>四元数类似于欧拉角用于表示坐标系的相对姿态，</p>

<p>具体转化详见<a href="https://sdutvincirobot.feishu.cn/wiki/PVS8wQzRgiTRqpko9l4cEK33nhw">大疆开发板C型嵌入式软件教程文档.pdf</a>的18.3节</p>

<p>具体转化算法（Mahony算法）（ROS2的TF2库中也有具体的转化算法）：</p>

<p>https://x-io.co.uk/open-source-imu-and-ahrs-algorithms/</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1276.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1277.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1278.webp" alt="" /></p>

<p>按右手坐标系来看，N2相对于N1沿X轴平移了1m(一格代表1米）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1279.webp" alt="" /></p>

<p>旋转</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1280.webp" alt="" /></p>

<h4 id="geometry_msgsmsgpointstamped">geometry_msgs/msg/PointStamped</h4>

<p>通过如下命令查看接口定义：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 interface show geometry_msgs/msg/PointStamped
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接口定义解释：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>std_msgs/Header header
    builtin_interfaces/Time stamp    <span class="c"># 时间戳</span>
        int32 sec   <span class="c">#秒</span>
        uint32 nanosec   <span class="c">#纳秒</span>
    string frame_id                  <span class="c"># 参考系</span>
Point point                          <span class="c"># 三维坐标</span>
    float64 x
    float64 y
    float64 z
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在三维中的坐标点</p>

<h2 id="坐标变换广播">坐标变换广播</h2>

<h3 id="引言与案例及分析">引言与案例及分析</h3>

<p>坐标系相对关系主要有两种： <strong>静态坐标系相对关系</strong> 与 <strong>动态坐标系相对关系</strong> 。</p>

<p>所谓静态坐标系相对关系是指两个坐标系之间的相对位置是固定不变的，比如：车辆上的雷达、摄像头等组件一般是固定式的，那么雷达坐标系相对于车辆底盘坐标系或摄像头坐标系相对于车辆底盘坐标系就是一种静态关系。</p>

<p>所谓动态坐标系相对关系是指两个坐标系之间的相对位置关系是动态改变的，比如：车辆上机械臂的关节或夹爪、多车编队中不同车辆等都是可以运动的，那么机械臂的关节或夹爪坐标系相对车辆底盘坐标系或不同车辆坐标系的相对关系就是一种动态关系。</p>

<p>本节会主要介绍如何实现静态坐标变换广播与动态坐标变换广播。另外，本节还会演示如何发布坐标点消息。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1281.webp" alt="" /></p>

<p>激光雷达Laser和色相头与底盘位置是静态的，而机械臂的末端执行器与机器人的位置是动态的。</p>

<h4 id="1案例需求">1.案例需求</h4>

<p><strong>案例1：</strong> 现有一无人车，在无人车底盘上装有固定式的雷达与摄像头，已知车辆底盘、雷达与摄像头各对应一坐标系，各坐标系的原点取其几何中心。现又已知雷达坐标系相对于底盘坐标系的三维平移量分别为：x方向0.4米，y方向0米，z方向0.2米，无旋转。摄像头坐标系相对于底盘坐标系的三维平移量分别为：x方向-0.5米，y方向0米，z方向0.4米，无旋转。请广播雷达与底盘的坐标系相对关系，摄像头与底盘的坐标系相对关系，并在 rviz2 中查看广播的结果。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1282.webp" alt="" /></p>

<p><strong>案例2：</strong> 启动 turtlesim_node，设该节点中窗体有一个世界坐标系(左下角为坐标系原点)，乌龟是另一个坐标系，乌龟可以通过键盘控制运动，请动态发布乌龟坐标系与世界坐标系的相对关系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1283.webp" alt="" /></p>

<h4 id="2案例分析">2.案例分析</h4>

<p>在上述案例中，案例1需要使用到静态坐标变换，案例2则需要使用动态坐标变换，不论无论何种实现关注的要素都有两个：</p>

<ol>
  <li>
    <p>如何广播坐标系相对关系；</p>
  </li>
  <li>
    <p>如何使用 rviz2 显示坐标系相对关系。</p>
  </li>
</ol>

<h4 id="3流程简介">3.流程简介</h4>

<p>以编码的实现实现静态或动态坐标变换的流程类似，主要步骤如下：</p>

<ol>
  <li>
    <p>编写广播实现；</p>
  </li>
  <li>
    <p>编辑配置文件；</p>
  </li>
  <li>
    <p>编译；</p>
  </li>
  <li>
    <p>执行；</p>
  </li>
  <li>
    <p>在 rviz2 中查看坐标系关系。</p>
  </li>
</ol>

<p>案例我们会采用 C++ 和 Python 分别实现，二者都遵循上述实现流程。</p>

<p>另外：需要说明的是，静态广播器除了可以以编码的方式实现外，在 tf2 中还内置了相关工具，可以无需编码，直接执行节点并传入表示坐标系相对关系的参数，即可实现静态坐标系关系的发布（即命令行，有命令行可以优先用命令行）。而动态广播器没有提供类似的工具。（即必须敲代码）</p>

<h4 id="4准备工作">4.准备工作</h4>

<p>终端下进入工作空间的src目录，调用如下两条命令分别创建C++功能包。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp03_tf_broadcaster <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp tf2 tf2_ros geometry_msgs turtlesim
</pre></td></tr></tbody></table></code></pre></div></div>

<p>tf2功能包内包含了四元数与欧拉角的转换算法。</p>

<p>tf2_ros功能包内包含了广播对象。</p>

<p>geometry_msgs功能包消息载体</p>

<p>turtlesim功能包是获取乌龟🐢位姿</p>

<h3 id="静态广播器_命令行实现">静态广播器_命令行实现</h3>

<h4 id="1静态广播器工具">1.静态广播器工具</h4>

<p>在 <code class="language-plaintext highlighter-rouge">tf2_ros</code>功能包中提供了一个名为<code class="language-plaintext highlighter-rouge">static_transform_publisher</code>的可执行文件，通过该文件可以直接广播静态坐标系关系，其使用语法如下。</p>

<p><strong>格式1：</strong></p>

<p>使用以米为单位的 x/y/z 偏移量和以弧度为单位的roll/pitch/yaw（可直译为滚动/俯仰/偏航，分别指的是围绕 x/y/z 轴的旋转）向 tf2 发布静态坐标变换。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--x</span> x <span class="nt">--y</span> y <span class="nt">--z</span> z <span class="nt">--yaw</span> yaw <span class="nt">--pitch</span> pitch <span class="nt">--roll</span> roll <span class="nt">--frame-id</span> frame_id <span class="nt">--child-frame-id</span> child_frame_id
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1284.webp" alt="" /></p>

<p>父级坐标系和子级坐标系是必须要写的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1285.webp" alt="" /></p>

<p>如果这些可选参数不选的话，默认父级坐标系和子级坐标系重合，也就是偏移量和旋转度都是0。</p>

<p>偏移量：X,Y,Z</p>

<p>旋转度：QX,QY,QZ,QW <strong>或者</strong> ROLL,PITCH,YAW（单位是弧度）</p>

<p>时间戳：不用设置，会以发布的时间为起点</p>

<p><strong>格式2：</strong></p>

<p>使用以米为单位的 x/y/z 偏移量和 qx/qy/qz/qw 四元数向 tf2 发布静态坐标变换。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--x</span> x <span class="nt">--y</span> y <span class="nt">--z</span> z <span class="nt">--qx</span> qx <span class="nt">--qy</span> qy <span class="nt">--qz</span> qz <span class="nt">--qw</span> qw <span class="nt">--frame-id</span> frame_id <span class="nt">--child-frame-id</span> child_frame_id
</pre></td></tr></tbody></table></code></pre></div></div>

<p>注意：在上述两种格式中除了用于表示父级坐标系的<code class="language-plaintext highlighter-rouge">--frame-id</code>和用于表示子级坐标系的<code class="language-plaintext highlighter-rouge">--child-frame-id</code>之外，其他参数都是可选的，如果未指定特定选项，那么将直接使用默认值。</p>

<h4 id="2静态广播器工具使用">2.静态广播器工具使用</h4>

<p>打开两个终端，终端1输入如下命令发布雷达（laser）相对于底盘（base_link）的静态坐标变换（重合）：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--frame-id</span> base_link <span class="nt">--child-frame-id</span> laser
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1286.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1287.webp" alt="" /></p>

<p>base_link是父级参考系</p>

<p>laser是子级参考系</p>

<p>一般选父系参考系</p>

<h4 id="3rviz2-查看坐标系关系">3.rviz2 查看坐标系关系</h4>

<p>新建终端，通过命令<code class="language-plaintext highlighter-rouge">rviz2</code>打开 rviz2 并配置相关插件查看坐标变换消息：</p>

<ol>
  <li>
    <p>将 Global Options 中的 Fixed Frame 设置为 base_link；</p>
  </li>
  <li>
    <p>点击 add 按钮添加 TF 插件；</p>
  </li>
  <li>
    <p>勾选 TF 插件中的 show names。</p>
  </li>
</ol>

<p>右侧 Grid 中将以图形化的方式显示坐标变换关系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1288.webp" alt="" /></p>

<p>如图，两个参考系重合。</p>

<p>打开两个终端，终端1输入如下命令发布雷达（laser）相对于底盘（base_link）的静态坐标变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--x</span> 0.4 <span class="nt">--y</span> 0 <span class="nt">--z</span> 0.2 <span class="nt">--yaw</span> 0.5 <span class="nt">--roll</span> 0 <span class="nt">--pitch</span> 0 <span class="nt">--frame-id</span> base_link <span class="nt">--child-frame-id</span> laser
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端2输入如下命令发布摄像头（camera）相对于底盘（base_link）的静态坐标变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--x</span> <span class="nt">-0</span>.5 <span class="nt">--y</span> 0 <span class="nt">--z</span> 0.4 <span class="nt">--yaw</span> 0 <span class="nt">--roll</span> 0 <span class="nt">--pitch</span> 0 <span class="nt">--frame-id</span> base_link <span class="nt">--child-frame-id</span> camera
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1289.webp" alt="" /></p>

<h3 id="静态广播器_c实现">静态广播器_C++实现</h3>

<h4 id="框架搭建">框架搭建</h4>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nb">find_package</span><span class="p">(</span>ament_cmake REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>rclcpp REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>tf2 REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>tf2_ros REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>geometry_msgs REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>turtlesim REQUIRED<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>demo01_static_tf_broadcaster src/demo01_static_tf_broadcaster.cpp<span class="p">)</span>
<span class="nf">ament_target_dependencies</span><span class="p">(</span>
  demo01_static_tf_broadcaster
  <span class="s2">"rclcpp"</span>
  <span class="s2">"tf2"</span>
  <span class="s2">"tf2_ros"</span>
  <span class="s2">"geometry_msgs"</span>
  <span class="s2">"turtlesim"</span>
<span class="p">)</span>

<span class="nb">install</span><span class="p">(</span>TARGETS demo01_static_tf_broadcaster
  DESTINATION lib/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="广播实现">广播实现</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="rouge-code"><pre><span class="cm">/*  
  需求：编写静态坐标变换程序，执行时传入两个坐标系的相对位姿关系以及父子级坐标系id，
       程序运行发布静态坐标变换。
  步骤：
    1.包含头文件；
    2.判断终端传入的参数是否合法；
    3.初始化 ROS 客户端；
    4.定义节点类；
      4-1.创建静态坐标变换发布方；
      4-2.组织并发布消息。
    5.调用 spin 函数，并传入对象指针；
    6.释放资源。

*/</span>

<span class="c1">// 1.包含头文件；</span>
<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/msg/transform_stamped.hpp&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;rclcpp/rclcpp.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tf2/LinearMath/Quaternion.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tf2_ros/static_transform_broadcaster.h&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>

<span class="c1">// 4.定义节点类；</span>
<span class="k">class</span> <span class="nc">MinimalStaticFrameBroadcaster</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="n">MinimalStaticFrameBroadcaster</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">transformation</span><span class="p">[])</span><span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"minimal_static_frame_broadcaster"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 4-1.创建静态坐标变换发布方；</span>
    <span class="n">tf_publisher_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">StaticTransformBroadcaster</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="o">-&gt;</span><span class="n">make_transforms</span><span class="p">(</span><span class="n">transformation</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="c1">// 4-2.组织并发布消息。</span>
  <span class="kt">void</span> <span class="nf">make_transforms</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">transformation</span><span class="p">[])</span>
  <span class="p">{</span>
    <span class="c1">// 组织消息</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">TransformStamped</span> <span class="n">t</span><span class="p">;</span>

    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
    <span class="n">t</span><span class="p">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">transformation</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">transformation</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">transformation</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="n">tf2</span><span class="o">::</span><span class="n">Quaternion</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">q</span><span class="p">.</span><span class="n">setRPY</span><span class="p">(</span>
      <span class="n">atof</span><span class="p">(</span><span class="n">transformation</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
      <span class="n">atof</span><span class="p">(</span><span class="n">transformation</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
      <span class="n">atof</span><span class="p">(</span><span class="n">transformation</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">w</span><span class="p">();</span>

    <span class="c1">// 发布消息</span>
    <span class="n">tf_publisher_</span><span class="o">-&gt;</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">StaticTransformBroadcaster</span><span class="o">&gt;</span> <span class="n">tf_publisher_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="c1">// 2.判断终端传入的参数是否合法；</span>
  <span class="k">auto</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"logger"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RCLCPP_INFO</span><span class="p">(</span>
      <span class="n">logger</span><span class="p">,</span> <span class="s">"运行程序时请按照：x y z roll pitch yaw frame_id child_frame_id 的格式传入参数"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 3.初始化 ROS 客户端；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="c1">// 5.调用 spin 函数，并传入对象指针；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MinimalStaticFrameBroadcaster</span><span class="o">&gt;</span><span class="p">(</span><span class="n">argv</span><span class="p">));</span>
  <span class="c1">// 6.释放资源。</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1290.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1291.webp" alt="" /></p>

<p>必须传参正确，否则抛错。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1292.webp" alt="" /></p>

<p>创建组织并发布数据的函数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1293.webp" alt="" /></p>

<p>用最简单的重载。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1294.webp" alt="" /></p>

<p>这样就可以发送了，接下来编辑发送的内容。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1295.webp" alt="" /></p>

<p>stamp时间戳设置为当前时间，now()函数是设置为当前时间。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1296.webp" alt="" /></p>

<p>atof()是转化为float浮点类型</p>

<p>x()和getx()都是获取四元数x。（y，z，w以此类推）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1297.webp" alt="" /></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> cpp03_tf_broadcaster
</pre></td></tr></tbody></table></code></pre></div></div>

<p>当前工作空间下，启动两个终端，终端1输入如下命令发布雷达（laser）相对于底盘（base_link）的静态坐标变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash 
ros2 run cpp03_tf_broadcaster demo01_static_tf_broadcaster 0.4 0 0.2 0 0 0 base_link laser
</pre></td></tr></tbody></table></code></pre></div></div>

<p>参考 <strong>静态广播器（命令）</strong> 内容启动并配置 rviz2，最终执行结果与案例1类似。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1298.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1299.webp" alt="" /></p>

<p>本质就是话题通信，但这个话题通信的topic是啥呢？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1300.webp" alt="" /></p>

<p>通过查看该类源码，就得知，话题为/tf_static</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1301.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1302.webp" alt="" /></p>

<p>发布方有俩，订阅方有一个。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1303.webp" alt="" /></p>

<p>这俩是发布方</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1304.webp" alt="" /></p>

<p>这个是订阅方</p>

<h3 id="动态广播器_c实现">动态广播器_C++实现</h3>

<h4 id="框架搭建-1">框架搭建</h4>

<p>CMakeLists.txt 文件需要添加如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">add_executable</span><span class="p">(</span>demo02_dynamic_tf_broadcaster src/demo02_dynamic_tf_broadcaster.cpp<span class="p">)</span>
<span class="nf">ament_target_dependencies</span><span class="p">(</span>
  demo02_dynamic_tf_broadcaster
  <span class="s2">"rclcpp"</span>
  <span class="s2">"tf2"</span>
  <span class="s2">"tf2_ros"</span>
  <span class="s2">"geometry_msgs"</span>
  <span class="s2">"turtlesim"</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>文件中 install 修改为如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>TARGETS demo01_static_tf_broadcaster
  demo02_dynamic_tf_broadcaster
  DESTINATION lib/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="广播实现-1">广播实现</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="rouge-code"><pre><span class="cm">/*   
  需求：编写动态坐标变换程序，启动 turtlesim_node 以及 turtle_teleop_key 后，该程序可以发布
       乌龟坐标系到窗口坐标系的坐标变换，并且键盘控制乌龟运动时，乌龟坐标系与窗口坐标系的相对关系
       也会实时更新。

  步骤：
    1.包含头文件；
    2.初始化 ROS 客户端；
    3.定义节点类；
      3-1.创建动态坐标变换发布方；
      3-2.创建乌龟位姿订阅方；
      3-3.根据订阅到的乌龟位姿生成坐标帧并广播。
    4.调用 spin 函数，并传入对象指针；
    5.释放资源。

*/</span>
<span class="c1">// 1.包含头文件；</span>
<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/msg/transform_stamped.hpp&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;rclcpp/rclcpp.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tf2/LinearMath/Quaternion.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tf2_ros/transform_broadcaster.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;turtlesim/msg/pose.hpp&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>

<span class="c1">// 3.定义节点类；</span>
<span class="k">class</span> <span class="nc">MinimalDynamicFrameBroadcaster</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">MinimalDynamicFrameBroadcaster</span><span class="p">()</span><span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"minimal_dynamic_frame_broadcaster"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 3-1.创建动态坐标变换发布方；</span>
    <span class="n">tf_broadcaster_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformBroadcaster</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">topic_name</span> <span class="o">=</span> <span class="s">"/turtle1/pose"</span><span class="p">;</span>

    <span class="c1">// 3-2.创建乌龟位姿订阅方；</span>
    <span class="n">subscription_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">turtlesim</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Pose</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="n">topic_name</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
      <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MinimalDynamicFrameBroadcaster</span><span class="o">::</span><span class="n">handle_turtle_pose</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="c1">// 3-3.根据订阅到的乌龟位姿生成坐标帧并广播。   </span>
  <span class="kt">void</span> <span class="nf">handle_turtle_pose</span><span class="p">(</span><span class="k">const</span> <span class="n">turtlesim</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Pose</span> <span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 组织消息</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">TransformStamped</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>

    <span class="n">t</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">"world"</span><span class="p">;</span>   <span class="c1">//窗体坐标系</span>
    <span class="n">t</span><span class="p">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="s">"turtle1"</span><span class="p">;</span>  <span class="c1">//乌龟坐标系</span>

    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>      <span class="c1">//乌龟在平面内运动</span>

    <span class="c1">//从欧拉角转换为四元数</span>
    <span class="n">tf2</span><span class="o">::</span><span class="n">Quaternion</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">q</span><span class="p">.</span><span class="n">setRPY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">theta</span><span class="p">);</span>        <span class="c1">//乌龟只有Yaw</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">w</span><span class="p">();</span>
    <span class="c1">// 发布消息</span>
    <span class="n">tf_broadcaster_</span><span class="o">-&gt;</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">turtlesim</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Pose</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">subscription_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformBroadcaster</span><span class="o">&gt;</span> <span class="n">tf_broadcaster_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="c1">// 2.初始化 ROS 客户端；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="c1">// 4.调用 spin 函数，并传入对象指针；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MinimalDynamicFrameBroadcaster</span><span class="o">&gt;</span><span class="p">());</span>
  <span class="c1">// 5.释放资源。</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1305.webp" alt="" /></p>

<p>入口参数：</p>

<p>参数1话题名称</p>

<p>参数2QoS</p>

<p>参数3回调函数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1306.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1307.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1308.webp" alt="" /></p>

<p>操控乌龟运动，会使乌龟在Rviz2里也运动</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1309.webp" alt="" /></p>

<h3 id="坐标点发布_c实现">坐标点发布_C++实现</h3>

<h4 id="案例与分析">案例与分析</h4>

<p><strong>案例需求</strong></p>

<p><strong>案例：</strong> 无人车上安装有激光雷达，现激光雷达扫描到一点状障碍物并且可以定位障碍物的坐标，请在雷达坐标系下发布障碍物坐标点数据，并在 rviz2 中查看发布结果。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1310.webp" alt="" /></p>

<p><strong>案例分析</strong></p>

<p>上述案例，是一个简单的话题发布程序，在了解坐标点<code class="language-plaintext highlighter-rouge">geometry_msgs/msg/PointStamped</code>接口消息之后，直接通过话题发布方按照一定逻辑发布消息即可。</p>

<p><strong>流程简介</strong></p>

<p>程序实现主要步骤如下：</p>

<ol>
  <li>
    <p>编写话题发布实现；</p>
  </li>
  <li>
    <p>编辑配置文件；</p>
  </li>
  <li>
    <p>编译；</p>
  </li>
  <li>
    <p>执行；</p>
  </li>
  <li>
    <p>在 rviz2 中查看运行结果。</p>
  </li>
</ol>

<p>案例我们会采用 C++ 和 Python 分别实现，二者都遵循上述实现流程。</p>

<p>CMakeLists.txt 文件需要添加如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">add_executable</span><span class="p">(</span>demo03_point_publisher src/demo03_point_publisher.cpp<span class="p">)</span>
<span class="nf">ament_target_dependencies</span><span class="p">(</span>
  demo03_point_publisher
  <span class="s2">"rclcpp"</span>
  <span class="s2">"tf2"</span>
  <span class="s2">"tf2_ros"</span>
  <span class="s2">"geometry_msgs"</span>
  <span class="s2">"turtlesim"</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>文件中 install 修改为如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>TARGETS demo01_static_tf_broadcaster
  demo02_dynamic_tf_broadcaster
  demo03_point_publisher
  DESTINATION lib/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="实现">实现</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="cm">/*  
    需求：发布雷达坐标系中某个坐标点相对于雷达（laser）坐标系的位姿。
    步骤：
        1.包含头文件；
        2.初始化 ROS 客户端；
        3.定义节点类；
            3-1.创建坐标点发布方；
            3-2.创建定时器；
            3-3.组织并发布坐标点消息。
        4.调用 spin 函数，并传入对象指针；
        5.释放资源。

*/</span>
<span class="c1">// 1.包含头文件；</span>
<span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"geometry_msgs/msg/point_stamped.hpp"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="c1">// 3.定义节点类；</span>
<span class="k">class</span> <span class="nc">MinimalPointPublisher</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">MinimalPointPublisher</span><span class="p">()</span><span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"minimal_point_publisher"</span><span class="p">),</span><span class="n">x</span><span class="p">(</span><span class="mf">0.1</span><span class="p">){</span>
        <span class="c1">// 3-1.创建坐标点发布方；</span>
        <span class="n">point_pub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"point"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="c1">// 3-2.创建定时器；</span>
        <span class="n">timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mx">0.1s</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MinimalPointPublisher</span><span class="o">::</span><span class="n">on_timer</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
    <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">on_timer</span><span class="p">(){</span>
        <span class="c1">// 3-3.组织并发布坐标点消息。</span>
        <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span> <span class="n">point</span><span class="p">;</span>
        <span class="n">point</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">"laser"</span><span class="p">;</span>
        <span class="n">point</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.004</span><span class="p">;</span>
        <span class="n">point</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="n">point</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
        <span class="n">point</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>        
        <span class="n">point_pub_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">point</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">point_pub_</span><span class="p">;</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">timer_</span><span class="p">;</span>
    <span class="n">double_t</span> <span class="n">x</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="c1">// 2.初始化 ROS 客户端；</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
    <span class="c1">// 4.调用 spin 函数，并传入对象指针；</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MinimalPointPublisher</span><span class="o">&gt;</span><span class="p">());</span>
    <span class="c1">// 5.释放资源。</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1311.webp" alt="" /></p>

<p>创建定时器用create_wall_time()函数，要填时间间隔和对应的回调函数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1312.webp" alt="" /></p>

<p><strong>执行</strong></p>

<p>当前工作空间下，启动两个终端，终端1输入如下命令发布雷达（laser）相对于底盘（base_link）的静态坐标变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash 
ros2 run cpp03_tf_broadcaster demo01_static_tf_broadcaster 0.4 0 0.2 0 0 0 base_link laser
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端2输入如下命令发布障碍物相对于雷达（laser）的坐标点：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash 
ros2 run cpp03_tf_broadcaster demo03_point_publisher
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>rviz2 查看坐标系关系</strong></p>

<p>参考 <strong>5.3.2 静态广播器（命令）</strong> 内容启动并配置 rviz2，显示坐标变换后，再添加 PointStamped 插件并将其话题设置为 /point，最终显示结果与案例演示类似。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1313.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1314.webp" alt="" /></p>

<p>通过这里可以改球的透明度和大小</p>

<h3 id="小结">小结</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1315.webp" alt="" /></p>

<p>静态广播只发布一次。</p>

<p>而动态广播和坐标点广播都是发布多次。</p>

<p>但实质上就是话题通信。</p>

<h2 id="坐标变换监听">坐标变换监听</h2>

<h3 id="案例与分析-1">案例与分析</h3>

<p><strong>案例1：</strong> 在 <strong>5.3 坐标变换广播</strong> 中发布了laser相对于base_link和camra相对于base_link的坐标系关系，请求解laser相对于camera的坐标系关系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1316.webp" alt="" /></p>

<p><strong>案例2：</strong> 在 <strong>5.3 坐标变换广播</strong> 中发布了laser相对于base_link的坐标系关系且发布了laser坐标系下的障碍物的坐标点数据，请求解base_link坐标系下该障碍物的坐标。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1317.webp" alt="" /></p>

<p><strong>案例分析</strong></p>

<p>在上述案例中，案例1是多坐标系的场景下实现不同坐标系之间的变换，案例2则是要实现同一坐标点在不同坐标系下的变换，虽然需求不同，但是相关算法都被封装好了，我们只需要调用相关 API 即可。</p>

<p><strong>流程简介</strong></p>

<p>两个案例的实现流程类似，主要步骤如下：</p>

<ol>
  <li>
    <p>编写坐标变换程序实现；</p>
  </li>
  <li>
    <p>编辑配置文件；</p>
  </li>
  <li>
    <p>编译；</p>
  </li>
  <li>
    <p>执行。</p>
  </li>
</ol>

<p>案例我们会采用 C++ 和 Python 分别实现，二者都遵循上述实现流程。</p>

<p><strong>准备工作</strong></p>

<p>终端下进入工作空间的src目录，调用如下两条命令分别创建C++功能包和Python功能包。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp04_tf_listener <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp tf2 tf2_ros geometry_msgs <span class="nt">--node-name</span> demo01_tf_listener
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="坐标-系-变换监听_c">坐标 <strong>系</strong> 变换监听_C++</h3>

<h4 id="实例分析">实例分析</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1318.webp" alt="" /></p>

<p>与之前实现不太一样，要保存到buffer中。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1319.webp" alt="" /></p>

<p>因为之前的广播是发一条订阅一条。</p>

<p>但是在坐标变换中，是多对一实现的。</p>

<p>多个广播发布的消息组成一个坐标树，要从坐标树中获取不同坐标帧的变换。</p>

<p>把多条广播方的消息组成坐标树，就要使用buffer，把消息全部存到缓存buffer中。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1320.webp" alt="" /></p>

<p>这里为何要做异常处理呢？</p>

<p>因为进程间的通信开销比较大，是有延迟的，可能程序要开始做变换了，可惜消息还没订阅到。</p>

<p>消息都没有，就会抛异常。直到buffer里有数据，坐标也转化成功，才不会抛异常。</p>

<h4 id="实现-1">实现</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="cm">/*  
  需求：订阅 laser 到 base_link 以及 camera 到 base_link 的坐标系关系，
       并生成 laser 到 camera 的坐标变换。
  步骤：
    1.包含头文件；
    2.初始化 ROS 客户端；
    3.定义节点类；
      3-1.创建tf缓存对象指针；融合多个坐标系相对关系为一棵坐标树。
      3-2.创建tf监听器；指定缓存对象，会将所有广播器广播的数据写入缓存。
      3-3.编写定时器，循环实现转换；按照条件查找符合条件的坐标系并生成变换后的坐标帧。
    4.调用 spin 函数，并传入对象指针；
    5.释放资源。

*/</span>
<span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"tf2_ros/transform_listener.h"</span><span class="cp">
#include</span> <span class="cpf">"tf2_ros/buffer.h"</span><span class="cp">
#include</span> <span class="cpf">"tf2/LinearMath/Quaternion.h"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="c1">// 3.定义节点类；</span>
<span class="k">class</span> <span class="nc">MinimalFrameListener</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">MinimalFrameListener</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"minimal_frame_listener"</span><span class="p">){</span>
    <span class="n">tf_buffer_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">());</span>
    <span class="n">transform_listener_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformListener</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">tf_buffer_</span><span class="p">);</span>
    <span class="n">timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mx">1s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MinimalFrameListener</span><span class="o">::</span><span class="n">on_timer</span><span class="p">,</span><span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="nf">on_timer</span><span class="p">(){</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="k">auto</span> <span class="n">transformStamped</span> <span class="o">=</span> <span class="n">tf_buffer_</span><span class="o">-&gt;</span><span class="n">lookupTransform</span><span class="p">(</span><span class="s">"camera"</span><span class="p">,</span><span class="s">"laser"</span><span class="p">,</span><span class="n">tf2</span><span class="o">::</span><span class="n">TimePointZero</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"----------------------转换结果----------------------"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"frame_id:%s"</span><span class="p">,</span><span class="n">transformStamped</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"child_frame_id:%s"</span><span class="p">,</span><span class="n">transformStamped</span><span class="p">.</span><span class="n">child_frame_id</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"坐标:(%.2f,%.2f,%.2f)"</span><span class="p">,</span>
                <span class="n">transformStamped</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">transformStamped</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">transformStamped</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">tf2</span><span class="o">::</span><span class="n">LookupException</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"坐标变换异常：%s"</span><span class="p">,</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>

  <span class="p">}</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">timer_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformListener</span><span class="o">&gt;</span> <span class="n">transform_listener_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">tf_buffer_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="c1">// 2.初始化 ROS 客户端；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
  <span class="c1">// 4.调用 spin 函数，并传入对象指针；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MinimalFrameListener</span><span class="o">&gt;</span><span class="p">());</span>
  <span class="c1">// 5.释放资源。</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1321.webp" alt="" /></p>

<p>要填回调函数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1322.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1323.webp" alt="" /></p>

<p>实现坐标系转换的核心函数就是lookuptransform()</p>

<p>target_frame就是父级</p>

<p>source_frame就是子级</p>

<p>time是时间，一般都写最新时刻的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1324.webp" alt="" /></p>

<p>如果buffer没捕获到，抛异常的函数实现</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1325.webp" alt="" /></p>

<p>这样就成功转换坐标了，可以打印转换的坐标。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1326.webp" alt="" /></p>

<p>除了用try catch处理转换异常，还可以用buffer底下的函数转换。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1327.webp" alt="" /></p>

<p>比如这个cantransform可以判断是否可以正常转换。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1328.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1329.webp" alt="" /></p>

<p>这种报错要改为C风格字符串</p>

<p>启动三个终端，终端1输入如下命令发布雷达（laser）相对于底盘（base_link）的静态坐标变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--frame-id</span> base_link <span class="nt">--child-frame-id</span> camera <span class="nt">--x</span> <span class="nt">-0</span>.5 <span class="nt">--z</span> <span class="nt">-0</span>.4
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端2输入如下命令发布摄像头（camera）相对于底盘（base_link）的静态坐标变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--frame-id</span> base_link <span class="nt">--child-frame-id</span> laser--x 0.4 <span class="nt">--z</span> 0.2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端3输入如下命令执行坐标系变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash 
ros2 run cpp04_tf_listener demo01_tf_listener
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端3将输出 laser 相对于 camera 的坐标，具体结果请参考案例1。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1330.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1331.webp" alt="" /></p>

<p>当只运行一个广播，他会抛错。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1332.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1333.webp" alt="" /></p>

<p>当所有广播都跑起来时，才会正常转换。</p>

<h3 id="坐标-点-变换监听_c">坐标 <strong>点</strong> 变换监听_C++</h3>

<h4 id="实现框架">实现框架</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1334.webp" alt="" /></p>

<p>求laser测得的坐标点到base_link的距离</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1335.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1336.webp" alt="" /></p>

<p>laser到point的坐标用的是point话题，与监听器用的话题不一样，所以不好订阅，要创建一个新的订阅对象。</p>

<h4 id="框架搭建-2">框架搭建</h4>

<p>package.xml在创建功能包时，所依赖的部分功能包已经自动配置了，不过为了实现坐标点变换，还需要添加依赖包<code class="language-plaintext highlighter-rouge">tf2_geometry_msgs</code>和</p>

<p><code class="language-plaintext highlighter-rouge">message_filters</code>，修改后的配置内容如下：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;depend&gt;</span>rclcpp<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>tf2<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>tf2_ros<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>geometry_msgs<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>tf2_geometry_msgs<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>message_filters<span class="nt">&lt;/depend&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>CMakeLists.txt 文件修改后的内容如下：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>find dependencies
<span class="nb">find_package</span><span class="p">(</span>ament_cmake REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>rclcpp REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>tf2 REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>tf2_ros REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>geometry_msgs REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>tf2_geometry_msgs REQUIRED<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>message_filters REQUIRED<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>demo01_tf_listener src/demo01_tf_listener.cpp<span class="p">)</span>
<span class="nf">ament_target_dependencies</span><span class="p">(</span>
  demo01_tf_listener
  <span class="s2">"rclcpp"</span>
  <span class="s2">"tf2"</span>
  <span class="s2">"tf2_ros"</span>
  <span class="s2">"geometry_msgs"</span>
<span class="p">)</span>
<span class="nb">add_executable</span><span class="p">(</span>demo02_message_filter src/demo02_message_filter.cpp<span class="p">)</span>
<span class="nf">ament_target_dependencies</span><span class="p">(</span>
  demo02_message_filter
  <span class="s2">"rclcpp"</span>
  <span class="s2">"tf2"</span>
  <span class="s2">"tf2_ros"</span>
  <span class="s2">"geometry_msgs"</span>
  <span class="s2">"tf2_geometry_msgs"</span>
  <span class="s2">"message_filters"</span>
<span class="p">)</span>
<span class="nb">install</span><span class="p">(</span>TARGETS demo01_tf_listener
  demo02_message_filter
  DESTINATION lib/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="实现-2">实现</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre><span class="cm">/*  
  需求：将雷达感知到的障碍物的坐标点数据（相对于 laser 坐标系），
       转换成相对于底盘坐标系（base_link）的坐标点。

  步骤：
    1.包含头文件；
    2.初始化 ROS 客户端；
    3.定义节点类；
      3-1.创建tf缓存对象指针；
      3-2.创建tf监听器；
      3-3.创建坐标点订阅方并订阅指定话题；
      3-4.创建消息过滤器过滤被处理的数据；
      3-5.为消息过滤器注册转换坐标点数据的回调函数。
    4.调用 spin 函数，并传入对象指针；
    5.释放资源。

*/</span><span class="c1">// 1.包含头文件；#include &lt;geometry_msgs/msg/point_stamped.hpp&gt;#include &lt;message_filters/subscriber.h&gt;#include &lt;rclcpp/rclcpp.hpp&gt;#include &lt;tf2_ros/buffer.h&gt;#include &lt;tf2_ros/create_timer_ros.h&gt;#include &lt;tf2_ros/message_filter.h&gt;#include &lt;tf2_ros/transform_listener.h&gt;// #ifdef TF2_CPP_HEADERS//   #include &lt;tf2_geometry_msgs/tf2_geometry_msgs.hpp&gt;// #else//   #include &lt;tf2_geometry_msgs/tf2_geometry_msgs.h&gt;// #endif#include &lt;tf2_geometry_msgs/tf2_geometry_msgs.hpp&gt;using namespace std::chrono_literals;</span>

<span class="c1">// 3.定义节点类；class MessageFilterPointListener : public rclcpp::Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">MessageFilterPointListener</span><span class="p">()</span><span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"message_filter_point_listener"</span><span class="p">)</span>
  <span class="p">{</span>

    <span class="n">target_frame_</span> <span class="o">=</span> <span class="s">"base_link"</span><span class="p">;</span>

    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">seconds_type</span><span class="p">;</span>
    <span class="n">seconds_type</span> <span class="n">buffer_timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="c1">// 3-1.创建tf缓存对象指针；</span>
    <span class="n">tf2_buffer_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">());</span>
    <span class="k">auto</span> <span class="n">timer_interface</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">CreateTimerROS</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_base_interface</span><span class="p">(),</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_timers_interface</span><span class="p">());</span>
    <span class="n">tf2_buffer_</span><span class="o">-&gt;</span><span class="n">setCreateTimerInterface</span><span class="p">(</span><span class="n">timer_interface</span><span class="p">);</span>
    <span class="c1">// 3-2.创建tf监听器；</span>
    <span class="n">tf2_listener_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformListener</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">tf2_buffer_</span><span class="p">);</span>

    <span class="c1">// 3-3.创建坐标点订阅方并订阅指定话题；</span>
    <span class="n">point_sub_</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">"point"</span><span class="p">);</span>
    <span class="c1">// 3-4.创建消息过滤器过滤被处理的数据；</span>
    <span class="n">tf2_filter_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">MessageFilter</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span><span class="o">&gt;&gt;</span><span class="p">(</span>
      <span class="n">point_sub_</span><span class="p">,</span> <span class="o">*</span><span class="n">tf2_buffer_</span><span class="p">,</span> <span class="n">target_frame_</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_logging_interface</span><span class="p">(),</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_clock_interface</span><span class="p">(),</span> <span class="n">buffer_timeout</span><span class="p">);</span>
    <span class="c1">// 3-5.为消息过滤器注册转换坐标点数据的回调函数。</span>
    <span class="n">tf2_filter_</span><span class="o">-&gt;</span><span class="n">registerCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MessageFilterPointListener</span><span class="o">::</span><span class="n">msgCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="nf">msgCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">point_ptr</span><span class="p">){</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span> <span class="n">point_out</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">tf2_buffer_</span><span class="o">-&gt;</span><span class="n">transform</span><span class="p">(</span><span class="o">*</span><span class="n">point_ptr</span><span class="p">,</span> <span class="n">point_out</span><span class="p">,</span> <span class="n">target_frame_</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"坐标点相对于base_link的坐标:(%.2f,%.2f,%.2f)"</span><span class="p">,</span>
        <span class="n">point_out</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">point_out</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
        <span class="n">point_out</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">tf2</span><span class="o">::</span><span class="n">TransformException</span> <span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">RCLCPP_WARN</span><span class="p">(</span>
        <span class="c1">// Print exception which was caughtthis-&gt;get_logger(), "Failure %s\n", ex.what());</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">target_frame_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">tf2_buffer_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformListener</span><span class="o">&gt;</span> <span class="n">tf2_listener_</span><span class="p">;</span>
  <span class="n">message_filters</span><span class="o">::</span><span class="n">Subscriber</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span><span class="o">&gt;</span> <span class="n">point_sub_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">MessageFilter</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointStamped</span><span class="o">&gt;&gt;</span> <span class="n">tf2_filter_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
  <span class="c1">// 2.初始化 ROS 客户端；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="c1">// 4.调用 spin 函数，并传入对象指针；</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MessageFilterPointListener</span><span class="o">&gt;</span><span class="p">());</span>
  <span class="c1">// 5.释放资源。</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1337.webp" alt="" /></p>

<p>把上面此参数设置一下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1338.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1339.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1340.webp" alt="" /></p>

<p>进行数据解析</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1341.webp" alt="" /></p>

<p>用第一个重载。</p>

<p>转换过程会抛异常，可以不管他。转化失败会在终端上自动抛异常。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1342.webp" alt="" /></p>

<p>在当前工作空间下，启动三个终端，终端1输入如下命令发布雷达（laser）相对于底盘（base_link）的静态坐标变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash 
ros2 run cpp03_tf_broadcaster demo01_static_tf_broadcaster 0.4 0 0.2 0 0 0 base_link laser
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端2输入如下命令发布障碍物相对于雷达（laser）的坐标点：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash 
ros2 run cpp03_tf_broadcaster demo03_point_publisher
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端3输入如下命令执行坐标点变换：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash 
ros2 run cpp04_tf_listener demo02_message_filter
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端3将输出坐标点相对于 base_link 的坐标，具体结果请参考案例2。</p>

<p>按顺序依次发布</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1343.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1344.webp" alt="" /></p>

<h2 id="坐标变换工具">坐标变换工具</h2>

<p>在 ROS2 的 TF 框架中除了封装了坐标广播与订阅功能外，还提供了一些工具，可以帮助我们提高开发、调试效率。本节主要介绍这些工具的使用，这些工具主要涉及到两个功能包：<code class="language-plaintext highlighter-rouge">tf2_ros</code>和<code class="language-plaintext highlighter-rouge">tf2_tools</code>。</p>

<p><code class="language-plaintext highlighter-rouge">tf2_ros</code>包中提供的常用节点如下：</p>

<ul>
  <li>
    <p>static_transform_publisher：该节点用于广播静态坐标变换；（用过很多次了）</p>
  </li>
  <li>
    <p>tf2_monitor：该节点用于打印所有或特定坐标系的发布频率与网络延迟；</p>
  </li>
  <li>
    <p>tf2_echo：该节点用于打印特定坐标系的平移旋转关系。</p>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">tf2_tools</code>包中提供的节点如下：</p>

<ul>
  <li>view_frames：该节点可以生成显示坐标系关系的 pdf 文件，该文件包含树形结构的坐标系图谱。</li>
</ul>

<p>上述诸多工具中，功能包<code class="language-plaintext highlighter-rouge">tf2_ros</code>中的<code class="language-plaintext highlighter-rouge">static_transform_publisher</code>节点在 <strong>静态广播器（命令）</strong> 一节中已有详细说明，本节不再介绍。</p>

<p><strong>准备工作：</strong></p>

<p>为了更好的演示工具的使用，请先启动若干坐标系广播节点，比如：可以按照 <strong>静态广播器（命令）</strong> 和 <strong>动态广播器（C++）</strong> 广播一些坐标系消息。</p>

<p>第一个终端：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--x</span> 0.4 <span class="nt">--y</span> 0 <span class="nt">--z</span> 0.2 <span class="nt">--yaw</span> 0.5 <span class="nt">--roll</span> 0 <span class="nt">--pitch</span> 0 <span class="nt">--frame-id</span> base_link <span class="nt">--child-frame-id</span> laser
</pre></td></tr></tbody></table></code></pre></div></div>

<p>第二个终端：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros static_transform_publisher <span class="nt">--x</span> <span class="nt">-0</span>.5 <span class="nt">--y</span> 0 <span class="nt">--z</span> 0.4 <span class="nt">--yaw</span> 0 <span class="nt">--roll</span> 0 <span class="nt">--pitch</span> 0 <span class="nt">--frame-id</span> base_link <span class="nt">--child-frame-id</span> camera
</pre></td></tr></tbody></table></code></pre></div></div>

<p>第三个终端：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtlesim_node
</pre></td></tr></tbody></table></code></pre></div></div>

<p>第四个终端：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run turtlesim turtle_teleop_key
</pre></td></tr></tbody></table></code></pre></div></div>

<p>第五个终端：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">source install</span>/setup.bash
ros2 run cpp03_tf_broadcaster demo02_dynamic_tf_broadcaster
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1345.webp" alt="" /></p>

<p>以上是准备工作</p>

<h4 id="1tf2_monitor">1.tf2_monitor</h4>

<h5 id="11打印所有坐标系的发布频率与网络延迟">1.1打印所有坐标系的发布频率与网络延迟</h5>

<p>终端执行命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros tf2_monitor
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1346.webp" alt="" /></p>

<p>该命令有10s的阻塞时间，因为要在一个区间内测频率。</p>

<p>静态的没有变化，而动态的发布频率是有一些变化的。</p>

<p>该函数每隔10s会再发布一次。</p>

<h5 id="12打印指定坐标系的发布频率与网络延迟">1.2打印指定坐标系的发布频率与网络延迟</h5>

<p>终端执行命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros tf2_monitor camera laser
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1347.webp" alt="" /></p>

<p>刚开始在缓存里拿不到数据抛错很正常。</p>

<h4 id="2tf2_echo">2.tf2_echo</h4>

<p>打印两个坐标系的平移旋转关系。</p>

<p>终端执行命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_ros tf2_echo world turtle1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1348.webp" alt="" /></p>

<p>会出平移量和旋转量</p>

<p>会以好几种方式表现，如<em>平移距离，四元数，弧度欧拉角，角度欧拉角，矩阵</em>等。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1349.webp" alt="" /></p>

<p>当龟男🐢🚹动弹的时候，数值也会发生改变。</p>

<h4 id="3view_frames常用">3.view_frames（常用）</h4>

<p>以图形化的方式显示坐标系关系。</p>

<p>终端执行命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run tf2_tools view_frames
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果：将会在<strong>当前目录</strong>下生成 frames_xxxx.gv 与 frames_xxxx.pdf 文件，其中 xxxx 为时间戳。打开 pdf 文件显示如下内容：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1350.webp" alt="" /></p>

<p>此节点会监听我们5秒钟，并生成对应的文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1351.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1352.webp" alt="" /></p>

<p>上图中有两棵坐标树，但是实际上的项目中，咱们只能设计一棵树，而不能设计两个坐标树。</p>

<h2 id="练习">练习</h2>

<h3 id="乌龟跟随">乌龟跟随</h3>

<h3 id="乌龟护航">乌龟护航</h3>

<h2 id="小结-1">小结</h2>

<h1 id="可视化平台rviz2与urdf建模语言">可视化平台RVIZ2与URDF建模语言</h1>

<h2 id="可视化简介">可视化简介</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1353.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1354.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1355.webp" alt="" /></p>

<p>坐标相关、激光雷达相关、摄像头相关的rviz2插件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1356.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1357.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1358.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1359.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1360.webp" alt="" /></p>

<h2 id="rviz2基本使用">rviz2基本使用</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1361.webp" alt="" /></p>

<p>以<code class="language-plaintext highlighter-rouge">sudo apt install ros-[ROS_DISTRO]-desktop</code>格式安装ROS2时，RViz已经默认被安装了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-[ROS_DISTRO]-rviz2
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>备注：</strong> 命令中的 [ROS_DISTRO] 指代ROS2版本。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1362.webp" alt="" /></p>

<p>方式1：<code class="language-plaintext highlighter-rouge">rviz2</code>；</p>

<p>方式2：<code class="language-plaintext highlighter-rouge">ros2 run rviz2 rviz2</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1363.webp" alt="" /></p>

<p><strong>rviz2 启动之后，默认界面如下：</strong></p>

<ol>
  <li>
    <p>上部为工具栏：包括视角控制、预估位姿设置、目标设置等，还可以添加自定义插件；</p>
  </li>
  <li>
    <p>左侧为插件显示区：包括添加、删除、复制、重命名插件，显示插件，以及设置插件属性等功能；</p>
  </li>
  <li>
    <p>中间为3D试图显示区：以可视化的方式显示添加的插件信息；</p>
  </li>
  <li>
    <p>右侧为观测视角设置区：可以设置不同的观测视角；</p>
  </li>
  <li>
    <p>下侧为时间显示区：包括系统时间和ROS时间。</p>
  </li>
</ol>

<p><strong>左侧插件显示区默认有两个插件：</strong></p>

<ul>
  <li>
    <p>Global Options：该插件用于设置全局显示相关的参数，一般情况下，需要自行设置的是 Fixed Frame 选项，该选项是其他所有数据在可视化显示时所参考的全局坐标系；</p>
  </li>
  <li>
    <p>Global Status：该插件用于显示在 Global Options 设置完毕 Fixed Frame 之后，所有的坐标变换是否正常。</p>
  </li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1364.webp" alt="" /></p>

<p>最上面是菜单区，左侧是插件显示区，中间是3D调试区，右侧是视角切换区域，最下方是时间区ROS Time是ROS2时间，Wall Time是系统时间，Elapsed是Rviz2运行的时间。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1365.webp" alt="" /></p>

<p>可以保存rviz2的配置，也可以打开配置</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1366.webp" alt="" /></p>

<p>设置显示面板</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1367.webp" alt="" /></p>

<p>可以设置平面网格的个数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1368.webp" alt="" /></p>

<p>可以设置竖直方向网格的个数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1369.webp" alt="" /></p>

<p>可以设置网格边长是多大</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1370.webp" alt="" /></p>

<p>改变sRGB的4个通道</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1371.webp" alt="" /></p>

<p>可以改变视角</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1372.webp" alt="" /></p>

<p>设置偏移量，如果Z是-1，那么网格会相对于坐标系下沉1个单位</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1373.webp" alt="" /></p>

<p>Fixed name一般是根坐标系的名称</p>

<p>background color就是背景色</p>

<p>frame rate是坐标系的发布频率</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1374.webp" alt="" /></p>

<p>全局状态，当fixed name设置对后，就无警告了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1375.webp" alt="" /></p>

<p>视角切换(一般默认)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1376.webp" alt="" /></p>

<p>可以翻转Z轴</p>

<p><strong>常用插件：</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">序号</th>
      <th style="text-align: left">名称</th>
      <th style="text-align: left">功能</th>
      <th style="text-align: left">消息类型</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">1</td>
      <td style="text-align: left">Axes</td>
      <td style="text-align: left">显示 rviz2 默认的坐标系。</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">Camera</td>
      <td style="text-align: left">显示相机图像，必须需要使用消息：CameraInfo。</td>
      <td style="text-align: left">sensor_msgs/msg/Image，sensor_msgs/msg/CameraInfo</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">Grid</td>
      <td style="text-align: left">显示以参考坐标系原点为中心的网格。</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td style="text-align: left">Grid Cells</td>
      <td style="text-align: left">从网格中绘制单元格，通常是导航堆栈中成本地图中的障碍物。</td>
      <td style="text-align: left">nav_msgs/msg/GridCells</td>
    </tr>
    <tr>
      <td style="text-align: left">5</td>
      <td style="text-align: left">Image</td>
      <td style="text-align: left">显示相机图像，但是和Camera插件不同，它不需要使用 CameraInfo 消息。</td>
      <td style="text-align: left">sensor_msgs/msg/Image</td>
    </tr>
    <tr>
      <td style="text-align: left">6</td>
      <td style="text-align: left">InteractiveMarker</td>
      <td style="text-align: left">显示来自一个或多个交互式标记服务器的 3D 对象，并允许与它们进行鼠标交互。</td>
      <td style="text-align: left">visualization_msgs/msg/InteractiveMarker</td>
    </tr>
    <tr>
      <td style="text-align: left">7</td>
      <td style="text-align: left">Laser Scan</td>
      <td style="text-align: left">显示激光雷达数据。</td>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
    </tr>
    <tr>
      <td style="text-align: left">8</td>
      <td style="text-align: left">Map</td>
      <td style="text-align: left">显示地图数据。</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
    </tr>
    <tr>
      <td style="text-align: left">9</td>
      <td style="text-align: left">Markers</td>
      <td style="text-align: left">允许开发者通过主题显示任意原始形状的几何体。</td>
      <td style="text-align: left">visualization_msgs/msg/Marker，visualization_msgs/msg/MarkerArray</td>
    </tr>
    <tr>
      <td style="text-align: left">10</td>
      <td style="text-align: left">Path</td>
      <td style="text-align: left">显示机器人导航中的路径相关数据。</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
    </tr>
    <tr>
      <td style="text-align: left">11</td>
      <td style="text-align: left">PointStamped</td>
      <td style="text-align: left">以小球的形式绘制一个点。</td>
      <td style="text-align: left">geometry_msgs/msg/PointStamped</td>
    </tr>
    <tr>
      <td style="text-align: left">12</td>
      <td style="text-align: left">Pose</td>
      <td style="text-align: left">以箭头或坐标轴的方式绘制位姿。</td>
      <td style="text-align: left">geometry_msgs/msg/PoseStamped</td>
    </tr>
    <tr>
      <td style="text-align: left">13</td>
      <td style="text-align: left">Pose Array</td>
      <td style="text-align: left">绘制一组 Pose。</td>
      <td style="text-align: left">geometry_msgs/msg/PoseArray</td>
    </tr>
    <tr>
      <td style="text-align: left">14</td>
      <td style="text-align: left">Point Cloud2</td>
      <td style="text-align: left">绘制点云数据。</td>
      <td style="text-align: left">sensor_msgs/msg/PointCloud，sensor_msgs/msg/PointCloud2</td>
    </tr>
    <tr>
      <td style="text-align: left">15</td>
      <td style="text-align: left">Polygon</td>
      <td style="text-align: left">将多边形的轮廓绘制为线。</td>
      <td style="text-align: left">geometry_msgs/msg/Polygon</td>
    </tr>
    <tr>
      <td style="text-align: left">16</td>
      <td style="text-align: left">Odometry</td>
      <td style="text-align: left">显示随着时间推移累积的里程计消息。</td>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
    </tr>
    <tr>
      <td style="text-align: left">17</td>
      <td style="text-align: left">Range</td>
      <td style="text-align: left">显示表示来自声纳或红外距离传感器的距离测量值的圆锥。</td>
      <td style="text-align: left">sensor_msgs/msg/Range</td>
    </tr>
    <tr>
      <td style="text-align: left">18</td>
      <td style="text-align: left">RobotModel</td>
      <td style="text-align: left">显示机器人模型。</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">19</td>
      <td style="text-align: left">TF</td>
      <td style="text-align: left">显示 tf 变换层次结构。</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">20</td>
      <td style="text-align: left">Wrench</td>
      <td style="text-align: left">将geometry_msgs /WrenchStamped消息显示为表示力的箭头和表示扭矩的箭头加圆圈。</td>
      <td style="text-align: left">geometry_msgs/msg/WrenchStamped</td>
    </tr>
    <tr>
      <td style="text-align: left">21</td>
      <td style="text-align: left">Oculus</td>
      <td style="text-align: left">将 RViz 场景渲染到 Oculus 头戴设备。</td>
      <td style="text-align: left"> </td>
    </tr>
  </tbody>
</table>

<p>上述每一种插件又包含了诸多属性，可以通过设置插件属性来控制插件的最终显示效果。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1377.webp" alt="" /></p>

<p>Image是摄像头数据插件</p>

<p>LaserScan是激光雷达数据插件</p>

<p>TF是坐标变换插件</p>

<p>RobotModel是机器人模型插件</p>

<pre><code class="language-TypeScript">ros2 run rviz2 rviz2 -d xxx.rviz
#可以读取自己保存的rviz配置
</code></pre>

<h2 id="rviz2集成urdf基本流程">rviz2集成URDF基本流程</h2>

<h3 id="案例分析">  案例分析</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1378.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1379.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1380.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1381.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1382.webp" alt="" /></p>

<p>请调用如下命令，安装案例所需的两个功能包(可以控制机器人关节运动)：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-joint-state-publisher
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-joint-state-publisher-gui
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端下进入工作空间的src目录，调用如下命令创建C++功能包。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp06_urdf <span class="nt">--build-type</span> ament_cmake
</pre></td></tr></tbody></table></code></pre></div></div>

<p>功能包下新建 urdf、rviz、launch、meshes目录以备用，其中 urdf 目录下再新建子目录 urdf 与 xacro，分别用于存储 urdf 文件和 xacro 文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1383.webp" alt="" /></p>

<p>launch存放launch文件</p>

<p>urdf文件里面存放urdf三维模型文件</p>

<p>meshes存放stl模型</p>

<p>xacro可以简化urdf文件，并且增强其灵活性</p>

<p>rviz存放rviz2的配置</p>

<h3 id="框架搭建-3">  框架搭建</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1384.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
 <span class="nt">&lt;robot&gt;</span> name="hello_world"
   <span class="nt">&lt;link&gt;</span> name="base_link"
     <span class="nt">&lt;visual&gt;</span>
       <span class="nt">&lt;geometry&gt;</span>
         <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.5 0.2 0.1"</span><span class="nt">/&gt;</span>
       <span class="nt">&lt;/geometry&gt;</span>
     <span class="nt">&lt;/visual&gt;</span>
   <span class="nt">&lt;/link&gt;</span>
 <span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>  标准的XML文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1385.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1386.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="n">launch_ros.parameter_descriptions</span> <span class="kn">import</span> <span class="n">ParameterValue</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">Command</span><span class="p">,</span><span class="n">LaunchConfiguration</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>

<span class="c1">#示例：ros2 launch cpp06_urdf display.launch.py model:=`ros2 pkg prefix --share cpp06_urdf`/urdf/urdf/demo01_helloworld.urdf
</span><span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">cpp06_urdf_dir</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp06_urdf</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">default_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cpp06_urdf_dir</span><span class="p">,</span><span class="sh">"</span><span class="s">urdf/urdf</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">demo01_helloworld.urdf</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">default_rviz_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cpp06_urdf_dir</span><span class="p">,</span><span class="sh">"</span><span class="s">rviz</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">display.rviz</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">default_model_path</span><span class="p">)</span>

    <span class="c1"># 加载机器人模型
</span>
    <span class="c1"># 1.启动 robot_state_publisher 节点并以参数方式加载 urdf 文件
</span>    <span class="n">robot_description</span> <span class="o">=</span> <span class="nc">ParameterValue</span><span class="p">(</span><span class="nc">Command</span><span class="p">([</span><span class="sh">"</span><span class="s">xacro </span><span class="sh">"</span><span class="p">,</span><span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)]))</span>
    <span class="n">robot_state_publisher</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">robot_description</span><span class="sh">"</span><span class="p">:</span> <span class="n">robot_description</span><span class="p">}]</span>
    <span class="p">)</span>

    <span class="c1"># 2.启动 joint_state_publisher 节点发布非固定关节状态
</span>    <span class="n">joint_state_publisher</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="c1"># rviz2 节点
</span>    <span class="n">rviz2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span>

        <span class="c1"># arguments=["-d", default_rviz_path]
</span>    <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">robot_state_publisher</span><span class="p">,</span>
        <span class="n">joint_state_publisher</span><span class="p">,</span>
        <span class="n">rviz2</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1387.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;exec_depend&gt;</span>rviz2<span class="nt">&lt;/exec_depend&gt;</span>
<span class="nt">&lt;exec_depend&gt;</span>xacro<span class="nt">&lt;/exec_depend&gt;</span>
<span class="nt">&lt;exec_depend&gt;</span>robot_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
<span class="nt">&lt;exec_depend&gt;</span>joint_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
<span class="nt">&lt;exec_depend&gt;</span>ros2launch<span class="nt">&lt;/exec_depend&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1388.webp" alt="" /></p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>
  DIRECTORY launch urdf rviz meshes
  DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>  
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1389.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> cpp06_urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1390.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">source install</span>/setup.bash
ros2 launch cpp06_urdf display.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1391.webp" alt="" /></p>

<p>   <strong>小提示：</strong></p>

<p>  在本章的后续案例中，所有实现都遵循上述步骤，在后续案例中我们只需要关注 urdf 实现即可，launch 文件和 配置文件无需修改。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1392.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1393.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1394.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1395.webp" alt="" /></p>

<h3 id="urdf文件">  urdf文件</h3>

<p>  按ctrl+\生成注释</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1396.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1397.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1398.webp" alt="" /></p>

<p>因为安装过urdf插件，所以有提示，需要创建robot根标签</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1399.webp" alt="" /></p>

<p>第一个属性为机器人名字</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1400.webp" alt="" /></p>

<p>第二个有个xml namespace，指向xacro</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1401.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1402.webp" alt="" /></p>

<p>第三个有个xml namespace，指向xacro，然后还有一个机器人名字</p>

<p>(暂时用最简单的，也就是第一个)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1403.webp" alt="" /></p>

<p>link标签叫连杆，也需要起个名字，连杆一般指刚体部分</p>

<p>link有个子集标签，叫visual</p>

<p>visual标签下要写机器人形状</p>

<p>然后该标签下又有一个子集标签叫geometry(几何形状)</p>

<p>然后又有子集标签叫box(矩形体状)后面的size后面对应长宽高</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1404.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>
 <span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"boxrobot"</span><span class="nt">&gt;</span> 

    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span> 

      <span class="nt">&lt;visual&gt;</span>

        <span class="nt">&lt;geometry&gt;</span>

          <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"1.0 0.5 0.1"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="xacro工具将磁盘文件加载到ros2中的工具">  xacro工具(将磁盘文件加载到ROS2中的工具)</h3>

<p>搜索是否安装过xacro</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg list | <span class="nb">grep</span> <span class="nt">-i</span> xacro
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1405.webp" alt="" /></p>

<p>如果打印了xacro说明安装了，如果没打印，则要手动安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>ros-humble-xacro
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用xacro读取文件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1406.webp" alt="" /></p>

<p>文件里的内容被输出到了终端，咱们一般集成到launch文件中。咱们在终端里是只能查看内容，但是用launch就可以把文件弄到节点里，也就是集成到ROS2里。</p>

<h3 id="launch核心实现">  launch核心实现</h3>

<p>核心实现就三步，加载机器人模型，节点发布非固定关节的状态，启动rviz2节点</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1407.webp" alt="" /></p>

<p>创建rviz2节点很简单，就声明下包名，声明下executable。</p>

<p>加载机器人模型比较复杂，加载机器人模型，也要创建一个节点，</p>

<p>然后有参数，参数里有个键叫robot_description，然后这个键对应一个值</p>

<p>值是ParameterValue对象，这个对象里执行了一个指令，叫xacro，然后后面又有一个Launch配置，其实就是urdf文件的路径。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1408.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1409.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1410.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1411.webp" alt="" /></p>

<p>这个值，其实就是URDF文件里的内容，但是内容太长了，所以我们把它封装成一个对象。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1412.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1413.webp" alt="" /></p>

<p>命令行，不能直接当对象参数值，所以还要封装</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1414.webp" alt="" /></p>

<p>Comand是专门封装终端指令执行的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1415.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1416.webp" alt="" /></p>

<p>记得xacro后面要有空格，这里填路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1417.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1418.webp" alt="" /></p>

<p>此时已经定位到cpp06_urdf的share路径下的cpp06_urdf路径了，返回的也就是该路径的字符串</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1419.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1420.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1421.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span>
<span class="c1"># from launch.actions import ExecuteProcess
</span>
<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span>
<span class="c1"># from launch.actions import DeclareLaunchArgument
</span>
<span class="c1"># from launch.substitutions import LaunchConfiguration
</span>
<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch_ros.parameter_descriptions</span> <span class="kn">import</span> <span class="n">ParameterValue</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="n">p_value</span> <span class="o">=</span> <span class="nc">ParameterValue</span><span class="p">(</span><span class="nc">Command</span><span class="p">([</span><span class="sh">"</span><span class="s">xacro </span><span class="sh">"</span><span class="p">,</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp06_urdf</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/urdf/urdf/demo01_boxrobot.urdf</span><span class="sh">"</span><span class="p">]))</span>
<span class="n">robot_state_pub</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">robot_description</span><span class="sh">"</span><span class="p">:</span><span class="n">p_value</span><span class="p">}]</span>
<span class="p">)</span>

<span class="n">rviz2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">robot_state_pub</span><span class="p">,</span><span class="n">rviz2</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1422.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1423.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1424.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1425.webp" alt="" /></p>

<p>点击左下角Add添加RobotModel插件</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1426.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1427.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1428.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1429.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1430.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1431.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1432.webp" alt="" /></p>

<p>新建一个坐标系插件，长沿着X，宽沿着Y，高沿着Z</p>

<h3 id="launch优化说明与实现">  launch优化说明与实现</h3>

<p>我们还需要优化三个点，第一个是打开关节节点，第二是设置rviz2默认配置文件，第三是Launch文件中我们将读取的urdf文件写死了，所以要优化结构。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1433.webp" alt="" /></p>

<p>还要启动这个节点，来控制关节运动，可以改成joint_state_publisher_gui，出现图形化界面。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1434.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1435.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1436.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1437.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1438.webp" alt="" /></p>

<p>保存一下rviz2的配置</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1439.webp" alt="" /></p>

<p>正常的指令是</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run rviz2 rviz2 <span class="nt">-d</span> rviz2配置的路径
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1440.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1441.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1442.webp" alt="" /></p>

<p>创建一个参数叫model，值是后面那一长串。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1443.webp" alt="" /></p>

<p>LaunchConfiguration是解析参数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1444.webp" alt="" /></p>

<p>记得要把model放在最前面，放在后面是不可以的，现在已经把路径封装完毕了。</p>

<p>现在启动是正常启动默认的urdf路径。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1445.webp" alt="" /></p>

<p>解析非默认值的urdf，在终端里也有类似于get_package_share_directory，以下就是(这里参数model少写了个L)要把参数值用反引号(ESC与TAB中间的按键)框起来。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1446.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>ros2 pkg prefix <span class="nt">--share</span> cpp06_urdf

ros2 run launch cpp06_urdf display.launch.py model:<span class="o">=</span><span class="sb">`</span>ros2 pkg prefix <span class="nt">--share</span> cpp06_urdf<span class="sb">`</span>/urdf/urdf/hahah.urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1447.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1448.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1449.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span>
<span class="c1"># from launch.actions import ExecuteProcess
</span>
<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>

<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch_ros.parameter_descriptions</span> <span class="kn">import</span> <span class="n">ParameterValue</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp06_urdf</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/urdf/urdf/demo01_boxrobot.urdf</span><span class="sh">"</span><span class="p">)</span>

<span class="n">p_value</span> <span class="o">=</span> <span class="nc">ParameterValue</span><span class="p">(</span><span class="nc">Command</span><span class="p">([</span><span class="sh">"</span><span class="s">xacro </span><span class="sh">"</span><span class="p">,</span><span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)]))</span>
<span class="n">robot_state_pub</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">robot_description</span><span class="sh">"</span><span class="p">:</span><span class="n">p_value</span><span class="p">}]</span>
<span class="p">)</span>

<span class="n">joint_state_pub</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher</span><span class="sh">"</span>
    <span class="p">)</span>

<span class="n">rviz2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-d</span><span class="sh">"</span><span class="p">,</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp06_urdf</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/rviz/urdf.rviz</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">model</span><span class="p">,</span><span class="n">robot_state_pub</span><span class="p">,</span><span class="n">joint_state_pub</span><span class="p">,</span><span class="n">rviz2</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>继续优化最终的代码为：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span>
<span class="c1"># from launch.actions import ExecuteProcess
</span>
<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>

<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch_ros.parameter_descriptions</span> <span class="kn">import</span> <span class="n">ParameterValue</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="kn">import</span> <span class="n">os</span>

<span class="n">cpp06_urdf_dir</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp06_urdf</span><span class="sh">"</span><span class="p">)</span>

<span class="n">default_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cpp06_urdf_dir</span><span class="p">,</span><span class="sh">"</span><span class="s">urdf/urdf</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">demo01_boxrobot.urdf</span><span class="sh">"</span><span class="p">)</span>
<span class="n">default_rviz_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cpp06_urdf_dir</span><span class="p">,</span><span class="sh">"</span><span class="s">rviz</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">urdf.rviz</span><span class="sh">"</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="n">default_model_path</span><span class="p">)</span>

<span class="n">p_value</span> <span class="o">=</span> <span class="nc">ParameterValue</span><span class="p">(</span><span class="nc">Command</span><span class="p">([</span><span class="sh">"</span><span class="s">xacro </span><span class="sh">"</span><span class="p">,</span><span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)]))</span>
<span class="n">robot_state_pub</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">robot_description</span><span class="sh">"</span><span class="p">:</span><span class="n">p_value</span><span class="p">}]</span>
<span class="p">)</span>

<span class="c1"># 关节信息节点
</span>
<span class="c1"># joint_state_pub = Node(
</span>
<span class="c1">#     package="joint_state_publisher",
</span>
<span class="c1">#     executable="joint_state_publisher"
</span>
<span class="c1"># )
</span>
<span class="c1"># 关节信息节点图形界面(建议)
</span><span class="n">joint_state_pub</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher_gui</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher_gui</span><span class="sh">"</span>
<span class="p">)</span>

<span class="n">rviz2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>

<span class="c1">#    arguments=["-d",get_package_share_directory("cpp06_urdf") + "/rviz/urdf.rviz"]
</span>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-d</span><span class="sh">"</span><span class="p">,</span><span class="n">default_rviz_path</span><span class="p">]</span>

    <span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">model</span><span class="p">,</span><span class="n">robot_state_pub</span><span class="p">,</span><span class="n">joint_state_pub</span><span class="p">,</span><span class="n">rviz2</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="urdf语法">URDF语法</h2>

<h3 id="简介-1">简介</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1450.webp" alt="" /></p>

<h3 id="robot根标签">robot根标签</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1451.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1452.webp" alt="" /></p>

<p>对机器人进行分割，分割成几个子集，比如一个子集描述头，一个子集描述身子，最后再合成合集，成机器人</p>

<p>虽然我的子文件和主文件在逻辑上是有包含关系的，但是其实，他们都是单独的urdf文件。主文件中，robot标签的name属性必须写，子文件可以不写，如果写，那么子文件name的值与主文件的必须相同！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1453.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1454.webp" alt="" /></p>

<h3 id="link标签">link标签</h3>

<h4 id="简介-2">简介</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1455.webp" alt="" /></p>

<p>每一个link都是刚体，都是独立部件</p>

<p>Link是通过joint进行拼接的</p>

<p>Link主要包含三部分，Visual，Collision和Inertial</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1456.webp" alt="" /></p>

<p>没加尖括号的是属性，加了的是标签</p>

<p>**<visual>** （可选）：用于描述link的可视化属性，可以设置link的形状（立方体、球体、圆柱等）。</visual></p>

<ul>
  <li>
    <p><strong>name</strong> （可选）：指定link名称，此名称会映射为同名坐标系，还可以通过引用该值定位定位link。</p>
  </li>
  <li>
    <p>**<geometry>** （必填）：用于设置link的形状，比如：立方体、球体或圆柱。</geometry></p>

    <ul>
      <li>
        <p>**<box>** ：立方体标签，通过size属性设置立方体的边长，原点为其几何中心。</box></p>
      </li>
      <li>
        <p>**<cylinder>** ：圆柱标签，通过radius属性设置圆柱半径，通过length属性设置圆柱高度，原点为其几何中心。</cylinder></p>
      </li>
      <li>
        <p>**<sphere>** ：球体标签，通过radius属性设置球体半径，原点为其几何中心。</sphere></p>
      </li>
      <li>
        <p>**<mesh>** ：通过属性filename引用“皮肤”文件，为link设置外观，该文件必须是本地文件。使用 package://<packagename>/<path>为文件名添加前缀。</path></packagename></mesh></p>
      </li>
      <li>
        <p>**<origin>** （可选）：用于设置link的相对偏移量以及旋转角度，如未指定则使用默认值（无偏移且无旋转）。</origin></p>

        <ul>
          <li>
            <p><strong>xyz</strong> ：表示x、y、z三个维度上的偏移量（以米为单位），不同数值之间使用空格分隔，如未指定则使用默认值（三个维度无偏移）。</p>
          </li>
          <li>
            <p><strong>rpy</strong> ：表示翻滚、俯仰与偏航的角度（以弧度为单位），不同数值之间使用空格分隔，如未指定则使用默认值（三个维度无旋转）。</p>
          </li>
        </ul>
      </li>
      <li>
        <p>**<material>** （可选）：视觉元素的材质。也可以在根标签robot中定义material标签，然后，可以在link中按名称进行引用。</material></p>

        <ul>
          <li>
            <p><strong>name</strong> （可选）：为material指定名称，可以通过该值进行引用。</p>
          </li>
          <li>
            <p>**<color>** （可选）：rgba 材质的颜色，由代表red/green/blue/alpha 的四个数字组成，每个数字的范围为 \[0,1\]。</color></p>
          </li>
          <li>
            <p>**<texture>** （可选）：材质的纹理，可以由属性filename设置。</texture></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>当有多个Visual的时候，需要给Visual设置name，所以是个可选项。</p>

<p>Collision与仿真有关系，我们可以给我们的机器人的刚体设置一个碰撞区间，只要障碍物进入了区间，那么就发生了碰撞，一般碰撞区间要比实际大小要大。</p>

<p>**<collision>** （可选）：link的碰撞属性。可以与link的视觉属性一致，也可以不同，比如：我们会通常使用更简单的碰撞模型来减少计算时间，或者设置的值大于link的视觉属性，以尽量避免碰撞。另外，同一链接可以存在多个 <collision>标签实例，多个几何图形组合表示link的碰撞属性。</collision></collision></p>

<ul>
  <li>
    <p><strong>name</strong> （可选）：为collision设置名称。</p>
  </li>
  <li>
    <p>**<geometry>** （必须）：请参考visual标签的geometry使用规则。</geometry></p>
  </li>
  <li>
    <p>**<origin>** （可选）：请参考visual标签的origin使用规则。</origin></p>
  </li>
</ul>

<p>Inertial是设置惯性矩阵的，也是和仿真有关系的。比如说机器人刹车，会出现前倾的情况，比如说惯性矩阵的重心高一些，那么急刹车就会出现翻车的情况了。</p>

<p>**<inertial>** （可选）：用于设置link的质量、质心位置和中心惯性特性，如果未指定，则默认为质量为0、惯性为0。</inertial></p>

<ul>
  <li>
    <p>**<origin>** （可选）：该位姿（平移、旋转）描述了链接的质心框架 C 相对于链接框架 L 的位置和方向。</origin></p>

    <ul>
      <li>
        <p><strong>xyz</strong> ：表示从 Lo（链接框架原点）到 Co（链接的质心）的位置向量为 x L̂x + y L̂y + z L̂z，其中 L̂x、L̂y、L̂z 是链接框架 L 的正交单位向量。</p>
      </li>
      <li>
        <p><strong>rpy</strong> ：将 C 的单位向量 Ĉx、Ĉy、Ĉz 相对于链接框架 L 的方向表示为以弧度为单位的欧拉旋转序列 (r p y)。注意：Ĉx、Ĉy、Ĉz 不需要与连杆的惯性主轴对齐。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>**<mass>** （必填）：通过其value属性设置link的质量。</mass></p>
  </li>
  <li>
    <p>**<inertia>** （必填）：对于固定在质心坐标系 C 中的单位向量 Ĉx、Ĉy、Ĉz，该连杆的惯性矩 ixx、iyy、izz 以及关于 Co（连杆的质心）的惯性 ixy、ixz、iyz 的乘积。</inertia></p>
  </li>
</ul>

<p><strong>注意：</strong> <collision> 和 <inertial> 在仿真环境下才需要使用到，如果只是在 rviz2 中集成 urdf，那么不必须为 link 定义这两个标签。</inertial></collision></p>

<h4 id="使用">使用</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1457.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"link_demo"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.7 0.7 0 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>

        <span class="nt">&lt;geometry&gt;</span>

            <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.5 0.3 0.1"</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;/geometry&gt;</span>

        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1458.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch cpp06_urdf display.launch.py model:<span class="o">=</span><span class="sb">`</span>ros2 pkg prefix <span class="nt">--share</span> cpp06_urdf<span class="sb">`</span>/urdf/urdf/demo02_link.urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1459.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1460.webp" alt="" /></p>

<p>矩形体，球形，圆柱体</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1461.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1462.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1463.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1464.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1465.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1466.webp" alt="" /></p>

<p>平移量，X平移1，Y和Z平移0，rpy旋转度设置为0(旋转度分别是欧拉角里的翻滚角Roll(绕X)，俯仰角Pitch(绕Y)，航向角Yaw(绕Z))</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1467.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1468.webp" alt="" /></p>

<p>发现长方体在X上偏移了1</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1469.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1470.webp" alt="" /></p>

<p>让航向角Yaw(绕Z运动)为0.5 rad</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1471.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1472.webp" alt="" /></p>

<p>设置翻滚角Roll(绕X运动)为0.5rad</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1473.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1474.webp" alt="" /></p>

<p>设置俯仰角Pitch(绕Y运动)为0.5rad</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1475.webp" alt="" /></p>

<p>sRGB是R,G,B,Alpha(浮点模型，所以范围是0-1.0)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1476.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1477.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1478.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1479.webp" alt="" /></p>

<p>如果一个颜色要被用好几次，可以封装成一个类似于全局变量的东西，然后在其他link中调用时，直接用<material name="对应属性值"></material> （这里是个闭环，注意）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1480.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"link_demo"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.7 0.7 0 0.8"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;visual&gt;</span>

          <span class="nt">&lt;geometry&gt;</span>

              <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.5 0.3 0.1"</span> <span class="nt">/&gt;</span>

          <span class="nt">&lt;/geometry&gt;</span>

          <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>

          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="使用补充">使用补充</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1481.webp" alt="" /></p>

<p>mesh标签是引用皮肤文件，一般是stl文件，可以用SolidWorks导出，可以看文档后面的SW2URDF</p>

<p>如果不会使用solidworks，可以学，这东西2天半就能学会，只是一个工具，只会画图没有啥水平，最重要的还是机械设计比较难。想学的可以看兄弟社团机械学会微信公众号的视频进行学习。</p>

<p>https://mp.weixin.qq.com/mp/homepage?__biz=MzI4MjkyMDgyMA==&amp;hid=7&amp;sn=1efc3d3cee0142970227785f767cc7c8&amp;scene=18</p>

<p>当然，没时间学习可以直接用别人画好的机器人，在Github上搜索turtlebot3</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1482.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1483.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1484.webp" alt="" /></p>

<p>这里有已经导出的模型，bases里是外观的模型，sensors是传感器的模型，wheels是轮子的模型。</p>

<p>我们克隆下仓库，注意要克隆branch是ros2的分支。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1485.webp" alt="" /></p>

<p>我们引用一个就行了，看看效果即可，真正的应用还是要用SolidWorks通过SW2URDF插件进行导出</p>

<p>把项目里的meshes/bases里的burger_base.stl拷贝到我们WS里的meshes目录</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1486.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1487.webp" alt="" /></p>

<p>filename是写刚才的皮肤文件，package://就是协议名，后面跟包名，也就是cpp06_urdf。然后跟功能包下的文件路径，也就是meshes/burger_base.stl（其实也就是share下的路径）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1488.webp" alt="" /></p>

<p>因为是个三维模型，所以在填scale大小缩放时，需要填3个比例，咱们都填1.0即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1489.webp" alt="" /></p>

<p>为什么显示的模型会这么大呢，因为rviz2以米为单位，而stl是以mm为单位，注意。在机械上，默认不说单位就都是mm，不要乱改单位，一般都要以mm为单位，咱们是做机器人的，要专业一些。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1490.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1491.webp" alt="" /></p>

<h3 id="joint标签">joint标签</h3>

<h4 id="简介-3">简介</h4>

<p>urdf 中的 joint 标签用于描述机器人关节的运动学和动力学属性，还可以指定关节运动的安全极限，机器人的两个部件(分别称之为 parent link 与 child link)以”关节“的形式相连接，不同的关节有不同的运动形式: 旋转、滑动、固定、旋转速度、旋转角度限制….,比如:安装在底座上的轮子可以360度旋转，而摄像头则可能是完全固定在底座上。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1492.webp" alt="" /></p>

<ul>
  <li>
    <p><strong>name</strong> （必填）：为关节命名，名称需要唯一。</p>
  </li>
  <li>
    <p><strong>type</strong> （必填）：设置关节类型，可用类型如下：</p>

    <ul>
      <li>
        <p>continuous：旋转关节，可以绕单轴无限旋转。</p>
      </li>
      <li>
        <p>revolute：旋转关节，类似于 continues，但是有旋转角度限制。</p>
      </li>
      <li>
        <p>prismatic：滑动关节，沿某一轴线移动的关节，有位置极限。</p>
      </li>
      <li>
        <p>planer：平面关节，允许在平面正交方向上平移或旋转。</p>
      </li>
      <li>
        <p>floating：浮动关节，允许进行平移、旋转运动。</p>
      </li>
      <li>
        <p>fixed：固定关节，不允许运动的特殊关节。</p>
      </li>
    </ul>
  </li>
</ul>

<p>以下是子级标签</p>

<ul>
  <li>
    <p>**<parent>** （必填）：指定父级link。</parent></p>

    <ul>
      <li><strong>link</strong> （必填）：父级link的名字，是这个link在机器人结构树中的名字。</li>
    </ul>
  </li>
  <li>
    <p>**<child>** （必填）：指定子级link。</child></p>

    <ul>
      <li><strong>link</strong> （必填）：子级link的名字，是这个link在机器人结构树中的名字。</li>
    </ul>
  </li>
  <li>
    <p>**<origin>** （可选）：这是从父link到子link的转换，关节位于子link的原点。</origin></p>

    <ul>
      <li>
        <p><strong>xyz</strong> ：各轴线上的偏移量。</p>
      </li>
      <li>
        <p><strong>rpy</strong> ：各轴线上的偏移弧度。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>&lt;axis&gt;</strong> （可选）：如不设置，默认值为（1，0，0）。</p>

    <ul>
      <li><strong>xyz</strong> ：用于设置围绕哪个关节轴运动。</li>
    </ul>
  </li>
  <li>
    <p>**<calibration>** （可选）：关节的参考位置，用于校准关节的绝对位置。</calibration></p>

    <ul>
      <li>
        <p><strong>rising</strong> （可选）：当关节向正方向移动时，该参考位置将触发上升沿。</p>
      </li>
      <li>
        <p><strong>falling</strong> （可选）：当关节向正方向移动时，该参考位置将触发下降沿。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>**<dynamics>** （可选）：指定接头物理特性的元素。这些值用于指定关节的建模属性，对仿真较为有用。</dynamics></p>

    <ul>
      <li>
        <p><strong>damping</strong> （可选）：关节的物理阻尼值，默认为0。</p>
      </li>
      <li>
        <p><strong>friction</strong> （可选）：关节的物理静摩擦值，默认为0。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>**<limit>** （关节类型是revolute或prismatic时为必须的）：</limit></p>

    <ul>
      <li>
        <p><strong>lower</strong> （可选）：指定关节下限的属性（旋转关节以弧度为单位，棱柱关节以米为单位）。如果关节是连续的，则省略。</p>
      </li>
      <li>
        <p><strong>upper</strong> （可选）：指定关节上限的属性（旋转关节以弧度为单位，棱柱关节以米为单位）。如果关节是连续的，则省略。</p>
      </li>
      <li>
        <p><strong>effort</strong> （必填）：指定关节可受力的最大值。</p>
      </li>
      <li>
        <p><strong>velocity</strong> （必填）：用于设置最大关节速度（旋转关节以弧度每秒 [rad/s] 为单位，棱柱关节以米每秒 [m/s] 为单位）。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>**<mimic>** （可选）：此标签用于指定定义的关节模仿另一个现有关节。该关节的值可以计算为*value = multiplier \* other\_joint\_value + offset*。</mimic></p>

    <ul>
      <li>
        <p><strong>joint</strong> （必填）：指定要模拟的关节的名称。</p>
      </li>
      <li>
        <p><strong>multiplier</strong> （可选）：指定上述公式中的乘法因子。</p>
      </li>
      <li>
        <p><strong>offset</strong> （可选）：指定要在上述公式中添加的偏移量，默认为 0（旋转关节的单位是弧度，棱柱关节的单位是米）。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>&lt;safety_controller&gt;</strong> （可选）：安全控制器。</p>

    <ul>
      <li>
        <p><strong>soft_lower_limit</strong> （可选）：指定安全控制器开始限制关节位置的下关节边界，此限制需要大于joint下限。</p>
      </li>
      <li>
        <p><strong>soft_upper_limit</strong> （可选）：指定安全控制器开始限制关节位置的关节上边界的属性，此限制需要小于joint上限。</p>
      </li>
      <li>
        <p><strong>k_position</strong> （可选）：指定位置和速度限制之间的关系。</p>
      </li>
      <li>
        <p><strong>k_velocity</strong> （必填）：指定力和速度限制之间的关系。</p>
      </li>
    </ul>
  </li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1493.webp" alt="" /></p>

<p>关节名称是必填的，且是唯一的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1494.webp" alt="" /></p>

<p>咱们最常用的是有限位的revolute类型的关节，continuous可无限旋转的关节，fixed固定关节，这个根据具体的关节类型来填。</p>

<p>revolute一般用于工业机器人机械臂的关节，continuous比如舵轮结构的“关节”，fixed就是一些固定的不能运动的结构关节。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1495.webp" alt="" /></p>

<p>子集标签很多，咱们用的最常用的就几个，记住常用的即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1496.webp" alt="" /></p>

<p>parent标签，link属性指定父级link的名字。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1497.webp" alt="" /></p>

<p>child标签类似。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1498.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1499.webp" alt="" /></p>

<p>这个轴，默认是1，0，0，以X轴进行旋转，但是咱们一般是需要设置的，可通过SolidWorks设置基准轴进行设置。</p>

<p>剩下的标签，都与关节类型有关，比如limit，如果关节类型是revolute，而且不设置limit，那么在joint_state_publisher_gui里是无法调关节的角度的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1500.webp" alt="" /></p>

<p>其他标签用到的时候再进行介绍。</p>

<h4 id="练习-1">练习</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1501.webp" alt="" /></p>

<p>先把俩关节，单独实现，然后再通过joint关节进行连接。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1502.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1503.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1504.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1505.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1506.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1507.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1508.webp" alt="" /></p>

<p>黄色的话，红和绿要多一些。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1509.webp" alt="" /></p>

<p>这是红色。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1510.webp" alt="" /></p>

<p>底盘Link就创建完毕了，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1511.webp" alt="" /></p>

<p>摄像头Link也创建完毕了，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1512.webp" alt="" /></p>

<p>关节名字设置为camera2base_link，也就是摄像头连接底座的joint，然后类型是360度都可以转的continuous。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1513.webp" alt="" /></p>

<p>填入子级Link与父级Link</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1514.webp" alt="" /></p>

<p>这样两个Link就通过该Joint连接到一起了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1515.webp" alt="" /></p>

<p>还需要设置这俩选项，咱们先不设置，先看默认是什么状态。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> cpp06_urdf
<span class="nb">source install</span>/setup.bash
ros2 launch cpp06_urdf display.launch.py model:<span class="o">=</span><span class="sb">`</span>ros2 pkg prefix <span class="nt">--share</span> cpp06_urdf<span class="sb">`</span>/urdf/urdf/demo03_joint.urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1516.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1517.webp" alt="" /></p>

<p>可以打开TF看看坐标系，勾上Show Names，发现是重合的。所以显示效果不满足咱们的逻辑业务。（默认状态下），所以需要设置偏移量。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1518.webp" alt="" /></p>

<p>如果咱们想把摄像头移动到车头，如图所示，在X上有偏移量，Y没有，但是Z有。然后roll，pitch，yaw上没有。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1519.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1520.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1521.webp" alt="" /></p>

<p>Z的高度就是1/2的底盘高度+1/2的摄像头高度</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1522.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1523.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1524.webp" alt="" /></p>

<p>咱们要绕Yaw旋转，所以也就是绕Z轴旋转，也就是001，注意一定得是整形，不能是浮点型。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1525.webp" alt="" /></p>

<p>想要看是否能旋转，要打开joint_state_publisher_gui，可以从launch中打开，也可以从终端中直接打开。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1526.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1527.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run joint_state_publisher_gui joint_state_publisher_gui
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1528.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1529.webp" alt="" /></p>

<p>拖拽滚动条可改变摄像头的Yaw</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1530.webp" alt="" /></p>

<p>Randomize是随机数，Center是回中(复位)</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre>
 <span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"joint_demo"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.7 0.7 0 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"red"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.8 0.1 0.1 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>

        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.5 0.3 0.1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"camera"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;visual&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
              <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.02 0.05 0.05"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"red"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"camera2baselink"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"camera"</span> <span class="nt">/&gt;</span>

      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.2 0 0.075"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 0 1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="joint_state_publisher">joint_state_publisher</h4>

<p>bug:Yaw不稳定，会一直回中。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1531.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1532.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1533.webp" alt="" /></p>

<p>其实是因为launch里启动的和终端里启动的冲突了。</p>

<p>解决方案：只启动其中一个。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1534.webp" alt="" /></p>

<p>解决方案：直接在Launch里启动GUI版本的，这样即可解决。(但是不建议)</p>

<p>建议方案：用非GUI版本的，因为以后，我们控制关节是用程序控制，而不是GUI控制。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1535.webp" alt="" /></p>

<p>如果只是想展示模型，用GUI，</p>

<p>如果想用程序控制，用普通版。</p>

<h4 id="base_footprint">base_footprint</h4>

<p>bug:机器人底盘半沉入地下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1536.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1537.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1538.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1539.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_footprint"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
          <span class="nt">&lt;sphere</span> <span class="na">radius=</span><span class="s">"0.001"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>    <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"baselink2basefootprint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_footprint"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0.0 0.05"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/joint&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Z的偏移量要填下沉底盘的距离，也就是整车底盘的一半。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1540.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1541.webp" alt="" /></p>

<p>修改参考坐标系</p>

<p>其实这个优化，可以不做，影响不大。但是建议用有basefootprint版本的。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre>
 <span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"base_footprint_demo"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.7 0.7 0 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"red"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.8 0.1 0.1 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_footprint"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
          <span class="nt">&lt;sphere</span> <span class="na">radius=</span><span class="s">"0.001"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>

        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.5 0.3 0.1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"baselink2basefootprint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_footprint"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0.0 0.05"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"camera"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;visual&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
              <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.02 0.05 0.05"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"red"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"camera2baselink"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"camera"</span> <span class="nt">/&gt;</span>

      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.2 0 0.075"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 0 1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="练习-2">练习</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1542.webp" alt="" /></p>

<p>没必要太深入练习，咱们可以直接用SolidWorks建模，更为友好。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1543.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre></td><td class="rouge-code"><pre>
 <span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"exercise_demo"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.7 0.7 0 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"red"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.8 0.1 0.1 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"gray"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.2 0.2 0.2 0.8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/material&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_footprint"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
          <span class="nt">&lt;sphere</span> <span class="na">radius=</span><span class="s">"0.001"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>

        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.2 0.12 0.07"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"baselink2basefootprint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_footprint"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0.0 0.05"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"front_left_wheel"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;visual&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
              <span class="nt">&lt;cylinder</span> <span class="na">radius=</span><span class="s">"0.025"</span> <span class="na">length=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57 0 0"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"gray"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"frontleftwheel2baselink"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"front_left_wheel"</span> <span class="nt">/&gt;</span>

      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.075 0.06 -0.025"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"front_right_wheel"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;cylinder</span> <span class="na">radius=</span><span class="s">"0.025"</span> <span class="na">length=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57 0 0"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"gray"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"frontrightwheel2baselink"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"front_right_wheel"</span> <span class="nt">/&gt;</span>

      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.075 -0.06 -0.025"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"back_left_wheel"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;cylinder</span> <span class="na">radius=</span><span class="s">"0.025"</span> <span class="na">length=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57 0 0"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"gray"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"backleftwheel2baselink"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"back_left_wheel"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"-0.075 0.06 -0.025"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"back_right_wheel"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;cylinder</span> <span class="na">radius=</span><span class="s">"0.025"</span> <span class="na">length=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57 0 0"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"gray"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"backrightwheel2baselink"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"back_right_wheel"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"-0.075 -0.06 -0.025"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端运行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch cpp06_urdf display.launch.py model:<span class="o">=</span><span class="sb">`</span>ros2 pkg prefix <span class="nt">--share</span> cpp06_urdf<span class="sb">`</span>/urdf/urdf/demo05_exercise.urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1544.webp" alt="" /></p>

<h2 id="urdf工具">URDF工具</h2>

<p>在 ROS2 中，提供了一些URDF文件相关的工具，比如:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">check_urdf</code>命令可以检查复杂的 urdf 文件是否存在语法问题；</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">urdf_to_graphviz</code>命令可以查看 urdf 模型结构，显示不同 link 的层级关系。</p>
  </li>
</ul>

<p>当然，要使用工具之前，请先安装，安装命令：<code class="language-plaintext highlighter-rouge">sudo apt install liburdfdom-tools</code>。</p>

<h3 id="check_urdf-语法检查"><strong>check_urdf 语法检查</strong></h3>

<p>进入urdf文件所属目录，调用：<code class="language-plaintext highlighter-rouge">check_urdf urdf文件</code>，如果不抛出异常，说明文件合法，否则非法。</p>

<p>示例，终端下进入功能包 cpp06_urdf 的 urdf/urdf 目录，执行如下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>check_urdf demo05_exercise.urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>urdf 文件如无异常，将显示urdf中link的层级关系，如下图所示：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1545.webp" alt="" /></p>

<p>否则将会给出错误提示。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1546.webp" alt="" /></p>

<p>演示错误，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1547.webp" alt="" /></p>

<h3 id="urdf_to_graphviz-结构查看"><strong>urdf_to_graphviz 结构查看</strong></h3>

<p>进入urdf文件所属目录，调用:<code class="language-plaintext highlighter-rouge">urdf_to_graphviz urdf文件</code>，当前目录下会生成 pdf 文件。</p>

<p>示例，终端下进入功能包 cpp06_urdf 的 urdf/urdf 目录，执行如下命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>urdf_to_graphviz demo05_exercise.urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>当前目录下，将生成以urdf中robot名称命名的.pdf和.gv文件，打开pdf文件会显示如下图内容：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1548.webp" alt="" /></p>

<p>在上图中会以树形结构显示link与joint的关系。</p>

<p><strong>注意：</strong> 该工具以前名为<code class="language-plaintext highlighter-rouge">urdf_to_graphiz</code>现建议使用<code class="language-plaintext highlighter-rouge">urdf_to_graphviz</code>替代。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1549.webp" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">urdf_to_graphiz</code>是历史版本，已经被废弃，建议用<code class="language-plaintext highlighter-rouge">urdf_to_graphviz</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1550.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1551.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1552.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1553.webp" alt="" /></p>

<p>黑色方框代表Link，蓝色代表Joint，也会展示平移量和旋转度等信息。</p>

<h2 id="sw2urdf">SW2URDF</h2>

<h3 id="solidworks简介">solidworks简介</h3>

<p>SolidWorks是一种计算机辅助设计（CAD）和计算机辅助制造（CAM）软件，由Dassault Systèmes SolidWorks Corp.开发。它主要用于工程设计和制造，可用于创建3D三维模型、进行装配设计、进行工程分析和绘图等。SolidWorks具有直观的用户界面和强大的功能，使工程师和设计师能够快速而精确地设计复杂的零部件和装配体。该软件广泛应用于机械、航空航天、汽车、医疗设备等行业，是工程设计领域的重要工具之一。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1554.webp" alt="" /></p>

<h3 id="solidworks插件sw2urdf介绍">solidworks插件sw2urdf介绍</h3>

<p>sw2urdf插件维基百科：</p>

<p>https://wiki.ros.org/sw_urdf_exporter</p>

<p>github下载链接：</p>

<p>https://github.com/ros/solidworks_urdf_exporter/releases</p>

<p>虽然github链接上写着只支持到SW2021，但是目前发现最新版SW(2022、2024经测试)也是可以正常用的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1555.webp" alt="" /></p>

<h3 id="安装sw2urdf">安装sw2urdf</h3>

<ol>
  <li>去github上下载sw2urdf插件（这个SW版本不用管，实测在后续的SW版本依然可用）</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1556.webp" alt="" /></p>

<ol>
  <li>查看SW的安装路径</li>
</ol>

<p>比如我的路径”C:\Program Files\SOLIDWORKS Corp\SOLIDWORKS\”</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1557.webp" alt="" /></p>

<ol>
  <li>打开插件安装器，默认情况下会自动找到你的SW路径进行安装，如果没有自动找到路径安装，那么需要手动选取SW安装路径。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1558.webp" alt="" /></p>

<ol>
  <li>查看插件是否安装成功</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1559.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1560.webp" alt="" /></p>

<p>如图这样就是安装成功了。</p>

<h3 id="导出urdf与meshes">导出URDF与Meshes</h3>

<ol>
  <li>如图是一个标准的SW装配体图(大家也可以尝试自己手撸一个，里面没有传动装置也可以)</li>
</ol>

<p>这个过程看不太懂的话，可以参考一下古月居老师的视频，结合本教程一起学习。 【SolidWorks模型导出urdf（古月居老师）-哔哩哔哩】https://www.bilibili.com/video/BV1Tx411o7rH</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1561.webp" alt="" /></p>

<ol>
  <li>对joint关节建立基准轴</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1562.webp" alt="" /></p>

<p>选择关节的圆柱面或者其他面，对转轴进行标定</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1563.webp" alt="" /></p>

<p>如果建完基准轴，发现不能够正常展示，那么就打开该选项。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1564.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1565.webp" alt="" /></p>

<p>建完所有系后</p>

<ol>
  <li>打开export as URDF选项</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1566.webp" alt="" /></p>

<ol>
  <li>需要先选择base_link基底刚体</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1567.webp" alt="" /></p>

<p>这里的Global Origin可能需要自己选择，就选择Origin_Global即可，但是一般选择automatically Generate即可。</p>

<ol>
  <li>因为他的base_link通过一个joint连接了一个child_link，所以，这个选项要填1。</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1568.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1569.webp" alt="" /></p>

<p>咱们把base_link连接的关节叫joint1，把joint1连接的更上面的刚体叫做link1,</p>

<p>然后参考基准轴选择刚才咱们在这个关节处建立的基准轴1，然后joint type关节类型选择revolute（有限位的关节，只有这样，机器人关节才可以正常运动）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1570.webp" alt="" /></p>

<p>这里的参考坐标系系统可以选择automatically Generate，也可以选择Origin_Joint1。</p>

<p>然后再在link1上加一，创建link2。</p>

<p>后面的link3，link4添加步骤是一样的，不再详细展示。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1571.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1572.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1573.webp" alt="" /></p>

<ol>
  <li>点击preview and export</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1574.webp" alt="" /></p>

<ol>
  <li>对关节进行限位设置</li>
</ol>

<p>coordinates是坐标系，axis是轴，如果这里Axis坐标显示错误，那么说明Coordinates或者Axis选择错了，请手动选择正确的坐标系或者基准轴。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1575.webp" alt="" /></p>

<p>如果转轴生成错误，比如都是000，可以自己填一下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1576.webp" alt="" /></p>

<p>比如这里是X轴，可以把左轮全填-100,右轮100（这里，仅供参考，chatgpt提供的解决方案）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1577.webp" alt="" /></p>

<ol>
  <li>查看矩阵，并点导出urdf与meshes</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1578.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1579.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1580.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1581.webp" alt="" /></p>

<p>这样就成功生成ROS1的WS了，将WS移动至Linux系统。</p>

<h3 id="将ros1的ws转化为ros2的ws">将ROS1的WS转化为ROS2的WS</h3>

<ol>
  <li>先将ROS1的WS移动到Linux系统上</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1582.webp" alt="" /></p>

<ol>
  <li>新建一个ROS2的WS</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1583.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> ros2_4axisrobot_ws/src
<span class="nb">cd </span>ros2_4axisrobot_ws/
colcon build
<span class="nb">cd </span>src
ros2 pkg create cpp01_urdf <span class="nt">--build-type</span> ament_cmake
<span class="nb">cd</span> ..
code <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>完善WS的目录</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1584.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1585.webp" alt="" /></p>

<p>在./src/cpp01_urdf路径下创建launch、meshes、rviz、urdf等等文件夹，在urdf文件夹下再新建urdf和xacro文件夹</p>

<ol>
  <li>复制ROS1的WS里的URDF和Meshes到ROS2的WS中</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1586.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1587.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1588.webp" alt="" /></p>

<ol>
  <li>对CMake和package进行配置</li>
</ol>

<p>在CMake中请添加</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>
  DIRECTORY launch urdf rviz meshes
  DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>  
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在Package.xml中请添加</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;exec_depend&gt;</span>rviz2<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>xacro<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>robot_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>joint_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>ros2launch<span class="nt">&lt;/exec_depend&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>CMakeLists.txt</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.8<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>cpp01_urdf<span class="p">)</span>

<span class="nb">if</span><span class="p">(</span>CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES <span class="s2">"Clang"</span><span class="p">)</span>
  <span class="nb">add_compile_options</span><span class="p">(</span>-Wall -Wextra -Wpedantic<span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c1"># find dependencies</span>
<span class="nb">find_package</span><span class="p">(</span>ament_cmake REQUIRED<span class="p">)</span>

<span class="c1"># uncomment the following section in order to fill in</span>

<span class="c1"># further dependencies manually.</span>

<span class="c1"># find_package(&lt;dependency&gt; REQUIRED)</span>

<span class="nb">install</span><span class="p">(</span>
  DIRECTORY launch urdf rviz meshes
  DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>  
<span class="p">)</span>

<span class="nb">if</span><span class="p">(</span>BUILD_TESTING<span class="p">)</span>
  <span class="nb">find_package</span><span class="p">(</span>ament_lint_auto REQUIRED<span class="p">)</span>

  <span class="c1"># the following line skips the linter which checks for copyrights</span>

  <span class="c1"># comment the line when a copyright and license is added to all source files</span>
  <span class="nb">set</span><span class="p">(</span>ament_cmake_copyright_FOUND TRUE<span class="p">)</span>

  <span class="c1"># the following line skips cpplint (only works in a git repo)</span>

  <span class="c1"># comment the line when this package is in a git repo and when</span>

  <span class="c1"># a copyright and license is added to all source files</span>
  <span class="nb">set</span><span class="p">(</span>ament_cmake_cpplint_FOUND TRUE<span class="p">)</span>
  <span class="nf">ament_lint_auto_find_test_dependencies</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nf">ament_package</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>package.xml</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="cp">&lt;?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"?&gt;</span>
<span class="nt">&lt;package</span> <span class="na">format=</span><span class="s">"3"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;name&gt;</span>cpp01_urdf<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;version&gt;</span>0.0.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;description&gt;</span>TODO: Package description<span class="nt">&lt;/description&gt;</span>
  <span class="nt">&lt;maintainer</span> <span class="na">email=</span><span class="s">"tungchiahui@gmail.com"</span><span class="nt">&gt;</span>tungchiahui<span class="nt">&lt;/maintainer&gt;</span>
  <span class="nt">&lt;license&gt;</span>TODO: License declaration<span class="nt">&lt;/license&gt;</span>

  <span class="nt">&lt;buildtool_depend&gt;</span>ament_cmake<span class="nt">&lt;/buildtool_depend&gt;</span>

  <span class="nt">&lt;exec_depend&gt;</span>rviz2<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>xacro<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>robot_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>joint_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>ros2launch<span class="nt">&lt;/exec_depend&gt;</span>

  <span class="nt">&lt;test_depend&gt;</span>ament_lint_auto<span class="nt">&lt;/test_depend&gt;</span>
  <span class="nt">&lt;test_depend&gt;</span>ament_lint_common<span class="nt">&lt;/test_depend&gt;</span>

  <span class="nt">&lt;export&gt;</span>
    <span class="nt">&lt;build_type&gt;</span>ament_cmake<span class="nt">&lt;/build_type&gt;</span>
  <span class="nt">&lt;/export&gt;</span>
<span class="nt">&lt;/package&gt;</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>对launch文件进行编写</li>
</ol>

<p>详细过程请看URDF有关Launch的核心优化那一节</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1589.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span>
<span class="c1"># from launch.actions import ExecuteProcess
</span>
<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>

<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch_ros.parameter_descriptions</span> <span class="kn">import</span> <span class="n">ParameterValue</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="kn">import</span> <span class="n">os</span>

<span class="n">cpp01_urdf_dir</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">cpp01_urdf</span><span class="sh">"</span><span class="p">)</span>

<span class="n">default_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cpp01_urdf_dir</span><span class="p">,</span><span class="sh">"</span><span class="s">urdf/urdf</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">4axisrobot.urdf</span><span class="sh">"</span><span class="p">)</span>
<span class="n">default_rviz_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cpp01_urdf_dir</span><span class="p">,</span><span class="sh">"</span><span class="s">rviz</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">urdf.rviz</span><span class="sh">"</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="n">default_model_path</span><span class="p">)</span>

<span class="n">p_value</span> <span class="o">=</span> <span class="nc">ParameterValue</span><span class="p">(</span><span class="nc">Command</span><span class="p">([</span><span class="sh">"</span><span class="s">xacro </span><span class="sh">"</span><span class="p">,</span><span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)]))</span>
<span class="n">robot_state_pub</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">robot_description</span><span class="sh">"</span><span class="p">:</span><span class="n">p_value</span><span class="p">}]</span>
<span class="p">)</span>

<span class="c1"># 关节信息节点(建议)
</span>
<span class="c1"># joint_state_pub = Node(
</span>
<span class="c1">#     package="joint_state_publisher",
</span>
<span class="c1">#     executable="joint_state_publisher"
</span>
<span class="c1"># )
</span>
<span class="c1"># 关节信息节点图形界面
</span><span class="n">joint_state_pub</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher_gui</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">joint_state_publisher_gui</span><span class="sh">"</span>
<span class="p">)</span>

<span class="n">rviz2</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">rviz2</span><span class="sh">"</span><span class="p">,</span>

<span class="c1">#    arguments=["-d",get_package_share_directory("cpp06_urdf") + "/rviz/urdf.rviz"]
</span>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-d</span><span class="sh">"</span><span class="p">,</span><span class="n">default_rviz_path</span><span class="p">]</span>

    <span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">model</span><span class="p">,</span><span class="n">robot_state_pub</span><span class="p">,</span><span class="n">joint_state_pub</span><span class="p">,</span><span class="n">rviz2</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>对URDF文件进行修改</li>
</ol>

<p>修改的内容主要有两项，一个是meshes的路径，一个是删掉易引起报错的注释。</p>

<p>主要由于ROS1的WS和ROS2的WS路径不同，所以，我们只需要修改有关路径的内容，比如说Meshes的路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1590.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1591.webp" alt="" /></p>

<p>package://一般是share目录，所以我们需要从cpp01_urdf这一级开始写（share目录需要编译后才会显示）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1592.webp" alt="" /></p>

<p>然后按Ctrl+H</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1593.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1594.webp" alt="" /></p>

<p>然后还需要删除掉urdf文件刚开始的注释，否则也会报错</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1595.webp" alt="" /></p>

<p>如下是替换完毕的URDF文件：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;robot</span>
  <span class="na">name=</span><span class="s">"4axisrobot"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span>
    <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"-0.0819771145953119 -0.0394328123681598 -0.0605612328464761"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;mass</span>
        <span class="na">value=</span><span class="s">"7.43807257011133"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span>
        <span class="na">ixx=</span><span class="s">"0.33173827700719"</span>
        <span class="na">ixy=</span><span class="s">"-1.91350798633049E-05"</span>
        <span class="na">ixz=</span><span class="s">"-2.38586363043925E-05"</span>
        <span class="na">iyy=</span><span class="s">"0.510937907009661"</span>
        <span class="na">iyz=</span><span class="s">"1.14706407748075E-05"</span>
        <span class="na">izz=</span><span class="s">"0.66107272632796"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/base_link.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span>
        <span class="na">name=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span>
          <span class="na">rgba=</span><span class="s">"0.792156862745098 0.819607843137255 0.933333333333333 1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/base_link.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;link</span>
    <span class="na">name=</span><span class="s">"link1"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0.19141 -0.050676 -0.030057"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;mass</span>
        <span class="na">value=</span><span class="s">"21.822"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span>
        <span class="na">ixx=</span><span class="s">"0.50464"</span>
        <span class="na">ixy=</span><span class="s">"0.13295"</span>
        <span class="na">ixz=</span><span class="s">"0.087353"</span>
        <span class="na">iyy=</span><span class="s">"0.59136"</span>
        <span class="na">iyz=</span><span class="s">"-0.066053"</span>
        <span class="na">izz=</span><span class="s">"0.64081"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link1.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span>
        <span class="na">name=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span>
          <span class="na">rgba=</span><span class="s">"0.79216 0.81961 0.93333 1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link1.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;joint</span>
    <span class="na">name=</span><span class="s">"joint1"</span>
    <span class="na">type=</span><span class="s">"revolute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span>
      <span class="na">xyz=</span><span class="s">"-0.081947 -0.039447 0.11191"</span>
      <span class="na">rpy=</span><span class="s">"0.40394 -1.5708 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span>
      <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span>
      <span class="na">link=</span><span class="s">"link1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span>
      <span class="na">xyz=</span><span class="s">"1 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;limit</span>
      <span class="na">lower=</span><span class="s">"-3.14"</span>
      <span class="na">upper=</span><span class="s">"3.14"</span>
      <span class="na">effort=</span><span class="s">"100"</span>
      <span class="na">velocity=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>
  <span class="nt">&lt;link</span>
    <span class="na">name=</span><span class="s">"link2"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0.00711598521454873 0.430460941882332 -0.181074256126024"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;mass</span>
        <span class="na">value=</span><span class="s">"30.6115349647897"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span>
        <span class="na">ixx=</span><span class="s">"2.84056101478768"</span>
        <span class="na">ixy=</span><span class="s">"0.00176700425270318"</span>
        <span class="na">ixz=</span><span class="s">"-0.000605507690039326"</span>
        <span class="na">iyy=</span><span class="s">"0.803420593303961"</span>
        <span class="na">iyz=</span><span class="s">"0.881921487314161"</span>
        <span class="na">izz=</span><span class="s">"2.25142021571439"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link2.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span>
        <span class="na">name=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span>
          <span class="na">rgba=</span><span class="s">"0.792156862745098 0.819607843137255 0.933333333333333 1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link2.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;joint</span>
    <span class="na">name=</span><span class="s">"joint2"</span>
    <span class="na">type=</span><span class="s">"revolute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span>
      <span class="na">xyz=</span><span class="s">"0.35141 -0.28119 0.13918"</span>
      <span class="na">rpy=</span><span class="s">"-2.0566 1.1982 1.5708"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span>
      <span class="na">link=</span><span class="s">"link1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span>
      <span class="na">link=</span><span class="s">"link2"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span>
      <span class="na">xyz=</span><span class="s">"-1 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;limit</span>
      <span class="na">lower=</span><span class="s">"-3.14"</span>
      <span class="na">upper=</span><span class="s">"3.14"</span>
      <span class="na">effort=</span><span class="s">"100"</span>
      <span class="na">velocity=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>
  <span class="nt">&lt;link</span>
    <span class="na">name=</span><span class="s">"link3"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0.00112887115421612 0.0366346915274407 0.31720330934553"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;mass</span>
        <span class="na">value=</span><span class="s">"32.192726667578"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span>
        <span class="na">ixx=</span><span class="s">"4.01515983126431"</span>
        <span class="na">ixy=</span><span class="s">"0.0013193752174692"</span>
        <span class="na">ixz=</span><span class="s">"0.0113529938102155"</span>
        <span class="na">iyy=</span><span class="s">"3.86196311673823"</span>
        <span class="na">iyz=</span><span class="s">"-0.336440022491883"</span>
        <span class="na">izz=</span><span class="s">"0.399977905540088"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link3.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span>
        <span class="na">name=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span>
          <span class="na">rgba=</span><span class="s">"0.792156862745098 0.819607843137255 0.933333333333333 1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link3.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;joint</span>
    <span class="na">name=</span><span class="s">"joint3"</span>
    <span class="na">type=</span><span class="s">"revolute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span>
      <span class="na">xyz=</span><span class="s">"0.3765 0.82481 -0.49591"</span>
      <span class="na">rpy=</span><span class="s">"2.5802 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span>
      <span class="na">link=</span><span class="s">"link2"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span>
      <span class="na">link=</span><span class="s">"link3"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span>
      <span class="na">xyz=</span><span class="s">"1 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;limit</span>
      <span class="na">lower=</span><span class="s">"-3.14"</span>
      <span class="na">upper=</span><span class="s">"3.14"</span>
      <span class="na">effort=</span><span class="s">"100"</span>
      <span class="na">velocity=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>
  <span class="nt">&lt;link</span>
    <span class="na">name=</span><span class="s">"link4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0.162516620557178 -0.213844847423599 3.38133504529381E-07"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;mass</span>
        <span class="na">value=</span><span class="s">"12.1646007734167"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span>
        <span class="na">ixx=</span><span class="s">"0.288208127188405"</span>
        <span class="na">ixy=</span><span class="s">"0.00080326659836716"</span>
        <span class="na">ixz=</span><span class="s">"8.72489392803044E-07"</span>
        <span class="na">iyy=</span><span class="s">"0.107000706575729"</span>
        <span class="na">iyz=</span><span class="s">"-1.48935044230573E-07"</span>
        <span class="na">izz=</span><span class="s">"0.295147863994059"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link4.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span>
        <span class="na">name=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span>
          <span class="na">rgba=</span><span class="s">"0.792156862745098 0.819607843137255 0.933333333333333 1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span>
        <span class="na">xyz=</span><span class="s">"0 0 0"</span>
        <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span>
          <span class="na">filename=</span><span class="s">"package://cpp01_urdf/meshes/link4.STL"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;joint</span>
    <span class="na">name=</span><span class="s">"joint4"</span>
    <span class="na">type=</span><span class="s">"revolute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span>
      <span class="na">xyz=</span><span class="s">"0 0.070837 0.99728"</span>
      <span class="na">rpy=</span><span class="s">"0.82315 -1.5708 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span>
      <span class="na">link=</span><span class="s">"link3"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span>
      <span class="na">link=</span><span class="s">"link4"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span>
      <span class="na">xyz=</span><span class="s">"1 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;limit</span>
      <span class="na">lower=</span><span class="s">"-3.14"</span>
      <span class="na">upper=</span><span class="s">"3.14"</span>
      <span class="na">effort=</span><span class="s">"100"</span>
      <span class="na">velocity=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>编译</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> cpp01_urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1596.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1597.webp" alt="" /></p>

<ol>
  <li>更新终端环境</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">source install</span>/setup.bash
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1598.webp" alt="" /></p>

<ol>
  <li>运行Launch</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch cpp01_urdf display.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1599.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1600.webp" alt="" /></p>

<ol>
  <li>在Rviz2中添加插件以及基本配置</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1601.webp" alt="" /></p>

<ol>
  <li>使用joint_state_publisher_gui可以调关节的角度</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1602.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1603.webp" alt="" /></p>

<ol>
  <li>保存rviz2的配置到rviz文件夹中</li>
</ol>

<p>首先点击rviz2的菜单栏上的File，然后选择Save Config as</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1604.webp" alt="" /></p>

<p>可以去本节简介看效果视频</p>

<h3 id="注意事项仅供参考chatgpt的解决方案">注意事项（仅供参考，ChatGPT的解决方案）</h3>

<h4 id="坐标系1">坐标系1</h4>

<p>轮子要用continuous的关节，并且尽量自己选坐标系，要求从后面看车的话，左是Y，前是X，上是Z。所有的坐标系都要求。</p>

<p>可以先让他帮你自动生成一个，你再去修改坐标系，要简单一些。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1605.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1606.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1607.webp" alt="" /></p>

<h4 id="坐标系让车躺着">坐标系让车躺着</h4>

<p>如果你的车在rviz2里是侧着睡觉的，那么：</p>

<p>哈哈，没错，这种“整车侧着躺尸”的情况 <strong>90%就是 STL 的坐标轴方向搞错了</strong> 。很多 CAD 工具导出的 STL 模型默认是：</p>

<ul>
  <li>
    <p>Z 轴朝前（例如 SolidWorks：Z朝前，Y朝上，用右手坐标系推X坐标系位置，从车屁股后面看是朝左。）</p>
  </li>
  <li>
    <p>或者 Y 轴朝上（例如 Blender）</p>
  </li>
</ul>

<p>而 ROS/URDF 的坐标系统是：</p>

<ul>
  <li>
    <p>X 向前（前进方向）</p>
  </li>
  <li>
    <p>Y 向左（平移方向）</p>
  </li>
  <li>
    <p>Z 向上（重力方向）</p>
  </li>
</ul>

<h4 id="车直走变旋转旋转变直走">车直走变旋转，旋转变直走</h4>

<p>那说明你的转轴有问题。</p>

<p>如果向前走成了左转，那么说明左轮的转轴错了，少了个符号，加上就行了。</p>

<p>比如这个010,你应该改成0-10</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1608.webp" alt="" /></p>

<h2 id="xacro">xacro</h2>

<h3 id="场景作用与概念">场景、作用与概念</h3>

<p><strong>场景</strong></p>

<p>前面 URDF 文件构建机器人模型的过程中，存在若干问题。</p>

<blockquote>
  <p>问题1：在设计关节的位置时，需要按照一定的规则计算，规则是固定的，但是在 URDF 中依赖于人工计算，存在不便，容易计算失误，且当某些参数发生改变时，还需要重新计算。</p>

  <p>问题2：URDF中的部分内容是高度重复的，比如车轮的设计实现，不同轮子只是部分参数不同，形状、颜色、翻转量都是一致的，在实际应用中，构建复杂的机器人模型时，更是易于出现高度重复的设计，按照一般的编程思想涉及到重复代码应该考虑封装、复用，但是在之前的URDF文件中并没有相关操作。</p>

  <p>……</p>
</blockquote>

<p>如果在一般编程语言中遇到类似问题，我们可以通过变量结合函数解决。对应的，在 ROS 中也给出了类似编程的优化方案，该方案称之为： <strong>Xacro（可以理解为urdf2.0）</strong> 。</p>

<p><strong>概念</strong></p>

<p>Xacro 是 XML Macros 的缩写，Xacro 是一种 XML 宏语言，是可编程的 XML。</p>

<p>Xacro 可以声明变量，可以通过数学运算求解；可以使用流程控制控制执行顺序；还可以通过宏封装(可以想成函数)、复用功能，从而提高代码复用率以及程序的安全性。</p>

<p><strong>作用</strong></p>

<p>较之于纯粹的 URDF 实现，可以编写更安全、精简、易读性更强的机器人模型文件，且可以提高编写效率。</p>

<h3 id="快速体验">快速体验</h3>

<p>先安装xacro</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c">#humble版本</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-xacro
<span class="c">#jazzy版本</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-xacro
</pre></td></tr></tbody></table></code></pre></div></div>

<p>1.需求</p>

<p>使用xacro优化 <strong>6.4.4 URDF练习</strong> 中的小车底盘实现，需要使用变量封装车辆参数，并使用 xacro 宏封装轮子重复的代码并调用宏创建四个轮子(注意: 在此，演示 xacro 的基本使用，不必要生成合法的 URDF )。</p>

<p>2.实现</p>

<p>功能包cpp06_urdf的urdf/xacro目录下，新建xacro文件demo01_helloworld.urdf.xacro，并编辑文件，输入如下内容：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"mycar"</span> <span class="na">xmlns:xacro=</span><span class="s">"http://wiki.ros.org/xacro"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"wheel_radius"</span> <span class="na">value=</span><span class="s">"0.025"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"wheel_length"</span> <span class="na">value=</span><span class="s">"0.02"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"PI"</span> <span class="na">value=</span><span class="s">"3.1415927"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;xacro:macro</span> <span class="na">name=</span><span class="s">"wheel_func"</span> <span class="na">params=</span><span class="s">"wheel_name"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"${wheel_name}_wheel"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;visual&gt;</span>
                <span class="nt">&lt;geometry&gt;</span>
                    <span class="nt">&lt;cylinder</span> <span class="na">radius=</span><span class="s">"${wheel_radius}"</span> <span class="na">length=</span><span class="s">"${wheel_length}"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/geometry&gt;</span>

                <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"${PI / 2} 0 0"</span> <span class="nt">/&gt;</span>

                <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"wheel_color"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0 0 0 0.3"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/material&gt;</span>
            <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;/link&gt;</span>
    <span class="nt">&lt;/xacro:macro&gt;</span>
    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"left_front"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"left_back"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"right_front"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"right_back"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1609.webp" alt="" /></p>

<p>宏类似函数</p>

<p>params类似入口参数</p>

<p>子标签类似函数体</p>

<p>终端下进入当前文件所述目录，输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">cd </span>src/cpp06_urdf/urdf/xacro/
xacro demo01_helloworld.urdf.xacro
<span class="c">#或者</span>
ros2 run xacro xacro demo01_helloworld.urdf.xacro
</pre></td></tr></tbody></table></code></pre></div></div>

<p>终端将会输出如下内容（以下内容是纯urdf）：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" ?&gt;</span>

<span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"mycar"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"left_front_wheel"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.02"</span> <span class="na">radius=</span><span class="s">"0.025"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">rpy=</span><span class="s">"1.57079635 0 0"</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"wheel_color"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0 0 0 0.3"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"left_back_wheel"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.02"</span> <span class="na">radius=</span><span class="s">"0.025"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">rpy=</span><span class="s">"1.57079635 0 0"</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"wheel_color"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0 0 0 0.3"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"right_front_wheel"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.02"</span> <span class="na">radius=</span><span class="s">"0.025"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">rpy=</span><span class="s">"1.57079635 0 0"</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"wheel_color"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0 0 0 0.3"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"right_back_wheel"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.02"</span> <span class="na">radius=</span><span class="s">"0.025"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">rpy=</span><span class="s">"1.57079635 0 0"</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"wheel_color"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0 0 0 0.3"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>显然的，通过xacro我们方便的实现了代码复用。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1610.webp" alt="" /></p>

<h4 id="语法">语法</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
</pre></td><td class="rouge-code"><pre>1.  简介

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1611.webp)

  xacro 提供了可编程接口，类似于计算机语言，包括变量声明调用、函数声明与调用等语法实现。在使用 xacro 生成 urdf 时，根标签`robot`中**必须**包含命名空间声明:`xmlns:xacro="``http://wiki.ros.org/xacro``"`。

   **变量**

  变量用于封装 URDF 中的一些字段，比如: PAI 值，小车的尺寸，轮子半径 ....，变量的基本使用语法包括变量定义、变量调用、变量运算等。

  1.1变量定义

  语法格式：

```xml
&lt;xacro:property name="变量名" value="变量值" /&gt;
```

  示例：

```xml
&lt;xacro:property name="PI" value="3.1416"/&gt;
&lt;xacro:property name="wheel_radius" value="0.025"/&gt;
&lt;xacro:property name="wheel_length" value="0.02"/&gt;
```

  1.2变量调用

  语法格式：

```xml
${变量名}
```

  示例：

```xml
&lt;geometry&gt;
    &lt;cylinder radius="${wheel_radius}" length="${wheel_length}" /&gt;
&lt;/geometry&gt;
```

  1.3变量运算

  语法格式：

```xml
${数学表达式}
```

  示例：

```xml
&lt;origin xyz="0 0 0" rpy="${PI / 2} 0 0" /&gt;
```

```xml
&lt;robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="demo2_pro"&gt;

&lt;xacro:property name="num1" value="10"/&gt;
&lt;xacro:property name="num2" value="20"/&gt;

&lt;car length="${num1}" width="${num2}"/&gt;

&lt;sum value="${num1 + num2}"/&gt;
&lt;/robot&gt;
```

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1612.webp)

   **宏**

  类似于函数实现，提高代码复用率，优化代码结构，提高安全性。宏的基本使用语法包括宏的定义与调用。

  2.1宏定义

  语法格式：

```xml
&lt;xacro:macro name="宏名称" params="参数列表(多参数之间使用空格分隔)"&gt;
    .....
    参数调用格式: ${参数名}
&lt;/xacro:macro&gt;
```

  示例：

```xml
&lt;xacro:macro name="wheel_func" params="wheel_name" &gt;
    &lt;link name="${wheel_name}_wheel"&gt;
        &lt;visual&gt;
            &lt;geometry&gt;
                &lt;cylinder radius="${wheel_radius}" length="${wheel_length}" /&gt;
            &lt;/geometry&gt;

            &lt;origin xyz="0 0 0" rpy="${PI / 2} 0 0" /&gt;

            &lt;material name="wheel_color"&gt;
                &lt;color rgba="0 0 0 0.3" /&gt;
            &lt;/material&gt;
        &lt;/visual&gt;
    &lt;/link&gt;
&lt;/xacro:macro&gt;
```

  2.2宏调用

  语法格式：

```xml
&lt;xacro:宏名称 参数1=xxx 参数2=xxx/&gt;
```

  示例：

```xml
&lt;xacro:wheel_func wheel_name="left_front"/&gt;
&lt;xacro:wheel_func wheel_name="left_back"/&gt;
&lt;xacro:wheel_func wheel_name="right_front"/&gt;
&lt;xacro:wheel_func wheel_name="right_back"/&gt;
```

```xml
&lt;robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="demo3_func"&gt;

    &lt;xacro:macro name="get_sum" params="num1 num2"&gt;
        &lt;sum value="${num1 + num2}"/&gt;
    &lt;/xacro:macro&gt;

    &lt;xacro:get_sum num1="20" num2="30"/&gt;
    &lt;xacro:get_sum num1="70" num2="30"/&gt;

&lt;/robot&gt;
```

![](https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1613.webp)

   **文件**
</pre></td></tr></tbody></table></code></pre></div></div>

<p>机器人由多部件组成，不同部件可能封装为单独的 xacro 文件，最后再将不同的文件集成，组合为完整机器人，可以使用文件包含实现。</p>

<p>语法格式：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"其他xacro文件"</span> <span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>示例：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"car"</span> <span class="na">xmlns:xacro=</span><span class="s">"http://wiki.ros.org/xacro"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"car_base.xacro"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"car_camera.xacro"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"car_laser.xacro"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">xmlns:xacro=</span><span class="s">"http://www.ros.org/wiki/xacro"</span> <span class="na">name=</span><span class="s">"demo4_include"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"demo02_base_pro.urdf.xacro"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"demo03_base_func.urdf.xacro"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1614.webp" alt="" /></p>

<p><em>但不建议这样，建议父级xacro和子级xacro使用同样的name。</em></p>

<h3 id="练习-3">练习</h3>

<h4 id="框架">框架</h4>

<p>1.需求</p>

<p>使用xacro创建一个四轮机器人模型，该模型底盘可以参考 <strong>6.4.4 URDF练习</strong> 中的实现，并且在底盘之上添加了相机与激光雷达。相机与激光雷达的尺寸参数、安装位置可自定义。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1615.webp" alt="" /></p>

<p>2.实现分析</p>

<p>需求中的机器人模型是由底盘、摄像头和雷达三部分组成的，那么可以将每一部分都封装进一个xacro文件，最后再通过xacro文件包含组织成一个完整的机器人模型。</p>

<p>3.实现</p>

<p>功能包cpp06_urdf的urdf/xacro目录下，新建多个xacro文件，分别为：</p>

<ul>
  <li>
    <p>car.urdf.xacro：用于包含不同机器人部件对应的xacro文件；</p>
  </li>
  <li>
    <p>car_base.urdf.xacro：描述机器人底盘的xacro文件；</p>
  </li>
  <li>
    <p>car_camera.urdf.xacro：描述摄像头的xacro文件；</p>
  </li>
  <li>
    <p>car_laser.urdf.xacro：描述雷达的xacro文件。</p>
  </li>
</ul>

<p>编辑car.urdf.xacro文件，输入如下内容：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"car"</span> <span class="na">xmlns:xacro=</span><span class="s">"http://wiki.ros.org/xacro"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"car_base.urdf.xacro"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"car_camera.urdf.xacro"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"car_laser.urdf.xacro"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="车体">车体</h4>

<p>编辑car_base.urdf.xacro文件，输入如下内容：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">xmlns:xacro=</span><span class="s">"http://wiki.ros.org/xacro"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"PI"</span> <span class="na">value=</span><span class="s">"3.1416"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"base_link_x"</span> <span class="na">value=</span><span class="s">"0.2"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"base_link_y"</span> <span class="na">value=</span><span class="s">"0.12"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"base_link_z"</span> <span class="na">value=</span><span class="s">"0.07"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"distance"</span> <span class="na">value=</span><span class="s">"0.015"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"wheel_radius"</span> <span class="na">value=</span><span class="s">"0.025"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"wheel_length"</span> <span class="na">value=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.7 0.7 0 0.8"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"red"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.8 0.1 0.1 0.8"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"gray"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.2 0.2 0.2 0.95"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/material&gt;</span>

    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_footprint"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;visual&gt;</span>
            <span class="nt">&lt;geometry&gt;</span>
                <span class="nt">&lt;sphere</span> <span class="na">radius=</span><span class="s">"0.001"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/geometry&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;/link&gt;</span>

    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;visual&gt;</span>

            <span class="nt">&lt;geometry&gt;</span>
                <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"${base_link_x} ${base_link_y} ${base_link_z}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/geometry&gt;</span>
            <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"yellow"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;/link&gt;</span>
    <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"baselink2basefootprint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_footprint"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0.0 ${distance + base_link_z / 2}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/joint&gt;</span>

    <span class="nt">&lt;xacro:macro</span> <span class="na">name=</span><span class="s">"wheel_func"</span> <span class="na">params=</span><span class="s">"wheel_name is_front is_left"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"${wheel_name}_wheel"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;visual&gt;</span>
                <span class="nt">&lt;geometry&gt;</span>
                    <span class="nt">&lt;cylinder</span> <span class="na">radius=</span><span class="s">"${wheel_radius}"</span> <span class="na">length=</span><span class="s">"${wheel_length}"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/geometry&gt;</span>
                <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"${PI / 2} 0 0"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"gray"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;/link&gt;</span>
        <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"${wheel_name}2baselink"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span>  <span class="nt">/&gt;</span>
            <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"${wheel_name}_wheel"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"${(base_link_x / 2 - wheel_radius) * is_front} ${base_link_y / 2 * is_left} ${(base_link_z / 2 + distance - wheel_radius) * -1}"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/joint&gt;</span>
    <span class="nt">&lt;/xacro:macro&gt;</span>

    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"left_front"</span> <span class="na">is_front=</span><span class="s">"1"</span> <span class="na">is_left=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"left_back"</span> <span class="na">is_front=</span><span class="s">"-1"</span> <span class="na">is_left=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"right_front"</span> <span class="na">is_front=</span><span class="s">"1"</span> <span class="na">is_left=</span><span class="s">"-1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:wheel_func</span> <span class="na">wheel_name=</span><span class="s">"right_back"</span> <span class="na">is_front=</span><span class="s">"-1"</span> <span class="na">is_left=</span><span class="s">"-1"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="添加摄像头">添加摄像头</h4>

<p>编辑car_camera.urdf.xacro文件，输入如下内容：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>
<span class="nt">&lt;robot</span> <span class="na">xmlns:xacro=</span><span class="s">"http://wiki.ros.org/xacro"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"camera_x"</span> <span class="na">value=</span><span class="s">"0.012"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"camera_y"</span> <span class="na">value=</span><span class="s">"0.05"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"camera_z"</span> <span class="na">value=</span><span class="s">"0.01"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"camera_joint_x"</span> <span class="na">value=</span><span class="s">"${base_link_x / 2 - camera_x / 2}"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"camera_joint_y"</span> <span class="na">value=</span><span class="s">"0.0"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"camera_joint_z"</span> <span class="na">value=</span><span class="s">"${base_link_z / 2 + camera_z / 2}"</span> <span class="nt">/&gt;</span> 

    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"camera"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;visual&gt;</span>
            <span class="nt">&lt;geometry&gt;</span>
                <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"${camera_x} ${camera_y} ${camera_z}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/geometry&gt;</span>
            <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0.0 0.0"</span> <span class="na">rpy=</span><span class="s">"0.0 0.0 0.0"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"red"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;/link&gt;</span>

    <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"camera2baselink"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"camera"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"${camera_joint_x} ${camera_joint_y} ${camera_joint_z}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/joint&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="添加雷达">添加雷达</h4>

<p>编辑car_laser.urdf.xacro文件，输入如下内容：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>
<span class="nt">&lt;robot</span> <span class="na">xmlns:xacro=</span><span class="s">"http://wiki.ros.org/xacro"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"blue"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.4 0.95"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/material&gt;</span>

    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"laser_length"</span> <span class="na">value=</span><span class="s">"0.03"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"laser_radius"</span> <span class="na">value=</span><span class="s">"0.03"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"laser_joint_x"</span> <span class="na">value=</span><span class="s">"0.0"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"laser_joint_y"</span> <span class="na">value=</span><span class="s">"0.0"</span> <span class="nt">/&gt;</span> 
    <span class="nt">&lt;xacro:property</span> <span class="na">name=</span><span class="s">"laser_joint_z"</span> <span class="na">value=</span><span class="s">"${base_link_z / 2 + laser_length / 2}"</span> <span class="nt">/&gt;</span> 

    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"laser"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;visual&gt;</span>
            <span class="nt">&lt;geometry&gt;</span>
                <span class="nt">&lt;cylinder</span> <span class="na">radius=</span><span class="s">"${laser_radius}"</span> <span class="na">length=</span><span class="s">"${laser_length}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/geometry&gt;</span>
            <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0.0 0.0"</span> <span class="na">rpy=</span><span class="s">"0.0 0.0 0.0"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"blue"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;/link&gt;</span>

    <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"laser2baselink"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"laser"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"${laser_joint_x} ${laser_joint_y} ${laser_joint_z}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/joint&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="执行">执行</h4>

<p>编译后，工作空间终端下调用如下命令执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
<span class="c"># ROS Humble</span>
ros2 launch cpp06_urdf display.launch.py model:<span class="o">=</span>ros2 pkg prefix <span class="nt">--share</span> cpp06_urdf/urdf/xacro/car.urdf.xacro
<span class="c">#ROS Jazzy</span>
colcon build
<span class="nb">source install</span>/setup.bash
ros2 run xacro xacro <span class="si">$(</span>ros2 pkg prefix cpp06_urdf<span class="si">)</span>/share/cpp06_urdf/urdf/xacro/car.urdf.xacro <span class="nt">-o</span> ./src/cpp06_urdf/urdf/urdf/car.urdf
ros2 launch cpp06_urdf display.launch.py model:<span class="o">=</span>./src/cpp06_urdf/urdf/urdf/car.urdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>命令执行后，rviz2 中可以显示与需求类似的机器人模型。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1616.webp" alt="" /></p>

<h2 id="小结-2">小结</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1617.webp" alt="" /></p>

<p>目前只是空壳，激光雷达和摄像头以及轮子还都是空壳，到进阶联系中，才可以实现作用。</p>

<h1 id="stage_ros2仿真平台">Stage_Ros2仿真平台</h1>

<p>stage_ros2是基于Stage模拟器的ROS2功能包，用于在虚拟环境中模拟和控制机器人的行为。它提供了强大的工具和通信接口，可用于开发、测试和验证机器人系统。通过stage_ros2，用户可以轻松创建虚拟环境，并使用ROS 2发送指令控制机器人的运动，同时接收传感器数据。这个功能包可以帮助用户以更低的成本和风险进行机器人开发，提供了高效且灵活的机器人仿真环境。</p>

<p><em>stage使用手册：</em></p>

<p>http://rtv.github.io/Stage/modules.html</p>

<p>（ <strong>可以不学</strong> ，连ROS2官方都已经移除掉了Stage， <strong>用更牛X的Gazebo更好</strong> ，但学一学也问题不大）</p>

<h3 id="stage_ros2安装与运行">stage_ros2安装与运行</h3>

<p>1.安装</p>

<p>因为ROS2官方已经移除掉了Stage，所以我们要通过源码编译手动安装，已经有大佬适配了ROS2版本的Stage：</p>

<p>请先调用如下指令安装依赖：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>git cmake g++ libjpeg8-dev libpng-dev libglu1-mesa-dev libltdl-dev libfltk1.1-dev
</pre></td></tr></tbody></table></code></pre></div></div>

<p>进入ROS2工作空间的src目录，调用如下指令下载相关仓库：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git clone https://github.com/damuxt/Stage.git
git clone https://github.com/damuxt/stage_ros2.git
</pre></td></tr></tbody></table></code></pre></div></div>

<p>进入工作空间目录，使用<code class="language-plaintext highlighter-rouge">colcon build</code>指令进行构建。</p>

<p>（这是第三方作者适配Humble版本的，暂时不支持Jazzy版本，Jazzy版本目前编译会报错，可能作者会更新Jazzy版本的）</p>

<p>2.节点说明</p>

<p><code class="language-plaintext highlighter-rouge">stage_ros2</code>节点是stage_ros2功能包的核心节点之一。它通过加载world文件来创建一个仿真场景，包括地图、障碍物和机器人等元素。world文件描述了虚拟环境的属性，节点会根据文件中的描述构建对应的环境。stage_ros2节点利用这个虚拟环境来模拟机器人的运动、感知和控制。通过该节点和world文件的结合，可以进行机器人的仿真和测试。</p>

<p>3.使用</p>

<p>在功能包下，已经内置了使用示例，终端下可以执行如下指令启动示例：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch stage_ros2 my_house.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>模拟器以及rviz2将被启动，并且在rviz2中可以显示里程计、激光雷达以及深度相机等相关信息，运行结果如下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1618.webp" alt="" /></p>

<h3 id="stage_ros2仿真框架搭建">stage_ros2仿真框架搭建</h3>

<p>本节开始，我们将介绍如何通过stage_ros2自定义仿真环境。</p>

<p>1.准备工作</p>

<p>首先请创建一个功能包，指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create demo_stage_sim <span class="nt">--dependencies</span> stage_ros2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后在功能包下新建launch、world、config目录，并修改功能包下的CMakeLists.txt文件，添加如下代码：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="o">(</span>DIRECTORY launch world config DESTINATION share/<span class="k">${</span><span class="nv">PROJECT_NAME</span><span class="k">}</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中，launch目录用于存储launch文件，config用于存储rviz2的配置文件，world用于存储仿真相关文件。world目录中请新建maps目录，并将课程配套资料中的图片素材复制进去。</p>

<p>2.搭建代码框架</p>

<p>在功能包的launch目录下，新建stage_sim.launch.py文件，并输入如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description<span class="o">()</span>:
    this_directory <span class="o">=</span> get_package_share_directory<span class="o">(</span><span class="s1">'demo_stage_sim'</span><span class="o">)</span>
<span class="k">return </span>LaunchDescription<span class="o">([</span>
        Node<span class="o">(</span>
            <span class="nv">package</span><span class="o">=</span><span class="s1">'stage_ros2'</span>,
            <span class="nv">executable</span><span class="o">=</span><span class="s1">'stage_ros2'</span>,
            <span class="nv">name</span><span class="o">=</span><span class="s1">'stage'</span>,
            <span class="nv">parameters</span><span class="o">=[{</span><span class="s2">"world_file"</span>: os.path.join<span class="o">(</span>this_directory,<span class="s1">'world'</span>,<span class="s1">'sim.world'</span><span class="o">)}]</span>,
        <span class="o">)</span>
    <span class="o">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该launch文件将运行stage_ros2节点，并加载world目录下的sim.world文件。</p>

<p>在world目录下，新建sim.world文件，并输入如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
<span class="c"># -----------------------------------------------------------------------------</span>

<span class="c"># 设置窗体</span>

<span class="c"># 设置模拟器地图分辨率(以 米/像素 为单位)</span>
resolution 0.02

<span class="c"># 设置模拟器的时间步长(以 毫秒 为单位)</span>
interval_sim 100
</pre></td></tr></tbody></table></code></pre></div></div>

<p>sim.world文件当前只是声明了仿真环境的一些通用参数。</p>

<p>3.编译</p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> demo_stage_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p>4.执行</p>

<p>当前工作空间下，启动终端，并输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch demo_stage_sim stage_sim.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>执行该launch文件后，将生成一个窗口，该窗口中并无任何内容，下一步我们就可以着手创建具体的仿真内容了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1619.webp" alt="" /></p>

<p>5.world文件参数</p>

<p><strong>摘要和默认值</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>name                      &lt;worldfile name&gt;
interval_sim              100
quit_time                 0
resolution                0.02
show_clock                0
show_clock_interval       100
threads                   0
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>详解</strong></p>

<ul>
  <li>
    <p>name <string></string></p>
  </li>
  <li>
    <p>用于世界的识别名称，例如在图形用户界面的标题栏中使用。</p>
  </li>
  <li>
    <p>interval_sim <float></float></p>
  </li>
  <li>
    <p>每次调用 World::Update() 时运行的模拟时间量。每个模型都有其自己可配置的更新间隔，可以大于或小于此值，但比此值更短的间隔在图形用户界面或 World 更新回调中是不可见的。您可能不需要改变默认值100毫秒：此值在客户端内部使用，如Player和WebSim。</p>
  </li>
  <li>
    <p>quit_time <float> 在模拟时间达到指定的秒数后停止模拟。在 libstage 中，World::Update() 返回 true。在带有图形用户界面的 Stage 中，模拟被暂停。在没有图形用户界面的 Stage 中，Stage 会退出。</float></p>
  </li>
  <li>
    <p>resolution <float> 底层位图模型的分辨率（以米为单位）。较大的值可以加快射线追踪速度，但会以碰撞检测和感知精度为代价。通常情况下，默认值是一个合理的选择。</float></p>
  </li>
  <li>
    <p>show_clock <int></int></p>
  </li>
  <li>
    <p>如果非零，每经过 $show_clock_interval 次更新就在标准输出上打印模拟时间。这对于观察非 GUI 模拟的进展非常有用。</p>
  </li>
  <li>
    <p>show_clock_interval <int></int></p>
  </li>
  <li>
    <p>设置在启用 $show_clock 的情况下，在标准输出上打印时间之间的更新次数。默认值是每经过 10 秒模拟时间打印一次。较小的值会稍微降低模拟速度。</p>
  </li>
  <li>
    <p>threads <int></int></p>
  </li>
  <li>
    <p>要生成的工作线程数。一些模型可以并行更新（例如激光器、测距仪），在这里运行 2 个或更多线程可能会使模拟运行更快，取决于可用的 CPU 内核数量和世界文件的情况。如果您有启用并行的高分辨率模型（例如带有数百或数千个样本的激光器或大量模型），则每个内核使用一个线程。</p>
  </li>
</ul>

<h3 id="stage_ros2设置窗体">stage_ros2设置窗体</h3>

<p>stage 窗体由菜单栏和模拟世界的视图组成。我们可以放大和缩小视图，并滚动视图以查看模拟世界的更多内容。模拟的机器人设备、障碍物等被渲染为彩色多边形。窗体中还可以实现各种传感器和执行器模型的数据和配置的可视化。菜单则具有用于控制呈现哪些数据和配置的选项。本节我们将介绍如何设置以及操作stage窗体。</p>

<p>1.设置窗体</p>

<p>设置窗体相关参数，可以在stage_sim.launch.py文件中添加如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
<span class="c"># 配置窗体参数</span>
window
<span class="o">(</span>
  size <span class="o">[</span> 700.000 700.000 <span class="o">]</span> <span class="c"># 窗体尺寸(以 像素 为单位)</span>
  scale 35  <span class="c"># 缩放比</span>
  center <span class="o">[</span> 0  0 <span class="o">]</span> <span class="c"># 地图相对于窗体的偏移量(以 米 为单位)</span>
  rotate <span class="o">[</span> 0  0 <span class="o">]</span> <span class="c"># 地图旋转角度</span>
  show_data 1     <span class="c"># 是否显示传感器数据 1=on 0=off</span>
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述代码创建了一个窗体对象，该窗体分辨率为700*700，使用了35倍缩放比，后续加载的地图相对于窗体无偏移无旋转且会以可视化的方式显示传感器数据。</p>

<p>2.编译执行</p>

<p>构建功能包并执行launch文件后，运行结果如下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1620.webp" alt="" /></p>

<p>3.窗体参数</p>

<p><strong>摘要和默认值</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>window
<span class="o">(</span>
  size <span class="o">[</span> 400 300 <span class="o">]</span>

  <span class="c"># camera options</span>
  center <span class="o">[</span> 0 0 <span class="o">]</span>
  rotate <span class="o">[</span> 0 0 <span class="o">]</span>
  scale 1.0

  <span class="c"># perspective camera options</span>
  pcam_loc <span class="o">[</span> 0 <span class="nt">-4</span> 2 <span class="o">]</span>
  pcam_angle <span class="o">[</span> 70 0 <span class="o">]</span>

  <span class="c"># GUI options</span>
  show_data 0
  show_flags 1
  show_blocks 1
  show_clock 1
  show_footprints 0
  show_grid 1
  show_trailarrows 0
  show_trailrise 0
  show_trailfast 0
  show_occupancy 0
  show_tree 0
  pcam_on 0
  screenshots 0
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>详解</strong></p>

<ul>
  <li>
    <p>speedup <int></int></p>
  </li>
  <li>
    <p>Stage 将尝试以实时的这个倍数运行。如果设置为 -1，Stage 将尽可能以最快速度运行，并且不会尝试跟踪实时时间。</p>
  </li>
  <li>
    <p>size [<width:int><height:int> \]</height:int></width:int></p>
  </li>
  <li>
    <p>窗口的大小（以像素为单位）。</p>
  </li>
  <li>
    <p>center [<x:float><y:float> \]</y:float></x:float></p>
  </li>
  <li>
    <p>窗口中心的位置，使用世界坐标表示（以米为单位）。</p>
  </li>
  <li>
    <p>rotate [<pitch:float><yaw:float> \]</yaw:float></pitch:float></p>
  </li>
  <li>
    <p>相对于垂直向上的角度，旋转角度（以度为单位）。</p>
  </li>
  <li>
    <p>scale<float></float></p>
  </li>
  <li>
    <p>世界坐标到像素坐标的比例（窗口缩放）。</p>
  </li>
  <li>
    <p>pcam_loc [<x:int><y:int><z:int> \]</z:int></y:int></x:int></p>
  </li>
  <li>
    <p>透视摄像机的位置（以米为单位）。</p>
  </li>
  <li>
    <p>pcam_angle [<pitch:float><yaw:float> \]</yaw:float></pitch:float></p>
  </li>
  <li>
    <p>透视摄像机的垂直和水平角度。</p>
  </li>
  <li>
    <p>pcam_on<int></int></p>
  </li>
  <li>
    <p>是否启用透视摄像机（0/1）。</p>
  </li>
</ul>

<p>4.操作窗体</p>

<p><strong>滚动视图</strong></p>

<p>在背景上左键单击并拖动以移动你对世界的视图。</p>

<p><strong>缩放视图</strong></p>

<p>滚动鼠标滚轮可放大或缩小鼠标光标处的位置。</p>

<p><strong>保存世界</strong></p>

<p>你可以保存当前世界中所有事物的位置，使用“文件/保存”菜单项。警告：保存的位置将覆盖当前的世界文件。在保存之前，先复制你的世界文件，以保留旧的位置。另外，可以使用“文件/另存为”菜单项将其保存到一个新的世界文件中。</p>

<p><strong>暂停和恢复时钟</strong></p>

<p>按下“p”键可以暂停或恢复模拟。按下“.”（句号）键可以运行一个模拟步骤。按住“.”键可以重复多次步进。步进会让模拟暂停，所以按下“p”键可以恢复运行。可以在世界文件中使用“paused”属性来设置初始的暂停/运行状态。</p>

<p><strong>选择模型</strong></p>

<p>可以通过点击左键来选择模型。通过按住Shift键并点击多个模型，也可以选择多个模型。选择的模型可以通过拖动来移动，或者通过按住右键并移动鼠标来旋转。点击世界中的空白位置可以清除选择。在清除选择后，最后选中的单个模型将被保存为影响特定模型的几个视图选项的目标。</p>

<p><strong>视图选项</strong></p>

<p>视图菜单提供了许多影响世界渲染方式的功能。在每个选项的右侧，通常有一个按键快捷键，可快速切换相关选项。</p>

<p>“Data”选项（快捷键’d’）可切换传感器数据可视化。滤波器数据选项（快捷键Shift+’d’）打开对话框，可启用或禁用特定传感器的可视化。对话框中的“Visualize All”选项可切换是否为所有模型启用传感器可视化，还是仅为当前选择的模型启用。</p>

<p>“Follow”选项可保持视图始终在最后选择的模型上。</p>

<p>“Perspective camera”选项可以从正交视图切换到透视视图。</p>

<p><strong>保存截图</strong></p>

<p>要保存世界的一系列截图，从视图菜单中选择“Save screenshots”选项以开始录制图像，然后再次从菜单中选择该选项以停止。</p>

<h3 id="stage_ros2基本模型">stage_ros2基本模型</h3>

<p>基本模型（model）模拟具有基本属性的对象；位置、大小、速度、颜色、对各种传感器的可见性等。基本模型还具有由线性列表组成的主体。在内部，基本模型被用作所有其他模型类型的基类。我们可以使用基本模型来模拟环境对象。在stage中，底盘模型、雷达模型、相机模型等都可以看作是基本模型的子类。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1621.webp" alt="" /></p>

<p>1.添加基本模型</p>

<p>在stage_sim.launch.py文件中添加如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>
<span class="c"># -----------------------------------------------------------------------------</span>

<span class="c"># 添加障碍物</span>
model<span class="o">(</span> pose <span class="o">[</span> <span class="nt">-2</span> <span class="nt">-4</span> 0 0 <span class="o">]</span> color <span class="s2">"green"</span><span class="o">)</span>

<span class="c"># define a block</span>
define my_block model
<span class="o">(</span>
  size <span class="o">[</span>1.0 1.0 1.0]
  gui_nose 0
  gui_grid 0
  gui_outline 0
<span class="o">)</span>

<span class="c"># throw in a block</span>
my_block<span class="o">(</span> pose <span class="o">[</span> 0 4 0 90 <span class="o">]</span> color <span class="s2">"red"</span> bitmap <span class="s2">"maps/ghost.png"</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述代码中，直接使用默认的基础model创建了一个绿色模型对象，并且还自定义了继承自model的my_block模型，然后创建了该模型对象。</p>

<p>2.编译执行</p>

<p>构建功能包并执行launch文件后，运行结果如下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1622.webp" alt="" /></p>

<p>3.窗体参数</p>

<p><strong>摘要和默认值</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>model <span class="o">(</span>
    pose <span class="o">[</span> 0.0 0.0 0.0 0.0 <span class="o">]</span>
    size <span class="o">[</span> 0.1 0.1 0.1 <span class="o">]</span>
    origin <span class="o">[</span> 0.0 0.0 0.0 0.0 <span class="o">]</span>
    velocity <span class="o">[</span> 0.0 0.0 0.0 0.0 <span class="o">]</span>
    color <span class="s2">"red"</span>
    color_rgba <span class="o">[</span> 0.0 0.0 0.0 1.0 <span class="o">]</span>
    bitmap <span class="s2">""</span>
    ctrl <span class="s2">""</span>

    <span class="c"># determine how the model appears in various sensors</span>
    fiducial_return 0
    fiducial_key 0
    obstacle_return 1
    ranger_return 1
    blob_return 1
    laser_return LaserVisible
    gripper_return 0
    gravity_return 0
    sticky_return 0

    <span class="c"># GUI properties</span>
    gui_nose 0
    gui_grid 0
    gui_outline 1
    gui_move 0 <span class="o">(</span>1 <span class="k">if </span>the model has no parents<span class="o">)</span><span class="p">;</span>
    boundary 0
    mass 10.0
    map_resolution 0.1
    say <span class="s2">""</span>
    alwayson 0
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>详解</strong></p>

<ul>
  <li>
    <p>pose [ x:<float> y:<float> z:<float> heading:<float> \] 指定模型在其父坐标系中的姿态。</float></float></float></float></p>
  </li>
  <li>
    <p>size [ x:<float> y:<float> z:<float> \] 指定模型在各个维度上的大小。</float></float></float></p>
  </li>
  <li>
    <p>origin [ x:<float> y:<float> z:<float> heading:<float> \] 指定对象中心的位置，相对于其姿态。</float></float></float></float></p>
  </li>
  <li>
    <p>velocity [ x:<float> y:<float> z:<float> heading:<float> omega:<float> \] 指定模型的初始速度。请注意，如果模型撞到障碍物，其速度将被设置为零。</float></float></float></float></float></p>
  </li>
  <li>
    <p>velocity_enable int (默认为0) 大多数模型忽略其速度状态。这样可以节省处理时间，因为大多数模型的速度永远不会被设置为非零值。一些子类（例如ModelPosition）会改变这个默认值，因为它们期望移动。用户可以在这里指定一个非零值来启用对该模型的速度控制。这与调用Model::VelocityEnable()的效果相同。</p>
  </li>
  <li>
    <p>color <string> 使用X11数据库（rgb.txt）中的颜色名称指定对象的颜色。</string></p>
  </li>
  <li>
    <p>bitmap filename:<string> 通过解释位图中的线条来绘制模型（支持bmp、jpeg、gif、png）。文件被打开并解析为一组线条。这些线条被缩放以适应模型当前大小所定义的矩形内。</string></p>
  </li>
  <li>
    <p>ctrl <string> 指定模型的控制器模块及其参数字符串。例如，字符串"foo bar bash"将加载libfoo.so，其Init()函数将以整个字符串作为参数进行调用（包括库名称）。控制器需要解析字符串（如果需要参数）。</string></p>
  </li>
  <li>
    <p>fiducial_return fiducial_id <int> 如果非零，则通过fiducialfinder传感器检测到此模型。该值用作基准标识符。</int></p>
  </li>
  <li>
    <p>fiducial_key <int> 仅当模型和fiducialfinder的fiducial\_key值匹配时，fiducial\_id模型才会被fiducialfinder检测到。这允许您在同一环境中拥有几种独立类型的基准标识，每种类型只显示在为其"调谐"的fiducialfinders中。</int></p>
  </li>
  <li>
    <p>obstacle_return <int> 如果为1，则此模型可以与具有此属性设置的其他模型发生碰撞。</int></p>
  </li>
  <li>
    <p>ranger_return <int> 如果为1，则该模型可以被ranger传感器检测到。</int></p>
  </li>
  <li>
    <p>blob_return <int> 如果为1，则该模型可以在blob\_finder中被检测到（取决于其颜色）。</int></p>
  </li>
  <li>
    <p>laser_return <int> 如果为0，则此模型不会被激光传感器检测到。如果为1，则该模型在激光传感器中显示为正常（0）反射。如果为2，则显示为高（1）反射。</int></p>
  </li>
  <li>
    <p>gripper_return <int> 如果为1，则该模型可以被夹爪夹取，并且可以通过与具有非零obstacle\_return的任何东西的碰撞来推动。</int></p>
  </li>
  <li>
    <p>gui_nose <int> 如果为1，则在模型上绘制显示其朝向的鼻子（正X轴）。</int></p>
  </li>
  <li>
    <p>gui_grid <int> 如果为1，则在模型上绘制比例网格。</int></p>
  </li>
  <li>
    <p>gui_outline <int> 如果为1，则在模型周围绘制边界框，指示其大小。</int></p>
  </li>
  <li>
    <p>gui_move <int> 如果为1，则模型可以在GUI窗口中通过鼠标移动。</int></p>
  </li>
</ul>

<h3 id="stage_ros2添加地图">stage_ros2添加地图</h3>

<p>本节我们将在仿真环境中，添加一张全局地图，请先准备一张作为全局地图的图片。</p>

<p>1.添加地图</p>

<p>在stage_sim.launch.py文件中添加如下内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>
<span class="c"># -----------------------------------------------------------------------------</span>

<span class="c"># 设置地图(定义模型)</span>
define floorplan model
<span class="o">(</span>
  color <span class="s2">"gray30"</span>  <span class="c"># 颜色</span>
  boundary 1  <span class="c"># 为地图设置边框</span>

  gui_nose 0
  gui_grid 0 

  gui_outline 0
  gripper_return 0
  fiducial_return 0
  laser_return 1
<span class="o">)</span>

<span class="c"># 加载地图</span>
floorplan
<span class="o">(</span> 
  name <span class="s2">"room"</span>
  size <span class="o">[</span>16.000 16.000 0.800]
  pose <span class="o">[</span>0 0 0 0]
  bitmap <span class="s2">"maps/room.jpg"</span>
  gui_move 0
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述代码自定义了floorplan模型，并根据此模型创建了一个加载了地图数据的floorplan对象。</p>

<p>2.编译执行</p>

<p>构建功能包并执行launch文件后，运行结果如下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1623.webp" alt="" /></p>

<h3 id="stage_ros2添加机器人">stage_ros2添加机器人</h3>

<p>本节将在仿真环境中添加一个由底盘、摄像头以及激光雷达组成的虚拟机器人。</p>

<p>1.代码框架搭建</p>

<p>在world目录下新建robot目录，robot目录中再创建car_base.inc、camera.inc、laser.inc以及mycar.inc等文件，各文件作用如下：</p>

<ul>
  <li>
    <p>car_base.inc：用于设置机器人底盘模块；</p>
  </li>
  <li>
    <p>camera.inc：用于设置机器人相机模块；</p>
  </li>
  <li>
    <p>laser.inc：用于设置机器人雷达模块；</p>
  </li>
  <li>
    <p>mycar.inc：用于组装机器人各模块。</p>
  </li>
</ul>

<p>除此之外，还会在sim.world中包含mycar.inc并调用其生成机器人的功能。</p>

<p>2.设置机器人底盘</p>

<p>stage中的position模型可以以差速、全向或阿克曼的方式模拟移动机器人底盘。在car_base.inc中输入如下代码：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre>
<span class="c"># 机器人底盘配置</span>
define car_base position 
<span class="o">(</span>
  color <span class="s2">"red"</span>                   <span class="c"># 车身颜色</span>
  drive <span class="s2">"diff"</span>                  <span class="c"># 车辆运动学模型                  </span>
  obstacle_return 1             
  ranger_return 1           
  blob_return 1                  
  fiducial_return 1             

  localization <span class="s2">"odom"</span>           <span class="c"># 定位方式</span>
  odom_error <span class="o">[</span> 0.05 0.05 0.0 0.1 <span class="o">]</span>  <span class="c"># 里程计误差</span>

  <span class="c"># localization_origin [0 0 0 0]   # 定位原点，默认为机器人的初始位置。</span>

  <span class="c"># [ xmin xmax ymin ymax zmin zmax amin amax ]        </span>
  velocity_bounds <span class="o">[</span><span class="nt">-1</span> 1 0 0 0 0 <span class="nt">-45</span>.0 45.0 <span class="o">]</span>         <span class="c"># 速度最值 </span>
  acceleration_bounds <span class="o">[</span><span class="nt">-0</span>.5 0.5 0 0 0 0 <span class="nt">-45</span> 45.0 <span class="o">]</span>   <span class="c"># 加速度最值</span>

  size <span class="o">[</span>0.44 0.38 0.22]  <span class="c"># 车体尺寸</span>
  origin <span class="o">[</span>0 0 0 0] <span class="c"># 旋转中心与车体中心的偏移量</span>
  mass 23.0 <span class="c"># 车体质量，单位kg</span>

  gui_nose 0 <span class="c"># 是否绘制方向指示标记</span>

  block<span class="o">(</span> 
    points 8
    point[0] <span class="o">[</span><span class="nt">-0</span>.2 0.18]
    point[1] <span class="o">[</span><span class="nt">-0</span>.2 <span class="nt">-0</span>.18]
    point[2] <span class="o">[</span><span class="nt">-0</span>.15 <span class="nt">-0</span>.27]
    point[3] <span class="o">[</span>0.12 <span class="nt">-0</span>.23]
    point[4] <span class="o">[</span>0.2 <span class="nt">-0</span>.12]
    point[5] <span class="o">[</span>0.2 0.12]
    point[6] <span class="o">[</span>0.12 0.23]
    point[7] <span class="o">[</span><span class="nt">-0</span>.15 0.27]
    z <span class="o">[</span>0 0.22]
  <span class="o">)</span>
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>position摘要和默认值</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>position<span class="o">(</span>
    drive <span class="s2">"diff"</span>
    localization <span class="s2">"gps"</span>
    localization_origin <span class="o">[</span>&lt;defaults to model<span class="s1">'s start pose&gt;]
    odom_error [0.03 0.03 0.00 0.05]
    velocity_enable 1
)
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>详解</strong></p>

<ul>
  <li>
    <p>drive “diff”, “omni” 或 “car” 选择差速转向模型、全向模式或类似汽车的阿克曼模式。</p>
  </li>
  <li>
    <p>localization “gps” 或 “odom” 如果选择 “gps”，位置模型将以完全准确的精度报告位置。如果选择 “odom”，将使用简单的里程计模型，并且位置数据会随时间与真实位置的差异而漂移。里程计模型由 odom_error 属性参数化。</p>
  </li>
  <li>
    <p>localization_origin [x y z theta] 您可以使用 localization_origin 参数来设置定位坐标系的原点。默认情况下，它将复制模型的初始姿态，因此机器人将报告相对于起始位置的位置。提示: 如果将 localization_origin 设置为 [0 0 0 0] 并且定位方式为 “gps”，模型将返回其真实的全局位置。这种设置是不现实的，但在希望抽象定位细节的研究中很有用。</p>
  </li>
  <li>
    <p>odom_error [x y z theta] 在选择 “odom” 定位方式时用到的里程计误差模型参数，每个值是计算里程计位置估计时积分 x、y 和 theta 速度的误差比例的最大值。对于每个轴，如果在此处指定的值为 E，则实际比例在启动时在 -E/2 到 +E/2 的范围内随机选择。请注意，由于舍入误差，将这些值设置为零并不能让定位完美无误 - 为了实现这一点，您需要选择 “gps” 定位方式。</p>
  </li>
</ul>

<p>3.设置摄像头</p>

<p>stage中的camera模型可以模拟深度相机。在camera.inc中输入如下代码：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>define my_camera camera
<span class="o">(</span>
    range <span class="o">[</span> 0.3 3.0 <span class="o">]</span> <span class="c"># 相机采样范围</span>
    resolution <span class="o">[</span> 160 90 <span class="o">]</span>  <span class="c">#相机分辨率 1280 × 720 / 8</span>
    fov <span class="o">[</span> 87 58 <span class="o">]</span> <span class="c"># 相机视场</span>
    pantilt <span class="o">[</span> 0 0 <span class="o">]</span> <span class="c"># 相机姿态</span>
    alwayson 1 <span class="c"># 是否一直处于启动状态</span>
    size <span class="o">[</span> 0.025 0.09 0.025 <span class="o">]</span> <span class="c"># 相机尺寸</span>
    color <span class="s2">"gray"</span> <span class="c"># 相机颜色</span>
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>camera摘要和默认值</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>camera<span class="o">(</span>
  resolution <span class="o">[</span> 32 32 <span class="o">]</span>
  range <span class="o">[</span> 0.2 8.0 <span class="o">]</span>
  fov <span class="o">[</span> 70.0 40.0 <span class="o">]</span>
  pantilt <span class="o">[</span> 0.0 0.0 <span class="o">]</span>
  size <span class="o">[</span> 0.1 0.07 0.05 <span class="o">]</span>
  color <span class="s2">"black"</span>
  watts 100.0 
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>详解</strong></p>

<ul>
  <li>
    <p>resolution [ width:<int> height:<int>\] 相机分辨率。</int></int></p>
  </li>
  <li>
    <p>range [ min:<float> max:<float> \] 相机报告的距离范围，以米为单位。距离小于`min`或大于`max`的物体将无法显示。`min`数字越小，深度精度越低 - 不要将此值设置得太接近 0。</float></float></p>
  </li>
  <li>
    <p>fov [ horizontal: <float> vertical: <float> \] 水平和垂直视野的角度，以度为单位。</float></float></p>
  </li>
  <li>
    <p>pantilt [ pan:<float> tilt:<float> \] 相机的朝向角度，以度为单位。左右位置称为 pan，上下位置称为 tilt。</float></float></p>
  </li>
</ul>

<p>4.设置激光雷达</p>

<p>stage中的ranger模型可以模拟激光雷达。在laser.inc中输入如下代码：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>define my_laser ranger
<span class="o">(</span>
  sensor<span class="o">(</span>

    range <span class="o">[</span> 0.0  15.0 <span class="o">]</span>     <span class="c"># 雷达数据采集区间</span>
    fov 360.0               <span class="c"># 视角</span>
    samples 720             <span class="c"># 采样数</span>
    color_rgba <span class="o">[</span> 0 0 1 0.15 <span class="o">]</span> <span class="c"># 可视化光束颜色以及透明度</span>
  <span class="o">)</span>
  model <span class="c"># 雷达外观</span>
  <span class="o">(</span>
    pose <span class="o">[</span> 0 0 0 0 <span class="o">]</span>        <span class="c"># 雷达位姿</span>
    size <span class="o">[</span> 0.07 0.07 0.05 <span class="o">]</span> <span class="c"># 雷达尺寸信息</span>
    color <span class="s2">"blue"</span>            <span class="c"># 雷达颜色</span>
  <span class="o">)</span>
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ranger摘要和默认值</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre> sensor<span class="o">(</span>
   samples 180
   range_max 8.0
   fov 360.0
   resolution 1
   size <span class="o">[</span> 0.15 0.15 0.2 <span class="o">]</span>
   color <span class="s2">"blue"</span>
 <span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>详解</strong></p>

<ul>
  <li>
    <p>samples <int> 每次扫描的激光样本数量。</int></p>
  </li>
  <li>
    <p>range_max <float> 激光扫描仪所报告的最大距离，以米为单位。扫描仪将不会检测超出此范围的物体。</float></p>
  </li>
  <li>
    <p>fov <float> 激光扫描仪的角度视野。</float></p>
  </li>
  <li>
    <p>resolution <int> 仅计算第 n 个激光样本的真实距离。缺失的样本将用线性插值填充。一般来说，使用较少的样本会更好，但某些（实现不好的）程序需要固定数量的样本数。设置此数字大于 1 可以减少所需的计算量，适用于固定大小的激光矢量。</int></p>
  </li>
</ul>

<p>5.组装机器人</p>

<p>在mycar.inc中实现机器人的组装：</p>

<pre><code class="language-SQL">
# 组装机器人各个模块
include "robot/car_base.inc"
include "robot/camera.inc"
include "robot/laser.inc"

define my_car car_base(
    my_camera(pose [0.15 0 0 0])
    my_laser()
)
</code></pre>

<p>my_car模型是在car_base模型之上，集成了my_camera和my_laser模型。</p>

<p>6.在仿真环境中生成机器人</p>

<p>在sim.world中添加如下代码生成一个机器人：</p>

<pre><code class="language-SQL">
# -----------------------------------------------------------------------------

# 生成机器人

# 文件包含
include "robot/mycar.inc"

my_car(
  name "robot_0"
  color "red"
  pose [ -3 -7 0 90 ] 
)
</code></pre>

<p>7.构建执行</p>

<p>构建功能包并执行launch文件后，运行结果如下。</p>

<p>启动rviz2可以查看仿真环境下传感器相关数据，启动键盘控制节点后，也可以控制机器人运动。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1624.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1625.webp" alt="" /></p>

<h3 id="stage_ros2添加多机器人">stage_ros2添加多机器人</h3>

<p>在stage_ros2中也可以很方便的生成多个机器人。</p>

<p>1.生成多个机器人</p>

<p>在sim.world中还可以继续创建my_car对象以生成新的机器人模型，添加代码如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>my_car<span class="o">(</span>
  name <span class="s2">"robot_1"</span>
  color <span class="s2">"yellow"</span>
  pose <span class="o">[</span> <span class="nt">-1</span> <span class="nt">-7</span> 0 90 <span class="o">]</span> 
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>2.构建执行</p>

<p>构建功能包并执行launch文件后，运行结果如下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1626.webp" alt="" /></p>

<p>在多机器人运行时，不同的机器人发布的话题会以各自对应的<code class="language-plaintext highlighter-rouge">name</code>值为命名空间，且不同机器人发布的坐标变换也会以<code class="language-plaintext highlighter-rouge">name</code>值为前缀。</p>

<h1 id="gezebo仿真平台">Gezebo仿真平台</h1>

<h2 id="简述">简述</h2>

<p>Gazebo目前主要分为两个版本，</p>

<p>一个是旧版Gazebo Classic，一个是新版Ignition Gazebo。</p>

<p>本文中称呼的Gazebo均代指Gazebo Classic，而Ignition Gazebo会加以区别。</p>

<p><strong>场景</strong></p>

<p>在ROS机器人开发中，实体机器人虽然具有直接性和真实性的优势，但也存在一些不足，比如：</p>

<blockquote>
  <ol>
    <li>
      <p>高昂的成本：研发一款自主移动机器人需要购买昂贵的硬件组件，如传感器、电机、控制器等，且这些硬件在研发初期可能需要频繁更换或升级，导致成本急剧上升。</p>
    </li>
    <li>
      <p>资源限制：由于资金和资源有限，可能无法同时拥有多台实体机器人进行测试。这会导致测试周期延长，研发进度受阻。</p>
    </li>
    <li>
      <p>环境的不确定性和复杂性：在真实环境中测试机器人时，可能会遇到各种不可预测的情况，如光线变化、地面不平整、电磁干扰等，这些因素都可能影响机器人的性能。</p>
    </li>
    <li>
      <p>安全风险：在测试过程中，如果机器人的控制算法或硬件出现故障，可能会导致机器人失控，对人员或环境造成损害。</p>
    </li>
  </ol>

</blockquote>

<p>在ROS机器人开发的领域里，仿真技术被广泛应用以弥补实体机器人测试中的不足。</p>

<p><strong>概念</strong></p>

<p><strong>机器人仿真</strong> 是一种利用计算机模型和仿真技术来模拟机器人在虚拟环境中的行为和性能的过程。它通过创建虚拟的机器人和环境模型，模拟机器人的感知、控制和运动能力，以及与环境和其他对象的交互。</p>

<p><strong>作用</strong></p>

<p>通过仿真测试，可以降低机器人研发成本和风险，提高机器人系统的性能和可靠性，并为实际机器人部署提供参考和指导。</p>

<p><strong>仿真优势:</strong></p>

<p>仿真在机器人系统研发过程中占有举足轻重的地位，在研发与测试中较之于实体机器人实现，仿真有如下几点的显著优势:</p>

<ol>
  <li>
    <p><strong>低成本:</strong> 当前机器人成本居高不下，动辄几十万，仿真可以大大降低成本，减小风险</p>
  </li>
  <li>
    <p><strong>高效:</strong> 搭建的环境更为多样且灵活，可以提高测试效率以及测试覆盖率</p>
  </li>
  <li>
    <p><strong>高安全性:</strong> 仿真环境下，无需考虑耗损问题</p>
  </li>
</ol>

<p>仿真技术为开发者构建了一个既高效又安全，且成本低廉的全方位测试和验证平台。</p>

<p><strong>仿真缺陷:</strong></p>

<p>机器人在仿真环境与实际环境下的表现差异较大，换言之，仿真并不能完全做到模拟真实的物理世界，存在一些”失真”的情况，原因:</p>

<ol>
  <li>
    <p>仿真器所使用的物理引擎目前还不能够完全精确模拟真实世界的物理情况</p>
  </li>
  <li>
    <p>仿真器构建的是关节驱动器（电机&amp;齿轮箱）、传感器与信号通信的绝对理想情况，目前不支持模拟实际硬件缺陷或者一些临界状态等情形</p>
  </li>
</ol>

<p>总之，仿真技术虽然重要，但并不能完全替代实体测试。实体测试可以验证仿真结果的准确性，并发现仿真中可能忽略的问题。</p>

<h2 id="gazebogazebo-classic">Gazebo(<a href="https://classic.gazebosim.org/">Gazebo Classic</a>)</h2>

<p>这个是老版Gazebo，仅在ROS1和ROS2 Humble上可用。（但是ROS2并不推荐使用老版Gazebo，更加建议使用新版Gazebo）</p>

<p>ROS2老版Gazebo仅在Humble版本上可用，在Jazzy及以后的版本已移除。</p>

<p><strong>（不想学老版Gazebo的，直接跳到下一节的Ignition Gazebo即可）</strong></p>

<p>这俩对咱们的区别不算太大，也就是一个教程多，一个教程少的区别，你直接学老版Gazebo也是一样用的。</p>

<p><strong>（初学者也可以只学教程多的Gazebo Classic,可以少走一些弯路）</strong></p>

<p>Gezebo官网：</p>

<p>https://gazebosim.org/home</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1627.webp" alt="" /></p>

<p>如果你想从老版的Gazebo迁移到新版的Gazebo，那么请看下方官方教程：</p>

<p>从Gazebo Classic迁移到ROS2 Humble的Ign Gazebo(Gazebo Fortress)：</p>

<p>https://gazebosim.org/docs/fortress/gazebo_classic_migration/</p>

<p>从Gazebo Classic迁移到ROS2 Jazzy的Gazebo Sim(Gazebo Harmonic)：</p>

<p>Jazzy之后的版本应该变化不会太大，也可以暂时参照下面这个教程（或者去官网找对应版本的教程）：</p>

<p>https://gazebosim.org/docs/harmonic/gazebo_classic_migration/</p>

<h3 id="gazebo-classic安装与运行">Gazebo Classic安装与运行</h3>

<p>ROS2只有humble有老版Gazebo</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-gazebo-ros ros-humble-gazebo-ros-pkgs
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装完成后，我们就可以通过下面的命令行来启动gazebo并加载ros2插件。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>gazebo <span class="nt">--verbose</span> <span class="nt">-s</span> libgazebo_ros_init.so <span class="nt">-s</span> libgazebo_ros_factory.so 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>看到下面这个日志和gazebo界面，没啥大问题就说明成功了。（一些警告是说Gazebo Classic已经弃用，鼓励使用新版Ingition Gazebo，忽略这些警告即可）</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="n">root</span><span class="o">@</span><span class="n">Dell</span><span class="o">-</span><span class="n">G15</span><span class="o">-</span><span class="mi">5511</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">tungchiahui</span><span class="o">/</span><span class="n">UserFolder</span><span class="o">/</span><span class="n">MySource</span><span class="o">/</span><span class="n">ROS_WS</span><span class="o">/</span><span class="n">ROS2_WS</span><span class="o">/</span><span class="mi">6</span><span class="p">.</span><span class="n">ws_simulations</span><span class="err">$</span> <span class="n">gazebo</span> <span class="c1">--verbose -s libgazebo_ros_init.so -s libgazebo_ros_factory.so </span>
<span class="n">Gazebo</span> <span class="n">multi</span><span class="o">-</span><span class="n">robot</span> <span class="n">simulator</span><span class="p">,</span> <span class="k">version</span> <span class="mi">11</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">2</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="k">C</span><span class="p">)</span> <span class="mi">2012</span> <span class="k">Open</span> <span class="k">Source</span> <span class="n">Robotics</span> <span class="n">Foundation</span><span class="p">.</span>
<span class="n">Released</span> <span class="k">under</span> <span class="n">the</span> <span class="n">Apache</span> <span class="mi">2</span> <span class="n">License</span><span class="p">.</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">gazebosim</span><span class="p">.</span><span class="n">org</span>

<span class="p">[</span><span class="n">Msg</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span><span class="p">.</span>
<span class="n">Gazebo</span> <span class="n">multi</span><span class="o">-</span><span class="n">robot</span> <span class="n">simulator</span><span class="p">,</span> <span class="k">version</span> <span class="mi">11</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">2</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="k">C</span><span class="p">)</span> <span class="mi">2012</span> <span class="k">Open</span> <span class="k">Source</span> <span class="n">Robotics</span> <span class="n">Foundation</span><span class="p">.</span>
<span class="n">Released</span> <span class="k">under</span> <span class="n">the</span> <span class="n">Apache</span> <span class="mi">2</span> <span class="n">License</span><span class="p">.</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">gazebosim</span><span class="p">.</span><span class="n">org</span>

<span class="p">[</span><span class="n">Wrn</span><span class="p">]</span> <span class="p">[</span><span class="n">gazebo_ros_init</span><span class="p">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">178</span><span class="p">]</span> 

<span class="o">#</span>     <span class="o">#</span> <span class="o">#######</span> <span class="o">#######</span> <span class="o">###</span>  <span class="o">#####</span>  <span class="o">#######</span>

<span class="o">##</span>    <span class="o">#</span> <span class="o">#</span>     <span class="o">#</span>    <span class="o">#</span>     <span class="o">#</span>  <span class="o">#</span>     <span class="o">#</span> <span class="o">#</span>

<span class="o">#</span> <span class="o">#</span>   <span class="o">#</span> <span class="o">#</span>     <span class="o">#</span>    <span class="o">#</span>     <span class="o">#</span>  <span class="o">#</span>       <span class="o">#</span>

<span class="o">#</span>  <span class="o">#</span>  <span class="o">#</span> <span class="o">#</span>     <span class="o">#</span>    <span class="o">#</span>     <span class="o">#</span>  <span class="o">#</span>       <span class="o">#####</span>

<span class="o">#</span>   <span class="o">#</span> <span class="o">#</span> <span class="o">#</span>     <span class="o">#</span>    <span class="o">#</span>     <span class="o">#</span>  <span class="o">#</span>       <span class="o">#</span>

<span class="o">#</span>    <span class="o">##</span> <span class="o">#</span>     <span class="o">#</span>    <span class="o">#</span>     <span class="o">#</span>  <span class="o">#</span>     <span class="o">#</span> <span class="o">#</span>

<span class="o">#</span>     <span class="o">#</span> <span class="o">#######</span>    <span class="o">#</span>    <span class="o">###</span>  <span class="o">#####</span>  <span class="o">#######</span>

<span class="n">This</span> <span class="k">version</span> <span class="k">of</span> <span class="n">Gazebo</span><span class="p">,</span> <span class="n">now</span> <span class="k">called</span> <span class="n">Gazebo</span> <span class="n">classic</span><span class="p">,</span> <span class="n">reaches</span> <span class="k">end</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">life</span>
<span class="k">in</span> <span class="n">January</span> <span class="mi">2025</span><span class="p">.</span> <span class="n">Users</span> <span class="k">are</span> <span class="n">highly</span> <span class="n">encouraged</span> <span class="k">to</span> <span class="n">migrate</span> <span class="k">to</span> <span class="n">the</span> <span class="k">new</span> <span class="n">Gazebo</span>
<span class="k">using</span> <span class="n">our</span> <span class="n">migration</span> <span class="n">guides</span> <span class="p">(</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">gazebosim</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">gazebo_classic_migration</span><span class="o">?</span><span class="n">utm_source</span><span class="o">=</span><span class="n">gazebo_ros_pkgs</span><span class="o">&amp;</span><span class="n">utm_medium</span><span class="o">=</span><span class="n">cli</span><span class="p">)</span>

<span class="p">[</span><span class="n">Msg</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span><span class="p">.</span>
<span class="p">[</span><span class="n">Msg</span><span class="p">]</span> <span class="n">Connected</span> <span class="k">to</span> <span class="n">gazebo</span> <span class="n">master</span> <span class="o">@</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">11345</span>
<span class="p">[</span><span class="n">Msg</span><span class="p">]</span> <span class="n">Publicized</span> <span class="n">address</span><span class="p">:</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">31</span><span class="p">.</span><span class="mi">60</span>
<span class="p">[</span><span class="n">Msg</span><span class="p">]</span> <span class="n">Loading</span> <span class="n">world</span> <span class="n">file</span> <span class="p">[</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">share</span><span class="o">/</span><span class="n">gazebo</span><span class="o">-</span><span class="mi">11</span><span class="o">/</span><span class="n">worlds</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">world</span><span class="p">]</span>
<span class="n">XDG_RUNTIME_DIR</span> <span class="p">(</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="k">user</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="n">owned</span> <span class="k">by</span> <span class="n">us</span> <span class="p">(</span><span class="n">uid</span> <span class="mi">0</span><span class="p">),</span> <span class="n">but</span> <span class="k">by</span> <span class="n">uid</span> <span class="mi">1000</span><span class="o">!</span> <span class="p">(</span><span class="n">This</span> <span class="n">could</span> <span class="n">e</span><span class="p">.</span><span class="k">g</span><span class="p">.</span> <span class="n">happen</span> <span class="n">if</span> <span class="n">you</span> <span class="n">try</span> <span class="k">to</span> <span class="k">connect</span> <span class="k">to</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">root</span> <span class="n">PulseAudio</span> <span class="k">as</span> <span class="n">a</span> <span class="n">root</span> <span class="k">user</span><span class="p">,</span> <span class="n">over</span> <span class="n">the</span> <span class="n">native</span> <span class="n">protocol</span><span class="p">.</span> <span class="n">Don</span><span class="s1">'t do that.)
ALSA lib pcm_dmix.c:1032:(snd_pcm_dmix_open) unable to open slave
AL lib: (EE) ALCplaybackAlsa_open: Could not open playback device '</span><span class="k">default</span><span class="s1">': No such file or directory
[Err] [OpenAL.cc:84] Unable to open audio device[default]
 Audio will be disabled.
[Msg] Connected to gazebo master @ http://127.0.0.1:11345
[Msg] Publicized address: 192.168.31.60
[Wrn] [GuiIface.cc:298] Couldn'</span><span class="n">t</span> <span class="n">locate</span> <span class="n">specified</span> <span class="p">.</span><span class="n">ini</span><span class="p">.</span> <span class="n">Creating</span> <span class="n">file</span> <span class="k">at</span> <span class="nv">"/root/.gazebo/gui.ini"</span>
<span class="p">[</span><span class="n">Wrn</span><span class="p">]</span> <span class="p">[</span><span class="n">GuiIface</span><span class="p">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">120</span><span class="p">]</span> <span class="n">QStandardPaths</span><span class="p">:</span> <span class="n">runtime</span> <span class="n">directory</span> <span class="s1">'/run/user/1000'</span> <span class="k">is</span> <span class="k">not</span> <span class="n">owned</span> <span class="k">by</span> <span class="n">UID</span> <span class="mi">0</span><span class="p">,</span> <span class="n">but</span> <span class="n">a</span> <span class="n">directory</span> <span class="n">permissions</span> <span class="mi">0700</span> <span class="n">owned</span> <span class="k">by</span> <span class="n">UID</span> <span class="mi">1000</span> <span class="n">GID</span> <span class="mi">1000</span>
<span class="p">[</span><span class="n">Wrn</span><span class="p">]</span> <span class="p">[</span><span class="n">Event</span><span class="p">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span> <span class="n">Warning</span><span class="p">:</span> <span class="n">Deleting</span> <span class="n">a</span> <span class="k">connection</span> <span class="k">right</span> <span class="k">after</span> <span class="n">creation</span><span class="p">.</span> <span class="n">Make</span> <span class="n">sure</span> <span class="k">to</span> <span class="n">save</span> <span class="n">the</span> <span class="n">ConnectionPtr</span> <span class="k">from</span> <span class="n">a</span> <span class="k">Connect</span> <span class="k">call</span>

<span class="n">libcurl</span><span class="p">:</span> <span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="n">error</span><span class="p">:</span><span class="mi">0</span><span class="n">A000126</span><span class="p">:</span><span class="n">SSL</span> <span class="n">routines</span><span class="p">::</span><span class="n">unexpected</span> <span class="n">eof</span> <span class="n">while</span> <span class="n">reading</span>
<span class="p">[</span><span class="n">Wrn</span><span class="p">]</span> <span class="p">[</span><span class="n">ModelDatabase</span><span class="p">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">212</span><span class="p">]</span> <span class="n">Unable</span> <span class="k">to</span> <span class="k">connect</span> <span class="k">to</span> <span class="n">model</span> <span class="k">database</span> <span class="k">using</span> <span class="p">[</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">models</span><span class="p">.</span><span class="n">gazebosim</span><span class="p">.</span><span class="n">org</span><span class="o">//</span><span class="k">database</span><span class="p">.</span><span class="n">config</span><span class="p">].</span> <span class="k">Only</span> <span class="n">locally</span> <span class="n">installed</span> <span class="n">models</span> <span class="n">will</span> <span class="n">be</span> <span class="n">available</span><span class="p">.</span>
<span class="p">[</span><span class="n">Wrn</span><span class="p">]</span> <span class="p">[</span><span class="n">Event</span><span class="p">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span> <span class="n">Warning</span><span class="p">:</span> <span class="n">Deleting</span> <span class="n">a</span> <span class="k">connection</span> <span class="k">right</span> <span class="k">after</span> <span class="n">creation</span><span class="p">.</span> <span class="n">Make</span> <span class="n">sure</span> <span class="k">to</span> <span class="n">save</span> <span class="n">the</span> <span class="n">ConnectionPtr</span> <span class="k">from</span> <span class="n">a</span> <span class="k">Connect</span> <span class="k">call</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1628.webp" alt="" /></p>

<h3 id="插件及节点服务介绍">插件及节点服务介绍</h3>

<p>使用之前的命令启动Gazebo并加载gazebo_ros插件，我们使用下面的指令来看插件的节点，以及改节点为我们提供的服务有哪些？</p>

<p>节点列表</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 node list
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1629.webp" alt="" /></p>

<p>然后我们看看这个节点对外提供的服务有哪些？</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 service list
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1630.webp" alt="" /></p>

<p>除去和参数相关的几个服务，我们可以看到另外三个特殊服务：</p>

<ul>
  <li>
    <p>/spawn_entity，用于加载模型到gazebo中</p>
  </li>
  <li>
    <p>/get_model_list，用于获取模型列表</p>
  </li>
  <li>
    <p>/delete_entity，用于删除gazbeo中已经加载的模型</p>
  </li>
</ul>

<p>我们想要让gazebo显示出我们配置好的机器人模型使用/spawn_entity来加载即可。</p>

<p>接着我们可以来请求服务来加载模型，先带你看一下服务的接口类型。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 service <span class="nb">type</span> /spawn_entity
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1631.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 interface show gazebo_msgs/srv/SpawnEntity
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1632.webp" alt="" /></p>

<p>可以看到服务的请求内容包括：</p>

<ul>
  <li>
    <p>string name ，需要加载的实体的名称 (可选的)。</p>
  </li>
  <li>
    <p>string xml ，实体的XML描述字符串, URDF或者SDF。</p>
  </li>
  <li>
    <p>string robot_namespace ，产生的机器人和所有的ROS接口的命名空间，多机器人仿真的时候很有用。</p>
  </li>
  <li>
    <p>geometry_msgs/Pose initial_pose ，机器人的初始化位置</p>
  </li>
  <li>
    <p>string reference_frame ，初始姿态是相对于该实体的frame定义的。如果保持”empty”或”world”或“map”，则使用 gazebo的world作为frame。如果指定了不存在的实体，则会返回错误</p>
  </li>
</ul>

<h3 id="调用服务加载模型">调用服务加载模型</h3>

<p>我们这里教程使用鱼香ROS的fishbot模型：https://github.com/fishros/fishbot/blob/navgation2/src/fishbot_description/urdf/fishbot_gazebo.urdf</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"fishbot"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_footprint"</span><span class="nt">/&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"base_joint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_footprint"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0.0 0.076"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0.0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
                <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.12"</span> <span class="na">radius=</span><span class="s">"0.10"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"blue"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.1 0.1 1.0 0.5"</span> <span class="nt">/&gt;</span> 
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0.0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
                <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.12"</span> <span class="na">radius=</span><span class="s">"0.10"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"blue"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.1 0.1 1.0 0.5"</span> <span class="nt">/&gt;</span> 
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"0.2"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"0.0122666"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span> <span class="na">iyy=</span><span class="s">"0.0122666"</span> <span class="na">iyz=</span><span class="s">"0"</span> <span class="na">izz=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"laser_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.02"</span> <span class="na">radius=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.02"</span> <span class="na">radius=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
      <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
      <span class="nt">&lt;/material&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
    <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"0.1"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"0.000190416666667"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span> <span class="na">iyy=</span><span class="s">"0.0001904"</span> <span class="na">iyz=</span><span class="s">"0"</span> <span class="na">izz=</span><span class="s">"0.00036"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"laser_joint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"laser_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0.075"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"imu_link"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;visual&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0.0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
                    <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.02 0.02 0.02"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
    <span class="nt">&lt;collision&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0.0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
                    <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">"0.02 0.02 0.02"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"0.1"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"0.000190416666667"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span> <span class="na">iyy=</span><span class="s">"0.0001904"</span> <span class="na">iyz=</span><span class="s">"0"</span> <span class="na">izz=</span><span class="s">"0.00036"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/inertial&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"imu_joint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"imu_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0.02"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"left_wheel_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;visual&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57079 0 0"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
          <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.04"</span> <span class="na">radius=</span><span class="s">"0.032"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
          <span class="nt">&lt;/material&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
      <span class="nt">&lt;collision&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57079 0 0"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
          <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.04"</span> <span class="na">radius=</span><span class="s">"0.032"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
          <span class="nt">&lt;/material&gt;</span>
      <span class="nt">&lt;/collision&gt;</span>
      <span class="nt">&lt;inertial&gt;</span>
        <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"0.2"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"0.000190416666667"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span> <span class="na">iyy=</span><span class="s">"0.0001904"</span> <span class="na">iyz=</span><span class="s">"0"</span> <span class="na">izz=</span><span class="s">"0.00036"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"right_wheel_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;visual&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57079 0 0"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
          <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.04"</span> <span class="na">radius=</span><span class="s">"0.032"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
          <span class="nt">&lt;/material&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
      <span class="nt">&lt;collision&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57079 0 0"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
          <span class="nt">&lt;cylinder</span> <span class="na">length=</span><span class="s">"0.04"</span> <span class="na">radius=</span><span class="s">"0.032"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
          <span class="nt">&lt;/material&gt;</span>
      <span class="nt">&lt;/collision&gt;</span>
      <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"0.2"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"0.000190416666667"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span> <span class="na">iyy=</span><span class="s">"0.0001904"</span> <span class="na">iyz=</span><span class="s">"0"</span> <span class="na">izz=</span><span class="s">"0.00036"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"left_wheel_joint"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"left_wheel_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"-0.02 0.10 -0.06"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"right_wheel_joint"</span> <span class="na">type=</span><span class="s">"continuous"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"right_wheel_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"-0.02 -0.10 -0.06"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"caster_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;visual&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57079 0 0"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;sphere</span> <span class="na">radius=</span><span class="s">"0.016"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
          <span class="nt">&lt;/material&gt;</span>
      <span class="nt">&lt;/visual&gt;</span>
      <span class="nt">&lt;collision&gt;</span>
        <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"1.57079 0 0"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;sphere</span> <span class="na">radius=</span><span class="s">"0.016"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material</span> <span class="na">name=</span><span class="s">"black"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;color</span> <span class="na">rgba=</span><span class="s">"0.0 0.0 0.0 0.5"</span> <span class="nt">/&gt;</span> 
          <span class="nt">&lt;/material&gt;</span>
      <span class="nt">&lt;/collision&gt;</span>
      <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"0.02"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"0.000190416666667"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span> <span class="na">iyy=</span><span class="s">"0.0001904"</span> <span class="na">iyz=</span><span class="s">"0"</span> <span class="na">izz=</span><span class="s">"0.00036"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"caster_joint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"caster_link"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.06 0.0 -0.076"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"caster_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;material&gt;</span>Gazebo/Black<span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"caster_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;mu1</span> <span class="na">value=</span><span class="s">"0.0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;mu2</span> <span class="na">value=</span><span class="s">"0.0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;kp</span> <span class="na">value=</span><span class="s">"1000000.0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;kd</span> <span class="na">value=</span><span class="s">"10.0"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;/gazebo&gt;</span>

  <span class="nt">&lt;gazebo&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'diff_drive'</span> <span class="na">filename=</span><span class="s">'libgazebo_ros_diff_drive.so'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;ros&gt;</span>
            <span class="nt">&lt;namespace&gt;</span>/<span class="nt">&lt;/namespace&gt;</span>
            <span class="nt">&lt;remapping&gt;</span>cmd_vel:=cmd_vel<span class="nt">&lt;/remapping&gt;</span>
            <span class="nt">&lt;remapping&gt;</span>odom:=odom<span class="nt">&lt;/remapping&gt;</span>
          <span class="nt">&lt;/ros&gt;</span>
          <span class="nt">&lt;update_rate&gt;</span>30<span class="nt">&lt;/update_rate&gt;</span>

          <span class="nt">&lt;left_joint&gt;</span>left_wheel_joint<span class="nt">&lt;/left_joint&gt;</span>
          <span class="nt">&lt;right_joint&gt;</span>right_wheel_joint<span class="nt">&lt;/right_joint&gt;</span>

          <span class="nt">&lt;wheel_separation&gt;</span>0.2<span class="nt">&lt;/wheel_separation&gt;</span>
          <span class="nt">&lt;wheel_diameter&gt;</span>0.065<span class="nt">&lt;/wheel_diameter&gt;</span>

          <span class="nt">&lt;max_wheel_torque&gt;</span>20<span class="nt">&lt;/max_wheel_torque&gt;</span>
          <span class="nt">&lt;max_wheel_acceleration&gt;</span>1.0<span class="nt">&lt;/max_wheel_acceleration&gt;</span>

          <span class="nt">&lt;publish_odom&gt;</span>true<span class="nt">&lt;/publish_odom&gt;</span>
          <span class="nt">&lt;publish_odom_tf&gt;</span>true<span class="nt">&lt;/publish_odom_tf&gt;</span>
          <span class="nt">&lt;publish_wheel_tf&gt;</span>false<span class="nt">&lt;/publish_wheel_tf&gt;</span>
          <span class="nt">&lt;odometry_frame&gt;</span>odom<span class="nt">&lt;/odometry_frame&gt;</span>
          <span class="nt">&lt;robot_base_frame&gt;</span>base_footprint<span class="nt">&lt;/robot_base_frame&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>

      <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">"fishbot_joint_state"</span> <span class="na">filename=</span><span class="s">"libgazebo_ros_joint_state_publisher.so"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ros&gt;</span>
          <span class="nt">&lt;remapping&gt;</span>~/out:=joint_states<span class="nt">&lt;/remapping&gt;</span>
        <span class="nt">&lt;/ros&gt;</span>
        <span class="nt">&lt;update_rate&gt;</span>30<span class="nt">&lt;/update_rate&gt;</span>
        <span class="nt">&lt;joint_name&gt;</span>right_wheel_joint<span class="nt">&lt;/joint_name&gt;</span>
        <span class="nt">&lt;joint_name&gt;</span>left_wheel_joint<span class="nt">&lt;/joint_name&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>    
      <span class="nt">&lt;/gazebo&gt;</span> 

      <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"laser_link"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;material&gt;</span>Gazebo/Black<span class="nt">&lt;/material&gt;</span>
      <span class="nt">&lt;/gazebo&gt;</span>

    <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"imu_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"imu_sensor"</span> <span class="na">type=</span><span class="s">"imu"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;plugin</span> <span class="na">filename=</span><span class="s">"libgazebo_ros_imu_sensor.so"</span> <span class="na">name=</span><span class="s">"imu_plugin"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;ros&gt;</span>
            <span class="nt">&lt;namespace&gt;</span>/<span class="nt">&lt;/namespace&gt;</span>
            <span class="nt">&lt;remapping&gt;</span>~/out:=imu<span class="nt">&lt;/remapping&gt;</span>
          <span class="nt">&lt;/ros&gt;</span>
          <span class="nt">&lt;initial_orientation_as_reference&gt;</span>false<span class="nt">&lt;/initial_orientation_as_reference&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;always_on&gt;</span>true<span class="nt">&lt;/always_on&gt;</span>
        <span class="nt">&lt;update_rate&gt;</span>100<span class="nt">&lt;/update_rate&gt;</span>
        <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
        <span class="nt">&lt;imu&gt;</span>
          <span class="nt">&lt;angular_velocity&gt;</span>
            <span class="nt">&lt;x&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>2e-4<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.0000075<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.0000008<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/x&gt;</span>
            <span class="nt">&lt;y&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>2e-4<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.0000075<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.0000008<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/y&gt;</span>
            <span class="nt">&lt;z&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>2e-4<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.0000075<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.0000008<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/z&gt;</span>
          <span class="nt">&lt;/angular_velocity&gt;</span>
          <span class="nt">&lt;linear_acceleration&gt;</span>
            <span class="nt">&lt;x&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>1.7e-2<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.1<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.001<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/x&gt;</span>
            <span class="nt">&lt;y&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>1.7e-2<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.1<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.001<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/y&gt;</span>
            <span class="nt">&lt;z&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>1.7e-2<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.1<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.001<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/z&gt;</span>
          <span class="nt">&lt;/linear_acceleration&gt;</span>
        <span class="nt">&lt;/imu&gt;</span>
      <span class="nt">&lt;/sensor&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span>

    <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"laser_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"laser_sensor"</span> <span class="na">type=</span><span class="s">"ray"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>true<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>5<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 0.075 0 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;ray&gt;</span>
          <span class="nt">&lt;scan&gt;</span>
            <span class="nt">&lt;horizontal&gt;</span>
              <span class="nt">&lt;samples&gt;</span>360<span class="nt">&lt;/samples&gt;</span>
              <span class="nt">&lt;resolution&gt;</span>1.000000<span class="nt">&lt;/resolution&gt;</span>
              <span class="nt">&lt;min_angle&gt;</span>0.000000<span class="nt">&lt;/min_angle&gt;</span>
              <span class="nt">&lt;max_angle&gt;</span>6.280000<span class="nt">&lt;/max_angle&gt;</span>
            <span class="nt">&lt;/horizontal&gt;</span>
          <span class="nt">&lt;/scan&gt;</span>
          <span class="nt">&lt;range&gt;</span>
            <span class="nt">&lt;min&gt;</span>0.120000<span class="nt">&lt;/min&gt;</span>
            <span class="nt">&lt;max&gt;</span>3.5<span class="nt">&lt;/max&gt;</span>
            <span class="nt">&lt;resolution&gt;</span>0.015000<span class="nt">&lt;/resolution&gt;</span>
          <span class="nt">&lt;/range&gt;</span>
          <span class="nt">&lt;noise&gt;</span>
            <span class="nt">&lt;type&gt;</span>gaussian<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
            <span class="nt">&lt;stddev&gt;</span>0.01<span class="nt">&lt;/stddev&gt;</span>
          <span class="nt">&lt;/noise&gt;</span>
      <span class="nt">&lt;/ray&gt;</span>

      <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">"laserscan"</span> <span class="na">filename=</span><span class="s">"libgazebo_ros_ray_sensor.so"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ros&gt;</span>

          <span class="nt">&lt;remapping&gt;</span>~/out:=scan<span class="nt">&lt;/remapping&gt;</span>
        <span class="nt">&lt;/ros&gt;</span>
        <span class="nt">&lt;output_type&gt;</span>sensor_msgs/LaserScan<span class="nt">&lt;/output_type&gt;</span>
        <span class="nt">&lt;frame_name&gt;</span>laser_link<span class="nt">&lt;/frame_name&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;/sensor&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span>

<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>看到这里你是不是迫不及待敲起来命令行来加载我们的机器人到gazebo了，别着急，小鱼再推荐一个可视化服务请求工具，其实在第六章中小鱼介绍过，在rqt工具集里有一个叫服务请求工具。</p>

<p>命令行输入rqt，在插件选项中选择Services-&gt;Service Caller,然后再下拉框选择/spawn_entity服务，即可看到下面的界面。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1633.webp" alt="" /></p>

<p>接着我们把我们的FishBot的URDF模型复制粘贴，放到xml中（注意要把原来的’‘删掉哦！）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1634.webp" alt="" /></p>

<p>然后点右上角的call，可以显示下图成功了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1635.webp" alt="" /></p>

<p>接着就可以看到工厂返回说成功把机器人制作出来送入gazebo了。</p>

<p>此时再看我们的Gazebo,一个小小的，白白的机器人出现了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1636.webp" alt="" /></p>

<p>shift+鼠标左键，或者直接点滚轮中键，都可以拖动视角。很多玩过第三人称游戏的学弟学妹肯定都不陌生这种操控吧。</p>

<h3 id="在不同位置加载多个机器人">在不同位置加载多个机器人</h3>

<p>可以再生产一个fishbot（为了后面需要多机器人仿真的小伙伴）。</p>

<p>修改rqt中的参数，增加一个命名空间，然后修改一个位置，让第二个机器人和第一个相距1m的地方生产，然后点击Call。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1637.webp" alt="" /></p>

<p>返回成功，此时拖送Gazebo观察一下，发现多出了一个机器人，距离刚好是在X轴（红色）1米（一个小格子一米）处。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1638.webp" alt="" /></p>

<h3 id="查询和删除机器人">查询和删除机器人</h3>

<p>利用rqt工具，我们再对另外两个服务接口进行请求。</p>

<p>首先先查询有几个模型在仿真环境中</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1639.webp" alt="" /></p>

<p>查到了三个模型，一个大地，一个fishbot，一个fishbot_0。</p>

<p>我们接着尝试把fishbot_0删掉，选择删除实体，输入fishbot_0的名字，拿起小电话通知工厂回收我们的0号fishbot。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1640.webp" alt="" /></p>

<p>调用成功，观察gazebo发现机器人，人没了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1641.webp" alt="" /></p>

<h3 id="创建工作空间">创建工作空间</h3>

<p>本节代码参考鱼香ROS：https://github.com/fishros/fishbot/tree/navgation2</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 创建工作空间</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> ws_simulations/src
<span class="nb">cd </span>ws_simulations/src
</pre></td></tr></tbody></table></code></pre></div></div>

<p>创建功能包</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>ros2 pkg create fishbot_description <span class="nt">--build-type</span> ament_cmake
<span class="nb">cd </span>fishbot_description
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后配置package.xml</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;exec_depend&gt;</span>rviz2<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>xacro<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>robot_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>joint_state_publisher<span class="nt">&lt;/exec_depend&gt;</span>
  <span class="nt">&lt;exec_depend&gt;</span>ros2launch<span class="nt">&lt;/exec_depend&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1642.webp" alt="" /></p>

<p>然后修改cmakelists.txt</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="o">(</span>
  DIRECTORY launch urdf rviz meshes
  DESTINATION share/<span class="k">${</span><span class="nv">PROJECT_NAME</span><span class="k">}</span>  
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1643.webp" alt="" /></p>

<p>克隆下鱼香ROS的仓库，并复制下里面的文件到咱们的目录下。这都是上一节的东西，与本节学习无关，直接复制就行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1644.webp" alt="" /></p>

<p>打开工作空间，在<code class="language-plaintext highlighter-rouge">src/fishbot_description/launch</code>中添加一个<code class="language-plaintext highlighter-rouge">gazebo.launch.py</code>文件，我们开始编写launch文件来在gazebo中加载机器人模型。</p>

<p>我们主要需要做两件事：</p>

<ol>
  <li>启动gazebo，我们可以将命令行写成一个launch节点</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">gazebo</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--verbose</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_init.so</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_factory.so</span><span class="sh">'</span><span class="p">,</span> <span class="n">gazebo_world_path</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>上面我们加载机器人是直接将XML格式的URDF复制过去进行加载的，这样很不方便，我们可以使用gazebo_ros为我们提供好的一个叫做<code class="language-plaintext highlighter-rouge">spawn_entity.py</code>节点，该节点支持从文件地址直接生产机器人到Gazebo。</li>
</ol>

<p>该节点需要两个参数，一个机器人的模型名字和urdf的文件地址，这个简单，前面我们曾经使用package_share来拼接过urdf路径。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">spawn_entity_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">gazebo_ros</span><span class="sh">'</span><span class="p">,</span> 
    <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">spawn_entity.py</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-entity</span><span class="sh">'</span><span class="p">,</span> <span class="n">robot_name_in_model</span><span class="p">,</span>  <span class="sh">'</span><span class="s">-file</span><span class="sh">'</span><span class="p">,</span> <span class="n">urdf_model_path</span> <span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>先加载赵虚左老师的模板</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1645.webp" alt="" /></p>

<p>我们首先需要ExecuteProcess来输入终端命令，所以要先把from launch.actions import ExecuteProcess的注释先打开。</p>

<p>为了方便修改加载的机器人模型和urdf,我们还需要使用share目录，所以也要把from ament_index_python.packages import get_package_share_directory的注释打开，并import os。</p>

<p>写完后的launch文件如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>

<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span>
<span class="c1"># from launch.actions import DeclareLaunchArgument
</span>
<span class="c1"># from launch.substitutions import LaunchConfiguration
</span>
<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">robot_name_in_model</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot</span><span class="sh">'</span>
    <span class="n">package_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot_description</span><span class="sh">'</span>
    <span class="n">urdf_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fishbot_gazebo.urdf</span><span class="sh">"</span>

    <span class="n">pkg_share</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">urdf_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">urdf/urdf/</span><span class="si">{</span><span class="n">urdf_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Gazebo server
</span>    <span class="n">start_gazebo_cmd</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">gazebo</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--verbose</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_init.so</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_factory.so</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Launch the robot
</span>    <span class="n">spawn_entity_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">gazebo_ros</span><span class="sh">'</span><span class="p">,</span> 
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">spawn_entity.py</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-entity</span><span class="sh">'</span><span class="p">,</span> <span class="n">robot_name_in_model</span><span class="p">,</span>  <span class="sh">'</span><span class="s">-file</span><span class="sh">'</span><span class="p">,</span> <span class="n">urdf_model_path</span> <span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">start_gazebo_cmd</span><span class="p">,</span><span class="n">spawn_entity_cmd</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>编译运行</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">colcon</span> <span class="n">build</span> <span class="o">--</span><span class="n">packages</span><span class="o">-</span><span class="n">select</span> <span class="n">fishbot_description</span>
<span class="n">source</span> <span class="n">install</span><span class="o">/</span><span class="n">setup</span><span class="p">.</span><span class="n">bash</span>
<span class="n">ros2</span> <span class="n">launch</span> <span class="n">fishbot_description</span> <span class="n">gazebo</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">py</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1646.webp" alt="" /></p>

<h3 id="插件">插件</h3>

<p>使用下面的指令可以查看所有的动态链接库：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ls</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ros</span><span class="o">/</span><span class="n">humble</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgazebo_ros</span><span class="o">*</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1647.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>/opt/ros/humble/lib/libgazebo_ros2_control.so
/opt/ros/humble/lib/libgazebo_ros_ackermann_drive.so
/opt/ros/humble/lib/libgazebo_ros_bumper.so
/opt/ros/humble/lib/libgazebo_ros_camera.so
/opt/ros/humble/lib/libgazebo_ros_diff_drive.so
/opt/ros/humble/lib/libgazebo_ros_elevator.so
/opt/ros/humble/lib/libgazebo_ros_factory.so
/opt/ros/humble/lib/libgazebo_ros_force.so
/opt/ros/humble/lib/libgazebo_ros_force_system.so
/opt/ros/humble/lib/libgazebo_ros_ft_sensor.so
/opt/ros/humble/lib/libgazebo_ros_gps_sensor.so
/opt/ros/humble/lib/libgazebo_ros_hand_of_god.so
/opt/ros/humble/lib/libgazebo_ros_harness.so
/opt/ros/humble/lib/libgazebo_ros_imu_sensor.so
/opt/ros/humble/lib/libgazebo_ros_init.so
/opt/ros/humble/lib/libgazebo_ros_joint_pose_trajectory.so
/opt/ros/humble/lib/libgazebo_ros_joint_state_publisher.so
/opt/ros/humble/lib/libgazebo_ros_node.so
/opt/ros/humble/lib/libgazebo_ros_p3d.so
/opt/ros/humble/lib/libgazebo_ros_planar_move.so
/opt/ros/humble/lib/libgazebo_ros_projector.so
/opt/ros/humble/lib/libgazebo_ros_properties.so
/opt/ros/humble/lib/libgazebo_ros_ray_sensor.so
/opt/ros/humble/lib/libgazebo_ros_state.so
/opt/ros/humble/lib/libgazebo_ros_template.so
/opt/ros/humble/lib/libgazebo_ros_tricycle_drive.so
/opt/ros/humble/lib/libgazebo_ros_utils.so
/opt/ros/humble/lib/libgazebo_ros_vacuum_gripper.so
/opt/ros/humble/lib/libgazebo_ros_video.so
/opt/ros/humble/lib/libgazebo_ros_wheel_slip.so
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="运动控制插件里程计odom">运动控制插件+里程计odom</h4>

<p>本节课通过配置两轮差速控制插件，让我们的机器人动起来</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1648.webp" alt="" /></p>

<p>插件介绍：</p>

<p>Gazebo是一个独立于ROS的软件，对外提供了丰富的API可以使用，gazebo的插件按照用途大致可以分为两种：</p>

<ol>
  <li>
    <p>用于控制的插件，通过插件可以控制机器人关节运动，可以进行位置、速度、力的控制，比如我们这节课的两轮差速控制器。</p>
  </li>
  <li>
    <p>用于数据采集的插件，比如IMU传感器用于采集机器人的惯性，激光雷达用于采集机器人周围的点云信息。</p>
  </li>
</ol>

<p>当然上面两类插件功能也可以写到一个插件里，两轮差速插件（gazebo_ros_diff_drive）就是一个二合一加强版。（差速控制+odom）</p>

<p>两轮差速插件用于控制机器人轮子关节的位置变化，同时该插件还会获取轮子的位置以及速度的信息的反馈，根据反馈的位置信息结合运动学模型即可计算出当前机器人的位姿（里程计）。</p>

<p>两轮差速控制器可以将轮子的目标转速发送给Gazebo，并从Gazebo获取到实际的速度和位置。（注意：发送给Gazebo是目标速度，反馈回来的是实际速度。目标!=实际，比如轮子卡住了，无论你发什么目标速度，实际速度都是0。）</p>

<p>要想快速了解一个系统的功能，最直接的就是看系统的对外的输入和输出是什么？什么都不要说，看下图：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1649.webp" alt="" /></p>

<p>上图就是对gazebo_ros_diff_drive的输入和输出信息的总结，可以很直观的看到该插件主要输入控制指令，主要输出里程计信息。接着小鱼带你分别认识一下输入和输出两个部分。</p>

<p>这个插件需要配置一系列参数如下图：</p>

<p>不知道你是否还记得在第七章中，小鱼对两轮差速底盘的运动学正的介绍。如果要完成底盘的正逆解和里程计的推算就必须要知道轮子的直径和间距。</p>

<p>同时该插件还提供了一些可以控制输出的选项，因为是仿真，所以还要告诉插件轮子对应的joint名称等信息，这样就有了下面这个参数表格：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">配置项</th>
      <th style="text-align: left">含义</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ros</td>
      <td style="text-align: left">ros相关配置，包含命名空间和话题重映射等</td>
    </tr>
    <tr>
      <td style="text-align: left">update_rate</td>
      <td style="text-align: left">数据更新速率</td>
    </tr>
    <tr>
      <td style="text-align: left">left_joint</td>
      <td style="text-align: left">左轮关节名称</td>
    </tr>
    <tr>
      <td style="text-align: left">right_joint</td>
      <td style="text-align: left">右轮关节名称</td>
    </tr>
    <tr>
      <td style="text-align: left">wheel_separation</td>
      <td style="text-align: left">左右轮子的间距</td>
    </tr>
    <tr>
      <td style="text-align: left">wheel_diameter</td>
      <td style="text-align: left">轮子的直径</td>
    </tr>
    <tr>
      <td style="text-align: left">max_wheel_torque</td>
      <td style="text-align: left">轮子最大的力矩</td>
    </tr>
    <tr>
      <td style="text-align: left">max_wheel_acceleration</td>
      <td style="text-align: left">轮子最大的加速度</td>
    </tr>
    <tr>
      <td style="text-align: left">publish_odom</td>
      <td style="text-align: left">是否发布里程计</td>
    </tr>
    <tr>
      <td style="text-align: left">publish_odom_tf</td>
      <td style="text-align: left">是否发布里程计的tf开关</td>
    </tr>
    <tr>
      <td style="text-align: left">publish_wheel_tf</td>
      <td style="text-align: left">是否发布轮子的tf数据开关</td>
    </tr>
    <tr>
      <td style="text-align: left">odometry_frame</td>
      <td style="text-align: left">里程计的framed ID，最终体现在话题和TF上</td>
    </tr>
    <tr>
      <td style="text-align: left">robot_base_frame</td>
      <td style="text-align: left">机器人的基础frame的ID</td>
    </tr>
  </tbody>
</table>

<p>控制指令：两轮差速控制器默认通过订阅话题<code class="language-plaintext highlighter-rouge">cmd_vel</code>来获取目标线速度和角速度。该话题的类型为：<code class="language-plaintext highlighter-rouge">geometry_msgs/msg/Twist</code></p>

<p>该接口里主要是一些线速度和角速度都包含在x、y、z，代表坐标系的三个方向上的对应速度。 <strong>（详细的接口内容请看硬件平台章节）</strong></p>

<p>两轮差速控制器收到这个话题数据后将其中的角速度和线速度转换上两个轮子的转动速度发送给Gazebo。</p>

<p>输出的信息：</p>

<p>里程计信息默认的输出话题为<code class="language-plaintext highlighter-rouge">odom</code>，其消息类型为：<code class="language-plaintext highlighter-rouge">nav_msgs/msg/Odometry</code></p>

<p>其数据主要包含三个部分： <strong>（详细的接口内容请看硬件平台章节）</strong></p>

<ul>
  <li>
    <p>header，表示该消息发布的时间</p>
  </li>
  <li>
    <p>pose，表示当前机器人位置和朝向</p>
  </li>
  <li>
    <p>twist，表示当前机器人的线速度和角速度</p>
  </li>
  <li>
    <p>数据中还包含一个covariance，其代表协方差矩阵，后面小鱼写篇文章来介绍下，这里只需了解其含义即可。</p>
  </li>
</ul>

<p>里程计TF信息也可以输出：设为true，订阅tf话题里你就可以看到像下面的msg，建议后面配置好后，手动修改下，对比区别</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">header</span><span class="pi">:</span>
    <span class="na">stamp</span><span class="pi">:</span>
      <span class="na">sec</span><span class="pi">:</span> <span class="m">6157</span>
      <span class="na">nanosec</span><span class="pi">:</span> <span class="m">907000000</span>
    <span class="na">frame_id</span><span class="pi">:</span> <span class="s">odom</span>
  <span class="na">child_frame_id</span><span class="pi">:</span> <span class="s">base_footprint</span>
  <span class="na">transform</span><span class="pi">:</span>
    <span class="na">translation</span><span class="pi">:</span>
      <span class="na">x</span><span class="pi">:</span> <span class="m">0.0005557960241049835</span>
      <span class="na">y</span><span class="pi">:</span> <span class="s">-0.0007350446303238693</span>
      <span class="na">z</span><span class="pi">:</span> <span class="m">0.01599968753145574</span>
    <span class="na">rotation</span><span class="pi">:</span>
      <span class="na">x</span><span class="pi">:</span> <span class="s">4.691143395208505e-07</span>
      <span class="na">y</span><span class="pi">:</span> <span class="s">7.115496626557812e-06</span>
      <span class="na">z</span><span class="pi">:</span> <span class="s">-0.018531475772549166</span>
      <span class="na">w</span><span class="pi">:</span> <span class="m">0.9998282774331005</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>轮子TF信息也可以输出：设为true，订阅tf话题里你就可以看到像下面的msg，建议后面配置好后，手动修改下，对比区别</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">header</span><span class="pi">:</span>
    <span class="na">stamp</span><span class="pi">:</span>
      <span class="na">sec</span><span class="pi">:</span> <span class="m">6157</span>
      <span class="na">nanosec</span><span class="pi">:</span> <span class="m">941000000</span>
    <span class="na">frame_id</span><span class="pi">:</span> <span class="s">base_link</span>
  <span class="na">child_frame_id</span><span class="pi">:</span> <span class="s">left_wheel_link</span>
  <span class="na">transform</span><span class="pi">:</span>
    <span class="na">translation</span><span class="pi">:</span>
      <span class="na">x</span><span class="pi">:</span> <span class="s">-0.02</span>
      <span class="na">y</span><span class="pi">:</span> <span class="m">0.1</span>
      <span class="na">z</span><span class="pi">:</span> <span class="s">-0.06</span>
    <span class="na">rotation</span><span class="pi">:</span>
      <span class="na">x</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">y</span><span class="pi">:</span> <span class="m">0.049519025127821005</span>
      <span class="na">z</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">w</span><span class="pi">:</span> <span class="m">0.9987731805321918</span>
<span class="pi">-</span> <span class="na">header</span><span class="pi">:</span>
    <span class="na">stamp</span><span class="pi">:</span>
      <span class="na">sec</span><span class="pi">:</span> <span class="m">6157</span>
      <span class="na">nanosec</span><span class="pi">:</span> <span class="m">941000000</span>
    <span class="na">frame_id</span><span class="pi">:</span> <span class="s">base_link</span>
  <span class="na">child_frame_id</span><span class="pi">:</span> <span class="s">right_wheel_link</span>
  <span class="na">transform</span><span class="pi">:</span>
    <span class="na">translation</span><span class="pi">:</span>
      <span class="na">x</span><span class="pi">:</span> <span class="s">-0.02</span>
      <span class="na">y</span><span class="pi">:</span> <span class="s">-0.1</span>
      <span class="na">z</span><span class="pi">:</span> <span class="s">-0.06</span>
    <span class="na">rotation</span><span class="pi">:</span>
      <span class="na">x</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">y</span><span class="pi">:</span> <span class="s">-0.0663387077034509</span>
      <span class="na">z</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">w</span><span class="pi">:</span> <span class="m">0.9977971616817898</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>咱们之前下载的那个鱼香ROS的fishbot的urdf已经包含了差速插件的内容，如下：</p>

<p>因为是给Gazebo的插件，所以在<code class="language-plaintext highlighter-rouge">URDF</code>中，我们需要使用<code class="language-plaintext highlighter-rouge">&lt;gazebo&gt;</code>进行配置，因为是要给<code class="language-plaintext highlighter-rouge">gazebo</code>配置插件，所有要在<code class="language-plaintext highlighter-rouge">gazebo</code>标签下添加<code class="language-plaintext highlighter-rouge">plugin</code>子插件。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;gazebo&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'diff_drive'</span> <span class="na">filename=</span><span class="s">'libgazebo_ros_diff_drive.so'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;ros&gt;</span>
            <span class="nt">&lt;namespace&gt;</span>/<span class="nt">&lt;/namespace&gt;</span>
            <span class="nt">&lt;remapping&gt;</span>cmd_vel:=cmd_vel<span class="nt">&lt;/remapping&gt;</span>
            <span class="nt">&lt;remapping&gt;</span>odom:=odom<span class="nt">&lt;/remapping&gt;</span>
          <span class="nt">&lt;/ros&gt;</span>
          <span class="nt">&lt;update_rate&gt;</span>30<span class="nt">&lt;/update_rate&gt;</span>

          <span class="nt">&lt;left_joint&gt;</span>left_wheel_joint<span class="nt">&lt;/left_joint&gt;</span>
          <span class="nt">&lt;right_joint&gt;</span>right_wheel_joint<span class="nt">&lt;/right_joint&gt;</span>

          <span class="nt">&lt;wheel_separation&gt;</span>0.2<span class="nt">&lt;/wheel_separation&gt;</span>
          <span class="nt">&lt;wheel_diameter&gt;</span>0.065<span class="nt">&lt;/wheel_diameter&gt;</span>

          <span class="nt">&lt;max_wheel_torque&gt;</span>20<span class="nt">&lt;/max_wheel_torque&gt;</span>
          <span class="nt">&lt;max_wheel_acceleration&gt;</span>1.0<span class="nt">&lt;/max_wheel_acceleration&gt;</span>

          <span class="nt">&lt;publish_odom&gt;</span>true<span class="nt">&lt;/publish_odom&gt;</span>
          <span class="nt">&lt;publish_odom_tf&gt;</span>true<span class="nt">&lt;/publish_odom_tf&gt;</span>
          <span class="nt">&lt;publish_wheel_tf&gt;</span>true<span class="nt">&lt;/publish_wheel_tf&gt;</span>
          <span class="nt">&lt;odometry_frame&gt;</span>odom<span class="nt">&lt;/odometry_frame&gt;</span>
          <span class="nt">&lt;robot_base_frame&gt;</span>base_footprint<span class="nt">&lt;/robot_base_frame&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>编译一下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">colcon</span> <span class="n">build</span>
<span class="n">source</span> <span class="n">install</span><span class="o">/</span><span class="n">setup</span><span class="p">.</span><span class="n">bash</span>
<span class="n">ros2</span> <span class="n">launch</span> <span class="n">fishbot_description</span> <span class="n">gazebo</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">py</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后可以看看下面这俩命令：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">node</span> <span class="nb">list</span>
<span class="n">ros2</span> <span class="n">topic</span> <span class="nb">list</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1650.webp" alt="" /></p>

<p>可以看到了我们插件订阅的的/cmd_vel和发布的/odom了。</p>

<p>然后我们可以通过teleop-twist-keyboard节点发布cmd_vel来控制fishbot。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">ros</span><span class="o">-</span><span class="n">humble</span><span class="o">-</span><span class="n">teleop</span><span class="o">-</span><span class="n">twist</span><span class="o">-</span><span class="n">keyboard</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用下方节点来控制</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">run</span> <span class="n">teleop_twist_keyboard</span> <span class="n">teleop_twist_keyboard</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接着尝试使用来控制机器人运动</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>   <span class="n">U</span>    <span class="n">I</span>    <span class="n">O</span>
   <span class="n">J</span>    <span class="n">K</span>    <span class="n">L</span>
   <span class="n">M</span>    <span class="o">&lt;</span>    <span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>点一下，你就能看到fishbot在Gazebo中飞速的移动。接着打开终端，打印一下odom话题和tf话题，移动机器人观察数据变化。</p>

<p>也可以使用rqt显示速度数据</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">rqt</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>选择Plugin-&gt;Visualization-&gt;Plot</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1651.webp" alt="" /></p>

<p>在上方Topic输入<code class="language-plaintext highlighter-rouge">/cmd_vel/linear/x</code>，再输入<code class="language-plaintext highlighter-rouge">/cmd_vel/angular/z</code>，然后用键盘控制机器人移动。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1652.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1653.webp" alt="" /></p>

<p>也可以在rviz2里看odom</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">rviz2</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>点键盘控制节点按U，让机器人转圈。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1654.webp" alt="" /></p>

<p>虽然机器人的轨迹已经在RVIZ中显示出来了，但是并没有机器人的模型，也看不到轮子的转动，咱们来带你一起解决这个问题。</p>

<p>前面咱们介绍过，要发布机器人模型我们所使用的节点是<code class="language-plaintext highlighter-rouge">robot_state_publisher</code>,所以我们在<code class="language-plaintext highlighter-rouge">gazebo.launch.py</code>中加入这个节点，同时再加上rviz2的启动节点，最终的<code class="language-plaintext highlighter-rouge">gazebo.launch.py</code>内容如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>

<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span>
<span class="c1"># from launch.actions import DeclareLaunchArgument
</span>
<span class="c1"># from launch.substitutions import LaunchConfiguration
</span>
<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">robot_name_in_model</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot</span><span class="sh">'</span>
    <span class="n">package_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot_description</span><span class="sh">'</span>
    <span class="n">urdf_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fishbot_gazebo.urdf</span><span class="sh">"</span>

    <span class="n">pkg_share</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">urdf_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">urdf/urdf/</span><span class="si">{</span><span class="n">urdf_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># gazebo_world_path = os.path.join(pkg_share, 'world/fishbot.world')
</span>
    <span class="c1"># Start Gazebo server
</span>
    <span class="c1"># start_gazebo_cmd = ExecuteProcess(
</span>
    <span class="c1">#     cmd=['gazebo', '--verbose','-s', 'libgazebo_ros_init.so', '-s', 'libgazebo_ros_factory.so',gazebo_world_path],
</span>
    <span class="c1">#     output='screen')
</span>    <span class="n">start_gazebo_cmd</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">gazebo</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--verbose</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_init.so</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_factory.so</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Launch the robot
</span>    <span class="n">spawn_entity_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">gazebo_ros</span><span class="sh">'</span><span class="p">,</span> 
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">spawn_entity.py</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-entity</span><span class="sh">'</span><span class="p">,</span> <span class="n">robot_name_in_model</span><span class="p">,</span>  <span class="sh">'</span><span class="s">-file</span><span class="sh">'</span><span class="p">,</span> <span class="n">urdf_model_path</span> <span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Robot State publisher
</span>    <span class="n">start_robot_state_publisher_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="n">urdf_model_path</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Launch RViz
</span>    <span class="n">start_rviz_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>

        <span class="c1"># arguments=['-d', default_rviz_config_path]
</span>        <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">start_gazebo_cmd</span><span class="p">,</span><span class="n">spawn_entity_cmd</span><span class="p">,</span><span class="n">start_robot_state_publisher_cmd</span><span class="p">,</span><span class="n">start_rviz_cmd</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>保存编译启动</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">colcon</span> <span class="n">build</span>
<span class="n">ros2</span> <span class="n">launch</span> <span class="n">fishbot_description</span> <span class="n">gazebo</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">py</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这样rviz2里就有模型了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1655.webp" alt="" /></p>

<p>可以保存下rviz2的配置</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1656.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1657.webp" alt="" /></p>

<p>然后在launch里添加上rviz2的路径配置：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>    <span class="n">default_rviz_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sh">'</span><span class="s">rviz/rviz2.rviz</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Launch RViz
</span>    <span class="n">start_rviz_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="n">default_rviz_config_path</span><span class="p">]</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如下为全部的launch：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>

<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span>
<span class="c1"># from launch.actions import DeclareLaunchArgument
</span>
<span class="c1"># from launch.substitutions import LaunchConfiguration
</span>
<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">robot_name_in_model</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot</span><span class="sh">'</span>
    <span class="n">package_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot_description</span><span class="sh">'</span>
    <span class="n">urdf_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fishbot_gazebo.urdf</span><span class="sh">"</span>

    <span class="n">pkg_share</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">urdf_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">urdf/urdf/</span><span class="si">{</span><span class="n">urdf_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># gazebo_world_path = os.path.join(pkg_share, 'world/fishbot.world')
</span>    <span class="n">default_rviz_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sh">'</span><span class="s">rviz/rviz2.rviz</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Gazebo server
</span>
    <span class="c1"># start_gazebo_cmd = ExecuteProcess(
</span>
    <span class="c1">#     cmd=['gazebo', '--verbose','-s', 'libgazebo_ros_init.so', '-s', 'libgazebo_ros_factory.so',gazebo_world_path],
</span>
    <span class="c1">#     output='screen')
</span>    <span class="n">start_gazebo_cmd</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">gazebo</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--verbose</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_init.so</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_factory.so</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Launch the robot
</span>    <span class="n">spawn_entity_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">gazebo_ros</span><span class="sh">'</span><span class="p">,</span> 
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">spawn_entity.py</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-entity</span><span class="sh">'</span><span class="p">,</span> <span class="n">robot_name_in_model</span><span class="p">,</span>  <span class="sh">'</span><span class="s">-file</span><span class="sh">'</span><span class="p">,</span> <span class="n">urdf_model_path</span> <span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Robot State publisher
</span>    <span class="n">start_robot_state_publisher_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="n">urdf_model_path</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Launch RViz
</span>    <span class="n">start_rviz_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="n">default_rviz_config_path</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">start_gazebo_cmd</span><span class="p">,</span><span class="n">spawn_entity_cmd</span><span class="p">,</span><span class="n">start_robot_state_publisher_cmd</span><span class="p">,</span><span class="n">start_rviz_cmd</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>可以自行编译测试。</p>

<h4 id="惯性计imu">惯性计IMU</h4>

<p>上节课通过配置两轮差速控制器我们已经成功的让fishbot在gazebo中动了起来，本节课我们通过给fishbot的URDF配置IMU传感器插件，让IMU模块工作起来。</p>

<p>惯性测量单元是测量物体三轴姿态角(或角速率)以及加速度的装置。一般的，一个IMU包含了三个单轴的加速度计和三个单轴的陀螺，加速度计检测物体在载体坐标系统独立三轴的加速度信号，而陀螺检测载体相对于导航坐标系的角速度信号，测量物体在三维空间中的角速度和加速度，并以此解算出物体的姿态。在导航中有着很重要的应用价值。</p>

<p>上面这段话是小鱼从百科中摘抄出来的，你需要知道的一个关键点是IMU可以测量以下三组数据：</p>

<ul>
  <li>
    <p>三维加速度计加速度</p>
  </li>
  <li>
    <p>三维陀螺仪角速度</p>
  </li>
  <li>
    <p>三维磁力计（有的也没有磁力计）</p>
  </li>
</ul>

<p>用六轴、九轴算法或其他算法等可以输出三轴欧拉角（Yaw,Pitch,Roll），欧拉角可以转化为四元数。</p>

<p>IMU长啥样？直接线下找控制组要就行，他们经常会玩这个。</p>

<p>便宜的长这样（MPU6050,MPU9050等）：</p>

<p>MPU6050是六轴的，MPU9050是九轴的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1658.webp" alt="" /></p>

<p>贵的长这样（HWT101CT，HWT605等）：</p>

<p>其中HWT101CT是三轴的，HWT605是六轴的。（各有优缺点）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1659.webp" alt="" /></p>

<p>不要钱的长什么样？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1660.webp" alt="" /></p>

<p>仿真的不要钱哈哈，接着我们来配置一下仿真的IMU。</p>

<p>IMU对应的消息类型为<code class="language-plaintext highlighter-rouge">sensor_msgs/msg/Imu</code></p>

<p>ROS的imu信息只有三轴加速度，角速度和四元数。（并没有磁力计和欧拉角，磁力计并非必须要填的，而欧拉角和四元数可以互相转换，四元数更好被算法运算，所以选择用四元数）</p>

<p>具体imu接口请看硬件平台章节。</p>

<p>可以看到除了每个数据对应的三个协方差之外，每一个还都对应一个<code class="language-plaintext highlighter-rouge">3*3</code>的协方差矩阵。</p>

<p>有了上节课的经验，我们可以很轻松的添加IMU传感器，但是还有一个需要注意的地方，为了更真实的模拟IMU传感器，我们需要给我们的仿真IMU传感器加点料。</p>

<p>加什么？加点高斯噪声，高斯噪声只需要指定平均值和标准差两个参数即可，不过因为IMU传感器的特殊性，我们还需要给模型添加两个偏差参数，分别是 <code class="language-plaintext highlighter-rouge">平均值偏差</code>和<code class="language-plaintext highlighter-rouge">标准差偏差</code>。</p>

<p>有关Gazebo仿真和噪声模型更深入的介绍可以参考鱼香ROS发的两篇推文：</p>

<ul>
  <li>
    <p><a href="https://mp.weixin.qq.com/s/0-OEATkyfMf6wEyrP5csGw">Gazebo仿真进阶教程之传感器高斯噪声（一）</a></p>
  </li>
  <li>
    <p><a href="https://mp.weixin.qq.com/s/5k1SEGdASjUMbwWdSpf1PQ">Gazebo仿真进阶教程之传感器高斯噪声（二）</a></p>
  </li>
</ul>

<p>下面是IMU传感器的URDF配置代码，大家结合文章对应可以理解一下，IMU对应的插件库<code class="language-plaintext highlighter-rouge">libgazebo_ros_imu_sensor.so</code>：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="rouge-code"><pre>    <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"imu_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"imu_sensor"</span> <span class="na">type=</span><span class="s">"imu"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;plugin</span> <span class="na">filename=</span><span class="s">"libgazebo_ros_imu_sensor.so"</span> <span class="na">name=</span><span class="s">"imu_plugin"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;ros&gt;</span>
            <span class="nt">&lt;namespace&gt;</span>/<span class="nt">&lt;/namespace&gt;</span>
            <span class="nt">&lt;remapping&gt;</span>~/out:=imu<span class="nt">&lt;/remapping&gt;</span>
          <span class="nt">&lt;/ros&gt;</span>
          <span class="nt">&lt;initial_orientation_as_reference&gt;</span>false<span class="nt">&lt;/initial_orientation_as_reference&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;always_on&gt;</span>true<span class="nt">&lt;/always_on&gt;</span>
        <span class="nt">&lt;update_rate&gt;</span>100<span class="nt">&lt;/update_rate&gt;</span>
        <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
        <span class="nt">&lt;imu&gt;</span>
          <span class="nt">&lt;angular_velocity&gt;</span>
            <span class="nt">&lt;x&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>2e-4<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.0000075<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.0000008<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/x&gt;</span>
            <span class="nt">&lt;y&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>2e-4<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.0000075<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.0000008<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/y&gt;</span>
            <span class="nt">&lt;z&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>2e-4<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.0000075<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.0000008<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/z&gt;</span>
          <span class="nt">&lt;/angular_velocity&gt;</span>
          <span class="nt">&lt;linear_acceleration&gt;</span>
            <span class="nt">&lt;x&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>1.7e-2<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.1<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.001<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/x&gt;</span>
            <span class="nt">&lt;y&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>1.7e-2<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.1<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.001<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/y&gt;</span>
            <span class="nt">&lt;z&gt;</span>
              <span class="nt">&lt;noise</span> <span class="na">type=</span><span class="s">"gaussian"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
                <span class="nt">&lt;stddev&gt;</span>1.7e-2<span class="nt">&lt;/stddev&gt;</span>
                <span class="nt">&lt;bias_mean&gt;</span>0.1<span class="nt">&lt;/bias_mean&gt;</span>
                <span class="nt">&lt;bias_stddev&gt;</span>0.001<span class="nt">&lt;/bias_stddev&gt;</span>
              <span class="nt">&lt;/noise&gt;</span>
            <span class="nt">&lt;/z&gt;</span>
          <span class="nt">&lt;/linear_acceleration&gt;</span>
        <span class="nt">&lt;/imu&gt;</span>
      <span class="nt">&lt;/sensor&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>我们之前下载的fishbot已经包含该内容了，所以不用再添加了，直接运行即可。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">launch</span> <span class="n">fishbot_description</span> <span class="n">gazebo</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">py</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">topic</span> <span class="nb">list</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1661.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">topic</span> <span class="n">info</span> <span class="o">/</span><span class="n">imu</span>
<span class="n">ros2</span> <span class="n">topic</span> <span class="n">echo</span> <span class="o">/</span><span class="n">imu</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1662.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1663.webp" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="na">header</span><span class="pi">:</span>
  <span class="na">stamp</span><span class="pi">:</span>
    <span class="na">sec</span><span class="pi">:</span> <span class="m">150</span>
    <span class="na">nanosec</span><span class="pi">:</span> <span class="m">599000000</span>
  <span class="na">frame_id</span><span class="pi">:</span> <span class="s">base_footprint</span>
<span class="na">orientation</span><span class="pi">:</span>
  <span class="na">x</span><span class="pi">:</span> <span class="s">3.434713830866392e-07</span>
  <span class="na">y</span><span class="pi">:</span> <span class="s">7.119913105768616e-06</span>
  <span class="na">z</span><span class="pi">:</span> <span class="s">-0.00028312437320413914</span>
  <span class="na">w</span><span class="pi">:</span> <span class="m">0.9999999598948884</span>
<span class="na">orientation_covariance</span><span class="pi">:</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="na">angular_velocity</span><span class="pi">:</span>
  <span class="na">x</span><span class="pi">:</span> <span class="s">-0.00013597855247901325</span>
  <span class="na">y</span><span class="pi">:</span> <span class="m">0.0006306135617081868</span>
  <span class="na">z</span><span class="pi">:</span> <span class="s">-0.00015794894627685146</span>
<span class="na">angular_velocity_covariance</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">4.0e-08</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="s">4.0e-08</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="s">4.0e-08</span>
<span class="na">linear_acceleration</span><span class="pi">:</span>
  <span class="na">x</span><span class="pi">:</span> <span class="m">0.08679200038530369</span>
  <span class="na">y</span><span class="pi">:</span> <span class="m">0.07753419258567491</span>
  <span class="na">z</span><span class="pi">:</span> <span class="m">9.687910969061628</span>
<span class="na">linear_acceleration_covariance</span><span class="pi">:</span>
<span class="pi">-</span> <span class="m">0.00028900000000000003</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.00028900000000000003</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.0</span>
<span class="pi">-</span> <span class="m">0.00028900000000000003</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>用rqt可视化：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1664.webp" alt="" /></p>

<h4 id="雷达laser">雷达Laser</h4>

<p>本节我们来认识一个新的传感器，该传感器在自动驾驶、室内导航等应用非常多，比如扫地机器人上就是用的它作为感知环境的重要工具，该传感器是激光雷达。</p>

<p>激光雷达（Light Detection And Ranging）,缩写<code class="language-plaintext highlighter-rouge">LiDAR</code>，英文也叫laser,翻译一下叫——激光探测与测距。</p>

<p>激光雷达的原理也很简单，就像蝙蝠的定位方法一样，蝙蝠定位大家都知道吧，像下面这样子的回声定位。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1665.webp" alt="" /></p>

<p>普通的单线激光雷达一般有一个发射器，一个接收器，发射器发出激光射线到前方的目标上，物品会将激光反射回来，然后激光雷达的接受器可以检测到反射的激光。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1666.webp" alt="" /></p>

<p>通过计算发送和反馈之间的时间间隔，乘上激光的速度，就可以计算出激光飞行的距离，该计算方法成为TOF（飞行时间法Time of flight，也称时差法）。</p>

<p>除了TOF之外还有其他方法进行测距，比如三角法，这里就不拓展了放一篇文章，大家自行阅读。<a href="https://www.slamtec.com/cn/News/Detail/190">激光三角测距原理详述</a></p>

<p>目前市面上的激光雷达，几乎都是采用三角测距，比如思岚的：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1667.webp" alt="" /></p>

<p>需要注意的是虽然只有一个发射器和一个接受器，激光雷达通过电机可以进行旋转，这样就可以达到对周围环境360度测距的目的。</p>

<p>五位数的长这样：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1668.webp" alt="" /></p>

<p>四位数的长这样（咱们有一台）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1669.webp" alt="" /></p>

<p>三位数的长这样（咱们也有）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1670.webp" alt="" /></p>

<p>两位数的长这样</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1671.webp" alt="" /></p>

<p>不要钱的长这样</p>

<p>仿真的，不要钱</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1672.webp" alt="" /></p>

<p>因为激光雷达是属于射线类传感器，该类传感在在Gazebo插件中都被封装成了一个动态库<code class="language-plaintext highlighter-rouge">libgazebo_ros_ray_sensor.so</code>。</p>

<p>接着我们来看看LiDAR的话题消息接口<code class="language-plaintext highlighter-rouge">sensor_msgs/msg/LaserScan</code>。</p>

<p>雷达的数据结构有些复杂，但通过注释和名字相信你可以看的七七八八，看不懂也没关系，一般情况下我们不会直接的对雷达的数据做操作。</p>

<p>雷达的模型不需要collision，请删掉，否则会挡激光射出。</p>

<p>有了前面的经验，我们需要在URDF添加以下内容即可，但我们下载的是鱼香ROS添加好的，所以不用改了：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"laser_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"laser_sensor"</span> <span class="na">type=</span><span class="s">"ray"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>true<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>10<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 0.075 0 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;ray&gt;</span>
          <span class="nt">&lt;scan&gt;</span>
            <span class="nt">&lt;horizontal&gt;</span>
              <span class="nt">&lt;samples&gt;</span>360<span class="nt">&lt;/samples&gt;</span>
              <span class="nt">&lt;resolution&gt;</span>1.000000<span class="nt">&lt;/resolution&gt;</span>
              <span class="nt">&lt;min_angle&gt;</span>0.000000<span class="nt">&lt;/min_angle&gt;</span>
              <span class="nt">&lt;max_angle&gt;</span>6.280000<span class="nt">&lt;/max_angle&gt;</span>
            <span class="nt">&lt;/horizontal&gt;</span>
          <span class="nt">&lt;/scan&gt;</span>
          <span class="nt">&lt;range&gt;</span>
            <span class="nt">&lt;min&gt;</span>0.120000<span class="nt">&lt;/min&gt;</span>
            <span class="nt">&lt;max&gt;</span>3.5<span class="nt">&lt;/max&gt;</span>
            <span class="nt">&lt;resolution&gt;</span>0.015000<span class="nt">&lt;/resolution&gt;</span>
          <span class="nt">&lt;/range&gt;</span>
          <span class="nt">&lt;noise&gt;</span>
            <span class="nt">&lt;type&gt;</span>gaussian<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
            <span class="nt">&lt;stddev&gt;</span>0.01<span class="nt">&lt;/stddev&gt;</span>
          <span class="nt">&lt;/noise&gt;</span>
      <span class="nt">&lt;/ray&gt;</span>

      <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">"laserscan"</span> <span class="na">filename=</span><span class="s">"libgazebo_ros_ray_sensor.so"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ros&gt;</span>
          <span class="nt">&lt;remapping&gt;</span>~/out:=scan<span class="nt">&lt;/remapping&gt;</span>
        <span class="nt">&lt;/ros&gt;</span>
        <span class="nt">&lt;output_type&gt;</span>sensor_msgs/LaserScan<span class="nt">&lt;/output_type&gt;</span>
        <span class="nt">&lt;frame_name&gt;</span>laser_link<span class="nt">&lt;/frame_name&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;/sensor&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>可以看到:</p>

<ol>
  <li>
    <p>雷达也可以设置更新频率<code class="language-plaintext highlighter-rouge">update_rate</code>，这里设置为5</p>
  </li>
  <li>
    <p>雷达可以设置分辨率，设置为1，采样数量360个，最终生成的点云数量就是360</p>
  </li>
  <li>
    <p>雷达也有噪声，模型为<code class="language-plaintext highlighter-rouge">gaussian</code></p>
  </li>
  <li>
    <p>雷达有扫描范围<code class="language-plaintext highlighter-rouge">range</code>，这里配置成0.12-3.5，0.015分辨率</p>
  </li>
  <li>
    <p>雷达的<code class="language-plaintext highlighter-rouge">pose</code>就是雷达的joint中位置的设置值</p>
  </li>
</ol>

<p>下面这个蓝色的就是激光雷达的光线覆盖范围：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1673.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">topic</span> <span class="nb">list</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1674.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">ros2</span> <span class="n">topic</span> <span class="n">info</span> <span class="o">/</span><span class="n">scan</span>
<span class="n">ros2</span> <span class="n">topic</span> <span class="n">echo</span> <span class="o">/</span><span class="n">scan</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1675.webp" alt="" /></p>

<p>接着我们尝试使用rviz2进行可视化激光雷达数据</p>

<p>添加和修改RVIZ2的如下：（通过LaserScan插件可以看到激光数据）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1676.webp" alt="" /></p>

<p>相信你改完之后依然是看不到任何激光雷达的数据的，反看topic的echo出来的数据，不是0就是inf(无限大)，再看看gazebo你会发现，激光雷达并没有达到任何一个物体上。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1677.webp" alt="" /></p>

<p>所以我们可以手动的给激光雷达周围添加一下东西，点击Gazebo工具栏的正方体，圆球或者圆柱，随意放置几个到我们激光雷达的最大扫描半径内。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1678.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1679.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1680.webp" alt="" /></p>

<h4 id="超声波ultrasonic">超声波Ultrasonic</h4>

<p>这玩意对于ROS2算法意义不是很大，控制组直接在MCU上实现即可，有需求可以学本节。 <strong>（可以跳过本节）</strong></p>

<p>在实际的机器人开发过程中，我们可能会利用超声波传感器实现实时避障的功能，毕竟超声波的价格相较于激光雷达要便宜很多（便宜的几块钱）。</p>

<p>所以本节我们来说一下如何使用ROS2+Gazebo来仿真超声波传感器。</p>

<p>百科来一段：</p>

<p>超声波传感器是将超声波信号转换成其它能量信号（通常是电信号）的传感器。超声波是<a href="https://baike.baidu.com/item/%E6%8C%AF%E5%8A%A8%E9%A2%91%E7%8E%87/8068137">振动频率</a>高于20kHz的机械波。它具有频率高、波长短、绕射现象小，特别是方向性好、能够成为<a href="https://baike.baidu.com/item/%E5%B0%84%E7%BA%BF/327964">射线</a>而定向传播等特点。超声波对液体、固体的穿透本领很大，尤其是在阳光不透明的固体中。超声波碰到杂质或分界面会产生显著反射形成反射回波，碰到活动物体能产生<a href="https://baike.baidu.com/item/%E5%A4%9A%E6%99%AE%E5%8B%92%E6%95%88%E5%BA%94/115710">多普勒效应</a>。超声波传感器广泛应用在工业、国防、生物医学等方面。</p>

<p>接着看看长什么样子：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1681.webp" alt="" /></p>

<p>便宜的就长这样子，一共两个头，一个头用于发送波，一个头接收波。这个还稍微高级一点，带一个光敏电阻，可以为超声波数据做一些补偿。</p>

<p>超声波传感器原理是什么呢？</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1682.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>距离<span class="o">=(</span>发送时间-接收时间<span class="o">)</span><span class="k">*</span>速度/2Copy to clipboardErrorCopied
</pre></td></tr></tbody></table></code></pre></div></div>

<p>看了超声波的原理，你有没有发现和前面的激光雷达传感器是一样的，是的，所以超声波传感器插件和激光雷达传感器插件在Gazebo插件中是同一个：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>libgazebo_ros_ray_sensor.so
</pre></td></tr></tbody></table></code></pre></div></div>

<p>超声波总要装在机器人身上某个位置，所以我们先添加一个关节和Joint，为了省事，link我们就只写个名字，你如果有需要可以按照前面的章节那样添加一下。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"ultrasonic_sensor_link"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"ultrasonic_sensor_joint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"ultrasonic_sensor_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.07 0.0 0.076"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>添加完了关节，我们就可以配置gazebo的插件了，gazebo插件配置如下</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"ultrasonic_sensor_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">type=</span><span class="s">"ray"</span> <span class="na">name=</span><span class="s">"ultrasonic_sensor"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 0 0 0 0<span class="nt">&lt;/pose&gt;</span>

      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>

      <span class="nt">&lt;update_rate&gt;</span>5<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;ray&gt;</span>
        <span class="nt">&lt;scan&gt;</span>

          <span class="nt">&lt;horizontal&gt;</span>
            <span class="nt">&lt;samples&gt;</span>5<span class="nt">&lt;/samples&gt;</span>
            <span class="nt">&lt;resolution&gt;</span>1<span class="nt">&lt;/resolution&gt;</span>
            <span class="nt">&lt;min_angle&gt;</span>-0.12<span class="nt">&lt;/min_angle&gt;</span>
            <span class="nt">&lt;max_angle&gt;</span>0.12<span class="nt">&lt;/max_angle&gt;</span>
          <span class="nt">&lt;/horizontal&gt;</span>

          <span class="nt">&lt;vertical&gt;</span>
            <span class="nt">&lt;samples&gt;</span>5<span class="nt">&lt;/samples&gt;</span>
            <span class="nt">&lt;resolution&gt;</span>1<span class="nt">&lt;/resolution&gt;</span>
            <span class="nt">&lt;min_angle&gt;</span>-0.01<span class="nt">&lt;/min_angle&gt;</span>
            <span class="nt">&lt;max_angle&gt;</span>0.01<span class="nt">&lt;/max_angle&gt;</span>
          <span class="nt">&lt;/vertical&gt;</span>
        <span class="nt">&lt;/scan&gt;</span>

        <span class="nt">&lt;range&gt;</span>
          <span class="nt">&lt;min&gt;</span>0.02<span class="nt">&lt;/min&gt;</span>
          <span class="nt">&lt;max&gt;</span>4<span class="nt">&lt;/max&gt;</span>
          <span class="nt">&lt;resolution&gt;</span>0.01<span class="nt">&lt;/resolution&gt;</span>
        <span class="nt">&lt;/range&gt;</span>

        <span class="nt">&lt;noise&gt;</span>
          <span class="nt">&lt;type&gt;</span>gaussian<span class="nt">&lt;/type&gt;</span>
          <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
          <span class="nt">&lt;stddev&gt;</span>0.01<span class="nt">&lt;/stddev&gt;</span>
        <span class="nt">&lt;/noise&gt;</span>
      <span class="nt">&lt;/ray&gt;</span>
      <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">"ultrasonic_sensor_controller"</span> <span class="na">filename=</span><span class="s">"libgazebo_ros_ray_sensor.so"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ros&gt;</span>

          <span class="nt">&lt;remapping&gt;</span>~/out:=ultrasonic_sensor_1<span class="nt">&lt;/remapping&gt;</span>
        <span class="nt">&lt;/ros&gt;</span>

        <span class="nt">&lt;output_type&gt;</span>sensor_msgs/Range<span class="nt">&lt;/output_type&gt;</span>

        <span class="nt">&lt;radiation_type&gt;</span>ultrasound<span class="nt">&lt;/radiation_type&gt;</span>

        <span class="nt">&lt;frame_name&gt;</span>ultrasonic_sensor_link<span class="nt">&lt;/frame_name&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>添加完成后就可以编译测试下代码</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">colcon</span> <span class="n">build</span> <span class="o">--</span><span class="n">packages</span><span class="o">-</span><span class="n">select</span> <span class="n">fishbot_description</span>
<span class="n">source</span> <span class="n">install</span><span class="o">/</span><span class="n">setup</span><span class="p">.</span><span class="n">bash</span>
<span class="n">ros2</span> <span class="n">launch</span> <span class="n">fishbot_description</span> <span class="n">gazebo</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">py</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>没有物体的前面可以放个东西</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1683.webp" alt="" /></p>

<p>打开终端，输入下面指令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>ros2 topic list 
ros2 topic info /ultrasonic_sensor_1
ros2 topic <span class="nb">echo</span> /ultrasonic_sensor_1Copy to clipboardErrorCopied
</pre></td></tr></tbody></table></code></pre></div></div>

<p>不出意外可以看到下面的数据</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>header:
  stamp:
    sec: 4458
    nanosec: 1000000
  frame_id: ultrasonic_sensor_link
radiation_type: 0
field_of_view: 0.23999999463558197
min_range: 0.019999999552965164
max_range: 4.0
range: 2.6798219680786133
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里的range就是fishbot到墙之间的距离：2.67982</p>

<p>我们来讲一讲超声波传感器的数据类型<code class="language-plaintext highlighter-rouge">sensor_msgs/msg/Range</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c1"># ros2 topic info /ultrasonic_sensor_1
</span><span class="n">Type</span><span class="p">:</span> <span class="n">sensor_msgs</span><span class="o">/</span><span class="n">msg</span><span class="o">/</span><span class="n">Range</span>
<span class="n">Publisher</span> <span class="n">count</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Subscription</span> <span class="n">count</span><span class="p">:</span> <span class="mi">0</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>你可以使用<code class="language-plaintext highlighter-rouge">ros2 interface show sensor_msgs/msg/Range</code>看到详细的解释，我们翻译一下</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre>
<span class="c1"># Single range reading from an active ranger that emits energy and reports
</span>
<span class="c1"># one range reading that is valid along an arc at the distance measured.
</span>
<span class="c1"># This message is  not appropriate for laser scanners. See the LaserScan
</span>
<span class="c1"># message if you are working with a laser scanner.
#
</span>
<span class="c1"># This message also can represent a fixed-distance (binary) ranger.  This
</span>
<span class="c1"># sensor will have min_range===max_range===distance of detection.
</span>
<span class="c1"># These sensors follow REP 117 and will output -Inf if the object is detected
</span>
<span class="c1"># and +Inf if the object is outside of the detection range.
</span>
<span class="n">std_msgs</span><span class="o">/</span><span class="n">Header</span> <span class="n">header</span> <span class="c1"># timestamp in the header is the time the ranger
</span>
                             <span class="c1"># returned the distance reading
</span>
<span class="c1"># Radiation type enums
</span>
<span class="c1"># If you want a value added to this list, send an email to the ros-users list
</span><span class="n">uint8</span> <span class="n">ULTRASOUND</span><span class="o">=</span><span class="mi">0</span>
<span class="n">uint8</span> <span class="n">INFRARED</span><span class="o">=</span><span class="mi">1</span>

<span class="n">uint8</span> <span class="n">radiation_type</span>    <span class="c1"># 传感器射线类型
</span>
                        <span class="c1"># (sound, IR, etc) [enum]
</span>
<span class="n">float32</span> <span class="n">field_of_view</span>   <span class="c1"># 距离数据对应的弧[rad]的大小，测量物体的范围介于         
</span>
                        <span class="c1"># -field_of_view/2 到 field_of_view/2 之间。
</span>
                        <span class="c1"># 0 角度对应于传感器的 x 轴。
</span>
<span class="n">float32</span> <span class="n">min_range</span>       <span class="c1"># 最小范围值 [m]
</span><span class="n">float32</span> <span class="n">max_range</span>       <span class="c1"># 最大范围值 [m]
</span>
                        <span class="c1">#  固定距离需要 min_range==max_range
</span>
<span class="n">float32</span> <span class="nb">range</span>           <span class="c1"># 范围数据 [m]
</span>
                        <span class="c1"># (Note: values &lt; range_min or &gt; range_max should be discarded)
</span>
                        <span class="c1"># Fixed distance rangers only output -Inf or +Inf.
</span>
                        <span class="c1"># -Inf represents a detection within fixed distance.
</span>
                        <span class="c1"># (Detection too close to the sensor to quantify)
</span>
                        <span class="c1"># +Inf represents no detection within the fixed distance.
</span>
                        <span class="c1"># (Object out of range)
</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>结论，主要关注range就可以了。</p>

<p>在rviz2里添加超声波数据</p>

<p>Add -&gt;By topic-&gt;Range</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1684.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1685.webp" alt="" /></p>

<h3 id="搭建世界地图">搭建世界地图</h3>

<p>本节我们要在Gazebo中建立一个测试的环境，其实也很简单，利用Gazebo的画墙工具即可完成。</p>

<p>world即世界，gazebo的world文件就是用于描述世界模型的，也就是环境模型。</p>

<p>Gazebo已经为我们准备了很多常用的物体模型，除了基础的圆球，圆柱，立方体外的，其实还有飞机、汽车、房子等你现实中无法拥有的。</p>

<p>但是一开始安装Gazebo的时候并不会帮你下载好这些模型，需要我们手动下载，找一个你要存模型的文件夹，打开终端，复制粘贴下面这句</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">osrf</span><span class="o">/</span><span class="n">gazebo_models</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>并把存放模型的路径加到~/.bashrc里（第二个冒号后面的可以不写，第二个冒号后面的是多个路径。）</p>

<p>GAZEBO_MODEL_PATH是老版Gazebo Classic的宏。</p>

<p>IGN_GAZEBO_RESOURCE_PATH是新版Igntion Gazebo的宏。</p>

<p>模型都通用，可以一起配置上。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1686.webp" alt="" /></p>

<p>刷新环境变量</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">source</span> <span class="o">~/</span><span class="p">.</span><span class="n">bashrc</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时再次打开终端，输入<code class="language-plaintext highlighter-rouge">gazebo</code>，把选项卡切换到Insert</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1687.webp" alt="" /></p>

<p>在Insert选项卡下可以看到一个目录，以及目录下的模型名称，随着下载脚本的不断下载，这里的模型会越来越多。</p>

<p>随手拖几个，搭建一个漂亮的环境出来~</p>

<p>每个成功的男人都有一辆车，咱们也不例外</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1688.webp" alt="" /></p>

<p>上面是Gazebo为我们准备好的开源模型，我们也可以通过Gazebo的工具来自己画一个环境。</p>

<p>然后也可以用墙壁工具建墙</p>

<p>Gazebo左上角-&gt;Edit-&gt;Building Editor</p>

<p>接着可以看到这样一个编辑界面</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1689.webp" alt="" /></p>

<p>点击左边的Wall,你就可以在上方的白色区域进行建墙了，这个和模拟人生游戏不一样，这个是画二维的墙生成三维的墙，模拟人生是直接在三维里画。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1690.webp" alt="" /></p>

<p>建完后还可以用选Add Color或者Add Texture，然后点击下方墙，给墙添加颜色或者纹理。</p>

<p>首先你要有一个地图，小鱼为你准备了两个，两个图片都是800*600像素的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1691.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1692.webp" alt="" /></p>

<p>打开Gazebo-&gt;Gazebo左上角-&gt;Edit-&gt;Building Editor-&gt;左下方选Import</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1693.webp" alt="" /></p>

<p>将上面两个图片存到本地，在这个界面选图片，记着选Next</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1694.webp" alt="" /></p>

<p>左边选尺寸对应关系</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1695.webp" alt="" /></p>

<p>我们选择默认的，100像素/米。点击OK（需要手动将100改变一下才能点击OK哦），之后就可以用图片画墙了。</p>

<p>注意：导入完图片不会直接出来墙，图片只是提供了墙的大概位置，需要你手动用墙再将边描一遍。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1696.webp" alt="" /></p>

<p>建完后点击File-&gt;Exit,在退出的弹框中选Exit。</p>

<p>接着在Gazebo界面中就可以看到墙了，我们再手动添加几个物体，就可以用于下面的导航使用了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1697.webp" alt="" /></p>

<p>添加完，接着点击File-&gt;SaveWorld，将文件保存到我们的fishbot_descrption的world下。</p>

<p>没有world目录的小伙伴可以先手动创建下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1698.webp" alt="" /></p>

<p>加载world其实也很简单，可以先启动Gazebo，再手动的加载文件，也可以在Gazebo启动时加载：</p>

<p>比如在前面加载ROS2插件基础上再加载fishbot.world。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">gazebo</span> <span class="o">--</span><span class="n">verbose</span>  <span class="o">-</span><span class="n">s</span> <span class="n">libgazebo_ros_init</span><span class="p">.</span><span class="n">so</span> <span class="o">-</span><span class="n">s</span>  <span class="n">libgazebo_ros_factory</span><span class="p">.</span><span class="n">so</span> <span class="n">你的world文件目录</span><span class="o">/</span><span class="n">fishbot</span><span class="p">.</span><span class="n">world</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>修改launch文件，将上面的命令行写到<code class="language-plaintext highlighter-rouge">gazebo.launch.py</code>中即可。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>    <span class="n">gazebo_world_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sh">'</span><span class="s">world/fishbot.world</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Gazebo server
</span>    <span class="n">start_gazebo_cmd</span> <span class="o">=</span>  <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">gazebo</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--verbose</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_init.so</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_factory.so</span><span class="sh">'</span><span class="p">,</span> <span class="n">gazebo_world_path</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>下面是整个launch文件：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>

<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span>
<span class="c1"># from launch.actions import DeclareLaunchArgument
</span>
<span class="c1"># from launch.substitutions import LaunchConfiguration
</span>
<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">robot_name_in_model</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot</span><span class="sh">'</span>
    <span class="n">package_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot_description</span><span class="sh">'</span>
    <span class="n">urdf_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fishbot_gazebo.urdf</span><span class="sh">"</span>
    <span class="n">world_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fishbot.world</span><span class="sh">"</span>

    <span class="n">pkg_share</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">urdf_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">urdf/urdf/</span><span class="si">{</span><span class="n">urdf_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">gazebo_world_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">world/</span><span class="si">{</span><span class="n">world_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">default_rviz_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sh">'</span><span class="s">rviz/rviz2.rviz</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Gazebo server
</span>    <span class="n">start_gazebo_cmd</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">gazebo</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--verbose</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_init.so</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_factory.so</span><span class="sh">'</span><span class="p">,</span><span class="n">gazebo_world_path</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Launch the robot
</span>    <span class="n">spawn_entity_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">gazebo_ros</span><span class="sh">'</span><span class="p">,</span> 
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">spawn_entity.py</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-entity</span><span class="sh">'</span><span class="p">,</span> <span class="n">robot_name_in_model</span><span class="p">,</span>  <span class="sh">'</span><span class="s">-file</span><span class="sh">'</span><span class="p">,</span> <span class="n">urdf_model_path</span> <span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Robot State publisher
</span>    <span class="n">start_robot_state_publisher_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="n">urdf_model_path</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Launch RViz
</span>    <span class="n">start_rviz_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="n">default_rviz_config_path</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">start_gazebo_cmd</span><span class="p">,</span><span class="n">spawn_entity_cmd</span><span class="p">,</span><span class="n">start_robot_state_publisher_cmd</span><span class="p">,</span><span class="n">start_rviz_cmd</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最后记得修改cmakelists.txt文件，让编译后将world文件拷贝到install目录下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1699.webp" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">colcon</span> <span class="n">build</span>
<span class="n">source</span> <span class="n">install</span><span class="o">/</span><span class="n">setup</span><span class="p">.</span><span class="n">bash</span>
<span class="n">ros2</span> <span class="n">launch</span> <span class="n">fishbot_description</span> <span class="n">gazebo</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">py</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1700.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1701.webp" alt="" /></p>

<h3 id="框架优化">框架优化</h3>

<p>本节代码学长也发到仓库了，有需要的学弟学妹请看:https://github.com/tungchiahui/ROS_WS/tree/main/ROS2_WS%2F6.ws_simulations%2Fsrc%2Ffishbot_description</p>

<p>比如说支持xacro等优化。</p>

<p>首先先把原来的fishbot_gazebo.urdf里的内容分成好几个urdf和xacro再用一个总的fishbot.urdf.xacro去引用。（学过xacro的肯定都会）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1702.webp" alt="" /></p>

<p>优化后的launch如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="c1"># 封装终端指令相关类
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">ExecuteProcess</span>

<span class="c1"># from launch.substitutions import FindExecutable
</span>
<span class="c1"># 参数声明与获取
</span><span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>

<span class="c1"># 文件包含相关
</span>
<span class="c1"># from launch.actions import IncludeLaunchDescription
</span>
<span class="c1"># from launch.launch_description_sources import PythonLaunchDescriptionSource
</span>
<span class="c1"># 分组相关
</span>
<span class="c1"># from launch_ros.actions import PushRosNamespace
</span>
<span class="c1"># from launch.actions import GroupAction
</span>
<span class="c1"># 事件相关
</span>
<span class="c1"># from launch.event_handlers import OnProcessStart,OnProcessExit
</span>
<span class="c1"># from launch.actions import ExecuteProcess,RegisterEventHandler,LogInfo
</span>
<span class="c1"># 获取功能包下share目录或路径
</span><span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="n">launch_ros.parameter_descriptions</span> <span class="kn">import</span> <span class="n">ParameterValue</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">Command</span><span class="p">,</span><span class="n">LaunchConfiguration</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">robot_name_in_model</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot</span><span class="sh">'</span>
    <span class="n">package_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fishbot_description</span><span class="sh">'</span>

    <span class="c1"># urdf_xacro_name = "fishbot_gazebo.urdf"
</span>    <span class="n">world_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fishbot.world</span><span class="sh">"</span>

    <span class="n">pkg_share</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">urdf_xacro_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sh">"</span><span class="s">urdf/xacro</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">fishbot.urdf.xacro</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">gazebo_world_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">world/</span><span class="si">{</span><span class="n">world_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">default_rviz_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_share</span><span class="p">,</span> <span class="sh">'</span><span class="s">rviz/rviz2.rviz</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">urdf_xacro_model_path</span><span class="p">)</span>
    <span class="n">robot_description</span> <span class="o">=</span> <span class="nc">ParameterValue</span><span class="p">(</span><span class="nc">Command</span><span class="p">([</span><span class="sh">"</span><span class="s">xacro </span><span class="sh">"</span><span class="p">,</span><span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)]))</span>

    <span class="c1"># Start Gazebo server
</span>    <span class="n">start_gazebo_cmd</span> <span class="o">=</span> <span class="nc">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">gazebo</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--verbose</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_init.so</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">libgazebo_ros_factory.so</span><span class="sh">'</span><span class="p">,</span><span class="n">gazebo_world_path</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Launch the robot
</span>    <span class="n">spawn_entity_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">gazebo_ros</span><span class="sh">'</span><span class="p">,</span> 
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">spawn_entity.py</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-entity</span><span class="sh">'</span><span class="p">,</span> <span class="n">robot_name_in_model</span><span class="p">,</span>  <span class="sh">'</span><span class="s">-topic</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">/robot_description</span><span class="sh">'</span> <span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Start Robot State publisher
</span>    <span class="n">start_robot_state_publisher_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_state_publisher</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">robot_description</span><span class="sh">"</span><span class="p">:</span> <span class="n">robot_description</span><span class="p">}]</span>
    <span class="p">)</span>

    <span class="c1"># Launch RViz
</span>    <span class="n">start_rviz_cmd</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="n">default_rviz_config_path</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">model</span><span class="p">,</span><span class="n">start_gazebo_cmd</span><span class="p">,</span><span class="n">spawn_entity_cmd</span><span class="p">,</span><span class="n">start_robot_state_publisher_cmd</span><span class="p">,</span><span class="n">start_rviz_cmd</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">colcon</span> <span class="n">build</span>
<span class="n">source</span> <span class="n">install</span><span class="o">/</span><span class="n">setup</span><span class="p">.</span><span class="n">bash</span>
<span class="n">ros2</span> <span class="n">launch</span> <span class="n">fishbot_description</span> <span class="n">gazebo</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">py</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1703.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1704.webp" alt="" /></p>

<p>然后就可以去搞导航啦！也可以接着学新版Ignition Gazebo，但这东西教程巨少，截止2024年只有赵虚左老师讲了。</p>

<h2 id="ignition-gazebo">Ignition Gazebo</h2>

<h3 id="ign-gazebo安装与运行">Ign Gazebo安装与运行</h3>

<p>Gazebo每个版本的变化都很大。</p>

<p>特别是ROS1用的老版Gazebo(黑色界面)和ROS2用的新版Gazebo(白色界面)。</p>

<p>ROS2的不同版本的Gazebo跨度也很大，比如Humble和Jazzy及Jazzy之后的版本之间很多标签区别很大。</p>

<p>本文使用humble版本(即Ignition Gazebo)当做教程。</p>

<p>当然，为了兼容以后的Gazebo，在下方也会有教程教你如何从ign gazebo迁移到gazebo sim（最最最新版gazebo）。</p>

<p>Ignition Gazebo 是 ROS2 中使用的全新机器人仿真工具，<strong>它是 Gazebo 的升级版本</strong>。在Humble他还叫Ignition Gazebo(也叫Gazebo Fortress)，在Jazzy中叫Gazebo Harmonic(去掉了Ignition的名字)(https://community.gazebosim.org/t/a-new-era-for-gazebo/1356)。它具备更好的性能和可用性，并通过紧密集成 ROS2 来提供强大的仿真环境。Ignition Gazebo 支持各种机器人平台和传感器，并提供灵活的配置选项和易于使用的界面。它的物理引擎和传感器模型可以帮助开发人员进行机器人系统的开发、测试和验证。无论是研究还是教育，Ignition Gazebo 都是一个强大的工具。</p>

<p>如果想从Ignition Gazebo(ROS2 Humble)迁移到Gazebo(ROS2 Jazzy)，请往下翻翻，下面有一节是讲如何迁移的。</p>

<p>https://docs.ros.org/en/humble/Tutorials/Advanced/Simulators/Gazebo/Gazebo.html</p>

<p>下面这个网站是官方教程(ROS2 Humble的Ignition Gazebo Fortress)：</p>

<p>https://gazebosim.org/docs/fortress/getstarted/</p>

<p>https://gazebosim.org/docs/fortress/library_reference_nav/</p>

<p>源码：https://github.com/gazebosim/docs/blob/master/fortress/tutorials</p>

<p><strong>安装</strong></p>

<p>Ignition Gazebo 是不依赖于ROS2的一个独立的项目，可以独自安装。但是如果安装了ROS2，在ROS2存储库中已经集成了对应版本的 Ignition Gazebo，可以调用如下指令直接安装：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 通用命令</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-<span class="k">${</span><span class="nv">ROS_DISTRO</span><span class="k">}</span><span class="nt">-ros-gz</span>

<span class="c"># Humble版本</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-ros-gz

<span class="c"># Jazzy版本</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-ros-gz
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1705.webp" alt="" /></p>

<p><strong>运行</strong></p>

<p>Ignition Gazebo 安装完毕之后，可以通过两种方式启动。</p>

<p>方式1，以Ignition Gazebo 的方式启动，指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># Humble版本</span>
ign gazebo

<span class="c"># Jazzy版本</span>
gz sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p>方式2，以ROS2的方式 启动，指令如下 ：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch ros_gz_sim gz_sim.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>二者运行结果一致，如下图所示：在弹出窗口中，选择仿真环境然后点击<code class="language-plaintext highlighter-rouge">run</code>按钮即可运行。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1706.webp" alt="" /></p>

<p><strong>界面介绍</strong></p>

<p>接下来以Empty仿真环境为例，介绍一下Ignition Gazebo的界面组成。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1707.webp" alt="" /></p>

<p>注意：如果你的Gazebo不卡，但是Ignition Gazebo巨卡的话，请确认Ignition Gazebo是以独显打开的，而不是核显。</p>

<p>如果不会切换应用显卡，可以直接把核显关闭掉，从混合输出切换为独立显卡输出。</p>

<p><strong>工具栏</strong></p>

<ul>
  <li>顶部的工具栏包含两个按钮，左侧的文件菜单按钮（水平条纹）和右侧的插件按钮（垂直省略号）。</li>
</ul>

<ol>
  <li>文件菜单按钮（水平条纹）</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1708.webp" alt="" /></p>

<ul>
  <li>文件菜单按钮包含将仿真环境保存到文件、保存和加载界面配置以及自定义界面样式等设置。</li>
</ul>

<ol>
  <li>右侧的插件按钮（垂直省略号）</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1709.webp" alt="" /></p>

<ul>
  <li>插件按钮列出了所有可用的插件。点击后会弹出插件列表，向下滚动此列表以查看所有插件。 当选择一个时，其界面将出现在右侧面板中。</li>
</ul>

<p><strong>3D视窗</strong></p>

<ul>
  <li>左上方工具栏包含多种几何体（球体、框体、圆柱体）按钮和变换控件。通过集合体按钮可以直接将盒子、球体或圆柱体模型插入仿真环境。只需单击要插入的形状，然后将其放入环境中。该形状将自动捕捉到地平面上。</li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1710.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1711.webp" alt="" /></p>

<ul>
  <li>主视图会显示仿真环境，我们可以通过鼠标以不同方式来导航场景，相关操作如下：</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>左键单击：选择实体
右键单击：打开带有选项的菜单：
   Move to：移动到以实体为中心的场景
   Follow：选择一个实体让视图保持居中，无论是移动还是平移
   Remove：从模拟中删除实体
   Copy：复制实体
   Past: 粘贴实体
   View：显示实体的重心（Center of Mass）、碰撞边界（Collisions）、惯性（Inertia）、
         关节（Joints）、坐标系（Frames）、透明度（Transparent）、线框（Wireframe）等属性
左键单击并拖动：在场景中平移
右键单击并拖动：放大和缩小
滚轮向前/向后：放大和缩小
滚轮单击并拖动：旋转场景
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>想移动这个球，需要点左上角的移动模式，再左键单击选中物体</li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1712.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1713.webp" alt="" /></p>

<ul>
  <li>在视窗的底部，从左到右分别是是播放、步长按钮和实时因子（Real-Time Factor，RTF）。点击播放按钮将开始运行仿真环境， 再次点击可以暂停运行。步长按钮用于设置仿真时间的离散单位，可以通过将鼠标悬停在按钮上来自定义步长。实时因子表示仿真运行速度相对于真实时间的比例。</li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1714.webp" alt="" /></p>

<p><strong>右侧面板</strong></p>

<p>右侧面板用于显示插件，当前仿真环境默认包含两个插件：Model和Entity Tree。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1715.webp" alt="" /></p>

<ul>
  <li>
    <p>Entity Tree 中会显示仿真环境中的实体列表；</p>
  </li>
  <li>
    <p>点击Entity Tree中的实体后，可以在Model中显示该实体的相关信息。</p>
  </li>
  <li>
    <p>也可以按住 Ctrl 并单击以选择多个实体；</p>
  </li>
  <li>
    <p>还可以右键单击任何插件以打开基本设置或关闭。</p>
  </li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1716.webp" alt="" /></p>

<p>在Ignition Gazebo中内置了许多插件，可以点击工具栏的右侧按钮自行添加，比如：可以选择 Grid Config 插件调整世界网格的特征，包括单元格大小、网格位置、单元格计数、或颜色等。</p>

<p>后期随着应用的深入，也会陆续介绍其他一些插件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1717.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1718.webp" alt="" /></p>

<h3 id="与ros2集成">与ROS2集成</h3>

<p>本节将介绍如何实现Ignition Gazebo与ROS2的集成，以实现二者之间的交互，比如，可以通过ROS2的键盘控制节点控制机器人运动，并且在rviz2中显示机器人的里程计(odom)数据。其流程大致如下：</p>

<ol>
  <li>
    <p>启动 Ignition Gazebo 仿真环境；</p>
  </li>
  <li>
    <p>通过 ros_gz_bridge 建立 ROS2 与 Ignition Gazebo 的连接；</p>
  </li>
  <li>
    <p>启动 ROS2 相关节点实现与 Ignition Gazebo 的数据收发。</p>
  </li>
</ol>

<p>Ignition Gazebo与ROS2的的所有集成实现，基本都遵循上述流程。</p>

<p><strong>启动仿真环境</strong></p>

<p>在 Ignition Gazebo 安装时，已经内置了一些仿真环境，直接启动即可。在此我们可以使用名为<code class="language-plaintext highlighter-rouge">visualize_lidar.sdf</code>的仿真文件，该文件对应的仿真环境中包括了差速机器人以及激光雷达的仿真。启动指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>ign gazebo <span class="nt">-v</span> 4 <span class="nt">-r</span> visualize_lidar.sdf
<span class="c">#或者</span>
gz sim <span class="nt">-v</span> 4 <span class="nt">-r</span> visualize_lidar.sdf
</pre></td></tr></tbody></table></code></pre></div></div>

<p>或者也可以以ROS2 launch的方式启动，指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch ros_gz_sim gz_sim.launch.py gz_args:<span class="o">=</span><span class="s2">"-v 4 -r visualize_lidar.sdf"</span> <span class="c"># 启动状态</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>两种方式本质相同，都是启动了Ignition Gazebo并且加载了visualize_lidar.sdf文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1719.webp" alt="" /></p>

<p><strong>建立连接</strong></p>

<p>虽然仿真环境中的机器人已经配置了运动控制插件，可以通过<code class="language-plaintext highlighter-rouge">/model/vehicle_blue/cmd_vel</code>话题订阅速度指令并运动，但是Ignition Gazebo与ROS2中的消息格式并不一致，所以还需要通过ros_gz_bridge这一桥接功能包，实现二者之间消息的转换，调用指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run ros_gz_bridge parameter_bridge /model/vehicle_blue/cmd_vel@geometry_msgs/msg/Twist]gz.msgs.Twist
</pre></td></tr></tbody></table></code></pre></div></div>

<p>通过该指令可以将发布在<code class="language-plaintext highlighter-rouge">/model/vehicle_blue/cmd_vel</code>话题上的<code class="language-plaintext highlighter-rouge">geometry_msgs/msg/Twist</code>类型的ROS2消息转换成可以被Ignition Gzebo识别的<code class="language-plaintext highlighter-rouge">gz.msgs.Twist</code>类型的消息。</p>

<p><strong>启动ROS2节点</strong></p>

<p>启动ROS2的键盘控制节点，并将话题重映射为<code class="language-plaintext highlighter-rouge">/model/vehicle_blue/cmd_vel</code>，指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run teleop_twist_keyboard teleop_twist_keyboard <span class="nt">--ros-args</span> <span class="nt">-r</span> /cmd_vel:<span class="o">=</span>/model/vehicle_blue/cmd_vel
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接下来就可以使用键盘控制机器人运动了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1720.webp" alt="" /></p>

<h3 id="ros_gz_bridge">ros_gz_bridge</h3>

<p>ros_gz_bridge是连接ROS2与Ignition Gazebo的桥梁，ROS2与Ignition Gazebo使用的消息并不兼容，必须通过ros_gz_bridge进行转换。</p>

<p><strong>ros_gz_bridge使用语法</strong></p>

<p>ROS2与Ignition Gazebo的桥接是通过ros_gz_bridge包中的parameter_bridge节点实现，其使用语法如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>parameter_bridge <span class="o">[</span>&lt;topic@ROS2_type@Ign_type&gt; ..]  <span class="o">[</span>&lt;service@ROS2_srv_type[@Ign_req_type@Ign_rep_type]&gt; ..]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在话题Topic中， <strong>第一个@</strong> 符号是话题名称和消息类型的 <strong>分隔符</strong> 。</p>

<p>第一个@符号后面是ROS消息类型。</p>

<p>ROS消息类型后面是@、[或]符号：</p>

<ul>
  <li>
    <p><strong>@</strong>  表示双向桥接；</p>
  </li>
  <li>
    <p><strong>[</strong>  表示从Ignition Gazebo到ROS的桥接；</p>
  </li>
  <li>
    <p><strong>]</strong>  表示从ROS到Ignition Gazebo的桥接。</p>
  </li>
</ul>

<p>方向符号后是Gazebo Transport消息类型。</p>

<p>（两个@不是同一个含义）</p>

<p>在服务Service中， <strong>第一个@</strong> 符号是服务名称和类型的 <strong>分隔符</strong> 。</p>

<p>第一个@符号后面是ROS服务类型。可以选择地包括Gazebo请求和响应类型，在它们之间用@符号分隔。</p>

<p><strong>仅</strong> 支持将Gazebo服务公开为ROS服务，即ROS服务将请求转发到Gazebo服务，然后将响应转发回ROS客户端。</p>

<p>双向桥接示例：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>parameter_bridge /chatter@std_msgs/String@gz.msgs.StringMsg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从Gazebo到ROS的桥接示例：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>parameter_bridge /chatter@std_msgs/String[gz.msgs.StringMsg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从ROS到Gazebo的桥接示例：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>parameter_bridge /chatter@std_msgs/String]gz.msgs.StringMsg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>服务桥接示例：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>parameter_bridge /world/default/control@ros_gz_interfaces/srv/ControlWorld
或者：
parameter_bridge /world/default/control@ros_gz_interfaces/srv/ControlWorld@gz.msgs.WorldControl@gz.msgs.Boolean
</pre></td></tr></tbody></table></code></pre></div></div>

<p>也可以运行<code class="language-plaintext highlighter-rouge">ros2 run ros_gz_bridge parameter_bridge -h</code>指令查看官方说明文档。</p>

<p><strong>ros_gz_bridge支持的消息类型</strong></p>

<p>以下是ROS2与Ignition Gazebo中话题消息类型对应表：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ROS2消息类型</th>
      <th style="text-align: left">Gazebo Transport 类型</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">builtin_interfaces/msg/Time</td>
      <td style="text-align: left">gz.msgs.Time</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/Point</td>
      <td style="text-align: left">gz.msgs.Vector3d</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/Pose</td>
      <td style="text-align: left">gz.msgs.Pose</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/PoseArray</td>
      <td style="text-align: left">gz.msgs.Pose_V</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/PoseStamped</td>
      <td style="text-align: left">gz.msgs.Pose</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/PoseWithCovariance</td>
      <td style="text-align: left">gz.msgs.PoseWithCovariance</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/Quaternion</td>
      <td style="text-align: left">gz.msgs.Quaternion</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/Transform</td>
      <td style="text-align: left">gz.msgs.Pose</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/TransformStamped</td>
      <td style="text-align: left">gz.msgs.Pose</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">gz.msgs.Twist</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/TwistWithCovariance</td>
      <td style="text-align: left">gz.msgs.TwistWithCovariance</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/TwistWithCovarianceStamped</td>
      <td style="text-align: left">gz.msgs.TwistWithCovariance</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/Vector3</td>
      <td style="text-align: left">gz.msgs.Vector3d</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/Wrench</td>
      <td style="text-align: left">gz.msgs.Wrench</td>
    </tr>
    <tr>
      <td style="text-align: left">geometry_msgs/msg/WrenchStamped</td>
      <td style="text-align: left">gz.msgs.Wrench</td>
    </tr>
    <tr>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
      <td style="text-align: left">gz.msgs.Odometry</td>
    </tr>
    <tr>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
      <td style="text-align: left">gz.msgs.OdometryWithCovariance</td>
    </tr>
    <tr>
      <td style="text-align: left">rcl_interfaces/msg/ParameterValue</td>
      <td style="text-align: left">gz.msgs.Any</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/Altimeter</td>
      <td style="text-align: left">gz.msgs.Altimeter</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/Contact</td>
      <td style="text-align: left">gz.msgs.Contact</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/Contacts</td>
      <td style="text-align: left">gz.msgs.Contacts</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/Dataframe</td>
      <td style="text-align: left">gz.msgs.Dataframe</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/Entity</td>
      <td style="text-align: left">gz.msgs.Entity</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/Float32Array</td>
      <td style="text-align: left">gz.msgs.Float_V</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/GuiCamera</td>
      <td style="text-align: left">gz.msgs.GUICamera</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/JointWrench</td>
      <td style="text-align: left">gz.msgs.JointWrench</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/Light</td>
      <td style="text-align: left">gz.msgs.Light</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/SensorNoise</td>
      <td style="text-align: left">gz.msgs.SensorNoise</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/StringVec</td>
      <td style="text-align: left">gz.msgs.StringMsg_V</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/TrackVisual</td>
      <td style="text-align: left">gz.msgs.TrackVisual</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/VideoRecord</td>
      <td style="text-align: left">gz.msgs.VideoRecord</td>
    </tr>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/msg/WorldControl</td>
      <td style="text-align: left">gz.msgs.WorldControl</td>
    </tr>
    <tr>
      <td style="text-align: left">rosgraph_msgs/msg/Clock*</td>
      <td style="text-align: left">gz.msgs.Clock*</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/BatteryState</td>
      <td style="text-align: left">gz.msgs.BatteryState</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/CameraInfo</td>
      <td style="text-align: left">gz.msgs.CameraInfo</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/FluidPressure</td>
      <td style="text-align: left">gz.msgs.FluidPressure</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/Image</td>
      <td style="text-align: left">gz.msgs.Image</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/Imu</td>
      <td style="text-align: left">gz.msgs.IMU</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/JointState</td>
      <td style="text-align: left">gz.msgs.Model</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/Joy</td>
      <td style="text-align: left">gz.msgs.Joy</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">gz.msgs.LaserScan</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/MagneticField</td>
      <td style="text-align: left">gz.msgs.Magnetometer</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/NavSatFix</td>
      <td style="text-align: left">gz.msgs.NavSat</td>
    </tr>
    <tr>
      <td style="text-align: left">sensor_msgs/msg/PointCloud2</td>
      <td style="text-align: left">gz.msgs.PointCloudPacked</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/Bool</td>
      <td style="text-align: left">gz.msgs.Boolean</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/ColorRGBA</td>
      <td style="text-align: left">gz.msgs.Color</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/Empty</td>
      <td style="text-align: left">gz.msgs.Empty</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/Float32</td>
      <td style="text-align: left">gz.msgs.Float</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/Float64</td>
      <td style="text-align: left">gz.msgs.Double</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/Header</td>
      <td style="text-align: left">gz.msgs.Header</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/Int32</td>
      <td style="text-align: left">gz.msgs.Int32</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/String</td>
      <td style="text-align: left">gz.msgs.StringMsg</td>
    </tr>
    <tr>
      <td style="text-align: left">std_msgs/msg/UInt32</td>
      <td style="text-align: left">gz.msgs.UInt32</td>
    </tr>
    <tr>
      <td style="text-align: left">tf2_msgs/msg/TFMessage</td>
      <td style="text-align: left">gz.msgs.Pose_V</td>
    </tr>
    <tr>
      <td style="text-align: left">trajectory_msgs/msg/JointTrajectory</td>
      <td style="text-align: left">gz.msgs.JointTrajectory</td>
    </tr>
  </tbody>
</table>

<p>以及服务消息类型对应表：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ROS2消息类型</th>
      <th style="text-align: left">Gazebo 请求</th>
      <th style="text-align: left">Gazebo 响应</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ros_gz_interfaces/srv/ControlWorld</td>
      <td style="text-align: left">gz.msgs.WorldControl</td>
      <td style="text-align: left">gz.msgs.Boolean</td>
    </tr>
  </tbody>
</table>

<h3 id="与ros2集成优化">与ROS2集成优化</h3>

<p>在 <strong>Ignition Gazebo与ROS2集成</strong> 实现中需要在终端中使用不同的指令启动不同模块，该流程实现稍显复杂，本节将介绍如何以launch文件的方式进行优化。</p>

<p><strong>新建功能包</strong></p>

<p>请首先调用如下指令创建一个功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create demo_gazebo_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1721.webp" alt="" /></p>

<p><strong>添加目录</strong></p>

<p>在新建的功能包下添加目录： launch、rviz、world。并在CmakeLists.txt中添加如下代码：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>DIRECTORY rviz world launch DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>launch目录用于存储launch文件，rviz目录由于存储rviz2的配置文件，而world目录则用于存储Ignition Gazebo仿真环境的相关文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1722.webp" alt="" /></p>

<p><strong>rviz目录中生成rviz2的配置文件</strong></p>

<p>启动 rviz2，直接将默认配置保存至当前功能包的rviz目录，保存文件命名为sim.rviz。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1723.webp" alt="" /></p>

<p><strong>复制world文件</strong></p>

<p>在ignition安装路径下的worlds目录（<code class="language-plaintext highlighter-rouge">/usr/share/ignition/ignition-gazebo6/worlds</code>）中复制visualize_lidar.sdf文件至world目录。</p>

<p>如果该路径下没有，那可能在ROS的安装路径下：</p>

<p><code class="language-plaintext highlighter-rouge">/opt/ros/jazzy/opt/gz_sim_vendor/share/gz/gz-sim8/worlds/</code></p>

<p>如果还没有的话，手动查找一下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>find / <span class="nt">-name</span> <span class="s2">"visualize_lidar.sdf"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1724.webp" alt="" /></p>

<p><strong>编写launch文件</strong></p>

<p>launch目录下新建launch文件gazebo_sim_demo.launch.py，并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.conditions</span> <span class="kn">import</span> <span class="n">IfCondition</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>

<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">this_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">demo_gazebo_sim</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">pkg_ros_gz_sim</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">ros_gz_sim</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">world_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">this_pkg</span><span class="p">,</span><span class="sh">'</span><span class="s">world</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">visualize_lidar.sdf</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">gz_sim</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_ros_gz_sim</span><span class="p">,</span> <span class="sh">'</span><span class="s">launch</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">gz_sim.launch.py</span><span class="sh">'</span><span class="p">)),</span>
        <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">'</span><span class="s">gz_args</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">-r </span><span class="sh">'</span> <span class="o">+</span> <span class="n">world_file</span>
        <span class="p">}.</span><span class="nf">items</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># RViz
</span>    <span class="n">rviz</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
       <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
       <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
       <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">this_pkg</span><span class="p">,</span> <span class="sh">'</span><span class="s">rviz</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sim.rviz</span><span class="sh">'</span><span class="p">)],</span>
       <span class="n">condition</span><span class="o">=</span><span class="nc">IfCondition</span><span class="p">(</span><span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">rviz</span><span class="sh">'</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Bridge
</span>    <span class="n">bridge</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">ros_gz_bridge</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">parameter_bridge</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">/model/vehicle_blue/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">'</span><span class="p">,</span>
                   <span class="sh">'</span><span class="s">/model/vehicle_blue/odometry@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">'</span><span class="p">,</span>
                   <span class="sh">'</span><span class="s">/model/vehicle_blue/tf@tf2_msgs/msg/TFMessage[gz.msgs.Pose_V</span><span class="sh">'</span><span class="p">,</span>
                   <span class="p">],</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">'</span><span class="s">qos_overrides./model/vehicle_blue.subscriber.reliability</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">reliable</span><span class="sh">'</span><span class="p">}],</span>
        <span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="sh">'</span><span class="s">/model/vehicle_blue/tf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">/tf</span><span class="sh">'</span><span class="p">),</span>
                <span class="p">(</span><span class="sh">'</span><span class="s">/model/vehicle_blue/cmd_vel</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">cmd_vel</span><span class="sh">'</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">gz_sim</span><span class="p">,</span>
        <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="sh">'</span><span class="s">rviz</span><span class="sh">'</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
                              <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Open RViz.</span><span class="sh">'</span><span class="p">),</span>
        <span class="n">bridge</span><span class="p">,</span>
        <span class="n">rviz</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该launch文件中，启动了Ignition Gazebo仿真环境、通过ros_gz_bridge建立了仿真与ROS2的连接，并且启动了rviz2节点。其中建立连接时，实现了速度指令、里程计以及坐标变换等消息的转换。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1725.webp" alt="" /></p>

<p><strong>构建</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build  <span class="nt">--packages-select</span> demo_gazebo_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1726.webp" alt="" /></p>

<p><strong>执行</strong></p>

<p>终端中进入当前工作空间，调用如下指令执行launch文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch demo_gazebo_sim gazebo_sim_demo.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>新开终端，启动键盘控制节点：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run teleop_twist_keyboard teleop_twist_keyboard
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再配置rviz2，将<code class="language-plaintext highlighter-rouge">Fixed Frame</code>设置为<code class="language-plaintext highlighter-rouge">vehicle_blue/odom</code>，添加TF插件，添加Odometry插件并将话题设置为<code class="language-plaintext highlighter-rouge">/model/vehicle_blue/odometry</code>，当通过键盘控制发送速度指令时，仿真环境的机器人开始运动，并且在rviz2中可以回显坐标变换以及里程计等消息。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1727.webp" alt="" /></p>

<h3 id="仿真环境创建-sdf文件">仿真环境创建 <strong>SDF文件</strong></h3>

<p>前面几节内容我们使用的是Ignition Gazebo内置的仿真环境，本节开始将介绍如何自行搭建仿真环境。本节案例将仿真一个长10m宽5m的矩形房间。该案例可以先启动Ignition Gazebo以拖拽的方式搭建仿真环境，然后再修改仿真环境对应的文件以调整细节。</p>

<p><strong>SDF、URDF 和 Xacro 的关系：</strong></p>

<ul>
  <li>
    <p><strong>URDF 和 SDF 的区别：</strong></p>

    <ul>
      <li>
        <p><strong>复杂性：</strong> SDF 支持的功能更强大，能够描述完整的仿真环境；URDF 更适合定义机器人模型。</p>
      </li>
      <li>
        <p><strong>用途：</strong> URDF 是 ROS 的标准；SDF 是 Gazebo 的标准。</p>
      </li>
      <li>
        <p><strong>物理引擎支持：</strong> URDF 通过插件支持 Gazebo；SDF 原生支持 Gazebo。</p>
      </li>
      <li>
        <p><strong>格式转换：</strong> URDF 可以转换为 SDF（通过 ROS 提供的工具<code class="language-plaintext highlighter-rouge">gz sdf -p</code>）。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Xacro 的作用：</strong></p>

    <ul>
      <li>Xacro 是 URDF 的生成工具，帮助用户高效编写 URDF 文件，但它与 SDF 无直接关系。</li>
    </ul>
  </li>
</ul>

<hr />

<p><strong>实践建议</strong></p>

<ul>
  <li>
    <p><strong>在 Gazebo 仿真中：</strong> 如果你用的是 ROS 2 和 Gazebo，可以直接使用 SDF 文件，功能更强大。</p>
  </li>
  <li>
    <p><strong>在 ROS 中：</strong> 如果主要用于机器人控制和规划，推荐使用 URDF 或由 Xacro 生成的 URDF。</p>
  </li>
  <li>
    <p><strong>两者结合：</strong> 使用 URDF 进行控制，使用 SDF 进行仿真。例如，使用 URDF 定义机器人结构后，借助 Gazebo 插件将其转换为 SDF。</p>
  </li>
</ul>

<p><strong>示例对比</strong></p>

<p>URDF 示例：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"example_robot"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"1.0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"1.0"</span> <span class="na">ixy=</span><span class="s">"0.0"</span> <span class="na">ixz=</span><span class="s">"0.0"</span> <span class="na">iyy=</span><span class="s">"1.0"</span> <span class="na">iyz=</span><span class="s">"0.0"</span> <span class="na">izz=</span><span class="s">"1.0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
  <span class="nt">&lt;/link&gt;</span>
<span class="nt">&lt;/robot&gt;</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Xacro 示例（生成 URDF）：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;xacro:robot</span> <span class="na">xmlns:xacro=</span><span class="s">"http://www.ros.org/wiki/xacro"</span> <span class="na">name=</span><span class="s">"example_robot"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xacro:macro</span> <span class="na">name=</span><span class="s">"base_link"</span> <span class="na">params=</span><span class="s">"mass"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;inertial&gt;</span>
        <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"${mass}"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;inertia</span> <span class="na">ixx=</span><span class="s">"1.0"</span> <span class="na">ixy=</span><span class="s">"0.0"</span> <span class="na">ixz=</span><span class="s">"0.0"</span> <span class="na">iyy=</span><span class="s">"1.0"</span> <span class="na">iyz=</span><span class="s">"0.0"</span> <span class="na">izz=</span><span class="s">"1.0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;/xacro:macro&gt;</span>

  <span class="nt">&lt;xacro:base_link</span> <span class="na">mass=</span><span class="s">"1.0"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/xacro:robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>SDF 示例：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;sdf</span> <span class="na">version=</span><span class="s">"1.6"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">"example_robot"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;inertial&gt;</span>
        <span class="nt">&lt;mass&gt;</span>1.0<span class="nt">&lt;/mass&gt;</span>
        <span class="nt">&lt;inertia&gt;</span>
          <span class="nt">&lt;ixx&gt;</span>1.0<span class="nt">&lt;/ixx&gt;</span>
          <span class="nt">&lt;iyy&gt;</span>1.0<span class="nt">&lt;/iyy&gt;</span>
          <span class="nt">&lt;izz&gt;</span>1.0<span class="nt">&lt;/izz&gt;</span>
        <span class="nt">&lt;/inertia&gt;</span>
      <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;/link&gt;</span>
  <span class="nt">&lt;/model&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>1.创建sdf文件</strong></p>

<p>首先请调用指令<code class="language-plaintext highlighter-rouge">ign gazebo</code>启动Ignition Gazebo，选择Empty仿真环境，然后添加立方体，每一个立方体都对应一堵墙。</p>

<p>上下左右立方体box、box_1、box_2、box_3对应的坐标分别为(5.0,0.0,0.5)、(-5.0,0.0,0.5)、(0.0,2.5,0.5)、(0.0,-2.5,0.5)。</p>

<p>（以上坐标是指X，Y，Z坐标，没有旋转度）</p>

<p>保存文件到功能包的world目录下，保存的文件名称需要以.sdf为后缀，此处文件名为house.sdf。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1728.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1729.webp" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;sdf</span> <span class="na">version=</span><span class="s">'1.9'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;world</span> <span class="na">name=</span><span class="s">'empty'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;physics</span> <span class="na">name=</span><span class="s">'1ms'</span> <span class="na">type=</span><span class="s">'ignored'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;max_step_size&gt;</span>0.001<span class="nt">&lt;/max_step_size&gt;</span>
      <span class="nt">&lt;real_time_factor&gt;</span>1<span class="nt">&lt;/real_time_factor&gt;</span>
      <span class="nt">&lt;real_time_update_rate&gt;</span>1000<span class="nt">&lt;/real_time_update_rate&gt;</span>
    <span class="nt">&lt;/physics&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::Physics'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-physics-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::UserCommands'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-user-commands-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::SceneBroadcaster'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-scene-broadcaster-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::Contact'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-contact-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;gravity&gt;</span>0 0 -9.8<span class="nt">&lt;/gravity&gt;</span>
    <span class="nt">&lt;magnetic_field&gt;</span>6e-06 2.3e-05 -4.2e-05<span class="nt">&lt;/magnetic_field&gt;</span>
    <span class="nt">&lt;atmosphere</span> <span class="na">type=</span><span class="s">'adiabatic'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;scene&gt;</span>
      <span class="nt">&lt;ambient&gt;</span>0.4 0.4 0.4 1<span class="nt">&lt;/ambient&gt;</span>
      <span class="nt">&lt;background&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/background&gt;</span>
      <span class="nt">&lt;shadows&gt;</span>true<span class="nt">&lt;/shadows&gt;</span>
    <span class="nt">&lt;/scene&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'ground_plane'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;static&gt;</span>true<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;plane&gt;</span>
              <span class="nt">&lt;normal&gt;</span>0 0 1<span class="nt">&lt;/normal&gt;</span>
              <span class="nt">&lt;size&gt;</span>100 100<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/plane&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;plane&gt;</span>
              <span class="nt">&lt;normal&gt;</span>0 0 1<span class="nt">&lt;/normal&gt;</span>
              <span class="nt">&lt;size&gt;</span>100 100<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/plane&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>1<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>1<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>1<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>5.0 0 0.5 -0 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_0'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-5.0 -0 0.50000 -0 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_1'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0 -2.5 0.5 -0 -0 -0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_2'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0 2.5 0.5 0 -0 -0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;light</span> <span class="na">name=</span><span class="s">'sun'</span> <span class="na">type=</span><span class="s">'directional'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 10 0 -0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;cast_shadows&gt;</span>true<span class="nt">&lt;/cast_shadows&gt;</span>
      <span class="nt">&lt;intensity&gt;</span>1<span class="nt">&lt;/intensity&gt;</span>
      <span class="nt">&lt;direction&gt;</span>-0.5 0.1 -0.9<span class="nt">&lt;/direction&gt;</span>
      <span class="nt">&lt;diffuse&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/diffuse&gt;</span>
      <span class="nt">&lt;specular&gt;</span>0.2 0.2 0.2 1<span class="nt">&lt;/specular&gt;</span>
      <span class="nt">&lt;attenuation&gt;</span>
        <span class="nt">&lt;range&gt;</span>1000<span class="nt">&lt;/range&gt;</span>
        <span class="nt">&lt;linear&gt;</span>0.01<span class="nt">&lt;/linear&gt;</span>
        <span class="nt">&lt;constant&gt;</span>0.90000000000000002<span class="nt">&lt;/constant&gt;</span>
        <span class="nt">&lt;quadratic&gt;</span>0.001<span class="nt">&lt;/quadratic&gt;</span>
      <span class="nt">&lt;/attenuation&gt;</span>
      <span class="nt">&lt;spot&gt;</span>
        <span class="nt">&lt;inner_angle&gt;</span>0<span class="nt">&lt;/inner_angle&gt;</span>
        <span class="nt">&lt;outer_angle&gt;</span>0<span class="nt">&lt;/outer_angle&gt;</span>
        <span class="nt">&lt;falloff&gt;</span>0<span class="nt">&lt;/falloff&gt;</span>
      <span class="nt">&lt;/spot&gt;</span>
    <span class="nt">&lt;/light&gt;</span>
  <span class="nt">&lt;/world&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>2.修改sdf文件</strong></p>

<p>修改sdf文件，调整立方体的尺寸，实现墙体的合围。在sdf文件中，四个立方体分别对应了四个<code class="language-plaintext highlighter-rouge">&lt;model&gt;</code>标签，其<code class="language-plaintext highlighter-rouge">name</code>属性分别为<code class="language-plaintext highlighter-rouge">box</code>、<code class="language-plaintext highlighter-rouge">box_1</code>、<code class="language-plaintext highlighter-rouge">box_2</code>、<code class="language-plaintext highlighter-rouge">box_3</code>，将<code class="language-plaintext highlighter-rouge">box</code>和<code class="language-plaintext highlighter-rouge">box_1</code>中的<code class="language-plaintext highlighter-rouge">&lt;size&gt;1 1 1&lt;/size&gt;</code>修改为<code class="language-plaintext highlighter-rouge">&lt;size&gt;0.1 5 1&lt;/size&gt;</code>，将<code class="language-plaintext highlighter-rouge">box_2</code>和<code class="language-plaintext highlighter-rouge">box_3</code>中的<code class="language-plaintext highlighter-rouge">&lt;size&gt;1 1 1&lt;/size&gt;</code>修改为<code class="language-plaintext highlighter-rouge">&lt;size&gt;10 0.1 1&lt;/size&gt;</code>（<em>注意：每个</em><code class="language-plaintext highlighter-rouge">&lt;model&gt;</code><em>标签下，都包含两个</em><code class="language-plaintext highlighter-rouge">&lt;size&gt;</code><em>标签，分别位于</em><code class="language-plaintext highlighter-rouge">&lt;collision&gt;</code><em>标签和</em><code class="language-plaintext highlighter-rouge">&lt;visual&gt;</code><em>标签下，两个</em><code class="language-plaintext highlighter-rouge">&lt;size&gt;</code><em>标签内容都需要修改</em>）。</p>

<p>修改后与的house.sdf文件内容如下：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;sdf</span> <span class="na">version=</span><span class="s">'1.9'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;world</span> <span class="na">name=</span><span class="s">'empty'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;physics</span> <span class="na">name=</span><span class="s">'1ms'</span> <span class="na">type=</span><span class="s">'ignored'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;max_step_size&gt;</span>0.001<span class="nt">&lt;/max_step_size&gt;</span>
      <span class="nt">&lt;real_time_factor&gt;</span>1<span class="nt">&lt;/real_time_factor&gt;</span>
      <span class="nt">&lt;real_time_update_rate&gt;</span>1000<span class="nt">&lt;/real_time_update_rate&gt;</span>
    <span class="nt">&lt;/physics&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'ign::gazebo::systems::Physics'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-physics-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'ign::gazebo::systems::UserCommands'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-user-commands-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'ign::gazebo::systems::SceneBroadcaster'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-scene-broadcaster-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'ign::gazebo::systems::Contact'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-contact-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;gravity&gt;</span>0 0 -9.8<span class="nt">&lt;/gravity&gt;</span>
    <span class="nt">&lt;magnetic_field&gt;</span>6e-06 2.3e-05 -4.2e-05<span class="nt">&lt;/magnetic_field&gt;</span>
    <span class="nt">&lt;atmosphere</span> <span class="na">type=</span><span class="s">'adiabatic'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;scene&gt;</span>
      <span class="nt">&lt;ambient&gt;</span>0.4 0.4 0.4 1<span class="nt">&lt;/ambient&gt;</span>
      <span class="nt">&lt;background&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/background&gt;</span>
      <span class="nt">&lt;shadows&gt;</span>true<span class="nt">&lt;/shadows&gt;</span>
    <span class="nt">&lt;/scene&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'ground_plane'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;static&gt;</span>true<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;plane&gt;</span>
              <span class="nt">&lt;normal&gt;</span>0 0 1<span class="nt">&lt;/normal&gt;</span>
              <span class="nt">&lt;size&gt;</span>100 100<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/plane&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;plane&gt;</span>
              <span class="nt">&lt;normal&gt;</span>0 0 1<span class="nt">&lt;/normal&gt;</span>
              <span class="nt">&lt;size&gt;</span>100 100<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/plane&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>1<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>1<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>1<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>5.0 0 0.5 -0 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_0'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-5.0 -0 0.50000 -0 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_1'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0 -2.5 0.5 -0 -0 -0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_2'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0 2.5 0.5 0 -0 -0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;light</span> <span class="na">name=</span><span class="s">'sun'</span> <span class="na">type=</span><span class="s">'directional'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 10 0 -0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;cast_shadows&gt;</span>true<span class="nt">&lt;/cast_shadows&gt;</span>
      <span class="nt">&lt;intensity&gt;</span>1<span class="nt">&lt;/intensity&gt;</span>
      <span class="nt">&lt;direction&gt;</span>-0.5 0.1 -0.9<span class="nt">&lt;/direction&gt;</span>
      <span class="nt">&lt;diffuse&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/diffuse&gt;</span>
      <span class="nt">&lt;specular&gt;</span>0.2 0.2 0.2 1<span class="nt">&lt;/specular&gt;</span>
      <span class="nt">&lt;attenuation&gt;</span>
        <span class="nt">&lt;range&gt;</span>1000<span class="nt">&lt;/range&gt;</span>
        <span class="nt">&lt;linear&gt;</span>0.01<span class="nt">&lt;/linear&gt;</span>
        <span class="nt">&lt;constant&gt;</span>0.90000000000000002<span class="nt">&lt;/constant&gt;</span>
        <span class="nt">&lt;quadratic&gt;</span>0.001<span class="nt">&lt;/quadratic&gt;</span>
      <span class="nt">&lt;/attenuation&gt;</span>
      <span class="nt">&lt;spot&gt;</span>
        <span class="nt">&lt;inner_angle&gt;</span>0<span class="nt">&lt;/inner_angle&gt;</span>
        <span class="nt">&lt;outer_angle&gt;</span>0<span class="nt">&lt;/outer_angle&gt;</span>
        <span class="nt">&lt;falloff&gt;</span>0<span class="nt">&lt;/falloff&gt;</span>
      <span class="nt">&lt;/spot&gt;</span>
    <span class="nt">&lt;/light&gt;</span>
  <span class="nt">&lt;/world&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>3.编写launch文件</strong></p>

<p>在launch目录下新建launch文件gazebo_sim_world.launch.py，并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">this_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">demo_gazebo_sim</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">pkg_ros_gz_sim</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">ros_gz_sim</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">world_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">this_pkg</span><span class="p">,</span><span class="sh">"</span><span class="s">world</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">house.sdf</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">gz_sim</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_ros_gz_sim</span><span class="p">,</span> <span class="sh">'</span><span class="s">launch</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">gz_sim.launch.py</span><span class="sh">'</span><span class="p">)),</span>
        <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">'</span><span class="s">gz_args</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">-r </span><span class="sh">'</span> <span class="o">+</span> <span class="n">world_file</span>
        <span class="p">}.</span><span class="nf">items</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">gz_sim</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>4.构建</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build  <span class="nt">--packages-select</span> demo_gazebo_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>5.执行</strong></p>

<p>终端中进入当前工作空间，调用如下指令执行launch文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch demo_gazebo_sim gazebo_sim_world.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果如下图所示。</p>

<p>也可以根据个人喜好，继续设计房间模型。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1730.webp" alt="" /></p>

<h3 id="igng添加模型"><strong>IgnG添加模型</strong></h3>

<p>在Ignition Gazebo官网提供了许多仿真模型，可以自行下载并使用以优化仿真环境，使其更多样、美观且真实。</p>

<p><strong>资源下载</strong></p>

<p>仿真Ignition Gazebo的官方模型链接：</p>

<p>http://app.ignitionrobotics.org/fuel/models</p>

<p>自行选择仿真模型点击进入详情页面，然后点击下载按钮即可将模型资源保存到本地。</p>

<p>在用户目录下新建ign_models目录，将下载的资源解压缩到该目录以作备用。</p>

<p><strong>资源配置</strong></p>

<p>为了可以让Ignition Gazebo识别到模型资源，下一步还需要修改用户目录下的 .bashrc 文件，添加如下代码：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="c"># Humble版本一般是下面的，但是有可能会更新，如果不生效，请尝试Jazzy的宏</span>
<span class="nb">export </span><span class="nv">IGN_GAZEBO_RESOURCE_PATH</span><span class="o">=</span>~/ign_models

<span class="c"># Jazzy版本的宏改了，如下：</span>
<span class="nb">export </span><span class="nv">GZ_SIM_RESOURCE_PATH</span><span class="o">=</span>~/ign_models
</pre></td></tr></tbody></table></code></pre></div></div>

<p>https://gazebosim.org/docs/latest/fuel_insert/</p>

<p><strong>模型添加</strong></p>

<p>终端下进入功能包demo_gazebo_sim的world目录，使用指令<code class="language-plaintext highlighter-rouge">ign gazebo house.sdf</code> 或者<code class="language-plaintext highlighter-rouge">gz sim house.sdf</code>启动仿真环境，点击窗口右上的折叠按钮，搜索<code class="language-plaintext highlighter-rouge">Resource Spawner</code>并打开，点击<code class="language-plaintext highlighter-rouge">Local resources</code>并选择模型拖拽至仿真环境中。将修改后的内容保存至house.sdf文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1731.webp" alt="" /></p>

<p>正常下载资源后，这个local resources这里就会显示了</p>

<p>house.sdf文件示例内容如下：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;sdf</span> <span class="na">version=</span><span class="s">'1.9'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;world</span> <span class="na">name=</span><span class="s">'empty'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;physics</span> <span class="na">name=</span><span class="s">'1ms'</span> <span class="na">type=</span><span class="s">'ignored'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;max_step_size&gt;</span>0.001<span class="nt">&lt;/max_step_size&gt;</span>
      <span class="nt">&lt;real_time_factor&gt;</span>1<span class="nt">&lt;/real_time_factor&gt;</span>
      <span class="nt">&lt;real_time_update_rate&gt;</span>1000<span class="nt">&lt;/real_time_update_rate&gt;</span>
    <span class="nt">&lt;/physics&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::Physics'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-physics-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::UserCommands'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-user-commands-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::SceneBroadcaster'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-scene-broadcaster-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">'gz::sim::systems::Contact'</span> <span class="na">filename=</span><span class="s">'ignition-gazebo-contact-system'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;gravity&gt;</span>0 0 -9.8<span class="nt">&lt;/gravity&gt;</span>
    <span class="nt">&lt;magnetic_field&gt;</span>6e-06 2.3e-05 -4.2e-05<span class="nt">&lt;/magnetic_field&gt;</span>
    <span class="nt">&lt;atmosphere</span> <span class="na">type=</span><span class="s">'adiabatic'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;scene&gt;</span>
      <span class="nt">&lt;ambient&gt;</span>0.4 0.4 0.4 1<span class="nt">&lt;/ambient&gt;</span>
      <span class="nt">&lt;background&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/background&gt;</span>
      <span class="nt">&lt;shadows&gt;</span>true<span class="nt">&lt;/shadows&gt;</span>
    <span class="nt">&lt;/scene&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'ground_plane'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;static&gt;</span>true<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;plane&gt;</span>
              <span class="nt">&lt;normal&gt;</span>0 0 1<span class="nt">&lt;/normal&gt;</span>
              <span class="nt">&lt;size&gt;</span>100 100<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/plane&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;plane&gt;</span>
              <span class="nt">&lt;normal&gt;</span>0 0 1<span class="nt">&lt;/normal&gt;</span>
              <span class="nt">&lt;size&gt;</span>100 100<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/plane&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>1<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>1<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>1<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>5.02632 -2e-06 0.500002 -0 4.4e-05 4.6e-05<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_0'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-5.01336 -0.00029 0.500002 0 -4.2e-05 -0.005335<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>0.1 5 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_1'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0 -2.5 0.5 1e-06 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">'box_2'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0.000154 2.52488 0.500821 -0.018068 -0 -0.003156<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'box_link'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;inertial&gt;</span>
          <span class="nt">&lt;inertia&gt;</span>
            <span class="nt">&lt;ixx&gt;</span>16.666<span class="nt">&lt;/ixx&gt;</span>
            <span class="nt">&lt;ixy&gt;</span>0<span class="nt">&lt;/ixy&gt;</span>
            <span class="nt">&lt;ixz&gt;</span>0<span class="nt">&lt;/ixz&gt;</span>
            <span class="nt">&lt;iyy&gt;</span>16.666<span class="nt">&lt;/iyy&gt;</span>
            <span class="nt">&lt;iyz&gt;</span>0<span class="nt">&lt;/iyz&gt;</span>
            <span class="nt">&lt;izz&gt;</span>16.666<span class="nt">&lt;/izz&gt;</span>
          <span class="nt">&lt;/inertia&gt;</span>
          <span class="nt">&lt;mass&gt;</span>100<span class="nt">&lt;/mass&gt;</span>
          <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;/inertial&gt;</span>
        <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'box_collision'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;surface&gt;</span>
            <span class="nt">&lt;friction&gt;</span>
              <span class="nt">&lt;ode/&gt;</span>
            <span class="nt">&lt;/friction&gt;</span>
            <span class="nt">&lt;bounce/&gt;</span>
            <span class="nt">&lt;contact/&gt;</span>
          <span class="nt">&lt;/surface&gt;</span>
        <span class="nt">&lt;/collision&gt;</span>
        <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'box_visual'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;geometry&gt;</span>
            <span class="nt">&lt;box&gt;</span>
              <span class="nt">&lt;size&gt;</span>10 0.1 1<span class="nt">&lt;/size&gt;</span>
            <span class="nt">&lt;/box&gt;</span>
          <span class="nt">&lt;/geometry&gt;</span>
          <span class="nt">&lt;material&gt;</span>
            <span class="nt">&lt;ambient&gt;</span>0.3 0.3 0.3 1<span class="nt">&lt;/ambient&gt;</span>
            <span class="nt">&lt;diffuse&gt;</span>0.7 0.7 0.7 1<span class="nt">&lt;/diffuse&gt;</span>
            <span class="nt">&lt;specular&gt;</span>1 1 1 1<span class="nt">&lt;/specular&gt;</span>
          <span class="nt">&lt;/material&gt;</span>
        <span class="nt">&lt;/visual&gt;</span>
        <span class="nt">&lt;pose&gt;</span>0 0 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
        <span class="nt">&lt;enable_wind&gt;</span>false<span class="nt">&lt;/enable_wind&gt;</span>
      <span class="nt">&lt;/link&gt;</span>
      <span class="nt">&lt;static&gt;</span>false<span class="nt">&lt;/static&gt;</span>
      <span class="nt">&lt;self_collide&gt;</span>false<span class="nt">&lt;/self_collide&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Bed<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>Bed<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>2.82155 1.18752 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Office Desk<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>Desk<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>2.78306 -1.97796 0 0 -0 1.57<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Bathtub<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>Bathtub<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-3.87509 1.82783 0 0 -0 0<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Vanity<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>Vanity<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-2.5974 1.85613 -0.010992 0.021648 0 -1.57<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Vanity<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>Vanity_1<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-2.5974 0.634325 -0.010992 0.021648 0 -1.57<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Dining Table<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>DiningTable<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0.374337 1.33602 0 0 0 -1.57<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Chair<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>Chair<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>2.79762 -1.26474 -0 -0 0 -2.3062<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>file://Sofa<span class="nt">&lt;/uri&gt;</span>
      <span class="nt">&lt;name&gt;</span>Sofa<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;pose&gt;</span>-0.546136 -1.92328 0.000119 -0 0 1.57<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;light</span> <span class="na">name=</span><span class="s">'sun'</span> <span class="na">type=</span><span class="s">'directional'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 10 0 -0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;cast_shadows&gt;</span>true<span class="nt">&lt;/cast_shadows&gt;</span>
      <span class="nt">&lt;intensity&gt;</span>1<span class="nt">&lt;/intensity&gt;</span>
      <span class="nt">&lt;direction&gt;</span>-0.5 0.1 -0.9<span class="nt">&lt;/direction&gt;</span>
      <span class="nt">&lt;diffuse&gt;</span>0.8 0.8 0.8 1<span class="nt">&lt;/diffuse&gt;</span>
      <span class="nt">&lt;specular&gt;</span>0.2 0.2 0.2 1<span class="nt">&lt;/specular&gt;</span>
      <span class="nt">&lt;attenuation&gt;</span>
        <span class="nt">&lt;range&gt;</span>1000<span class="nt">&lt;/range&gt;</span>
        <span class="nt">&lt;linear&gt;</span>0.01<span class="nt">&lt;/linear&gt;</span>
        <span class="nt">&lt;constant&gt;</span>0.90000000000000002<span class="nt">&lt;/constant&gt;</span>
        <span class="nt">&lt;quadratic&gt;</span>0.001<span class="nt">&lt;/quadratic&gt;</span>
      <span class="nt">&lt;/attenuation&gt;</span>
      <span class="nt">&lt;spot&gt;</span>
        <span class="nt">&lt;inner_angle&gt;</span>0<span class="nt">&lt;/inner_angle&gt;</span>
        <span class="nt">&lt;outer_angle&gt;</span>0<span class="nt">&lt;/outer_angle&gt;</span>
        <span class="nt">&lt;falloff&gt;</span>0<span class="nt">&lt;/falloff&gt;</span>
      <span class="nt">&lt;/spot&gt;</span>
    <span class="nt">&lt;/light&gt;</span>
  <span class="nt">&lt;/world&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>构建</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build  <span class="nt">--packages-select</span> demo_gazebo_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>执行</strong></p>

<p>终端中进入当前工作空间，调用如下指令执行launch文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch demo_gazebo_sim gazebo_sim_world.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果如下图所示。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1732.webp" alt="" /></p>

<h3 id="igng添加机器人">IgnG添加机器人</h3>

<p>Ignition Gazebo中可以直接创建机器人模型，或者也可以加载ROS2中URDF格式的机器人模型，此处我们使用后者（也可以选择用自己的urdf小车，但是注意修改launch的路径）。</p>

<p>我没有用赵虚左老师的mycar_description，用的自己的小车模型，后面的一系列源码都在下方这个Github仓库中，需要的可以自行clone.</p>

<p>https://github.com/tungchiahui/ROS2_WS/tree/main/6.ws_simulations</p>

<p><strong>准备机器人模型功能包</strong></p>

<p>复制机器人描述功能包mycar_description到工作空间的src目录，ign_models中新建mycar_description目录，并将功能包mycar_description下的mesh目录复制进ign_models中的mycar_description目录。</p>

<p><strong>机器人模型功能包下新建launch文件</strong></p>

<p>新建launch文件mycar_desc_sim.launch.py，并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="n">launch_ros.parameter_descriptions</span> <span class="kn">import</span> <span class="n">ParameterValue</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">Command</span><span class="p">,</span><span class="n">LaunchConfiguration</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>

<span class="c1">#示例： ros2 launch cpp06_urdf display.launch.py model:=`ros2 pkg prefix --share cpp06_urdf`/urdf/urdf/demo01_helloworld.urdf
</span><span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">MYCAR_MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">MYCAR_MODEL</span><span class="sh">'</span><span class="p">]</span>

    <span class="n">mycar_description</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_description</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">default_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">mycar_description</span><span class="p">,</span><span class="sh">"</span><span class="s">urdf</span><span class="sh">"</span><span class="p">,</span><span class="n">MYCAR_MODEL</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.urdf</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">default_model_path</span><span class="p">)</span>

    <span class="c1"># 加载机器人模型
</span>
    <span class="c1"># 启动 robot_state_publisher 节点并以参数方式加载 urdf 文件
</span>    <span class="n">robot_description</span> <span class="o">=</span> <span class="nc">ParameterValue</span><span class="p">(</span><span class="nc">Command</span><span class="p">([</span><span class="sh">"</span><span class="s">xacro </span><span class="sh">"</span><span class="p">,</span><span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)]))</span>
    <span class="n">robot_state_publisher</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">robot_state_publisher</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">robot_description</span><span class="sh">"</span><span class="p">:</span> <span class="n">robot_description</span><span class="p">}]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">robot_state_publisher</span><span class="p">,</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>较之于以往该文件缺少了joint_state_publisher节点，该节点作用是发布活动关节状态，这一功能后续由ignition实现。</p>

<p><strong>添加机器人模型</strong></p>

<p>修改gazebo_sim_world.launch.py文件，包含机器人模型的发布文件并在Gazebo中生成机器人模型，修改后的代码如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">this_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">demo_gazebo_sim</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">mycar_desc_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_description</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pkg_ros_gz_sim</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">ros_gz_sim</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">world_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">this_pkg</span><span class="p">,</span><span class="sh">"</span><span class="s">world</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">house.sdf</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">gz_sim</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_ros_gz_sim</span><span class="p">,</span> <span class="sh">"</span><span class="s">launch</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gz_sim.launch.py</span><span class="sh">"</span><span class="p">)),</span>
        <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">gz_args</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">-r </span><span class="sh">"</span> <span class="o">+</span> <span class="n">world_file</span>
        <span class="p">}.</span><span class="nf">items</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">mycar_desc</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">mycar_desc_pkg</span><span class="p">,</span><span class="sh">"</span><span class="s">launch</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">mycar_desc_sim.launch.py</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">spawn</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_sim</span><span class="sh">"</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">create</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
                <span class="sh">"</span><span class="s">-name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mycar</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">-x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">-z</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0.01</span><span class="sh">"</span><span class="p">,</span> <span class="c1">#设置为0,可能会陷进地里
</span>                <span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">-topic</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/robot_description</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">gz_sim</span><span class="p">,</span>
        <span class="n">spawn</span><span class="p">,</span>
        <span class="n">mycar_desc</span><span class="p">,</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>构建</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_description demo_gazebo_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>执行</strong></p>

<p>终端中进入当前工作空间，调用如下指令执行launch文件：（执行起来有问题的话，你只要学过urdf怎么跑，应该拥有自我寻找错误的能力了，自己找吧）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash

<span class="c"># MYCAR_MODEL值可以设置为arduino、stm32_2w 或stm32_4w（这个是具体的urdf文件名，在mycar_description包下的）</span>
<span class="nb">export </span><span class="nv">MYCAR_MODEL</span><span class="o">=</span>stm32_4w
ros2 launch demo_gazebo_sim gazebo_sim_world.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果如下图所示。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1733.webp" alt="" /></p>

<h3 id="-igng运动控制器实质上就是标签">   IgnG运动控制器(实质上就是<gazebo>标签)</gazebo></h3>

<p>本节将介绍如何让你的机器人动起来。</p>

<p>原理就是给urdf或xacro等添加<gazebo>标签：</gazebo></p>

<p>http://sdformat.org/tutorials?tut=sdformat_urdf_extensions&amp;cat=specification&amp;</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1734.webp" alt="" /></p>

<p>https://gazebosim.org/api/plugin/2/index.html</p>

<p>安装库：</p>

<p>https://gazebosim.org/api/plugin/2/installation.html</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>lsb-release
<span class="nb">sudo </span>sh <span class="nt">-c</span> <span class="s1">'echo "deb http://packages.osrfoundation.org/gazebo/ubuntu-stable `lsb_release -cs` main" &gt; /etc/apt/sources.list.d/gazebo-stable.list'</span>
wget http://packages.osrfoundation.org/gazebo.key <span class="nt">-O</span> - | <span class="nb">sudo </span>apt-key add -
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt <span class="nb">install </span>libgz-plugin2-dev
</pre></td></tr></tbody></table></code></pre></div></div>

<p>利用插件去让小车动，比如有两轮差速插件，四轮麦轮插件等等</p>

<p>同时该插件还提供了一些可以控制输出的选项，因为是仿真，所以还要告诉插件轮子对应的joint名称等信息，这样就有了下面这个参数表格：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">配置项</th>
      <th style="text-align: left">含义</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ros</td>
      <td style="text-align: left">ros相关配置，包含命名空间和话题重映射等</td>
    </tr>
    <tr>
      <td style="text-align: left">update_rate</td>
      <td style="text-align: left">数据更新速率</td>
    </tr>
    <tr>
      <td style="text-align: left">left_joint</td>
      <td style="text-align: left">左轮关节名称</td>
    </tr>
    <tr>
      <td style="text-align: left">right_joint</td>
      <td style="text-align: left">右轮关节名称</td>
    </tr>
    <tr>
      <td style="text-align: left">wheel_separation</td>
      <td style="text-align: left">左右轮子的间距</td>
    </tr>
    <tr>
      <td style="text-align: left">wheel_diameter</td>
      <td style="text-align: left">轮子的直径</td>
    </tr>
    <tr>
      <td style="text-align: left">max_wheel_torque</td>
      <td style="text-align: left">轮子最大的力矩</td>
    </tr>
    <tr>
      <td style="text-align: left">max_wheel_acceleration</td>
      <td style="text-align: left">轮子最大的加速度</td>
    </tr>
    <tr>
      <td style="text-align: left">publish_odom</td>
      <td style="text-align: left">是否发布里程计</td>
    </tr>
    <tr>
      <td style="text-align: left">publish_odom_tf</td>
      <td style="text-align: left">是否发布里程计的tf开关</td>
    </tr>
    <tr>
      <td style="text-align: left">publish_wheel_tf</td>
      <td style="text-align: left">是否发布轮子的tf数据开关</td>
    </tr>
    <tr>
      <td style="text-align: left">odometry_frame</td>
      <td style="text-align: left">里程计的framed ID，最终体现在话题和TF上</td>
    </tr>
    <tr>
      <td style="text-align: left">robot_base_frame</td>
      <td style="text-align: left">机器人的基础frame的ID</td>
    </tr>
  </tbody>
</table>

<p><strong>修改URDF文件</strong></p>

<p>arduino.urdf 和 stm32_2w.urdf 文件中，在<code class="language-plaintext highlighter-rouge">&lt;robot&gt;</code>根标签下添加如下代码：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>
  <span class="nt">&lt;gazebo&gt;</span>
      <span class="nt">&lt;plugin</span> <span class="na">filename=</span><span class="s">"libignition-gazebo-diff-drive-system.so"</span>
        <span class="na">name=</span><span class="s">"ignition::gazebo::systems::DiffDrive"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;left_joint&gt;</span>left_joint<span class="nt">&lt;/left_joint&gt;</span>
        <span class="nt">&lt;right_joint&gt;</span>right_joint<span class="nt">&lt;/right_joint&gt;</span>
        <span class="nt">&lt;wheel_separation&gt;</span>0.2097<span class="nt">&lt;/wheel_separation&gt;</span>
        <span class="nt">&lt;wheel_radius&gt;</span>0.03415<span class="nt">&lt;/wheel_radius&gt;</span>
        <span class="nt">&lt;odom_publish_frequency&gt;</span>10<span class="nt">&lt;/odom_publish_frequency&gt;</span>
        <span class="nt">&lt;frame_id&gt;</span>odom<span class="nt">&lt;/frame_id&gt;</span>
        <span class="nt">&lt;child_frame_id&gt;</span>base_footprint<span class="nt">&lt;/child_frame_id&gt;</span>
        <span class="nt">&lt;topic&gt;</span>/cmd_vel<span class="nt">&lt;/topic&gt;</span>
        <span class="nt">&lt;max_linear_acceleration&gt;</span>10<span class="nt">&lt;/max_linear_acceleration&gt;</span>
        <span class="nt">&lt;min_linear_acceleration&gt;</span>-10<span class="nt">&lt;/min_linear_acceleration&gt;</span>
        <span class="nt">&lt;max_angular_acceleration&gt;</span>10<span class="nt">&lt;/max_angular_acceleration&gt;</span>
        <span class="nt">&lt;min_angular_acceleration&gt;</span>-10<span class="nt">&lt;/min_angular_acceleration&gt;</span>
        <span class="nt">&lt;max_linear_velocity&gt;</span>0.5<span class="nt">&lt;/max_linear_velocity&gt;</span>
        <span class="nt">&lt;min_linear_velocity&gt;</span>-0.5<span class="nt">&lt;/min_linear_velocity&gt;</span>
        <span class="nt">&lt;max_angular_velocity&gt;</span>1<span class="nt">&lt;/max_angular_velocity&gt;</span>
        <span class="nt">&lt;min_angular_velocity&gt;</span>-1<span class="nt">&lt;/min_angular_velocity&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>

  <span class="nt">&lt;/gazebo&gt;</span>

  <span class="nt">&lt;gazebo&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">filename=</span><span class="s">"ignition-gazebo-joint-state-publisher-system"</span>
      <span class="na">name=</span><span class="s">"ignition::gazebo::systems::JointStatePublisher"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>stm32_4w.urdf 文件中，在<code class="language-plaintext highlighter-rouge">&lt;robot&gt;</code>根标签下添加如下代码：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>
<span class="nt">&lt;gazebo&gt;</span>
    <span class="nt">&lt;plugin</span>
        <span class="na">filename=</span><span class="s">"ignition-gazebo-diff-drive-system"</span>
        <span class="na">name=</span><span class="s">"ignition::gazebo::systems::DiffDrive"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;left_joint&gt;</span>left_former_joint<span class="nt">&lt;/left_joint&gt;</span>
        <span class="nt">&lt;left_joint&gt;</span>left_rear_joint<span class="nt">&lt;/left_joint&gt;</span>
        <span class="nt">&lt;right_joint&gt;</span>right_former_joint<span class="nt">&lt;/right_joint&gt;</span>
        <span class="nt">&lt;right_joint&gt;</span>right_rear_joint<span class="nt">&lt;/right_joint&gt;</span>
        <span class="nt">&lt;wheel_separation&gt;</span>0.4<span class="nt">&lt;/wheel_separation&gt;</span>
        <span class="nt">&lt;wheel_radius&gt;</span>0.0415<span class="nt">&lt;/wheel_radius&gt;</span>
        <span class="nt">&lt;odom_publish_frequency&gt;</span>50<span class="nt">&lt;/odom_publish_frequency&gt;</span>
        <span class="nt">&lt;frame_id&gt;</span>odom<span class="nt">&lt;/frame_id&gt;</span>
        <span class="nt">&lt;child_frame_id&gt;</span>base_footprint<span class="nt">&lt;/child_frame_id&gt;</span>
        <span class="nt">&lt;topic&gt;</span>/cmd_vel<span class="nt">&lt;/topic&gt;</span>
        <span class="nt">&lt;max_linear_acceleration&gt;</span>10<span class="nt">&lt;/max_linear_acceleration&gt;</span>
        <span class="nt">&lt;min_linear_acceleration&gt;</span>-10<span class="nt">&lt;/min_linear_acceleration&gt;</span>
        <span class="nt">&lt;max_angular_acceleration&gt;</span>10<span class="nt">&lt;/max_angular_acceleration&gt;</span>
        <span class="nt">&lt;min_angular_acceleration&gt;</span>-10<span class="nt">&lt;/min_angular_acceleration&gt;</span>
        <span class="nt">&lt;max_linear_velocity&gt;</span>0.5<span class="nt">&lt;/max_linear_velocity&gt;</span>
        <span class="nt">&lt;min_linear_velocity&gt;</span>-0.5<span class="nt">&lt;/min_linear_velocity&gt;</span>
        <span class="nt">&lt;max_angular_velocity&gt;</span>1<span class="nt">&lt;/max_angular_velocity&gt;</span>
        <span class="nt">&lt;min_angular_velocity&gt;</span>-1<span class="nt">&lt;/min_angular_velocity&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

  <span class="nt">&lt;gazebo&gt;</span>
    <span class="nt">&lt;plugin</span> <span class="na">filename=</span><span class="s">"ignition-gazebo-joint-state-publisher-system"</span>
      <span class="na">name=</span><span class="s">"ignition::gazebo::systems::JointStatePublisher"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果是麦轮（ROS1的，ROS2的待更新）（把轮子关节设置为自己轮子关节名即可）：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">"mycar"</span> <span class="na">xmlns:xacro=</span><span class="s">"http://wiki.ros.org/xacro"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xacro:macro</span> <span class="na">name=</span><span class="s">"joint_trans"</span> <span class="na">params=</span><span class="s">"joint_name"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;transmission</span> <span class="na">name=</span><span class="s">"${joint_name}_trans"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;type&gt;</span>transmission_interface/SimpleTransmission<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"${joint_name}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;hardwareInterface&gt;</span>hardware_interface/VelocityJointInterface<span class="nt">&lt;/hardwareInterface&gt;</span>
            <span class="nt">&lt;/joint&gt;</span>
            <span class="nt">&lt;actuator</span> <span class="na">name=</span><span class="s">"${joint_name}_motor"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;hardwareInterface&gt;</span>hardware_interface/VelocityJointInterface<span class="nt">&lt;/hardwareInterface&gt;</span>
                <span class="nt">&lt;mechanicalReduction&gt;</span>1<span class="nt">&lt;/mechanicalReduction&gt;</span>
            <span class="nt">&lt;/actuator&gt;</span>
        <span class="nt">&lt;/transmission&gt;</span>
    <span class="nt">&lt;/xacro:macro&gt;</span>

    <span class="nt">&lt;xacro:joint_trans</span> <span class="na">joint_name=</span><span class="s">"LeftFrontwheelToBase"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:joint_trans</span> <span class="na">joint_name=</span><span class="s">"LeftBackwheelToBase"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:joint_trans</span> <span class="na">joint_name=</span><span class="s">"RightFrontwheelToBase"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;xacro:joint_trans</span> <span class="na">joint_name=</span><span class="s">"RightBackwheelToBase"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;gazebo&gt;</span>
        <span class="nt">&lt;plugin</span> <span class="na">name=</span><span class="s">"mecanum_controller"</span> <span class="na">filename=</span><span class="s">"libgazebo_ros_planar_move.so"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;commandTopic&gt;</span>cmd_vel<span class="nt">&lt;/commandTopic&gt;</span>
            <span class="nt">&lt;odometryTopic&gt;</span>odom<span class="nt">&lt;/odometryTopic&gt;</span>
            <span class="nt">&lt;odometryFrame&gt;</span>odom<span class="nt">&lt;/odometryFrame&gt;</span>
            <span class="nt">&lt;leftFrontJoint&gt;</span>LeftFrontwheelToBase<span class="nt">&lt;/leftFrontJoint&gt;</span>
            <span class="nt">&lt;rightFrontJoint&gt;</span>RightFrontwheelToBase<span class="nt">&lt;/rightFrontJoint&gt;</span>
            <span class="nt">&lt;leftRearJoint&gt;</span>LeftBackwheelToBase<span class="nt">&lt;/leftRearJoint&gt;</span>
            <span class="nt">&lt;rightRearJoint&gt;</span>RightBackwheelToBase<span class="nt">&lt;/rightRearJoint&gt;</span>
            <span class="nt">&lt;odometryRate&gt;</span>100<span class="nt">&lt;/odometryRate&gt;</span>
            <span class="nt">&lt;robotBaseFrame&gt;</span>base_footprint<span class="nt">&lt;/robotBaseFrame&gt;</span>
            <span class="nt">&lt;broadcastTF&gt;</span>1<span class="nt">&lt;/broadcastTF&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span>

<span class="nt">&lt;/robot&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>修改launch文件</strong></p>

<p>修改gazebo_sim_world.launch.py文件，修改后的代码如下：</p>

<pre><code class="language-JavaScript">import os

from ament_index_python.packages import get_package_share_directory

from launch import LaunchDescription
from launch.actions import IncludeLaunchDescription
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch_ros.actions import Node

def generate_launch_description():

    this_pkg = get_package_share_directory("demo_gazebo_sim")
    mycar_desc_pkg = get_package_share_directory("mycar_description")
    pkg_ros_gz_sim = get_package_share_directory("ros_gz_sim")
    world_file = os.path.join(this_pkg,"world","base.sdf")

    gz_sim = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(pkg_ros_gz_sim, "launch", "gz_sim.launch.py")),
        launch_arguments={
            "gz_args": "-r " + world_file
        }.items(),
    )
    mycar_desc = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(mycar_desc_pkg,"launch","mycar_desc_sim.launch.py")
        )
    )
    spawn = Node(package="ros_gz_sim", executable="create",
                arguments=[
                "-name", "mycar",
                "-x", "-4",
                "-z", "0.01", #设置为0,可能会陷进地里
                "-y", "0",
                "-topic", "/robot_description"],
            output="screen")

    # Bridge
    bridge = Node(
        package="ros_gz_bridge",
        executable="parameter_bridge",
        arguments=["/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist",
                   "/model/mycar/odometry@nav_msgs/msg/Odometry@gz.msgs.Odometry",
                   "/model/mycar/tf@tf2_msgs/msg/TFMessage[gz.msgs.Pose_V",
                   "/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock",
                   "/world/empty/model/mycar/joint_state@sensor_msgs/msg/JointState[gz.msgs.Model",
                   ],
        parameters=[{"qos_overrides./model/mycar.subscriber.reliability": "reliable"}],
        remappings=[
                ("/model/mycar/tf", "/tf"),
                ("/world/empty/model/mycar/joint_state","joint_states"),
                ("/model/mycar/odometry","/odom")
            ],
        output="screen"
    )

    return LaunchDescription([
        gz_sim,
        spawn,
        mycar_desc,
        bridge
    ])
</code></pre>

<p><strong>构建</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_description demo_gazebo_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>执行</strong></p>

<p>终端中进入当前工作空间，调用如下指令执行launch文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
<span class="nb">export </span><span class="nv">MYCAR_MODEL</span><span class="o">=</span>stm32_4w <span class="c"># MYCAR_MODEL值可以设置为arduino、stm32_2w 或stm32_4w（这个是具体的urdf文件名，在mycar_description包下的）</span>
ros2 launch demo_gazebo_sim gazebo_sim_world.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再启动键盘控制节点，就可以控制机器人运动了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run teleop_twist_keyboard teleop_twist_keyboard
</pre></td></tr></tbody></table></code></pre></div></div>

<p>还可以启动rviz2，以查看里程计消息以及坐标变换。终端中进入当前工作空间，调用如下指令执行launch文件：</p>

<p>启动rviz2</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
rviz2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>RVIZ2软件配置如下图所示：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1735.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1736.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1737.webp" alt="" /></p>

<h3 id="ignition-gazebo仿真之传感器">Ignition Gazebo仿真之传感器</h3>

<p>本节将介绍如何为仿真机器人添加雷达、相机等传感器。本节代码部分内容对于我们教程中涉及到的arduino、stm32_2w以及stm32_4w等机器人模型而言是完全通用的。</p>

<p><strong>添加传感器插件</strong></p>

<p>在进行传感器模拟之前，需要先添加一个名为<code class="language-plaintext highlighter-rouge">ignition-gazebo-sensors-system</code>的插件，打开urdf文件，在<code class="language-plaintext highlighter-rouge">&lt;robot&gt;</code>根标签内添加如下代码：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
<span class="nt">&lt;gazebo&gt;</span>
    <span class="nt">&lt;plugin</span>
      <span class="na">filename=</span><span class="s">"ignition-gazebo-sensors-system"</span>
      <span class="na">name=</span><span class="s">"ignition::gazebo::systems::Sensors"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;render_engine&gt;</span>ogre2<span class="nt">&lt;/render_engine&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ignition-gazebo-sensors-system是Ignition Gazebo仿真环境的插件，提供传感器模型和相关功能，用于创建、模拟和测试各种传感器设备。它包含常见传感器模型，如摄像头、激光雷达等。</p>

<p><strong>添加各种传感器</strong></p>

<p><strong>(注意，你的模型一定要有以下几个传感器的模型)</strong></p>

<p>雷达的模型不需要collision，请删掉，否则会挡激光射出。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre>
  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"laser"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">'gpu_lidar'</span> <span class="na">type=</span><span class="s">'gpu_lidar'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;topic&gt;</span>scan<span class="nt">&lt;/topic&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>30<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;lidar&gt;</span>
        <span class="nt">&lt;scan&gt;</span>
          <span class="nt">&lt;horizontal&gt;</span>
            <span class="nt">&lt;samples&gt;</span>640<span class="nt">&lt;/samples&gt;</span>
            <span class="nt">&lt;resolution&gt;</span>1<span class="nt">&lt;/resolution&gt;</span>
            <span class="nt">&lt;min_angle&gt;</span>-3.1415926<span class="nt">&lt;/min_angle&gt;</span>
            <span class="nt">&lt;max_angle&gt;</span>3.1415926<span class="nt">&lt;/max_angle&gt;</span>
          <span class="nt">&lt;/horizontal&gt;</span>
          <span class="nt">&lt;vertical&gt;</span>
            <span class="nt">&lt;samples&gt;</span>16<span class="nt">&lt;/samples&gt;</span>
            <span class="nt">&lt;resolution&gt;</span>1<span class="nt">&lt;/resolution&gt;</span>
            <span class="nt">&lt;min_angle&gt;</span>-0.261799<span class="nt">&lt;/min_angle&gt;</span>
            <span class="nt">&lt;max_angle&gt;</span>0.261799<span class="nt">&lt;/max_angle&gt;</span>
          <span class="nt">&lt;/vertical&gt;</span>
        <span class="nt">&lt;/scan&gt;</span>
        <span class="nt">&lt;range&gt;</span>
          <span class="nt">&lt;min&gt;</span>0.08<span class="nt">&lt;/min&gt;</span>
          <span class="nt">&lt;max&gt;</span>10.0<span class="nt">&lt;/max&gt;</span>
          <span class="nt">&lt;resolution&gt;</span>0.01<span class="nt">&lt;/resolution&gt;</span>
        <span class="nt">&lt;/range&gt;</span>
      <span class="nt">&lt;/lidar&gt;</span>
      <span class="nt">&lt;alwaysOn&gt;</span>1<span class="nt">&lt;/alwaysOn&gt;</span>
      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
      <span class="nt">&lt;ignition_frame_id&gt;</span>laser<span class="nt">&lt;/ignition_frame_id&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"camera"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"cam_link"</span> <span class="na">type=</span><span class="s">"camera"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>10.0<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>true<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;ignition_frame_id&gt;</span>camera<span class="nt">&lt;/ignition_frame_id&gt;</span>
      <span class="nt">&lt;pose&gt;</span>0 0 0 0 0 0<span class="nt">&lt;/pose&gt;</span>
      <span class="nt">&lt;topic&gt;</span>/image_raw<span class="nt">&lt;/topic&gt;</span>
      <span class="nt">&lt;camera</span> <span class="na">name=</span><span class="s">"my_camera"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;horizontal_fov&gt;</span>1.3962634<span class="nt">&lt;/horizontal_fov&gt;</span>
        <span class="nt">&lt;image&gt;</span>
           <span class="nt">&lt;width&gt;</span>600<span class="nt">&lt;/width&gt;</span>
           <span class="nt">&lt;height&gt;</span>600<span class="nt">&lt;/height&gt;</span>
           <span class="nt">&lt;format&gt;</span>R8G8B8<span class="nt">&lt;/format&gt;</span>
        <span class="nt">&lt;/image&gt;</span>
        <span class="nt">&lt;clip&gt;</span>
          <span class="nt">&lt;near&gt;</span>0.02<span class="nt">&lt;/near&gt;</span>
          <span class="nt">&lt;far&gt;</span>300<span class="nt">&lt;/far&gt;</span>
        <span class="nt">&lt;/clip&gt;</span>
      <span class="nt">&lt;/camera&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"camera"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"depth_camera"</span> <span class="na">type=</span><span class="s">"depth_camera"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;update_rate&gt;</span>10<span class="nt">&lt;/update_rate&gt;</span>
          <span class="nt">&lt;topic&gt;</span>depth_camera<span class="nt">&lt;/topic&gt;</span>
          <span class="nt">&lt;camera&gt;</span>
            <span class="nt">&lt;horizontal_fov&gt;</span>1.05<span class="nt">&lt;/horizontal_fov&gt;</span>
            <span class="nt">&lt;image&gt;</span>
              <span class="nt">&lt;width&gt;</span>256<span class="nt">&lt;/width&gt;</span>
              <span class="nt">&lt;height&gt;</span>256<span class="nt">&lt;/height&gt;</span>
              <span class="nt">&lt;format&gt;</span>R_FLOAT32<span class="nt">&lt;/format&gt;</span>
            <span class="nt">&lt;/image&gt;</span>
            <span class="nt">&lt;clip&gt;</span>
              <span class="nt">&lt;near&gt;</span>0.1<span class="nt">&lt;/near&gt;</span>
              <span class="nt">&lt;far&gt;</span>10.0<span class="nt">&lt;/far&gt;</span>
            <span class="nt">&lt;/clip&gt;</span>
          <span class="nt">&lt;/camera&gt;</span>
          <span class="nt">&lt;alwaysOn&gt;</span>1<span class="nt">&lt;/alwaysOn&gt;</span>
          <span class="nt">&lt;ignition_frame_id&gt;</span>camera<span class="nt">&lt;/ignition_frame_id&gt;</span>
      <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从官网找到的imu传感器的</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
    <span class="nt">&lt;gazebo&gt;</span>
        <span class="nt">&lt;plugin</span> <span class="na">filename=</span><span class="s">"libignition-gazebo-imu-system.so"</span>
                <span class="na">name=</span><span class="s">"ignition::gazebo::systems::Imu"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span>

    <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"base_link"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"imu_sensor"</span> <span class="na">type=</span><span class="s">"imu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;always_on&gt;</span>1<span class="nt">&lt;/always_on&gt;</span>
            <span class="nt">&lt;update_rate&gt;</span>30<span class="nt">&lt;/update_rate&gt;</span>
            <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
            <span class="nt">&lt;topic&gt;</span>imu<span class="nt">&lt;/topic&gt;</span>
        <span class="nt">&lt;/sensor&gt;</span>
    <span class="nt">&lt;/gazebo&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>可以用<code class="language-plaintext highlighter-rouge">ign topic -e -t /imu</code>测试gazebo是否发布了话题，后面再用gazebo_bridge把话题给ROS2就行了。</p>

<p>默认情况下，rviz2没有显示imu消息的插件，需要自行安装相关插件，具体安装指令如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">ros</span><span class="o">-</span><span class="err">$</span><span class="p">{</span><span class="n">ROS_DISTRO</span><span class="p">}</span><span class="o">-</span><span class="n">imu</span><span class="o">-</span><span class="n">tools</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>SolidWorks自动生成的模型可能翻转了laser_joint,请你修改回正，这样可能rivz2就有激光了，然后修改一下可视化的模型，让模型正常，不要给碰撞，不然可能会遮挡激光。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1738.webp" alt="" /></p>

<p>修改gazebo_sim_world.launch.py文件，修改后的代码如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">this_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">demo_gazebo_sim</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">mycar_desc_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_description</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pkg_ros_gz_sim</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">ros_gz_sim</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">world_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">this_pkg</span><span class="p">,</span><span class="sh">"</span><span class="s">world</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">house.sdf</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">gz_sim</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
    <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_ros_gz_sim</span><span class="p">,</span> <span class="sh">"</span><span class="s">launch</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gz_sim.launch.py</span><span class="sh">"</span><span class="p">)),</span>
        <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">gz_args</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">-r </span><span class="sh">"</span> <span class="o">+</span> <span class="n">world_file</span>
        <span class="p">}.</span><span class="nf">items</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">mycar_desc</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">mycar_desc_pkg</span><span class="p">,</span><span class="sh">"</span><span class="s">launch</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">mycar_desc_sim.launch.py</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">spawn</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_sim</span><span class="sh">"</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">create</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">-name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mycar</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">-x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-4</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">-z</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0.01</span><span class="sh">"</span><span class="p">,</span> <span class="c1">#设置为0,可能会陷进地里
</span>            <span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">-topic</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/robot_description</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Bridge
</span>    <span class="n">bridge</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/model/mycar/odometry@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/model/mycar/tf@tf2_msgs/msg/TFMessage[gz.msgs.Pose_V</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/world/empty/model/mycar/joint_state@sensor_msgs/msg/JointState[gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/scan@sensor_msgs/msg/LaserScan@gz.msgs.LaserScan</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/scan/points@sensor_msgs/msg/PointCloud2@gz.msgs.PointCloudPacked</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/image_raw@sensor_msgs/msg/Image@gz.msgs.Image</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/depth_camera@sensor_msgs/msg/Image@gz.msgs.Image</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/imu@sensor_msgs/msg/Imu[gz.msgs.IMU</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/imu/angular_velocity@geometry_msgs/msg/Vector3[gz.msgs.Vector3d</span><span class="sh">"</span>
        <span class="p">],</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">qos_overrides./model/mycar.subscriber.reliability</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reliable</span><span class="sh">"</span><span class="p">}],</span>
        <span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="sh">"</span><span class="s">/model/mycar/tf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/tf</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">(</span><span class="sh">"</span><span class="s">/world/empty/model/mycar/joint_state</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">joint_states</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">(</span><span class="sh">"</span><span class="s">/model/mycar/odometry</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">/odom</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">gz_sim</span><span class="p">,</span>
        <span class="n">spawn</span><span class="p">,</span>
        <span class="n">mycar_desc</span><span class="p">,</span>
        <span class="n">bridge</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>构建</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_description demo_gazebo_sim
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>执行</strong></p>

<p>终端中进入当前工作空间，调用如下指令执行launch文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
<span class="nb">export </span><span class="nv">MYCAR_MODEL</span><span class="o">=</span>stm32_4w <span class="c"># MYCAR_MODEL值可以设置为arduino、stm32_2w 或stm32_4w</span>
ros2 launch demo_gazebo_sim gazebo_sim_world.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再启动键盘控制节点，就可以控制机器人运动了。</p>

<p>还可以启动rviz2，以查看机器人发布的诸多数据。终端中进入当前工作空间，调用如下指令执行launch文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
rviz2
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1739.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1740.webp" alt="" /></p>

<p>我没有用赵虚左老师的mycar_description，用的自己的小车模型，后面的一系列源码都在下方这个Github仓库中，需要的可以自行clone.</p>

<p>https://github.com/tungchiahui/ROS2_WS/tree/main/6.ws_simulations</p>

<p>(把上面的全部复现，才能够进行下一章导航，下一章导航依然基于仿真)</p>

<h2 id="将ign-gazebo迁移至gz-sim">将Ign Gazebo迁移至Gz Sim</h2>

<p><strong>（即ROS2Humble迁移至ROS2Jazzy及之后的版本，只用Humble的也要看一下）</strong></p>

<p>由于只有ROS2 Humble的Gazebo叫做ign gazebo，到了ROS2 Jazzy及之后的版本，应该会都改名叫gazebo（简称gz sim）。</p>

<p>如果你要把代码从ROS2 Humble迁移到ROS2 Jazzy，那么兼容性问题最大的地方就是Gazebo，需要修改很多东西。</p>

<p>但是Ign Gazebo与Gz Sim的最大区别其实就是重命名了一下，所以迁移很好迁移。</p>

<p>为何都是ROS2，且gazebo界面功能几乎都一模一样还代码不互通呢？</p>

<p>是因为gazebo组织早期在为ROS2开发新版Gazebo时，为了和Gazebo Classic做出区分，所以给新版Gazebo命名为Ignition Gazebo，并在ROS2 Humble上推行。</p>

<p>后来Gazebo组织发现这种命名方式及其麻烦，所以在新版ROS2 Jazzy上又修改回了Gazebo的名字(简称Gz Sim)。</p>

<p>所以并不是功能不互通，仅仅是名字不互通罢了，只需要重命名，就这么简单。</p>

<p>https://gazebosim.org/docs/harmonic/migration_from_ignition/</p>

<p>主要修改以下部分：</p>

<h3 id="sdf文件">SDF文件</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1741.webp" alt="" /></p>

<p>根据官方所说，普通的要把ignition全部替换为gz.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1742.webp" alt="" /></p>

<p>插件要按照上面的修改，比如ignition::gazebo改为gz::sim。然后ignition::修改为gz::。</p>

<ul>
  <li>
    <p>所有 <code class="language-plaintext highlighter-rouge">ignition-</code> 前缀 → <code class="language-plaintext highlighter-rouge">gz-</code></p>
  </li>
  <li>
    <p>所有 <code class="language-plaintext highlighter-rouge">ignition::gazebo</code> 命名空间 → <code class="language-plaintext highlighter-rouge">gz::sim</code></p>
  </li>
  <li>
    <p>插件系统名称 <code class="language-plaintext highlighter-rouge">ignition-gazebo-XXX-system</code> → <code class="language-plaintext highlighter-rouge">gz-sim-XXX-system</code></p>
  </li>
  <li>
    <p>新版本中<code class="language-plaintext highlighter-rouge">alwaysOn</code>已被always_on替代，<code class="language-plaintext highlighter-rouge">gz_frame_id</code>改为pose relative_to””</p>
  </li>
  <li>
    <p>确保所有环境变量（如<code class="language-plaintext highlighter-rouge">IGN_GAZEBO_RESOURCE_PATH</code>）更新为<code class="language-plaintext highlighter-rouge">GZ_SIM_RESOURCE_PATH</code></p>
  </li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: left">原字段</th>
      <th style="text-align: left">新字段</th>
      <th style="text-align: left">示例场景</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ignition-gazebo-*</td>
      <td style="text-align: left">gz-sim-*</td>
      <td style="text-align: left">插件文件名</td>
    </tr>
    <tr>
      <td style="text-align: left">ignition::gazebo::*</td>
      <td style="text-align: left">gz::sim::*</td>
      <td style="text-align: left">插件命名空间</td>
    </tr>
    <tr>
      <td style="text-align: left">IGN_GAZEBO环境变量前缀</td>
      <td style="text-align: left">GZ_SIM前缀</td>
      <td style="text-align: left">资源路径配置</td>
    </tr>
  </tbody>
</table>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1743.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1744.webp" alt="" /></p>

<p>具体代码看我的仓库：</p>

<p>https://github.com/CyberNaviRobot/CyberRobot_ROS2_Jazzy_WS</p>

<h2 id="本章小结">本章小结</h2>

<p>本章主要介绍了2D仿真工具stage_ros2以及3D仿真工具ignition gazebo在ROS2中的应用。</p>

<p>相关知识点如下：</p>

<ul>
  <li>
    <p>仿真的理论知识；</p>
  </li>
  <li>
    <p>stage_ros2在ROS2中的使用；</p>
  </li>
  <li>
    <p>ignition gazebo在ROS2中的使用。</p>
  </li>
</ul>

<p>通过上述内容我们介绍了仿真在ROS2中的应用场景、概念，以及较之于实体机器人，仿真的优势和不足。还学习了如何基于stage_ros2以及ignition gazebo分别搭建仿真环境并模拟机器人，为后续的学习奠定了基础。</p>

<p>另外，除了stage_ros2和ignition gazebo之外，还有其他一些可用于ROS2仿真的软件。以下是一些常见的选择：</p>

<ul>
  <li>
    <p>Webots: Webots是一个强大的开源多机器人仿真软件平台，它支持各种机器人硬件和传感器模拟，并且可以与ROS 2进行集成。</p>
  </li>
  <li>
    <p>Gazebo Classic: Gazebo Classic是ROS 1中常用的仿真器，也可以通过ROS 2进行连接和使用。</p>
  </li>
  <li>
    <p>MORSE: MORSE是一个基于Python的开源仿真器，可以用于ROS 2仿真和机器人开发，支持多种传感器和行为模型。</p>
  </li>
  <li>
    <p>V-REP: V-REP是一个强大的多机器人仿真平台，它支持ROS 2与其进行通信，可以实现各种机器人模型和场景的仿真。</p>
  </li>
</ul>

<p>这些都是一些常见的ROS 2仿真软件，你可以根据具体的需求选择合适的软件来进行仿真和开发。请注意，某些仿真器可能需要进行适配和配置以与ROS 2兼容。</p>

<h1 id="机器人导航navigation2仿真篇">机器人导航Navigation2(仿真篇)</h1>

<h2 id="导航概述">导航概述</h2>

<h3 id="导航简述">导航简述</h3>

<p><strong>概念</strong></p>

<p>机器人导航是指在没有人为干预的情况下，机器人可以自主地从一个位置移动到另一个位置。在ROS2中，导航实现最为常用的框架是Nav2。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1745.webp" alt="" /></p>

<p>Nav2也即Navigation2，它继承自ROS的导航堆栈。它采用了与自动驾驶车辆相同的前沿技术，并经过优化和改造，专门适用于移动机器人和地面机器人的导航需求。这个项目赋予移动机器人穿越复杂环境的能力，使其能够完成用户定义的各种应用任务，几乎适用于任何类型的机器人动力学。Nav2不仅支持机器人从A点到B点的移动，还能设置中间姿态，并执行多种任务，如物体跟踪、全面覆盖导航等。作为全球100多家公司信赖的生产级高质量导航框架，Nav2以其卓越的可靠性和稳定性赢得了广泛赞誉。</p>

<p><strong>作用</strong></p>

<p>Nav2在机器人导航领域作用显著，主要表现在以下几个方面。</p>

<ul>
  <li>
    <p>Nav2具备多样的导航功能，支持激光雷达、摄像头等多种传感器输入，实时获取环境信息，实现智能路径规划和精确运动控制。它支持多种导航模式，满足不同应用需求，并具备强大的扩展性，可与ROS 2组件无缝集成。</p>
  </li>
  <li>
    <p>Nav2性能卓越，采用高效算法和数据处理技术，确保机器人在导航过程中响应迅速且稳定。</p>
  </li>
  <li>
    <p>安全方面，Nav2采用多种避障算法和参数调节功能，设定安全区域，提供诊断监控，确保机器人安全导航。</p>
  </li>
</ul>

<p>总之，Nav2为机器人的导航和应用提供了强大的支持。无论是工业领域的自动化生产，还是服务领域的智能机器人，Nav2都能够发挥重要作用，提升机器人的自主性和智能化水平。</p>

<h3 id="导航安装">导航安装</h3>

<p>借助于Ubuntu的包资源管理器，可以使用二进制的方式安装Nav2，安装指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;ros2-distro&gt;-navigation2
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;ros2-distro&gt;-nav2-bringup

<span class="c"># Humble</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-navigation2
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-nav2-bringup

<span class="c"># Jazzy</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-navigation2
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-nav2-bringup
</pre></td></tr></tbody></table></code></pre></div></div>

<p>指令中的<code class="language-plaintext highlighter-rouge">&lt;ros2-distro&gt;</code>请替换成当前所使用的ROS2版本。</p>

<h3 id="导航条件">导航条件</h3>

<p>深入学习Nav2，需了解ROS2机器人基础知识，并配备仿真或实体机器人作为实践环境。</p>

<p><strong>ROS2基础</strong></p>

<ul>
  <li>
    <p><strong>ROS2通信</strong> ：了解ROS2中的节点（Nodes）、话题（Topics）、服务（Services）、动作（Actions）等基本概念，以及如何通过这些机制实现节点间的通信。</p>
  </li>
  <li>
    <p><strong>生命周期管理</strong> ：熟悉ROS2中的生命周期节点（Lifecycle Nodes），理解节点的启动、配置、激活、去激活、清理等状态转换过程，这对于管理复杂的ROS2系统至关重要。</p>
  </li>
  <li>
    <p><strong>rviz2：</strong> 熟练使用rviz2进行可视化调试，包括如何设置不同的显示类型（如点云、地图、路径等），以及如何通过rviz2与ROS2节点进行交互（如设置导航目标点、观察机器人状态等）。</p>
  </li>
  <li>
    <p><strong>URDF：</strong> 了解URDF（Unified Robot Description Format）文件，这是ROS中用于描述机器人模型的一种XML格式。熟悉如何编写和修改URDF文件，以便在仿真或实际环境中准确地表示机器人结构。</p>
  </li>
  <li>
    <p><strong>TF坐标变换：</strong> 掌握TF（Transform）库的使用，理解坐标变换在机器人导航中的重要性。学会如何设置和查询不同坐标系之间的变换关系，以确保机器人能够准确地定位自身和周围环境。</p>
  </li>
</ul>

<p>实践环境</p>

<ul>
  <li>
    <p><strong>仿真环境：</strong> 搭建一个ROS2兼容的仿真环境，并配置好相应的机器人模型、传感器（如激光雷达、相机等）和仿真世界。确保仿真环境中的机器人能够接收速度指令、反馈里程计消息、发布传感器数据和TF坐标变换等。</p>
  </li>
  <li>
    <p><strong>实体机器人：</strong> 如果条件允许，准备一台实体机器人。这台机器人应该具备与仿真环境中相似的功能，即能够接收速度指令、反馈里程计消息、发布激光雷达等传感器数据以及发布TF坐标变换。同时，确保实体机器人已经安装了ROS2系统，并且已经配置好相应的驱动程序和算法库。</p>
  </li>
  <li>
    <p><strong>Nav2软件包：</strong> 安装并配置好Nav2软件包及其依赖项。Nav2是ROS2中用于机器人导航的综合性软件包，它包含了路径规划、避障、局部和全局地图维护等多个功能模块。确保Nav2软件包与您的ROS2版本兼容，并且已经根据需要进行了适当的配置。</p>
  </li>
</ul>

<p>通过掌握上述基础知识并准备好实践环境，您将能够更好地学习和应用Nav2进行机器人导航任务的开发与调试。</p>

<h3 id="导航参数参考">导航参数参考</h3>

<p>https://docs.nav2.org/configuration/index.html</p>

<h2 id="slam-定位与建图">SLAM 定位与建图</h2>

<p><strong>概念</strong></p>

<p>SLAM（Simultaneous Localization and Mapping，即时定位与建图）是机器人学和自动导航领域的一种关键技术，允许机器人在未知环境中绘制环境地图。</p>

<p>在ROS 2下进行SLAM，通常涉及使用专门为ROS 2开发的SLAM相关软件包。这些软件包利用ROS 2的通讯框架（如话题、服务和action）来处理接收到的传感器数据，包括激光雷达、相机、惯性测量单元等。</p>

<p>以下列举了一些常见的在ROS2中使用的SLAM系统：</p>

<ol>
  <li>
    <p><strong>SLAM Toolbox</strong> ：SLAM Toolbox 是一种在 ROS 2 中普遍使用的 SLAM 解决方案，由 Steve Macenski 维护。它是为了替代原有的ROS中著名的gmapping包和Cartographer SLAM包而开发的，提供了2D激光SLAM领域中的多种功能。</p>
  </li>
  <li>
    <p><strong>Cartographer for ROS 2</strong> ：Cartographer是由Google开发的一个2D和3D环境SLAM库。尽管它最初是为ROS开发的，但已经有为ROS 2创建的适配版本，可以在ROS 2生态系统内使用。</p>
  </li>
</ol>

<p>要在ROS 2中开始一个SLAM项目，还需要具体的传感器（例如激光雷达或摄像头），计算机要有足够的算力来运行SLAM算法，以及熟悉ROS 2节点、话题、服务、action、参数等知识，以实现有效的数据处理和通信。随着项目的发展，可能还需要考虑动态重配置、3D建图和路径规划等高级功能。</p>

<p><strong>作用</strong></p>

<p>必须先说明的是：SLAM与Nav2并没有直接的依赖关系，它们是两种相对独立的技术框架。然而，在实际应用中，这两者却展现出紧密的联系与互补性。</p>

<blockquote>
  <p><strong>独立性：</strong> SLAM能够独立完成环境地图的构建，无需Nav2的介入。它依靠传感器数据来感知环境，并通过算法估计机器人的位置与姿态，从而构建出环境的地图。与此同时，Nav2也具备自主导航的能力。即使没有SLAM地图作为输入，它也能依赖其他来源的环境信息进行导航。</p>

  <p><strong>互补性：</strong> 尽管两者在技术上各自独立，但它们的结合却带来了显著的优势。Nav2能够利用SLAM创建的精确地图进行高效的路径规划，确保机器人能够顺利导航至目标位置。而SLAM则能借助Nav2的导航控制功能，在机器人移动过程中实时收集环境信息，从而进一步提高地图构建的效率和准确性。</p>
</blockquote>

<p>因此，尽管SLAM与Nav2在技术上各自独立，但在构建完整的机器人导航系统中，它们的互补性使得机器人能够在复杂环境中实现更加自主、精准的建图或导航。</p>

<h3 id="slam_toolbox概述">slam_toolbox概述</h3>

<p>概念</p>

<p>SLAM Toolbox是一个基于开源软件的用来构建 <strong>2D地图</strong> 的工具集，旨在为研究人员和开发者提供一个快速构建和实现SLAM算法的平台。它集成了多种常用的SLAM算法，并提供了丰富的数据处理和滤波函数，以及地图构建和环境建模的工具。</p>

<p>功能</p>

<ul>
  <li>
    <p><strong>算法集成</strong> 包含基于卡尔曼滤波器和粒子滤波器的SLAM算法，以及基于图优化的SLAM算法等。</p>
  </li>
  <li>
    <p><strong>数据处理</strong> 提供数据融合、数据预处理和异常检测等功能，支持激光雷达、摄像头、IMU等多种传感器数据的处理。</p>
  </li>
  <li>
    <p><strong>地图构建</strong> 利用传感器数据和机器人运动信息构建准确的地图，并进行更新和优化。</p>
  </li>
  <li>
    <p><strong>模块化设计</strong> 支持用户插入自己的算法或替换现有模块，实现高度定制化的SLAM解决方案。</p>
  </li>
</ul>

<p>优点</p>

<ul>
  <li>
    <p><strong>开源性和灵活性</strong> 作为开源软件，SLAM Toolbox提供了源代码和文档，用户可以自由修改和扩展算法。</p>
  </li>
  <li>
    <p><strong>多种传感器支持</strong> 支持激光雷达、摄像头、IMU等多种传感器数据，适应不同应用场景的需求。</p>
  </li>
  <li>
    <p><strong>高效性</strong> 利用现代C++的特性优化性能，确保在资源受限的硬件上也能高效运行。</p>
  </li>
  <li>
    <p><strong>广泛的应用前景</strong> 适用于学术研究、无人机导航、自动驾驶汽车、室内机器人和工业自动化等多个领域。</p>
  </li>
</ul>

<h3 id="slam_toolbox安装">slam_toolbox安装</h3>

<p>借助于Advanced Packaging Tools(<a href="https://c6.y.qq.com/base/fcgi-bin/u?__=bqEbdGxIB7mM">APT</a>)包资源管理器，可以使用二进制的方式安装slam_toolbox，安装指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;ros2-distro&gt;-slam-toolbox

<span class="c">#humble</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-slam-toolbox
<span class="c">#jazzy</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-slam-toolbox
</pre></td></tr></tbody></table></code></pre></div></div>

<p>指令中的<code class="language-plaintext highlighter-rouge">&lt;ros2-distro&gt;</code>请替换成当前所使用的ROS2版本。</p>

<h3 id="slam_toolbox节点说明">slam_toolbox节点说明</h3>

<p>在slam_toolbox中常用的节点有两个：sync_slam_toolbox_node和async_slam_toolbox_node。</p>

<blockquote>
  <p><strong>sync_slam_toolbox_node：</strong></p>

  <p>这是一个同步节点，会等待所有传感器数据到达后再处理，确保数据完整性和一致性，提高定位和建图准确性。但同步处理可能导致延迟，更适合对数据一致性和准确性要求高、实时性要求不高的场景。</p>

  <p><strong>async_slam_toolbox_node：</strong></p>

  <p>与同步节点不同，这是一个异步节点，可以立即处理已接收的数据，减小延迟，提高响应速度。但异步处理可能导致数据不完全同步，定位和建图结果可能不如同步方式准确。因此，它更适合对实时性要求高、对数据一致性和准确性要求相对较低的场景。</p>
</blockquote>

<p>在选择使用sync_slam_toolbox_node还是async_slam_toolbox_node时，需根据应用需求和环境权衡。若实时性关键且能接受一定定位或建图误差，选择async_slam_toolbox_node。若对数据一致性和准确性要求较高，且实时性非首要考虑，则选择sync_slam_toolbox_node。另外二者的主要区别在于数据处理的方式，而两个节点发布的话题、订阅的话题、发布的服务以及使用的参数等都是一样的。</p>

<ol>
  <li>订阅的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/scan</td>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">来自激光雷达输入的扫描数据</td>
    </tr>
    <tr>
      <td style="text-align: left">/tf</td>
      <td style="text-align: left">tf2_msgs/msg/TFMessage</td>
      <td style="text-align: left">配置的odom_frame到base_frame的转换</td>
    </tr>
  </tbody>
</table>

<p>虽然不订阅/odom,但是需要发布/odom,以改变坐标。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">特性</th>
      <th style="text-align: left">slam_toolbox</th>
      <th style="text-align: left">hector_slam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">地图精度</td>
      <td style="text-align: left">高</td>
      <td style="text-align: left">中</td>
    </tr>
    <tr>
      <td style="text-align: left">实时性</td>
      <td style="text-align: left">较好，但依赖优化（回环检测）</td>
      <td style="text-align: left">极高</td>
    </tr>
    <tr>
      <td style="text-align: left">依赖数据</td>
      <td style="text-align: left">激光雷达、TF 树、里程计</td>
      <td style="text-align: left">激光雷达（可选 IMU）</td>
    </tr>
    <tr>
      <td style="text-align: left">回环检测</td>
      <td style="text-align: left">支持</td>
      <td style="text-align: left">不支持</td>
    </tr>
    <tr>
      <td style="text-align: left">长期运行</td>
      <td style="text-align: left">支持</td>
      <td style="text-align: left">不支持</td>
    </tr>
    <tr>
      <td style="text-align: left">适用场景</td>
      <td style="text-align: left">动态导航、复杂环境</td>
      <td style="text-align: left">简单环境，或无里程计时</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>发布的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/map</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">pose-graph（姿态图）在特定的更新频率（map_update_interval）下的占用栅格表示。</td>
    </tr>
    <tr>
      <td style="text-align: left">/pose</td>
      <td style="text-align: left">geometry_msgs/msg/PoseWithCovarianceStamped</td>
      <td style="text-align: left">配置的map_frame中base_frame的位姿以及根据扫描匹配计算的协方差</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>发布的服务</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/slam_toolbox/clear_changes</td>
      <td style="text-align: left">slam_toolbox/srv/Clear</td>
      <td style="text-align: left">清除所有待处理的手动位姿图操作的更改</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/deserialize_map</td>
      <td style="text-align: left">slam_toolbox/srv/DeserializePoseGraph</td>
      <td style="text-align: left">从磁盘加载保存的序列化位姿图文件</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/dynamic_map</td>
      <td style="text-align: left">nav_msgs/OccupancyGrid</td>
      <td style="text-align: left">请求位姿图的当前状态作为占用网格</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/manual_loop_closure</td>
      <td style="text-align: left">slam_toolbox/srv/LoopClosure</td>
      <td style="text-align: left">请求对位姿图进行手动更改</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/pause_new_measurements</td>
      <td style="text-align: left">slam_toolbox/srv/Pause</td>
      <td style="text-align: left">暂停处理新传入的激光扫描</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/save_map</td>
      <td style="text-align: left">slam_toolbox/srv/SaveMap</td>
      <td style="text-align: left">保存可用于显示 AMCL 定位的地图图像文件。</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/serialize_map</td>
      <td style="text-align: left">slam_toolbox/srv/SerializePoseGraph</td>
      <td style="text-align: left">保存地图位姿图和数据，可用于继续建图、slam_toolbox 定位、离线操作等</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/toggle_interactive_mode</td>
      <td style="text-align: left">slam_toolbox/srv/ToggleInteractive</td>
      <td style="text-align: left">在交互模式与非交互模式之间切换，发布节点的交互式标记及其位置，以便在应用程序中进行更新</td>
    </tr>
    <tr>
      <td style="text-align: left">/slam_toolbox/reset</td>
      <td style="text-align: left">slam_toolbox/srv/Reset</td>
      <td style="text-align: left">将当前地图重置回初始状态</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>
    <p>参数</p>

    <ol>
      <li>求解器参数</li>
    </ol>
  </li>
</ol>

<ul>
  <li>
    <p><strong>solver_plugin</strong>  用于 karto 扫描解算器的非线性解算器类型。选项：solver_plugins::CeresSolver, - solver_plugins::SpaSolver, solver_plugins::G2oSolver. Default: solver_plugins::CeresSolver.</p>
  </li>
  <li>
    <p><strong>ceres_linear_solver</strong>  Ceres 使用的线性求解器。选项：SPARSE_NORMAL_CHOLESKY、SPARSE_SCHUR、ITERATIVE_SCHUR、CGNR。默认为 SPARSE_NORMAL_CHOLESKY。</p>
  </li>
  <li>
    <p><strong>ceres_preconditioner</strong>  与该求解器一起使用的预处理器。选项：JACOBI、IDENTITY（none）、SCHUR_JACOBI。默认为JACOBI。</p>
  </li>
  <li>
    <p><strong>ceres_trust_strategy</strong>  信任区域策略。行搜索策略没有公开，因为它们对于这种用途表现不佳。选项：LEVENBERG_MARQUARDT、DOGLEG。默认值：LEVENBERG_MARQUARDT。</p>
  </li>
  <li>
    <p><strong>ceres_dogleg_type</strong>  如果信任策略是 DOGLEG，则使用dogleg策略。选项：TRADITIONAL_DOGLEG、SUBSPACE_DOGLEG。默认值：TRADITIONAL_DOGLEG</p>
  </li>
  <li>
    <p><strong>ceres_loss_function</strong>  拒绝异常值的损失函数类型。没有一个等于损失平方。选项：None、HuberLoss、CauchyLoss。默认值：None。</p>
  </li>
  <li>
    <p><strong>mode</strong>  “建图”或“定位”模式，用于 Ceres 问题创建中的性能优化</p>

    <ul>
      <li>Toolbox参数</li>
    </ul>
  </li>
  <li>
    <p><strong>odom_frame</strong>  里程计坐标系</p>
  </li>
  <li>
    <p><strong>map_frame</strong>  地图坐标系</p>
  </li>
  <li>
    <p><strong>base_frame</strong>  基坐标系</p>
  </li>
  <li>
    <p><strong>scan_topic</strong>  扫描主题名， 注意是/scan 不是scan</p>
  </li>
  <li>
    <p><strong>scan_queue_size</strong>  扫描消息对队列长度。在异步模式下应始终设置为 1</p>
  </li>
  <li>
    <p><strong>use_map_saver</strong>  实例化地图服务程序并自行订阅map主题</p>
  </li>
  <li>
    <p><strong>map_file_name</strong>  启动时加载的位姿图文件的名称（如果可用）</p>
  </li>
  <li>
    <p><strong>map_start_pose</strong>  启动建图/定位时的位姿（如果可用）</p>
  </li>
  <li>
    <p><strong>map_start_at_dock</strong>  在dock（第一个节点）处启动姿势图加载（如果可用）。如果同时设置了pose和dock，优先使用pose</p>
  </li>
  <li>
    <p><strong>debug_logging</strong>  更改日志以进行调试</p>
  </li>
  <li>
    <p><strong>throttle_scans</strong>  在同步模式下限制的扫描次数</p>
  </li>
  <li>
    <p><strong>transform_publish_period</strong>  里程计odom变换发布周期。 0 不会发布变换。</p>
  </li>
  <li>
    <p><strong>map_update_interval</strong>  更新 2D 占用地图的时间间隔</p>
  </li>
  <li>
    <p><strong>enable_interactive_mode</strong>  是否允许启用交互模式。交互模式将保留映射到其 ID 的激光扫描缓存，以便在交互模式下进行可视化。结果，该进程的内存将会增加。在定位和长期建图模式下可以手动禁用此功能，因为它们会随着时间的推移增加内存利用率。对于建图或连续建图模式均有效。</p>
  </li>
  <li>
    <p><strong>position_covariance_scale</strong>  从扫描匹配发布姿势时缩放位置协方差的量。这可用于调整下游定位滤波器中位姿的影响。协方差表示测量的不确定性，因此扩大协方差将减小位姿对下游滤波器的影响。默认值：1.0</p>
  </li>
  <li>
    <p><strong>yaw_covariance_scale</strong>  从扫描匹配发布位姿时缩放偏航协方差的量。请参阅position_covariance_scale 的描述。默认值：1.0</p>
  </li>
  <li>
    <p><strong>resolution</strong>  生成的 2D 占用图的分辨率</p>
  </li>
  <li>
    <p><strong>max_laser_range</strong>  用于 2D 占用地图光栅化的最大激光范围</p>
  </li>
  <li>
    <p><strong>minimum_time_interval</strong>  在同步模式下处理的扫描之间的最短持续时间</p>
  </li>
  <li>
    <p><strong>transform_timeout</strong>  查找转换 TF 超时时间限制</p>
  </li>
  <li>
    <p><strong>tf_buffer_duration</strong>  存储 TF 消息以供查询的时间。如果在同步模式下以倍速脱机运行，则设置高一些。</p>
  </li>
  <li>
    <p><strong>stack_size_to_use</strong>  将堆栈大小重置为的字节数，以启用文件的序列化/反序列化。自由默认值为 40000000，但越少越好。</p>
  </li>
  <li>
    <p><strong>minimum_travel_distance</strong>  处理新扫描之前的最小行进距离</p>

    <ul>
      <li>匹配器参数</li>
    </ul>
  </li>
  <li>
    <p><strong>use_scan_matching</strong>  是否使用扫描匹配来优化里程位姿</p>
  </li>
  <li>
    <p><strong>use_scan_barycenter</strong>  是否使用重心或扫描位姿</p>
  </li>
  <li>
    <p><strong>minimum_travel_heading</strong>  合理更新的最小航向变化</p>
  </li>
  <li>
    <p><strong>scan_buffer_size</strong>  缓冲到链中的扫描次数，也用作定位模式循环缓冲区中的扫描次数</p>
  </li>
  <li>
    <p><strong>scan_buffer_maximum_scan_distance</strong>  从缓冲区中删除之前扫描，距离之前位姿的最大距离</p>
  </li>
  <li>
    <p><strong>link_match_minimum_response_fine</strong>  精细分辨率通过的阈值链接匹配算法响应</p>
  </li>
  <li>
    <p><strong>link_scan_maximum_distance</strong>  有效链接扫描之间的最大距离</p>
  </li>
  <li>
    <p><strong>Loop_search_maximum_distance</strong>  循环闭合时考虑的扫描距离的最大阈值</p>
  </li>
  <li>
    <p><strong>do_loop_close</strong>  是否进行循环闭合（如果不确定，答案是“true”）</p>
  </li>
  <li>
    <p><strong>Loop_match_minimum_chain_size</strong>  寻找循环闭合的扫描的最小链长度</p>
  </li>
  <li>
    <p><strong>Loop_match_maximum_variance_coarse</strong>  粗略搜索中传递给细化的阈值方差</p>
  </li>
  <li>
    <p><strong>Loop_match_minimum_response_coarse</strong>  粗略搜索中环路闭合算法的阈值响应要传递给细化</p>
  </li>
  <li>
    <p><strong>Loop_match_minimum_response_fine</strong>  精细搜索中循环闭合算法的阈值响应传递给细化</p>
  </li>
  <li>
    <p><strong>correlation_search_space_dimension</strong> 搜索网格大小以进行扫描相关性</p>
  </li>
  <li>
    <p><strong>correlation_search_space_resolution</strong>  搜索网格分辨率以进行扫描相关性</p>
  </li>
  <li>
    <p><strong>correlation_search_space_smear_deviation</strong>  用于平滑响应的多模态涂抹量</p>
  </li>
  <li>
    <p><strong>loop_search_space_dimension</strong>  循环闭合算法的搜索网格的大小</p>
  </li>
  <li>
    <p><strong>loop_search_space_resolution</strong>  搜索网格分辨率以进行循环闭合</p>
  </li>
  <li>
    <p><strong>loop_search_space_smear_deviation</strong>  用于平滑响应的多模态涂抹量</p>
  </li>
  <li>
    <p><strong>distance_variance_penalty</strong>  应用于匹配扫描的惩罚，因为它与里程姿势不同</p>
  </li>
  <li>
    <p><strong>angle_variance_penalty</strong>  应用于匹配扫描的惩罚，因为它与里程姿势不同</p>
  </li>
  <li>
    <p><strong>fine_search_angle_offset</strong>  用于测试精细扫描匹配的角度范围</p>
  </li>
  <li>
    <p><strong>rough_search_angle_offset</strong>  用于测试粗略扫描匹配的角度范围</p>
  </li>
  <li>
    <p><strong>coarse_angle_resolution</strong>  在扫描匹配中测试的偏移范围内的角度分辨率</p>
  </li>
  <li>
    <p><strong>minimum_angle_penalty</strong>  确保尺寸不会膨胀的最小惩罚角度</p>
  </li>
  <li>
    <p><strong>minimum_distance_penalty</strong>  扫描可以确保大小不会爆炸的最小惩罚</p>
  </li>
  <li>
    <p><strong>use_response_expansion</strong>  如果没有找到可行的匹配，是否自动增加搜索网格大小</p>
  </li>
</ul>

<h3 id="slam_toolbox基本使用">slam_toolbox基本使用</h3>

<ol>
  <li>准备工作</li>
</ol>

<p>在src目录下，请先调用如下指令在工作空间的src目录下创建一个功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create mycar_slam_slam_toolbox <span class="nt">--dependencies</span> slam_toolbox
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>编写launch文件与参数文件</li>
</ol>

<p>在功能包下，新建launch目录和params目录，launch目录下新建<code class="language-plaintext highlighter-rouge">online_sync_launch.py</code>文件并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">use_sim_time</span> <span class="o">=</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">slam_params_file</span> <span class="o">=</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">slam_params_file</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">declare_use_sim_time_argument</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span>
        <span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">default_value</span><span class="o">=</span><span class="sh">'</span><span class="s">false</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Use simulation/Gazebo clock</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">declare_slam_params_file_cmd</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span>
        <span class="sh">'</span><span class="s">slam_params_file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">default_value</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_slam_slam_toolbox</span><span class="sh">"</span><span class="p">),</span>
                                   <span class="sh">'</span><span class="s">params</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mapper_params_online_sync.yaml</span><span class="sh">'</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Full path to the ROS2 parameters file to use for the slam_toolbox node</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">start_sync_slam_toolbox_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
          <span class="n">slam_params_file</span><span class="p">,</span>
          <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">use_sim_time</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">slam_toolbox</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">sync_slam_toolbox_node</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">slam_toolbox</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">ld</span> <span class="o">=</span> <span class="nc">LaunchDescription</span><span class="p">()</span>

    <span class="n">ld</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">declare_use_sim_time_argument</span><span class="p">)</span>
    <span class="n">ld</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">declare_slam_params_file_cmd</span><span class="p">)</span>
    <span class="n">ld</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">start_sync_slam_toolbox_node</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ld</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该launch文件主要是加载了slam_toolbox下的sync_slam_toolbox_node节点，并且会从当前功能包的params下读取一个名为<code class="language-plaintext highlighter-rouge">mapper_params_online_sync.yaml</code>的配置文件。这个配置文件还不存在，接下来需要在params目录下新建<code class="language-plaintext highlighter-rouge">mapper_params_online_sync.yaml</code>文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="na">slam_toolbox</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">solver_plugin</span><span class="pi">:</span> <span class="s">solver_plugins::CeresSolver</span>
    <span class="na">ceres_linear_solver</span><span class="pi">:</span> <span class="s">SPARSE_NORMAL_CHOLESKY</span>
    <span class="na">ceres_preconditioner</span><span class="pi">:</span> <span class="s">SCHUR_JACOBI</span>
    <span class="na">ceres_trust_strategy</span><span class="pi">:</span> <span class="s">LEVENBERG_MARQUARDT</span>
    <span class="na">ceres_dogleg_type</span><span class="pi">:</span> <span class="s">TRADITIONAL_DOGLEG</span>
    <span class="na">ceres_loss_function</span><span class="pi">:</span> <span class="s">None</span>

    <span class="na">odom_frame</span><span class="pi">:</span> <span class="s">odom</span>
    <span class="na">map_frame</span><span class="pi">:</span> <span class="s">map</span>
    <span class="na">base_frame</span><span class="pi">:</span> <span class="s">base_link</span>
    <span class="na">scan_topic</span><span class="pi">:</span> <span class="s">/scan</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">mapping</span> <span class="c1">#localization</span>

    <span class="c1">#map_file_name: test_steve</span>
    <span class="c1">#map_start_pose: [0.0, 0.0, 0.0]</span>
    <span class="c1">#map_start_at_dock: true</span>

    <span class="na">debug_logging</span><span class="pi">:</span> <span class="kc">false</span>
    <span class="na">throttle_scans</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">transform_publish_period</span><span class="pi">:</span> <span class="s">0.02</span> 
    <span class="na">map_update_interval</span><span class="pi">:</span> <span class="m">2.0</span>
    <span class="na">resolution</span><span class="pi">:</span> <span class="m">0.05</span>
    <span class="na">max_laser_range</span><span class="pi">:</span> <span class="s">20.0</span> 
    <span class="na">minimum_time_interval</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">transform_timeout</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">tf_buffer_duration</span><span class="pi">:</span> <span class="s">30.</span>
    <span class="na">stack_size_to_use</span><span class="pi">:</span> <span class="s">40000000</span> 
    <span class="na">enable_interactive_mode</span><span class="pi">:</span> <span class="kc">true</span>

    <span class="na">use_scan_matching</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">use_scan_barycenter</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">minimum_travel_distance</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">minimum_travel_heading</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">scan_buffer_size</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">scan_buffer_maximum_scan_distance</span><span class="pi">:</span> <span class="m">10.0</span>
    <span class="na">link_match_minimum_response_fine</span><span class="pi">:</span> <span class="s">0.1</span>  
    <span class="na">link_scan_maximum_distance</span><span class="pi">:</span> <span class="m">1.5</span>
    <span class="na">loop_search_maximum_distance</span><span class="pi">:</span> <span class="m">3.0</span>
    <span class="na">do_loop_closing</span><span class="pi">:</span> <span class="kc">true</span> 
    <span class="na">loop_match_minimum_chain_size</span><span class="pi">:</span> <span class="s">10</span>           
    <span class="na">loop_match_maximum_variance_coarse</span><span class="pi">:</span> <span class="s">3.0</span>  
    <span class="na">loop_match_minimum_response_coarse</span><span class="pi">:</span> <span class="s">0.35</span>    
    <span class="na">loop_match_minimum_response_fine</span><span class="pi">:</span> <span class="m">0.45</span>

    <span class="na">correlation_search_space_dimension</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">correlation_search_space_resolution</span><span class="pi">:</span> <span class="m">0.01</span>
    <span class="na">correlation_search_space_smear_deviation</span><span class="pi">:</span> <span class="s">0.1</span> 

    <span class="na">loop_search_space_dimension</span><span class="pi">:</span> <span class="m">8.0</span>
    <span class="na">loop_search_space_resolution</span><span class="pi">:</span> <span class="m">0.05</span>
    <span class="na">loop_search_space_smear_deviation</span><span class="pi">:</span> <span class="m">0.03</span>

    <span class="na">distance_variance_penalty</span><span class="pi">:</span> <span class="s">0.5</span>      
    <span class="na">angle_variance_penalty</span><span class="pi">:</span> <span class="s">1.0</span>    

    <span class="na">fine_search_angle_offset</span><span class="pi">:</span> <span class="s">0.00349</span>     
    <span class="na">coarse_search_angle_offset</span><span class="pi">:</span> <span class="s">0.349</span>   
    <span class="na">coarse_angle_resolution</span><span class="pi">:</span> <span class="s">0.0349</span>        
    <span class="na">minimum_angle_penalty</span><span class="pi">:</span> <span class="m">0.9</span>
    <span class="na">minimum_distance_penalty</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">use_response_expansion</span><span class="pi">:</span> <span class="kc">true</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>配置文件的内容需要根据实际情况进行动态调整。</p>

<ol>
  <li>编辑配置文件</li>
</ol>

<p>打开<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> 并输入如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>DIRECTORY launch params
  DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>编译</li>
</ol>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_slam_slam_toolbox
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p>执行</p>

    <ol>
      <li>请先调用如下指令启动仿真环境：</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch stage_ros2 my_house.launch.py
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>然后在终端下进入当前工作空间，输入如下指令：</li>
    </ol>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch mycar_slam_slam_toolbox online_sync_launch.py use_sim_time:<span class="o">=</span>True
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>
        <p>启动rviz2，将Fixed Frame设置为map，添加map插件并将话题设置为/map，即可显示slam_toolbox创建的地图了，当机器人运动时，地图也会随之更新。</p>
      </li>
      <li>
        <p>use_sim_time:=True参数表示使用仿真的时间。</p>
      </li>
    </ol>

    <p>  最后需要说明的是，本节内容使用的是<code class="language-plaintext highlighter-rouge">sync_slam_toolbox_node</code> 节点，即以同步方式建图，而异步建图节点<code class="language-plaintext highlighter-rouge">async_slam_toolbox_node</code> 的使用与同步类似。</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1746.webp" alt="" /></p>

<p>我们用键盘控制节点去控制机器人跑满整张地图，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1747.webp" alt="" /></p>

<p>黑色：障碍物</p>

<p>白色：无障碍物区</p>

<p>灰色：未知区</p>

<p>SLAM是建图与定位，以上就是建图，那么定位是啥呢？</p>

<p>定位就是Slam会发布一个/tf，这里面会包含机器人到map之间的坐标变换。</p>

<p>这个/tf发布的具体是map到odom的坐标变换，所以需要你自己去处理odom和base_link之间的坐标关系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1748.webp" alt="" /></p>

<p>这样的设计，可以让整条坐标树是一个链式结构，避免base_link或者base_foot_print出现两个父类，这样计算量会变大。</p>

<h3 id="cartographer概述">cartographer概述</h3>

<p><strong>概念</strong></p>

<p>Cartographer是Google推出的一套基于图优化的激光SLAM算法库，支持二维和三维地图的构建。它结合了激光雷达和惯性测量单元（IMU）的数据，通过高效的算法实现实时、准确的定位和建图。</p>

<p><strong>功能</strong></p>

<ul>
  <li>
    <p><strong>并行扫描匹配</strong> 利用并行计算技术加快扫描匹配速度，提高建图效率。</p>
  </li>
  <li>
    <p><strong>位姿图优化</strong> 通过图优化技术估计机器人的姿态和地图的拓扑结构，减少累积误差。</p>
  </li>
  <li>
    <p><strong>实时地图更新</strong> 在机器人移动过程中实时更新地图，确保地图的准确性和时效性。</p>
  </li>
  <li>
    <p><strong>回环检测</strong> 通过回环检测识别机器人曾经访问过的区域，进一步减少累积误差，提高地图的全局一致性。</p>
  </li>
  <li>
    <p><strong>多传感器融合</strong> 支持激光雷达、IMU、里程计等多种传感器数据的融合，提高定位和建图的精度。</p>
  </li>
</ul>

<p>优点</p>

<ul>
  <li>
    <p><strong>高效稳定</strong> Cartographer的算法经过精心设计和优化，能够在复杂环境中高效稳定地运行。</p>
  </li>
  <li>
    <p><strong>高精度</strong> 通过图优化和回环检测技术提供高精度的定位和建图结果。</p>
  </li>
  <li>
    <p><strong>灵活性</strong> 支持二维和三维地图构建，适应不同应用场景的需求。</p>
  </li>
  <li>
    <p><strong>开源免费</strong> Cartographer是开源项目，用户可以免费获取和使用其源代码和文档。</p>
  </li>
  <li>
    <p><strong>社区支持</strong> 拥有活跃的社区支持体系，用户可以获取来自全球开发者的帮助和支持。</p>
  </li>
</ul>

<h3 id="cartographer安装">cartographer安装</h3>

<p>借助于Ubuntu的包资源管理器，可以使用二进制的方式安装cartographer，安装指令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;ros2-distro&gt;-cartographer
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;ros2-distro&gt;-cartographer-ros

<span class="c"># humble</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-cartographer
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-cartographer-ros
<span class="c">#jazzy</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-cartographer
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-cartographer-ros
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述两条安装指令中，前者用于安装cartographer的核心库，这个包不直接与ROS2集成，而是作为一个独立的算法库存在，为地图构建和定位提供底层的计算支持。后者则是cartographer在ROS2环境下的封装，它提供了与ROS2系统的接口，使得Cartographer算法能够在ROS2环境中运行。另外指令中的<code class="language-plaintext highlighter-rouge">&lt;ros2-distro&gt;</code>请替换成当前所使用的ROS2版本。</p>

<h3 id="cartographer节点说明">cartographer节点说明</h3>

<p>在Cartographer框架中，<code class="language-plaintext highlighter-rouge">cartographer_node</code>和<code class="language-plaintext highlighter-rouge">cartographer_occupancy_grid_node</code>是两个关键的节点，它们各自承担着不同的角色和功能。详细介绍如下。</p>

<blockquote>
  <p><strong>cartographer_node：</strong></p>

  <p>主要负责订阅来自各种传感器的数据（如激光雷达、IMU、里程计等），并基于这些数据实时构建地图。它采用子图（submap）的方法来逐步构建和更新地图，确保定位的准确性和建图的实时性。</p>

  <p><strong>cartographer_occupancy_grid_node：</strong></p>

  <p>该节点负责接收<code class="language-plaintext highlighter-rouge">cartographer_node</code>发布的子图列表（<code class="language-plaintext highlighter-rouge">/submap_list</code>），并将其拼接成完整的栅格地图（occupancy grid map），然后发布这个地图。这个节点是地图生成的最终环节，它使得Cartographer能够输出人类可读且易于可视化的地图。</p>
</blockquote>

<p>这两个节点的协同工作，前者负责实时构建和更新地图，后者则负责将子图拼接成完整的栅格地图并发布，使得Cartographer能够高效地实现SLAM功能。</p>

<ol>
  <li>cartographer_node订阅的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/scan</td>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">来自激光雷达输入的扫描数据</td>
    </tr>
    <tr>
      <td style="text-align: left">/odom</td>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
      <td style="text-align: left">里程计消息</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>cartographer_node发布的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/scan_matched_points2</td>
      <td style="text-align: left">sensors_msgs/msg/PointCloud2</td>
      <td style="text-align: left">匹配好的点云数据，用于scan-to-submap matching</td>
    </tr>
    <tr>
      <td style="text-align: left">/submap_list</td>
      <td style="text-align: left">cartographer_ros_msgs/SubmapList</td>
      <td style="text-align: left">发布构建好的子图列表</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>cartographer_node发布的服务</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/submap_query</td>
      <td style="text-align: left">cartographer_ros_msgs/srv/SubmapQuery</td>
      <td style="text-align: left">提供查询子图的服务，获取到查询的子图</td>
    </tr>
    <tr>
      <td style="text-align: left">/start_trajectory</td>
      <td style="text-align: left">cartographer_ros_msgs/srv/StartTrajectory</td>
      <td style="text-align: left">开始一条轨迹</td>
    </tr>
    <tr>
      <td style="text-align: left">/finish_trajectory</td>
      <td style="text-align: left">cartographer_ros_msgs/srv/FinishTrajectory</td>
      <td style="text-align: left">结束一条给定ID的轨迹</td>
    </tr>
    <tr>
      <td style="text-align: left">/write_state</td>
      <td style="text-align: left">cartographer_ros_msgs/srv/WriteState</td>
      <td style="text-align: left">将当前状态写入磁盘文件中</td>
    </tr>
    <tr>
      <td style="text-align: left">/get_trajectory_states</td>
      <td style="text-align: left">cartographer_ros_msgs/srv/GetTrajectoryStates</td>
      <td style="text-align: left">获取指定轨迹的状态</td>
    </tr>
    <tr>
      <td style="text-align: left">/read_metrics</td>
      <td style="text-align: left">cartographer_ros_msgs/srv/ReadMetrics</td>
      <td style="text-align: left">读取性能指标</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>cartographer_node参数</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">cartographer_node</code>节点需要接收一个参数配置文件，该配置文件包含了地图构建、轨迹跟踪等所需的各项参数。</p>

<ol>
  <li>cartographer_occupancy_grid_node订阅的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/submap_list</td>
      <td style="text-align: left">cartographer_ros_msgs/SubmapList</td>
      <td style="text-align: left">子图列表</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>cartographer_occupancy_grid_node发布的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/map</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">发布的栅格地图</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>cartographer_occupancy_grid_node请求的服务</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/submap_query</td>
      <td style="text-align: left">cartographer_ros_msgs/srv/SubmapQuery</td>
      <td style="text-align: left">获取子图</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>cartographer_occupancy_grid_node参数</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">cartographer_occupancy_grid_node</code>节点需要配置地图的分辨率和更新周期等参数，以确保生成的栅格地图满足特定的精度和实时性要求。</p>

<h3 id="cartogarpher基本使用">cartogarpher基本使用</h3>

<ol>
  <li>准备工作</li>
</ol>

<p>在src目录下，请先调用如下指令在工作空间的src目录下创建一个功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create mycar_slam_cartographer <span class="nt">--dependencies</span> cartographer
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>编写launch文件与参数文件</li>
</ol>

<p>在功能包下，新建launch目录和params目录，launch目录下新建<code class="language-plaintext highlighter-rouge">cartographer.launch.py</code>文件并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">use_sim_time_arg</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">,</span> <span class="n">default_value</span> <span class="o">=</span> <span class="sh">'</span><span class="s">True</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">resolution_arg</span> <span class="o">=</span> <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="sh">'</span><span class="s">0.05</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">cartographer_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span> <span class="o">=</span> <span class="sh">'</span><span class="s">cartographer_ros</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span> <span class="o">=</span> <span class="sh">'</span><span class="s">cartographer_node</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)}],</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">-configuration_directory</span><span class="sh">'</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_slam_cartographer</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">-configuration_basename</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mycar.lua</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">output</span> <span class="o">=</span> <span class="sh">'</span><span class="s">screen</span><span class="sh">'</span>
    <span class="p">)</span>

    <span class="n">cartographer_occupancy_grid_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span> <span class="o">=</span> <span class="sh">'</span><span class="s">cartographer_ros</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span> <span class="o">=</span> <span class="sh">'</span><span class="s">cartographer_occupancy_grid_node</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">)}],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">use_sim_time_arg</span><span class="p">,</span>
        <span class="n">resolution_arg</span><span class="p">,</span>
        <span class="n">cartographer_node</span><span class="p">,</span>
        <span class="n">cartographer_occupancy_grid_node</span><span class="p">,</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该launch文件主要是加载了cartographer_ros下的cartographer_node与cartographer_occupancy_grid_node节点，并且会从当前功能包的params下读取一个名为mycar.lua的配置文件。这个配置文件还不存在，接下来需要在params目录下新建mycar.lua文件，并输入如下内容：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="n">include</span> <span class="s2">"map_builder.lua"</span> <span class="c1">-- 地图构建器</span>
<span class="n">include</span> <span class="s2">"trajectory_builder.lua"</span> <span class="c1">-- 轨迹构建器</span>

<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">map_builder</span> <span class="o">=</span> <span class="n">MAP_BUILDER</span><span class="p">,</span>
  <span class="n">trajectory_builder</span> <span class="o">=</span> <span class="n">TRAJECTORY_BUILDER</span><span class="p">,</span>
  <span class="n">map_frame</span> <span class="o">=</span> <span class="s2">"map"</span><span class="p">,</span>  <span class="c1">-- 地图坐标系</span>
  <span class="n">tracking_frame</span> <span class="o">=</span> <span class="s2">"base_link"</span><span class="p">,</span> <span class="c1">-- 跟踪的坐标系，可以是基坐标系、雷达或imu的坐标系</span>
  <span class="n">published_frame</span> <span class="o">=</span> <span class="s2">"odom"</span><span class="p">,</span> <span class="c1">-- cartographer发布的位姿（pose）的坐标系</span>
  <span class="n">odom_frame</span> <span class="o">=</span> <span class="s2">"carto_odom"</span><span class="p">,</span>  <span class="c1">-- cartographer 计算后优化的里程计，并非机器人本身里程计</span>
  <span class="n">provide_odom_frame</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">-- 是否发布cartographer的里程计</span>
  <span class="n">publish_frame_projected_to_2d</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 是否转换成2d(无俯仰、滚动的情况下为 true)</span>
  <span class="n">use_odometry</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 是否订阅里程计数据</span>
  <span class="n">use_nav_sat</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">-- 是否订阅GPS</span>
  <span class="n">use_landmarks</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">-- 是否订阅路标</span>
  <span class="n">num_laser_scans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">-- 订阅的雷达的数量</span>
  <span class="n">num_multi_echo_laser_scans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">-- 订阅的多层回波激光雷达数量</span>
  <span class="n">num_subdivisions_per_laser_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">-- 将激光雷达的数据拆分成多少部分发布</span>
  <span class="n">num_point_clouds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">-- 订阅多线激光雷达的数量</span>
  <span class="n">lookup_transform_timeout_sec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="c1">-- 坐标变换超时时间</span>
  <span class="n">submap_publish_period_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="c1">-- 发布子图的时间间隔</span>
  <span class="n">pose_publish_period_sec</span> <span class="o">=</span> <span class="mf">5e-3</span><span class="p">,</span> <span class="c1">-- 发布pose的时间间隔</span>
  <span class="n">trajectory_publish_period_sec</span> <span class="o">=</span> <span class="mf">30e-3</span><span class="p">,</span> <span class="c1">-- 发布轨迹的时间间隔</span>
  <span class="n">rangefinder_sampling_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.,</span> <span class="c1">-- 雷达采样比例</span>
  <span class="n">odometry_sampling_ratio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="c1">-- 里程计采样比例(如果里程计精度低，可以减小该设置值)</span>
  <span class="n">fixed_frame_pose_sampling_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.,</span> <span class="c1">-- 参考坐标系采样比例</span>
  <span class="n">imu_sampling_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.,</span><span class="c1">-- imu采样比例</span>
  <span class="n">landmarks_sampling_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.,</span> <span class="c1">-- 路标采样比例</span>
<span class="p">}</span>

<span class="n">MAP_BUILDER</span><span class="p">.</span><span class="n">use_trajectory_builder_2d</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">-- 启用2D轨迹构建器</span>

<span class="n">TRAJECTORY_BUILDER_2D</span><span class="p">.</span><span class="n">min_range</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">15</span> <span class="c1">-- 最小雷达有效距离</span>
<span class="n">TRAJECTORY_BUILDER_2D</span><span class="p">.</span><span class="n">max_range</span> <span class="o">=</span> <span class="mi">6</span><span class="p">.</span><span class="mi">0</span> <span class="c1">-- 最大雷达有效距离</span>
<span class="n">TRAJECTORY_BUILDER_2D</span><span class="p">.</span><span class="n">missing_data_ray_length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span> <span class="c1">-- 缺失数据的射线长度</span>
<span class="n">TRAJECTORY_BUILDER_2D</span><span class="p">.</span><span class="n">use_imu_data</span> <span class="o">=</span> <span class="kc">false</span> <span class="c1">-- 是否使用 imu 数据</span>
<span class="n">TRAJECTORY_BUILDER_2D</span><span class="p">.</span><span class="n">use_online_correlative_scan_matching</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">-- 是否使用在线相关扫描匹配</span>
<span class="n">TRAJECTORY_BUILDER_2D</span><span class="p">.</span><span class="n">motion_filter</span><span class="p">.</span><span class="n">max_angle_radians</span> <span class="o">=</span> <span class="nb">math.rad</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="c1">-- 运动滤波器的最大角度限制（以弧度为单位）</span>

<span class="n">POSE_GRAPH</span><span class="p">.</span><span class="n">constraint_builder</span><span class="p">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">65</span> <span class="c1">-- 建约束时的最小分数</span>
<span class="n">POSE_GRAPH</span><span class="p">.</span><span class="n">constraint_builder</span><span class="p">.</span><span class="n">global_localization_min_score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span> <span class="c1">-- 全局定位时的最小分数</span>

<span class="c1">-- POSE_GRAPH.optimize_every_n_nodes = 0</span>

<span class="k">return</span> <span class="n">options</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>配置文件的内容需要根据实际情况进行动态调整。</p>

<ol>
  <li>编辑配置文件</li>
</ol>

<p>打开<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> 并输入如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>DIRECTORY launch params
  DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>编译</li>
</ol>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_slam_cartographer
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>执行</li>
</ol>

<p>（1）请先调用如下指令启动仿真环境：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch stage_ros2 my_house.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（2）然后在终端下进入当前工作空间，输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch mycar_slam_cartographer cartographer.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（3）启动rviz2，将Fixed Frame设置为map，添加map插件并将话题设置为/map，即可显示创建的地图了，当机器人运动时，地图也会随之更新。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1749.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1750.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1751.webp" alt="" /></p>

<h2 id="地图服务">地图服务</h2>

<p>SLAM建图时，地图数据是保存在内存中的，这也意味着，一旦节点关闭，数据也会一并被释放，而更合理的实现应该是将构建的地图序列化到的磁盘以持久化存储，并且后期还要通过反序列化读取磁盘的地图数据以做其他操作。在Nav2中已经已经封装好了地图序列化和反序列化的相关功能包，该包是：<code class="language-plaintext highlighter-rouge">nav2_map_server</code>。</p>

<p>在<code class="language-plaintext highlighter-rouge">nav2_map_server</code>中，可以通过话题和服务接口与Nav2系统的其余部分进行交互。<code class="language-plaintext highlighter-rouge">nav2_map_server</code>包下有两个重要的节点，分别是<code class="language-plaintext highlighter-rouge">map_saver_cli</code>和<code class="language-plaintext highlighter-rouge">map_server</code>，通过<code class="language-plaintext highlighter-rouge">map_saver_cli</code>节点则可以保存地图，而<code class="language-plaintext highlighter-rouge">map_server</code>节点则可以在启动时显示地图。</p>

<h3 id="保存地图序列化">保存地图(序列化)</h3>

<h4 id="地图保存节点说明">地图保存节点说明</h4>

<p>在<code class="language-plaintext highlighter-rouge">nav2_map_server</code>中的地图保存节点是<code class="language-plaintext highlighter-rouge">map_saver_server</code>，该节点相关信息如下。</p>

<ol>
  <li>订阅的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/map</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">SLAM节点发布的地图数据</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>参数</li>
</ol>

<ul>
  <li>
    <p><strong>save_map_timeout</strong>  保存地图操作的最大等待时间。</p>
  </li>
  <li>
    <p><strong>free_thresh_default</strong>  栅格单元被认为未被占用的概率阈值。</p>
  </li>
  <li>
    <p><strong>occupied_thresh_default</strong>  栅格单元被认为占用的概率阈值。</p>
  </li>
  <li>
    <p><strong>map_subscribe_transient_local</strong>  节点重启后消息不保留，默认为 true。</p>
  </li>
</ul>

<ol>
  <li>map_saver_cli</li>
</ol>

<p>另外，而为了便于使用，在<code class="language-plaintext highlighter-rouge">map_saver_server</code>的基础之上还封装了一个名为<code class="language-plaintext highlighter-rouge">map_saver_cli</code>的可执行程序，它可以以实参的方式更方便的设置地图保存相关数据，并且后续执行时也是调用<code class="language-plaintext highlighter-rouge">map_saver_cli</code>，其实参列表如下：</p>

<ul>
  <li>
    <p><strong>-t</strong> 订阅的地图话题。</p>
  </li>
  <li>
    <p><strong>-f</strong> 地图存储路径。</p>
  </li>
  <li>
    <p><strong>--occ</strong> 栅格单元被认为占用的概率阈值。</p>
  </li>
  <li>
    <p><strong>--free</strong> 栅格单元被认为未被占用的概率阈值。</p>
  </li>
  <li>
    <p><strong>--fmt</strong> 图片格式。</p>
  </li>
  <li>
    <p><strong>--mode</strong> 地图模式，trinary(默认)或scale或raw。</p>
  </li>
</ul>

<h4 id="地图保存基本操作">地图保存基本操作</h4>

<p><strong>准备工作</strong></p>

<p>请先启动仿真或实体机器人，然后启动SLAM相关节点，实现基本的建图功能。</p>

<p><strong>保存地图</strong></p>

<p>SLAM建图完毕，在终端下进入工作空间，调用如下指令保存地图：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run nav2_map_server map_saver_cli <span class="nt">-f</span> map/my_map
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述指令将订阅/map话题，并把/map话题里的数据保存为文件，在工作空间下的map目录(<em>需要自行创建该目录，否则将会抛出异常</em>)中，生成两个文件，分别名为：<code class="language-plaintext highlighter-rouge">my_map.yaml</code>和<code class="language-plaintext highlighter-rouge">my_map.pgm</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1752.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1753.webp" alt="" /></p>

<h4 id="地图接口">地图接口</h4>

<p>在Nav2中地图相关的接口主要有两个：</p>

<ul>
  <li>
    <p><strong>nav_msgs/msg/MapMetaData</strong> 地图元数据，包括地图的宽度、高度、分辨率等。</p>
  </li>
  <li>
    <p><strong>nav_msgs/msg/OccupancyGrid</strong> 地图栅格数据，一般会在rviz中以图形化的方式显示。</p>
  </li>
</ul>

<p><strong>nav_msgs/msg/MapMetaData</strong></p>

<p>调用指令<code class="language-plaintext highlighter-rouge">ros2 interface show nav_msgs/msg/MapMetaData</code>查看接口格式，显示如下内容（注释已汉化）：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>
<span class="c"># 它包含了关于OccupancyGrid特性的基本信息</span>

<span class="c"># 地图加载时间</span>
builtin_interfaces/Time map_load_time
        int32 sec
        uint32 nanosec

<span class="c"># 地图分辨率 [米/像素]</span>
float32 resolution

<span class="c"># 地图宽度 [像素]</span>
uint32 width

<span class="c"># 地图高度 [像素]</span>
uint32 height

<span class="c">#地图的原点坐标[米，米，弧度]。这是地图中单元格(0,0)左下角在现实世界中的位置和方向。</span>
geometry_msgs/Pose origin
        Point position
                float64 x
                float64 y
                float64 z
        Quaternion orientation
                float64 x 0
                float64 y 0
                float64 z 0
                float64 w 1
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>nav_msgs/msg/OccupancyGrid</strong></p>

<p>调用指令<code class="language-plaintext highlighter-rouge">ros2 interface show nav_msgs/msg/OccupancyGrid</code>查看接口格式，显示如下内容（注释已汉化）：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre>
<span class="c"># 它代表一个二维网格地图。</span>
std_msgs/Header header
        builtin_interfaces/Time stamp
                int32 sec
                uint32 nanosec
        string frame_id

<span class="c"># 地图元数据</span>
MapMetaData info
        builtin_interfaces/Time map_load_time
                int32 sec
                uint32 nanosec
        float32 resolution
        uint32 width
        uint32 height
        geometry_msgs/Pose origin
                Point position
                        float64 x
                        float64 y
                        float64 z
                Quaternion orientation
                        float64 x 0
                        float64 y 0
                        float64 z 0
                        float64 w 1

<span class="c"># 地图数据按照行优先的顺序进行排列，</span>

<span class="c"># 这意味着首先填充第一行的所有单元格，</span>

<span class="c"># 然后填充第二行，依此类推。</span>

<span class="c"># 起始单元格是(0,0)，也就是地图的左上角。</span>

<span class="c"># 单元格(1, 0)紧接着(0,0)，是x方向上紧邻的下一个单元格。</span>

<span class="c"># 而单元格(0, 1)则位于第一行的第二个位置，其索引等于地图的宽度（info.width），</span>

<span class="c"># 然后才是(1, 1)单元格，即第二行的第二个单元格。</span>

<span class="c"># 关于地图数据的值，它们根据具体的应用需求来定义。但在很多情况下，</span>

<span class="c"># 会使用0表示该单元格是未占用的，即机器人可以安全通过；</span>

<span class="c"># 1表示该单元格是确定占用的，即存在障碍物；</span>

<span class="c"># 而-1表示该单元格的状态是未知的，即机器人尚未探测到该区域的状态。</span>
int8[] data
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="地图存储格式">地图存储格式</h4>

<p>在 <strong>地图保存基本操作</strong>  一节中，地图保存后后生成两个文件，这两个文件就是用来存储序列化后的地图数据的。其中，my_map.pgm是一张图片资源，使用图片查看程序打开即可，而my_map.yaml保存的是地图的元数据信息，用于描述图片，内容格式如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="na">image</span><span class="pi">:</span> <span class="s">my_map.pgm</span>
<span class="na">mode</span><span class="pi">:</span> <span class="s">trinary</span>
<span class="na">resolution</span><span class="pi">:</span> <span class="m">0.05</span>
<span class="na">origin</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">-0.955</span><span class="pi">,</span> <span class="nv">-10.9</span><span class="pi">,</span> <span class="nv">0</span><span class="pi">]</span>
<span class="na">negate</span><span class="pi">:</span> <span class="m">0</span>
<span class="na">occupied_thresh</span><span class="pi">:</span> <span class="m">0.65</span>
<span class="na">free_thresh</span><span class="pi">:</span> <span class="m">0.25</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>参数解释：</strong></p>

<ul>
  <li>
    <p><strong>image</strong>  被描述的图片资源路径，可以是绝对路径也可以是相对路径。</p>
  </li>
  <li>
    <p><strong>resolution</strong> 图片分片率(单位: m/像素)。</p>
  </li>
  <li>
    <p><strong>origin</strong> 地图中左下像素的二维姿态，为（x，y，z），偏航为逆时针旋转（偏航=0 表示无旋转）。</p>
  </li>
  <li>
    <p><strong>occupied_thresh</strong> 占用概率大于此阈值的像素被视为完全占用。</p>
  </li>
  <li>
    <p><strong>free_thresh</strong> 占用率小于此阈值的像素被视为完全空闲。</p>
  </li>
  <li>
    <p><strong>negate</strong> 是否应该颠倒白色/黑色 自由/占用的语义。</p>
  </li>
  <li>
    <p><strong>mode</strong>  地图模式，trinary(默认)或scale或raw。</p>
  </li>
</ul>

<h3 id="读取地图反序列化">读取地图(反序列化)</h3>

<h4 id="地图读取节点说明">地图读取节点说明</h4>

<p>在<code class="language-plaintext highlighter-rouge">nav2_map_server</code>中的地图读取节点是<code class="language-plaintext highlighter-rouge">map_server</code>，该节点相关信息如下。</p>

<p><strong>发布的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/map</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">地图数据</td>
    </tr>
  </tbody>
</table>

<p><strong>参数</strong></p>

<ul>
  <li>
    <p><strong>frame_id</strong>  地图坐标系名称。</p>
  </li>
  <li>
    <p><strong>topic_name</strong>  话题名称。</p>
  </li>
  <li>
    <p><strong>yaml_filename</strong>  地图数据源。</p>
  </li>
</ul>

<h4 id="地图读取基本操作">地图读取基本操作</h4>

<p><strong>准备工作</strong></p>

<p>请先调用如下指令在工作空间的src目录下创建一个功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create mycar_map_server <span class="nt">--dependencies</span> nav2_map_server
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在功能包下，新建launch文件夹，并在CMakeLists.txt中添加如下配置：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>DIRECTORY launch DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1754.webp" alt="" /></p>

<p><strong>读取地图</strong></p>

<p>使用<code class="language-plaintext highlighter-rouge">map_server</code>读取地图时，常用的方式有两种，分别是使用终端指令与launch文件集成。两种方式效果一致，都可以以话题的方式发布地图消息。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>colcon build
<span class="nb">source</span> ./install/setup.bash
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>方式1：终端指令</strong></p>

<p>请在终端下进入工作空间，输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run nav2_map_server map_server <span class="nt">--ros-args</span> <span class="nt">-p</span> yaml_filename:<span class="o">=</span>map/my_map.yaml
</pre></td></tr></tbody></table></code></pre></div></div>

<p>由于<code class="language-plaintext highlighter-rouge">map_server</code>是具有生命周期的节点，所以接下来还需要对节点进行配置和激活，请新开终端执行如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>ros2 lifecycle <span class="nb">set</span> /map_server configure
ros2 lifecycle <span class="nb">set</span> /map_server activate
</pre></td></tr></tbody></table></code></pre></div></div>

<p>执行完毕若无异常，再调用<code class="language-plaintext highlighter-rouge">ros2 topic list</code>即可查看到<code class="language-plaintext highlighter-rouge">/map</code>话题了，说明地图消息已经被发布了。</p>

<p><strong>方式2：launch集成</strong></p>

<p>方式1需要手动设置<code class="language-plaintext highlighter-rouge">map_server</code>生命周期，步骤稍显繁琐，因此，我们还可以将该节点集成进launch文件，以简化启动步骤。在launch目录下新建名为<code class="language-plaintext highlighter-rouge">map_server.launch.py</code>的文件，并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
  <span class="n">map_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">'</span><span class="s">map</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">my_map.yaml</span><span class="sh">'</span><span class="p">)</span>
  <span class="n">map_server_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
      <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_map_server</span><span class="sh">'</span><span class="p">,</span>
      <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">map_server</span><span class="sh">'</span><span class="p">,</span>
      <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">map_server</span><span class="sh">'</span><span class="p">,</span>
      <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
      <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                  <span class="p">{</span><span class="sh">'</span><span class="s">yaml_filename</span><span class="sh">'</span><span class="p">:</span><span class="n">map_file</span><span class="p">}]</span>
  <span class="p">)</span>
  <span class="n">manager_mapper_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_lifecycle_manager</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">lifecycle_manager</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">lifecycle_manager_mapper</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
      <span class="p">{</span><span class="sh">'</span><span class="s">autostart</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
      <span class="p">{</span><span class="sh">'</span><span class="s">node_names</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">map_server</span><span class="sh">'</span><span class="p">]}]</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">map_server_node</span><span class="p">,</span><span class="n">manager_mapper_node</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在该文件中，使用了功能包中<code class="language-plaintext highlighter-rouge">nav2_lifecycle_manager</code>中的<code class="language-plaintext highlighter-rouge">lifecycle_manager</code>组件，该组件可以自动的配置、激活其所管理的具有生命周期的节点。构建功能包后并执行该launch文件，其最终效果与方式一类似。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch mycar_map_server map_server.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>显示地图</strong></p>

<p>打开rviz2，然后添加Map插件，并将话题设置为/map，并将该话题的<code class="language-plaintext highlighter-rouge">Durability Policy</code></p>

<p>选项设置为<code class="language-plaintext highlighter-rouge">Transient Local</code>，就可以正常显示地图数据了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1755.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1756.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1757.webp" alt="" /></p>

<h2 id="amcl自适应蒙特卡洛定位">AMCL自适应蒙特卡洛定位</h2>

<p>定位是机器人在已知地图上确定自身位置的过程，为机器人的导航提供了基础信息。</p>

<p>Nav2中的定位技术技术称之为AMCL，全称Adaptive Monte Carlo Localization，即自适应蒙特卡洛定位，是一种基于粒子滤波器的定位算法。它通过蒙特卡洛方法进行自适应定位，利用对机器人周围环境的感知和观测数据的分析，来确定机器人在环境中的位置和姿态。在Nav2中对应的功能包为<code class="language-plaintext highlighter-rouge">nav2_amcl</code>。</p>

<p>在AMCL中，粒子滤波器的核心思想是使用一组粒子（样本）来代表机器人在地图上的可能位置。每个粒子都有一个权重，表示该粒子所代表的位置的置信度。算法会根据机器人的运动模型和传感器数据来更新这些粒子的位置和权重。随着时间的推移，粒子会逐渐收敛到机器人实际位置附近，从而实现对机器人位置的准确估计。</p>

<h3 id="定位节点说明">定位节点说明</h3>

<p>功能包<code class="language-plaintext highlighter-rouge">nav2_amcl</code>中的核心节点为amcl。该节点相关信息如下。</p>

<p><strong>1.订阅的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/map</td>
      <td style="text-align: left">/nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">地图数据</td>
    </tr>
    <tr>
      <td style="text-align: left">/scan</td>
      <td style="text-align: left">/sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">激光雷达数据</td>
    </tr>
    <tr>
      <td style="text-align: left">/initialpose</td>
      <td style="text-align: left">/geometry_msgs/msg/PoseWithCovarianceStamped</td>
      <td style="text-align: left">用来初始化粒子滤波器的均值和协方差</td>
    </tr>
    <tr>
      <td style="text-align: left">/tf</td>
      <td style="text-align: left">/tf2_msgs/msg/TFMessage</td>
      <td style="text-align: left">坐标变换消息</td>
    </tr>
  </tbody>
</table>

<p><strong>2.发布的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/amcl_pose</td>
      <td style="text-align: left">/geometry_msgs/msg/PoseWithCovarianceStamped</td>
      <td style="text-align: left">机器人在地图中的位姿估计</td>
    </tr>
    <tr>
      <td style="text-align: left">/particle_cloud</td>
      <td style="text-align: left">/nav2_msgs/msg/ParticleCloud</td>
      <td style="text-align: left">位姿估计集合，rviz中可以被 PoseArray 订阅然后图形化显示机器人的位姿估计集合</td>
    </tr>
    <tr>
      <td style="text-align: left">/tf</td>
      <td style="text-align: left">/tf2_msgs/msg/TFMessage</td>
      <td style="text-align: left">发布从 odom 与 map 的转换</td>
    </tr>
  </tbody>
</table>

<p><strong>3.发布的服务</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/reinitialize_global_localization</td>
      <td style="text-align: left">std_srvs/srv/Empty</td>
      <td style="text-align: left">在全局范围内初始化粒子位姿</td>
    </tr>
    <tr>
      <td style="text-align: left">/request_nomotion_update</td>
      <td style="text-align: left">std_srvs/srv/Empty</td>
      <td style="text-align: left">在没有运动模型更新的情况下手动触发粒子群的更新</td>
    </tr>
  </tbody>
</table>

<p><strong>4.参数</strong></p>

<p><strong>通用参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bond_disable_heartbeat_timeout</code>: 设置为<code class="language-plaintext highlighter-rouge">true</code>时，禁用amcl节点与其他节点之间基于心跳的超时检测。这通常用于当节点之间的连接非常稳定，不需要频繁的心跳检测来确认连接状态时。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">base_frame_id</code>: 定义机器人基坐标系的ID，通常是<code class="language-plaintext highlighter-rouge">base_link</code>或类似的名称。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">global_frame_id</code>: 定义全局地图坐标系的ID，通常是<code class="language-plaintext highlighter-rouge">map</code>。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">odom_frame_id</code>: 定义里程计坐标系的ID，通常是<code class="language-plaintext highlighter-rouge">odom</code>。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tf_broadcast</code>: 设置为<code class="language-plaintext highlighter-rouge">true</code>时，amcl节点会发布从里程计坐标系到全局地图坐标系的变换。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">transform_tolerance</code>: 设置TF变换的容忍度，用于处理TF树中的时间不一致性。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 设置为<code class="language-plaintext highlighter-rouge">true</code>时，amcl将使用ROS 2的模拟时间（如果可用）。这在仿真环境中很有用。</p>
  </li>
</ul>

<p><strong>激光模型参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">laser_model_type</code>: 设置激光模型类型，<code class="language-plaintext highlighter-rouge">likelihood_field</code>是一种常用的模型，它考虑了激光束击中障碍物的概率。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">laser_max_range</code>和<code class="language-plaintext highlighter-rouge">laser_min_range</code>: 分别设置激光雷达的最大和最小探测范围。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">laser_likelihood_max_dist</code>: 设置激光模型考虑的最大距离，超过这个距离的数据将被忽略。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">do_beamskip</code>和相关参数（<code class="language-plaintext highlighter-rouge">beam_skip_distance</code>、<code class="language-plaintext highlighter-rouge">beam_skip_threshold</code>、<code class="language-plaintext highlighter-rouge">beam_skip_error_threshold</code>）: 这些参数用于控制是否跳过某些激光束的处理，以减少计算量。然而，<code class="language-plaintext highlighter-rouge">do_beamskip</code>被设置为<code class="language-plaintext highlighter-rouge">false</code>，意味着不跳过任何激光束。</p>
  </li>
</ul>

<p><strong>粒子滤波器参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">alpha1</code><strong>到</strong><code class="language-plaintext highlighter-rouge">alpha5</code>: 这些参数用于控制粒子滤波器中的权重更新过程，但它们的具体作用可能因amcl的实现而异。在标准的amcl实现中，这些参数可能不是直接使用的。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">max_particles</code>和<code class="language-plaintext highlighter-rouge">min_particles</code>: 分别设置粒子滤波器的最大和最小粒子数。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">resample_interval</code>: 设置在重采样前需要的滤波更新次数。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">pf_err</code>和<code class="language-plaintext highlighter-rouge">pf_z</code>: 这些参数用于控制粒子滤波器的性能，但它们的具体作用可能依赖于amcl的实现细节。</p>
  </li>
</ul>

<p><strong>初始位姿参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">initial_pose</code>: 定义了机器人的初始位姿（x, y, yaw, z），但在实际使用中，如果<code class="language-plaintext highlighter-rouge">set_initial_pose</code>被设置为<code class="language-plaintext highlighter-rouge">true</code>，则这个初始位姿可能会被通过服务请求设置的初始位姿所覆盖。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">set_initial_pose</code>: 设置为<code class="language-plaintext highlighter-rouge">true</code>时，允许通过服务请求来设置机器人的初始位姿。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">always_reset_initial_pose</code>: 设置为<code class="language-plaintext highlighter-rouge">false</code>时，表示不会在每个定位会话开始时自动重置初始位姿。</p>
  </li>
</ul>

<p><strong>其他参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">first_map_only</code>: 当设置为<code class="language-plaintext highlighter-rouge">false</code>时，表示amcl将订阅并处理不断更新的地图话题。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">map_topic</code>: 定义地图话题的名称，amcl将订阅这个话题以获取地图信息。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">scan_topic</code>: 定义激光雷达扫描数据话题的名称，amcl将订阅这个话题以获取用于定位的数据。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">save_pose_rate</code>: 设置保存机器人位姿的速率（以Hz为单位）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">recovery_alpha_fast</code>和<code class="language-plaintext highlighter-rouge">recovery_alpha_slow</code>: 这些参数在标准的amcl实现中可能不是直接使用的，它们可能属于某个特定版本的amcl或扩展。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">z_hit</code>、<code class="language-plaintext highlighter-rouge">z_rand</code>、<code class="language-plaintext highlighter-rouge">z_short</code>、<code class="language-plaintext highlighter-rouge">z_max</code>和<code class="language-plaintext highlighter-rouge">sigma_hit</code>: 这些参数定义了激光模型中的概率分布，用于计算激光束击中障碍物或随机位置的概率。</p>
  </li>
</ul>

<h3 id="定位节点基本操作">定位节点基本操作</h3>

<p><strong>1.准备工作</strong></p>

<p>请先调用如下指令在工作空间的src目录下创建一个功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create mycar_localization <span class="nt">--dependencies</span> nav2_amcl mycar_map_server
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>2.编写launch文件与参数文件</strong></p>

<p>在功能包下，新建launch和params文件夹，在launch目录下新建名为<code class="language-plaintext highlighter-rouge">mycar_loca.launch.py</code>的文件，并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">amcl_yaml</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">mycar_localization</span><span class="sh">'</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">params</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amcl.yaml</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">amcl_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_amcl</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">amcl</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">amcl</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">amcl_yaml</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">manager_localization_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_lifecycle_manager</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">lifecycle_manager</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">lifecycle_manager_localization</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">autostart</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">node_names</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">amcl</span><span class="sh">'</span><span class="p">]}]</span>
    <span class="p">)</span>
    <span class="n">map_server_launch</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="n">launch_description_source</span><span class="o">=</span><span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="n">launch_file_path</span><span class="o">=</span><span class="p">([</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_map_server</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">/launch/map_server.launch.py</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span><span class="n">amcl_node</span><span class="p">,</span><span class="n">manager_localization_node</span><span class="p">,</span><span class="n">map_server_launch</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在上述代码中，创建了<code class="language-plaintext highlighter-rouge">amcl</code>节点，并从<code class="language-plaintext highlighter-rouge">params</code>目录加载了名为<code class="language-plaintext highlighter-rouge">amcl.yaml</code>的配置文件，且由于<code class="language-plaintext highlighter-rouge">amcl</code>也是拥有生命周期的节点，所以将其添加进了生命周期管理器。最后，定位必须依赖于地图信息，因此又包含了 <strong>地图读取基本操作</strong>  中的launch文件，以加载地图。</p>

<p>在params目录下新建名为<code class="language-plaintext highlighter-rouge">amcl.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">alpha1</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">alpha2</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">alpha3</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">alpha4</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">alpha5</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">base_frame_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">base_link"</span>
    <span class="na">beam_skip_distance</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">beam_skip_error_threshold</span><span class="pi">:</span> <span class="m">0.9</span>
    <span class="na">beam_skip_threshold</span><span class="pi">:</span> <span class="m">0.3</span>
    <span class="na">do_beamskip</span><span class="pi">:</span> <span class="kc">false</span>
    <span class="na">global_frame_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">map"</span>
    <span class="na">lambda_short</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">laser_likelihood_max_dist</span><span class="pi">:</span> <span class="m">2.0</span>
    <span class="na">laser_max_range</span><span class="pi">:</span> <span class="m">100.0</span>
    <span class="na">laser_min_range</span><span class="pi">:</span> <span class="s">-1.0</span>
    <span class="na">laser_model_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">likelihood_field"</span>
    <span class="na">max_beams</span><span class="pi">:</span> <span class="m">60</span>
    <span class="na">max_particles</span><span class="pi">:</span> <span class="m">2000</span>
    <span class="na">min_particles</span><span class="pi">:</span> <span class="m">500</span>
    <span class="na">odom_frame_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">odom"</span>
    <span class="na">pf_err</span><span class="pi">:</span> <span class="m">0.05</span>
    <span class="na">pf_z</span><span class="pi">:</span> <span class="m">0.99</span>
    <span class="na">recovery_alpha_fast</span><span class="pi">:</span> <span class="m">0.0</span>
    <span class="na">recovery_alpha_slow</span><span class="pi">:</span> <span class="m">0.0</span>
    <span class="na">resample_interval</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">robot_model_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_amcl::DifferentialMotionModel"</span>
    <span class="na">save_pose_rate</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">sigma_hit</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">tf_broadcast</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">transform_tolerance</span><span class="pi">:</span> <span class="m">2.0</span>
    <span class="na">update_min_a</span><span class="pi">:</span> <span class="m">0.2</span>
    <span class="na">update_min_d</span><span class="pi">:</span> <span class="m">0.25</span>
    <span class="na">z_hit</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">z_max</span><span class="pi">:</span> <span class="m">0.05</span>
    <span class="na">z_rand</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">z_short</span><span class="pi">:</span> <span class="m">0.05</span>
    <span class="na">scan_topic</span><span class="pi">:</span> <span class="s">scan</span>
    <span class="na">set_initial_pose</span><span class="pi">:</span> <span class="kc">false</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>关于参数的具体含义，可以参考 <strong>定位节点说明</strong> 中参数相关内容。</p>

<p><strong>3.编辑配置文件</strong></p>

<p>打开<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> 并输入如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>DIRECTORY launch params
  DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>4.编译</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_localization
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>5.执行</strong></p>

<p>（1）请先调用如下指令启动仿真环境：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch stage_ros2 my_house.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（2）然后在终端下进入当前工作空间，输入如下指令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch mycar_localization mycar_loca.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（3）启动键盘控制节点以作备用：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run teleop_twist_keyboard teleop_twist_keyboard
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（4）在rviz2中，将Fixed Frme设置为map，添加TF插件，按照 <strong>地图读取基本操作</strong>  添加并显示地图。</p>

<p>接下来，点击rviz2菜单栏的<code class="language-plaintext highlighter-rouge">2D Pose Estimate</code>在地图中为机器人设置一个初始位姿。</p>

<p>这里需要给一个大概的机器人位置和机器人的朝向，不是很准确也可以，机器人会在运动中逐渐通过AMCL校准。</p>

<p>先点击<code class="language-plaintext highlighter-rouge">2D Pose Estimate</code>，左键在地图上点击机器人所在位置，长摁别松手，鼠标往机器人朝向的位置划，出现下方这种绿色箭头，再松手即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1758.webp" alt="" /></p>

<p>再添加<code class="language-plaintext highlighter-rouge">ParticleCloud</code>插件，将话题设置为<code class="language-plaintext highlighter-rouge">/particle_cloud</code>，并将话题下<code class="language-plaintext highlighter-rouge">Reliability Policy</code>设置为<code class="language-plaintext highlighter-rouge">Best Effort</code>，最后使用键盘控制机器人运动时，会发现，机器人周边会出现点云，并且随着机器人的运动，点云会出现不同程度的收敛或发散。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1759.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1760.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1761.webp" alt="" /></p>

<p>即便你的机器人撞墙了，rviz2和Gazebo的机器人位置完全偏移了，只要再让机器人运动一会儿，机器人位置会被重新预估出来，AMCL非常强。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1762.webp" alt="" /></p>

<p>如上图位置已经完全偏移了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1763.webp" alt="" /></p>

<p>经过一段时间行驶，姿态位置再次被预估成功。</p>

<h2 id="导航服务器">导航服务器</h2>

<p>本节将介绍导航服务器中核心节点，实现基本导航功能，并将导航与SLAM集成，以实现自主探索建图。</p>

<p>下方网站是官方NAV2的各个节点的参数说明(<strong>调参的时候非常常用的网站</strong>):</p>

<p>https://docs.nav2.org/configuration/index.html</p>

<p>看不懂的英文可以用沉浸式翻译这个chrome插件来翻译,可以进行中英文对照翻译,非常好用.</p>

<p>https://chromewebstore.google.com/detail/%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%BF%BB%E8%AF%91-%E7%BD%91%E9%A1%B5%E7%BF%BB%E8%AF%91%E6%8F%92%E4%BB%B6-pdf%E7%BF%BB%E8%AF%91-%E5%85%8D%E8%B4%B9/bpoadfkcbjbfhfodiogcnhhhpibjhbnh?utm_source=official&amp;pli=1</p>

<p>https://microsoftedge.microsoft.com/addons/detail/%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%BF%BB%E8%AF%91-%E7%BD%91%E9%A1%B5%E7%BF%BB%E8%AF%91%E6%8F%92%E4%BB%B6-pdf%E7%BF%BB%E8%AF%91-/amkbmndfnliijdhojkpoglbnaaahippg?utm_source=official</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1764.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1765.webp" alt="" /></p>

<p>不会用这个插件的话,也可以看鱼香ROS翻译好的版本(但是网站不稳定):</p>

<p>http://fishros.org/doc/nav2/configuration/index.html</p>

<h3 id="生命周期管理节点说明">生命周期管理节点说明</h3>

<p>Nav2中通过的<code class="language-plaintext highlighter-rouge">nav2_lifecycle_manager</code>功能包下的<code class="language-plaintext highlighter-rouge">lifecycle_manager</code>节点管理其他节点的生命周期状态转换。<code class="language-plaintext highlighter-rouge">lifecycle_manager</code>节点通过ROS 2的生命周期节点（Lifecycle Node）机制，提供了一种标准化的方法来控制Nav2中各个节点的状态转换。这些状态包括未配置（Unconfigured）、非活动（Inactive）、活动（Active）和结束（Finalized）等。通过精细控制这些状态转换，<code class="language-plaintext highlighter-rouge">lifecycle_manager</code>节点能够确保Nav2系统的各个部分在正确的时机启动、运行和停止，从而提高系统的可靠性和稳定性。</p>

<p><strong>参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/bond_disable_heartbeat_timeout</code>: 该参数与节点之间的通信绑定（bonding）有关。节点之间的通信可以通过绑定来增强可靠性，而心跳超时是检测节点是否仍然活跃的一种方式。设置为<code class="language-plaintext highlighter-rouge">false</code>意味着启用心跳超时检测。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">attempt_respawn_reconnection</code>: 取值为bool值，设置为<code class="language-plaintext highlighter-rouge">true</code>时，表示如果管理的节点意外终止，生命周期管理器将尝试重新启动它。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">autostart</code>: 取值为bool值，设置为<code class="language-plaintext highlighter-rouge">true</code>时，表示在生命周期管理器启动时，它将自动尝试启动其管理的节点。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bond_respawn_max_duration</code>: 重新连接或重新启动节点时的最大持续时间。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bond_timeout</code>: 与节点之间的通信绑定超时有关。如果在这个时间内没有收到来自另一个节点的消息，则认为该节点已经断开连接。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">diagnostic_updater</code>:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">period</code>: 诊断更新器的更新周期。诊断更新器用于收集和发布有关节点状态的诊断信息，定义了这些信息更新的频率。</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">node_names</code>: 由该生命周期管理器管理的节点名称列表。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>:是否使用仿真实践。</p>
  </li>
</ul>

<h3 id="行为树节点说明">行为树节点说明</h3>

<p><strong>行为树（BT）</strong> 是一种在智能体（如机器人或电脑游戏中的虚拟实体）中构建不同任务之间切换结构的方式。它是一种形式化的图形建模语言，以层次化的节点组织为特征，用于描述和规划复杂系统中各种实体的交互和决策。<code class="language-plaintext highlighter-rouge">nav2_bt_navigator</code>功能包下的<code class="language-plaintext highlighter-rouge">/bt_navigator</code>是Nav2中的行为树导航器节点，它实现了基于行为树的导航策略。行为树是一种用于描述复杂行为的树状结构，通过组合不同的行为节点，可以灵活地定义机器人的导航行为，包括路径规划、避障、恢复等。以下是官网。</p>

<p>https://www.behaviortree.dev/</p>

<p>https://arxiv.org/abs/1709.00084</p>

<p>github链接如下：</p>

<p>https://github.com/BehaviorTree/BehaviorTree.CPP</p>

<p>BT可视化工具Groot2下载：</p>

<p>https://www.behaviortree.dev/groot/</p>

<ol>
  <li>订阅的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/goal_pose</td>
      <td style="text-align: left">geometry_msgs/msg/PoseStamped</td>
      <td style="text-align: left">导航目标点，用于触发导航任务</td>
    </tr>
    <tr>
      <td style="text-align: left">/tf</td>
      <td style="text-align: left">tf2_msgs/msg/TFMessage</td>
      <td style="text-align: left">坐标变换消息，用于不同坐标系之间的转换</td>
    </tr>
    <tr>
      <td style="text-align: left">/odom</td>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
      <td style="text-align: left">里程计数据，提供机器人位置和运动信息</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>请求的Action</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Action</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/navigate_to_pose</td>
      <td style="text-align: left">nav2_msgs/action/NavigateToPose</td>
      <td style="text-align: left">请求导航到指定位姿的Action，包括目标位姿和容忍度等参数</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>参数</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 指定是否使用模拟时间而非实际时间。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">global_frame</code>: 定义全局坐标系的名称，通常为地图坐标系。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">robot_base_frame</code>: 指定机器人基座的坐标系名称。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">odom_topic</code>: 里程计数据的ROS话题名称。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bt_loop_duration</code>: 行为树执行循环的持续时间（单位可能根据实现而异）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">default_server_timeout</code>: 导航服务器操作的默认超时时间。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">enable_groot_monitoring</code>: 启用或禁用Groot监控功能。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">groot_zmq_publisher_port</code>: Groot监控中ZeroMQ发布者的端口号。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">groot_zmq_server_port</code>: Groot监控中ZeroMQ服务器的端口号。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">plugin_lib_names</code>: 包含导航所需插件的库名称列表。</p>
  </li>
</ul>

<h3 id="规划器节点说明">规划器节点说明</h3>

<p>在Nav2 导航框架中<code class="language-plaintext highlighter-rouge">nav2_planner</code>功能包下的<code class="language-plaintext highlighter-rouge">planner_server</code>节点，负责处理路径规划请求，生成从当前位置到目标位置的路径。该节点在执行时需要依赖于<code class="language-plaintext highlighter-rouge">/global_costmap/global_costmap</code>节点提供的地图消息。</p>

<ol>
  <li>planner_server发布的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">当前位置到目标点的全局路径</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>planner_server 参数</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/bond_disable_heartbeat_timeout</code>: 这个参数控制是否禁用心跳超时检测，在ROS 2中，节点之间的通信绑定（bonding）机制用于增强通信的可靠性。心跳超时是检测节点是否仍然活跃的一种机制。如果该参数设置为<code class="language-plaintext highlighter-rouge">true</code>，则表示禁用了心跳超时检测，这可能在某些特定的网络环境下或当确信节点间通信非常稳定时使用。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">GridBased</code>: 这是一个配置块，专门用于设置基于网格的规划器的参数。基于网格的规划器通常使用地图的网格化表示来规划路径。</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">allow_unknown</code>: 控制规划器是否允许在地图的未知（即未探索）区域中规划路径。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">plugin</code>: 指定使用的规划器插件。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">tolerance</code>: 设置规划路径时的容忍度，通常用于考虑机器人尺寸和定位的不确定性。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">use_astar</code>: 控制是否使用A* 算法进行路径规划<em>。A*</em> 算法是一种启发式搜索算法，能够找到从起点到终点的最短路径。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">use_final_approach_orientation</code>: 控制规划器是否在路径的终点附近考虑机器人的最终朝向。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">expected_planner_frequency</code>: 这个参数表示对规划器生成新路径的频率的预期值。它帮助系统监控规划器的性能，并可能用于调试或性能优化。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">planner_plugins</code>: 这是一个列表，指定了可用的规划器插件。在这个例子中，它只包含了一个<code class="language-plaintext highlighter-rouge">GridBased</code>规划器，但理论上可以包含多个不同类型的规划器，以适应不同的导航需求。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 这个参数控制是否使用模拟时间。在仿真环境中，时间是由仿真软件控制的，而不是由实际的物理时钟控制的。将此参数设置为<code class="language-plaintext highlighter-rouge">true</code>允许节点在仿真环境中正常运行，而无需依赖实际的系统时间。这对于开发和测试导航算法非常有用。</p>
  </li>
</ul>

<ol>
  <li>/global_costmap/global_costmap订阅的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/global_costmap/footprint</td>
      <td style="text-align: left">geometry_msgs/msg/Polygon</td>
      <td style="text-align: left">机器人（或任何移动平台）的足迹（footprint）信息。足迹是机器人在地图上占据的空间形状，通常用多边形表示。</td>
    </tr>
    <tr>
      <td style="text-align: left">/map</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">发布环境地图，特别是用于导航的占用网格图（Occupancy Grid Map）。</td>
    </tr>
    <tr>
      <td style="text-align: left">/scan</td>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">激光扫描数据。</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>/global_costmap/global_costmap发布的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/global_costmap/costmap</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">发布全局代价地图的当前状态。</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">未经进一步处理的原始代价地图数据。</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/costmap_updates</td>
      <td style="text-align: left">map_msgs/msg/OccupancyGridUpdate</td>
      <td style="text-align: left">全局代价地图的更新，该消息可以高效更新地图。</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">发布机器人的足迹（footprint），即机器人在地图上占据的空间形状。</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>/global_costmap/global_costmap参数</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/bond_disable_heartbeat_timeout</code>: 控制是否禁用心跳超时检测，这在节点间通信绑定时用于监控对方节点的活跃度。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">always_send_full_costmap</code>: 控制是否总是发送完整的代价地图信息，而不是仅发送变化的部分。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">clearable_layers</code>: 列出可以被清除的代价图层，这些图层中的障碍物信息可以通过某种方式（如传感器数据）被更新或清除。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">filters</code>: 定义应用于代价地图的过滤器列表，用于预处理或修改地图数据。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">footprint</code>: 指定机器人在地图上的足迹形状，即机器人占据的空间范围。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">footprint_padding</code>: 为机器人的足迹添加额外的填充空间，以考虑机器人运动时的额外空间需求。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">global_frame</code>: 定义全局代价地图所使用的参考坐标系。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">height</code>和<code class="language-plaintext highlighter-rouge">width</code>: 定义全局代价地图的高度和宽度（以单元格数计）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">inflation_layer</code>: 配置膨胀层的参数，膨胀层用于在障碍物周围增加一定宽度的“缓冲区”，以避免机器人与障碍物过近。</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">cost_scaling_factor</code>: 膨胀成本的缩放因子。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">enabled</code>: 控制膨胀层是否启用。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">inflate_around_unknown</code>: 控制是否在未知空间周围进行膨胀。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">inflate_unknown</code>: 控制是否将未知空间视为障碍物并进行膨胀。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">inflation_radius</code>: 膨胀的半径。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">plugin</code>: 指定使用的膨胀层插件。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">lethal_cost_threshold</code>: 定义代价地图中视为“致命”障碍物的成本阈值。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">map_topic</code>: 指定订阅以获取地图信息的ROS话题。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">observation_sources</code>: 定义代价地图的观测源，即哪些传感器或数据源用于更新地图。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">obstacle_layer</code>: 配置障碍物层的参数，障碍物层负责处理传感器观测到的障碍物信息。</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">combination_method</code>: 定义如何组合多个观测源的信息。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">enabled</code>: 控制障碍物层是否启用。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">footprint_clearing_enabled</code>: 控制是否清除机器人足迹内的障碍物信息。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">max_obstacle_height</code>和<code class="language-plaintext highlighter-rouge">min_obstacle_height</code>: 定义障碍物的高度范围。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">observation_sources</code>: 指定障碍物信息的来源。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">plugin</code>: 指定使用的障碍物层插件。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">scan</code>: 包含与激光扫描相关的配置，如扫描数据的处理方式。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">origin_x</code>和<code class="language-plaintext highlighter-rouge">origin_y</code>: 定义全局代价地图原点的坐标。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">plugins</code>: 列出启用的代价地图插件，这些插件定义了如何构建和更新代价地图。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">publish_frequency</code>: 定义发布代价地图的频率。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">resolution</code>: 定义代价地图的分辨率，即每个单元格代表的实际物理尺寸。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">robot_base_frame</code>: 定义机器人基座的参考坐标系。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">robot_radius</code>: 定义机器人的半径，用于计算机器人在地图上的占用空间。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">rolling_window</code>: 控制是否使用滚动窗口（即动态变化的地图区域）而非固定大小的地图。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">static_layer</code>: 配置静态层的参数，静态层负责处理地图中的静态障碍物信息。</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">enabled</code>: 控制静态层是否启用。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">map_subscribe_transient_local</code>: 控制是否订阅瞬态本地地图更新。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">map_topic</code>: 指定静态地图的ROS话题（如果不同于全局地图）。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">plugin</code>: 指定使用的静态层插件。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">subscribe_to_updates</code>: 控制是否订阅地图更新。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">transform_tolerance</code>: 定义坐标变换的容忍度。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">track_unknown_space</code>: 控制是否跟踪地图中的未知空间。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">transform_tolerance</code>: 定义在坐标变换过程中允许的误差范围。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">trinary_costmap</code>: 控制是否使用三态代价地图（空闲、占用、未知），而不是仅使用二态（空闲、占用）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">unknown_cost_value</code>: 定义在代价地图中表示未知空间的值。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">update_frequency</code>: 定义更新代价地图的频率。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_maximum</code>: 控制是否使用多个观测源中的最大值来更新代价地图。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 控制是否使用仿真时间（在仿真环境中很有用）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">voxel_layer</code>: 配置体素层的参数，体素层使用体素网格来表示三维空间中的障碍物信息。</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">enabled</code>: 控制体素层是否启用。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">footprint_clearing_enabled</code>: 控制是否清除机器人足迹内的体素信息。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">mark_threshold</code>和<code class="language-plaintext highlighter-rouge">unknown_threshold</code>: 定义将体素视为障碍物或未知的阈值。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">max_obstacle_height</code>和<code class="language-plaintext highlighter-rouge">min_obstacle_height</code>: 定义体素表示的障碍物的高度范围。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">observation_sources</code>: 指定体素信息的来源。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">origin_z</code>: 定义体素网格在Z轴上的原点。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">plugin</code>: 指定使用的体素层插件。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">publish_voxel_map</code>: 控制是否发布体素地图。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">scan</code>: 包含与激光扫描相关的配置，如扫描数据的处理方式。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">z_resolution</code>和<code class="language-plaintext highlighter-rouge">z_voxels</code>: 定义体素网格在Z轴上的分辨率和体素数。</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="控制器节点说明">控制器节点说明</h3>

<p>在Nav2导航系统中<code class="language-plaintext highlighter-rouge">nav2_controller</code>功能包的<code class="language-plaintext highlighter-rouge">controller_server</code>负责处理导航任务中的控制请求，确保机器人能够按照规划的路径进行移动。其主要功能是根据<code class="language-plaintext highlighter-rouge">nav2_planner</code>模块计算出的全局或局部路径，生成速度、方向控制的命令，即控制机器人沿着规划好的路径行走。该节点在执行时还需要依赖于<code class="language-plaintext highlighter-rouge">/local_costmap/local_costmap</code>节点提供的地图消息。</p>

<p><strong>1.controller_server订阅的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/odom</td>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
      <td style="text-align: left">机器人的里程计信息，包含位置、速度和姿态</td>
    </tr>
    <tr>
      <td style="text-align: left">/speed_limit</td>
      <td style="text-align: left">nav2_msgs/msg/SpeedLimit</td>
      <td style="text-align: left">导航过程中的速度限制信息，用于动态调整机器人的移动速度</td>
    </tr>
  </tbody>
</table>

<p><strong>2.controller_server发布的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题名称</th>
      <th style="text-align: left">消息类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/cmd_vel_nav</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">发布控制命令，包括线性和角速度，用于控制机器人按照规划路径移动。</td>
    </tr>
    <tr>
      <td style="text-align: left">/cost_cloud</td>
      <td style="text-align: left">sensor_msgs/msg/PointCloud2</td>
      <td style="text-align: left">发布成本地图中的点云数据，用于避障和路径规划。</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">发布局部路径规划结果，即机器人应如何到达当前目标点附近的一个点。</td>
    </tr>
    <tr>
      <td style="text-align: left">/marker</td>
      <td style="text-align: left">visualization_msgs/msg/MarkerArray</td>
      <td style="text-align: left">发布可视化标记，用于在RViz等可视化工具中显示路径、障碍物等信息。</td>
    </tr>
    <tr>
      <td style="text-align: left">/received_global_plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">发布从全局规划器接收到的全局路径，即当前位置到目标点的路径。</td>
    </tr>
    <tr>
      <td style="text-align: left">/transformed_global_plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">发布经过坐标变换的全局路径，确保路径与机器人的当前坐标系一致。</td>
    </tr>
  </tbody>
</table>

<p><strong>3.controller_server参数</strong></p>

<ul>
  <li>
    <p>FollowPath: 这个部分定义了一个名为FollowPath的插件或配置集，它可能是一个路径跟随行为或算法的配置。它包含了多个子参数和子配置，用于定义如何跟随路径。</p>

    <ul>
      <li>
        <p>BaseObstacle: 定义了基本的障碍物评估参数，用于在路径跟随过程中避免障碍物。</p>

        <ul>
          <li>
            <p>class: 指定了类的名称，这里是BaseObstacle，表示这是一个基本障碍物评估组件。</p>
          </li>
          <li>
            <p>scale: 定义了该障碍物评估在整体评估中的权重或影响程度。</p>
          </li>
          <li>
            <p>sum_scores: 指示是否累加多个障碍物的分数，false可能表示使用最大值或其他逻辑。</p>
          </li>
        </ul>
      </li>
      <li>
        <p>GoalAlign, GoalDist, PathAlign, PathDist, RotateToGoal, Oscillation: 这些都是路径跟随过程中的不同评估或行为组件，每个都有其特定的参数和用途，如对齐目标、保持与目标或路径的距离、减少振荡等。</p>
      </li>
      <li>
        <p>acc_lim_theta, acc_lim_x, acc_lim_y: 这些参数定义了机器人在不同方向上的加速度限制。</p>
      </li>
      <li>
        <p>critics: 指定了哪些评估组件（或“批评家”）将被用于路径跟随决策。</p>
      </li>
      <li>
        <p>debug_trajectory_details: 指示是否发布轨迹的详细调试信息。</p>
      </li>
      <li>
        <p>其他与速度、加速度、时间粒度、轨迹生成等相关的参数，共同定义了路径跟随算法的行为和性能。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>controller_frequency: 指定了控制器（可能是FollowPath或其他控制器）的运行频率，以赫兹为单位。</p>
  </li>
  <li>
    <p>controller_plugins: 指定了将要使用的控制器插件列表，这里只包含了FollowPath。</p>
  </li>
  <li>
    <p>failure_tolerance: 定义了容忍失败的时间或距离，用于在评估控制器是否失败时提供一定的缓冲。</p>
  </li>
  <li>
    <p>general_goal_checker: 定义了一个通用的目标检查器，用于确定机器人是否已达到其目标位置和方向。</p>
  </li>
  <li>
    <p>goal_checker_plugins: 指定了将要使用的目标检查器插件列表。</p>
  </li>
  <li>
    <p>min_theta_velocity_threshold, min_x_velocity_threshold, min_y_velocity_threshold: 这些定义了机器人在不同方向上的最小速度阈值，低于这些阈值可能被视为停止或静止。</p>
  </li>
  <li>
    <p>odom_topic: 指定了里程计信息的ROS主题。</p>
  </li>
  <li>
    <p>progress_checker: 定义了一个进度检查器，用于评估机器人是否在向目标移动。</p>
  </li>
  <li>
    <p>qos_overrides: 定义了ROS服务或主题的QoS（服务质量）覆盖设置，用于调整消息传递的可靠性和性能。</p>
  </li>
  <li>
    <p>speed_limit_topic: 指定了速度限制信息的ROS主题。</p>
  </li>
  <li>
    <p>use_sim_time: 指示是否使用模拟时间，这在ROS仿真环境中非常有用。</p>
  </li>
</ul>

<p><strong>4./local_costmap/local_costmap订阅的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/local_costmap/footprint</td>
      <td style="text-align: left">geometry_msgs/msg/Polygon</td>
      <td style="text-align: left">机器人或移动平台的足迹多边形，用于本地代价地图的计算</td>
    </tr>
    <tr>
      <td style="text-align: left">/scan</td>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">激光扫描仪的扫描数据，用于环境感知和避障</td>
    </tr>
  </tbody>
</table>

<p><strong>5./local_costmap/local_costmap发布的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/local_costmap/clearing_endpoints</td>
      <td style="text-align: left">sensor_msgs/msg/PointCloud2</td>
      <td style="text-align: left">清除成本图上的障碍物点云数据，通常用于动态障碍物处理</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">本地成本图，表示机器人周围环境的可通行性</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">未经处理的本地成本图，可能包含更详细的信息</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap_updates</td>
      <td style="text-align: left">map_msgs/msg/OccupancyGridUpdate</td>
      <td style="text-align: left">本地成本图的更新信息，包括哪些区域发生了变化</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">发布的机器人足迹多边形，时间戳表示发布时间</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/voxel_grid</td>
      <td style="text-align: left">nav2_msgs/msg/VoxelGrid</td>
      <td style="text-align: left">体素网格数据，用于成本图生成中的空间划分和优化</td>
    </tr>
  </tbody>
</table>

<p><strong>6./local_costmap/local_costmap参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/bond_disable_heartbeat_timeout</code>: 是否禁用节点间的心跳超时检查。当设置为<code class="language-plaintext highlighter-rouge">true</code>时，表示禁用该功能，可能用于减少网络通信量或适应特定网络环境。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">always_send_full_costmap</code>: 是否总是发送完整的成本图。当设置为<code class="language-plaintext highlighter-rouge">true</code>时，节点将不依赖于增量更新，而是始终发送完整的成本图数据。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">clearable_layers</code>: 指定可以被清除的层列表。在这个例子中，包括<code class="language-plaintext highlighter-rouge">obstacle_layer</code>、<code class="language-plaintext highlighter-rouge">voxel_layer</code>和<code class="language-plaintext highlighter-rouge">range_layer</code>，这意味着这些层中的障碍物数据可以被清除。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">filters</code>: 用于指定应用于成本图的过滤器列表。此处为空，表示没有应用任何过滤器。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">footprint</code>: 机器人的足迹多边形，定义了机器人在二维空间中的物理占用区域。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">footprint_padding</code>: 足迹的填充量，用于在计算成本图时给机器人足迹添加额外的空间。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">global_frame</code>: 全局参考坐标系的名称，通常用于定位和导航任务。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">height</code>: 成本图的高度（以单元格数量计）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">inflation_layer</code>: 膨胀层的配置，用于在障碍物周围添加一定范围的膨胀区域，使机器人与障碍物保持安全距离。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">lethal_cost_threshold</code>: 致命成本阈值，超过此阈值的成本值表示不可通行的区域。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">map_topic</code>: 订阅的地图主题名称，用于获取全局地图信息。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">observation_sources</code>: 观察源的配置，用于指定哪些传感器数据将被用于更新成本图。此处为空字符串，可能是默认值或配置方式的不同。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">obstacle_layer</code>: 障碍物层的配置，用于处理来自传感器（如激光雷达）的障碍物数据。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">origin_x</code>,<code class="language-plaintext highlighter-rouge">origin_y</code>: 成本图原点的X和Y坐标，定义了成本图在全局坐标系中的位置。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">plugins</code>: 启用的插件列表，定义了成本图使用的不同层（如障碍物层、膨胀层等）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">publish_frequency</code>: 成本图的发布频率（以Hz为单位）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">resolution</code>: 成本图的分辨率（以米/单元格计）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">robot_base_frame</code>: 机器人基座的参考坐标系名称，用于定位机器人。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">robot_radius</code>: 机器人的半径，用于在成本图中表示机器人的物理尺寸。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">rolling_window</code>: 是否使用滚动窗口。当设置为<code class="language-plaintext highlighter-rouge">true</code>时，成本图将随着机器人的移动而更新其位置和范围。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">track_unknown_space</code>: 是否跟踪未知空间。在某些情况下，这可能用于处理未探索或未知的区域。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">transform_tolerance</code>: 变换容差，定义了接受变换的时间差和角度差的阈值。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">trinary_costmap</code>: 是否使用三态成本图（通常是自由、占用、未知）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">unknown_cost_value</code>: 未知区域在成本图中的成本值。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">update_frequency</code>: 成本图的更新频率（以Hz为单位），不同于发布频率。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_maximum</code>: 是否在多个源提供相同位置的成本信息时使用最大值。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 是否使用模拟时间而非系统时间。这在仿真环境中很有用。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">voxel_layer</code>: 体素层的配置，用于将三维空间划分为体素（体积像素），以提高成本图的处理效率。</p>
  </li>
</ul>

<h3 id="恢复器节点说明">恢复器节点说明</h3>

<p>恢复行为是机器人导航过程中一个至关重要的部分，它允许机器人在遇到障碍、卡住或其他导航问题时采取一系列预定义的动作来尝试恢复。在Nav2中由<code class="language-plaintext highlighter-rouge">nav2_behaviors</code>功能包的<code class="language-plaintext highlighter-rouge">behavior_server</code>实现这一功能。</p>

<p><strong>1.订阅的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/clock</td>
      <td style="text-align: left">rosgraph_msgs/msg/Clock</td>
      <td style="text-align: left">ROS系统时间</td>
    </tr>
    <tr>
      <td style="text-align: left">/cmd_vel_teleop</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">遥操作命令，用于控制机器人的线性和角速度</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">局部代价地图的原始数据</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">机器人在局部代价地图中的已发布足迹</td>
    </tr>
    <tr>
      <td style="text-align: left">/preempt_teleop</td>
      <td style="text-align: left">std_msgs/msg/Empty</td>
      <td style="text-align: left">遥操作抢占信号，用于中断当前遥操作</td>
    </tr>
  </tbody>
</table>

<p><strong>2.发布的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/cmd_vel</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">发送给底层控制器的速度命令</td>
    </tr>
  </tbody>
</table>

<p><strong>3.提供的Action服务器</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">Action接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/assisted_teleop</td>
      <td style="text-align: left">nav2_msgs/action/AssistedTeleop</td>
      <td style="text-align: left">遥控辅助操作服务，允许用户在导航时提供方向性输入</td>
    </tr>
    <tr>
      <td style="text-align: left">/backup</td>
      <td style="text-align: left">nav2_msgs/action/BackUp</td>
      <td style="text-align: left">后退动作服务，用于在特定情况下使机器人后退</td>
    </tr>
    <tr>
      <td style="text-align: left">/drive_on_heading</td>
      <td style="text-align: left">nav2_msgs/action/DriveOnHeading</td>
      <td style="text-align: left">按指定航向行驶的动作服务</td>
    </tr>
    <tr>
      <td style="text-align: left">/spin</td>
      <td style="text-align: left">nav2_msgs/action/Spin</td>
      <td style="text-align: left">旋转动作服务，允许机器人在原地旋转</td>
    </tr>
    <tr>
      <td style="text-align: left">/wait</td>
      <td style="text-align: left">nav2_msgs/action/Wait</td>
      <td style="text-align: left">等待动作服务，使机器人在当前位置等待一定时间</td>
    </tr>
  </tbody>
</table>

<p><strong>4.参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 该参数指定是否使用模拟时间而非实际时间。这在仿真环境中非常有用，因为仿真环境可以加速或减速时间流逝，而不需要等待实际时间的流逝。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">global_frame</code>: 定义全局坐标系的名称，该坐标系通常用于导航任务中的定位和路径规划。在这里，它被设置为<code class="language-plaintext highlighter-rouge">odom</code>，意味着使用里程计数据来作为全局坐标系的参考。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">robot_base_frame</code>: 指定机器人基座的坐标系名称。这是机器人上用于定位和运动控制的参考点，通常与机器人的物理中心或驱动轮的中心相对应。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">odom_topic</code>: 这是一个ROS话题名称，用于发布里程计数据。里程计数据包含了机器人随时间推移的位置和姿态变化信息，是导航和定位系统的关键输入之一。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/bond_disable_heartbeat_timeout</code>：这个参数可能用于配置ROS节点之间的心跳检测机制。将其设置为<code class="language-plaintext highlighter-rouge">true</code>可能意味着禁用或调整心跳超时的行为，以便在特定情况下（如仿真环境）避免不必要的超时错误。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">assisted_teleop</code>,<code class="language-plaintext highlighter-rouge">backup</code>,<code class="language-plaintext highlighter-rouge">drive_on_heading</code>,<code class="language-plaintext highlighter-rouge">spin</code>,<code class="language-plaintext highlighter-rouge">wait</code>: 这些是行为树中可能使用的行为插件的配置项。每个插件都定义了机器人可以执行的一种特定行为，如辅助遥操作、后退、按指定方向行驶、原地旋转和等待。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">behavior_plugins</code>: 列出了在行为树中可用的行为插件名称。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">cmd_vel_teleop</code>: 指定了用于遥操作的速度控制命令的ROS话题名称。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">costmap_topic</code>: 定义了局部代价地图的ROS话题名称，代价地图用于表示环境中的障碍物和可通行区域。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">cycle_frequency</code>: 定义了导航系统更新其状态和规划新路径的频率（以赫兹为单位）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">max_rotational_vel</code>,<code class="language-plaintext highlighter-rouge">min_rotational_vel</code>,<code class="language-plaintext highlighter-rouge">rotational_acc_lim</code>: 这些参数定义了机器人旋转时的最大速度、最小速度和加速度限制。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">projection_time</code>: 与代价地图的更新或预测未来障碍物位置有关的时间参数。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">footprint_topic</code>: 定义了发布机器人足迹（即机器人占据的空间）的ROS话题名称。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">simulate_ahead_time</code>,<code class="language-plaintext highlighter-rouge">simulation_time_step</code>: 这些参数与仿真环境相关，可能用于控制仿真过程中的时间流逝和步长。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">transform_tolerance</code>: 定义了坐标变换时的容差范围，用于处理不同坐标系之间的微小差异。</p>
  </li>
</ul>

<h3 id="航点跟随节点说明">航点跟随节点说明</h3>

<p>在Nav2 导航堆栈中，<code class="language-plaintext highlighter-rouge">nav2_waypoint_follower</code>包下的<code class="language-plaintext highlighter-rouge">/waypoint_follower</code>节点负责跟踪由路径规划器生成的一系列航点（waypoints），以确保机器人能够沿着预定的路径安全、准确地移动。该节点的主要功能是根据当前机器人位置和速度信息，以及由路径规划器（如<code class="language-plaintext highlighter-rouge">nav2_global_planner</code>和<code class="language-plaintext highlighter-rouge">nav2_local_planner</code>）提供的航点列表，计算出控制指令来控制机器人的运动。这些控制指令可能包括线性和角速度命令，或者更具体的运动学或动力学命令，具体取决于机器人的类型和配置。</p>

<p><strong>1.提供的Action服务器</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">Action接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/follow_waypoints</td>
      <td style="text-align: left">nav2_msgs/action/FollowWaypoints</td>
      <td style="text-align: left">允许客户端请求planner_server按照一系列路点进行导航</td>
    </tr>
  </tbody>
</table>

<p><strong>2.请求的Action服务</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">Action接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/navigate_to_pose</td>
      <td style="text-align: left">nav2_msgs/action/NavigateToPose</td>
      <td style="text-align: left">允许planner_server（或调用它的节点）请求导航到指定的位姿</td>
    </tr>
  </tbody>
</table>

<p><strong>3.参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 指定是否使用模拟时间而非实际时间进行节点的计时和同步。这在仿真环境中特别有用，因为仿真环境可能无法提供与真实时间完全同步的时钟。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">loop_rate</code>: 定义了节点的主循环速率，即节点每秒执行其主要任务（如处理数据、发布信息等）的次数。这个参数对于控制节点的响应性和资源使用非常重要。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">stop_on_failure</code>: 指明当导航任务遇到无法克服的障碍或达到其他失败条件时，节点是否应该停止执行。这对于确保在失败情况下系统能够安全地停止并等待进一步指令很重要。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bond_disable_heartbeat_timeout</code>: 涉及节点间通信的可靠性机制。Bond是ROS 2中用于节点间稳定通信的一种机制，其中心跳信号用于检测节点是否仍然活跃。将此参数设置为true会禁用心跳超时检测，这可能在某些特定的网络配置或应用场景中是有用的。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">waypoint_task_executor_plugin</code>: 指定了在执行路径点导航任务时要使用的插件。路径点导航通常涉及一系列预先定义的点，机器人需要按顺序访问这些点。这个参数允许用户指定用于执行这种类型任务的特定插件或算法。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">wait_at_waypoint</code>: 这是一个复合参数，用于配置在路径点等待的特定行为。</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">enabled</code>: 启用或禁用在到达每个路径点时等待的功能。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">plugin</code>: 指定实现等待功能的插件类型。这允许用户根据需要选择不同的等待策略或行为。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">waypoint_pause_duration</code>: 定义了在每个路径点处等待的持续时间（以毫秒为单位）。这可以用于确保机器人在移动到下一个路径点之前已经稳定或已经完成了某些操作。</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="路径平滑节点说明">路径平滑节点说明</h3>

<p>在Nav2框架中<code class="language-plaintext highlighter-rouge">nav2_smoother</code>功能包下的<code class="language-plaintext highlighter-rouge">smoother_server</code>节点通过加载和运行各种平滑器插件，对规划出的路径进行平滑处理，使得机器人能够更流畅、连续且安全地移动。这一功能对于提高机器人的导航性能和减少硬件磨损具有重要意义。</p>

<p><strong>1.订阅的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/global_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">全局代价地图的原始数据，用于路径规划</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">机器人在全局代价地图中的足迹表示</td>
    </tr>
  </tbody>
</table>

<p><strong>2.发布的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/plan_smoothed</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">经过平滑处理后的全局路径</td>
    </tr>
  </tbody>
</table>

<p><strong>3.提供的Action服务器</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">动作类型</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/smooth_path</td>
      <td style="text-align: left">nav2_msgs/action/SmoothPath</td>
      <td style="text-align: left">提供平滑路径的服务，接受路径平滑的请求，并返回平滑后的路径。这允许客户端（如行为树）异步地请求路径平滑，并在平滑完成后接收结果。</td>
    </tr>
  </tbody>
</table>

<p><strong>4.参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/bond_disable_heartbeat_timeout</code>: 指示是否禁用Bond的心跳超时功能。在分布式系统中，Bond用于管理节点间的连接和心跳，此参数用于调整心跳相关的行为。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">costmap_topic</code>: 代价地图数据的ROS话题名称，通常是全局代价地图的原始数据。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">footprint_topic</code>: 机器人足迹（即机器人在地图上的占用区域）的ROS话题名称，用于在全局代价地图中表示机器人的物理尺寸。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">robot_base_frame</code>: 指定机器人基座的坐标系名称，这是机器人导航中用于定位和移动的参考点。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">simple_smoother</code>:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">do_refinement</code>: 指示是否启用路径的细化（或进一步优化）过程。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">max_its</code>: 平滑过程中允许的最大迭代次数，用于控制平滑算法的收敛时间。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">plugin</code>: 平滑插件的类型，这里是<code class="language-plaintext highlighter-rouge">nav2_smoother::SimpleSmoother</code>，表示使用简单的平滑算法。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">tolerance</code>: 平滑算法的收敛容差，当路径变化小于此值时，认为平滑过程已完成。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">w_data</code>: 平滑过程中数据项（如障碍物距离）的权重。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">w_smooth</code>: 平滑过程中平滑项（如路径曲率）的权重。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">smoother_plugins</code>: 定义的平滑插件列表，这里列出了<code class="language-plaintext highlighter-rouge">simple_smoother</code>，表示将使用此插件进行路径平滑。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">transform_tolerance</code>: 坐标变换的容差，用于处理不同坐标系之间的转换时的不确定性。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 指定是否使用模拟时间而非实际时间。在仿真环境中，这通常设置为<code class="language-plaintext highlighter-rouge">true</code>，以匹配仿真器的虚拟时间；在真实环境中，应设置为<code class="language-plaintext highlighter-rouge">false</code>以使用ROS系统的实际时间。</p>
  </li>
</ul>

<h3 id="速度平滑节点说明">速度平滑节点说明</h3>

<p>Nav2框架中的<code class="language-plaintext highlighter-rouge">nav2_velocity_smoother</code>包下的<code class="language-plaintext highlighter-rouge">velocity_smoother</code>节点主要负责平滑由Nav2框架发送给机器人控制器的速度指令。其核心功能是实现速度和加速度平滑。这一功能对于确保机器人在导航过程中的稳定性和安全性至关重要。</p>

<p><strong>1.订阅的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/cmd_vel_nav</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">接收来自其他节点的速度控制指令的话题</td>
    </tr>
  </tbody>
</table>

<p><strong>2.发布的话题</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/cmd_vel</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">发布经过处理或平滑后的速度控制指令的话题</td>
    </tr>
  </tbody>
</table>

<p><strong>3.参数</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bond_disable_heartbeat_timeout</code>: 指示是否禁用节点间的心跳超时机制。如果为<code class="language-plaintext highlighter-rouge">true</code>，则节点间的心跳检测不会因超时而断开连接。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">deadband_velocity</code>: 定义在哪些速度分量上应用死区平滑（即忽略小于此阈值的微小速度变化）。这里分别为X轴、Y轴和偏航角速度（theta）设置了死区值。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">feedback</code>: 指定速度平滑器的反馈类型。<code class="language-plaintext highlighter-rouge">OPEN_LOOP</code>表示开环控制，即不考虑机器人的实际速度反馈进行速度调整。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">max_accel</code>: 定义机器人在各个方向上的最大加速度限制，包括X轴、Y轴和偏航角速度（theta）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">max_decel</code>: 定义机器人在各个方向上的最大减速度限制，包括X轴、Y轴和偏航角速度（theta）。注意，减速度值以负数表示。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">max_velocity</code>: 定义机器人在各个方向上的最大速度限制，包括X轴、Y轴和偏航角速度（theta）。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">min_velocity</code>: 定义机器人在各个方向上的最小速度限制，包括X轴、Y轴和偏航角速度（theta）。这通常用于避免发送过小的速度指令给底层控制器。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">odom_duration</code>: 与里程计数据相关的参数，但在此上下文中可能不直接用于<code class="language-plaintext highlighter-rouge">velocity_smoother</code>节点，可能是遗留或与其他功能相关联。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">odom_topic</code>: 指定里程计数据的ROS话题名称，<code class="language-plaintext highlighter-rouge">velocity_smoother</code>节点将订阅此话题以获取机器人的运动信息。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">scale_velocities</code>: 指示是否根据加速度限制同比例调整速度的其他分量。如果为<code class="language-plaintext highlighter-rouge">false</code>，则不会进行速度缩放。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">smoothing_frequency</code>: 定义速度平滑操作的执行频率（Hz），即每秒进行多少次平滑计算。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_sim_time</code>: 指定是否使用模拟时间而非实际系统时间。这对于仿真环境特别有用，可以确保时间的一致性和可预测性。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">velocity_timeout</code>: 如果在指定时间内未接收到新的速度指令，则<code class="language-plaintext highlighter-rouge">velocity_smoother</code>节点将停止发布速度指令，并可能发送零速度指令以停止机器人运动。这是为了防止在失去速度控制时机器人继续移动。</p>
  </li>
</ul>

<h3 id="导航功能集成重要">导航功能集成(重要)</h3>

<p><strong>1.准备工作</strong></p>

<p>请先调用如下指令在工作空间的src目录下创建一个功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create mycar_navigation2 <span class="nt">--dependencies</span> navigation2 nav2_common
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>2.编写launch文件与参数文件</strong></p>

<p>在功能包下，新建launch目录、params目录和bts目录。</p>

<p>launch目录下新建<code class="language-plaintext highlighter-rouge">nav2.launch.py</code>文件并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">current_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">bt_params</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">bt.yaml</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">planner_params</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">planner.yaml</span><span class="sh">"</span><span class="p">)</span>       
    <span class="n">controller_params</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">controller.yaml</span><span class="sh">"</span><span class="p">)</span>       
    <span class="n">behavior_params</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">behavior.yaml</span><span class="sh">"</span><span class="p">)</span>       
    <span class="n">waypoint_params</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">waypoint.yaml</span><span class="sh">"</span><span class="p">)</span>       
    <span class="n">velocity_params</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">velocity.yaml</span><span class="sh">"</span><span class="p">)</span>       
    <span class="n">smoother_params</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">),</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">smoother.yaml</span><span class="sh">"</span><span class="p">)</span>       

    <span class="n">planner_server_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_planner</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">planner_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">planner_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">planner_params</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="n">controller_server_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_controller</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">controller_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">controller_params</span><span class="p">],</span>
        <span class="n">remappings</span><span class="o">=</span><span class="p">[(</span><span class="sh">'</span><span class="s">cmd_vel</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cmd_vel_nav</span><span class="sh">'</span><span class="p">)]</span>
    <span class="p">)</span>

    <span class="n">behavior_server_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_behaviors</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">behavior_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">behavior_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">behavior_params</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">waypoint_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_waypoint_follower</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">waypoint_follower</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">waypoint_follower</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">waypoint_params</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">velocity_smoother_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_velocity_smoother</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">velocity_smoother</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">velocity_smoother</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">respawn_delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">velocity_params</span><span class="p">],</span>
        <span class="n">remappings</span><span class="o">=</span>
                <span class="p">[(</span><span class="sh">'</span><span class="s">cmd_vel</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cmd_vel_nav</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">cmd_vel_smoothed</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cmd_vel</span><span class="sh">'</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">smoother_server_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_smoother</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">smoother_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">smoother_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">smoother_params</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">bt_navigator_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_bt_navigator</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">bt_navigator</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">bt_navigator</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>      
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="n">bt_params</span><span class="p">,</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">default_nav_to_pose_bt_xml</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">current_pkg</span><span class="p">,</span><span class="sh">"</span><span class="s">bts</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">bt_planner_controller_behavior.xml</span><span class="sh">"</span><span class="p">)},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">default_nav_through_poses_bt_xml</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">current_pkg</span><span class="p">,</span><span class="sh">"</span><span class="s">bts</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">bt_planner_controller_behavior_poses.xml</span><span class="sh">"</span><span class="p">)}</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="n">lifecycle_manager_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">nav2_lifecycle_manager</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">lifecycle_manager</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">lifecycle_manager_navigation</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">'</span><span class="s">autostart</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">'</span><span class="s">node_names</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
                        <span class="sh">'</span><span class="s">bt_navigator</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">planner_server</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">controller_server</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">behavior_server</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">waypoint_follower</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">velocity_smoother</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">smoother_server</span><span class="sh">'</span>
                    <span class="p">]}])</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">lifecycle_manager_node</span><span class="p">,</span>
        <span class="n">bt_navigator_node</span><span class="p">,</span>
        <span class="n">planner_server_node</span><span class="p">,</span>
        <span class="n">controller_server_node</span><span class="p">,</span>
        <span class="n">behavior_server_node</span><span class="p">,</span>
        <span class="n">waypoint_node</span><span class="p">,</span>
        <span class="n">velocity_smoother_node</span><span class="p">,</span>
        <span class="n">smoother_server_node</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该launch文件主要是加载了生命周期管理器、行为树、规划器、控制器、恢复器、航点跟踪、路径平滑以及速度平滑等节点。并且除了生命周期管理器节点外，每个节点都还会加载一个配置文件，接下来需要编辑这些配置文。</p>

<p><strong>（1）bt_navigator相关配置文件</strong></p>

<p>bt_navigator相关配置文件有两个，分别是描述行为树的xml文件，以及yaml格式的参数文件，前者存储在bts目录下，后者存储在params目录下。</p>

<p>请在bts目录下，新建一个名为<code class="language-plaintext highlighter-rouge">bt_planner_controller_behavior.xml</code>的文件并输入如下内容：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>
<span class="nt">&lt;root</span> <span class="na">main_tree_to_execute=</span><span class="s">"MainTree"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;BehaviorTree</span> <span class="na">ID=</span><span class="s">"MainTree"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;RecoveryNode</span> <span class="na">number_of_retries=</span><span class="s">"6"</span> <span class="na">name=</span><span class="s">"NavigateRecovery"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;PipelineSequence</span> <span class="na">name=</span><span class="s">"NavigateWithReplanning"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;RateController</span> <span class="na">hz=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;RecoveryNode</span> <span class="na">number_of_retries=</span><span class="s">"1"</span> <span class="na">name=</span><span class="s">"ComputePathToPose"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ComputePathToPose</span> <span class="na">goal=</span><span class="s">"{goal}"</span> <span class="na">path=</span><span class="s">"{path}"</span> <span class="na">planner_id=</span><span class="s">"GridBased"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearGlobalCostmap-Context"</span> <span class="na">service_name=</span><span class="s">"global_costmap/clear_entirely_global_costmap"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/RecoveryNode&gt;</span>
        <span class="nt">&lt;/RateController&gt;</span>
        <span class="nt">&lt;RecoveryNode</span> <span class="na">number_of_retries=</span><span class="s">"1"</span> <span class="na">name=</span><span class="s">"FollowPath"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;FollowPath</span> <span class="na">path=</span><span class="s">"{path}"</span> <span class="na">controller_id=</span><span class="s">"FollowPath"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearLocalCostmap-Context"</span> <span class="na">service_name=</span><span class="s">"local_costmap/clear_entirely_local_costmap"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/RecoveryNode&gt;</span>
      <span class="nt">&lt;/PipelineSequence&gt;</span>
      <span class="nt">&lt;ReactiveFallback</span> <span class="na">name=</span><span class="s">"RecoveryFallback"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;GoalUpdated/&gt;</span>
        <span class="nt">&lt;RoundRobin</span> <span class="na">name=</span><span class="s">"RecoveryActions"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;Sequence</span> <span class="na">name=</span><span class="s">"ClearingActions"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearLocalCostmap-Subtree"</span> <span class="na">service_name=</span><span class="s">"local_costmap/clear_entirely_local_costmap"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearGlobalCostmap-Subtree"</span> <span class="na">service_name=</span><span class="s">"global_costmap/clear_entirely_global_costmap"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/Sequence&gt;</span>
          <span class="nt">&lt;Spin</span> <span class="na">spin_dist=</span><span class="s">"1.57"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;Wait</span> <span class="na">wait_duration=</span><span class="s">"5"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;BackUp</span> <span class="na">backup_dist=</span><span class="s">"0.30"</span> <span class="na">backup_speed=</span><span class="s">"0.05"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/RoundRobin&gt;</span>
      <span class="nt">&lt;/ReactiveFallback&gt;</span>
    <span class="nt">&lt;/RecoveryNode&gt;</span>
  <span class="nt">&lt;/BehaviorTree&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>继续在bts目录下新建一个名为<code class="language-plaintext highlighter-rouge">bt_planner_controller_behavior_poses.xml</code>的文件，并输入如下内容：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre>
<span class="nt">&lt;root</span> <span class="na">main_tree_to_execute=</span><span class="s">"MainTree"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;BehaviorTree</span> <span class="na">ID=</span><span class="s">"MainTree"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;RecoveryNode</span> <span class="na">number_of_retries=</span><span class="s">"6"</span> <span class="na">name=</span><span class="s">"NavigateRecovery"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;PipelineSequence</span> <span class="na">name=</span><span class="s">"NavigateWithReplanning"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;RateController</span> <span class="na">hz=</span><span class="s">"0.333"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;RecoveryNode</span> <span class="na">number_of_retries=</span><span class="s">"1"</span> <span class="na">name=</span><span class="s">"ComputePathThroughPoses"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ReactiveSequence&gt;</span>
              <span class="nt">&lt;RemovePassedGoals</span> <span class="na">input_goals=</span><span class="s">"{goals}"</span> <span class="na">output_goals=</span><span class="s">"{goals}"</span> <span class="na">radius=</span><span class="s">"0.7"</span><span class="nt">/&gt;</span>
              <span class="nt">&lt;ComputePathThroughPoses</span> <span class="na">goals=</span><span class="s">"{goals}"</span> <span class="na">path=</span><span class="s">"{path}"</span> <span class="na">planner_id=</span><span class="s">"GridBased"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/ReactiveSequence&gt;</span>
            <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearGlobalCostmap-Context"</span> <span class="na">service_name=</span><span class="s">"global_costmap/clear_entirely_global_costmap"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/RecoveryNode&gt;</span>
        <span class="nt">&lt;/RateController&gt;</span>
        <span class="nt">&lt;RecoveryNode</span> <span class="na">number_of_retries=</span><span class="s">"1"</span> <span class="na">name=</span><span class="s">"FollowPath"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;FollowPath</span> <span class="na">path=</span><span class="s">"{path}"</span> <span class="na">controller_id=</span><span class="s">"FollowPath"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearLocalCostmap-Context"</span> <span class="na">service_name=</span><span class="s">"local_costmap/clear_entirely_local_costmap"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/RecoveryNode&gt;</span>
      <span class="nt">&lt;/PipelineSequence&gt;</span>
      <span class="nt">&lt;ReactiveFallback</span> <span class="na">name=</span><span class="s">"RecoveryFallback"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;GoalUpdated/&gt;</span>
        <span class="nt">&lt;RoundRobin</span> <span class="na">name=</span><span class="s">"RecoveryActions"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;Sequence</span> <span class="na">name=</span><span class="s">"ClearingActions"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearLocalCostmap-Subtree"</span> <span class="na">service_name=</span><span class="s">"local_costmap/clear_entirely_local_costmap"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;ClearEntireCostmap</span> <span class="na">name=</span><span class="s">"ClearGlobalCostmap-Subtree"</span> <span class="na">service_name=</span><span class="s">"global_costmap/clear_entirely_global_costmap"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/Sequence&gt;</span>
          <span class="nt">&lt;Spin</span> <span class="na">spin_dist=</span><span class="s">"1.57"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;Wait</span> <span class="na">wait_duration=</span><span class="s">"5"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;BackUp</span> <span class="na">backup_dist=</span><span class="s">"0.30"</span> <span class="na">backup_speed=</span><span class="s">"0.05"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/RoundRobin&gt;</span>
      <span class="nt">&lt;/ReactiveFallback&gt;</span>
    <span class="nt">&lt;/RecoveryNode&gt;</span>
  <span class="nt">&lt;/BehaviorTree&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在params目录下新建一个名为<code class="language-plaintext highlighter-rouge">bt.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">global_frame</span><span class="pi">:</span> <span class="s">map</span>
    <span class="na">robot_base_frame</span><span class="pi">:</span> <span class="s">base_link</span>
    <span class="na">odom_topic</span><span class="pi">:</span> <span class="s">/odom</span>
    <span class="na">default_bt_xml_filename</span><span class="pi">:</span> <span class="s2">"</span><span class="s">navigate_w_replanning_and_recovery.xml"</span>
    <span class="na">bt_loop_duration</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">default_server_timeout</span><span class="pi">:</span> <span class="m">20</span>
    <span class="na">enable_groot_monitoring</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">groot_zmq_publisher_port</span><span class="pi">:</span> <span class="m">1666</span>
    <span class="na">groot_zmq_server_port</span><span class="pi">:</span> <span class="m">1667</span>
    <span class="na">plugin_lib_names</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">nav2_compute_path_to_pose_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_compute_path_through_poses_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_follow_path_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_back_up_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_spin_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_wait_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_clear_costmap_service_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_is_stuck_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_goal_reached_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_goal_updated_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_initial_pose_received_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_reinitialize_global_localization_service_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_rate_controller_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_distance_controller_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_speed_controller_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_truncate_path_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_goal_updater_node_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_recovery_node_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_pipeline_sequence_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_round_robin_node_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_transform_available_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_time_expired_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_distance_traveled_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_single_trigger_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_is_battery_low_condition_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_navigate_through_poses_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_navigate_to_pose_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_remove_passed_goals_action_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_planner_selector_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_controller_selector_bt_node</span>
    <span class="pi">-</span> <span class="s">nav2_goal_checker_selector_bt_node</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>（2）planner_server相关配置文件</strong></p>

<p>在params目录下新建一个名为<code class="language-plaintext highlighter-rouge">planner.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">expected_planner_frequency</span><span class="pi">:</span> <span class="m">20.0</span>
    <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">planner_plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">GridBased"</span><span class="pi">]</span>
    <span class="na">GridBased</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_navfn_planner/NavfnPlanner"</span>
      <span class="na">tolerance</span><span class="pi">:</span> <span class="m">0.5</span>
      <span class="na">use_astar</span><span class="pi">:</span> <span class="kc">false</span>
      <span class="na">allow_unknown</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">/**</span><span class="pi">:</span>
  <span class="na">global_costmap</span><span class="pi">:</span>
    <span class="na">ros__parameters</span><span class="pi">:</span>
      <span class="na">update_frequency</span><span class="pi">:</span> <span class="m">1.0</span>
      <span class="na">publish_frequency</span><span class="pi">:</span> <span class="m">1.0</span>
      <span class="na">global_frame</span><span class="pi">:</span> <span class="s">map</span>
      <span class="na">robot_base_frame</span><span class="pi">:</span> <span class="s">base_link</span>
      <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>

      <span class="c1"># robot_radius: 0.2</span>
      <span class="na">footprint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">[[0.19,</span><span class="nv"> </span><span class="s">0.13],</span><span class="nv"> </span><span class="s">[0.19,</span><span class="nv"> </span><span class="s">-0.13],</span><span class="nv"> </span><span class="s">[-0.19,</span><span class="nv"> </span><span class="s">-0.13],</span><span class="nv"> </span><span class="s">[-0.19,</span><span class="nv"> </span><span class="s">0.13]]"</span>
      <span class="na">resolution</span><span class="pi">:</span> <span class="m">0.05</span>
      <span class="na">track_unknown_space</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">static_layer"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">obstacle_layer"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">voxel_layer"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">inflation_layer"</span><span class="pi">]</span>
      <span class="na">obstacle_layer</span><span class="pi">:</span>
        <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_costmap_2d::ObstacleLayer"</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">observation_sources</span><span class="pi">:</span> <span class="s">scan</span>
        <span class="na">scan</span><span class="pi">:</span>
          <span class="na">topic</span><span class="pi">:</span> <span class="s">/scan</span>
          <span class="na">max_obstacle_height</span><span class="pi">:</span> <span class="m">2.0</span>
          <span class="na">clearing</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">marking</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">data_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">LaserScan"</span>
          <span class="na">raytrace_max_range</span><span class="pi">:</span> <span class="m">3.0</span>
          <span class="na">raytrace_min_range</span><span class="pi">:</span> <span class="m">0.0</span>
          <span class="na">obstacle_max_range</span><span class="pi">:</span> <span class="m">2.5</span>
          <span class="na">obstacle_min_range</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">voxel_layer</span><span class="pi">:</span>
        <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_costmap_2d::VoxelLayer"</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">publish_voxel_map</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">origin_z</span><span class="pi">:</span> <span class="m">0.0</span>
        <span class="na">z_resolution</span><span class="pi">:</span> <span class="m">0.05</span>
        <span class="na">z_voxels</span><span class="pi">:</span> <span class="m">16</span>
        <span class="na">max_obstacle_height</span><span class="pi">:</span> <span class="m">2.0</span>
        <span class="na">mark_threshold</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">observation_sources</span><span class="pi">:</span> <span class="s">scan</span>
        <span class="na">scan</span><span class="pi">:</span>
          <span class="na">topic</span><span class="pi">:</span> <span class="s">/scan</span>
          <span class="na">max_obstacle_height</span><span class="pi">:</span> <span class="m">2.0</span>
          <span class="na">clearing</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">marking</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">data_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">LaserScan"</span>
          <span class="na">raytrace_max_range</span><span class="pi">:</span> <span class="m">3.0</span>
          <span class="na">raytrace_min_range</span><span class="pi">:</span> <span class="m">0.0</span>
          <span class="na">obstacle_max_range</span><span class="pi">:</span> <span class="m">2.5</span>
          <span class="na">obstacle_min_range</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">static_layer</span><span class="pi">:</span>
        <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_costmap_2d::StaticLayer"</span>
        <span class="na">map_subscribe_transient_local</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">inflation_layer</span><span class="pi">:</span>
        <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_costmap_2d::InflationLayer"</span>
        <span class="na">cost_scaling_factor</span><span class="pi">:</span> <span class="m">4.0</span>
        <span class="na">inflation_radius</span><span class="pi">:</span> <span class="m">0.55</span>
      <span class="na">always_send_full_costmap</span><span class="pi">:</span> <span class="s">False</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>（3）controller_server相关配置文件</strong></p>

<p>在params目录下新建一个名为<code class="language-plaintext highlighter-rouge">controller.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">controller_frequency</span><span class="pi">:</span> <span class="m">10.0</span>
    <span class="na">min_x_velocity_threshold</span><span class="pi">:</span> <span class="m">0.001</span>
    <span class="na">min_y_velocity_threshold</span><span class="pi">:</span> <span class="m">0.5</span>
    <span class="na">min_theta_velocity_threshold</span><span class="pi">:</span> <span class="m">0.001</span>

    <span class="c1"># failure_tolerance: 0.3</span>
    <span class="na">failure_tolerance</span><span class="pi">:</span> <span class="m">1.0</span>
    <span class="na">progress_checker_plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">progress_checker"</span>
    <span class="na">goal_checker_plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">general_goal_checker"</span><span class="pi">]</span> 
    <span class="na">controller_plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">FollowPath"</span><span class="pi">]</span>

    <span class="c1"># Progress checker parameters</span>
    <span class="na">progress_checker</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_controller::SimpleProgressChecker"</span>
      <span class="na">required_movement_radius</span><span class="pi">:</span> <span class="m">0.5</span>
      <span class="na">movement_time_allowance</span><span class="pi">:</span> <span class="m">10.0</span>

    <span class="na">general_goal_checker</span><span class="pi">:</span>
      <span class="na">stateful</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_controller::SimpleGoalChecker"</span>
      <span class="na">xy_goal_tolerance</span><span class="pi">:</span> <span class="m">0.25</span>
      <span class="na">yaw_goal_tolerance</span><span class="pi">:</span> <span class="m">0.25</span>

    <span class="c1"># DWB parameters</span>
    <span class="na">FollowPath</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dwb_core::DWBLocalPlanner"</span>
      <span class="na">debug_trajectory_details</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">min_vel_x</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">min_vel_y</span><span class="pi">:</span> <span class="m">0.0</span>

      <span class="c1"># max_vel_x: 0.15</span>
      <span class="na">max_vel_x</span><span class="pi">:</span> <span class="m">0.2</span>
      <span class="na">max_vel_y</span><span class="pi">:</span> <span class="m">0.0</span>

      <span class="c1"># max_vel_theta: 1.0</span>
      <span class="na">max_vel_theta</span><span class="pi">:</span> <span class="m">1.0</span>
      <span class="na">min_speed_xy</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">max_speed_xy</span><span class="pi">:</span> <span class="m">0.2</span>
      <span class="na">min_speed_theta</span><span class="pi">:</span> <span class="m">0.0</span>

      <span class="c1"># Add high threshold velocity for turtlebot 3 issue.</span>

      <span class="c1"># https://github.com/ROBOTIS-GIT/turtlebot3_simulations/issues/75</span>
      <span class="na">acc_lim_x</span><span class="pi">:</span> <span class="m">1.0</span>
      <span class="na">acc_lim_y</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">acc_lim_theta</span><span class="pi">:</span> <span class="m">3.2</span>
      <span class="na">decel_lim_x</span><span class="pi">:</span> <span class="s">-1.0</span>
      <span class="na">decel_lim_y</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">decel_lim_theta</span><span class="pi">:</span> <span class="s">-3.2</span>

      <span class="c1"># vx_samples: 20</span>
      <span class="na">vx_samples</span><span class="pi">:</span> <span class="m">20</span>
      <span class="na">vy_samples</span><span class="pi">:</span> <span class="m">5</span>
      <span class="na">vtheta_samples</span><span class="pi">:</span> <span class="m">20</span>
      <span class="na">sim_time</span><span class="pi">:</span> <span class="m">1.7</span>
      <span class="na">linear_granularity</span><span class="pi">:</span> <span class="m">0.05</span>
      <span class="na">angular_granularity</span><span class="pi">:</span> <span class="m">0.025</span>

      <span class="c1"># transform_tolerance: 0.2</span>
      <span class="na">transform_tolerance</span><span class="pi">:</span> <span class="m">1.0</span>
      <span class="na">xy_goal_tolerance</span><span class="pi">:</span> <span class="m">0.15</span>
      <span class="na">trans_stopped_velocity</span><span class="pi">:</span> <span class="m">0.25</span>
      <span class="na">short_circuit_trajectory_evaluation</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">stateful</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">critics</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">RotateToGoal"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">Oscillation"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">BaseObstacle"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">GoalAlign"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">PathAlign"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">PathDist"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">GoalDist"</span><span class="pi">]</span>
      <span class="na">BaseObstacle.scale</span><span class="pi">:</span> <span class="m">0.02</span>
      <span class="na">PathAlign.scale</span><span class="pi">:</span> <span class="m">32.0</span>
      <span class="na">PathAlign.forward_point_distance</span><span class="pi">:</span> <span class="m">0.1</span>
      <span class="na">GoalAlign.scale</span><span class="pi">:</span> <span class="m">24.0</span>
      <span class="na">GoalAlign.forward_point_distance</span><span class="pi">:</span> <span class="m">0.1</span>
      <span class="na">PathDist.scale</span><span class="pi">:</span> <span class="m">32.0</span>
      <span class="na">GoalDist.scale</span><span class="pi">:</span> <span class="m">24.0</span>
      <span class="na">RotateToGoal.scale</span><span class="pi">:</span> <span class="m">32.0</span>
      <span class="na">RotateToGoal.slowing_factor</span><span class="pi">:</span> <span class="m">5.0</span>
      <span class="na">RotateToGoal.lookahead_time</span><span class="pi">:</span> <span class="s">-1.0</span>
<span class="na">/**</span><span class="pi">:</span>
  <span class="na">local_costmap</span><span class="pi">:</span>
    <span class="na">ros__parameters</span><span class="pi">:</span>
      <span class="na">update_frequency</span><span class="pi">:</span> <span class="m">5.0</span>
      <span class="na">publish_frequency</span><span class="pi">:</span> <span class="m">2.0</span>
      <span class="na">global_frame</span><span class="pi">:</span> <span class="s">odom</span>
      <span class="na">robot_base_frame</span><span class="pi">:</span> <span class="s">base_link</span>
      <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">rolling_window</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">width</span><span class="pi">:</span> <span class="m">2</span>
      <span class="na">height</span><span class="pi">:</span> <span class="m">2</span>
      <span class="na">resolution</span><span class="pi">:</span> <span class="m">0.05</span>

      <span class="c1"># robot_radius: 0.20</span>
      <span class="na">footprint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">[[0.19,</span><span class="nv"> </span><span class="s">0.13],</span><span class="nv"> </span><span class="s">[0.19,</span><span class="nv"> </span><span class="s">-0.13],</span><span class="nv"> </span><span class="s">[-0.19,</span><span class="nv"> </span><span class="s">-0.13],</span><span class="nv"> </span><span class="s">[-0.19,</span><span class="nv"> </span><span class="s">0.13]]"</span>
      <span class="na">plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">obstacle_layer"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">voxel_layer"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">inflation_layer"</span><span class="pi">]</span>
      <span class="na">inflation_layer</span><span class="pi">:</span>
        <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_costmap_2d::InflationLayer"</span>
        <span class="na">inflation_radius</span><span class="pi">:</span> <span class="m">0.5</span>
        <span class="na">cost_scaling_factor</span><span class="pi">:</span> <span class="m">4.0</span>
      <span class="na">obstacle_layer</span><span class="pi">:</span>
        <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_costmap_2d::ObstacleLayer"</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">observation_sources</span><span class="pi">:</span> <span class="s">scan</span>
        <span class="na">scan</span><span class="pi">:</span>
          <span class="na">topic</span><span class="pi">:</span> <span class="s">/scan</span>
          <span class="na">max_obstacle_height</span><span class="pi">:</span> <span class="m">2.0</span>
          <span class="na">clearing</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">marking</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">data_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">LaserScan"</span>
      <span class="na">voxel_layer</span><span class="pi">:</span>
        <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_costmap_2d::VoxelLayer"</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">publish_voxel_map</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">origin_z</span><span class="pi">:</span> <span class="m">0.0</span>
        <span class="na">z_resolution</span><span class="pi">:</span> <span class="m">0.05</span>
        <span class="na">z_voxels</span><span class="pi">:</span> <span class="m">16</span>
        <span class="na">max_obstacle_height</span><span class="pi">:</span> <span class="m">2.0</span>
        <span class="na">mark_threshold</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">observation_sources</span><span class="pi">:</span> <span class="s">scan</span>
        <span class="na">scan</span><span class="pi">:</span>
          <span class="na">topic</span><span class="pi">:</span> <span class="s">/scan</span>
          <span class="na">max_obstacle_height</span><span class="pi">:</span> <span class="m">2.0</span>
          <span class="na">clearing</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">marking</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">data_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">LaserScan"</span>
          <span class="na">raytrace_max_range</span><span class="pi">:</span> <span class="m">3.0</span>
          <span class="na">raytrace_min_range</span><span class="pi">:</span> <span class="m">0.0</span>
          <span class="na">obstacle_max_range</span><span class="pi">:</span> <span class="m">2.5</span>
          <span class="na">obstacle_min_range</span><span class="pi">:</span> <span class="m">0.0</span>
      <span class="na">static_layer</span><span class="pi">:</span>
        <span class="na">map_subscribe_transient_local</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">always_send_full_costmap</span><span class="pi">:</span> <span class="s">True</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Footprint</p>

<ul>
  <li>
    <p>将毫米转换为米：长0.96m，宽0.45m</p>
  </li>
  <li>
    <p>以机器人中心（<code class="language-plaintext highlighter-rouge">base_link</code>坐标系原点）为基准，计算矩形顶点坐标：</p>
  </li>
</ul>

<p><em>说明</em>：顶点按顺时针或逆时针顺序排列，覆盖机器人长宽边界。（右手坐标系）</p>

<p>例如长960宽450长400</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nl">footprint:</span> <span class="p">[[</span><span class="mf">0.48</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.48</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>（4）behavior_server相关配置文件</strong></p>

<p>在params目录下新建一个名为<code class="language-plaintext highlighter-rouge">behavior.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">costmap_topic</span><span class="pi">:</span> <span class="s">local_costmap/costmap_raw</span>
    <span class="na">footprint_topic</span><span class="pi">:</span> <span class="s">local_costmap/published_footprint</span>
    <span class="na">cycle_frequency</span><span class="pi">:</span> <span class="m">5.0</span>
    <span class="na">behavior_plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">spin"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">backup"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">drive_on_heading"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">assisted_teleop"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">wait"</span><span class="pi">]</span>
    <span class="na">spin</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_behaviors/Spin"</span>
    <span class="na">backup</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_behaviors/BackUp"</span>
    <span class="na">drive_on_heading</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_behaviors/DriveOnHeading"</span>
    <span class="na">wait</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_behaviors/Wait"</span>
    <span class="na">assisted_teleop</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_behaviors/AssistedTeleop"</span>
    <span class="na">global_frame</span><span class="pi">:</span> <span class="s">odom</span>
    <span class="na">robot_base_frame</span><span class="pi">:</span> <span class="s">base_link</span>
    <span class="na">transform_tolerance</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">simulate_ahead_time</span><span class="pi">:</span> <span class="m">2.0</span>
    <span class="na">max_rotational_vel</span><span class="pi">:</span> <span class="m">1.0</span>
    <span class="na">min_rotational_vel</span><span class="pi">:</span> <span class="m">0.4</span>
    <span class="na">rotational_acc_lim</span><span class="pi">:</span> <span class="m">3.2</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>（5）waypoint_follower相关配置文件</strong></p>

<p>在params目录下新建一个名为<code class="language-plaintext highlighter-rouge">waypoint.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">loop_rate</span><span class="pi">:</span> <span class="m">20</span>
    <span class="na">stop_on_failure</span><span class="pi">:</span> <span class="kc">false</span>
    <span class="na">waypoint_task_executor_plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">wait_at_waypoint"</span>
    <span class="na">wait_at_waypoint</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_waypoint_follower::WaitAtWaypoint"</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">waypoint_pause_duration</span><span class="pi">:</span> <span class="m">5000</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>（6）velocity_smoother相关配置文件</strong></p>

<p>在params目录下新建一个名为<code class="language-plaintext highlighter-rouge">velocity.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">use_sim_time</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">smoothing_frequency</span><span class="pi">:</span> <span class="m">20.0</span>
    <span class="na">scale_velocities</span><span class="pi">:</span> <span class="s">False</span>
    <span class="na">feedback</span><span class="pi">:</span> <span class="s2">"</span><span class="s">OPEN_LOOP"</span>
    <span class="na">max_velocity</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.1</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">1.0</span><span class="pi">]</span>
    <span class="na">min_velocity</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">-0.1</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">-1.0</span><span class="pi">]</span>
    <span class="na">max_accel</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">2.5</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">3.2</span><span class="pi">]</span>
    <span class="na">max_decel</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">-2.5</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">-3.2</span><span class="pi">]</span>
    <span class="na">odom_topic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">odom"</span>
    <span class="na">odom_duration</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">deadband_velocity</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">]</span>
    <span class="na">velocity_timeout</span><span class="pi">:</span> <span class="m">1.0</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>（7）smoother_server相关配置文件</strong></p>

<p>在params目录下新建一个名为<code class="language-plaintext highlighter-rouge">smootherr.yaml</code>的文件，并输入如下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="na">/**</span><span class="pi">:</span>
  <span class="na">ros__parameters</span><span class="pi">:</span>
    <span class="na">costmap_topic</span><span class="pi">:</span> <span class="s">global_costmap/costmap_raw</span>
    <span class="na">footprint_topic</span><span class="pi">:</span> <span class="s">global_costmap/published_footprint</span>
    <span class="na">robot_base_frame</span><span class="pi">:</span> <span class="s">base_link</span>
    <span class="na">transform_timeout</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">smoother_plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">simple_smoother"</span><span class="pi">]</span>
    <span class="na">simple_smoother</span><span class="pi">:</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nav2_smoother::SimpleSmoother"</span>
      <span class="na">tolerance</span><span class="pi">:</span> <span class="s">1.0e-10</span>
      <span class="na">do_refinement</span><span class="pi">:</span> <span class="s">True</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>3.launch集成</strong></p>

<p>导航实现时，需要依赖于地图与定位功能，我们可以在一个launch文件中集成之前的定位launch以及当前编写的导航核心模块的launch，以简化导航功能的启动，在launch目录下新建一个名为<code class="language-plaintext highlighter-rouge">bringup.launch.py</code>的launch文件，并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">amcl_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_localization</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">nav2_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">amcl_launch</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">amcl_pkg</span><span class="p">,</span><span class="sh">'</span><span class="s">launch</span><span class="sh">'</span><span class="p">,</span>
                                                    <span class="sh">'</span><span class="s">mycar_loca.launch.py</span><span class="sh">'</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">nav2_launch</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">nav2_pkg</span><span class="p">,</span><span class="sh">'</span><span class="s">launch</span><span class="sh">'</span><span class="p">,</span> 
                                                    <span class="sh">'</span><span class="s">nav2.launch.py</span><span class="sh">'</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">ld</span> <span class="o">=</span> <span class="nc">LaunchDescription</span><span class="p">()</span>
    <span class="n">ld</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">amcl_launch</span><span class="p">)</span>
    <span class="n">ld</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">nav2_launch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ld</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>4.编辑配置文件</strong></p>

<p>打开<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> 并输入如下内容：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">install</span><span class="p">(</span>DIRECTORY launch params bts
  DESTINATION share/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>5.编译</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_navigation2
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>6.执行</strong></p>

<p>（1）请先调用如下指令启动仿真环境：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch stage_ros2 my_house.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（2）然后在终端下进入当前工作空间，输入如下指令启动导航功能：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch mycar_navigation2 bringup.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（3）启动rviz2，加载<code class="language-plaintext highlighter-rouge">/opt/ros/humble/share/nav2_bringup/rviz</code>下的<code class="language-plaintext highlighter-rouge">nav2_default_view.rviz</code>文件，为机器人设置初始位姿后，再通过菜单栏的<code class="language-plaintext highlighter-rouge">Nav2 Goal</code>设置目标点，机器人就可以自动导航至目标点了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rviz2 <span class="nt">-d</span> /opt/ros/humble/share/nav2_bringup/rviz/nav2_default_view.rviz
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">rviz2</code>：启动 <code class="language-plaintext highlighter-rouge">rviz2</code> 工具。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-d</code>：指定要加载的 <code class="language-plaintext highlighter-rouge">.rviz</code> 配置文件。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/opt/ros/humble/share/nav2_bringup/rviz/nav2_default_view.rviz</code>：<code class="language-plaintext highlighter-rouge">.rviz</code> 配置文件的路径。</p>
  </li>
</ul>

<p>运行该命令后，<code class="language-plaintext highlighter-rouge">rviz2</code> 将启动并加载 <code class="language-plaintext highlighter-rouge">nav2_default_view.rviz</code> 配置文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1766.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1767.webp" alt="" /></p>

<p>如上图，左图是选择初始位置，右图是选择目标位置。</p>

<p>上图中，每个障碍物和墙附近的光圈是危险程度，颜色越红表示机器人经过此地越危险。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1768.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1769.webp" alt="" /></p>

<h3 id="自主探索slam">自主探索SLAM</h3>

<p>导航需要依赖于地图与定位，例如在上一节 <strong>导航功能集成</strong> 中，导航实现时就是以launch文件的方式集成了 <strong>定位AMCL</strong> 一节中的定位功能，而机器人SLAM时，也是发布地图数据与定位信息的，所以导航时也可以不借助于amcl而是直接与SLAM结合，达到自主探索的SLAM效果。</p>

<p><strong>1.编写launch文件</strong></p>

<p>在功能包mycar_navigation2的launch目录下新建名为<code class="language-plaintext highlighter-rouge">auto_slam.launch.py</code>的launch文件，并输入如下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="n">slam_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_slam_slam_toolbox</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">nav2_pkg</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">mycar_navigation2</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">slam_launch</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">slam_pkg</span><span class="p">,</span><span class="sh">'</span><span class="s">launch</span><span class="sh">'</span><span class="p">,</span>
                                                    <span class="sh">'</span><span class="s">online_sync_launch.py</span><span class="sh">'</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="c1"># slam_launch = IncludeLaunchDescription(
</span>
    <span class="c1">#     PythonLaunchDescriptionSource(os.path.join(slam_pkg,'launch',
</span>
    <span class="c1">#                                                 'online_async_launch.py'))
</span>
    <span class="c1">#     )
</span>
    <span class="n">nav2_launch</span> <span class="o">=</span> <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="nc">PythonLaunchDescriptionSource</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">nav2_pkg</span><span class="p">,</span><span class="sh">'</span><span class="s">launch</span><span class="sh">'</span><span class="p">,</span> 
                                                    <span class="sh">'</span><span class="s">nav2.launch.py</span><span class="sh">'</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">ld</span> <span class="o">=</span> <span class="nc">LaunchDescription</span><span class="p">()</span>
    <span class="n">ld</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">slam_launch</span><span class="p">)</span>
    <span class="n">ld</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">nav2_launch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ld</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>2.编译</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> mycar_navigation2
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>3.执行</strong></p>

<p>（1）请先调用如下指令启动仿真环境：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch stage_ros2 my_house.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（2）然后在终端下进入当前工作空间，输入如下指令启动自主SLAM功能：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch mycar_navigation2 auto_slam.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>（3）启动rviz2，加载<code class="language-plaintext highlighter-rouge">/opt/ros/humble/share/nav2_bringup/rviz</code>下的<code class="language-plaintext highlighter-rouge">nav2_default_view.rviz</code>文件，再通过菜单栏的<code class="language-plaintext highlighter-rouge">Nav2 Goal</code>设置目标点，机器人就可以自动导航至目标点，并且导航中还会实现建图的功能。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rviz2 <span class="nt">-d</span> /opt/ros/humble/share/nav2_bringup/rviz/nav2_default_view.rviz
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1770.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1771.webp" alt="" /></p>

<h2 id="多车编队">多车编队</h2>

<p>多车编队技术通过先进的传感器、实时数据分析和高度智能化的控制系统，使得一组车辆能够在没有人工干预的情况下实现协同运行，作为一种先进的智能交通系统应用，已经在多个领域展现出其巨大的潜力和广泛的应用场景。比如：</p>

<blockquote>
  <p>时间优化：多车编队技术消除了人为操作中的误差和延误，降低了人力资源成本和运营风险。</p>

  <p>空间优化：多车编队技术可以减少车辆间的空隙，最大化道路利用率。</p>

  <p>性能优化：密集编队行驶减少了空气动力学阻力，降低了能耗和燃料消耗。</p>
</blockquote>

<p>总之，多车编队技术在机器人领域有着独特的作用和价值。本节将介绍如何在ROS2中实现多车编队。</p>

<h1 id="ros2-serial">ROS2 Serial</h1>

<h2 id="ros1串口库11">ROS1串口库1.1</h2>

<p>这是ROS1的库，但是也可以从第三方源码编译这个库，用于ROS2.</p>

<p>http://wjwwood.io/serial/doc/1.1.0/index.html</p>

<h2 id="ros2串口库12">ROS2串口库1.2</h2>

<p>顾名思义，是一个串口包，</p>

<p>该库适用于ROS Humble和ROS Jazzy版本。</p>

<p>官方详解:</p>

<p>https://docs.ros.org/en/humble/p/serial_driver/generated/index.html#</p>

<p>https://index.ros.org/p/serial_driver/</p>

<p>下面是根据官方文档手搓的教程（截至教程出之前，还没有任何一个像样的教程）</p>

<h3 id="serialdriver库特点">SerialDriver库特点</h3>

<p>该库主要基于Boost.Asio库，所以说原理就是Boost.Asio库的特点：</p>

<p><strong>事件驱动</strong> Boost.Asio 使用操作系统提供的底层 I/O 复用机制（如 Linux 的 <code class="language-plaintext highlighter-rouge">epoll</code>、Windows 的 I/O Completion Ports）来监控文件描述符（如串口、套接字等）是否有可用的数据。当数据到达时，触发相应的事件。</p>

<p><strong>回调机制</strong> 用户调用异步方法（如 <code class="language-plaintext highlighter-rouge">async_read</code> 或 <code class="language-plaintext highlighter-rouge">async_receive</code>）时，传入一个回调函数。当指定的事件（如数据接收完成）发生后，Boost.Asio 会自动调用用户提供的回调函数。</p>

<p><strong>I/O 服务对象</strong> Boost.Asio 的核心是一个 <code class="language-plaintext highlighter-rouge">io_service</code> 或 <code class="language-plaintext highlighter-rouge">io_context</code> 对象，它管理所有的异步操作和回调的调度。异步接收时：</p>

<ul>
  <li>
    <p>用户将操作（如 <code class="language-plaintext highlighter-rouge">async_receive</code>）注册到 <code class="language-plaintext highlighter-rouge">io_context</code>。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">io_context</code> 将异步操作挂起，并等待 I/O 事件的触发。</p>
  </li>
  <li>
    <p>当 I/O 事件触发时，<code class="language-plaintext highlighter-rouge">io_context</code> 调用对应的回调函数。</p>
  </li>
</ul>

<p><strong>不阻塞主线程</strong> 异步操作不会阻塞调用线程。主线程可以继续执行其他任务，而异步操作在后台完成。</p>

<h3 id="基于boostasio库的优点">基于Boost.Asio库的优点</h3>

<p>Boost.Asio库是靠系统IO进行事件触发的，并且单独开了一个线程去干这件事，所以这就使boost库拥有单片机的串口中断的特点，又拥有真多线程的特点。</p>

<p>而单片机的串口中断，虽然也能通过IO进行事件触发，但是由于单片机只有一个真线程，所以在进入中断时，一定会阻塞主线程，造成效率损失。</p>

<p>如果在主线程里直接接收并加上死循环和延时，这种效率往往是最低的，并且有很大的安全风险，非常不建议使用。</p>

<p>效率：Boost.Asio接收 » 单片机串口中断 » 多线程阻塞式接收 » 单线程阻塞式接收（在传输速度非常快的情况下，全都是远远大于»）</p>

<h3 id="安装ros2串口包">安装ROS2串口包</h3>

<p><strong>serial_driver</strong> 是一个封装了串口通信功能的库，它分为两个部分：</p>

<ul>
  <li>
    <p><strong>ROS2 依赖版本</strong> ：用于 ROS2 环境中，依赖于 ROS2 的通信机制（如 <code class="language-plaintext highlighter-rouge">rclcpp</code>）。</p>
  </li>
  <li>
    <p><strong>独立库版本</strong> ：不依赖 ROS2，可以直接在普通的 C++ 项目中使用。(未经测试)</p>
  </li>
</ul>

<h4 id="方式一在ros2中安装"><strong>方式一：在ROS2中安装</strong></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;ros2-distro&gt;-asio-cmake-module
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;ros2-distro&gt;-serial-driver

<span class="c">#humble</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-asio-cmake-module
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-humble-serial-driver
<span class="c">#jazzy</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-asio-cmake-module
<span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-serial-driver
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="方式二通用该方法未经测试如果你测试了请帮忙删掉本句话"><strong>方式二：通用（该方法未经测试，如果你测试了，请帮忙删掉本句话）</strong></h4>

<p>如果你在ROS1或者说其他地方使用，而且没有安装ROS2，请选择该方法。</p>

<p><strong>克隆仓库</strong></p>

<p>首先，克隆 <strong>transport_drivers</strong> 仓库（包含 <code class="language-plaintext highlighter-rouge">serial_driver</code>）：</p>

<p>https://github.com/ros-drivers/transport_drivers</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git clone https://github.com/ros-drivers/transport_drivers.git
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>安装依赖</strong></p>

<p><code class="language-plaintext highlighter-rouge">serial_driver</code> 依赖于 <strong>ASIO</strong> 库（一个跨平台的 C++ 网络编程库）。确保系统中已安装 ASIO：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>libasio-dev
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>编译独立库</strong></p>

<p>进入 <code class="language-plaintext highlighter-rouge">serial_driver</code> 目录并编译：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">cd </span>transport_drivers/serial_driver
<span class="nb">mkdir </span>build
<span class="nb">cd </span>build
cmake ..
make
<span class="nb">sudo </span>make <span class="nb">install</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装完毕后，在CMake里正常添加该包就可以。</p>

<h4 id="其他准备工作">其他准备工作</h4>

<p><strong>串口调试助手安装(Linux版) (如果需要Windows版，问控制组要去)</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>cutecom
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>权限</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 将用户权限提高</span>
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> dialout <span class="nv">$USER</span>
newgrp dialout
</pre></td></tr></tbody></table></code></pre></div></div>

<p>有关Linux的USB设备的更多操作请看<a href="https://sdutvincirobot.feishu.cn/wiki/GIKnwJo39iREkHkFGvqcy5Osntc">Vinci机器人队Linux入门教程</a></p>

<h3 id="初始化详解">初始化详解</h3>

<ol>
  <li>创建功能包</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cpp01_serial <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp serial_driver <span class="nt">--node-name</span> demo01_uart_send
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p>引用头文件：<code class="language-plaintext highlighter-rouge">#include "serial_driver/serial_driver.hpp"</code></p>
  </li>
  <li>
    <p>首先要初始化串口：</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1772.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1773.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1774.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1775.webp" alt="" /></p>

<p>串口初始化函数<code class="language-plaintext highlighter-rouge">init_port()</code>有俩参数，</p>

<p>第一个参数device_name 是端口名称</p>

<p>第二个参数config 是串口参数设置</p>

<p>device_name是个字符串，是填<code class="language-plaintext highlighter-rouge">/dev</code>下的设备名</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1776.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1777.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">ls</span> /dev | <span class="nb">grep </span>USB
</pre></td></tr></tbody></table></code></pre></div></div>

<p>有关Linux的USB设备的更多操作请看<a href="https://sdutvincirobot.feishu.cn/wiki/GIKnwJo39iREkHkFGvqcy5Osntc">Vinci机器人队Linux入门教程</a></p>

<p>config是个类对象，所以要创建一下这个类对象如下：</p>

<p>这玩意是个轻量化的类，没必要放在堆区，直接在栈区里创建即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1778.webp" alt="" /></p>

<p>SerialPortConfig(uint32_t baud_rate, <strong>drivers::serial_driver::FlowControl flow_control</strong> , drivers::serial_driver::Parity parity, drivers::serial_driver::StopBits stop_bits)</p>

<p>从这个重载函数可以看到(参数不懂的问控制组)</p>

<p>第一个参数baud_rate 波特率</p>

<p>第二个参数flow_control 流控制</p>

<p>第三个参数parity 奇偶效验</p>

<p>第四个参数stop_bits 停止位</p>

<p>具体的参数在<code class="language-plaintext highlighter-rouge">serial_port.hpp</code>中有</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1779.webp" alt="" /></p>

<p>这样串口就初始化成功了。</p>

<h3 id="发送代码详解">发送代码详解</h3>

<ol>
  <li>发送主逻辑</li>
</ol>

<p>我们接下来写发送主逻辑，首先要创建一个延时，不要使用while(true)这种死循环延迟，ROS2提供了定时器。</p>

<p>先创建定时器（创建定时器不用详解了，不懂的回顾上面赵老师的视频）</p>

<p>就需要注意一个点，我们用的是 <strong>毫秒milliseconds</strong> ，不是 <strong>微秒microseconds</strong> 。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1780.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1781.webp" alt="" /></p>

<p>发送核心函数是这个send函数，可以看到，入口参数是vector类型的向量，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1782.webp" alt="" /></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"serial_driver/serial_driver.hpp"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Serial_Node</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Serial_Node</span><span class="p">()</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"serial_node_cpp"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 等设备准备好再初始化</span>
    <span class="c1">// std::this_thread::sleep_for(std::chrono::milliseconds(500));</span>

    <span class="c1">// 串口设备名（根据实际设备调整）</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">device_name</span> <span class="o">=</span> <span class="s">"/dev/ttyUSB0"</span><span class="p">;</span>

    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port Node Open!"</span><span class="p">);</span>
    <span class="c1">// 创建串口配置对象</span>
    <span class="c1">// 波特率115200；不开启流控制；无奇偶效验；停止位1。</span>
    <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialPortConfig</span> <span class="n">config</span><span class="p">(</span>
        <span class="mi">9600</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">FlowControl</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">Parity</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">StopBits</span><span class="o">::</span><span class="n">ONE</span><span class="p">);</span>

    <span class="c1">// 初始化串口</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">io_context_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="c1">// 初始化 serial_driver_</span>
      <span class="n">serial_driver_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">io_context_</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">init_port</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>

      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port initialized successfully"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Using device: %s"</span><span class="p">,</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Baud_rate: %d"</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">get_baud_rate</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Failed to initialize serial port: %s"</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 设置发送定时器</span>
    <span class="n">send_timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Serial_Node</span><span class="o">::</span><span class="n">send_message_timer_callback</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="nf">send_message_timer_callback</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// 发送一串字符串</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Hello from ROS 2!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="c1">// std::vector&lt;uint8_t&gt; hex_data = {0x48, 0x65, 0x6C, 0x6C, 0x6F}; // "Hello" in ASCII</span>
    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="k">try</span>
    <span class="p">{</span>
      <span class="kt">size_t</span> <span class="n">bytes_sent_size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Sent: %s (%ld bytes)"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">bytes_sent_size</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Error Transmiting from serial port:%s"</span><span class="p">,</span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span> <span class="n">serial_driver_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span> <span class="n">io_context_</span><span class="p">;</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">send_timer_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Serial_Node</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1783.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1784.webp" alt="" /></p>

<h3 id="接收代码详解">接收代码详解</h3>

<h4 id="定时器方式低效不建议用">定时器方式(低效，不建议用)</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"serial_driver/serial_driver.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Serial_Node</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Serial_Node</span><span class="p">()</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"serial_node_cpp"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 等设备准备好再初始化</span>
    <span class="c1">// std::this_thread::sleep_for(std::chrono::milliseconds(500));</span>

    <span class="c1">// 串口设备名（根据实际设备调整）</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">device_name</span> <span class="o">=</span> <span class="s">"/dev/ttyUSB0"</span><span class="p">;</span>

    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port Node Open!"</span><span class="p">);</span>
    <span class="c1">// 创建串口配置对象</span>
    <span class="c1">// 波特率115200；不开启流控制；无奇偶效验；停止位1。</span>
    <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialPortConfig</span> <span class="n">config</span><span class="p">(</span>
        <span class="mi">9600</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">FlowControl</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">Parity</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">StopBits</span><span class="o">::</span><span class="n">ONE</span><span class="p">);</span>

    <span class="c1">// 初始化串口</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">io_context_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="c1">// 初始化 serial_driver_</span>
      <span class="n">serial_driver_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">io_context_</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">init_port</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>

      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port initialized successfully"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Using device: %s"</span><span class="p">,</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Baud_rate: %d"</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">get_baud_rate</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Failed to initialize serial port: %s"</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 设置发送定时器</span>
    <span class="n">receive_timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Serial_Node</span><span class="o">::</span><span class="n">receive_message_timer_callback</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="nf">receive_message_timer_callback</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="c1">// "Hello" in ASCII</span>
    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="k">try</span>
    <span class="p">{</span>
      <span class="kt">size_t</span> <span class="n">bytes_receive_size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">bytes_receive_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">bytes_receive_size</span><span class="p">);</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Receive: %s (%ld bytes)"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">bytes_receive_size</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Error Receiving from serial port:%s"</span><span class="p">,</span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span> <span class="n">serial_driver_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span> <span class="n">io_context_</span><span class="p">;</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">receive_timer_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Serial_Node</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1785.webp" alt="" /></p>

<h4 id="异步方式高效">异步方式(高效)</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"serial_driver/serial_driver.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Serial_Node</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Serial_Node</span><span class="p">()</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"serial_node_cpp"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 等设备准备好再初始化</span>
    <span class="c1">// std::this_thread::sleep_for(std::chrono::milliseconds(500));</span>

    <span class="c1">// 串口设备名（根据实际设备调整）</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">device_name</span> <span class="o">=</span> <span class="s">"/dev/ttyUSB0"</span><span class="p">;</span>

    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port Node Open!"</span><span class="p">);</span>
    <span class="c1">// 创建串口配置对象</span>
    <span class="c1">// 波特率115200；不开启流控制；无奇偶效验；停止位1。</span>
    <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialPortConfig</span> <span class="n">config</span><span class="p">(</span>
        <span class="mi">9600</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">FlowControl</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">Parity</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">StopBits</span><span class="o">::</span><span class="n">ONE</span><span class="p">);</span>

    <span class="c1">// 初始化串口</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">io_context_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="c1">// 初始化 serial_driver_</span>
      <span class="n">serial_driver_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">io_context_</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">init_port</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>

      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port initialized successfully"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Using device: %s"</span><span class="p">,</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Baud_rate: %d"</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">get_baud_rate</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Failed to initialize serial port: %s"</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">async_receive_message</span><span class="p">();</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="nf">async_receive_message</span><span class="p">()</span>  <span class="c1">//创建一个函数更方便重新调用</span>
  <span class="p">{</span>
    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="c1">// 设置接收回调函数</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">async_receive</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="k">const</span> <span class="kt">size_t</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 处理接收到的数据</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">received_message</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
            <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Received: %s (%ld bytes)"</span><span class="p">,</span> <span class="n">received_message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">size</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 继续监听新的数据</span>
        <span class="n">async_receive_message</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span> <span class="n">serial_driver_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span> <span class="n">io_context_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">receive_data_buffer</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="c1">// 接收缓冲区</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Serial_Node</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1786.webp" alt="" /></p>

<h3 id="总代码又发又收">总代码(又发又收)</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"serial_driver/serial_driver.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Serial_Node</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Serial_Node</span><span class="p">()</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"serial_node_cpp"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 等设备准备好再初始化</span>
    <span class="c1">// std::this_thread::sleep_for(std::chrono::milliseconds(500));</span>

    <span class="c1">// 串口设备名（根据实际设备调整）</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">device_name</span> <span class="o">=</span> <span class="s">"/dev/ttyUSB0"</span><span class="p">;</span>

    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port Node Open!"</span><span class="p">);</span>
    <span class="c1">// 创建串口配置对象</span>
    <span class="c1">// 波特率115200；不开启流控制；无奇偶效验；停止位1。</span>
    <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialPortConfig</span> <span class="n">config</span><span class="p">(</span>
        <span class="mi">9600</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">FlowControl</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">Parity</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">StopBits</span><span class="o">::</span><span class="n">ONE</span><span class="p">);</span>

    <span class="c1">// 初始化串口</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">io_context_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="c1">// 初始化 serial_driver_</span>
      <span class="n">serial_driver_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">io_context_</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">init_port</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>

      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port initialized successfully"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Using device: %s"</span><span class="p">,</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Baud_rate: %d"</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">get_baud_rate</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Failed to initialize serial port: %s"</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

        <span class="c1">// 设置发送定时器</span>
    <span class="n">transmit_timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">5000</span><span class="p">),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Serial_Node</span><span class="o">::</span><span class="n">send_message_timer_callback</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>

    <span class="n">async_receive_message</span><span class="p">();</span>   <span class="c1">//进入异步接收</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>

  <span class="kt">void</span> <span class="nf">send_message_timer_callback</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// 发送一串字符串</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">transmitted_message</span> <span class="o">=</span> <span class="s">"Hello from ROS 2!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">transmit_data_buffer</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">transmitted_message</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">transmitted_message</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="c1">// std::vector&lt;uint8_t&gt; hex_data = {0x48, 0x65, 0x6C, 0x6C, 0x6F}; // "Hello" in ASCII</span>
    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="k">try</span>
    <span class="p">{</span>
      <span class="kt">size_t</span> <span class="n">bytes_transmit_size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">transmit_data_buffer</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Transmitted: %s (%ld bytes)"</span><span class="p">,</span> <span class="n">transmitted_message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">bytes_transmit_size</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Error Transmiting from serial port:%s"</span><span class="p">,</span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">async_receive_message</span><span class="p">()</span>  <span class="c1">//创建一个函数更方便重新调用</span>
  <span class="p">{</span>
    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="c1">// 设置接收回调函数</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">async_receive</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="k">const</span> <span class="kt">size_t</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 处理接收到的数据</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">received_message</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
            <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Received: %s (%ld bytes)"</span><span class="p">,</span> <span class="n">received_message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">size</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 继续监听新的数据</span>
        <span class="n">async_receive_message</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span> <span class="n">serial_driver_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span> <span class="n">io_context_</span><span class="p">;</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">transmit_timer_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">transmit_data_buffer</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="c1">// 发送缓冲区</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">receive_data_buffer</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>  <span class="c1">// 接收缓冲区</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Serial_Node</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1787.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1788.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1789.webp" alt="" /></p>

<h3 id="注意事项">注意事项</h3>

<ol>
  <li>禁止引用<code class="language-plaintext highlighter-rouge">boost/asio.hpp</code>：由于该库的原理就是boost库，而且是ROS2自带的boost库，所以你用通用版的<code class="language-plaintext highlighter-rouge">boost/asio.hpp</code>，会导致报错出现很多标志重复的问题。</li>
</ol>

<h1 id="机器人硬件">机器人硬件</h1>

<h2 id="机器人组成">机器人组成</h2>

<p>立足角度不同，对机器人组成的认识也会有所不同。宏观上讲，机器人由硬件以及软件两大部分组成。进一步细化，机器人又可以分为三大部分： <strong>控制系统</strong> 、 <strong>传感系统</strong> 与 <strong>硬件平台</strong> 。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1790.webp" alt="" /></p>

<p>1.控制系统</p>

<p>控制系统相当于机器人的大脑，由安装了机器人操作系统的处理器组成，是机器人的核心。控制系统的主要任务是根据作业指令和传感器反馈生成控制命令，同时负责算法处理和人机交互等功能。它在机器人中扮演着智能决策和执行任务的关键角色。</p>

<p>2.传感系统</p>

<p>传感系统相当于机器人的感官，分为内部传感器模块和外部传感器模块。</p>

<ul>
  <li>
    <p>内部传感系统包括电机的编码器、陀螺仪等，可以通过自身信号反馈来检测机器人的位姿状态。</p>
  </li>
  <li>
    <p>外部传感系统包括摄像头、雷达等，用于感知外部环境。</p>
  </li>
</ul>

<p>传感系统获取有用的信息，帮助机器人感知和理解周围的环境，起到辅助机器人操作和决策的作用。</p>

<p>3.硬件平台</p>

<p>硬件平台相当于机器人的躯体，提供了对机器人的物理支持，通常由驱动系统和执行机构两部分组成。</p>

<ul>
  <li>
    <p>驱动系统主要负责驱动执行机构，将控制系统下达的命令转换为执行机构所需的信号，类似于人的小脑和神经。</p>
  </li>
  <li>
    <p>执行机构是机器人的机械部分，类似于人的手和脚，例如机器人的行走部分和机械臂。</p>
  </li>
</ul>

<p>目前，机器人的硬件平台已经非常成熟，种类也非常丰富。包括但不限于飞行器、轮式机器人、四足机器人、人形机器人、软体机器人和水下机器人等。此外，我们甚至可以根据丰富的参考资料制作简易的机器人。在学习和工作中，大家可以根据实际需求选择适合的机器人平台。</p>

<h2 id="工控机之远程开发环境">工控机之远程开发环境</h2>

<p><strong>场景</strong></p>

<p>机器人平台一般自带预装了ROS的控制系统。这套控制系统与我们前一阶段的学习环境基本无异，具体到开发或应用层面也大致相同，我们可以借助于平台外设的鼠标、键盘、显示器等直接在其上开发、调试程序或控制该机器人。但是在”面向平台“开发时可能遇到一些问题，比如：</p>

<blockquote>
  <ol>
    <li>
      <p>机器人是一辆移动式平台时，”面向平台“的开发模式下可能需要人随车走，这显然效率低下，并存在一定的安全隐患；</p>
    </li>
    <li>
      <p>”面向平台“的开发模式，还会受限于环境、地形等诸多因素的约束；</p>
    </li>
    <li>
      <p>机器人与开发人员之间可能是一对多的关系，也即多位开发或测试工程师使用同一台设备，”面向平台“的开发模式下不免会出现资源抢占的情况；</p>
    </li>
  </ol>

</blockquote>

<p>总而言之，”面向平台“开发有其可行性，但是也存在诸多不便，此背景下，就可以通过搭建远程开发环境来解决上述问题了。</p>

<p><strong>概念</strong></p>

<p><strong>远程开发</strong> 是一种在远程主机上进行编写、编译或运行程序的开发方式。相对于本地开发，远程开发需要将本地设备连接到远程主机，以实现数据传输和操作同步。</p>

<p><strong>作用</strong></p>

<p>远程开发可以带来一些优势，比如提供更强大的计算资源、便于团队协作、统一开发环境等。同时，远程开发也需要考虑网络延迟和稳定性等因素。总的来说，远程开发可以提供更灵活和便捷的开发环境，适用于不同场景和需求。</p>

<p><strong>实现方式</strong></p>

<p>在本教程中，我们将主要介绍两种常用的远程开发模式：SSH和NoMachine。这是两种常见的远程连接方式，它们在功能和使用方式上有一些差异。</p>

<ul>
  <li>
    <p>SSH是一种命令行界面的连接方式，用户需要通过命令行输入指令进行远程操作。对于熟悉命令行的用户来说，SSH可能更加灵活和高效。</p>
  </li>
  <li>
    <p>NoMachine提供了图形界面的远程连接，用户可以直观地操作远程计算机的桌面。它支持窗口、多显示器和文件传输等功能，适合那些需要图形界面的远程操作。</p>
  </li>
</ul>

<p>总的来说，SSH更适合需要执行命令行操作和快速访问的场景，而NoMachine更适合需要图形界面远程桌面访问的场景。选择哪种方式应该根据具体的需求和使用习惯来决定。</p>

<h3 id="远程开发ssh">远程开发SSH</h3>

<p>详见<a href="https://sdutvincirobot.feishu.cn/wiki/GIKnwJo39iREkHkFGvqcy5Osntc">Vinci机器人队Linux入门教程</a></p>

<h3 id="远程访问桌面">远程访问桌面</h3>

<p>详见<a href="https://sdutvincirobot.feishu.cn/wiki/GIKnwJo39iREkHkFGvqcy5Osntc">Vinci机器人队Linux入门教程</a></p>

<h2 id="工控机之外接usb设备">工控机之外接USB设备</h2>

<p>详见<a href="https://sdutvincirobot.feishu.cn/wiki/GIKnwJo39iREkHkFGvqcy5Osntc">Vinci机器人队Linux入门教程</a></p>

<h2 id="分布式搭建-1">分布式搭建</h2>

<p>在 <strong>ROS2其他通信机制</strong> 章节里</p>

<h2 id="优化日志">优化日志</h2>

<p>在实际应用上,我们很少使用<code class="language-plaintext highlighter-rouge">RCLCPP_INFO</code>,原因是打印数据开销太大,像Nvidia Jetson Xavier等工控机设备可能吃不消.</p>

<p>像下方这个图就显示了在树莓派4b下打印的开销:</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1791.webp" alt="" /></p>

<p>由于我们想避免那么大的开销,又想在必要时查看打印的数据进行调试,所以我们常采用<code class="language-plaintext highlighter-rouge">RCLCPP_DEBUG</code>来打印数据,在必要时期才打印数据.</p>

<p><code class="language-plaintext highlighter-rouge">RCLCPP_DEBUG</code> <strong>的核心作用</strong></p>

<ul>
  <li>
    <p><strong>调试专用</strong> ：仅在调试阶段输出信息，生产环境自动静默</p>
  </li>
  <li>
    <p><strong>性能优化</strong> ：通过编译选项完全移除调试代码，零运行时开销</p>
  </li>
  <li>
    <p><strong>分级控制</strong> ：与其他日志级别（INFO/WARN/ERROR）解耦</p>
  </li>
</ul>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1792.webp" alt="" /></p>

<p><strong>打印出来rclcpp_debug的方式:</strong></p>

<p><strong>方式一:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run &lt;package_name&gt; &lt;node_name&gt; <span class="nt">--ros-args</span> <span class="nt">--log-level</span> debug
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>方式二:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="nc">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">my_package</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">my_node</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">my_node</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">--ros-args</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--log-level</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">])</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/opt/ros/humble/include/rcutils/rcutils/logging.h</code>定义：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1793.webp" alt="" /></p>

<h2 id="硬件平台">硬件平台</h2>

<p>硬件平台的选择是具有多样性的，比如：轮式底盘、两足或四足机器人、无人机等等。现在硬件平台相关技术发展的已经比较成熟了，可以自己制作，也可以直接采购，假设选择后者的话，那么购买后，关于具体使用，可以参考配套的使用手册。一般情况下，供应商会提供对应的驱动包，直接下载并编译执行即可驱动硬件平台，当然如果是集成了上位机的整套机器人方案，那么一般已经预置了驱动程序，届时直接运行即可。</p>

<p>机器人下位机常用的开发板有STM32，ESP32，GD32，Arduino，51MCU等等。（不懂的问控制组和电路组）</p>

<p>与机器人下位机开发板通信常用的有串口通信，MicroROS等方式，可以看上方的教程。</p>

<p>我们可以让下位机传给上位机的数据有里程计ODOM数据，惯性计IMU数据，全球定位GNSS数据等等，当然也可以让这些设备直接与工控机通信，让工控机处理好机器人的定位信息再一起传给下位机。</p>

<p>下面需要介绍这些数据如何进行传输。</p>

<p>自己写的大部分源码仅供参考，如果有更好的思路可以说：</p>

<p>我用Jazzy版本多一些，一切以Jazzy版本为最终参考，Humble其实与Jazzy最大区别就是Gazebo,关于Gazebo的代码可以看Humble仓库的。</p>

<p>https://github.com/CyberNaviRobot/CyberRobot_ROS2_Humble_WS</p>

<p>https://github.com/CyberNaviRobot/CyberRobot_ROS2_Jazzy_WS</p>

<h3 id="里程计odom">里程计Odom</h3>

<h4 id="功能包创建">功能包创建</h4>

<p>不一定非得要码盘(里程计Odom)的数据，只要把机器人6个自由度DOF，可以由电机编码器计算而来（x,y,z,yaw,pitch,roll不懂的看上方Moveit2里的教学）全部发过来就行。</p>

<p>首先先创建功能包</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create odom_plumb <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp nav_msgs geometry_msgs tf2_ros <span class="nt">--node-name</span> odom_node
</pre></td></tr></tbody></table></code></pre></div></div>

<p>先编译一下</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--cmake-args</span> <span class="nt">-DCMAKE_EXPORT_COMPILE_COMMANDS</span><span class="o">=</span>ON
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="消息接口">消息接口</h4>

<p>底盘驱动启动之后，会持续广播一个比较重要的数据——里程计。里程计用于描述当前机器人相对于出发点的位姿以及速度等信息，里程计在机器人定位和导航的局部路径规划中有着重要的作用。在ROS2中里程计消息被封装为了<code class="language-plaintext highlighter-rouge">nav_msgs/msg/Odometry</code>接口，可通过指令<code class="language-plaintext highlighter-rouge">ros2 interface show nav_msgs/msg/Odometry</code>查看该接口的具体数据结构，结果如下：</p>

<p>它描述的是机器人位姿与速度的预估信息。 其中位姿信息是以header中的frame_id为参考系的，而速度信息则是以child_frame_id为参考系的。</p>

<p>在 <strong>ROS2</strong> 中， <strong>odom 坐标系</strong> （通常是 <code class="language-plaintext highlighter-rouge">odom</code> frame）遵循 <strong>右手坐标系</strong> ，其定义如下：</p>

<ul>
  <li>
    <p><strong>X 轴</strong> ：向前（前进方向）为 <strong>正</strong></p>
  </li>
  <li>
    <p><strong>Y 轴</strong> ：向左（左侧方向）为 <strong>正</strong></p>
  </li>
  <li>
    <p><strong>Z 轴</strong> ：向上（垂直地面）为 <strong>正</strong></p>
  </li>
</ul>

<p>在 <strong>ROS2 的 odom 坐标系</strong> （右手坐标系）中， <strong>yaw 角的定义</strong> 如下：</p>

<ul>
  <li>
    <p><strong>yaw = 0</strong> ：机器人面向 <strong>X 轴正方向</strong> （向前）。</p>
  </li>
  <li>
    <p><strong>逆时针（CCW，Counter Clockwise）旋转为正</strong> 。</p>
  </li>
  <li>
    <p><strong>顺时针（CW，Clockwise）旋转为负</strong> 。</p>
  </li>
</ul>

<p><strong>yaw 角范围</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">yaw ∈ (-π, π]</code> <strong>（即 <code class="language-plaintext highlighter-rouge">-180°</code> 到 <code class="language-plaintext highlighter-rouge">180°</code>）</strong></p>
  </li>
  <li>
    <p>当 <code class="language-plaintext highlighter-rouge">yaw = π</code>（180°），如果继续增加，应该跳转到 <code class="language-plaintext highlighter-rouge">-π</code>（-180°），而不是 <code class="language-plaintext highlighter-rouge">π</code>。</p>
  </li>
  <li>
    <p>当 <code class="language-plaintext highlighter-rouge">yaw = -π</code>（-180°），如果继续减少，应该跳转到 <code class="language-plaintext highlighter-rouge">π</code>（180°）。</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>std_msgs/Header header <span class="c"># 标头</span>
    builtin_interfaces/Time stamp <span class="c"># 时间戳</span>
        int32 sec
        uint32 nanosec
    string frame_id <span class="c"># 位姿信息所参考的坐标系</span>
位姿信息所指向的坐标系，也是速度信息所参考的坐标系
string child_frame_id
相对于frame_id的预估位姿信息
geometry_msgs/PoseWithCovariance pose
    Pose pose
        Point position <span class="c"># 坐标</span>
            float64 x
            float64 y
            float64 z
        Quaternion orientation <span class="c"># 四元数</span>
            float64 x 0
            float64 y 0
            float64 z 0
            float64 w 1
    float64[36] covariance
相对于child_frame_id的预估线速度与角速度
geometry_msgs/TwistWithCovariance twist
    Twist twist
        Vector3  linear <span class="c"># 线速度</span>
            float64 x
            float64 y
            float64 z
        Vector3  angular <span class="c"># 角速度</span>
            float64 x
            float64 y
            float64 z
    float64[36] covariance
</pre></td></tr></tbody></table></code></pre></div></div>

<p>需要注意的是，</p>

<ol>
  <li>
    <p>坐标和位姿是相对于<strong>frame_id</strong>的，一般是odom自己。</p>
  </li>
  <li>
    <p>而线速度和角速度是相对于<strong>child_frame_id</strong>的。一般是base_link <strong>。</strong> （这里注意，学长我最初就弄错了）</p>
  </li>
  <li>
    <p>虽然Twist是相对于child_frame_id <strong>（</strong> base_link）的，但是他表达的是<strong>瞬时值</strong>，就和汽车一样，汽车上面的速度表也是相对于车身的<strong>瞬时值</strong>。</p>
  </li>
  <li>
    <p>里程计在计算时是存在累计误差的，它所描述的是机器人的预估位姿，并不绝对准确。</p>
  </li>
</ol>

<h4 id="节点主要逻辑">节点主要逻辑</h4>

<p>所以我们需要初始化<code class="language-plaintext highlighter-rouge">nav_msgs::msg::Odometry</code>并发布出去。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1794.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1795.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1796.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1797.webp" alt="" /></p>

<p>所以你需要从MCU单片机上去获取这些数据，或者计算这些数据，并以<code class="language-plaintext highlighter-rouge">nav_msgs::msg::Odometry</code>类型的消息发送出去。</p>

<p>注意，如果你没有正儿八经的里程计，那么里程计的数据可以由底盘电机编码器数据计算而成。</p>

<p>除了发布话题的代码，别忘记发布odom与base_link之间的动态坐标变换。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1798.webp" alt="" /></p>

<p>下方是运动学正解算出来的odom数据:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"odom_mg513.h"</span><span class="cp">
#include</span> <span class="cpf">"mg513_gmr500ppr.h"</span><span class="cp">
</span><span class="c1">//#include &lt;cmath&gt;</span>
<span class="cp">#include</span> <span class="cpf">"arm_math.h"</span><span class="cp">
</span>
<span class="n">ODOM_Motor</span> <span class="n">odom_motor_</span><span class="p">;</span>

<span class="c1">// 坐标系满足右手坐标系</span>

<span class="c1">//（单位：米）</span>
<span class="c1">//轮距</span>
<span class="k">extern</span> <span class="n">fp32</span> <span class="n">Wheel_Spacing</span><span class="p">;</span>
<span class="c1">//轴距</span>
<span class="k">extern</span> <span class="n">fp32</span> <span class="n">Alex_Spacing</span><span class="p">;</span>
<span class="c1">//轮子半径</span>
<span class="k">extern</span> <span class="n">fp32</span> <span class="n">Wheel_Radius</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">ODOM_Motor</span><span class="o">::</span><span class="n">Analysis</span><span class="p">(</span><span class="n">fp32</span> <span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 将 RPM 转换为 m/s</span>
      <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mg513_gmr500ppr_motor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">encoder</span><span class="p">.</span><span class="n">motor_data</span><span class="p">.</span><span class="n">motor_speed</span>  <span class="o">*</span> <span class="mf">2.0f</span> <span class="o">*</span> <span class="mf">3.14159265358979f</span> <span class="o">*</span> <span class="n">Wheel_Radius</span> <span class="o">/</span> <span class="mf">60.0f</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 计算机器人前进的线速度和角速度，公式不需要轮半径</span>
    <span class="c1">//线速度，四个轮子在机器人的运动学模型中贡献相同，所以要除以4</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">vx</span> <span class="o">=</span> <span class="p">(</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0f</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">vy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0f</span><span class="p">;</span>

    <span class="c1">//线速度，轮距（wheel_spacing） 决定了左右轮对旋转的贡献程度，轴距（alex_spacing） 决定了前后轮对旋转的贡献程度，</span>
    <span class="c1">//所以要除以底盘尺寸，alex_spacing + wheel_spacing 是底盘尺寸。</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">vw</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">encoder_wheel_velocities_</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0f</span> <span class="o">*</span> <span class="p">(</span><span class="n">Wheel_Spacing</span> <span class="o">+</span> <span class="n">Alex_Spacing</span><span class="p">));</span>

    <span class="c1">// 更新机器人的位置（假设机器人沿着y轴移动）</span>
<span class="c1">//     this-&gt;x_position += this-&gt;vx * std::__math::cos(this-&gt;yaw) * this-&gt;dt;  </span>
<span class="c1">//     this-&gt;y_position += this-&gt;vy * std::__math::sin(this-&gt;yaw) * this-&gt;dt;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">x_position</span> <span class="o">+=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">vx</span> <span class="o">*</span> <span class="n">arm_cos_f32</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">yaw</span><span class="p">)</span> <span class="o">*</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">;</span>  
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">y_position</span> <span class="o">+=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">vy</span> <span class="o">*</span> <span class="n">arm_sin_f32</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">yaw</span><span class="p">)</span> <span class="o">*</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">yaw</span> <span class="o">+=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">vw</span> <span class="o">*</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">;</span>

    <span class="c1">// 保证 yaw 始终在 -PI 到 PI 之间</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">yaw</span> <span class="o">&gt;</span> <span class="mf">3.14159265358979f</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">yaw</span> <span class="o">-=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="mf">3.14159265358979f</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">yaw</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">3.14159265358979f</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">yaw</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="mf">3.14159265358979f</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">//    this-&gt;yaw_deg = this-&gt;yaw *  180.0f / 3.14159265358979f;</span>

<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>ROS2总代码如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"serial_driver/serial_driver.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;rclcpp/logging.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span> <span class="cpf">"sensor04_odom_kc/serial_pack.h"</span><span class="cp">
#include</span> <span class="cpf">"geometry_msgs/msg/twist.hpp"</span><span class="cp">
#include</span> <span class="cpf">"nav_msgs/msg/odometry.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;tf2/LinearMath/Quaternion.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tf2_ros/transform_broadcaster.h&gt;</span><span class="cp">
</span>
<span class="k">extern</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">tx_data_buffer</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Odom_KC_Node</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Odom_KC_Node</span><span class="p">()</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="s">"Odom_KC_Node"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 声明参数（带默认值）</span>
    <span class="c1">// 串口设备默认名（根据实际设备调整）</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">"device_name"</span><span class="p">,</span> <span class="s">"/dev/ttyACM1"</span><span class="p">);</span>
    <span class="c1">//串口默认波特率</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">"baud_rate"</span><span class="p">,</span> <span class="mi">115200</span><span class="p">);</span>

    <span class="c1">// 获取参数值</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">device_name</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"device_name"</span><span class="p">).</span><span class="n">as_string</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">baud_rate</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"baud_rate"</span><span class="p">).</span><span class="n">as_int</span><span class="p">();</span>

    <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port Node Open!"</span><span class="p">);</span>
    <span class="c1">// 创建串口配置对象</span>
    <span class="c1">// 波特率默认115200；不开启流控制；无奇偶效验；停止位1。</span>
    <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialPortConfig</span> <span class="n">config</span><span class="p">(</span>
        <span class="n">baud_rate</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">FlowControl</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">Parity</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">StopBits</span><span class="o">::</span><span class="n">ONE</span><span class="p">);</span>

    <span class="c1">// 初始化串口</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">io_context_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="c1">// 初始化 serial_driver_</span>
      <span class="n">serial_driver_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">io_context_</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">init_port</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
      <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>

      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port initialized successfully"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Using device: %s"</span><span class="p">,</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Baud_rate: %d"</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">get_baud_rate</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Failed to initialize serial port: %s"</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//串口发布方</span>
    <span class="n">odom_pub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">nav_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Odometry</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"odom"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>

    <span class="c1">//初始化tf广播器</span>
    <span class="n">tf_broadcaster_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformBroadcaster</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

    <span class="c1">//初始化cmd_vel消息订阅</span>
    <span class="n">cmd_vel_sub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"cmd_vel"</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Odom_KC_Node</span><span class="o">::</span><span class="n">cmd_vel_sub_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>

    <span class="n">async_receive_message</span><span class="p">();</span>   <span class="c1">//进入异步接收</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span> <span class="n">serial_driver_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span> <span class="n">io_context_</span><span class="p">;</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">nav_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Odometry</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">odom_pub_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformBroadcaster</span><span class="o">&gt;</span> <span class="n">tf_broadcaster_</span><span class="p">;</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">cmd_vel_sub_</span><span class="p">;</span>

  <span class="c1">// // 四个轮子的速度(对应单片机的顺序)（单位：rpm）</span>
  <span class="c1">// fp32 received_encoder_wheel_velocities_[4] = {0.0, 0.0, 0.0, 0.0};</span>
  <span class="c1">// // 四个轮子的速度(对应单片机的顺序)（单位：m/s）</span>
  <span class="c1">// fp32 encoder_wheel_velocities_[4] = {0.0, 0.0, 0.0, 0.0};  </span>

  <span class="c1">// // 四个轮子的速度(对应单片机的顺序)（单位：2000pc）</span>
  <span class="c1">// fp32 received_encoder_wheel_angle_[4] = {0.0, 0.0, 0.0, 0.0};</span>

  <span class="c1">//麦克纳姆轮底盘参数</span>
  <span class="k">const</span> <span class="n">fp32</span> <span class="n">wheel_spacing</span> <span class="o">=</span> <span class="mf">0.093</span><span class="p">;</span> <span class="c1">// 轮间距（单位：米）</span>
  <span class="k">const</span> <span class="n">fp32</span> <span class="n">alex_spacing</span> <span class="o">=</span> <span class="mf">0.085</span><span class="p">;</span> <span class="c1">// 轮距（单位：米）</span>
  <span class="k">const</span> <span class="n">fp32</span> <span class="n">wheel_radius_</span> <span class="o">=</span> <span class="mf">0.0375</span><span class="p">;</span> <span class="c1">// 轮子半径（单位：米）</span>

  <span class="n">fp32</span> <span class="n">vy</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">vx</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">vw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
  <span class="n">fp32</span> <span class="n">yaw_</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// 机器人航向角（单位：弧度）</span>
  <span class="n">fp32</span> <span class="n">dt_</span><span class="p">;</span>

  <span class="n">fp32</span> <span class="n">x_position_</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// x位置</span>
  <span class="n">fp32</span> <span class="n">y_position_</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// y位置</span>

  <span class="kt">void</span> <span class="nf">async_receive_message</span><span class="p">()</span>  <span class="c1">//创建一个函数更方便重新调用</span>
  <span class="p">{</span>
    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="c1">// 设置接收回调函数</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">async_receive</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="k">const</span> <span class="kt">size_t</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="c1">//创建odom消息类型</span>
      <span class="k">auto</span> <span class="n">odom_msg</span> <span class="o">=</span> <span class="n">nav_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Odometry</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span><span class="kt">int16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">size</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="kt">uint8_t</span> <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="c1">// 处理接收到的数据</span>
            <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">Data_Analysis</span><span class="p">(</span>
              <span class="o">&amp;</span><span class="n">data_buffer</span><span class="p">,</span>
              <span class="mh">0x01</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">8</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="c1">//由于在ROS2中，node是局部变量，所以发布方只能在node类里，故Data_Apply不写任何东西，直接在接收下面的回调函数里实现功能。</span>
          <span class="k">if</span><span class="p">(</span><span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"以下是电机编码器的odom数据："</span><span class="p">);</span>

            <span class="c1">// // 存储电机速度数据</span>
            <span class="c1">// received_encoder_wheel_velocities_[0] = serial_pack_.rx.data.fp32_buffer[0];  // 电机 0 速度</span>
            <span class="c1">// received_encoder_wheel_velocities_[1] = serial_pack_.rx.data.fp32_buffer[1];  // 电机 1 速度</span>
            <span class="c1">// received_encoder_wheel_velocities_[2] = serial_pack_.rx.data.fp32_buffer[2];  // 电机 2 速度</span>
            <span class="c1">// received_encoder_wheel_velocities_[3] = serial_pack_.rx.data.fp32_buffer[3];  // 电机 3 速度</span>

            <span class="c1">// // 存储电机位置数据</span>
            <span class="c1">// received_encoder_wheel_angle_[0] = serial_pack_.rx.data.fp32_buffer[4];  // 电机 0 位置</span>
            <span class="c1">// received_encoder_wheel_angle_[1] = serial_pack_.rx.data.fp32_buffer[5];  // 电机 1 位置</span>
            <span class="c1">// received_encoder_wheel_angle_[2] = serial_pack_.rx.data.fp32_buffer[6];  // 电机 2 位置</span>
            <span class="c1">// received_encoder_wheel_angle_[3] = serial_pack_.rx.data.fp32_buffer[7];  // 电机 3 位置</span>

            <span class="c1">// vx = serial_pack_.rx.data.fp32_buffer[8];</span>
            <span class="c1">// vy = serial_pack_.rx.data.fp32_buffer[9];</span>
            <span class="c1">// vw = serial_pack_.rx.data.fp32_buffer[10];</span>
            <span class="c1">// yaw_ = serial_pack_.rx.data.fp32_buffer[11];</span>
            <span class="c1">// dt_ = serial_pack_.rx.data.fp32_buffer[12];</span>
            <span class="c1">// x_position_ = serial_pack_.rx.data.fp32_buffer[13];</span>
            <span class="c1">// y_position_ = serial_pack_.rx.data.fp32_buffer[14];</span>

            <span class="n">vx</span> <span class="o">=</span> <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">vw</span> <span class="o">=</span> <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="n">yaw_</span> <span class="o">=</span> <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
            <span class="n">dt_</span> <span class="o">=</span> <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
            <span class="n">x_position_</span> <span class="o">=</span> <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
            <span class="n">y_position_</span> <span class="o">=</span> <span class="n">serial_pack_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

            <span class="c1">// 打印电机速度和位置（角度）</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="c1">// RCLCPP_DEBUG(this-&gt;get_logger(), "%d号电机的速度: %.6f RPM, 位置: %.6f (2000pc)",</span>
                <span class="c1">//             i, received_encoder_wheel_velocities_[i], received_encoder_wheel_angle_[i]);</span>

                <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"线速度:x:%.6f,y:%.6f,z:%.6f"</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">,</span><span class="mf">0.0f</span><span class="p">);</span>
                <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"角速度:x:%.6f,y:%.6f,z:%.6f"</span><span class="p">,</span><span class="mf">0.0f</span><span class="p">,</span><span class="mf">0.0f</span><span class="p">,</span><span class="n">vw</span><span class="p">);</span>
                <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"欧拉角(逆正顺负):r:%.6f,p:%.6f,y:%.6f"</span><span class="p">,</span><span class="mf">0.0f</span><span class="p">,</span><span class="mf">0.0f</span><span class="p">,</span><span class="n">yaw_</span><span class="p">);</span>
                <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"积分间隔:%.6f"</span><span class="p">,</span><span class="n">dt_</span><span class="p">);</span>
                <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"右手坐标系X坐标(前正后负):%.6f"</span><span class="p">,</span><span class="n">x_position_</span><span class="p">);</span>
                <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"右手坐标系Y坐标(左正右负):%.6f"</span><span class="p">,</span><span class="n">y_position_</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">//时间戳</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>

            <span class="c1">//位姿信息所参考的坐标系</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">"odom"</span><span class="p">;</span>

            <span class="c1">// 设置child_frame_id（底盘坐标系）</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="s">"base_link"</span><span class="p">;</span>  <span class="c1">// 设置子坐标系为机器人底盘坐标系</span>

            <span class="c1">//DOF平动位置</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_position_</span><span class="p">;</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y_position_</span><span class="p">;</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

            <span class="c1">//从欧拉角转换为四元数</span>
            <span class="n">tf2</span><span class="o">::</span><span class="n">Quaternion</span> <span class="n">q</span><span class="p">;</span>
            <span class="n">q</span><span class="p">.</span><span class="n">setRPY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">yaw_</span><span class="p">);</span>
            <span class="c1">//DOF转动（四元数）</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">();</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">();</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">w</span><span class="p">();</span>

            <span class="c1">//线速度</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">vx</span><span class="p">;</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">vy</span><span class="p">;</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

            <span class="c1">//角速度</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">vw</span><span class="p">;</span>

            <span class="c1">// 发布消息</span>
            <span class="n">odom_pub_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">odom_msg</span><span class="p">);</span>

            <span class="c1">// 打印位置（XYZ）</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span>
              <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span>
              <span class="s">"位置Position(XYZ): %.6f, %.6f, %.6f"</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span>
            <span class="p">);</span>

            <span class="c1">// 打印姿态（四元数WXYZ）</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span>
              <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span>
              <span class="s">"姿态Orientation(WXYZ): %.6f, %.6f, %.6f, %.6f"</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span><span class="p">,</span>  <span class="c1">// 注意顺序：WXYZ</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span>
            <span class="p">);</span>

            <span class="c1">// 打印姿态（欧拉角RPY）</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span>
              <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span>
              <span class="s">"欧拉角Euler(RPY): %.6f, %.6f, %.6f"</span><span class="p">,</span>
              <span class="mf">0.0</span><span class="p">,</span>
              <span class="mf">0.0</span><span class="p">,</span>
              <span class="n">yaw_</span>
            <span class="p">);</span>

            <span class="c1">// 打印线速度（XYZ）</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span>
              <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span>
              <span class="s">"线速度LinearVel(XYZ): %.6f, %.6f, %.6f"</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span>
            <span class="p">);</span>

            <span class="c1">// 打印角速度（XYZ）</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span>
              <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span>
              <span class="s">"角速度AngularVel(XYZ): %.6f, %.6f, %.6f"</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
              <span class="n">odom_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span>
            <span class="p">);</span>

            <span class="cm">/* 接下来发布tf */</span>
            <span class="k">auto</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">TransformStamped</span><span class="p">();</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">odom_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">;</span> <span class="c1">// 时间戳与odom同步</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">"odom"</span><span class="p">;</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="s">"base_link"</span><span class="p">;</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_position_</span><span class="p">;</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y_position_</span><span class="p">;</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">odom_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">;</span> <span class="c1">// 复用四元数</span>
            <span class="n">tf_broadcaster_</span><span class="o">-&gt;</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">}</span>
        <span class="c1">// 继续监听新的数据</span>
        <span class="n">async_receive_message</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">cmd_vel_sub_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span> <span class="o">&amp;</span><span class="n">cmd_msg</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// bool bool_buffer[] = {1, 0, 1, 0};</span>
    <span class="c1">// int8_t int8_buffer[] = {0x11,0x22};</span>
    <span class="c1">// int16_t int16_buffer[] = {2000,6666};</span>
    <span class="c1">// int32_t int32_buffer[] = {305419896};</span>
    <span class="n">fp32</span> <span class="n">fp32_buffer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>

    <span class="c1">//由于ROS2中node为局部变量，所以只能在node中调用send函数，所以Serial_Transmit只负责处理data_buffer。</span>
    <span class="n">serial_pack_</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">Data_Pack</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> 
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="n">fp32_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp32_buffer</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp32</span><span class="p">));</span>

    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="k">try</span>
    <span class="p">{</span>
      <span class="kt">size_t</span> <span class="n">bytes_size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">tx_data_buffer</span><span class="p">);</span>

      <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"平动XYZ：%.6f,%.6f,%.6f"</span><span class="p">,</span> <span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"转动XYZ：%.6f,%.6f,%.6f"</span><span class="p">,</span> <span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
      <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"(%ld bytes)"</span><span class="p">,</span> <span class="n">bytes_size</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Error Transmiting from serial port:%s"</span><span class="p">,</span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Odom_KC_Node</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1799.webp" alt="" /></p>

<p>最终odom有效数据应该在250Hz左右,4ms发布一次,对于导航也是完全够用的.</p>

<h3 id="惯性计imu-1">惯性计IMU</h3>

<h4 id="简介-4">简介</h4>

<p><strong>概念</strong></p>

<p>IMU是惯性测量单元（Inertial Measurement Unit）的缩写，它是一种集成了多个惯性传感器如加速度计、陀螺仪、磁力计等的导航传感器。IMU可以实时地测量和记录其所在物体的加速度、角速度和方向等信息，并通过信号处理和数学模型来计算出物体的姿态、位置和运动状态等。</p>

<p>IMU（惯性测量单元）主要由以下几种类型组成：</p>

<ol>
  <li>
    <p>加速度计（Accelerometer）：用于测量物体的加速度，通常以三个轴向（X、Y、Z）提供加速度数据。加速度计可以帮助判断物体的线性运动和动作姿态变化。</p>
  </li>
  <li>
    <p>陀螺仪（Gyroscope）：用于测量物体的角速度或角度变化率。陀螺仪可以提供关于物体旋转的信息，判断物体的角度、方向和转动动作。</p>
  </li>
  <li>
    <p>磁力计（Magnetometer）：用于测量物体周围的磁场强度和方向（即测量场强）。磁力计可以帮助判断物体的方向和导航，尤其在地磁定位和航向控制中起重要作用。</p>
  </li>
</ol>

<p>这些传感器通常集成在一起形成IMU，并通过数据融合算法将它们的输出结合起来，提供综合的姿态、位置和运动信息。</p>

<p><strong>作用</strong></p>

<p>IMU是一种重要的传感器组件，它在姿态感知、行驶状态监测、非GPS定位中发挥着重要的作用。</p>

<p><strong>特点</strong></p>

<p>惯性测量单元（IMU）作为一种常见的传感器，在机器人领域中也有许多应用，下面是IMU在机器人领域的一些优点和缺点：</p>

<p>（1）优点：</p>

<ul>
  <li>
    <p><strong>实时性高：</strong> IMU能够以很高的采样频率获取姿态和加速度数据，提供实时的运动信息。</p>
  </li>
  <li>
    <p><strong>精度较高：</strong> IMU可以测量物体的加速度和角速度，经过合成和滤波处理后，可提供较高精度的姿态估计和运动跟踪。</p>
  </li>
  <li>
    <p><strong>不受光照条件限制：</strong> IMU不依赖于光照条件，适用于各种环境，如室内、室外和低光条件。</p>
  </li>
  <li>
    <p><strong>尺寸小巧：</strong> IMU通常具有小型、轻量级和紧凑的设计，适合嵌入式系统和对空间要求较高的机器人平台。</p>
  </li>
  <li>
    <p><strong>低功耗：</strong> IMU的功耗相对较低，适合资源受限或需要长时间运行的应用。</p>
  </li>
</ul>

<p>（2）缺点：</p>

<ul>
  <li>
    <p><strong>累积误差：</strong> 由于积分计算的误差会随时间累积，IMU的姿态估计随着时间推移可能会出现漂移，需要与其他传感器进行融合或采用校准方法进行补偿。</p>
  </li>
  <li>
    <p><strong>受外部干扰影响：</strong> IMU的测量结果容易受到振动、震动和温度变化等外界干扰的影响，可能导致姿态估计不稳定或不准确。</p>
  </li>
  <li>
    <p><strong>不适用于绝对定位：</strong> 单独使用IMU无法提供物体的绝对位置信息，需要结合其他传感器（如GNSS）来实现绝对定位。</p>
  </li>
  <li>
    <p><strong>无法感知环境信息：</strong> IMU只能提供自身的加速度和角速度数据，无法直接感知环境或检测周围物体。</p>
  </li>
</ul>

<p>综上所述，IMU在机器人领域具有实时性高、精度较高、不受光照条件限制、尺寸小巧和低功耗等优点。然而，它也存在累积误差、受外部干扰影响、不适用于绝对定位和无法感知环境信息等缺点。因此，在设计机器人系统时需综合考虑应用需求，并与其他传感器（如相机、激光雷达等）进行融合，以提升机器人的感知、定位和控制能力。</p>

<h4 id="消息接口-1">消息接口</h4>

<p>在ROS2中imu消息被封装为了<code class="language-plaintext highlighter-rouge">sensor_msgs/msg/Imu</code>接口，可通过指令<code class="language-plaintext highlighter-rouge">ros2 interface show sensor_msgs/msg/Imu</code>查看该接口的具体数据结构，结果如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre>
<span class="c"># 这是一个从惯性测量单元（Inertial Measurement Unit，简称IMU）获取数据的消息。</span>
<span class="c">#</span>

<span class="c"># 加速度应该以米/秒^2为单位（不是以g为单位），旋转速度应该以弧度/秒为单位。</span>
<span class="c">#</span>

<span class="c"># 如果测量的协方差已知，则应该填写相应值。全零的协方差矩阵将被解释为“协方差未知”，必须从其他源获取协方差才能使用协方差数据。</span>
<span class="c">#</span>

<span class="c"># 如果没有其中一个数据元素的估计值（例如，你的IMU不会产生方向估计），请将相关协方差矩阵的第 0 个元素设置为 -1。</span>

<span class="c"># 如果你正在解析此消息，请检查每个协方差矩阵的第一个元素中是否有 -1 的值，并忽略相关的估计值。</span>

std_msgs/Header header <span class="c"># 标头</span>
    builtin_interfaces/Time stamp <span class="c"># 时间戳</span>
        int32 sec
        uint32 nanosec
    string frame_id <span class="c"># imu坐标系</span>

geometry_msgs/Quaternion orientation <span class="c"># 四元数姿态</span>
    float64 x 0
    float64 y 0
    float64 z 0
    float64 w 1
float64[9] orientation_covariance <span class="c"># 姿态协方差矩阵</span>

geometry_msgs/Vector3 angular_velocity <span class="c"># 三轴角速度</span>
    float64 x
    float64 y
    float64 z
float64[9] angular_velocity_covariance <span class="c"># 角速度协方差矩阵</span>

geometry_msgs/Vector3 linear_acceleration <span class="c"># 三轴线性加速度</span>
    float64 x
    float64 y
    float64 z
float64[9] linear_acceleration_covariance <span class="c"># 线性加速度协方差矩阵</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="功能包创建-1">功能包创建</h4>

<p>首先先创建功能包</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create imu_plumb <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp sensor_msgs <span class="nt">--node-name</span> imu_node
</pre></td></tr></tbody></table></code></pre></div></div>

<p>先编译一下</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--cmake-args</span> <span class="nt">-DCMAKE_EXPORT_COMPILE_COMMANDS</span><span class="o">=</span>ON
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="节点主要逻辑-1">节点主要逻辑</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"serial_driver/serial_driver.hpp"</span><span class="cp">
#include</span> <span class="cpf">"cyber_imu/WitStandardProtocol.h"</span><span class="cp">
#include</span> <span class="cpf">"sensor_msgs/msg/imu.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdint&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;rclcpp/logging.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sensor_msgs/msg/detail/imu__struct.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tf2/LinearMath/Quaternion.h&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ImuNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">ImuNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"ImuNode_node_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"惯性计imu节点启动!"</span><span class="p">);</span>

      <span class="c1">//创建odom话题通信发布方</span>
      <span class="n">imu_pub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Imu</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"/imu"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>

    <span class="c1">// 声明参数（带默认值）</span>
    <span class="c1">// 串口默认设备名（根据实际设备调整）</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">"device_name"</span><span class="p">,</span> <span class="s">"/dev/ttyUSB0"</span><span class="p">);</span>
    <span class="c1">//串口默认波特率</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">"baud_rate"</span><span class="p">,</span> <span class="mi">115200</span><span class="p">);</span>

    <span class="c1">// 获取参数值</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">device_name</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"device_name"</span><span class="p">).</span><span class="n">as_string</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">baud_rate</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"baud_rate"</span><span class="p">).</span><span class="n">as_int</span><span class="p">();</span>

      <span class="c1">// 创建串口配置对象</span>
      <span class="c1">// 波特率默认115200；不开启流控制；无奇偶效验；停止位1。</span>
      <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialPortConfig</span> <span class="n">config</span><span class="p">(</span>
          <span class="n">baud_rate</span><span class="p">,</span>
          <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">FlowControl</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
          <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">Parity</span><span class="o">::</span><span class="n">NONE</span><span class="p">,</span>
          <span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">StopBits</span><span class="o">::</span><span class="n">ONE</span><span class="p">);</span>

      <span class="c1">// 初始化串口</span>
      <span class="k">try</span>
      <span class="p">{</span>
        <span class="n">io_context_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">// 初始化 serial_driver_</span>
        <span class="n">serial_driver_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">io_context_</span><span class="p">);</span>
        <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">init_port</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
        <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>

        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Serial port initialized successfully"</span><span class="p">);</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Using device: %s"</span><span class="p">,</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Baud_rate: %d"</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">get_baud_rate</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Failed to initialize serial port: %s"</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">async_receive_message</span><span class="p">();</span>   <span class="c1">//进入异步接收</span>
    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Imu</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">imu_pub_</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">serial_driver</span><span class="o">::</span><span class="n">SerialDriver</span><span class="o">&gt;</span> <span class="n">serial_driver_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">drivers</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">IoContext</span><span class="o">&gt;</span> <span class="n">io_context_</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">async_receive_message</span><span class="p">()</span>  <span class="c1">//创建一个函数更方便重新调用</span>
    <span class="p">{</span>
      <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

      <span class="c1">// 设置接收回调函数</span>
      <span class="n">port</span><span class="o">-&gt;</span><span class="n">async_receive</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="k">const</span> <span class="kt">size_t</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> 
      <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"以下是接收到的IMU惯性计数据:"</span><span class="p">);</span>
            <span class="c1">//创建imu消息类型</span>
            <span class="k">auto</span> <span class="n">imu_msg</span> <span class="o">=</span> <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Imu</span><span class="p">();</span>
            <span class="kt">bool</span> <span class="n">valid_frame</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// 添加有效帧标志</span>
            <span class="kt">bool</span> <span class="n">valid_data</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// 添加有效帧标志</span>

            <span class="k">for</span><span class="p">(</span><span class="kt">int16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">size</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="kt">uint8_t</span> <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
              <span class="c1">// RCLCPP_INFO(this-&gt;get_logger(),"接收到的字节：%x",data_buffer);</span>
              <span class="c1">// 处理接收到的数据</span>
              <span class="k">if</span><span class="p">(</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">Data_Analysis</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_buffer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">valid_frame</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>  <span class="c1">// 标记有有效帧需要处理</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="n">valid_frame</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x51</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="c1">// 存储加速度计数据</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Temp</span>    <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

                  <span class="c1">//加速度单位m/s2，温度单位℃摄氏度</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">X</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">16.0f</span> <span class="o">*</span> <span class="mf">9.8f</span><span class="p">;</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Y</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">16.0f</span> <span class="o">*</span> <span class="mf">9.8f</span><span class="p">;</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Z</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">16.0f</span> <span class="o">*</span> <span class="mf">9.8f</span><span class="p">;</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Temp</span>    <span class="o">=</span>  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Temp</span> <span class="o">/</span> <span class="mf">100.0f</span><span class="p">;</span>

                  <span class="c1">// 打印加速度计数据</span>
                  <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"加速度(XYZ): %.6f, %.6f, %.6f"</span><span class="p">,</span>
                              <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>
                  <span class="c1">//减少时间戳带来的延迟</span>
                  <span class="n">imu_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x52</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="c1">// 存储陀螺仪数据</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

                  <span class="c1">//角速度单位rad/s</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">X</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">2000.0f</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mf">180.0f</span><span class="p">);</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Y</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">2000.0f</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mf">180.0f</span><span class="p">);</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Z</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">2000.0f</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mf">180.0f</span><span class="p">);</span>

                  <span class="c1">// 打印陀螺仪数据</span>
                  <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"角速度(XYZ): %.6f, %.6f, %.6f"</span><span class="p">,</span>
                              <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x54</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="c1">// 存储磁力计数据(单位lsb)</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Magnet</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Magnet</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Magnet</span><span class="p">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

                  <span class="c1">//磁场单位uT</span>
                  <span class="c1">// wit_imu_.rx.data.imu.Magnet.X = wit_imu_.rx.data.imu.Magnet.X / 1.0f;</span>
                  <span class="c1">// wit_imu_.rx.data.imu.Magnet.Y = wit_imu_.rx.data.imu.Magnet.Y / 1.0f;</span>
                  <span class="c1">// wit_imu_.rx.data.imu.Magnet.Z = wit_imu_.rx.data.imu.Magnet.Z / 1.0f;</span>

                  <span class="c1">// 打印磁力计数据</span>
                  <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"磁场(XYZ): %.6f, %.6f, %.6f"</span><span class="p">,</span>
                              <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Magnet</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Magnet</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Magnet</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x53</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="c1">// 存储欧拉角数据</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">roll</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

                  <span class="c1">//欧拉角单位dec</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">roll</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">roll</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">180.0f</span><span class="p">;</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">pitch</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">180.0f</span><span class="p">;</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">32768.0f</span> <span class="o">*</span> <span class="mf">180.0f</span><span class="p">;</span>

                  <span class="c1">// 打印欧拉角数据</span>
                  <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"欧拉角(XYZ_RPY): %.6f, %.6f, %.6f"</span><span class="p">,</span>
                              <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">roll</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">yaw</span><span class="p">);</span>

                  <span class="c1">//欧拉角单位rad</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">roll</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">roll</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mf">180.0f</span><span class="p">);</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">pitch</span>  <span class="o">*</span> <span class="p">(</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mf">180.0f</span><span class="p">);</span>
                  <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Euler</span><span class="p">.</span><span class="n">yaw</span>  <span class="o">*</span> <span class="p">(</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mf">180.0f</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x59</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="k">for</span><span class="p">(</span><span class="kt">int16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                  <span class="p">{</span>
                    <span class="c1">// 存储四元数数据</span>
                    <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">int16_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

                    <span class="c1">//四元数是归一化的四元数</span>
                    <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">32768.0f</span><span class="p">;</span>
                  <span class="p">}</span>

                  <span class="c1">// 打印四元数数据</span>
                  <span class="c1">//注意，0对应y，1对应x，-2才对应z。</span>
                  <span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"四元数(xyzw): %.6f, %.6f, %.6f, %.6f"</span><span class="p">,</span>
                              <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
                  <span class="n">valid_data</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>   <span class="c1">//跑过一次就进行清0</span>
                <span class="n">valid_frame</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="n">valid_data</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="c1">//时间戳</span>
              <span class="c1">// imu_msg.header.stamp = this-&gt;get_clock()-&gt;now();</span>
              <span class="c1">//位姿信息所参考的坐标系</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">"imu"</span><span class="p">;</span>

              <span class="c1">// tf2::Quaternion q;</span>
              <span class="c1">// //DOF欧拉角单位rad</span>
              <span class="c1">// q.setRPY(roll_, pitch_, yaw_);</span>
              <span class="c1">// //DOF欧拉角（四元数）</span>
              <span class="c1">// imu_msg.orientation.x = q.x();</span>
              <span class="c1">// imu_msg.orientation.y = q.y();</span>
              <span class="c1">// imu_msg.orientation.z = q.z();</span>
              <span class="c1">// imu_msg.orientation.w = q.w();</span>

              <span class="c1">//DOF欧拉角（四元数）</span>
              <span class="c1">//注意对应关系</span>
              <span class="c1">// 传感器坐标系 -&gt; ROS坐标系：</span>
              <span class="c1">// X -&gt; Y</span>
              <span class="c1">// Y -&gt; X</span>
              <span class="c1">// Z -&gt; -Z</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span>   <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span>   <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="o">-</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span>   <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Quat</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

              <span class="c1">//加速度</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Accel</span><span class="p">.</span><span class="n">Z</span><span class="p">;</span>

              <span class="c1">//角速度</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">angular_velocity</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">angular_velocity</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>
              <span class="n">imu_msg</span><span class="p">.</span><span class="n">angular_velocity</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">wit_imu_</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">imu</span><span class="p">.</span><span class="n">Gyro</span><span class="p">.</span><span class="n">Z</span><span class="p">;</span>

              <span class="n">imu_pub_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">imu_msg</span><span class="p">);</span>
              <span class="n">valid_data</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>

          <span class="p">}</span>
          <span class="c1">// 继续监听新的数据</span>
          <span class="n">async_receive_message</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ImuNode</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1800.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1801.webp" alt="" /></p>

<p>这种框架对于一个250Hz（每4ms输出一次）的陀螺仪来说,最后/imu的发布频率是100Hz（每10ms发布一次）,效率也是还可以接受的.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1802.webp" alt="" /></p>

<h3 id="激光雷达lidar">激光雷达LiDAR</h3>

<h3 id="相机camera">相机Camera</h3>

<h3 id="全球定位gnss">全球定位GNSS</h3>

<h3 id="键盘控制节点">键盘控制节点</h3>

<h4 id="简介-5">简介</h4>

<p>要在 ROS2 中使用 <code class="language-plaintext highlighter-rouge">keyboard</code> 节点控制底盘，我们需要实现以下步骤：</p>

<ol>
  <li>
    <p><strong>创建 ROS2 包</strong> 创建一个新的 ROS2 包用于实现键盘控制功能。</p>
  </li>
  <li>
    <p><strong>编写键盘控制节点</strong> 编写一个 C++ 节点，用于监听键盘输入并发布速度命令。</p>
  </li>
  <li>
    <p><strong>与麦轮底盘通信</strong> 将发布的速度命令与底盘控制结合。</p>
  </li>
</ol>

<h4 id="twist消息接口">Twist消息接口</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 interface show geometry_msgs/msg/Twist
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
<span class="c"># This expresses velocity in free space broken into its linear and angular parts.</span>

<span class="c"># 该消息表示自由空间中的速度，分为线速度和角速度两部分。</span>

Vector3  linear
        float64 x  <span class="c"># 线速度的 x 分量（通常表示前后方向的速度）</span>
        float64 y  <span class="c"># 线速度的 y 分量（通常表示左右方向的速度）</span>
        float64 z  <span class="c"># 线速度的 z 分量（通常表示上下方向的速度）</span>

Vector3  angular
        float64 x  <span class="c"># 角速度的 x 分量（绕 x 轴的旋转速度）</span>
        float64 y  <span class="c"># 角速度的 y 分量（绕 y 轴的旋转速度）</span>
        float64 z  <span class="c"># 角速度的 z 分量（绕 z 轴的旋转速度）</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p><strong>线速度（linear）</strong> ：描述物体在三维空间中沿直线运动的速度。通常在移动机器人中：</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">x</code> 表示前进/后退。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">y</code> 表示左右平移。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">z</code> 通常为 0，因为大部分地面机器人只在平面上运动。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>角速度（angular）</strong> ：描述物体在三维空间中绕某一轴旋转的速度。通常在移动机器人中：</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">z</code> 表示绕垂直轴的旋转（顺时针/逆时针）。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">x</code> 和 <code class="language-plaintext highlighter-rouge">y</code> 通常为 0，因为大多数地面机器人只需要在平面上旋转。</p>
      </li>
    </ul>
  </li>
</ul>

<p>这个消息类型广泛用于控制机器人运动，也就是我们常说的DOF自由度，通过发布到 <code class="language-plaintext highlighter-rouge">/cmd_vel</code> 话题，可以为机器人提供运动指令。</p>

<h4 id="发布cmd_vel给单片机">发布cmd_vel给单片机</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="c1">//初始化串口消息订阅</span>
<span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">cmd_vel_sub_</span><span class="p">;</span>
<span class="n">cmd_vel_sub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="p">(</span><span class="s">"cmd_vel"</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Serial_Node</span><span class="o">::</span><span class="n">cmd_vel_sub_callback</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>

  <span class="kt">void</span> <span class="nf">cmd_vel_sub_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span> <span class="o">&amp;</span><span class="n">cmd_msg</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// bool bool_buffer[] = {1, 0, 1, 0};</span>
    <span class="c1">// int8_t int8_buffer[] = {0x11,0x22};</span>
    <span class="c1">// int16_t int16_buffer[] = {2000,6666};</span>
    <span class="c1">// int32_t int32_buffer[] = {305419896};</span>
    <span class="n">fp32</span> <span class="n">fp32_buffer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span><span class="p">,(</span><span class="n">fp32</span><span class="p">)</span><span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>

    <span class="c1">//由于ROS2中node为局部变量，所以只能在node中调用send函数，所以Serial_Transmit只负责处理data_buffer。</span>
    <span class="n">serial_pack_</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">Data_Pack</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> 
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="n">fp32_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp32_buffer</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp32</span><span class="p">));</span>

    <span class="k">auto</span> <span class="n">port</span> <span class="o">=</span> <span class="n">serial_driver_</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">();</span>

    <span class="k">try</span>
    <span class="p">{</span>
      <span class="kt">size_t</span> <span class="n">bytes_size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">data_buffer</span><span class="p">);</span>
      <span class="c1">// RCLCPP_INFO(this-&gt;get_logger(), "Transmitted: ");</span>
      <span class="c1">// for (size_t i = 0; i &lt; data_buffer.size(); ++i) </span>
      <span class="c1">// {</span>
        <span class="c1">// RCLCPP_INFO(this-&gt;get_logger(), "0x%02X ", data_buffer[i]);  //以十六进制格式打印每个字节</span>
      <span class="c1">// }</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"平动XYZ：%.6f,%.6f,%.6f"</span><span class="p">,</span> <span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"转动XYZ：%.6f,%.6f,%.6f"</span><span class="p">,</span> <span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">fp32_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"(%ld bytes)"</span><span class="p">,</span> <span class="n">bytes_size</span><span class="p">);</span>
      <span class="c1">// (void)bytes_size;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Error Transmiting from serial port:%s"</span><span class="p">,</span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>STM32部分代码：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>    <span class="k">case</span> <span class="n">CHASSIS_ROS2_CMD</span><span class="p">:</span> <span class="c1">//ROS2接管模式</span>
        <span class="c1">//单位就是m/s和rad/s</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">oriChassis</span><span class="p">.</span><span class="n">Speed</span><span class="p">.</span><span class="n">vx</span> <span class="o">=</span>   <span class="n">cmd_vel_</span><span class="p">.</span><span class="n">Linear</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">oriChassis</span><span class="p">.</span><span class="n">Speed</span><span class="p">.</span><span class="n">vy</span> <span class="o">=</span>   <span class="n">cmd_vel_</span><span class="p">.</span><span class="n">Linear</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">oriChassis</span><span class="p">.</span><span class="n">Speed</span><span class="p">.</span><span class="n">vw</span> <span class="o">=</span> <span class="o">-</span> <span class="n">cmd_vel_</span><span class="p">.</span><span class="n">Angular</span><span class="p">.</span><span class="n">Z</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>由于我的STM32以Y为底盘前后方向，ROS2以X为底盘前后方向，所以我这里并不是完全对应的。</p>

<h4 id="官方节点">官方节点</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 run teleop_twist_keyboard teleop_twist_keyboard
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">i</code>: 向前移动（增加线速度 <code class="language-plaintext highlighter-rouge">linear.x</code>）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">,</code> <strong>(逗号)</strong> : 向后移动（减少线速度 <code class="language-plaintext highlighter-rouge">linear.x</code>）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">j</code>: 左转（增加角速度 <code class="language-plaintext highlighter-rouge">angular.z</code>，逆时针）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">l</code>: 右转（减少角速度 <code class="language-plaintext highlighter-rouge">angular.z</code>，顺时针）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">k</code>: 紧急停止（将线速度和角速度归零）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">u</code>: 向前左转（组合运动：<code class="language-plaintext highlighter-rouge">linear.x</code> + <code class="language-plaintext highlighter-rouge">angular.z</code>）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">o</code>: 向前右转（组合运动：<code class="language-plaintext highlighter-rouge">linear.x</code> + <code class="language-plaintext highlighter-rouge">angular.z</code>）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">m</code>: 向后左转（组合运动：<code class="language-plaintext highlighter-rouge">-linear.x</code> + <code class="language-plaintext highlighter-rouge">angular.z</code>）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">.</code> <strong>(句号)</strong> : 向后右转（组合运动：<code class="language-plaintext highlighter-rouge">-linear.x</code> + <code class="language-plaintext highlighter-rouge">angular.z</code>）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">w</code><strong>/</strong><code class="language-plaintext highlighter-rouge">x</code>: 增加/减少 <strong>线速度</strong> （<code class="language-plaintext highlighter-rouge">linear.x</code> 的增量步长）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">a</code><strong>/</strong><code class="language-plaintext highlighter-rouge">d</code>: 增加/减少 <strong>角速度</strong> （<code class="language-plaintext highlighter-rouge">angular.z</code> 的增量步长）</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">s</code><strong>/</strong><code class="language-plaintext highlighter-rouge">S</code>: 紧急停止（将线速度和角速度归零）</p>
  </li>
</ul>

<p>建议可以使用官方的节点。记得跑之前，先将步长降低。</p>

<h4 id="自定义节点">自定义节点</h4>

<h5 id="功能包创建-2">功能包创建</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 pkg create cyber_teleop_twist_keyboard <span class="nt">--build-type</span> ament_cmake <span class="nt">--dependencies</span> rclcpp geometry_msgs <span class="nt">--node-name</span> teleop_twist_keyboard
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="节点主逻辑">节点主逻辑</h5>

<p><code class="language-plaintext highlighter-rouge">w/s/a/d</code>：控制机器人前进/后退/左平移/右平移。</p>

<p><code class="language-plaintext highlighter-rouge">q/e</code>：控制机器人逆时针/顺时针旋转。</p>

<p><code class="language-plaintext highlighter-rouge">i/,</code>：调整线速度步长（加速/减速步长）。</p>

<p><code class="language-plaintext highlighter-rouge">j/l</code>：调整角速度步长（减速/加速步长）。</p>

<p><code class="language-plaintext highlighter-rouge">k</code>：停止所有运动。</p>

<p>下方是一个核心函数，用于检测按键。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span>
    <span class="c1">//查键盘输入的函数，它不需要按回车就能返回键盘输入。它通过修改终端设置，使得可以直接获取按键的值。</span>
    <span class="kt">int</span> <span class="nf">kbhit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">struct</span> <span class="nc">termios</span> <span class="n">oldt</span><span class="p">,</span> <span class="n">newt</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">oldf</span><span class="p">;</span>

      <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldt</span><span class="p">);</span>        <span class="c1">// 获取当前终端的设置</span>
      <span class="n">newt</span> <span class="o">=</span> <span class="n">oldt</span><span class="p">;</span>
      <span class="n">newt</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICANON</span> <span class="o">|</span> <span class="n">ECHO</span><span class="p">);</span>       <span class="c1">// 禁用缓冲模式和回显</span>
      <span class="n">newt</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">newt</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newt</span><span class="p">);</span> <span class="c1">// 设置新的终端设置</span>

      <span class="n">oldf</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">fcntl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">oldf</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span> <span class="c1">// 设置为非阻塞模式</span>

      <span class="n">ch</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span> <span class="c1">// 获取字符</span>
      <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldt</span><span class="p">);</span>   <span class="c1">// 恢复终端设置</span>
      <span class="n">fcntl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">oldf</span><span class="p">);</span>         <span class="c1">// 恢复文件描述符设置</span>

      <span class="k">if</span><span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span> 
          <span class="n">ungetc</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>  <span class="c1">// 将字符放回标准输入流</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>           <span class="c1">// 如果读取了字符，返回 1</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// 没有读取到字符</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以下代码未经验证，谨慎使用，本人直接采用了官方的节点，并未使用自定义节点。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="cp">
#include</span> <span class="cpf">"geometry_msgs/msg/twist.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;geometry_msgs/msg/detail/twist__struct.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"cyber_teleop_twist_keyboard/struct_typedef.h"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">TeleopTwistKeyboardNode</span><span class="o">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">TeleopTwistKeyboardNode</span><span class="p">()</span><span class="o">:</span><span class="n">Node</span><span class="p">(</span><span class="s">"CyberTeleopTwistKeyboardNode_cpp"</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"TeleopTwistKeyboardNode Running!"</span><span class="p">);</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"键盘控制机器人节点已启动！"</span><span class="p">);</span>
      <span class="c1">// 创建一个发布者，类型是 geometry_msgs/msg/Twist，发布到 "cmd_vel" 话题</span>
      <span class="n">keyboard_control_pub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"cmd_vel"</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

      <span class="c1">// 定时器，周期性调用发布函数</span>
      <span class="n">keyboard_control_pub_timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span>
          <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> 
          <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TeleopTwistKeyboardNode</span><span class="o">::</span><span class="n">cmd_vel_publish_timer_callback</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">keyboard_control_pub_</span><span class="p">;</span>
    <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">keyboard_control_pub_timer_</span><span class="p">;</span>

    <span class="c1">// 步长</span>
    <span class="n">fp64</span> <span class="n">linear_step_</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
    <span class="n">fp64</span> <span class="n">angular_step_</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>

    <span class="c1">// 当前线速度和角速度</span>
    <span class="n">fp64</span> <span class="n">linear_speed_</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">fp64</span> <span class="n">angular_speed_</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="c1">// 最大速度限制</span>
    <span class="n">fp64</span> <span class="n">max_linear_speed_</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">fp64</span> <span class="n">max_angular_speed_</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>

    <span class="c1">// 最小速度限制</span>
    <span class="n">fp64</span> <span class="n">min_linear_speed_</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">fp64</span> <span class="n">min_angular_speed_</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span> <span class="n">cmd_msg</span><span class="p">;</span>

    <span class="c1">//查键盘输入的函数，它不需要按回车就能返回键盘输入。它通过修改终端设置，使得可以直接获取按键的值。</span>
    <span class="kt">int</span> <span class="nf">kbhit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">struct</span> <span class="nc">termios</span> <span class="n">oldt</span><span class="p">,</span> <span class="n">newt</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">oldf</span><span class="p">;</span>

      <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldt</span><span class="p">);</span>        <span class="c1">// 获取当前终端的设置</span>
      <span class="n">newt</span> <span class="o">=</span> <span class="n">oldt</span><span class="p">;</span>
      <span class="n">newt</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICANON</span> <span class="o">|</span> <span class="n">ECHO</span><span class="p">);</span>       <span class="c1">// 禁用缓冲模式和回显</span>
      <span class="n">newt</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">newt</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newt</span><span class="p">);</span> <span class="c1">// 设置新的终端设置</span>

      <span class="n">oldf</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">fcntl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">oldf</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span> <span class="c1">// 设置为非阻塞模式</span>

      <span class="n">ch</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span> <span class="c1">// 获取字符</span>
      <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldt</span><span class="p">);</span>   <span class="c1">// 恢复终端设置</span>
      <span class="n">fcntl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">oldf</span><span class="p">);</span>         <span class="c1">// 恢复文件描述符设置</span>

      <span class="k">if</span><span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span> 
          <span class="n">ungetc</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>  <span class="c1">// 将字符放回标准输入流</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>           <span class="c1">// 如果读取了字符，返回 1</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// 没有读取到字符</span>
    <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">cmd_vel_publish_timer_callback</span><span class="p">()</span>
  <span class="p">{</span>

    <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="c1">// 当有键盘输入时，处理它</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kbhit</span><span class="p">())</span> 
    <span class="p">{</span>
      <span class="kt">char</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>  <span class="c1">// 获取键盘输入的字符</span>

      <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="s">"按下了:%c"</span><span class="p">,</span><span class="n">key</span><span class="p">);</span>
      <span class="c1">// 根据按键决定机器人运动方向</span>
      <span class="k">switch</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">case</span> <span class="sc">'w'</span><span class="p">:</span> <span class="c1">// 前进</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">linear_speed_</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'s'</span><span class="p">:</span> <span class="c1">// 后退</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span> <span class="n">linear_speed_</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'a'</span><span class="p">:</span> <span class="c1">// 左平移</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span> <span class="n">linear_speed_</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'d'</span><span class="p">:</span> <span class="c1">// 右平移</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">linear_speed_</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'q'</span><span class="p">:</span> <span class="c1">// 逆时针旋转</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="o">-</span> <span class="n">angular_speed_</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'e'</span><span class="p">:</span> <span class="c1">// 顺时针旋转</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">angular_speed_</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'i'</span><span class="p">:</span> <span class="c1">// 增加线速度</span>
          <span class="n">linear_speed_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">linear_speed_</span> <span class="o">+</span> <span class="n">linear_step_</span><span class="p">,</span> <span class="n">min_linear_speed_</span><span class="p">,</span> <span class="n">max_linear_speed_</span><span class="p">);</span>
          <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Linear increased to: %.2f"</span><span class="p">,</span> <span class="n">linear_speed_</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">','</span><span class="p">:</span> <span class="c1">// 减小线速度</span>
          <span class="n">linear_speed_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">linear_speed_</span> <span class="o">-</span> <span class="n">linear_step_</span><span class="p">,</span> <span class="n">min_linear_speed_</span><span class="p">,</span> <span class="n">max_linear_speed_</span><span class="p">);</span>
          <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Linear decreased to: %.2f"</span><span class="p">,</span> <span class="n">linear_speed_</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'l'</span><span class="p">:</span> <span class="c1">// 增加角速度</span>
          <span class="n">angular_speed_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">angular_speed_</span> <span class="o">+</span> <span class="n">angular_step_</span><span class="p">,</span> <span class="n">min_angular_speed_</span><span class="p">,</span> <span class="n">max_angular_speed_</span><span class="p">);</span>
          <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Angular increased to: %.2f"</span><span class="p">,</span> <span class="n">angular_speed_</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'j'</span><span class="p">:</span> <span class="c1">// 减小角速度</span>
          <span class="n">angular_speed_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">angular_speed_</span> <span class="o">-</span> <span class="n">angular_step_</span><span class="p">,</span> <span class="n">min_angular_speed_</span><span class="p">,</span> <span class="n">max_angular_speed_</span><span class="p">);</span>
          <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Angular decreased to: %.2f"</span><span class="p">,</span> <span class="n">angular_speed_</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'k'</span><span class="p">:</span> <span class="c1">// 停止</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="n">cmd_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
          <span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s">"Unknown key pressed!"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">keyboard_control_pub_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">cmd_msg</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">node</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">TeleopTwistKeyboardNode</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="坐标系与话题关系">坐标系与话题关系</h2>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1803.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1804.webp" alt="" /></p>

<p><strong>odom坐标系</strong> 不是固定不动的，原点是机器人的初始位置。</p>

<p><strong>base_link坐标系</strong> 是机器人本体的坐标系，固定在机器人中心（如底盘）。当机器人移动时，/odom话题发布机器人运动数据，base_link坐标系会相对于odom坐标系移动。</p>

<p><strong>laser_link和imu_link等坐标系</strong> 和base_link之间的位置是静态的，所以当base_link移动了，其他子坐标系也会跟随移动。</p>

<p>odom坐标系是根据机器人电机编码器或者里程计反馈回来的数据预估的机器人出发时的位置，一般都会浮动。</p>

<p>map坐标系是通过算法用激光雷达等传感器预估出来的机器人出发时的位置。</p>

<p>但是由于建议使用树形TF，所以我们通常将map坐标系作为根坐标系，所以此时map在rviz2里是不动的，odom作为map坐标系的下行坐标系。（可以听一下赵老师ROS1的课程，这里讲的很好）</p>

<h2 id="硬件平台进阶">硬件平台进阶</h2>

<h3 id="轮式里程计标定与融合">轮式里程计标定与融合</h3>

<p><strong>场景</strong></p>

<p>里程计在ROS中扮演着重要的角色，能够为机器人的定位、路径规划和运动控制等任务提供重要的数据支持。然而在实际应用中，里程计并不能准确地反映机器人的位置和运动状态，出现的问题包括：</p>

<blockquote>
  <p>1.里程计中的线速度、角速度和机器人实际的线速度、角速度明显有差异，而且里程计中提供的机器人位姿与真实位姿不一致；</p>

  <p>2.当机器人车轮打滑或受到外力影响而出现姿态改变时，这种姿态的变化无法通过轮式里程计正确反馈。</p>
</blockquote>

<p>在这些场景中，我们可以通过进行里程计标定和融合来优化解决这些问题。</p>

<p><strong>概念</strong></p>

<p><strong>里程计标定：</strong> 里程计标定是指通过对机器人里程计进行精确的校准和调整，以减小或消除里程计测量中的误差和不准确性。例如，可以通过测量调整轮胎直径和轴距等参数来校准机器人的线速度和角速度，从而使里程计测量结果更加准确。里程计标定的主要目标是确保里程计测量结果与实际机器人的运动轨迹一致，从而提高机器人的定位精度和路径规划准确性。</p>

<p><strong>里程计融合：</strong> 里程计融合是利用多个来源的里程计数据进行融合，以获得更准确可靠的机器人定位和运动信息。例如，将车轮编码器和惯性测量单元（IMU）的数据融合，可以提高定位的准确性。通过结合不同的传感器和算法，能够提高机器人在导航和控制任务中的准确性和鲁棒性，从而实现更高级别的自主移动能力。</p>

<p><strong>作用</strong></p>

<p>里程计标定和融合是机器人领域中的两个重要技术，通过利用这些技术，机器人可以更加准确地了解自身位置和运动状态，提高机器人的定位和导航精度，为机器人的自主导航、路径规划等任务提供基础。</p>

<h4 id="轮式里程计标定">轮式里程计标定</h4>

<p>轮式里程计标定是校准机器人轮子的旋转和移动，以提供机器人运动中的准确位置和姿态信息的方法。通过标定，可以修正因轮子尺寸和轮距等因素引起的误差，获得更准确的运动轨迹。本节将以MyCar导航机器人为例演示标定过程，其标定步骤如下：</p>

<ol>
  <li>
    <p>准备测量场地；</p>
  </li>
  <li>
    <p>线性位移标定；</p>
  </li>
  <li>
    <p>转角位移标定；</p>
  </li>
  <li>
    <p>验证和调整。</p>
  </li>
</ol>

<p>另外，该过程还需要使用尺子作为测量工具。</p>

<p><strong>1.准备测量场地</strong></p>

<p>选择一个开放而平坦的区域，确保没有障碍物和其他干扰因素。</p>

<p><strong>2.线性位移标定</strong></p>

<p>线性位移标定是用来标定机器人在直线移动时行进的距离。该标定与车轮直径参数密切相关，当车轮直径测量不准确或轮胎磨损时，会导致轮式里程计的线性位移出现误差。以下是线性位移标定的主要步骤：</p>

<p><strong>（1）实际数据采集</strong></p>

<p>启动机器人底盘和键盘控制节点，使用键盘控制机器人向前直线运动一段距离，并测量线性位移数据。</p>

<p><strong>（2）里程计消息采集</strong></p>

<p>机器人停止后，输出里程计消息，并获取里程计消息中的机器人的位移数据。</p>

<p><strong>（3）参数计算以及修改</strong></p>

<p>收集实际位移数据（w1）和里程计消息中的位移数据（w2），并结合驱动包配置文件中的原轮胎直径值（d1），即可计算修正后的轮胎直径值（d）。计算公式如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">/</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">d1</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>将计算出的结果写入 MyCar 机器人的配置文件对应的参数，并重新构建。</p>

<p>为了获得最佳结果，可以多次执行上述流程。每次执行后，测量并记录新的实际位移数据（w1）和里程计消息中的位移数据（w2），然后根据新的数据再次计算修正后的轮胎直径值（d）。不断迭代这个过程，可以逐步优化轮胎直径的估计值，减小里程计的线性位移误差。</p>

<p><em>小提示：</em></p>

<blockquote>
  <p>如果使用的是以Arduino为主控的MyCar两轮差速机器人，那么需要修改ros2_arduino_bridge功能包下的params/arduino.yaml文件，该文件中有一个名为wheel_diameter参数即为车轮直径；</p>

  <p>如果使用的是以Stm32为主控的MyCar两轮差速机器人，那么需要修改ros2_stm32_bridge功能包下的params/stm32_2w.yaml文件，该文件中有一个名为wheel_diameter参数即为车轮直径；</p>

  <p>如果使用的是以Stm32为主控的MyCar四轮差速机器人，那么需要修改ros2_stm32_bridge功能包下的params/stm32_4w.yaml文件，该文件中有一个名为wheel_diameter参数即为车轮直径。</p>
</blockquote>

<p><strong>3.转角位移标定</strong></p>

<p>转角位移标定是用来标定机器人在转弯时的角度变化。该标定与底盘的旋转半径参数密切相关，当旋转半径设置不当时，会导致转角位移的测量误差。另外需要注意的是，如果是两轮差速机器人，那么旋转半径和轮间距基本一致。这是因为两轮差速机器人在旋转时没有造成车体的侧滑运动，所以可以使用轮间距来计算旋转角度，并且旋转半径可以近似等于轮间距。然而，对于四轮差速机器人，在旋转时会产生侧滑，轮间距无法直接用于计算旋转角度。四轮差速机器人的旋转半径需要通过实验获取，因为它的旋转半径受到侧滑运动的影响。此外，由于机器人的左右侧轮胎差异或车辆重心偏移等原因，左旋转和右旋转时计算旋转角度所使用的旋转半径可能不同，因此需要进行分别实验来获取左右旋转时的旋转半径。</p>

<p>以下是转角位移标定的主要步骤：</p>

<p><strong>（1）实际数据采集</strong></p>

<p>启动机器人底盘和键盘控制节点，使用键盘控制机器人原地旋转，并测量转角位移数据，比如可以原地旋转一周。</p>

<p><strong>（2）里程计消息采集</strong></p>

<p>机器人停止后，打开rviz2，并添加tf插件，以显示机器人基坐标系（一般是base_link或base_footprint）与里程计坐标系（一般是odom）相对关系。</p>

<p><strong>（3）参数计算以及修改</strong></p>

<p>在机器人原地旋转一周时，如果机器人基坐标系与里程计坐标系相吻合，那么旋转半径参数无需调整；如果机器人基坐标系与里程计坐标系不吻合且rviz2中机器人的旋转角度大于实际旋转角度，那么请将旋转半径调大；如果机器人基坐标系与里程计坐标系不吻合且rviz2中机器人的旋转角度小于实际旋转角度，那么请将旋转半径调小。将计算出的结果写入 MyCar 机器人的配置文件对应的参数，并重新构建。</p>

<p>为了获得最佳结果，可以多次执行上述流程。每次执行后，测量并记录新的实际转角位移数据和rviz2中的坐标系相对关系，然后根据新的数据再次修正旋转半径。通过不断迭代这个过程，可以逐步优化旋转半径的估计值，减小转角位移的测量误差。</p>

<p><em>小提示：</em></p>

<blockquote>
  <p>如果使用的是以Arduino为主控的MyCar两轮差速机器人，那么需要修改ros2_arduino_bridge功能包下的params/arduino.yaml文件，该文件中有一个名为wheel_track参数即为车轮直径，在ros2_arduino_bridge中并未对左旋转和右旋转做区分；</p>

  <p>如果使用的是以Stm32为主控的MyCar两轮差速机器人，那么需要修改ros2_stm32_bridge功能包下的params/stm32_2w.yaml文件，在机器人左旋转时，要标定的是名为model_param_acw的参数，在机器人右旋转时，要标定的是名为model_param_cw的参数；</p>

  <p>如果使用的是以Stm32为主控的MyCar四轮差速机器人，那么需要修改ros2_stm32_bridge功能包下的params/stm32_4w.yaml文件，和两轮差速类似的，在机器人左旋转时，要标定的是名为model_param_acw的参数，在机器人右旋转时，要标定的是名为model_param_cw的参数。</p>
</blockquote>

<p><strong>4.验证和调整</strong></p>

<p>将标定后的轮式里程计应用于实际场景中，并进行验证和调整。观察车辆的实际位置和运动与估计值的差异，并进行必要的调整和校准。另外，当车辆使用环境发生改变，或持续使用较长一段时间后，建议对里程计进行重新标定。</p>

<h4 id="轮式里程计与imu融合">轮式里程计与IMU融合</h4>

<p>轮式里程计可以通过监测轮子转动来估计机器人的位置和姿态变化，但容易受到滑动和不均匀地面等特殊情况的影响。IMU可以测量加速度和角速度，提供高频率的运动信息，但容易受到积分漂移和噪声的影响。将它们的数据融合可以弥补彼此的不足，提供更可靠和准确的定位结果，充分利用各自的优势，减少局限性。在ROS2中，提供了robot_localization功能包，可以方便的帮助开发人员实现二者的融合。</p>

<p><strong>1.robot_localization简介</strong></p>

<p>robot_localization是ROS2中的一个功能包，用于实现多传感器数据融合的机器人定位和导航。它提供了一个解决方案，可以将来自不同传感器（如轮式里程计、IMU、GPS、激光雷达等）的数据进行融合，以获得更准确和鲁棒的定位结果。在该功能包中，融合算法已经通过节点封装完毕，调用者只需在调用节点时注入参数即可。</p>

<p>请调用如下指令安装robot_localization：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>ros-&lt;distro&gt;-robot-localization
</pre></td></tr></tbody></table></code></pre></div></div>

<p>请将<code class="language-plaintext highlighter-rouge">&lt;distro&gt;</code>替换为正在使用的ROS2发行版代号。</p>

<p><strong>2.robot_localization节点说明</strong></p>

<p>在robot_localization功能包中提供了<code class="language-plaintext highlighter-rouge">ekf_node</code>、<code class="language-plaintext highlighter-rouge">ukf_node</code>和<code class="language-plaintext highlighter-rouge">navsat_transform_node</code>多个节点来实现机器人的状态估计和定位。不同节点介绍如下：</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ekf_node</code>是基于增强卡尔曼滤波器（EKF）的节点，用于融合多个传感器数据来进行状态估计。它接收来自里程计、IMU、激光雷达等传感器的数据，并将它们融合在一起以提供更准确的机器人状态估计。EKF节点使用机器人的运动模型和传感器测量模型来估计机器人的位置、姿态和速度等状态变量。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ukf_node</code>是基于无迹卡尔曼滤波器（UKF）的节点，用于实现机器人的状态估计和本地化。UKF节点采用无迹变换（Unscented Transform）来处理非线性系统，通过估计机器人在空间中的位置和姿态，提供更准确的状态估计。与EKF相比，UKF节点可以更好地处理非线性系统的估计问题。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">navsat_transform_node</code>用于将全球定位系统（GNSS）导航卫星数据与惯性测量单元（IMU）数据进行融合，以提供精确的位置估计。该节点校正GNSS信号的误差，并将其转化为带有高精度的位置信息。这有助于改善在室内或具有GNSS信号不稳定性的环境中的机器人定位精度。</p>
  </li>
</ul>

<p>这些节点是robot_localization功能包中的核心组件，每个节点都可以融合任意数量的传感器（惯性测量单元（IMU），里程计，室内定位系统，全球定位系统接收器等），它们支持 nav_msgs/msg/Odometry（位置、方向和线性、角速度）、geometry_msgs/msg/PoseWithCovarianceStamped（位置和方向）、geometry_msgs/msg/TwistWithCovarianceStamped（线性和角速度）和sensor_msgs/msg/Imu（方向、角速度和线性加速度）消息，以跟踪机器人的15维（x、y、z、滚动、俯仰、偏航、x˙、y˙、z˙、滚动˙、俯仰˙、偏航˙、x¨、y¨、z¨）状态。</p>

<p>基于这些测量数据，状态估计节点将过滤后的位置、方向和线性、角速度（nav_msgs/Odometry）发布到 /odometry/filtered 话题上，并在启用时将过滤后的加速度发布到 /accel/filtered 话题上。</p>

<p>此外，它们可以（默认启用）将相应的变换作为 tf2 变换进行发布，无论是 odom → base_link 变换还是 map → odom 变换。</p>

<p><strong>3.robot_localization使用示例</strong></p>

<p>假设要融合轮式里程计与IMU，那么请先保证机器人底盘可以发布里程计消息以及IMU消息。在MyCar导航机器人中，Stm32底盘是满足条件的，但是Arduino底盘不包含IMU传感器，需要自行安装。融合时，可以使用<code class="language-plaintext highlighter-rouge">ekf_node</code>或<code class="language-plaintext highlighter-rouge">ukf_node</code>节点。本案例中使用的是stm32 4w底盘结合<code class="language-plaintext highlighter-rouge">ekf_node</code>实现。其大致步骤如下：</p>

<ol>
  <li>
    <p>编写luanch文件；</p>
  </li>
  <li>
    <p>编写配置文件；</p>
  </li>
  <li>
    <p>编译；</p>
  </li>
  <li>
    <p>执行并查看结果。</p>
  </li>
</ol>

<p>由于robot_localization对融合实现已经做了很好的封装，所以整个实现流程是比较简单的。</p>

<p><strong>（1）编写launch文件</strong></p>

<p>在ros2_stm32_bridge功能包的launch目录下新建文件driver_ekf.launch.py，并输入以下内容：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">import</span> <span class="n">launch_ros.actions</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">MYCAR_MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">MYCAR_MODEL</span><span class="sh">'</span><span class="p">]</span><span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="n">launch_ros</span><span class="p">.</span><span class="n">actions</span><span class="p">.</span><span class="nc">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_localization</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">ekf_node</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">ekf_filter_node</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">ros2_stm32_bridge</span><span class="sh">"</span><span class="p">),</span> <span class="sh">'</span><span class="s">params</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ekf.yaml</span><span class="sh">'</span><span class="p">)],</span>
           <span class="p">),</span>
        <span class="n">launch_ros</span><span class="p">.</span><span class="n">actions</span><span class="p">.</span><span class="nc">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">tf2_ros</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">static_transform_publisher</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">--frame-id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">base_footprint</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--child-frame-id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">imu_link</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-0.15</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">launch_ros</span><span class="p">.</span><span class="n">actions</span><span class="p">.</span><span class="nc">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros2_stm32_bridge</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">base_controller</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">"</span><span class="s">ros2_stm32_bridge</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="n">MYCAR_MODEL</span> <span class="o">+</span> <span class="sh">"</span><span class="s">_ekf.yaml</span><span class="sh">"</span><span class="p">),],</span>
        <span class="p">)</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该launch文件中，启动了机器人底盘驱动，启动了robot_localization包中<code class="language-plaintext highlighter-rouge">ekf_node</code>节点，并且还发布了base_footprint与imu_link的坐标变换。</p>

<p><strong>（2）编写配置文件</strong></p>

<ul>
  <li>在ros2_stm32_bridge功能包的params目录下新建文件stm32_4w_ekf.yaml，并输入以下内容：</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>/mini_driver:

<span class="c"># /**:  ros__parameters:    base_frame: base_footprint</span>
    baud_rate: 115200    control_rate: 10    encoder_resolution: 44.0    kd: 130    ki: 0    kp: 100    maximum_encoding: 100.0    model_param_acw: 0.45    model_param_cw: 0.45    odom_frame: odom
    port_name: /dev/mycar
    publish_tf: <span class="nb">false    </span>qos_overrides:
      /parameter_events:
        publisher:          depth: 1000          durability: volatile
          <span class="nb">history</span>: keep_last
          reliability: reliable
      /tf:
        publisher:          depth: 100          durability: volatile
          <span class="nb">history</span>: keep_last
          reliability: reliable
    reduction_ratio: 90.0    use_sim_time: <span class="nb">false    </span>wheel_diameter: 0.080
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在该文件中，一个重要操作是将publish_tf参数设置为false，设置为false后，底盘驱动不再发布base_footprint与odom的坐标变换，而是由<code class="language-plaintext highlighter-rouge">ekf_node</code>取而代之。</p>

<ul>
  <li>在ros2_stm32_bridge功能包的params目录下新建文件ekf.yaml，并输入以下内容：</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
</pre></td><td class="rouge-code"><pre>
<span class="c1">### ekf config file ###</span>
<span class="na">ekf_filter_node</span><span class="pi">:</span>
    <span class="na">ros__parameters</span><span class="pi">:</span>

<span class="c1"># The frequency, in Hz, at which the filter will output a position estimate. Note that the filter will not begin</span>

<span class="c1"># computation until it receives at least one message from one of the inputs. It will then run continuously at the</span>

<span class="c1"># frequency specified here, regardless of whether it receives more measurements. Defaults to 30 if unspecified.</span>
        <span class="na">frequency</span><span class="pi">:</span> <span class="m">30.0</span>

<span class="c1"># The period, in seconds, after which we consider a sensor to have timed out. In this event, we carry out a predict</span>

<span class="c1"># cycle on the EKF without correcting it. This parameter can be thought of as the minimum frequency with which the</span>

<span class="c1"># filter will generate new output. Defaults to 1 / frequency if not specified.</span>
        <span class="na">sensor_timeout</span><span class="pi">:</span> <span class="m">0.1</span>

<span class="c1"># ekf_localization_node and ukf_localization_node both use a 3D omnidirectional motion model. If this parameter is</span>

<span class="c1"># set to true, no 3D information will be used in your state estimate. Use this if you are operating in a planar</span>

<span class="c1"># environment and want to ignore the effect of small variations in the ground plane that might otherwise be detected</span>

<span class="c1"># by, for example, an IMU. Defaults to false if unspecified.</span>
        <span class="na">two_d_mode</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># Use this parameter to provide an offset to the transform generated by ekf_localization_node. This can be used for</span>

<span class="c1"># future dating the transform, which is required for interaction with some other packages. Defaults to 0.0 if</span>

<span class="c1"># unspecified.</span>
        <span class="na">transform_time_offset</span><span class="pi">:</span> <span class="m">0.0</span>

<span class="c1"># Use this parameter to provide specify how long the tf listener should wait for a transform to become available. </span>

<span class="c1"># Defaults to 0.0 if unspecified.</span>
        <span class="na">transform_timeout</span><span class="pi">:</span> <span class="m">0.0</span>

<span class="c1"># If you're having trouble, try setting this to true, and then echo the /diagnostics_agg topic to see if the node is</span>

<span class="c1"># unhappy with any settings or data.</span>
        <span class="na">print_diagnostics</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># Debug settings. Not for the faint of heart. Outputs a ludicrous amount of information to the file specified by</span>

<span class="c1"># debug_out_file. I hope you like matrices! Please note that setting this to true will have strongly deleterious</span>

<span class="c1"># effects on the performance of the node. Defaults to false if unspecified.</span>
        <span class="na">debug</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># Defaults to "robot_localization_debug.txt" if unspecified. Please specify the full path.</span>
        <span class="na">debug_out_file</span><span class="pi">:</span> <span class="s">/path/to/debug/file.txt</span>

<span class="c1"># Whether we'll allow old measurements to cause a re-publication of the updated state</span>
        <span class="na">permit_corrected_publication</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># Whether to publish the acceleration state. Defaults to false if unspecified.</span>
        <span class="na">publish_acceleration</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># Whether to broadcast the transformation over the /tf topic. Defaults to true if unspecified.</span>
        <span class="na">publish_tf</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># REP-105 (http://www.ros.org/reps/rep-0105.html) specifies four principal coordinate frames: base_link, odom, map, and</span>

<span class="c1"># earth. base_link is the coordinate frame that is affixed to the robot. Both odom and map are world-fixed frames.</span>

<span class="c1"># The robot's position in the odom frame will drift over time, but is accurate in the short term and should be</span>

<span class="c1"># continuous. The odom frame is therefore the best frame for executing local motion plans. The map frame, like the odom</span>

<span class="c1"># frame, is a world-fixed coordinate frame, and while it contains the most globally accurate position estimate for your</span>

<span class="c1"># robot, it is subject to discrete jumps, e.g., due to the fusion of GPS data or a correction from a map-based</span>

<span class="c1"># localization node. The earth frame is used to relate multiple map frames by giving them a common reference frame.</span>

<span class="c1"># ekf_localization_node and ukf_localization_node are not concerned with the earth frame.</span>

<span class="c1"># Here is how to use the following settings:</span>

<span class="c1"># 1. Set the map_frame, odom_frame, and base_link frames to the appropriate frame names for your system.</span>

<span class="c1">#     1a. If your system does not have a map_frame, just remove it, and make sure "world_frame" is set to the value of</span>

<span class="c1">#         odom_frame.</span>

<span class="c1"># 2. If you are fusing continuous position data such as wheel encoder odometry, visual odometry, or IMU data, set</span>

<span class="c1">#   "world_frame" to your odom_frame value. This is the default behavior for robot_localization's state estimation nodes.</span>

<span class="c1"># 3. If you are fusing global absolute position data that is subject to discrete jumps (e.g., GPS or position updates</span>

<span class="c1"># from landmark observations) then:</span>

<span class="c1">#     3a. Set your "world_frame" to your map_frame value</span>

<span class="c1">#     3b. MAKE SURE something else is generating the odom-&gt;base_link transform. Note that this can even be another state</span>

<span class="c1">#         estimation node from robot_localization! However, that instance should *not* fuse the global data.</span>
        <span class="na">map_frame</span><span class="pi">:</span> <span class="s">map</span>              <span class="c1"># Defaults to "map" if unspecified</span>
        <span class="na">odom_frame</span><span class="pi">:</span> <span class="s">odom</span>            <span class="c1"># Defaults to "odom" if unspecified</span>
        <span class="na">base_link_frame</span><span class="pi">:</span> <span class="s">base_footprint</span>  <span class="c1"># Defaults to "base_link" if unspecified</span>
        <span class="na">world_frame</span><span class="pi">:</span> <span class="s">odom</span>           <span class="c1"># Defaults to the value of odom_frame if unspecified</span>

<span class="c1"># The filter accepts an arbitrary number of inputs from each input message type (nav_msgs/Odometry,</span>

<span class="c1"># geometry_msgs/PoseWithCovarianceStamped, geometry_msgs/TwistWithCovarianceStamped,</span>

<span class="c1"># sensor_msgs/Imu). To add an input, simply append the next number in the sequence to its "base" name, e.g., odom0,</span>

<span class="c1"># odom1, twist0, twist1, imu0, imu1, imu2, etc. The value should be the topic name. These parameters obviously have no</span>

<span class="c1"># default values, and must be specified.</span>
        <span class="na">odom0</span><span class="pi">:</span> <span class="s">odom</span>

<span class="c1"># Each sensor reading updates some or all of the filter's state. These options give you greater control over which</span>

<span class="c1"># values from each measurement are fed to the filter. For example, if you have an odometry message as input, but only</span>

<span class="c1"># want to use its Z position value, then set the entire vector to false, except for the third entry. The order of the</span>

<span class="c1"># values is x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az. Note that not some message types</span>

<span class="c1"># do not provide some of the state variables estimated by the filter. For example, a TwistWithCovarianceStamped message</span>

<span class="c1"># has no pose information, so the first six values would be meaningless in that case. Each vector defaults to all false</span>

<span class="c1"># if unspecified, effectively making this parameter required for each sensor.</span>
        <span class="na">odom0_config</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">false</span><span class="pi">,</span>  <span class="nv">false</span><span class="pi">,</span>  <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">true</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">]</span>

<span class="c1"># If you have high-frequency data or are running with a low frequency parameter value, then you may want to increase</span>

<span class="c1"># the size of the subscription queue so that more measurements are fused.</span>
        <span class="na">odom0_queue_size</span><span class="pi">:</span> <span class="m">2</span>

<span class="c1"># [ADVANCED] Large messages in ROS can exhibit strange behavior when they arrive at a high frequency. This is a result</span>

<span class="c1"># of Nagle's algorithm. This option tells the ROS subscriber to use the tcpNoDelay option, which disables Nagle's</span>

<span class="c1"># algorithm.</span>
        <span class="na">odom0_nodelay</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># [ADVANCED] When measuring one pose variable with two sensors, a situation can arise in which both sensors under-</span>

<span class="c1"># report their covariances. This can lead to the filter rapidly jumping back and forth between each measurement as they</span>

<span class="c1"># arrive. In these cases, it often makes sense to (a) correct the measurement covariances, or (b) if velocity is also</span>

<span class="c1"># measured by one of the sensors, let one sensor measure pose, and the other velocity. However, doing (a) or (b) isn't</span>

<span class="c1"># always feasible, and so we expose the differential parameter. When differential mode is enabled, all absolute pose</span>

<span class="c1"># data is converted to velocity data by differentiating the absolute pose measurements. These velocities are then</span>

<span class="c1"># integrated as usual. NOTE: this only applies to sensors that provide pose measurements; setting differential to true</span>

<span class="c1"># for twist measurements has no effect.</span>
        <span class="na">odom0_differential</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># [ADVANCED] When the node starts, if this parameter is true, then the first measurement is treated as a "zero point"</span>

<span class="c1"># for all future measurements. While you can achieve the same effect with the differential paremeter, the key</span>

<span class="c1"># difference is that the relative parameter doesn't cause the measurement to be converted to a velocity before</span>

<span class="c1"># integrating it. If you simply want your measurements to start at 0 for a given sensor, set this to true.</span>
        <span class="na">odom0_relative</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># [ADVANCED] If your data is subject to outliers, use these threshold settings, expressed as Mahalanobis distances, to</span>

<span class="c1"># control how far away from the current vehicle state a sensor measurement is permitted to be. Each defaults to</span>

<span class="c1"># numeric_limits&lt;double&gt;::max() if unspecified. It is strongly recommended that these parameters be removed if not</span>

<span class="c1"># required. Data is specified at the level of pose and twist variables, rather than for each variable in isolation.</span>

<span class="c1"># For messages that have both pose and twist data, the parameter specifies to which part of the message we are applying</span>

<span class="c1"># the thresholds.</span>
        <span class="na">odom0_pose_rejection_threshold</span><span class="pi">:</span> <span class="m">5.0</span>
        <span class="na">odom0_twist_rejection_threshold</span><span class="pi">:</span> <span class="m">1.0</span>

        <span class="na">imu0</span><span class="pi">:</span> <span class="s">imu</span>
        <span class="na">imu0_config</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>  <span class="nv">true</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>  <span class="nv">true</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>  <span class="nv">false</span><span class="pi">]</span>
        <span class="na">imu0_nodelay</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">imu0_differential</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">imu0_relative</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="na">imu0_queue_size</span><span class="pi">:</span> <span class="m">5</span>
        <span class="na">imu0_pose_rejection_threshold</span><span class="pi">:</span> <span class="m">0.8</span>                 <span class="c1"># Note the difference in parameter names</span>
        <span class="na">imu0_twist_rejection_threshold</span><span class="pi">:</span> <span class="m">0.8</span>                <span class="c1">#</span>
        <span class="na">imu0_linear_acceleration_rejection_threshold</span><span class="pi">:</span> <span class="m">0.8</span>  <span class="c1">#</span>

<span class="c1"># [ADVANCED] Some IMUs automatically remove acceleration due to gravity, and others don't. If yours doesn't, please set</span>

<span class="c1"># this to true, and *make sure* your data conforms to REP-103, specifically, that the data is in ENU frame.</span>
        <span class="na">imu0_remove_gravitational_acceleration</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># [ADVANCED]  The EKF and UKF models follow a standard predict/correct cycle. During prediction, if there is no</span>

<span class="c1"># acceleration reference, the velocity at time t+1 is simply predicted to be the same as the velocity at time t. During</span>

<span class="c1"># correction, this predicted value is fused with the measured value to produce the new velocity estimate. This can be</span>

<span class="c1"># problematic, as the final velocity will effectively be a weighted average of the old velocity and the new one. When</span>

<span class="c1"># this velocity is the integrated into a new pose, the result can be sluggish covergence. This effect is especially</span>

<span class="c1"># noticeable with LIDAR data during rotations. To get around it, users can try inflating the process_noise_covariance</span>

<span class="c1"># for the velocity variable in question, or decrease the  variance of the variable in question in the measurement</span>

<span class="c1"># itself. In addition, users can also take advantage of the control command being issued to the robot at the time we</span>

<span class="c1"># make the prediction. If control is used, it will get converted into an acceleration term, which will be used during</span>

<span class="c1"># predicition. Note that if an acceleration measurement for the variable in question is available from one of the</span>

<span class="c1"># inputs, the control term will be ignored.</span>

<span class="c1"># Whether or not we use the control input during predicition. Defaults to false.</span>
        <span class="na">use_control</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># Whether the input (assumed to be cmd_vel) is a geometry_msgs/Twist or geometry_msgs/TwistStamped message. Defaults to</span>

<span class="c1"># false.</span>
        <span class="na">stamped_control</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># The last issued control command will be used in prediction for this period. Defaults to 0.2.</span>
        <span class="na">control_timeout</span><span class="pi">:</span> <span class="m">0.2</span>

<span class="c1"># Which velocities are being controlled. Order is vx, vy, vz, vroll, vpitch, vyaw.</span>
        <span class="na">control_config</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">true</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">true</span><span class="pi">]</span>

<span class="c1"># Places limits on how large the acceleration term will be. Should match your robot's kinematics.</span>
        <span class="na">acceleration_limits</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1.3</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">3.4</span><span class="pi">]</span>

<span class="c1"># Acceleration and deceleration limits are not always the same for robots.</span>
        <span class="na">deceleration_limits</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1.3</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">4.5</span><span class="pi">]</span>

<span class="c1"># If your robot cannot instantaneously reach its acceleration limit, the permitted change can be controlled with these</span>

<span class="c1"># gains</span>
        <span class="na">acceleration_gains</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.8</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.9</span><span class="pi">]</span>

<span class="c1"># If your robot cannot instantaneously reach its deceleration limit, the permitted change can be controlled with these</span>

<span class="c1"># gains</span>
        <span class="na">deceleration_gains</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span> <span class="nv">1.0</span><span class="pi">]</span>

<span class="c1"># [ADVANCED] The process noise covariance matrix can be difficult to tune, and can vary for each application, so it is</span>

<span class="c1"># exposed as a configuration parameter. This matrix represents the noise we add to the total error after each</span>

<span class="c1"># prediction step. The better the omnidirectional motion model matches your system, the smaller these values can be.</span>

<span class="c1"># However, if users find that a given variable is slow to converge, one approach is to increase the</span>

<span class="c1"># process_noise_covariance diagonal value for the variable in question, which will cause the filter's predicted error</span>

<span class="c1"># to be larger, which will cause the filter to trust the incoming measurement more during correction. The values are</span>

<span class="c1"># ordered as x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az. Defaults to the matrix below if</span>

<span class="c1"># unspecified.</span>
        <span class="na">process_noise_covariance</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.05</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.05</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.06</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.03</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.03</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.06</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.025</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.025</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.04</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.02</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>
                                   <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.015</span><span class="pi">]</span>

<span class="c1"># [ADVANCED] This represents the initial value for the state estimate error covariance matrix. Setting a diagonal</span>

<span class="c1"># value (variance) to a large value will result in rapid convergence for initial measurements of the variable in</span>

<span class="c1"># question. Users should take care not to use large values for variables that will not be measured directly. The values</span>

<span class="c1"># are ordered as x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az. Defaults to the matrix below</span>
<span class="c1">#if unspecified.</span>
        <span class="na">initial_estimate_covariance</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span>  <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">1e-9</span><span class="pi">,</span>  <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">1e-9</span><span class="pi">,</span>  <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">,</span> <span class="nv">0.0</span><span class="pi">,</span>
                                      <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>     <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">0.0</span><span class="pi">,</span>    <span class="nv">1e-9</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在该文件中，关键配置如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">#......</span>
        <span class="na">odom0_config</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">false</span><span class="pi">,</span>  <span class="nv">false</span><span class="pi">,</span>  <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">true</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                       <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">]</span>
<span class="c1">#......</span>
        <span class="na">imu0_config</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>  <span class="nv">true</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>  <span class="nv">true</span><span class="pi">,</span>
                      <span class="nv">false</span><span class="pi">,</span> <span class="nv">false</span><span class="pi">,</span>  <span class="nv">false</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述配置主要是融合了里程计消息中的x方向速度与imu消息中的yaw角度生成新的里程计数据。</p>

<p><strong>（3）编译</strong></p>

<p>终端中进入当前工作空间，编译功能包：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>colcon build <span class="nt">--packages-select</span> ros2_stm32_bridge
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>（4）执行</strong></p>

<p>终端中进入当前工作空间，执行launch文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">.</span> <span class="nb">install</span>/setup.bash
ros2 launch ros2_stm32_bridge driver_ekf.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再启动rviz2以及键盘控制节点，在rviz2中将参考坐标系设置为odom，添加tf插件，再添加两个odometry插件并将话题分别设置为odom和odometry/filtered。使用键盘控制机器人前进，两个里程计插件显示的数据和机器人的实际运行基本相符，前进一段时间后，手动搬动机器人让其产生一定角度的偏航，该动作也能在融合后的里程计以及坐标变换中准确显示，而轮式里程计由于电机并未旋转而没有改变（如下图所示）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1805.webp" alt="" /></p>

<h3 id="激光雷达工具">激光雷达工具</h3>

<h3 id="相机使用进阶">相机使用进阶</h3>

<h1 id="机器人导航navigation2实体篇">机器人导航Navigation2(实体篇)</h1>

<h2 id="准备工作">准备工作</h2>

<ol>
  <li>
    <p>实物</p>
  </li>
  <li>
    <p>已经跑过一遍机器人导航Navigation2(仿真篇)</p>
  </li>
  <li>
    <p>本章只讲大体思路实现，一般只要你仿真篇搞明白了，实体篇看看大体思路就懂怎么实现了。</p>
  </li>
  <li>
    <p>本章非赵虚左教程，是自己的实现思路，仅供参考，可能赵老师有更好的办法，不过他还没出实体篇教程。</p>
  </li>
  <li>
    <p>本章用的是4轮麦克纳姆轮实现的，仅供参考。</p>
  </li>
</ol>

<p>以下代码都在下方这个github仓库里：</p>

<p>https://github.com/CyberNaviRobot/CyberRobot_ROS2_WS</p>

<p><em>下方的教程只有实现思路，不会放源码，所以建议克隆一下这个仓库，看看源码。</em></p>

<h2 id="导航参数参考-1">导航参数参考</h2>

<p>https://docs.nav2.org/configuration/index.html</p>

<h2 id="slam-定位与建图-1">SLAM 定位与建图</h2>

<h3 id="slam_toolbox">slam_toolbox</h3>

<p>根据上方的节点说明，我们要订阅/scan和/tf。</p>

<p>一般激光雷达的说明书都会提供源码去发布/scan,所以这个请看你硬件的说明书。</p>

<p>/tf则需要我们发布odom_frame到base_frame的转换，我们必须使用C++代码去动态发布odom的坐标变换。</p>

<p>但是这里你需要发布/odom,以便于知道机器人的位置和姿态，这样才能够够推算出机器人在map中的位置。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1806.webp" alt="" /></p>

<p>确保slam toolbox各项参数没有设置错，特别是坐标系等等，其他参数可以看着说明微调。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1807.webp" alt="" /></p>

<p>确保激光雷达发布的话题是/scan。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1808.webp" alt="" /></p>

<p>先启动激光雷达</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1809.webp" alt="" /></p>

<p>再启动urdf模型，同时发布tf。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1810.webp" alt="" /></p>

<p>最后开启slam</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch mycar_slam_slam_toolbox online_sync_launch.py use_sim_time:<span class="o">=</span><span class="nb">false</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1811.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1812.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1813.webp" alt="" /></p>

<h3 id="cartographer">cartographer</h3>

<p>根据cartographer说明，我们需要/scan和/odom即可。</p>

<p>先打开串口接收节点，接收stm32传过来的数据。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1814.webp" alt="" /></p>

<p>然后再打开里程计节点，发布odom话题</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1815.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1816.webp" alt="" /></p>

<p>再发布一下TF，可以直接用launch开启robot_state_publisher和joint_state_publisher,并打开urdf模型来发布TF。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1817.webp" alt="" /></p>

<p>打开激光雷达的节点，发布scan话题</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1818.webp" alt="" /></p>

<p>等/odom,/scan和TF全发了之后，再打开cartographer建图，然后可以检查map的TF是否发布。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1819.webp" alt="" /></p>

<p>检查TF树如下：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1820.webp" alt="" /></p>

<p>建图如下</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1821.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1822.webp" alt="" /></p>

<h2 id="地图服务-1">地图服务</h2>

<h3 id="保存地图序列化-1">保存地图(序列化)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir</span> ./map
ros2 run nav2_map_server map_saver_cli <span class="nt">-f</span> map/my_map
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1823.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1824.webp" alt="" /></p>

<h3 id="读取地图反序列化-1">读取地图(反序列化)</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1825.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ros2 launch mycar_map_server map_server.launch.py
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="amcl自适应蒙特卡洛定位-1">AMCL自适应蒙特卡洛定位</h2>

<p>首先需要地图的数据，发布/map话题。</p>

<p>其次需要激光雷达数据，即/scan话题。</p>

<p>然后需要坐标变换消息，即/tf话题。</p>

<p>然后那个/initial_pose话题，是2D地图上的初始位置，可以用rviz2发布，也可以用C++代码发布。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1826.webp" alt="" /></p>

<p>然后需要修改一下参数：</p>

<p>这个是参数的官方网站：</p>

<p>https://docs.nav2.org/configuration/packages/configuring-amcl.html#</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1827.webp" alt="" /></p>

<p>修改完Launch后，再修改params参数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1828.webp" alt="" /></p>

<p>这里的OmniChassis不止指全向轮底盘，而是广义的全向轮底盘，像全向轮底盘，麦轮底盘都是全向轮底盘。当然也可以自定义底盘类型。</p>

<p>这个配置文件最顶上的那个use_sim_time设置为False。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1829.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1830.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1831.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1832.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1833.webp" alt="" /></p>

<h2 id="导航服务器-1">导航服务器</h2>

<p>涉及的话题太多了，所以我们列出来了一个表：</p>

<ol>
  <li>订阅的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/goal_pose</td>
      <td style="text-align: left">geometry_msgs/msg/PoseStamped</td>
      <td style="text-align: left">导航目标点，用于触发导航任务</td>
    </tr>
    <tr>
      <td style="text-align: left">/tf</td>
      <td style="text-align: left">tf2_msgs/msg/TFMessage</td>
      <td style="text-align: left">坐标变换消息，用于不同坐标系之间的转换</td>
    </tr>
    <tr>
      <td style="text-align: left">/odom</td>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
      <td style="text-align: left">里程计数据，提供机器人位置和运动信息</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/footprint</td>
      <td style="text-align: left">geometry_msgs/msg/Polygon</td>
      <td style="text-align: left">机器人（或任何移动平台）的足迹（footprint）信息。足迹是机器人在地图上占据的空间形状，通常用多边形表示。</td>
    </tr>
    <tr>
      <td style="text-align: left">/map</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">发布环境地图，特别是用于导航的占用网格图（Occupancy Grid Map）。</td>
    </tr>
    <tr>
      <td style="text-align: left">/scan</td>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">激光扫描数据。</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/odom</td>
      <td style="text-align: left">nav_msgs/msg/Odometry</td>
      <td style="text-align: left">机器人的里程计信息，包含位置、速度和姿态</td>
    </tr>
    <tr>
      <td style="text-align: left">/speed_limit</td>
      <td style="text-align: left">nav2_msgs/msg/SpeedLimit</td>
      <td style="text-align: left">导航过程中的速度限制信息，用于动态调整机器人的移动速度</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/footprint</td>
      <td style="text-align: left">geometry_msgs/msg/Polygon</td>
      <td style="text-align: left">机器人或移动平台的足迹多边形，用于本地代价地图的计算</td>
    </tr>
    <tr>
      <td style="text-align: left">/scan</td>
      <td style="text-align: left">sensor_msgs/msg/LaserScan</td>
      <td style="text-align: left">激光扫描仪的扫描数据，用于环境感知和避障</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/clock</td>
      <td style="text-align: left">rosgraph_msgs/msg/Clock</td>
      <td style="text-align: left">ROS系统时间</td>
    </tr>
    <tr>
      <td style="text-align: left">/cmd_vel_teleop</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">遥操作命令，用于控制机器人的线性和角速度</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">局部代价地图的原始数据</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">机器人在局部代价地图中的已发布足迹</td>
    </tr>
    <tr>
      <td style="text-align: left">/preempt_teleop</td>
      <td style="text-align: left">std_msgs/msg/Empty</td>
      <td style="text-align: left">遥操作抢占信号，用于中断当前遥操作</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">全局代价地图的原始数据，用于路径规划</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">机器人在全局代价地图中的足迹表示</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/cmd_vel_nav</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">接收来自其他节点的速度控制指令的话题</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>发布的话题</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">话题</th>
      <th style="text-align: left">接口</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">当前位置到目标点的全局路径</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/costmap</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">发布全局代价地图的当前状态。</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">未经进一步处理的原始代价地图数据。</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/costmap_updates</td>
      <td style="text-align: left">map_msgs/msg/OccupancyGridUpdate</td>
      <td style="text-align: left">全局代价地图的更新，该消息可以高效更新地图。</td>
    </tr>
    <tr>
      <td style="text-align: left">/global_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">发布机器人的足迹（footprint），即机器人在地图上占据的空间形状。</td>
    </tr>
    <tr>
      <td style="text-align: left">话题名称</td>
      <td style="text-align: left">消息类型</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/cmd_vel_nav</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">发布控制命令，包括线性和角速度，用于控制机器人按照规划路径移动。</td>
    </tr>
    <tr>
      <td style="text-align: left">/cost_cloud</td>
      <td style="text-align: left">sensor_msgs/msg/PointCloud2</td>
      <td style="text-align: left">发布成本地图中的点云数据，用于避障和路径规划。</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">发布局部路径规划结果，即机器人应如何到达当前目标点附近的一个点。</td>
    </tr>
    <tr>
      <td style="text-align: left">/marker</td>
      <td style="text-align: left">visualization_msgs/msg/MarkerArray</td>
      <td style="text-align: left">发布可视化标记，用于在RViz等可视化工具中显示路径、障碍物等信息。</td>
    </tr>
    <tr>
      <td style="text-align: left">/received_global_plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">发布从全局规划器接收到的全局路径，即当前位置到目标点的路径。</td>
    </tr>
    <tr>
      <td style="text-align: left">/transformed_global_plan</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">发布经过坐标变换的全局路径，确保路径与机器人的当前坐标系一致。</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/clearing_endpoints</td>
      <td style="text-align: left">sensor_msgs/msg/PointCloud2</td>
      <td style="text-align: left">清除成本图上的障碍物点云数据，通常用于动态障碍物处理</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap</td>
      <td style="text-align: left">nav_msgs/msg/OccupancyGrid</td>
      <td style="text-align: left">本地成本图，表示机器人周围环境的可通行性</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap_raw</td>
      <td style="text-align: left">nav2_msgs/msg/Costmap</td>
      <td style="text-align: left">未经处理的本地成本图，可能包含更详细的信息</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/costmap_updates</td>
      <td style="text-align: left">map_msgs/msg/OccupancyGridUpdate</td>
      <td style="text-align: left">本地成本图的更新信息，包括哪些区域发生了变化</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/published_footprint</td>
      <td style="text-align: left">geometry_msgs/msg/PolygonStamped</td>
      <td style="text-align: left">发布的机器人足迹多边形，时间戳表示发布时间</td>
    </tr>
    <tr>
      <td style="text-align: left">/local_costmap/voxel_grid</td>
      <td style="text-align: left">nav2_msgs/msg/VoxelGrid</td>
      <td style="text-align: left">体素网格数据，用于成本图生成中的空间划分和优化</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/cmd_vel</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">发送给底层控制器的速度命令</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/plan_smoothed</td>
      <td style="text-align: left">nav_msgs/msg/Path</td>
      <td style="text-align: left">经过平滑处理后的全局路径</td>
    </tr>
    <tr>
      <td style="text-align: left">话题</td>
      <td style="text-align: left">接口</td>
      <td style="text-align: left">描述</td>
    </tr>
    <tr>
      <td style="text-align: left">/cmd_vel</td>
      <td style="text-align: left">geometry_msgs/msg/Twist</td>
      <td style="text-align: left">发布经过处理或平滑后的速度控制指令的话题</td>
    </tr>
  </tbody>
</table>

<p>由于赵虚左是把官方的源码重新写在了WS里，这样对于初学者来说会比较麻烦，对于初学者来说建议使用官方写好的bringup节点，以下是我根据官方Wiki总结出来的使用方法：（这里选择使用官方的bringup节点，而不是赵虚左老师的节点。）</p>

<p>以下是配置的<code class="language-plaintext highlighter-rouge">nav2.launch.py</code>文件：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.launch_description_sources</span> <span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>

<span class="c1"># from launch_ros.actions import Node
</span>
<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">navigation2_dir</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">nav05_navigation2</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">nav2_bringup_dir</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">nav2_bringup</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># launch的参数的优先级比yaml的参数优先级高
</span>    <span class="n">use_sim_time</span> <span class="o">=</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">flase</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">map_yaml_path</span> <span class="o">=</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">map</span><span class="sh">'</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">navigation2_dir</span><span class="p">,</span><span class="sh">'</span><span class="s">map</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">house.yaml</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">nav2_param_path</span> <span class="o">=</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">params_file</span><span class="sh">'</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">navigation2_dir</span><span class="p">,</span><span class="sh">'</span><span class="s">params</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">nav2.yaml</span><span class="sh">'</span><span class="p">))</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="n">use_sim_time</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Use simulation (Gazebo) clock if true</span><span class="sh">'</span><span class="p">),</span>
        <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="sh">'</span><span class="s">map</span><span class="sh">'</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="n">map_yaml_path</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Full path to map file to load</span><span class="sh">'</span><span class="p">),</span>
        <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="sh">'</span><span class="s">params_file</span><span class="sh">'</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="n">nav2_param_path</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Full path to param file to load</span><span class="sh">'</span><span class="p">),</span>

        <span class="nc">IncludeLaunchDescription</span><span class="p">(</span>
            <span class="nc">PythonLaunchDescriptionSource</span><span class="p">([</span><span class="n">nav2_bringup_dir</span><span class="p">,</span><span class="sh">'</span><span class="s">/launch</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">/bringup_launch.py</span><span class="sh">'</span><span class="p">]),</span>
            <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">'</span><span class="s">map</span><span class="sh">'</span><span class="p">:</span> <span class="n">map_yaml_path</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">use_sim_time</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">params_file</span><span class="sh">'</span><span class="p">:</span> <span class="n">nav2_param_path</span><span class="p">}.</span><span class="nf">items</span><span class="p">(),</span>
        <span class="p">),</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以下是<code class="language-plaintext highlighter-rouge">rviz2.launch.py</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="n">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="n">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="kn">from</span> <span class="n">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="kn">from</span> <span class="n">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">navigation2_dir</span> <span class="o">=</span> <span class="nf">get_package_share_directory</span><span class="p">(</span><span class="sh">'</span><span class="s">nav05_navigation2</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">use_sim_time</span> <span class="o">=</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">false</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">rviz_config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">navigation2_dir</span><span class="p">,</span><span class="sh">'</span><span class="s">rviz</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">nav2.rviz</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">LaunchDescription</span><span class="p">([</span>
        <span class="nc">DeclareLaunchArgument</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">,</span><span class="n">default_value</span><span class="o">=</span><span class="n">use_sim_time</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Use simulation (Gazebo) clock if true</span><span class="sh">'</span><span class="p">),</span>

        <span class="nc">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">rviz2</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="n">rviz_config_dir</span><span class="p">],</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">use_sim_time</span><span class="p">}],</span>
            <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以下是<code class="language-plaintext highlighter-rouge">nav2.yaml</code>配置文件（差速模型+DWE局部规划器）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
</pre></td><td class="rouge-code"><pre><span class="n">amcl</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">alpha1</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha2</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha3</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha4</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha5</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">base_frame_id</span><span class="p">:</span> <span class="sh">"</span><span class="s">base_link</span><span class="sh">"</span>
    <span class="n">beam_skip_distance</span><span class="p">:</span> <span class="mf">0.5</span>
    <span class="n">beam_skip_error_threshold</span><span class="p">:</span> <span class="mf">0.9</span>
    <span class="n">beam_skip_threshold</span><span class="p">:</span> <span class="mf">0.3</span>
    <span class="n">do_beamskip</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">global_frame_id</span><span class="p">:</span> <span class="sh">"</span><span class="s">map</span><span class="sh">"</span>
    <span class="n">lambda_short</span><span class="p">:</span> <span class="mf">0.1</span>
    <span class="n">laser_likelihood_max_dist</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="n">laser_max_range</span><span class="p">:</span> <span class="mf">100.0</span>
    <span class="n">laser_min_range</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">laser_model_type</span><span class="p">:</span> <span class="sh">"</span><span class="s">likelihood_field</span><span class="sh">"</span>
    <span class="n">max_beams</span><span class="p">:</span> <span class="mi">60</span>
    <span class="n">max_particles</span><span class="p">:</span> <span class="mi">2000</span>
    <span class="n">min_particles</span><span class="p">:</span> <span class="mi">500</span>
    <span class="n">odom_frame_id</span><span class="p">:</span> <span class="sh">"</span><span class="s">odom</span><span class="sh">"</span>
    <span class="n">pf_err</span><span class="p">:</span> <span class="mf">0.05</span>
    <span class="n">pf_z</span><span class="p">:</span> <span class="mf">0.99</span>
    <span class="n">recovery_alpha_fast</span><span class="p">:</span> <span class="mf">0.0</span>
    <span class="n">recovery_alpha_slow</span><span class="p">:</span> <span class="mf">0.0</span>
    <span class="n">resample_interval</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">robot_model_type</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_amcl::DifferentialMotionModel</span><span class="sh">"</span>
    <span class="n">save_pose_rate</span><span class="p">:</span> <span class="mf">0.5</span>
    <span class="n">sigma_hit</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">tf_broadcast</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">transform_tolerance</span><span class="p">:</span> <span class="mf">1.0</span>
    <span class="n">update_min_a</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">update_min_d</span><span class="p">:</span> <span class="mf">0.25</span>
    <span class="n">z_hit</span><span class="p">:</span> <span class="mf">0.5</span>
    <span class="n">z_max</span><span class="p">:</span> <span class="mf">0.05</span>
    <span class="n">z_rand</span><span class="p">:</span> <span class="mf">0.5</span>
    <span class="n">z_short</span><span class="p">:</span> <span class="mf">0.05</span>
    <span class="n">scan_topic</span><span class="p">:</span> <span class="n">scan</span>

<span class="n">amcl_map_client</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">amcl_rclcpp_node</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">bt_navigator</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">global_frame</span><span class="p">:</span> <span class="nb">map</span>
    <span class="n">robot_base_frame</span><span class="p">:</span> <span class="n">base_link</span>
    <span class="n">odom_topic</span><span class="p">:</span> <span class="o">/</span><span class="n">odom</span>
    <span class="n">bt_loop_duration</span><span class="p">:</span> <span class="mi">10</span>
    <span class="n">default_server_timeout</span><span class="p">:</span> <span class="mi">20</span>

    <span class="c1"># 'default_nav_through_poses_bt_xml' and 'default_nav_to_pose_bt_xml' are use defaults:
</span>
    <span class="c1"># nav2_bt_navigator/navigate_to_pose_w_replanning_and_recovery.xml
</span>
    <span class="c1"># nav2_bt_navigator/navigate_through_poses_w_replanning_and_recovery.xml
</span>
    <span class="c1"># They can be set here or via a RewrittenYaml remap from a parent launch file to Nav2.
</span>    <span class="n">plugin_lib_names</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">nav2_compute_path_to_pose_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_compute_path_through_poses_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_smooth_path_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_follow_path_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_spin_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_wait_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_back_up_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_drive_on_heading_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_clear_costmap_service_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_is_stuck_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_goal_reached_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_goal_updated_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_globally_updated_goal_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_is_path_valid_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_initial_pose_received_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_reinitialize_global_localization_service_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_rate_controller_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_distance_controller_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_speed_controller_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_truncate_path_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_truncate_path_local_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_goal_updater_node_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_recovery_node_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_pipeline_sequence_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_round_robin_node_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_transform_available_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_time_expired_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_path_expiring_timer_condition</span>
    <span class="o">-</span> <span class="n">nav2_distance_traveled_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_single_trigger_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_is_battery_low_condition_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_navigate_through_poses_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_navigate_to_pose_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_remove_passed_goals_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_planner_selector_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_controller_selector_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_goal_checker_selector_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_controller_cancel_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_path_longer_on_approach_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_wait_cancel_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_spin_cancel_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_back_up_cancel_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_drive_on_heading_cancel_bt_node</span>

<span class="n">bt_navigator_rclcpp_node</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">controller_server</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">controller_frequency</span><span class="p">:</span> <span class="mf">20.0</span>
    <span class="n">min_x_velocity_threshold</span><span class="p">:</span> <span class="mf">0.001</span>
    <span class="n">min_y_velocity_threshold</span><span class="p">:</span> <span class="mf">0.5</span>
    <span class="n">min_theta_velocity_threshold</span><span class="p">:</span> <span class="mf">0.001</span>
    <span class="n">failure_tolerance</span><span class="p">:</span> <span class="mf">0.3</span>
    <span class="n">progress_checker_plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">progress_checker</span><span class="sh">"</span>
    <span class="n">goal_checker_plugins</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">general_goal_checker</span><span class="sh">"</span><span class="p">]</span> <span class="c1"># "precise_goal_checker"
</span>    <span class="n">controller_plugins</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">FollowPath</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># Progress checker parameters
</span>    <span class="n">progress_checker</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_controller::SimpleProgressChecker</span><span class="sh">"</span>
      <span class="n">required_movement_radius</span><span class="p">:</span> <span class="mf">0.5</span>
      <span class="n">movement_time_allowance</span><span class="p">:</span> <span class="mf">10.0</span>

    <span class="c1"># Goal checker parameters
</span>    <span class="c1">#precise_goal_checker:
</span>
    <span class="c1">#  plugin: "nav2_controller::SimpleGoalChecker"
</span>
    <span class="c1">#  xy_goal_tolerance: 0.25
</span>
    <span class="c1">#  yaw_goal_tolerance: 0.25
</span>
    <span class="c1">#  stateful: True
</span>    <span class="n">general_goal_checker</span><span class="p">:</span>
      <span class="n">stateful</span><span class="p">:</span> <span class="bp">True</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_controller::SimpleGoalChecker</span><span class="sh">"</span>
      <span class="n">xy_goal_tolerance</span><span class="p">:</span> <span class="mf">0.25</span>
      <span class="n">yaw_goal_tolerance</span><span class="p">:</span> <span class="mf">0.25</span>

    <span class="c1"># DWB parameters
</span>    <span class="n">FollowPath</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">dwb_core::DWBLocalPlanner</span><span class="sh">"</span>
      <span class="n">debug_trajectory_details</span><span class="p">:</span> <span class="bp">True</span>
      <span class="n">min_vel_x</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">min_vel_y</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">max_vel_x</span><span class="p">:</span> <span class="mf">0.26</span>
      <span class="n">max_vel_y</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">max_vel_theta</span><span class="p">:</span> <span class="mf">1.0</span>
      <span class="n">min_speed_xy</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">max_speed_xy</span><span class="p">:</span> <span class="mf">0.26</span>
      <span class="n">min_speed_theta</span><span class="p">:</span> <span class="mf">0.0</span>

      <span class="c1"># Add high threshold velocity for turtlebot 3 issue.
</span>
      <span class="c1"># https://github.com/ROBOTIS-GIT/turtlebot3_simulations/issues/75
</span>      <span class="n">acc_lim_x</span><span class="p">:</span> <span class="mf">2.5</span>
      <span class="n">acc_lim_y</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">acc_lim_theta</span><span class="p">:</span> <span class="mf">3.2</span>
      <span class="n">decel_lim_x</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.5</span>
      <span class="n">decel_lim_y</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">decel_lim_theta</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.2</span>
      <span class="n">vx_samples</span><span class="p">:</span> <span class="mi">20</span>
      <span class="n">vy_samples</span><span class="p">:</span> <span class="mi">5</span>
      <span class="n">vtheta_samples</span><span class="p">:</span> <span class="mi">20</span>
      <span class="n">sim_time</span><span class="p">:</span> <span class="mf">1.7</span>
      <span class="n">linear_granularity</span><span class="p">:</span> <span class="mf">0.05</span>
      <span class="n">angular_granularity</span><span class="p">:</span> <span class="mf">0.025</span>
      <span class="n">transform_tolerance</span><span class="p">:</span> <span class="mf">0.2</span>
      <span class="n">xy_goal_tolerance</span><span class="p">:</span> <span class="mf">0.25</span>
      <span class="n">trans_stopped_velocity</span><span class="p">:</span> <span class="mf">0.25</span>
      <span class="n">short_circuit_trajectory_evaluation</span><span class="p">:</span> <span class="bp">True</span>
      <span class="n">stateful</span><span class="p">:</span> <span class="bp">True</span>
      <span class="n">critics</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">RotateToGoal</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Oscillation</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">BaseObstacle</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">GoalAlign</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">PathAlign</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">PathDist</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">GoalDist</span><span class="sh">"</span><span class="p">]</span>
      <span class="n">BaseObstacle</span><span class="p">.</span><span class="n">scale</span><span class="p">:</span> <span class="mf">0.02</span>
      <span class="n">PathAlign</span><span class="p">.</span><span class="n">scale</span><span class="p">:</span> <span class="mf">32.0</span>
      <span class="n">PathAlign</span><span class="p">.</span><span class="n">forward_point_distance</span><span class="p">:</span> <span class="mf">0.1</span>
      <span class="n">GoalAlign</span><span class="p">.</span><span class="n">scale</span><span class="p">:</span> <span class="mf">24.0</span>
      <span class="n">GoalAlign</span><span class="p">.</span><span class="n">forward_point_distance</span><span class="p">:</span> <span class="mf">0.1</span>
      <span class="n">PathDist</span><span class="p">.</span><span class="n">scale</span><span class="p">:</span> <span class="mf">32.0</span>
      <span class="n">GoalDist</span><span class="p">.</span><span class="n">scale</span><span class="p">:</span> <span class="mf">24.0</span>
      <span class="n">RotateToGoal</span><span class="p">.</span><span class="n">scale</span><span class="p">:</span> <span class="mf">32.0</span>
      <span class="n">RotateToGoal</span><span class="p">.</span><span class="n">slowing_factor</span><span class="p">:</span> <span class="mf">5.0</span>
      <span class="n">RotateToGoal</span><span class="p">.</span><span class="n">lookahead_time</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>

<span class="n">controller_server_rclcpp_node</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">local_costmap</span><span class="p">:</span>
  <span class="n">local_costmap</span><span class="p">:</span>
    <span class="n">ros__parameters</span><span class="p">:</span>
      <span class="n">update_frequency</span><span class="p">:</span> <span class="mf">5.0</span>
      <span class="n">publish_frequency</span><span class="p">:</span> <span class="mf">2.0</span>
      <span class="n">global_frame</span><span class="p">:</span> <span class="n">odom</span>
      <span class="n">robot_base_frame</span><span class="p">:</span> <span class="n">base_link</span>
      <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">rolling_window</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">width</span><span class="p">:</span> <span class="mi">3</span>
      <span class="n">height</span><span class="p">:</span> <span class="mi">3</span>
      <span class="n">resolution</span><span class="p">:</span> <span class="mf">0.05</span>
      <span class="n">robot_radius</span><span class="p">:</span> <span class="mf">0.22</span>
      <span class="n">plugins</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">static_layer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">obstacle_layer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">voxel_layer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">inflation_layer</span><span class="sh">"</span><span class="p">]</span>
      <span class="n">inflation_layer</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_costmap_2d::InflationLayer</span><span class="sh">"</span>
        <span class="n">cost_scaling_factor</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="n">inflation_radius</span><span class="p">:</span> <span class="mf">0.55</span>
      <span class="n">obstacle_layer</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_costmap_2d::ObstacleLayer</span><span class="sh">"</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="bp">True</span>
        <span class="n">observation_sources</span><span class="p">:</span> <span class="n">scan</span>
        <span class="n">scan</span><span class="p">:</span>
          <span class="n">topic</span><span class="p">:</span> <span class="o">/</span><span class="n">scan</span>
          <span class="n">max_obstacle_height</span><span class="p">:</span> <span class="mf">2.0</span>
          <span class="n">clearing</span><span class="p">:</span> <span class="bp">True</span>
          <span class="n">marking</span><span class="p">:</span> <span class="bp">True</span>
          <span class="n">data_type</span><span class="p">:</span> <span class="sh">"</span><span class="s">LaserScan</span><span class="sh">"</span>
          <span class="n">raytrace_max_range</span><span class="p">:</span> <span class="mf">3.0</span>
          <span class="n">raytrace_min_range</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="n">obstacle_max_range</span><span class="p">:</span> <span class="mf">2.5</span>
          <span class="n">obstacle_min_range</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">voxel_layer</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_costmap_2d::VoxelLayer</span><span class="sh">"</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="bp">True</span>
        <span class="n">publish_voxel_map</span><span class="p">:</span> <span class="bp">True</span>
        <span class="n">origin_z</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="n">z_resolution</span><span class="p">:</span> <span class="mf">0.05</span>
        <span class="n">z_voxels</span><span class="p">:</span> <span class="mi">16</span>
        <span class="n">max_obstacle_height</span><span class="p">:</span> <span class="mf">2.0</span>
        <span class="n">mark_threshold</span><span class="p">:</span> <span class="mi">0</span>
        <span class="n">observation_sources</span><span class="p">:</span> <span class="n">scan</span>
        <span class="n">scan</span><span class="p">:</span>
          <span class="n">topic</span><span class="p">:</span> <span class="o">/</span><span class="n">scan</span>
          <span class="n">max_obstacle_height</span><span class="p">:</span> <span class="mf">2.0</span>
          <span class="n">clearing</span><span class="p">:</span> <span class="bp">True</span>
          <span class="n">marking</span><span class="p">:</span> <span class="bp">True</span>
          <span class="n">data_type</span><span class="p">:</span> <span class="sh">"</span><span class="s">LaserScan</span><span class="sh">"</span>
          <span class="n">raytrace_max_range</span><span class="p">:</span> <span class="mf">3.0</span>
          <span class="n">raytrace_min_range</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="n">obstacle_max_range</span><span class="p">:</span> <span class="mf">2.5</span>
          <span class="n">obstacle_min_range</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">static_layer</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_costmap_2d::StaticLayer</span><span class="sh">"</span>
        <span class="n">map_subscribe_transient_local</span><span class="p">:</span> <span class="bp">True</span>
      <span class="n">always_send_full_costmap</span><span class="p">:</span> <span class="bp">True</span>

  <span class="n">local_costmap_client</span><span class="p">:</span>
    <span class="n">ros__parameters</span><span class="p">:</span>
      <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">local_costmap_rclcpp_node</span><span class="p">:</span>
    <span class="n">ros__parameters</span><span class="p">:</span>
      <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">global_costmap</span><span class="p">:</span>
  <span class="n">global_costmap</span><span class="p">:</span>
    <span class="n">ros__parameters</span><span class="p">:</span>
      <span class="n">update_frequency</span><span class="p">:</span> <span class="mf">1.0</span>
      <span class="n">publish_frequency</span><span class="p">:</span> <span class="mf">1.0</span>
      <span class="n">global_frame</span><span class="p">:</span> <span class="nb">map</span>
      <span class="n">robot_base_frame</span><span class="p">:</span> <span class="n">base_link</span>
      <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">robot_radius</span><span class="p">:</span> <span class="mf">0.22</span>
      <span class="n">resolution</span><span class="p">:</span> <span class="mf">0.05</span>
      <span class="n">track_unknown_space</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">plugins</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">static_layer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">obstacle_layer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">inflation_layer</span><span class="sh">"</span><span class="p">]</span>
      <span class="n">obstacle_layer</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_costmap_2d::ObstacleLayer</span><span class="sh">"</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="bp">True</span>
        <span class="n">observation_sources</span><span class="p">:</span> <span class="n">scan</span>
        <span class="n">scan</span><span class="p">:</span>
          <span class="n">topic</span><span class="p">:</span> <span class="o">/</span><span class="n">scan</span>
          <span class="n">max_obstacle_height</span><span class="p">:</span> <span class="mf">2.0</span>
          <span class="n">clearing</span><span class="p">:</span> <span class="bp">True</span>
          <span class="n">marking</span><span class="p">:</span> <span class="bp">True</span>
          <span class="n">data_type</span><span class="p">:</span> <span class="sh">"</span><span class="s">LaserScan</span><span class="sh">"</span>
          <span class="n">raytrace_max_range</span><span class="p">:</span> <span class="mf">3.0</span>
          <span class="n">raytrace_min_range</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="n">obstacle_max_range</span><span class="p">:</span> <span class="mf">2.5</span>
          <span class="n">obstacle_min_range</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">static_layer</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_costmap_2d::StaticLayer</span><span class="sh">"</span>
        <span class="n">map_subscribe_transient_local</span><span class="p">:</span> <span class="bp">True</span>
      <span class="n">inflation_layer</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_costmap_2d::InflationLayer</span><span class="sh">"</span>
        <span class="n">cost_scaling_factor</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="n">inflation_radius</span><span class="p">:</span> <span class="mf">0.55</span>
      <span class="n">always_send_full_costmap</span><span class="p">:</span> <span class="bp">True</span>

  <span class="n">global_costmap_client</span><span class="p">:</span>
    <span class="n">ros__parameters</span><span class="p">:</span>
      <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">global_costmap_rclcpp_node</span><span class="p">:</span>
    <span class="n">ros__parameters</span><span class="p">:</span>
      <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">map_server</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">yaml_filename</span><span class="p">:</span> <span class="sh">"</span><span class="s">house.yaml</span><span class="sh">"</span>

<span class="n">map_saver</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">save_map_timeout</span><span class="p">:</span> <span class="mf">5.0</span>
    <span class="n">free_thresh_default</span><span class="p">:</span> <span class="mf">0.25</span>
    <span class="n">occupied_thresh_default</span><span class="p">:</span> <span class="mf">0.65</span>
    <span class="n">map_subscribe_transient_local</span><span class="p">:</span> <span class="bp">True</span>

<span class="n">planner_server</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">expected_planner_frequency</span><span class="p">:</span> <span class="mf">20.0</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">planner_plugins</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">GridBased</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">GridBased</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_navfn_planner/NavfnPlanner</span><span class="sh">"</span>
      <span class="n">tolerance</span><span class="p">:</span> <span class="mf">0.5</span>
      <span class="n">use_astar</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">allow_unknown</span><span class="p">:</span> <span class="n">true</span>

<span class="n">planner_server_rclcpp_node</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">smoother_server</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">smoother_plugins</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">simple_smoother</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">simple_smoother</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_smoother::SimpleSmoother</span><span class="sh">"</span>
      <span class="n">tolerance</span><span class="p">:</span> <span class="mf">1.0e-10</span>
      <span class="n">max_its</span><span class="p">:</span> <span class="mi">1000</span>
      <span class="n">do_refinement</span><span class="p">:</span> <span class="bp">True</span>

<span class="n">behavior_server</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">costmap_topic</span><span class="p">:</span> <span class="n">local_costmap</span><span class="o">/</span><span class="n">costmap_raw</span>
    <span class="n">footprint_topic</span><span class="p">:</span> <span class="n">local_costmap</span><span class="o">/</span><span class="n">published_footprint</span>
    <span class="n">cycle_frequency</span><span class="p">:</span> <span class="mf">10.0</span>
    <span class="n">behavior_plugins</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">spin</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">backup</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">drive_on_heading</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wait</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">spin</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_behaviors/Spin</span><span class="sh">"</span>
    <span class="n">backup</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_behaviors/BackUp</span><span class="sh">"</span>
    <span class="n">drive_on_heading</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_behaviors/DriveOnHeading</span><span class="sh">"</span>
    <span class="n">wait</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_behaviors/Wait</span><span class="sh">"</span>
    <span class="n">global_frame</span><span class="p">:</span> <span class="n">odom</span>
    <span class="n">robot_base_frame</span><span class="p">:</span> <span class="n">base_link</span>
    <span class="n">transform_tolerance</span><span class="p">:</span> <span class="mf">0.1</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">simulate_ahead_time</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="n">max_rotational_vel</span><span class="p">:</span> <span class="mf">1.0</span>
    <span class="n">min_rotational_vel</span><span class="p">:</span> <span class="mf">0.4</span>
    <span class="n">rotational_acc_lim</span><span class="p">:</span> <span class="mf">3.2</span>

<span class="n">robot_state_publisher</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>

<span class="n">waypoint_follower</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">loop_rate</span><span class="p">:</span> <span class="mi">20</span>
    <span class="n">stop_on_failure</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">waypoint_task_executor_plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">wait_at_waypoint</span><span class="sh">"</span>
    <span class="n">wait_at_waypoint</span><span class="p">:</span>
      <span class="n">plugin</span><span class="p">:</span> <span class="sh">"</span><span class="s">nav2_waypoint_follower::WaitAtWaypoint</span><span class="sh">"</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="bp">True</span>
      <span class="n">waypoint_pause_duration</span><span class="p">:</span> <span class="mi">200</span>

<span class="n">velocity_smoother</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">smoothing_frequency</span><span class="p">:</span> <span class="mf">20.0</span>
    <span class="n">scale_velocities</span><span class="p">:</span> <span class="bp">False</span>
    <span class="n">feedback</span><span class="p">:</span> <span class="sh">"</span><span class="s">OPEN_LOOP</span><span class="sh">"</span>
    <span class="n">max_velocity</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.26</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">min_velocity</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.26</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">max_accel</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">]</span>
    <span class="n">max_decel</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2</span><span class="p">]</span>
    <span class="n">odom_topic</span><span class="p">:</span> <span class="sh">"</span><span class="s">odom</span><span class="sh">"</span>
    <span class="n">odom_duration</span><span class="p">:</span> <span class="mf">0.1</span>
    <span class="n">deadband_velocity</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">velocity_timeout</span><span class="p">:</span> <span class="mf">1.0</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="多车编队-1">多车编队</h2>

<h1 id="moveit2工业机器人机械臂">Moveit2工业机器人机械臂</h1>

<p>https://moveit.ros.org/</p>

<h2 id="机器人学">机器人学</h2>

<p>https://www.bilibili.com/video/BV1v4411H7ez</p>

<p>https://www.bilibili.com/video/av59243185</p>

<h3 id="理论基础">理论基础</h3>

<h4 id="dof自由度">DOF(自由度)</h4>

<p>简单来说，自由度(以下统称为dof)指的是 <strong>物体在空间里面的基本运动方式</strong> ，总共有6种。任何运动都可以拆分成这6种基本运动方式，而这6种基本运动方式又可以分为两类： <strong>位移</strong> 和 <strong>旋转</strong> 。</p>

<p>位移：X轴、Y轴、Z轴的平动</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1834.webp" alt="" /></p>

<p>旋转：Roll横滚角(绕X转动)、Pitch俯仰角(绕Y转动)、Yaw航向角(绕Z转动)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1835.webp" alt="" /></p>

<h3 id="数理基础">数理基础</h3>

<h4 id="位姿位置与姿态的表示">位姿（位置与姿态）的表示</h4>

<p>倘若在一个空间里有一个刚体（frame），我们如何确定刚体在这个空间里的位姿呢？</p>

<p>首先要建立一个世界坐标系（world frame），然后要在刚体上建立刚体坐标系（body frame）.</p>

<ol>
  <li><strong>位置的描述</strong></li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1836.webp" alt="" /></p>

<p>描述刚体的质心(一个点)在世界中的位置，就可以用一个3X1向量来表示.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1837.webp" alt="" /></p>

<p>这样就知道了平动的三个DOF。</p>

<ol>
  <li><strong>方位的描述</strong></li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1838.webp" alt="" /></p>

<p>设世界坐标系为A，刚体坐标系为B。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1839.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1840.webp" alt="" /></p>

<p>上面这个矩阵就叫旋转矩阵（Rotation Matrix），是一个3*3的正交矩阵，ABR描述的是A为参考坐标系，B相对于A的方向。</p>

<p>每一个列向量，都代表B的对应坐标轴各自指向的方向。</p>

<p>每一列向量都是B的对应的坐标轴相对于A的方向余弦（Direct Cosines）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1841.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1842.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1843.webp" alt="" /></p>

<p>旋转矩阵的每个元素 r ij代表 B 的第 j 轴与 A 的第 i 轴的方向余弦.</p>

<p>实在看不懂，先来看下面来看例子：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1844.webp" alt="" /></p>

<p>B的X轴在A中怎么表示？可以看出来，B的X正好是A的Z轴的负半轴，那就是0，0，-1.</p>

<p>B的Y轴在A中怎么表示？可以看出来，B的Y正好是A的Y轴的正半轴，那就是0，1，0.</p>

<p>B的Z轴在A中怎么表示？可以看出来，B的Z正好是A的X轴的正半轴，那就是1，0，0.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1845.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1846.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1847.webp" alt="" /></p>

<p>这个例子里，AB的Z重合了，所以我们只看上视图就可以了。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1848.webp" alt="" /></p>

<p>就是把XB这个单位向量，投影到A的X和Y上看分量即可。</p>

<p>同理YB也一样。</p>

<p>ZB和ZA重合，比较简单。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1849.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1850.webp" alt="" /></p>

<p>答案是B。</p>

<ol>
  <li><strong>位姿的描述</strong></li>
</ol>

<p>通过BF在WF的状态，就可以知道刚体在世界中的位姿。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1851.webp" alt="" /></p>

<ol>
  <li>运动的描述</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1852.webp" alt="" /></p>

<p>红色是刚体运动的轨迹线，</p>

<p>轨迹（平动DOF）对时间的微分(导数)，就是刚体线速度。</p>

<p>刚体速度再对时间的微分(导数)，就是刚体线加速度。</p>

<p>同理,转动DOF对时间的微分(导数)，就是刚体的角速度。</p>

<p>角速度再对时间的微分(导数)，就是刚体角加速度。</p>

<h4 id="旋转矩阵">旋转矩阵</h4>

<p>特性：</p>

<p>由于旋转矩阵R里每个元素都是两个向量内积，内积是可以交换位置且最后结果<strong>数值不变</strong>的。</p>

<p>所以我们选择交换位置。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1853.webp" alt="" /></p>

<p>原始的R是每一 <strong>列</strong> 都是B的某一轴在A系的分量。</p>

<p>交换位置后的R是每一 <strong>行</strong> 都是A的某一轴在B系的分量。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1854.webp" alt="" /></p>

<p>结论：所以说Rab = Rba的T。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1855.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1856.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1857.webp" alt="" /></p>

<p>他俩明显是转置关系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1858.webp" alt="" /></p>

<p>RT*R=I3（3*3单位阵）(正交阵orthogonal matrix的性质)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1859.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1860.webp" alt="" /></p>

<table>
  <tbody>
    <tr>
      <td>还有个性质就是</td>
      <td>R</td>
      <td>=1</td>
    </tr>
  </tbody>
</table>

<p>虽然有9个数字，但是啊，因为正交阵的性质，所以是有约束条件的，这9个数字里有6个数字是随着其他数字变化而变化的，所以这9个数字实际上只有3个参数可以任意选择，也就是旋转矩阵实际上只有3个自由度。(转动DOF)</p>

<p>旋转矩阵的一个功能如下：</p>

<p>比如说另一个坐标系B相对于A坐标系绕X,Y,Z轴各自<strong>逆时针</strong>转动theta度的旋转矩阵。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1861.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1862.webp" alt="" /></p>

<p>在中国大陆教材中，常用R(X,theta)来代替图中的RXA(theta)。图中这个A指的是原坐标系，得出来的AP`也是原坐标下的坐标。</p>

<p>这样的话，AP左乘一个R就得出来了P转动后在A系的坐标。（一定要与下面讲的旋转坐标变换分清楚，很容易混淆）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1863.webp" alt="" /></p>

<p>P逆时针转动30度后，在<strong>原坐标系</strong>中的坐标为002.</p>

<p>总结：旋转矩阵主要是三种用法，如下图：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1864.webp" alt="" /></p>

<h4 id="坐标变换-1">坐标变换</h4>

<ol>
  <li>
    <p>平移坐标变换</p>
  </li>
  <li>
    <p>旋转坐标变换</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1865.webp" alt="" /></p>

<p>这里的APX是个数值，XA等是矢量，加法是矢量加法，最后得出来的是AP向量。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1866.webp" alt="" /></p>

<p>重要结论就是AP = ABR*BP.(注意是矩阵的左乘)</p>

<p>AP就是P在A系的坐标。</p>

<p>BP就是P在B系的坐标。</p>

<p>ABR就是A为参考坐标系，B相对于A的旋转矩阵。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1867.webp" alt="" /></p>

<h4 id="物体的变换及逆变换">物体的变换及逆变换</h4>

<p>物体平动的顺序可以互相颠倒,但是物体转动的顺序不能互相颠倒,否则姿态会不一样.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1868.webp" alt="" /></p>

<p>主要是两种拆解方式,一个是设一个固定的坐标系,一直按这个坐标系转动,</p>

<p>另一个方式是假设物体的坐标系.</p>

<h3 id="机械臂描述方式">机械臂描述方式</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1869.webp" alt="" /></p>

<p>Link 0一般也叫base_Link</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1870.webp" alt="" /></p>

<p>先看好相对关系，Axis i-1的后面才是Link i - 1(当然其他描述也成立)</p>

<h3 id="描述各关节之间的关系">描述各关节之间的关系</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1871.webp" alt="" /></p>

<p>也就是公垂线(唯一解)，其长度为Link Length连杆长度</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1872.webp" alt="" /></p>

<p>现在只是限制住了两个轴的距离，两个轴还是可以转动的，所以需要下一个参数，Link Twist连杆扭角。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1873.webp" alt="" /></p>

<p>这个角就是沿中垂线，把后一个轴线沿中垂线往当前轴移动，然后形成的夹角叫Link Twist连杆扭角。</p>

<p>也就是说，针对空间中任意两个转轴，我们需要两个参数来进行描述，也就是Link Length和Link Twist。</p>

<p>如果是多个串起来的转轴，我们就无法找到对应关系了，比如说</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1874.webp" alt="" /></p>

<p>上面这个图，我没法表示ai-1与ai在轴线Axis i上的相对关系以及相对姿态是什么样子的。</p>

<p>所以还需要其他参数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1875.webp" alt="" /></p>

<p>首先肯定需要一个长度，两个公垂线在Axis i上的距离，叫做Link Offset，连杆偏距。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1876.webp" alt="" /></p>

<p>然后还需要一个角，Joint Angle连杆夹角，也叫关节角。</p>

<p>其实发现，这四个参数，只有一个参数是变化的，其他都是固定的。</p>

<p>如果ioint type是revolute joint，那么thetai变化，其他不变。</p>

<p>如果joint type是prismatic joint，那么di变化，其他不变。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1877.webp" alt="" /></p>

<p>描述两个轴需要2个参数，连杆长度与连杆扭角。</p>

<p>描述多个轴串在一起需要4个参数(每两两杆件都需要4个参数)，连杆长度Link Length，连杆扭角Link Twist，连杆偏距Link Offset，连杆夹角Joint Angle。</p>

<h3 id="在joint上建立frame">在joint上建立frame</h3>

<p>咱们一般把Z方向定义成和转轴的方向一样，Z朝上或朝下是看怎么朝向，这两个轴的夹角最小，这样就能够确定Z的方向了。</p>

<p>Xi的方向是沿着ai的方向。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1878.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1879.webp" alt="" /></p>

<p>Xi与Zi+1和Zi都垂直。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1880.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1881.webp" alt="" /></p>

<p>右手定则，判断Y方向。</p>

<p>原点是Z和X的交点。</p>

<p>若是建立base_link(link0)与link1的话，则是特殊情况。（base_link是immobile不动的）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1882.webp" alt="" /></p>

<p>frame0和frame1重叠(重合)。通常，比如说是个旋转关节，虽然规定theta是arbitrary任意的，但是我把theta固定成0，然后让frame0和frame1(theta</p>

<p>= 0)重合。如果是平动关节，那么同理也取d=0的时候的frame1。注意，这里是重叠重合，并不是形状相同，而是完全重叠的坐标系。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1883.webp" alt="" /></p>

<p>最后一个杆件，也差不多，因为Xn和Xn-1都要垂直于Axis n(Zn)，所以最简单的方法就是让Xn与Xn-1方向一致。</p>

<p>Xn取Xn-1的方向。也就是framen和framen-1是延长的。</p>

<p><strong>下面是重点中的重点：(有好几种方法判断，如有错误请讨论后修改)</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1884.webp" alt="" /></p>

<p>需要知道的常识：</p>

<ol>
  <li>
    <p>一般连杆扭角按逆时针是正值。</p>
  </li>
  <li>
    <p>我们常说的转向，是从逆着的方向去看，也就是让箭头指向眼睛的方向去看的。</p>
  </li>
  <li>
    <p>从轴的逆方向去看和顺着方向去看转向，是完全相反的方向，但是在平面上容易产生视觉错觉，难以理解。可以拿支笔或者电机，转动一下试试。</p>
  </li>
</ol>

<p>①alphai-1是正值还是负值，要看Zi-1到Zi的角是顺时针还是逆时针，伸出右手，让拇指沿Xi-1的方向，如果alphai-1顺着四指方向则为逆时针，正值，反之为顺时针，负值。</p>

<p>所以如图，alphai-1是逆时针，所以是正值。</p>

<p>②ai-1的长度因为是长度，所以永远是正值，然后值为Z轴间的相对距离。</p>

<p>③thetai的角度也基本同理，将右手大拇指沿着Zi的方向，若thetai顺着四指方向则为逆时针，逆着则为顺时针。</p>

<p>④di的大小方向要看从ai-1沿着zi的方向到ai，则是正值，反之为负值，大小即为距离。</p>

<h3 id="link-transformations">Link Transformations</h3>

<h4 id="理论">理论</h4>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1885.webp" alt="" /></p>

<p>我们两个关节都有俩轴，一个Axisi-1一个是Axisi，我们也有俩frame，一个是framei-1一个是framei。</p>

<p>我们需要找到两个frame之间的关系式是什么，也就是找到变换矩阵Transformation Matrix。</p>

<p>然后将Trans Matrix量化即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1886.webp" alt="" /></p>

<p>假设说有一个点P，他在frame i下的表达是Pi，如果我们找到了Ti-1 i的矩阵，那么就有办法，获得P在frame i-1下的表达了。</p>

<p>所以我们现在需要，用刚才找到的四个参数，转化成我们的Trans Matrix。</p>

<p>这四个参数，也就是ai-1，alphai-1，di和thetai，足以可以表达framei-1到framei了。</p>

<p>①首先在Axis i-1上，</p>

<p>先描述alpha，就把framei-1的Zi-1旋转到差不多Zi的方向，生成FrameR（只旋转Z，X不动，然后右手定则判断Y）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1887.webp" alt="" /></p>

<p>②然后描述a，</p>

<p>就把FrameR沿着ai-1的方向移动到Zi上，</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1888.webp" alt="" /></p>

<p>③再描述theta</p>

<p>我们转动frameR中的ZR，使其与ai方向相同，生成frameP（X动，Z不动，右手定则判断Y）</p>

<p>这样搞完之后，Xp的方向与Xi是相同的，Zp的方向也与Zi相同。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1889.webp" alt="" /></p>

<p>④再描述d，也就是把FrameP往上拉，最后会与Framei重合。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1890.webp" alt="" /></p>

<p>也就是从Framei - 1到Frame R，然后再到Frame Q，然后再到Frame P，最后到Frame i。一共四次转化。</p>

<p>刚才我们演示的是从Pi-1到Pi，现在我们要求的是从我们的Pi要到Pi-1，那么就是倒着左乘，先乘Tp i接着往下以此类推。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1891.webp" alt="" /></p>

<p>从连杆i到连杆i-1的坐标系间的齐次变换矩阵T i-1 i=Rot(X，aplhai-1)Trans(ai-1,0,0)Rot(Z,thetai)Trans(0,0,di)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1892.webp" alt="" /></p>

<p>左上角是3X3的旋转矩阵，所以只有角度theta和alpha参数，</p>

<p>右上角3X1的矩阵，也就是frame i的原点相对于frame i - 1的原点的向量。然后是从frame i - 1去看。所以他是长度与角度的复合。</p>

<p>最后一行的1X4的矩阵，是0001是固定数不动的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1893.webp" alt="" /></p>

<p>对于连续的杆件，我们可以从base_link一直算到linkx，x想是几就是几。</p>

<p>比如说，现在有三个杆件，我们找到T23（3对2的），T12（1对2的）T01（地对1的），就可以找到T03（地对3的）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1894.webp" alt="" /></p>

<h4 id="example">Example</h4>

<h5 id="平面rrr类型">平面RRR类型</h5>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1895.webp" alt="" /></p>

<p>①先找到关节转轴Joint Axes</p>

<p>三个转轴是三个红点，是点的话，也就是出纸面的方向。（因为，他是个平面的，所以说，每个Z轴之间的角度都是0，所以说Link Twist Alpha是0，所以Z的方向都随便取，但是咱们这里，假设关节都是逆时针旋转，按右手螺旋定则来看，Z就都朝上）</p>

<p>②再找到公垂线Common Perpendiculars</p>

<p>但是由于Axis都是互相平行的，所以说，这个公垂线有无数多条，所以我们就在一个平面内表达即可。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1896.webp" alt="" /></p>

<p>③下一步定义Zi向量（Z方向与转轴方向相同所以也是向上。）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1897.webp" alt="" /></p>

<p>④然后判断中间的Xi向量</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1898.webp" alt="" /></p>

<p>⑤然后判断中间的Yi向量</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1899.webp" alt="" /></p>

<p>⑥然后判断头和尾，也就是frame 0 和frame n</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1900.webp" alt="" /></p>

<p>其实，我们可以把frame0和frame1建的完全重合，就是让alpha和theta都为0，如图并没有重合，所以有theta大小。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1901.webp" alt="" /></p>

<p>最后一个杆件也一样，建议让X3的方向和X2方向重合，这样的话，theta和alpha都是0。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1902.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1903.webp" alt="" /></p>

<p>因为每个轴都是平行的，所以alpha是0，由于ai都是同平面的，所以d也为0.</p>

<p>因为frame0和frame1重合，所以a0 = 0，然后a1 = L1，a2 = L2</p>

<p>由于全是RRR，所以，theta都是变化的角。</p>

<p>P点末端执行器，也可以算出，沿X3方向走，获得P在frame n的表达，然后就可以推出P在frame 0中的表达了。</p>

<p>如图的，P点在Frame3里的坐标是（L3，0，0）</p>

<h5 id="rpr类型">RPR类型</h5>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1904.webp" alt="" /></p>

<p>①先找到转轴</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1905.webp" alt="" /></p>

<p>按右手螺旋来。</p>

<p>②找公垂线</p>

<p>因为frame1的Z1和frame2的Z2相交，所以，没有公垂线。</p>

<p>frame2的Z2和frame3的Z3重合，所以也没有公垂线。</p>

<p>也就是说a全是0.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1906.webp" alt="" /></p>

<p>③建立Zi向量</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1907.webp" alt="" /></p>

<p>Zi方向与转轴方向相同。</p>

<p>④Xi的向量</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1908.webp" alt="" /></p>

<p>当Z1和Z2相交时，我们挑X的方向就挑和Z1和Z2都垂直的，有两种方案，要么X往前，要么往后，如图是往后的。</p>

<p>X1和X2必须平行，因为是个P类型的关节</p>

<p>⑤Y轴</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1909.webp" alt="" /></p>

<p>⑥Frame 0和frame n</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1910.webp" alt="" /></p>

<p>frame 0 和frame1重合</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1911.webp" alt="" /></p>

<p>让X3方向与X2方向相同</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1912.webp" alt="" /></p>

<p>如图，驱动的关节参数分别是theta1，d2，theta3</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1913.webp" alt="" /></p>

<p>由于frame0和frame1重合，那么alpha0 = 0，</p>

<p>从Z1到Z2的角，伸右手大拇指指向X1，然后四指与Z1到Z2方向相同，所以是逆时针，为正值，所以是90度。</p>

<p>然后fame2到frame3，Z共线，所以alpha2=0</p>

<p>然后由于Zi有的相交，有的共线，所以a全是0</p>

<p>然后d1是0，因为frame0和frame1重合，</p>

<p>d2是d2，d3是L2（d是X在Axis上的距离）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1914.webp" alt="" /></p>

<p>P点在Frame3上的坐标为（0，0，L3）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1915.webp" alt="" /></p>

<p>其实Z方向有俩选择，X也有俩选择，一共四种选择，选择自己好理解，好计算的方案即可。</p>

<h5 id="中国台积电晶圆机器人prrr类型4个自由度">中国台积电晶圆机器人(PRRR类型4个自由度)</h5>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1916.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1917.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1918.webp" alt="" /></p>

<h5 id="scara机器人rrrp类型4个自由度">SCARA机器人(RRRP类型4个自由度)</h5>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1919.webp" alt="" /></p>

<p>该机器人最后一个关节是既可以R又可以P的，所以是个RP关节，既可以先算R也可以先算P。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1920.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1921.webp" alt="" /></p>

<h5 id="rp类型">RP类型</h5>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1922.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1923.webp" alt="" /></p>

<p>选D，因为俩自由度，所以有俩驱动参数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1924.webp" alt="" /></p>

<h3 id="执行器关节与笛卡尔空间actuator-joint-and-cartesian-spaces">执行器关节与笛卡尔空间(Actuator Joint and Cartesian Spaces)</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1925.webp" alt="" /></p>

<p>我们这里的驱动是theta1-3，</p>

<p>当我们知道theta1-3的值之后，我们就会知道P点在世界坐标系上的表达。</p>

<p>这被叫做正向运动学（Forward Kinematics）。</p>

<p>由P点世界坐标系反算关节角度，那么叫逆向运动学（Inverse Kinematics）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1926.webp" alt="" /></p>

<p>Actuator Space就是驱动器空间，比如一个电机怎么操控能转joint space下的固定角（经过一系列转换）。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1927.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1928.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1929.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1930.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1931.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1932.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1933.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1934.webp" alt="" /></p>

<p>有转动有移动的部分（所以需要两个电机来达到这两个自由度）</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1935.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1936.webp" alt="" /></p>

<p>同步带机构使其旋转。（第一个电机）</p>

<p>齿轮齿条机构达到上下移动。（第二个电机）</p>

<p>但是，这两个并不是独立的，因为是同轴驱动的，所以有些负荷。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1937.webp" alt="" /></p>

<p>两个转动变成一个转动一个移动。</p>

<h3 id="正运动学">正运动学</h3>

<p><strong>定义</strong> ：已知机器人各个关节（或轮子等驱动单元）的运动参数（如角度、位移、速度等），计算末端执行器的位置和姿态。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1938.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1939.webp" alt="" /></p>

<p>ads=dv/dt * ds = ds/dt *dv = vdv</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1940.webp" alt="" /></p>

<p>牛顿第二定律，能量守恒，冲量与动量</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1941.webp" alt="" /></p>

<p>Wp就是P点在世界坐标系下的坐标</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1942.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1943.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1944.webp" alt="" /></p>

<p>可以根据该公式，得知末端执行器在世界坐标系中的坐标。</p>

<h3 id="逆运动学">逆运动学</h3>

<p><strong>定义</strong> ：已知末端执行器的目标位置和姿态，计算需要让各个关节（或轮子等驱动单元）运动到什么角度或速度才能达到该目标。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1945.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1946.webp" alt="" /></p>

<p>先知道末端执行器的某个点P在世界坐标系中的表达，也就是给出Pw或者末端执行器某个点上的frameH，</p>

<p>通过Pw求出theta。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1947.webp" alt="" /></p>

<p>这样手臂就有6个未知数</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1948.webp" alt="" /></p>

<p>16个数字，转动的部分占了9个数字，也就是左上角的3X3的旋转矩阵，然后右上角3X1的向量表示相对于原点的位移量是什么。（也就是frame6的原点相对于frame0的原点位移量是什么）</p>

<p>下面的0001是整数，固定的，不变的。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1949.webp" alt="" /></p>

<p>这个旋转矩阵里，有3个长度条件，3个互相垂直条件，所以9个数字里，就剩3个自由度。（也就是向量长度为1限制3个，向量两两垂直限制3个，所以是平移矩阵，3个自由度）</p>

<p>然后右上角3X1的向量中，相对原点的坐标X,Y,Z,那么就是3个自由度。</p>

<p>所以总共有6个自由度。</p>

<p>这12个方程式就是除了低下的0001，上面的参数都可以列一个式子。我们要做的，就是从12个式子中求出6个未知数。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1950.webp" alt="" /></p>

<p>灵活工作空间Dexterous workspace是可达工作空间Reachable workspace的子集。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1951.webp" alt="" /></p>

<p>它的可达工作空间是个圆环。</p>

<p>对于某个点，在这个例子中，只有1种或2种姿态可以达到。这个机器人只有RWS，没有DWS。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1952.webp" alt="" /></p>

<p>手臂一样长的话，那样工作空间就是个圆了，</p>

<p>有一个点就是DWS,就是原点，当手臂内折，那么可以以360度任意一个角度来达到这个点，所以该点就是DWS。</p>

<h1 id="microros-1">MicroROS</h1>

<p>https://micro.ros.org/</p>

<p>没啥必要，串口够用了。</p>

<p>除非你想极低成本跑ROS2,比如说车上只放一个ESP32或者STM32跑MicroROS，然后电脑跑ROS2在旁边运行其他需要大型计算的节点。</p>

<h1 id="ros2_control">ROS2_Control</h1>

<p>官网:</p>

<p>https://control.ros.org/humble/index.html</p>

<p>仓库:https://github.com/ros-controls/ros2_control</p>

<p>第三方功能包（开发者:@brainyuan:https://b23.tv/L0sEXPL）:https://github.com/Factor-Robotics/odrive_ros2_control</p>

<h1 id="webots仿真平台">Webots仿真平台</h1>

<p>这个平台用来测运动学很舒服。</p>

<p>可以SolidWorks转URDF（ROS官方提供sw2udfo工具），再URDF转Webots（webots官方提供urdf2webots工具）。</p>

<p>https://github.com/ros/solidworks_urdf_exporter</p>

<p>https://github.com/cyberbotics/urdf2webots</p>

<p>这样的话，连电机甚至都给你选好了，你只需要写运动学即可。</p>

<p>运动控制程序可以用C/C++、Python、Java等语言编写，控制的时候只需要注意一下控制电机角度和速度的方式以及单位即可。</p>

<p>如果你给电机setPosition(INFINITY)的话，那么这个电机将变成角度电机，而原本设置速度的函数将会变成设置角速度。</p>

<p>如果你没给电机设置setPosition(INFINITY)，那么这个电机就是个速度电机。</p>

<p>角度单位是rad（存疑）</p>

<p>速度单位是rad/s（存疑）</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="c1">//舵电机仿真中默认顺时针为正</span>
                <span class="n">swerve_motor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">robot</span><span class="o">-&gt;</span><span class="n">getMotor</span><span class="p">(</span><span class="s">"swerve_joint"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                <span class="c1">//swerve_motor[i]-&gt;setPosition(INFINITY);       // 注释掉：不启用速度控制</span>
                <span class="n">swerve_motor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">setPosition</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>       <span class="c1">// 初始角度为0</span>
                <span class="n">swerve_motor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">setVelocity</span><span class="p">(</span><span class="mf">50.0</span><span class="p">);</span>       <span class="c1">// 设置角速度</span>

                <span class="c1">//驱动电机仿真中默认向后滚为正</span>
                <span class="n">drive_motor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">robot</span><span class="o">-&gt;</span><span class="n">getMotor</span><span class="p">(</span><span class="s">"drive_joint"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                <span class="n">drive_motor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">setPosition</span><span class="p">(</span><span class="n">INFINITY</span><span class="p">);</span>   <span class="c1">// 启用速度控制</span>
                <span class="n">drive_motor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">setVelocity</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">);</span>        <span class="c1">// 初始速度为0</span>
        <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="opencv-1">OpenCV</h1>

<h2 id="opencv-2">OpenCV</h2>

<p><a href="https://sdutvincirobot.feishu.cn/wiki/D50twQJ2UiVvaDky8Sic3aPOnEh">基础视觉算法-OpenCV实现</a></p>

<h2 id="cv_bridge">CV_Bridge</h2>

<p>cv_bridge维基百科介绍:</p>

<p>https://wiki.ros.org/cv_bridge</p>

<p>https://index.ros.org/p/cv_bridge/</p>

<p>ROS2Humble的cv_bridge仓库链接(注意选择对应版本的分支branches):</p>

<p>https://github.com/ros-perception/vision_opencv/tree/humble</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1953.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1954.webp" alt="" /></p>

<h3 id="安装">安装</h3>

<p>提前自己编译好带CUDA的OpenCV4,详见<a href="https://sdutvincirobot.feishu.cn/wiki/FQszwXIR5iQgCfk7pRwc9rYpnqg">电控组环境搭建大全</a></p>

<ol>
  <li>apt安装(不建议)</li>
</ol>

<p>由于ros自带的cv_bridge自动链接ros自带的oepncv版本,所以我们一般不会用ros2自带的cv_bridge,一般都需要自己手动编译一个cv_bridge.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c1"># 通用命令</span>
sudo apt install ros-&lt;ros2-distro&gt;-vision-opencv

<span class="c1"># ROS2 Humble</span>
sudo apt install ros-humble-vision-opencv

<span class="c1"># ROS2 Jazzy</span>
sudo apt install ros-jazzy-vision-opencv
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>源码编译安装(建议)</li>
</ol>

<p>本教程以jazzy为例子.</p>

<p>首先克隆仓库,克隆jazzy,humble,rolling都可以,只要是ROS2的基本都没啥大变化.但是官方暂时没出jazzy,我就直接克隆默认的rolling了.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1955.webp" alt="" /></p>

<p>新建一个文件夹</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>mkdir ~/ros2_ws/src
cd ~/ros2_ws/src

<span class="c1"># 克隆源码</span>
git clone https://github.com/ros-perception/vision_opencv.git
cd vision_opencv

<span class="c1"># 如果是humble建议:</span>
git checkout humble
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装依赖:</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>sudo apt install python3-numpy
sudo apt install libboost-python-dev
</pre></td></tr></tbody></table></code></pre></div></div>

<p>修改cv_bridge的CMakeLists</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1956.webp" alt="" /></p>

<p>将原本的<code class="language-plaintext highlighter-rouge">find_package(OpenCV 4 QUIET)</code>改为精确匹配版本，并添加<code class="language-plaintext highlighter-rouge">EXACT</code>参数：</p>

<p>EXACT是未找到精确版本时，CMake会报错并终止构建.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1957.webp" alt="" /></p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nb">find_package</span><span class="p">(</span>OpenCV 4.11 EXACT QUIET
  COMPONENTS
    opencv_core
    opencv_imgproc
    opencv_imgcodecs
  CONFIG
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>cd ~/ros2_ws

<span class="c1"># 下面这三个根据情况三选一,一般是第一个colcon build --symlink-install</span>

<span class="c1"># 如果你曾经没编译过</span>
colcon build --symlink-install

<span class="c1"># 如果你只想编译cv_bridge</span>
colcon build --symlink-install --packages-select cv_bridge

<span class="c1"># 如果你曾经编译过一遍,则需要下列命令</span>
colcon build --symlink-install --packages-select cv_bridge --allow-overriding cv_bridge
</pre></td></tr></tbody></table></code></pre></div></div>

<p>验证:</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c1"># 列出cv_bridge链接的opencv版本</span>
ldd ./install/cv_bridge/lib/libcv_bridge.so | grep opencv 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如下图,我的成功链接到411了,也就是opencv4.11版本.</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/30/image1958.webp" alt="" /></p>

<p>接下来配置环境:</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在<code class="language-plaintext highlighter-rouge">source /opt/ros/jazzy/setup.bash</code>的下一行加入下面这句</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>source ~/ros2_ws/install/setup.bash
</pre></td></tr></tbody></table></code></pre></div></div>

<p>输入<code class="language-plaintext highlighter-rouge">:wq</code>保存</p>

<p>完成安装与环境配置结束.</p>]]></content><author><name>Tung Chia-hui</name></author><category term="ROS" /></entry><entry><title type="html">Git教程</title><link href="https://jekyll.tungchiahui.cn/blog/git-tutorial/" rel="alternate" type="text/html" title="Git教程" /><published>2023-12-29T00:00:00+00:00</published><updated>2023-12-29T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/Git%E6%95%99%E5%AD%A6</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/git-tutorial/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#git简介" id="markdown-toc-git简介">Git简介</a></li>
  <li><a href="#git实操" id="markdown-toc-git实操">Git实操</a>    <ul>
      <li><a href="#环境准备" id="markdown-toc-环境准备">环境准备</a></li>
      <li><a href="#常用指令介绍" id="markdown-toc-常用指令介绍">常用指令介绍</a>        <ul>
          <li><a href="#linux创建目录并进入目录" id="markdown-toc-linux创建目录并进入目录">Linux创建目录&amp;&amp;并进入目录</a></li>
          <li><a href="#设置git的用户与邮箱必须设置" id="markdown-toc-设置git的用户与邮箱必须设置">设置git的用户与邮箱(必须设置！！！)</a></li>
          <li><a href="#git初始化使该文件夹被git控制" id="markdown-toc-git初始化使该文件夹被git控制">git初始化(使该文件夹被git控制)</a></li>
          <li><a href="#创建文件查看当前文件夹内的所有文件" id="markdown-toc-创建文件查看当前文件夹内的所有文件">创建文件&amp;&amp;查看当前文件夹内的所有文件</a></li>
          <li><a href="#编辑文件文本内容" id="markdown-toc-编辑文件文本内容">编辑文件文本内容</a></li>
          <li><a href="#查询当前文件的状态" id="markdown-toc-查询当前文件的状态">查询当前文件的状态</a></li>
          <li><a href="#将文件提交到暂存区" id="markdown-toc-将文件提交到暂存区">将文件提交到暂存区</a></li>
          <li><a href="#将文件提交至本地仓库" id="markdown-toc-将文件提交至本地仓库">将文件提交至本地仓库</a></li>
          <li><a href="#查看已经提交的项目版本" id="markdown-toc-查看已经提交的项目版本">查看已经提交的项目版本</a></li>
          <li><a href="#可以尝试对文件内容进行修改并再次进行提交" id="markdown-toc-可以尝试对文件内容进行修改并再次进行提交">可以尝试对文件内容进行修改，并再次进行提交</a></li>
          <li><a href="#如何忽略掉不想提交的文件" id="markdown-toc-如何忽略掉不想提交的文件">如何忽略掉不想提交的文件</a></li>
          <li><a href="#分支基本操作" id="markdown-toc-分支基本操作">分支基本操作</a></li>
          <li><a href="#分支的合并" id="markdown-toc-分支的合并">分支的合并</a></li>
          <li><a href="#分支合并的冲突" id="markdown-toc-分支合并的冲突">分支合并的冲突</a></li>
          <li><a href="#远程仓库github" id="markdown-toc-远程仓库github">远程仓库Github</a></li>
        </ul>
      </li>
      <li><a href="#vscode--git" id="markdown-toc-vscode--git">VScode + Git</a>        <ul>
          <li><a href="#vscode是什么" id="markdown-toc-vscode是什么">VScode是什么？</a></li>
          <li><a href="#vscode官网" id="markdown-toc-vscode官网">VScode官网:</a></li>
          <li><a href="#linux环境下配置c环境教程" id="markdown-toc-linux环境下配置c环境教程">Linux环境下配置C++环境教程:</a></li>
          <li><a href="#创建文件夹并在该文件夹下打开vscode" id="markdown-toc-创建文件夹并在该文件夹下打开vscode">创建文件夹并在该文件夹下打开VScode</a></li>
          <li><a href="#新建文件" id="markdown-toc-新建文件">新建文件</a></li>
          <li><a href="#初始化git类似于git-init命令" id="markdown-toc-初始化git类似于git-init命令">初始化Git(类似于git init命令)</a></li>
          <li><a href="#将文件提交到暂存区类似git-add" id="markdown-toc-将文件提交到暂存区类似git-add">将文件提交到暂存区(类似git add)</a></li>
          <li><a href="#取消提交到暂存区点减号这里不取消" id="markdown-toc-取消提交到暂存区点减号这里不取消">取消提交到暂存区点减号(这里不取消)</a></li>
          <li><a href="#进行提交类似于commit" id="markdown-toc-进行提交类似于commit">进行提交(类似于commit)</a></li>
          <li><a href="#创建新分支并进入新分支" id="markdown-toc-创建新分支并进入新分支">创建新分支，并进入新分支</a></li>
          <li><a href="#修改内容" id="markdown-toc-修改内容">修改内容</a></li>
          <li><a href="#查看历史版本对比点击文件" id="markdown-toc-查看历史版本对比点击文件">查看历史版本对比(点击文件)</a></li>
          <li><a href="#提交" id="markdown-toc-提交">提交</a></li>
          <li><a href="#切换回main分支" id="markdown-toc-切换回main分支">切换回main分支</a></li>
          <li><a href="#合并分支" id="markdown-toc-合并分支">合并分支</a></li>
          <li><a href="#push到github远程仓库" id="markdown-toc-push到github远程仓库">Push到Github远程仓库</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#高级工具" id="markdown-toc-高级工具">高级工具</a>    <ul>
      <li><a href="#vcs批量导入仓库" id="markdown-toc-vcs批量导入仓库">vcs批量导入仓库</a></li>
      <li><a href="#github代理" id="markdown-toc-github代理">Github代理</a></li>
      <li><a href="#搭建博客" id="markdown-toc-搭建博客">搭建博客</a></li>
    </ul>
  </li>
  <li><a href="#常见问题" id="markdown-toc-常见问题">常见问题</a>    <ul>
      <li><a href="#commit到本地的想直接取消" id="markdown-toc-commit到本地的想直接取消">commit到本地的想直接取消</a></li>
    </ul>
  </li>
</ul>

<p>本教程主要是Git的安装及使用。</p>

<h1 id="git简介">Git简介</h1>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image1.webp" alt="" /></p>

<p>其他参考资料：</p>

<table>
  <tbody>
    <tr>
      <td>【Git工作流和核心原理</td>
      <td>GitHub基本操作</td>
      <td>VS Code里使用Git和关联GitHub-哔哩哔哩】</td>
    </tr>
  </tbody>
</table>

<p>https://b23.tv/ziyw5jd</p>

<p>https://www.runoob.com/git/git-tutorial.html</p>

<h1 id="git实操">Git实操</h1>

<h2 id="环境准备">环境准备</h2>

<ol>
  <li>
    <p>操作系统: Linux,Windows,MacOS(本文以Linux为教程)</p>
  </li>
  <li>
    <p>安装Git</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>git
git <span class="nt">--version</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image2.webp" alt="" /></p>

<h2 id="常用指令介绍">常用指令介绍</h2>

<h3 id="linux创建目录并进入目录">Linux创建目录&amp;&amp;并进入目录</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> hellogit
<span class="nb">cd </span>hellogit
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image3.webp" alt="" /></p>

<h3 id="设置git的用户与邮箱必须设置">设置git的用户与邮箱(必须设置！！！)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git config <span class="nt">--global</span> user.name <span class="s2">"tungchiahui"</span>
git config <span class="nt">--global</span> user.email tungchiahui@gmail.com
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="git初始化使该文件夹被git控制">git初始化(使该文件夹被git控制)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git init
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image4.webp" alt="" /></p>

<h3 id="创建文件查看当前文件夹内的所有文件">创建文件&amp;&amp;查看当前文件夹内的所有文件</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">touch </span>test.md
<span class="nb">ls</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image5.webp" alt="" /></p>

<h3 id="编辑文件文本内容">编辑文件文本内容</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>vim
vim ./test.md
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image6.webp" alt="" /></p>

<p>接下来按键盘上的insert按键进入编辑模式&amp;&amp;并输入一段文本</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image7.webp" alt="" /></p>

<p>按ESC退出编辑模式</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image8.webp" alt="" /></p>

<p>按shift+冒号按键，并输入wq回车进行保存退出</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image9.webp" alt="" /></p>

<h3 id="查询当前文件的状态">查询当前文件的状态</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git status
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image10.webp" alt="" /></p>

<p>On branch 分支名</p>

<p>Untracked是指文件在工作区</p>

<h3 id="将文件提交到暂存区">将文件提交到暂存区</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git add test.md
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image11.webp" alt="" /></p>

<h3 id="将文件提交至本地仓库">将文件提交至本地仓库</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git commit <span class="nt">-m</span> <span class="s2">"version1"</span>  
<span class="c">#git commit -m "提交的信息(可以理解为是注释)"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image12.webp" alt="" /></p>

<h3 id="查看已经提交的项目版本">查看已经提交的项目版本</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git log
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image13.webp" alt="" /></p>

<p>这几行的意思是tungchiahui(邮箱为tungchiahui@gmail.com)用户于2023年12月30日周六00:42:47往master分支提交了注解为”version1”的项目版本</p>

<h3 id="可以尝试对文件内容进行修改并再次进行提交">可以尝试对文件内容进行修改，并再次进行提交</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>vim test.md
git add test.md
git commit <span class="nt">-m</span> <span class="s2">"version2"</span>
git log
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image14.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image15.webp" alt="" /></p>

<h3 id="如何忽略掉不想提交的文件">如何忽略掉不想提交的文件</h3>

<ol>
  <li>
    <p>首先创建一个文件.gitignore</p>
  </li>
  <li>
    <p>再创建一个文件 绝密文件不想开源.py 并修改里面的内容</p>
  </li>
  <li>
    <p>查看git状态</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">touch</span> .gitignore
<span class="nb">touch </span>vinci_secret.py
vim vinci_secret.py
git status
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image16.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image17.webp" alt="" /></p>

<ol>
  <li>修改.gitignore的内容，将不想被提交的文件名写入该文件</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>vim .gitignore
git status
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image18.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image19.webp" alt="" /></p>

<h3 id="分支基本操作">分支基本操作</h3>

<ol>
  <li>
    <p>分支的作用:开辟项目的一个新仓库分支，与master等其他分支是独立的，可以进行独立的add、commit和diff、clone。</p>
  </li>
  <li>
    <p>创建分支</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git branch route2
<span class="c">#git branch 分支名</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>进入分支</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git checkout route2
<span class="c">#git checkout 分支名</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>查询有多少分支，并查询目前为哪一个分支</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git branch
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image20.webp" alt="" /></p>

<p>当前分支文件会完美继承master分支的文件</p>

<ol>
  <li>删除掉该分支下的文件</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">ls
rm</span> <span class="nt">-rf</span> test.md
<span class="nb">rm</span> <span class="nt">-rf</span> vinci_secret.py
<span class="nb">ls</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image21.webp" alt="" /></p>

<ol>
  <li>将该分支往本地仓库进行提交</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git commit <span class="nt">-a</span> <span class="nt">-m</span> <span class="s2">"删库跑路"</span>
<span class="c">#该指令是把git add和git commit指令一起写</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image22.webp" alt="" /></p>

<ol>
  <li>查看分支是否对其他分支有影响(切换到其他分支查看影响)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git checkout master
<span class="nb">ls</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image23.webp" alt="" /></p>

<p>可以发现，在route2分支中被删掉的test.md文件回来了，但是同样被删掉的vinci_sercet.py文件没回来，是因为该文件在提交时被.gitignore文件屏蔽了，不会被提交到本地仓库</p>

<ol>
  <li>删除分支</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git branch <span class="nt">-D</span> route2
<span class="c">#git branch -D 分支名</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image24.webp" alt="" /></p>

<ol>
  <li>创建分支并立马切换到分支</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git checkout <span class="nt">-b</span> route3
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image25.webp" alt="" /></p>

<h3 id="分支的合并">分支的合并</h3>

<ol>
  <li>在route3分支中修改文件内容并提交</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>vim test.md
git commit <span class="nt">-am</span> <span class="s2">"route3 version3"</span>
<span class="c">#-a -m也可以被省略成-am</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image26.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image27.webp" alt="" /></p>

<ol>
  <li>切换到master分支</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git checkout master
vim test.md
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image28.webp" alt="" /></p>

<ol>
  <li>将route3分支合并到当前分支上</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>git merge route3
<span class="c">#git merge 被合并的分支名</span>
vim test.md
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image29.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image30.webp" alt="" /></p>

<h3 id="分支合并的冲突">分支合并的冲突</h3>

<ol>
  <li>为master添加一行内容，并提交</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>vim test.md
git commit <span class="nt">-am</span> <span class="s2">"master version4"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image31.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image32.webp" alt="" /></p>

<ol>
  <li>切换到route3分支，并添加内容并提交</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>git checkout route3
vim test.md
git commit <span class="nt">-am</span> <span class="s2">"route3 version4"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image33.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image34.webp" alt="" /></p>

<ol>
  <li>合并分支</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git merge master
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image35.webp" alt="" /></p>

<p>发生了内容冲突，需要手动修改文本冲突才可以！或者其他办法也可以解决，可以查询百度。</p>

<h3 id="远程仓库github">远程仓库Github</h3>

<ol>
  <li>
    <p>打开github官网：https://github.com(如果你打不开，请自己找办法打开)</p>
  </li>
  <li>
    <p>注册并登录账号</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image36.webp" alt="" /></p>

<ol>
  <li>新建远程仓库</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image37.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image38.webp" alt="" /></p>

<p>这个界面建议详细设置一下，但这里是演示，所以只设置了仓库名称，其他选项为默认操作。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image39.webp" alt="" /></p>

<p>如果上图出现，则说明已经创建成功了</p>

<ol>
  <li>进行创建文件并提交</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image40.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image41.webp" alt="" /></p>

<p>填写好文件名，文件内容，就可以点绿色按钮进行提交了。然后也可以填写提交的注释信息。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image42.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image43.webp" alt="" /></p>

<ol>
  <li>克隆远程仓库到本地</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image44.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nb">cd
mkdir </span>repo_floder
<span class="nb">cd </span>repo_floder
git clone https://github.com/tungchiahui/test_repo.git
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image45.webp" alt="" /></p>

<p>如果出错，请检查是否能正常访问github！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image46.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image47.webp" alt="" /></p>

<ol>
  <li>对文件内容进行修改</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd </span>test_repo
vim test1.md
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image48.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image49.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image50.webp" alt="" /></p>

<ol>
  <li>查看该本地仓库与哪些远程仓库有联系</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git remote <span class="nt">-v</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image51.webp" alt="" /></p>

<ol>
  <li>将本地仓库push到远程仓库</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git push
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image52.webp" alt="" /></p>

<p>这里需要你输入github的用户名与密码，用户名则为github用户名，但是密码则为github用户token，生成token的步骤如下：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image53.webp" alt="" /><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image54.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image55.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image56.webp" alt="" /></p>

<p>Note随便填，有效日期选择没有截止时间。</p>

<p>下面能勾的勾全勾上，这是权限。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image57.webp" alt="" /></p>

<p>复制token并填入password中(token在终端中输入会被隐藏，输完直接回车即可)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image58.webp" alt="" /></p>

<ol>
  <li>查看远程仓库</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image59.webp" alt="" /></p>

<p>发现文件已经被修改了！</p>

<ol>
  <li>对远程仓库内容进行修改</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image60.webp" alt="" /></p>

<ol>
  <li>将远程仓库内容拉到本地仓库</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git fetch
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image61.webp" alt="" /></p>

<ol>
  <li>查看本地与远程仓库区别</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git diff origin/main
<span class="c">#git diff 远程仓库名/分支名</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image62.webp" alt="" /></p>

<ol>
  <li>如果发现内容没问题，就可以将远程仓库内容同步到工作区</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git pull
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image63.webp" alt="" /></p>

<ol>
  <li>查看项目修改历史</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git log
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image64.webp" alt="" /></p>

<h2 id="vscode--git">VScode + Git</h2>

<h3 id="vscode是什么">VScode是什么？</h3>

<p>VScode是一个文本编辑器，类似于Vim等编辑器，但是他有图形界面，有非常多的好用的插件，而且可以集成编译器环境，最终也可以被用户自定义配置成Visual Studio那样的IDE。</p>

<h3 id="vscode官网">VScode官网:</h3>

<p>https://code.visualstudio.com/</p>

<h3 id="linux环境下配置c环境教程">Linux环境下配置C++环境教程:</h3>

<p><a href="https://sdutvincirobot.feishu.cn/docx/ANgFdRtvKoCcKDxZ2ehc5Rocnwh">Linux C++编译环境配置</a></p>

<h3 id="创建文件夹并在该文件夹下打开vscode">创建文件夹并在该文件夹下打开VScode</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image65.webp" alt="" /></p>

<h3 id="新建文件">新建文件</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image66.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image67.webp" alt="" /></p>

<h3 id="初始化git类似于git-init命令">初始化Git(类似于git init命令)</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image68.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image69.webp" alt="" /></p>

<p>U是指未追踪状态，也就是文件还在工作区</p>

<h3 id="将文件提交到暂存区类似git-add">将文件提交到暂存区(类似git add)</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image70.webp" alt="" /></p>

<h3 id="取消提交到暂存区点减号这里不取消">取消提交到暂存区点减号(这里不取消)</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image71.webp" alt="" /></p>

<p>A是added表示在暂存区</p>

<h3 id="进行提交类似于commit">进行提交(类似于commit)</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image72.webp" alt="" /></p>

<p>输入提交信息，并点对号进行commit</p>

<h3 id="创建新分支并进入新分支">创建新分支，并进入新分支</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image73.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image74.webp" alt="" /></p>

<h3 id="修改内容">修改内容</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image75.webp" alt="" /></p>

<p>显示M为修改状态</p>

<h3 id="查看历史版本对比点击文件">查看历史版本对比(点击文件)</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image76.webp" alt="" /></p>

<h3 id="提交">提交</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image77.webp" alt="" /></p>

<h3 id="切换回main分支">切换回main分支</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image78.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image79.webp" alt="" /></p>

<h3 id="合并分支">合并分支</h3>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image80.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image81.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image82.webp" alt="" /></p>

<h3 id="push到github远程仓库">Push到Github远程仓库</h3>

<ol>
  <li>输入仓库名</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image83.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image84.webp" alt="" /></p>

<ol>
  <li>打开github仓库查看</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image85.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image86.webp" alt="" /></p>

<h1 id="高级工具">高级工具</h1>

<h2 id="vcs批量导入仓库">vcs批量导入仓库</h2>

<ol>
  <li>安装</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># debian系</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>python3-vcstool

<span class="c"># rhel系</span>
<span class="nb">sudo </span>dnf <span class="nb">install </span>python3-vcstool

<span class="c"># pip3安装</span>
pip3 <span class="nb">install </span>vcstool
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>文件格式</li>
</ol>

<p>文件扩展名为<code class="language-plaintext highlighter-rouge">.repos</code>或者<code class="language-plaintext highlighter-rouge">.yaml</code>，必须满足yaml格式，否则会报错。</p>

<p>如下，</p>

<p>repositories:是总标签</p>

<p>ros_ws是克隆完这个仓库，要把仓库里的文件放在哪一个文件夹的文件夹的名字。</p>

<p>type是仓库管理的类型，一般为git.</p>

<p>url是仓库地址</p>

<p>version是分支名</p>

<pre><code class="language-YAML">repositories:
  ros_ws:
    type: git
    url: https://github.com/tungchiahui/ROS_WS.git
    version: main
  oepncv_projects:
    type: git
    url: https://github.com/tungchiahui/OpenCV_Projects.git
    version: main
</code></pre>

<p>以下是一个总示例：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="na">repositories</span><span class="pi">:</span>
  <span class="na">tungchiahui</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/tungchiahui/tungchiahui.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">ros_ws</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/tungchiahui/ROS_WS.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">oepncv_projects</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/tungchiahui/OpenCV_Projects.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">stm32_projetcts</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/tungchiahui/STM32_Projects.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">mdk6_template</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/tungchiahui/CubeMX_MDK5to6_Template.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">master</span>
  <span class="na">serial_pack</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/tungchiahui/Serial_Pack.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">ros-docker</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/tungchiahui/ros-docker.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">CyberRobotROS</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/CyberNaviRobot/CyberRobot_ROS2_Jazzy_WS.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">CyberRobotMCU</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/CyberNaviRobot/STM32_FreeRTOS_MainController.git</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">main</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>如何使用？</li>
</ol>

<p>把yaml文件放在某个你要存放大量仓库的文件夹下，敲入下方命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vcs import &lt; myrepos.yaml
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image87.webp" alt="" /></p>

<p>如下图，成功</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image88.webp" alt="" /></p>

<h2 id="github代理">Github代理</h2>

<p>https://ghproxy.link/</p>

<h2 id="搭建博客">搭建博客</h2>

<p>使用github搭建自己的博客。</p>

<p>https://www.bilibili.com/video/BV1g68TzPEkh</p>

<h1 id="常见问题">常见问题</h1>

<h2 id="commit到本地的想直接取消">commit到本地的想直接取消</h2>

<pre><code class="language-Python">
# 设置默认编辑器
git config --global core.editor vim

# 使用交互式rebase
git rebase -i HEAD~2
</code></pre>

<p>若我不想提交add bishe了</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/29/image89.webp" alt="" /></p>

<p>可以将上图修改为：</p>

<pre><code class="language-Python">drop &lt;hash1&gt; add bishe
pick &lt;hash2&gt; update
</code></pre>

<p>然后退出编辑器后就成功了。</p>]]></content><author><name>Tung Chia-hui</name></author><category term="Git" /></entry><entry><title type="html">电控视觉环境搭建</title><link href="https://jekyll.tungchiahui.cn/blog/ide-setup/" rel="alternate" type="text/html" title="电控视觉环境搭建" /><published>2023-12-10T00:00:00+00:00</published><updated>2023-12-10T00:00:00+00:00</updated><id>https://jekyll.tungchiahui.cn/blog/%E7%94%B5%E6%8E%A7%E8%A7%86%E8%A7%89%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA</id><content type="html" xml:base="https://jekyll.tungchiahui.cn/blog/ide-setup/"><![CDATA[<ul id="markdown-toc">
  <li><a href="#cc环境搭建" id="markdown-toc-cc环境搭建">C/C++环境搭建</a>    <ul>
      <li><a href="#windows" id="markdown-toc-windows">Windows</a>        <ul>
          <li><a href="#visual-studio" id="markdown-toc-visual-studio">Visual Studio</a></li>
        </ul>
      </li>
      <li><a href="#linux" id="markdown-toc-linux">Linux</a></li>
    </ul>
  </li>
  <li><a href="#arm-keil-mdkarm单片机环境搭建" id="markdown-toc-arm-keil-mdkarm单片机环境搭建">ARM Keil MDK(ARM单片机环境搭建)</a>    <ul>
      <li><a href="#介绍以及环境推荐" id="markdown-toc-介绍以及环境推荐">介绍以及环境推荐</a></li>
      <li><a href="#arm-keil-mdk-5--cubemx推荐小鸟新手" id="markdown-toc-arm-keil-mdk-5--cubemx推荐小鸟新手">Arm Keil MDK 5 + CubeMX【推荐小鸟(新手）】</a>        <ul>
          <li><a href="#简介" id="markdown-toc-简介">简介</a></li>
          <li><a href="#windows-1" id="markdown-toc-windows-1">Windows</a></li>
        </ul>
      </li>
      <li><a href="#arm-keil-mdk-5--vscodekeil-assistant不推荐" id="markdown-toc-arm-keil-mdk-5--vscodekeil-assistant不推荐">Arm Keil MDK 5 + VScode(Keil Assistant)【不推荐】</a>        <ul>
          <li><a href="#简介-1" id="markdown-toc-简介-1">简介</a></li>
          <li><a href="#windows-2" id="markdown-toc-windows-2">Windows</a>            <ul>
              <li><a href="#配置教程" id="markdown-toc-配置教程">配置教程：</a></li>
              <li><a href="#注意事项必看" id="markdown-toc-注意事项必看">注意事项（必看）：</a>                <ul>
                  <li><a href="#须知" id="markdown-toc-须知">须知</a></li>
                  <li><a href="#文字编码有问题" id="markdown-toc-文字编码有问题">文字🦟编码有问题</a></li>
                  <li><a href="#误报错" id="markdown-toc-误报错">误报错</a></li>
                  <li><a href="#无法go-to-definition" id="markdown-toc-无法go-to-definition">无法go to definition</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#arm-keil-mdk-6-基于vscode暂不推荐" id="markdown-toc-arm-keil-mdk-6-基于vscode暂不推荐">Arm Keil MDK 6 (基于VScode)【暂不推荐】</a>        <ul>
          <li><a href="#简介-2" id="markdown-toc-简介-2">简介</a></li>
          <li><a href="#windows--linux" id="markdown-toc-windows--linux">Windows &amp;&amp; Linux</a></li>
        </ul>
      </li>
      <li><a href="#告别keil-mdk--vscodecmake环境部署非常推荐老鸟" id="markdown-toc-告别keil-mdk--vscodecmake环境部署非常推荐老鸟">告别Keil MDK : VScode+CMake环境部署【非常推荐老鸟】</a></li>
    </ul>
  </li>
  <li><a href="#linux基本配置" id="markdown-toc-linux基本配置">Linux基本配置</a></li>
  <li><a href="#cmake工程搭建" id="markdown-toc-cmake工程搭建">CMake工程搭建</a></li>
  <li><a href="#opencv_cuda环境搭建" id="markdown-toc-opencv_cuda环境搭建">OpenCV_CUDA环境搭建</a>    <ul>
      <li><a href="#linux-1" id="markdown-toc-linux-1">Linux</a>        <ul>
          <li><a href="#保证显卡正常" id="markdown-toc-保证显卡正常">保证显卡正常</a></li>
          <li><a href="#安装依赖项" id="markdown-toc-安装依赖项">安装依赖项</a></li>
          <li><a href="#下载opencv源码" id="markdown-toc-下载opencv源码">下载OpenCV源码</a></li>
          <li><a href="#cmake编译" id="markdown-toc-cmake编译">CMake编译</a>            <ul>
              <li><a href="#准备工作" id="markdown-toc-准备工作">准备工作</a></li>
              <li><a href="#cmake编译两种方式选其一" id="markdown-toc-cmake编译两种方式选其一">CMake编译<strong>(两种方式选其一)</strong></a>                <ul>
                  <li><a href="#cmake终端命令方式不建议更建议用gui的方式这种终端的方式容易出奇奇怪怪的问题" id="markdown-toc-cmake终端命令方式不建议更建议用gui的方式这种终端的方式容易出奇奇怪怪的问题">CMake终端命令方式(不建议，更建议用GUI的方式，这种终端的方式容易出奇奇怪怪的问题)</a></li>
                  <li><a href="#cmake-gui方式推荐不过太麻烦但是问题少且更好找问题" id="markdown-toc-cmake-gui方式推荐不过太麻烦但是问题少且更好找问题">CMake-GUI方式(推荐，不过太麻烦，但是问题少，且更好找问题)</a></li>
                  <li><a href="#常见问题" id="markdown-toc-常见问题">常见问题</a>                    <ul>
                      <li><a href="#无cuda选项" id="markdown-toc-无cuda选项">无CUDA选项</a></li>
                      <li><a href="#模组的路径与命令行方式不同" id="markdown-toc-模组的路径与命令行方式不同">模组的路径与命令行方式不同</a></li>
                      <li><a href="#opencv_python3_version参数的类型错了" id="markdown-toc-opencv_python3_version参数的类型错了">OPENCV_PYTHON3_VERSION参数的类型错了</a></li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li><a href="#makefiles编译" id="markdown-toc-makefiles编译">Makefiles编译</a></li>
          <li><a href="#配置opencv环境变量env" id="markdown-toc-配置opencv环境变量env">配置OpenCV环境变量ENV</a></li>
          <li><a href="#测试opencv_cudacmake程序示例" id="markdown-toc-测试opencv_cudacmake程序示例">测试OpenCV_CUDA(CMake程序示例)</a></li>
          <li><a href="#常见问题-1" id="markdown-toc-常见问题-1">常见问题</a>            <ul>
              <li><a href="#cmake--jx编译遇到operator或权重weight相关问题" id="markdown-toc-cmake--jx编译遇到operator或权重weight相关问题">cmake -jx编译遇到operator!=或权重weight相关问题</a></li>
              <li><a href="#ros原装opencv与自己搭建的opencv_cuda冲突的问题" id="markdown-toc-ros原装opencv与自己搭建的opencv_cuda冲突的问题">ros原装opencv与自己搭建的opencv_cuda冲突的问题</a>                <ul>
                  <li><a href="#ros1" id="markdown-toc-ros1">ROS1</a></li>
                  <li><a href="#ros2" id="markdown-toc-ros2">ROS2</a></li>
                </ul>
              </li>
              <li><a href="#opencv编译爆内存的问题" id="markdown-toc-opencv编译爆内存的问题">opencv编译爆内存的问题</a>                <ul>
                  <li><a href="#windows中" id="markdown-toc-windows中">windows中：</a></li>
                  <li><a href="#linux中" id="markdown-toc-linux中">linux中：</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#windows-3" id="markdown-toc-windows-3">Windows</a></li>
    </ul>
  </li>
  <li><a href="#yolo环境搭建" id="markdown-toc-yolo环境搭建">YOLO环境搭建</a>    <ul>
      <li><a href="#windows-4" id="markdown-toc-windows-4">Windows</a></li>
      <li><a href="#linuxwsl2也能用" id="markdown-toc-linuxwsl2也能用">Linux(WSL2也能用)</a></li>
    </ul>
  </li>
  <li><a href="#ros环境搭建" id="markdown-toc-ros环境搭建">ROS环境搭建</a>    <ul>
      <li><a href="#推荐的搭建环境" id="markdown-toc-推荐的搭建环境">推荐的搭建环境</a>        <ul>
          <li><a href="#方案一推荐" id="markdown-toc-方案一推荐">方案一(推荐)</a></li>
          <li><a href="#方案二也是比较推荐但是要多学个docker" id="markdown-toc-方案二也是比较推荐但是要多学个docker">方案二(也是比较推荐，但是要多学个Docker)</a></li>
          <li><a href="#方案三可以用" id="markdown-toc-方案三可以用">方案三(可以用)</a></li>
          <li><a href="#方案四可以用" id="markdown-toc-方案四可以用">方案四(可以用)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#qt环境搭建" id="markdown-toc-qt环境搭建">QT环境搭建</a>    <ul>
      <li><a href="#安装qt" id="markdown-toc-安装qt">安装QT</a>        <ul>
          <li><a href="#qt5" id="markdown-toc-qt5">QT5</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#debian系" id="markdown-toc-debian系">debian系</a></li>
  <li><a href="#红帽系" id="markdown-toc-红帽系">红帽系</a></li>
  <li><a href="#安装-qt5-核心开发包" id="markdown-toc-安装-qt5-核心开发包">安装 Qt5 核心开发包</a></li>
  <li><a href="#安装常用模块按需选择" id="markdown-toc-安装常用模块按需选择">安装常用模块（按需选择）</a>    <ul>
      <li><a href="#vscode环境配置" id="markdown-toc-vscode环境配置">VScode环境配置</a></li>
      <li><a href="#qt-designer生成ui" id="markdown-toc-qt-designer生成ui">QT Designer生成.ui</a></li>
      <li><a href="#调用ui类并编译运行" id="markdown-toc-调用ui类并编译运行">调用.ui类并编译运行</a></li>
    </ul>
  </li>
  <li><a href="#docker环境搭建" id="markdown-toc-docker环境搭建">Docker环境搭建</a></li>
</ul>

<p>暂时无法在飞书文档外展示此内容</p>

<h1 id="cc环境搭建">C/C++环境搭建</h1>

<h2 id="windows">Windows</h2>

<h3 id="visual-studio">Visual Studio</h3>

<p>https://www.bilibili.com/video/BV11R4y1s7jz</p>

<h2 id="linux">Linux</h2>

<p>详见下方的CMake工程搭建。</p>

<h1 id="arm-keil-mdkarm单片机环境搭建">ARM Keil MDK(ARM单片机环境搭建)</h1>

<h2 id="介绍以及环境推荐">介绍以及环境推荐</h2>

<ol>
  <li>
    <p>Keil MDK是ARM公司旗下官方软件。最主流的单片机开发环境IDE，没有之一。</p>
  </li>
  <li>
    <p><strong>推荐版本：</strong></p>

    <ol>
      <li>
        <p><strong>新手：无脑</strong> <strong>ARM</strong> <strong>Keil</strong> <strong>MDK</strong> <strong>5 + CubeMX(新手前期只准先安装ARM Keil MDK 5，不准用CubeMX)</strong></p>
      </li>
      <li>
        <p><strong>老鸟：无脑 VScode + CMake + CubeMX</strong></p>
      </li>
    </ol>
  </li>
</ol>

<h2 id="arm-keil-mdk-5--cubemx推荐小鸟新手">Arm Keil MDK 5 + CubeMX【推荐小鸟(新手）】</h2>

<h3 id="简介">简介</h3>

<ol>
  <li>
    <p>最主流的开发环境(即便有很多致命缺点)，没有之一。新手无脑用，新手必须用这个方案开发STM32。</p>
  </li>
  <li>
    <p>缺点很明显：上古的界面，上古的代码补齐，仅支持Windows，且只有X86的32位版本。</p>
  </li>
</ol>

<h3 id="windows-1">Windows</h3>

<p>https://www.bilibili.com/video/BV18T411r7Yu</p>

<p>所需文件获取方式：</p>

<ol>
  <li>
    <p>社团的U盘(直接拷贝)</p>
  </li>
  <li>
    <p>官网：</p>

    <ol>
      <li>
        <p>MDK5官网：https://www.keil.com/demo/eval/arm.htm</p>
      </li>
      <li>
        <p>MDK5的FW固件下载链接：https://www.keil.arm.com/devices/</p>
      </li>
      <li>
        <p>ARM编译器下载链接：</p>

        <ol>
          <li>
            <p>ARMCC(AC5)必下：https://developer.arm.com/downloads/view/ACOMP5?revision=r5p6-07rel1</p>
          </li>
          <li>
            <p>ARMCLANG(AC6)一般MDK5最新版都自带，<em>不用下</em>：https://developer.arm.com/downloads/view/ACOMPE</p>
          </li>
          <li>
            <p>AC5与AC6对比(一般不用看)：<a href="https://developer.arm.com/Tools%20and%20Software/Arm%20Compiler%20for%20Embedded%20FuSa#Editions">https://developer.arm.com/Tools and Software/Arm Compiler for Embedded FuSa#Editions</a></p>
          </li>
        </ol>

        <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image1.webp" alt="" /></p>
      </li>
      <li>
        <p>Keil MDK 5 破解注册机(请关闭杀毒软件再下载)： <a href="https://sdutvincirobot.feishu.cn/file/SBbTbvSQ5o3dvExZ49UcGvYen8d">keygen.iso</a> or https://www.duote.com/soft/907739.html</p>
      </li>
      <li>
        <p>Java_JRE下载(一般下载<a href="https://javadl.oracle.com/webapps/download/AutoDL?BundleId=250129_d8aa705069af427f9b83e66b34f5e380">Windows Offline (64-bit)</a>,需要安装JRE才可以打开CubeMX)：https://www.java.com/en/download/manual.jsp</p>
      </li>
      <li>
        <p>CubeMX官网：https://www.st.com.cn/zh/development-tools/stm32cubemx.html</p>
      </li>
      <li>
        <p>正点原子配套资料1(A盘资料F1):http://www.openedv.com/docs/boards/stm32/zdyz_stm32f103_warshipV4.html</p>
      </li>
      <li>
        <p>正点原子配套资料2(A盘资料F4):http://www.openedv.com/docs/boards/stm32/zdyz_stm32f407_explorerV3.html</p>
      </li>
    </ol>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image2.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image3.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image4.webp" alt="" /></p>

<h2 id="arm-keil-mdk-5--vscodekeil-assistant不推荐">Arm Keil MDK 5 + VScode(Keil Assistant)【不推荐】</h2>

<h3 id="简介-1">简介</h3>

<ol>
  <li>该方式是折中方案，介于MDK5和MDK6之间的方案，可以规避掉一部分MDK5的缺点。(但是由于C/C++插件过于垃圾，所以<strong>不太推荐使用</strong>)</li>
</ol>

<h3 id="windows-2">Windows</h3>

<h4 id="配置教程">配置教程：</h4>

<p>快速配置的视频：</p>

<p>https://www.bilibili.com/video/BV18e4y1H7xX</p>

<p>如果遇到一些问题，请看下方这个视频：</p>

<p>https://www.bilibili.com/video/BV19V411g7gD/</p>

<ol>
  <li>
    <p>请安装好MDK5，CubeMX，VScode等软件</p>
  </li>
  <li>
    <p>安装VScode插件</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image5.webp" alt="" /></p>

<ol>
  <li>
    <p>配置Keil Assistant</p>

    <ol>
      <li>点击扩展设置</li>
    </ol>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image6.webp" alt="" /></p>

    <ol>
      <li>找到MDK5的路径</li>
    </ol>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image7.webp" alt="" /></p>

    <ol>
      <li>复制一下路径</li>
    </ol>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image8.webp" alt="" /></p>

    <ol>
      <li>填入刚才复制的路径</li>
    </ol>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image9.webp" alt="" /></p>

<ol>
  <li>
    <p>用VScode打开MDK5工程</p>

    <ol>
      <li>打开工程</li>
    </ol>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image10.webp" alt="" /></p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image11.webp" alt="" /></p>

    <p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image12.webp" alt="" /></p>
  </li>
  <li>
    <p>然后就可以用VScode编辑源码了</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image13.webp" alt="" /></p>

<h4 id="注意事项必看">注意事项（必看）：</h4>

<h5 id="须知">须知</h5>

<ol>
  <li>
    <p>该方式仅仅为<strong>折中方案</strong>，比单用MDK5好用一点，但远没有MDK6好用。</p>
  </li>
  <li>
    <p>VScode只负责代码编辑(建议别用Keil Assistant的编译等功能)。</p>
  </li>
  <li>
    <p>MDK5负责编译，下载，debug，添加源文件，头文件等其他一切操作。</p>
  </li>
  <li>
    <p>优点：解决了AC6编译器的go to definition失效的问题(AC6全是优点，这是唯一缺点)；解决了MDK5上古界面的不护眼；解决了MDK5代码提示拉跨；可以使用各种VScode的插件提高编辑效率。</p>
  </li>
  <li>
    <p>缺点：需要同时开着VScode和MDK5，各司其职，不统一。C/C++插件的代码提示虽比mdk5好，但也是过于拉胯。(远不如MDK6+Clangd)</p>
  </li>
</ol>

<h5 id="文字编码有问题">文字🦟编码有问题</h5>

<ol>
  <li>问题如下：</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image14.webp" alt="" /></p>

<ol>
  <li>手动改编码(点右下角的UTF-8，推荐用下方的插件解决，比手改便捷)：</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image15.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image16.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image17.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image18.webp" alt="" /></p>

<ol>
  <li>插件(VScode的特点就是插件多，不用插件的vscode失去了灵魂)</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image19.webp" alt="" /></p>

<p>该插件会自动提示你当前的编码有问题，自动猜测正确编码，点击yes就可以自动修改。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image20.webp" alt="" /></p>

<h5 id="误报错">误报错</h5>

<p>不用管，只要MDK5编译不报错就行。</p>

<h5 id="无法go-to-definition">无法go to definition</h5>

<p>(如果有问题才需要做，没问题就不要管)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image21.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image22.webp" alt="" /></p>

<p>在下面框中加上：(加完后可能还会误报错，但是已经可以正常go to definition了)</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="err">..\**</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>或者 将Include Path这一栏里的绝对路径全改为相对路径(下方只列举一部分)：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="err">..\applications\Inc</span><span class="w">
</span><span class="err">..\bsp\boards\Inc</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="arm-keil-mdk-6-基于vscode暂不推荐">Arm Keil MDK 6 (基于VScode)【暂不推荐】</h2>

<h3 id="简介-2">简介</h3>

<ol>
  <li>
    <p>优点：改善了MDK5的基本所有已知缺点，简直是开发者福音。</p>
  </li>
  <li>
    <p>缺点：学习成本较高，没有一定的电脑常识驾驭不了。</p>
  </li>
  <li>
    <p>目前暂时还<strong>不是很推荐单独使用</strong>，因为即便你会用，队友也不一定会用，这样工程无法互通。但如果你有能力，就是想用MDK6，那用也无妨，自己用着顺手为主。</p>
  </li>
  <li>
    <p>但是<strong>非常推荐配合使用</strong>，MDK6配合MDK5一起使用。使用MDK5添加源文件，添加头文件等操作(不要忘记添加完源文件和头文件后，用mdk5编译一下)；使用MDK6转化刚才的mdk5工程，进行源码编辑，编译，debug等等操作。(这样无论是用mdk5还是mdk6的队友，都可以打开你的工程直接食用啦)（看不懂这段话问学长）</p>
  </li>
</ol>

<h3 id="windows--linux">Windows &amp;&amp; Linux</h3>

<p><a href="/blog/arm-keil-mdk6-tutorial/">ARM Keil MDK6使用教程</a></p>

<h2 id="告别keil-mdk--vscodecmake环境部署非常推荐老鸟">告别Keil MDK : VScode+CMake环境部署【非常推荐老鸟】</h2>

<p><strong>(开发起来目前感觉还是挺舒服的，日后电控组组长如果觉得好用，可以统一一下IDE)</strong></p>

<p>主要现在有三个使用比较广的编译器.</p>

<p>armclang(AC6):编译巨快,开销巨小.(不论是编译,还是开销都非常优秀)</p>

<p>armcc(AC5):编译巨慢,开销很小.(仅仅只是开销小)</p>

<p>armgcc:编译较快,开销略大.(仅仅只是编译快)</p>

<p>所以说armgcc并没有那么大的优势，但是也可以接受。</p>

<p>主要是ARMCC和ARMCLANG是商用编译器，而ARMGCC是开源编译器，所以可以搭配CMake，Makefile等使用，可以更好管理项目，也可以支持全平台(Windows，Linux，MacOS等）</p>

<p>详细教程<a href="/blog/linux-stm32-cmake-vscode">STM32+CMake工程部署</a></p>

<h1 id="linux基本配置">Linux基本配置</h1>

<p><a href="/blog/linux-tutorial">Vinci机器人队Linux入门教程</a></p>

<h1 id="cmake工程搭建">CMake工程搭建</h1>

<p><a href="https://sdutvincirobot.feishu.cn/wiki/Dosvw46BtiBBLEkTdO4cPOt8nVb">CMake C/C++编译环境配置</a></p>

<h1 id="opencv_cuda环境搭建">OpenCV_CUDA环境搭建</h1>

<h2 id="linux-1">Linux</h2>

<p>更推荐在Linux上部署，一些深度学习的东西，在Linux上的运行速度要明显<strong>远远高于</strong>Windows。</p>

<p>如果你没有空闲硬盘装Linux了，可以考虑WSL2(在Windows上运行的Linux子系统2)，虽有一点点性能损失，但速度也远远高于Windows。</p>

<p>WSL2安装教程<a href="/blog/linux-tutorial">Vinci机器人队Linux入门教程</a></p>

<p><strong>实体机Linux</strong><strong>＞</strong><strong>WSL2</strong><strong>＞＞</strong><strong>Windows</strong></p>

<p>关于cv_bridge:最好在安装ros之前编译opencv，这样安装ros时,cv_bridge就会自己指向已经安装过的opencv，并且ros不会另外安装opencv，如此就可以通过find_package指令找到电脑上仅有的cv_bridge和opencv，保证系统环境不被污染。关于补救办法，请看常见问题</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image23.webp" alt="" /></p>

<h3 id="保证显卡正常">保证显卡正常</h3>

<p><strong>请确保 英伟达驱动、CUDA、cuDNN 全部安装成功并且版本正确。</strong></p>

<p><strong>(安装驱动、CUDA、cuDNN教程:</strong><a href="/blog/linux-tutorial">Vinci机器人队Linux入门教程</a><strong>)</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>
<span class="c"># 检查显卡驱动</span>
nvidia-smi

<span class="c"># 验证CUDA是否安装成功</span>
nvcc <span class="nt">-V</span>

<span class="c"># 检查cuDNN版本命令(仅仅只是查了头文件)</span>
<span class="nb">cat</span> /usr/local/cuda/include/cudnn_version.h | <span class="nb">grep </span>CUDNN_MAJOR <span class="nt">-A</span> 2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>出现下图这样的，则你是有英伟达驱动，CUDA以及cuDNN的</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image24.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image25.webp" alt="" /></p>

<h3 id="安装依赖项">安装依赖项</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>
<span class="c"># Debian系系统</span>
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> libcurl4 build-essential pkg-config cmake-gui <span class="se">\</span>
    libopenblas-dev libeigen3-dev libtbb-dev <span class="se">\</span>
    libavcodec-dev libavformat-dev <span class="se">\</span>
    libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev <span class="se">\</span>
    libswscale-dev libgtk-3-dev libpng-dev libjpeg-dev <span class="se">\</span>
    libcanberra-gtk-module libcanberra-gtk3-module libv4l-dev python3-dev python3-numpy

<span class="c"># RHEL红帽系系统</span>
bash <span class="nt">-c</span> <span class="s1">'sudo dnf install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm'</span>
<span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">-y</span> curl gcc gcc-c++ make cmake cmake-gui <span class="se">\</span>
    openblas-devel eigen3-devel tbb-devel <span class="se">\</span>
    ffmpeg-libs ffmpeg-devel <span class="se">\</span>
    gstreamer1-plugins-base-devel gstreamer1-devel <span class="se">\</span>
    gtk3-devel libpng-devel libjpeg-devel <span class="se">\</span>
    <span class="nv">libc</span><span class="o">=</span>aanberra-gtk3 libcanberra-devel v4l-utils v4l2loopback openexr-devel python3-dev python3-numpy

</pre></td></tr></tbody></table></code></pre></div></div>

<p>下方表格是这些依赖的说明</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">生成 OpenCV 的主要依赖项</th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">名称</td>
      <td>apt package 名称</td>
      <td>功能</td>
    </tr>
    <tr>
      <td style="text-align: left">编译系统</td>
      <td>build-essential cmake cmake-gui pkg-config</td>
      <td>生成 OpenCV</td>
    </tr>
    <tr>
      <td style="text-align: left">图像库</td>
      <td>libpng-dev libjpeg-dev</td>
      <td>提供各类图像格式的编解码</td>
    </tr>
    <tr>
      <td style="text-align: left">OpenBLAS</td>
      <td>libopenblas-dev</td>
      <td>利用 CPU 向量运算指令为大量算法提供加速。</td>
    </tr>
    <tr>
      <td style="text-align: left">Eigen3</td>
      <td>libeigen3-dev</td>
      <td>提供线性代数相关算法支持</td>
    </tr>
    <tr>
      <td style="text-align: left">Intel TBB</td>
      <td>libtbb-dev</td>
      <td>在 Intel CPU 上提供高性能并发计算支持</td>
    </tr>
    <tr>
      <td style="text-align: left">FFMPEG</td>
      <td>libavcodec-dev libavformat-dev libswscale-dev</td>
      <td>提供视频编解码能力</td>
    </tr>
    <tr>
      <td style="text-align: left">GStreamer</td>
      <td>libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev</td>
      <td>提供流媒体处理能力</td>
    </tr>
    <tr>
      <td style="text-align: left">GTK</td>
      <td>libgtk-3-dev libcanberra-gtk-module libcanberra-gtk3-module</td>
      <td>图形化用户界面</td>
    </tr>
    <tr>
      <td style="text-align: left">Video4Linux</td>
      <td>libv4l-dev</td>
      <td>Linux摄像头库</td>
    </tr>
  </tbody>
</table>

<h3 id="下载opencv源码">下载OpenCV源码</h3>

<p>https://github.com/opencv/opencv</p>

<p>https://github.com/opencv/opencv_contrib</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image26.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image27.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 创建文件夹存放源码</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> ooppccvv
<span class="nb">cd </span>ooppccvv
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image28.webp" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 解压源码</span>
unzip ./opencv-4.11.0.zip
unzip ./opencv_contrib-4.11.0.zip
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image29.webp" alt="" /></p>

<p>确认一下 opencv 目录和 opencv-contrib 目录位于相同的父目录内，并确认这两个目录下都存在 modules 子目录：<strong>(一般不用确认，只要你照着敲我上方的命令，一定没问题)</strong></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image30.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image31.webp" alt="" /></p>

<h3 id="cmake编译">CMake编译</h3>

<h4 id="准备工作">准备工作</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>
<span class="c"># 创建build文件夹用于装CMake生成的内容:</span>
<span class="nb">cd </span>opencv-4.11.0
<span class="nb">mkdir</span> <span class="nt">-p</span> build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image32.webp" alt="" /></p>

<p>OpenCV使用CMake与Makefile进行编译，编译选项较多，详见（也可以不看，不过不同版本有些CMake编译选项是不同的）：</p>

<p>https://docs.opencv.org/4.10.0/db/d05/tutorial_config_reference.html</p>

<p>下方被划掉的是在OpenCV4.11.0中已经不复存在的参数，但是可能在其他版本的OpenCV中仍有效，请自行用<code class="language-plaintext highlighter-rouge">CMake-LAH</code>(不推荐)命令或者<code class="language-plaintext highlighter-rouge">CMake-gui</code>(推荐)查看。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">OpenCV4.11.0 CMake常用编译选项表一览</th>
      <th> </th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">序号</td>
      <td>CMake参数名</td>
      <td>参数值</td>
      <td>作用</td>
    </tr>
    <tr>
      <td style="text-align: left">1</td>
      <td>CMAKE_BUILD_TYPE</td>
      <td>Release</td>
      <td>不在行成的库文件中包含调试信息，并进行速度优化。如果指定为 Debug ，就可以在 Debug 过程中进入 OpenCV 内部的代码，但运行速度会略微下降。</td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td>CMAKE_INSTALL_PREFIX</td>
      <td>/usr/local</td>
      <td>指定 OpenCV 生成的库文件在系统中的安装路径。</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td>CMAKE_VERBOSE_MAKEFILE</td>
      <td>ON</td>
      <td>务必开启，以便于发现编译中出现的问题。</td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td>BUILD_SHARED_LIBS</td>
      <td>ON</td>
      <td>成共享库（.so），如果置为 OFF 则只会生成静态库（.a）</td>
    </tr>
    <tr>
      <td style="text-align: left">5</td>
      <td>OPENCV_EXTRA_MODULES_PATH</td>
      <td><Modules路径></Modules路径></td>
      <td>按之前的描述，应为 「../../opencv_contrib-4.10.0/modules」。如果使用CMake-GUI则应为「../opencv_contrib-4.10.0/modules」。可以用 ls 命令确认相对路径是否存在。</td>
    </tr>
    <tr>
      <td style="text-align: left">6</td>
      <td>OPENCV_ENABLE_NONFREE</td>
      <td>ON</td>
      <td>如果置为OFF，一些包含专利保护算法的函数将不会生成。</td>
    </tr>
    <tr>
      <td style="text-align: left">7</td>
      <td>ENABLE_CXX11</td>
      <td>ON</td>
      <td>支持 C++11 以上的语法和 STL 库。</td>
    </tr>
    <tr>
      <td style="text-align: left">8</td>
      <td>BUILD_TESTS</td>
      <td>OFF</td>
      <td>可以关闭生成后的自我 TEST ，大多数情况没有必要开启，可大辐缩短生成时间。但如果怀疑生成的 OpenCV 库有问题，则尽量开启一下，可以进行自测。</td>
    </tr>
    <tr>
      <td style="text-align: left">9</td>
      <td>BUILD_PERF_TESTS</td>
      <td>OFF</td>
      <td> </td>
    </tr>
    <tr>
      <td style="text-align: left">10</td>
      <td>OPENCV_GENERATE_PKGCONFIG</td>
      <td>ON</td>
      <td>建议开启，便于 C++ 程序通过 pkg-config 来引用 OpenCV 库。</td>
    </tr>
    <tr>
      <td style="text-align: left">11</td>
      <td>WITH_GTK</td>
      <td>ON</td>
      <td>编译图形界面，cv2.show会用到</td>
    </tr>
    <tr>
      <td style="text-align: left">12</td>
      <td>CUDA_ARCH_BIN</td>
      <td>7.2;8.6;8.7</td>
      <td>这俩空需要填显卡算力，下面会有教程教你怎么查你的显卡算力。BIN指定为哪些 真实 GPU 架构 生成二进制代码（SASS），通常你要编译几张不同显卡，就要用分号分隔开这些显卡对应的算力（如 “7.2;8.6;8.7” ）。PTX指定为哪些 虚拟架构 生成 PTX 中间代码（用于未来 GPU 的 JIT 编译） 。通常只需设置BIN的最高算力（如 “8.7” ）。</td>
    </tr>
    <tr>
      <td style="text-align: left">13</td>
      <td>CUDA_ARCH_PTX</td>
      <td>8.7</td>
      <td> </td>
    </tr>
    <tr>
      <td style="text-align: left">14</td>
      <td>WITH_CUDA</td>
      <td>ON</td>
      <td>如果系统正确安装了 CUDA 并希望 OpenCV 启用 CUDA 支持，这四个选项都要打开。</td>
    </tr>
    <tr>
      <td style="text-align: left">15</td>
      <td>ENABLE_FAST_MATH</td>
      <td>ON</td>
      <td>支持math快速计算</td>
    </tr>
    <tr>
      <td style="text-align: left">16</td>
      <td>CUDA_FAST_MATH</td>
      <td>ON</td>
      <td>cuda的math快速计算</td>
    </tr>
    <tr>
      <td style="text-align: left">17</td>
      <td>WITH_CUBLAS</td>
      <td>ON</td>
      <td>开启CUBLAS</td>
    </tr>
    <tr>
      <td style="text-align: left">18</td>
      <td>WITH_CUDNN</td>
      <td>ON</td>
      <td>希望OpenCV启用cuDNN支持，这三项要打开</td>
    </tr>
    <tr>
      <td style="text-align: left">19</td>
      <td>WITH_DNN</td>
      <td>ON</td>
      <td>开启DNN</td>
    </tr>
    <tr>
      <td style="text-align: left">20</td>
      <td>OPENCV_DNN_CUDA</td>
      <td>ON</td>
      <td>启用CUDA，必须安装CUDA、CUBLAS和CUDNN。</td>
    </tr>
    <tr>
      <td style="text-align: left">21</td>
      <td>CUDA_HOST_COMPILER</td>
      <td>/usr/bin/gcc-13</td>
      <td>(可选)如果你是gcc14及以上，请安装一个gcc13及以下，改用gcc13及以下编译CUDA</td>
    </tr>
    <tr>
      <td style="text-align: left">22</td>
      <td>WITH_IPP</td>
      <td>ON</td>
      <td>这四个选项控制 OpenCV 如何进行并发运算，默认都是 ON，但如果有需要生成一个绝对单线程运行的 OpenCV ，请将这几个选项均置为 OFF 。</td>
    </tr>
    <tr>
      <td style="text-align: left">23</td>
      <td>WITH_TBB</td>
      <td>ON</td>
      <td> </td>
    </tr>
    <tr>
      <td style="text-align: left">24</td>
      <td>WITH_OPENMP</td>
      <td>ON</td>
      <td> </td>
    </tr>
    <tr>
      <td style="text-align: left">25</td>
      <td>WITH_PTHREADS_PF</td>
      <td>ON</td>
      <td> </td>
    </tr>
    <tr>
      <td style="text-align: left">26</td>
      <td>BUILD_opencv_python3</td>
      <td>ON</td>
      <td>OpenCV 提供 Python3 支持。在OpenCV4的某个版本已经默认打开。</td>
    </tr>
    <tr>
      <td style="text-align: left">27</td>
      <td>OPENCV_PYTHON3_VERSION</td>
      <td>Python3版本，如3.12</td>
      <td>填你的python3版本，比如Fedora42是Python3.13，就填3.13</td>
    </tr>
    <tr>
      <td style="text-align: left">28</td>
      <td>PYTHON3_EXECUTABLE</td>
      <td>Python3路径</td>
      <td>Python3 C++接口库的路径/usr/bin/python3</td>
    </tr>
    <tr>
      <td style="text-align: left">29</td>
      <td>PYTHON3_LIBRARY</td>
      <td>Lib路径</td>
      <td>Python3 C++接口库的路径</td>
    </tr>
    <tr>
      <td style="text-align: left">30</td>
      <td>PYTHON3_NUMPY_INCLUDE_DIRS</td>
      <td>矩阵库Head路径</td>
      <td>Python3 矩阵库头文件的路径</td>
    </tr>
    <tr>
      <td style="text-align: left">31</td>
      <td>PYTHON3_INCLUDE_DIR</td>
      <td>Head路径</td>
      <td>Python3 C++头文件的路径</td>
    </tr>
    <tr>
      <td style="text-align: left">32</td>
      <td>PYTHON3_PACKAGES_PATH</td>
      <td>Path路径</td>
      <td>OpenCV 的 Python3 包安装的路径</td>
    </tr>
    <tr>
      <td style="text-align: left">33</td>
      <td>WITH_OPENGL</td>
      <td>ON</td>
      <td>启用OPENGL</td>
    </tr>
    <tr>
      <td style="text-align: left"> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<ol>
  <li>查询GPU Compute Capability(CUDA_ARCH_BIN参数):</li>
</ol>

<p>https://developer.nvidia.com/cuda-gpus#collapseOne</p>

<p>进入网站后，</p>

<p>GeForce代表英伟达游戏系列显卡，常见的有GTX1080，RTX3080，RTX 4080等。</p>

<p>Jetson代表工控机序列显卡。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image33.webp" alt="" /></p>

<p>我是3060Laptop(笔记本移动端显卡，所以找右列的Notebook下方的3060)</p>

<p>如果你是3060(台式桌面端，则要找左列的3060)</p>

<p>通过图得知，我的显卡算力(GPU Compute Capability)为8.6，所以我的CMake的CUDA_ARCH_BIN参数为8.6。</p>

<p>CUDA_ARCH_PTX为BIN的最高值，我只设置了一个BIN，所以最高值就是这个8.6。(只有你要给电脑更换显卡的情况下，才要给BIN设置多个值，就需要把你要用的显卡的值全包含在BIN中，而PTX只需要BIN的最高值即可)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image34.webp" alt="" /></p>

<ol>
  <li>Python3的路径查询，请在终端中使用，检查是否都有结果生成，确保打印出的结果符合预期后再进行下面的CMake生成操作。(不需要记住路径)</li>
</ol>

<p>当然你也可以用命令反馈出来的路径复制出来，这个路径就是参数的值。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="c"># Python3 C++接口库的路径</span>
python3 <span class="nt">-c</span> <span class="s2">"import sysconfig; from os.path import join; print(join(sysconfig.get_config_var('LIBDIR'), sysconfig.get_config_var('LDLIBRARY')))"</span>

<span class="c"># Python3 矩阵库头文件的路径</span>
python3 <span class="nt">-c</span> <span class="s2">"import numpy; print(numpy.get_include())"</span>

<span class="c"># OpenCV 的 Python3 包安装的路径。</span>
python3 <span class="nt">-c</span> <span class="s2">"import sysconfig; print(sysconfig.get_path('purelib'))"</span>

<span class="c"># Python3 头文件的路径</span>
python3 <span class="nt">-c</span> <span class="s2">"import sysconfig; print(sysconfig.get_path('include'))"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="cmake编译两种方式选其一">CMake编译<strong>(两种方式选其一)</strong></h4>

<p>因为电脑配置的不同，每个电脑的硬件，软件(依赖包)等都不同，所以我能跑起来的你不一定一下就能跑成功。</p>

<p>一般很难风调雨顺，如果有问题及时去百度，谷歌，OpenCV论坛上找答案。</p>

<p>论坛:https://forum.opencv.org/</p>

<h5 id="cmake终端命令方式不建议更建议用gui的方式这种终端的方式容易出奇奇怪怪的问题">CMake终端命令方式(不建议，更建议用GUI的方式，这种终端的方式容易出奇奇怪怪的问题)</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>cmake .. <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span>Release <span class="se">\</span>
        <span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span>/usr/local <span class="se">\</span>
        <span class="nt">-DBUILD_SHARED_LIBS</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DOPENCV_EXTRA_MODULES_PATH</span><span class="o">=</span>../../opencv_contrib-4.11.0/modules <span class="se">\</span>
        <span class="nt">-DOPENCV_ENABLE_NONFREE</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DBUILD_TESTS</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DBUILD_PERF_TESTS</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DOPENCV_GENERATE_PKGCONFIG</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DWITH_GTK</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DWITH_CUDA</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DENABLE_FAST_MATH</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DCUDA_FAST_MATH</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DWITH_CUBLAS</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DCUDA_ARCH_BIN</span><span class="o">=</span><span class="s2">"8.6"</span> <span class="se">\</span>
        <span class="nt">-DCUDA_ARCH_PTX</span><span class="o">=</span><span class="s2">"8.6"</span> <span class="se">\</span>
        <span class="nt">-DCUDA_HOST_COMPILER</span><span class="o">=</span>/usr/bin/gcc-13 <span class="se">\</span>
        <span class="nt">-DWITH_CUDNN</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DOPENCV_DNN_CUDA</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DWITH_IPP</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DWITH_TBB</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DWITH_OPENMP</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DWITH_PTHREADS_PF</span><span class="o">=</span>ON <span class="se">\</span>
        <span class="nt">-DOPENCV_PYTHON3_VERSION</span><span class="o">=</span>3.12 <span class="se">\</span>
        <span class="nt">-DPYTHON3_EXECUTABLE</span><span class="o">=</span>/usr/bin/python3 <span class="se">\</span>
        <span class="nt">-DPYTHON3_LIBRARY</span><span class="o">=</span><span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"import sysconfig; from os.path import join; print(join(sysconfig.get_config_var('LIBDIR'), sysconfig.get_config_var('LDLIBRARY')))"</span><span class="si">)</span> <span class="se">\</span>
        <span class="nt">-DPYTHON3_NUMPY_INCLUDE_DIRS</span><span class="o">=</span><span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"import numpy; print(numpy.get_include())"</span><span class="si">)</span> <span class="se">\</span>
        <span class="nt">-DPYTHON3_PACKAGES_PATH</span><span class="o">=</span><span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"import sysconfig; print(sysconfig.get_path('purelib'))"</span><span class="si">)</span> <span class="se">\</span>
        <span class="nt">-DPYTHON3_INCLUDE_DIR</span><span class="o">=</span><span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"import sysconfig; print(sysconfig.get_path('include'))"</span><span class="si">)</span> <span class="se">\</span>
        <span class="nt">-DWITH_OPENGL</span><span class="o">=</span>ON

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image35.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image36.webp" alt="" /></p>

<p>你可以根据你的需要，按照之前的说明来自行增减或修改这些选项。如果 cmake 命令出错，往往是缺少依赖项或配置的生成选项不正确所致，可根据提示信息来检查。如果执行成功，就可以进行编译（请看Makefiles编译部分）了：</p>

<h5 id="cmake-gui方式推荐不过太麻烦但是问题少且更好找问题">CMake-GUI方式(推荐，不过太麻烦，但是问题少，且更好找问题)</h5>

<ol>
  <li>打开CMake-GUI：</li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image37.webp" alt="" /></p>

<p>配置一下这俩路径</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image38.webp" alt="" /></p>

<p>点击左下角配置，选择Makefiles</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image39.webp" alt="" /></p>

<ol>
  <li>配置参数</li>
</ol>

<p>根据上方表格去挨个参数进行配置。填完所有选项后，配置完毕点Configure.</p>

<p>在配置参数遇到问题，请看下面的常见问题章节。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image40.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image41.webp" alt="" /></p>

<p>你可以根据你的需要，按照之前的说明来自行增减或修改这些选项。如果 cmake 命令出错，往往是缺少依赖项或配置的生成选项不正确所致，可根据提示信息来检查。如果执行成功，就可以进行编译(进行Makefiles编译)了：</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image42.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image43.webp" alt="" /></p>

<h5 id="常见问题">常见问题</h5>

<h6 id="无cuda选项">无CUDA选项</h6>

<p>有时候CMake-GUI只会在编译后才显示某些参数(比如只有编译过WITH_CUDA才会显示CUDA相关的选项)。</p>

<p>所以你需要先把WITH_CUDA打上勾，再点左下角的config,这样才会出现和CUDA相关的选项，再把那些选项配置一下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image44.webp" alt="" /></p>

<h6 id="模组的路径与命令行方式不同">模组的路径与命令行方式不同</h6>

<p>需要注意的是，这个相对路径与直接敲CMake命令配置的参数不同，这里是<code class="language-plaintext highlighter-rouge">../opencv_contrib-4.11.0/modules</code>。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image45.webp" alt="" /></p>

<h6 id="opencv_python3_version参数的类型错了">OPENCV_PYTHON3_VERSION参数的类型错了</h6>

<p>在cmake-gui中不知道为何OPENCV_PYTHON3_VERSION参数的类型成了布尔型。</p>

<p>需要手动改为字符串型数据。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image46.webp" alt="" /></p>

<p>上图就是问题所在，这里竟然是个布尔值。</p>

<p>先删掉该选项。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image47.webp" alt="" /></p>

<p>再重新添加一个该选项。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image48.webp" alt="" /></p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 查看python3版本</span>
python3 --version
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image49.webp" alt="" /></p>

<p>在下面填上3.12，后面的小版本号不用填。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image50.webp" alt="" /></p>

<h3 id="makefiles编译">Makefiles编译</h3>

<p>后面 -j 参数的意义是使用所有 CPU 参与编译。如果启用了 CUDA ，生成过程会比较慢，请耐心等待。编译期间如果出错往往是编译器、系统库、三方库的版本兼容性问题，找问题的难度偏大。</p>

<p><strong>请在build目录下进行下方命令。</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="c"># 内存小于16GB</span>
make all

<span class="c"># 内存等于16GB</span>
make all <span class="nt">-j</span><span class="k">$((</span> <span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> ^processor /proc/cpuinfo<span class="si">)</span> <span class="o">/</span> <span class="m">2</span> <span class="k">))</span>

<span class="c"># 内存大于32GB</span>
make all <span class="nt">-j</span><span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> ^processor /proc/cpuinfo<span class="si">)</span>

<span class="c"># 或者自行规定线程数量（比如16线程）</span>
make all <span class="nt">-j16</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image51.webp" alt="" /></p>

<p>全核跑编译</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image52.webp" alt="" /></p>

<p>如图才是真编译成功，没有错误。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image53.webp" alt="" /></p>

<p>生成结束后，执行以下命令进行安装：</p>

<p><code class="language-plaintext highlighter-rouge">$(grep -c ^processor /proc/cpuinfo)</code>变量为CPU线程的数量。(这样可以使CPU全力多线程进行编译)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="c"># 内存小于16GB</span>
<span class="nb">sudo </span>make <span class="nb">install</span>

<span class="c"># 内存等于16GB</span>
<span class="nb">sudo </span>make <span class="nb">install</span> <span class="nt">-j</span><span class="k">$((</span> <span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> ^processor /proc/cpuinfo<span class="si">)</span> <span class="o">/</span> <span class="m">2</span> <span class="k">))</span>

<span class="c"># 内存大于32GB</span>
<span class="nb">sudo </span>make <span class="nb">install</span> <span class="nt">-j</span><span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> ^processor /proc/cpuinfo<span class="si">)</span>

<span class="c"># 或者自行规定线程数量（比如16线程）</span>
<span class="nb">sudo </span>make <span class="nb">install</span> <span class="nt">-j16</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image54.webp" alt="" /></p>

<p>无报错则安装成功</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image55.webp" alt="" /></p>

<h3 id="配置opencv环境变量env">配置OpenCV环境变量ENV</h3>

<ol>
  <li>可能需要配置一下lib的路径：</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vim ~/.bashrc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在最底下加上下方的内容</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
<span class="c"># 设置 LD_LIBRARY_PATH</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">"/usr/local/lib:</span><span class="nv">$LD_LIBRARY_PATH</span><span class="s2">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>其他的不用配置，开箱即用(可以配置一下pkg-config)，</li>
</ol>

<p>检查是否安装成功：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>opencv_version
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image56.webp" alt="" /></p>

<h3 id="测试opencv_cudacmake程序示例">测试OpenCV_CUDA(CMake程序示例)</h3>

<ol>
  <li>
    <p>CMake是一定要掌握的，请看下方文档学习:<a href="https://sdutvincirobot.feishu.cn/wiki/Dosvw46BtiBBLEkTdO4cPOt8nVb">CMake C/C++编译环境配置</a></p>
  </li>
  <li>
    <p>如图测试完毕：</p>
  </li>
</ol>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image57.webp" alt="" /></p>

<ol>
  <li>下方是实例工程我已上传至GitHub供大家下载：(下方示例工程里的CMake模板不是最新的，可能不如新版功能齐全，不如新版各方面设计的更周到，如果想找最新版模板请看<a href="https://sdutvincirobot.feishu.cn/wiki/Dosvw46BtiBBLEkTdO4cPOt8nVb">CMake C/C++编译环境配置</a>)</li>
</ol>

<p>https://github.com/tungchiahui/opencv_cuda_test</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>
<span class="c"># 克隆源码</span>
git clone https://github.com/tungchiahui/opencv_cuda_test.git

<span class="c"># cd进工程</span>
<span class="nb">cd </span>opencv_cuda_test

<span class="c"># cd进build目录</span>
<span class="nb">cd </span>build

<span class="c"># 进行cmake编译</span>
cmake ..

<span class="c"># 进行make编译+进行make install安装(最大线程)</span>
make <span class="nb">install</span> <span class="nt">-j</span><span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> ^processor /proc/cpuinfo<span class="si">)</span>

<span class="c"># 给予脚本执行权限</span>
<span class="nb">sudo chmod </span>a+x ../script/setup_vinci_emis.bash
<span class="nb">sudo chmod </span>a+x ../script/vinci_emis
<span class="nb">sudo chmod </span>a+x ../install/.setup.bash

<span class="c"># 执行环境脚本</span>
<span class="nb">source</span> ../script/setup_vinci_emis.bash

<span class="c"># 执行demo1二进制程序</span>
../script/vinci_emis run demo1
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>或者</strong>直接点击<code class="language-plaintext highlighter-rouge">Run</code>，<code class="language-plaintext highlighter-rouge">Start Debugging</code>或者<code class="language-plaintext highlighter-rouge">Run Without Debugging</code>都可以。(已经将launch.json及task.json全部配置好了)(发现bug及时call我，call我之前，请看最新CMake模板是否已经修复了该bug，若未修复，再call我)</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image58.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image59.webp" alt="" /></p>

<p>测试完毕</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image60.webp" alt="" /></p>

<h3 id="常见问题-1">常见问题</h3>

<h4 id="cmake--jx编译遇到operator或权重weight相关问题">cmake -jx编译遇到operator!=或权重weight相关问题</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  这个问题大多发生在ubuntu20.04或者cuda12.2上，编译时添加contrib库，对应ros版本为noetic，opencv版本为4.8.0。

  github上的讨论：
</pre></td></tr></tbody></table></code></pre></div></div>

<p>https://github.com/ros-perception/vision_opencv/tree/kinetic</p>

<p>根据GitHub中的解决方案，将对应报错.hpp文件中的相应代码修改（若只是有一些WARNING那大可不必修改）：</p>

<p><code class="language-plaintext highlighter-rouge">114 opencv/modules/dnn/src/cuda4dnn/primitives/normalize_bbox.hpp 中 if (weight != 1.0)</code>改为 <code class="language-plaintext highlighter-rouge">if (weight != static_cast&lt;T&gt;(1.0))</code></p>

<p><code class="language-plaintext highlighter-rouge">124 opencv/modules/dnn/src/cuda4dnn/primitives/region.hpp 中if (nms_iou_threshold &gt; 0)</code></p>

<p>改为 <code class="language-plaintext highlighter-rouge">if (nms_iou_threshold &gt; static_cast&lt;T&gt;(0))</code></p>

<p>再次编译</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make <span class="nt">-j16</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ros原装opencv与自己搭建的opencv_cuda冲突的问题">ros原装opencv与自己搭建的opencv_cuda冲突的问题</h4>

<p>原因：ros自带的cv_bridge自动链接ros的opencv，而ros自带的opencv没有cuda加速，故报错。</p>

<p>Ubuntu允许多版本 opencv共存，不建议直接卸载opencv，可能导致相关环境异常。</p>

<p>解决方案：额外配置一个版本的cv_bridge进行opencv的链接</p>

<h5 id="ros1">ROS1</h5>

<p>解决方案：</p>

<p>在https://github.com/ros-perception/vision_opencv/tree/kinetic中下载对应版本的cv_bridge</p>

<p>先对cv_bridge中的CmakeList.txt进行修改，OpencvDIR对应自己的opencv安装路径，并将修改包名：</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nb">project</span><span class="p">(</span>cv_bridge_480<span class="p">)</span><span class="c1">#修改为你的包名，加个版本号就可以</span>
<span class="nb">set</span><span class="p">(</span>OpenCV_DIR <span class="s2">"/home/liu/opencv/opencv-4.8.0"</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>OpenCV 4.8.0 REQUIRED
  COMPONENTS
    opencv_core
    opencv_imgproc
    opencv_imgcodecs
  CONFIG
<span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>修改package.xml中的包名</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;name&gt;</span>cv_bridge_480<span class="nt">&lt;/name&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时将cv_bridge作为一个ros功能包进行编译，把包整体复制进你工作空间的src中进行编译</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cp -rf ./cv_bridge ~/Yolo_Tensorrt_Demo/demo01_test/src
catkin_make
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后就可以将cv_bridge作为功能包使用了，在你原本的包CmakeLists中添加</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">find_package</span><span class="p">(</span>cv_bridge_480<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>package.xml:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;build_depend&gt;</span>cv_bridge_480<span class="nt">&lt;/build_depend&gt;</span>
<span class="nt">&lt;build_export_depend&gt;</span>cv_bridge_480<span class="nt">&lt;/build_export_depend&gt;</span>
<span class="nt">&lt;exec_depend&gt;</span>cv_bridge_480<span class="nt">&lt;/exec_depend&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>到这里自定义的cv_bridge包就配好了</p>

<p>如果你还想在vscode中使用代码补全，添加路径一直到cv_bridge包的include就可以,我这里是另一个工作空间，都一样。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nl">"includePath"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"/home/liu/cv_bridge_ws/src/cv_bridge/include"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"/home/liu/cv_bridge_ws/src/cv_bridge"</span><span class="w">

</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="ros2">ROS2</h5>

<p>详见<a href="/blog/ros2-tutorial/">ROS2机器人操作系统教程</a>中CV_Bridge章节.</p>

<h4 id="opencv编译爆内存的问题">opencv编译爆内存的问题</h4>

<p>解决方案：采用多核编译，一般采用make -j16 （这里16是CPU线程数，可以根据实际情况进行调整）即可解决，cpu线程越多，编译速度就越快</p>

<h5 id="windows中">windows中：</h5>

<p>Mingw：</p>

<pre><code class="language-PowerShell">mingw64-make -j16
</code></pre>

<p>值得注意的是，mingw并不支持windows上的opencv_contrib编译，这在configure一开始就会提示</p>

<p>Vs：</p>

<p>https://blog.csdn.net/hollyholly5/article/details/68062513</p>

<h5 id="linux中">linux中：</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make <span class="nt">-j</span><span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> ^processor /proc/cpuinfo<span class="si">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="windows-3">Windows</h2>

<p>详见<a href="https://sdutvincirobot.feishu.cn/wiki/Lm6XwbEJyi099ykqyV4cvirPn2f">使用OpenCV推理Yolov8模型（C++）</a></p>

<h1 id="yolo环境搭建">YOLO环境搭建</h1>

<h2 id="windows-4">Windows</h2>

<p><a href="https://sdutvincirobot.feishu.cn/wiki/BD51wAe3riSF74kIJEUcywINnhv">深度学习算法-Yolo系列</a></p>

<h2 id="linuxwsl2也能用">Linux(WSL2也能用)</h2>

<h1 id="ros环境搭建">ROS环境搭建</h1>

<p><a href="/blog/ros1-tutorial/">ROS机器人操作系统教程</a></p>

<p><a href="/blog/ros2-tutorial/">ROS2机器人操作系统教程</a></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image61.webp" alt="" /></p>

<p>ROS1已经EOF了，官方鼓励使用ROS2.</p>

<h2 id="推荐的搭建环境">推荐的搭建环境</h2>

<h3 id="方案一推荐">方案一(推荐)</h3>

<p><strong><em>ROS1=Kubuntu20.04</em></strong><strong>（Noetic与20.04双双寿终正寝）</strong></p>

<p><strong><em>ROS2=Kubuntu22.04+</em></strong></p>

<p><strong>仍然建议使用22.04+Humble</strong> Noetic，Humble，Jazzy这几个LTS之间主要有以下区别:</p>

<ol>
  <li>
    <p>Noetic是ROS1的LTS（长支持版），将于2025年5月31日EOF寿终正寝，自带算法比较老，依赖于其他非自带算法，但是教程最多，第三方算法支持也比较多。</p>
  </li>
  <li>
    <p>Humble是ROS2的第一个LTS，支持到2027年5月31日或海龟节，自带老版Gazebo Classic和新版Igntion Gazebo（独一份支持新旧两个Gazebo版本比较好的ROS版本），选择性比较广，自带算法比较新，教程正在逐渐增多中，第三方算法也在逐渐增多中，很多用ROS1的人都在往ROS2Humble上转。</p>
  </li>
  <li>
    <p>Jazzy是ROS2第二个LTS，支持到2029年5月31日或海龟节，在Humble的基础上，多了一些功能，但只有新版Gazebo Sim，针对Jazzy做ROS2教程的资料很少很少，而且很多第三方算法也并未针对Jazzy做相应版本，但是Jazzy目前来看兼容很多Humble的算法与教程，目前除了新版Gazebo改名需要改一些标记语言的标签外，没发现其他代码不兼容的地方。</p>
  </li>
</ol>

<h3 id="方案二也是比较推荐但是要多学个docker">方案二(也是比较推荐，但是要多学个Docker)</h3>

<ol>
  <li>
    <p>系统发行版:Fedora KDE（学长比较推荐，选一个自己喜欢的其他Linux发行版也行）</p>
  </li>
  <li>
    <p>ROS1Noetic安装方式:Docker</p>
  </li>
  <li>
    <p>ROS2Humble/Jazzy安装方式:Docker 详看<a href="/blog/docker-tutorial/">Docker教程</a></p>
  </li>
</ol>

<h3 id="方案三可以用">方案三(可以用)</h3>

<ol>
  <li>
    <p>系统发行版:Kubuntu 22.04 Jammy LTS / Kubuntu 24.04 Jammy LTS</p>
  </li>
  <li>
    <p>ROS1Noetic安装方式:西南交通大佬的ppa(详见上面ROS文档中，仅amd64(x86_64))</p>
  </li>
  <li>
    <p>ROS2Humble / ROS2Jazzy安装方式:官方二进制安装方式(详见上面的ROS2文档中)</p>
  </li>
</ol>

<h3 id="方案四可以用">方案四(可以用)</h3>

<ol>
  <li>
    <p>系统发行版:Windows10及以上</p>
  </li>
  <li>
    <p>WSL2发行版:Ubuntu24.04 Noble LTS</p>
  </li>
  <li>
    <p>ROS1Noetic安装方式:西南交通大佬的ppa(详见上面ROS文档中，仅amd64(x86_64))</p>
  </li>
  <li>
    <p>ROS2Jazzy安装方式:官方二进制安装方式(详见上面的ROS2文档中)</p>
  </li>
</ol>

<h1 id="qt环境搭建">QT环境搭建</h1>

<h2 id="安装qt">安装QT</h2>

<h3 id="qt5">QT5</h3>

<p>```Plain Text</p>

<h1 id="debian系">debian系</h1>
<p>sudo apt install qt5-default          # 基础开发工具（qmake、moc 等）
sudo apt install qtbase5-dev          # Qt5 核心库开发文件
sudo apt install qttools5-dev         # Qt5 工具（Qt Designer、Linguist 等）</p>

<h1 id="红帽系">红帽系</h1>

<h1 id="安装-qt5-核心开发包">安装 Qt5 核心开发包</h1>
<p>sudo dnf install qt5-qtbase-devel      # Qt5 核心库开发文件
sudo dnf install qt5-qttools-devel     # Qt5 工具（Qt Designer、Linguist 等）</p>

<h1 id="安装常用模块按需选择">安装常用模块（按需选择）</h1>
<p>sudo dnf install <br />
  qt5-qtdeclarative-devel \           # Qt Quick
  qt5-qtsvg-devel \                   # SVG 支持
  qt5-qtwayland-devel \               # Wayland 支持
  qt5-qtwebengine-devel               # WebEngine 支持</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>
### QT6

https://www.qt.io/product/qt6

```bash

# debian系
sudo apt install qt6-base-dev qt6-tools-dev

# 红帽系
sudo dnf install qt6-qtbase-devel qt6-qttools-devel

sudo dnf install qt6-qtdeclarative-devel qt6-qtsvg-devel qt6-qtwayland-devel qt6-qt5compat-devel qt6-qtwebsockets-devel
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="vscode环境配置">VScode环境配置</h2>

<p>主要是CMake搭建QT5/QT6开发环境，详看<a href="https://sdutvincirobot.feishu.cn/wiki/Dosvw46BtiBBLEkTdO4cPOt8nVb">CMake C/C++编译环境配置</a></p>

<h2 id="qt-designer生成ui">QT Designer生成.ui</h2>

<p>主要是用下面这个软件进行图形化设计，然后生成<code class="language-plaintext highlighter-rouge">.ui</code>文件再转化为<code class="language-plaintext highlighter-rouge">.h</code>文件用于C/C++工程。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image62.webp" alt="" /></p>

<p>比如我们创建一个Helloworld窗口，打开QT Designer之后，选择创建Widget。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image63.webp" alt="" /></p>

<p>拖进来，输入Hello World！</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image64.webp" alt="" /></p>

<p>可以调字体大小。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image65.webp" alt="" /></p>

<p>可以修改objectName，即是C++代码里调用的类名称。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image66.webp" alt="" /></p>

<p>最后保存.ui文件，一般是保存在功能包下的form文件夹下。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image67.webp" alt="" /></p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image68.webp" alt="" /></p>

<h2 id="调用ui类并编译运行">调用.ui类并编译运行</h2>

<p>首先先确保你的VScode+CMake配置正确。</p>

<p>然后再<code class="language-plaintext highlighter-rouge">cmake ..</code>，接着<code class="language-plaintext highlighter-rouge">make install</code>，此时QT_Projects/QT6/QT6_Template/build/src/QT6TEST/目录下会出现<code class="language-plaintext highlighter-rouge">.h</code>文件。</p>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image69.webp" alt="" /></p>

<p>然后可以在代码中引用这个.h。</p>

<p>接着实现自己的代码功能就可以了。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"QT6TEST/inc/qt6_test.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;QApplication&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;QWidget&gt;</span><span class="cp">
#include</span> <span class="cpf">"ui_mywidget.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">qt6_test</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">QApplication</span> <span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="c1">// 创建主窗口和 UI 对象</span>
    <span class="n">QWidget</span> <span class="n">mainWindow</span><span class="p">;</span>
    <span class="n">Ui</span><span class="o">::</span><span class="n">MyWidget</span> <span class="n">ui</span><span class="p">;</span>        <span class="c1">// Ui 命名空间中的类名与 .ui 文件中的 class 属性一致</span>
    <span class="n">ui</span><span class="p">.</span><span class="n">setupUi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mainWindow</span><span class="p">);</span>

    <span class="c1">// 设置窗口标题</span>
    <span class="n">mainWindow</span><span class="p">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s">"Hello Qt6!"</span><span class="p">);</span>

    <span class="c1">// 显示窗口</span>
    <span class="n">mainWindow</span><span class="p">.</span><span class="n">show</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/2023/12/10/image70.webp" alt="" /></p>

<p>我这里有个配置好的QT6环境，你可以clone下来使用。</p>

<p>https://github.com/tungchiahui/QT_Projects/tree/main/QT6/QT6_Template</p>

<h1 id="docker环境搭建">Docker环境搭建</h1>

<p><a href="/blog/docker-tutorial/">Docker教程</a></p>]]></content><author><name>Tung Chia-hui</name></author><category term="环境搭建" /></entry></feed>